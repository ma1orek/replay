"use client";

import React, { useState, useCallback, useRef, useEffect, Suspense, useMemo } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClient as createSupabaseClient } from "@/lib/supabase/client";
import { motion, AnimatePresence } from "framer-motion";
import { 
  Loader2, 
  Trash2,
  Trash,
  Upload,
  Download,
  ChevronRight,
  ChevronLeft,
  Film,
  CheckCircle,
  ExternalLink,
  Monitor,
  Video,
  Code,
  Eye,
  EyeOff,
  Square,
  ChevronDown,
  User,
  Sparkles,
  Activity,
  Palette,
  FileInput,
  Send,
  Pencil,
  Edit,
  X,
  GitBranch,
  Box,
  Boxes,
  Layers,
  Layout,
  Type,
  MousePointer,
  Play,
  Pause,
  Check,
  Droplet,
  Paintbrush,
  ZoomIn,
  ZoomOut,
  RefreshCw,
  Smartphone,
  Crosshair,
  Clock,
  Plus,
  Minus,
  Copy,
  History,
  Lock,
  Unlock,
  Key,
  MoreVertical,
  GripVertical,
  Folder,
  FolderTree,
  FileCode,
  Search,
  Settings,
  Image as ImageIcon,
  Paperclip,
  LogOut,
  Database,
  MessageSquare,
  ArrowRight,
  ArrowLeft,
  MousePointer2,
  Info,
  Rocket,
  Globe,
  Zap,
  Lightbulb,
  Puzzle,
  Target,
  Tag,
  PanelLeftClose,
  PanelLeft,
  FileText,
  Plug,
  CheckSquare,
  Package,
  Cpu,
  ListTodo,
  Shield,
  Cloud,
  Gauge,
  Network,
  Scale,
  Users,
  AlertCircle,
  Library,
  BookOpen,
  ToggleLeft,
  Accessibility,
  Ruler,
  Grid3X3,
  Map,
  Move,
  Link2,
  Maximize2,
  ChevronUp,
  AlertTriangle,
  Save,
  Moon,
  Sun,
  Grid2X2,
  Home,
  Menu,
  Mail,
  Phone,
  Calendar,
  Heart,
  Star,
  Bell,
  Bookmark,
  Share,
  Share2,
  HelpCircle,
  Terminal,
  Settings2,
  MousePointerClick,
  TextCursorInput,
  Compass,
  Table,
  PanelTop
} from "lucide-react";
import * as LucideIcons from 'lucide-react';
import { cn, generateId, formatDuration, updateProjectAnalytics } from "@/lib/utils";
import { stabilizePicsumUrls, simpleHash } from "@/lib/assets";
import { transmuteVideoToCode } from "@/actions/transmute";
import { getDatabaseContext, formatDatabaseContextForPrompt } from "@/lib/supabase/schema";
import { useIsMobile } from "@/lib/useIsMobile";
import MobileLayout from "@/components/mobile/MobileLayout";
// Enterprise presets REMOVED - using only system-prompt.ts for premium styling
// Demo is now loaded from /api/demo/[id] endpoint

// Global abort controller for canceling AI requests
let currentAbortController: AbortController | null = null;

// Streaming edit callback type
type StreamCallback = (event: {
  type: 'status' | 'chunk' | 'progress' | 'complete' | 'error';
  message?: string;
  phase?: string;
  text?: string;
  fullText?: string;
  code?: string;
  summary?: string;
  error?: string;
  isChat?: boolean;
  lines?: number;
  preview?: string;
}) => void;

// Client-side wrapper for editCodeWithAI that uses streaming API
async function editCodeWithAIStreaming(
  currentCode: string,
  editRequest: string,
  images?: { base64?: string; url?: string; mimeType: string; name: string }[],
  databaseContext?: string,
  isPlanMode?: boolean,
  chatHistory?: { role: string; content: string }[],
  onStream?: StreamCallback
): Promise<{ success: boolean; code?: string; error?: string; cancelled?: boolean; summary?: string }> {
  // Cancel any existing request
  if (currentAbortController) {
    currentAbortController.abort();
  }
  
  currentAbortController = new AbortController();
  
  try {
    const response = await fetch('/api/edit-code/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        currentCode,
        editRequest,
        images,
        databaseContext,
        isPlanMode,
        chatHistory,
      }),
      signal: currentAbortController.signal,
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('[editCodeWithAI] API error:', response.status, errorText);
      
      // Handle specific error codes with user-friendly messages
      if (response.status === 413) {
        return { 
          success: false, 
          error: 'Image too large! Please use a smaller image (max 4MB) or compress it first.' 
        };
      }
      if (response.status === 429) {
        return { 
          success: false, 
          error: 'Too many requests. Please wait a moment and try again.' 
        };
      }
      
      return { success: false, error: `API error: ${response.status}` };
    }
    
    const reader = response.body?.getReader();
    if (!reader) {
      return { success: false, error: 'No response stream' };
    }
    
    const decoder = new TextDecoder();
    let buffer = '';
    let finalResult: { success: boolean; code?: string; error?: string; summary?: string } = { success: false };
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      buffer += decoder.decode(value, { stream: true });
      
      // Parse SSE events
      const lines = buffer.split('\n');
      buffer = lines.pop() || ''; // Keep incomplete line in buffer
      
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          const eventType = line.slice(7);
          continue;
        }
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6));
            
            if (data.error) {
              onStream?.({ type: 'error', error: data.error });
              finalResult = { success: false, error: data.error };
            } else if (data.message && data.phase) {
              onStream?.({ type: 'status', message: data.message, phase: data.phase });
            } else if (data.text !== undefined && data.fullText !== undefined) {
              // Real-time code chunk
              onStream?.({ type: 'chunk', text: data.text, fullText: data.fullText });
            } else if (data.lines !== undefined) {
              // Progress update with lines count and optional preview
              onStream?.({ 
                type: 'progress', 
                message: `${data.lines} lines...`,
                lines: data.lines,
                preview: data.preview
              });
            } else if (data.code !== undefined) {
              onStream?.({ 
                type: 'complete', 
                code: data.code, 
                summary: data.summary,
                isChat: data.isChat 
              });
              // Include needsClarification and isChat in result
              finalResult = { 
                success: true, 
                code: data.code, 
                summary: data.summary,
                needsClarification: data.needsClarification,
                isChat: data.isChat
              } as any;
            }
          } catch (e) {
            // Ignore JSON parse errors for incomplete data
          }
        }
      }
    }
    
    return finalResult;
  } catch (error) {
    if (error instanceof Error && error.name === 'AbortError') {
      console.log('[editCodeWithAI] Request cancelled by user');
      return { success: false, cancelled: true, error: 'Request cancelled' };
    }
    console.error('[editCodeWithAI] Fetch error:', error);
    return { success: false, error: error instanceof Error ? error.message : 'Network error' };
  } finally {
    currentAbortController = null;
  }
}

// Non-streaming fallback for compatibility
async function editCodeWithAI(
  currentCode: string,
  editRequest: string,
  images?: { base64?: string; url?: string; mimeType: string; name: string }[],
  databaseContext?: string,
  isPlanMode?: boolean,
  chatHistory?: { role: string; content: string }[]
): Promise<{ success: boolean; code?: string; error?: string; cancelled?: boolean }> {
  // Cancel any existing request
  if (currentAbortController) {
    currentAbortController.abort();
  }
  
  // Create new abort controller
  currentAbortController = new AbortController();
  
  try {
    const response = await fetch('/api/edit-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        currentCode,
        editRequest,
        images,
        databaseContext,
        isPlanMode,
        chatHistory,
      }),
      signal: currentAbortController.signal,
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('[editCodeWithAI] API error:', response.status, errorText);
      
      // Handle specific error codes with user-friendly messages
      if (response.status === 413) {
        return { 
          success: false, 
          error: 'Image too large! Please use a smaller image (max 4MB) or compress it first.' 
        };
      }
      if (response.status === 429) {
        return { 
          success: false, 
          error: 'Too many requests. Please wait a moment and try again.' 
        };
      }
      
      return { success: false, error: `API error: ${response.status}` };
    }
    
    return await response.json();
  } catch (error) {
    if (error instanceof Error && error.name === 'AbortError') {
      console.log('[editCodeWithAI] Request cancelled by user');
      return { success: false, cancelled: true, error: 'Request cancelled' };
    }
    console.error('[editCodeWithAI] Fetch error:', error);
    return { success: false, error: error instanceof Error ? error.message : 'Network error' };
  } finally {
    currentAbortController = null;
  }
}

// Function to cancel ongoing AI request
function cancelAIRequest() {
  if (currentAbortController) {
    currentAbortController.abort();
    currentAbortController = null;
    return true;
  }
  return false;
}
import Logo from "@/components/Logo";
import StyleInjector from "@/components/StyleInjector";
import { Highlight, themes } from "prism-react-renderer";
import { usePendingFlow } from "@/app/providers";
import { useAuth } from "@/lib/auth/context";
import { useCredits, CREDIT_COSTS } from "@/lib/credits/context";
import { useProfile } from "@/lib/profile/context";
import Image from "next/image";
import Avatar from "@/components/Avatar";
import { OnlineUsers } from "@/components/LiveCursors";
import { CommentModeToggle } from "@/components/LiveComments";
import { 
  LiveCollaboration, 
  useLiveSync,
  broadcastBlueprintPosition,
  broadcastBlueprintSize,
  broadcastBlueprintCode,
  broadcastLibraryComponentChange,
  broadcastLibraryComponentDelete,
  broadcastLibraryComponentAdd,
} from "@/components/LiveCollaboration";
import { ShimmerButton } from "@/components/ui/shimmer-button";
import { ColorPicker } from "@/components/ui/color-picker";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import AuthModal from "@/components/modals/AuthModal";
import OutOfCreditsModal from "@/components/modals/OutOfCreditsModal";
import FeedbackGateModal from "@/components/modals/FeedbackGateModal";
import UpgradeModal from "@/components/modals/UpgradeModal";
import AssetsModal from "@/components/modals/AssetsModal";
import ProjectSettingsModal from "@/components/ProjectSettingsModal";
import { Toast, useToast } from "@/components/Toast";
import { useDesignSystems, ImportLibraryModal } from "@/components/DesignSystemSelector";
import { NewComponentBadge, NewComponentInlineBadge } from "@/components/NewComponentBadge";
import type { LocalComponent, DesignSystemListItem } from "@/types/design-system";
import AnimatedLoadingSkeleton from "@/components/ui/animated-loading-skeleton";
// MobileScanner removed - mobile users now use MobileLayout exclusively
import Link from "next/link";
import type { CodeMode, FileNode, FileTreeFolder, FileTreeFile, CodeReferenceMap } from "@/types";
import { trackViewContent, trackStartGeneration } from "@/lib/fb-tracking";

// Generate smart version label from user input (like Bolt/Lovable)
function generateVersionLabel(userInput: string): string {
  // Clean up the input
  let label = userInput.trim();
  
  // Remove common prefixes
  label = label.replace(/^(please\s+|can you\s+|could you\s+|i want to\s+|i need to\s+)/i, '');
  
  // Capitalize first letter
  label = label.charAt(0).toUpperCase() + label.slice(1);
  
  // If it starts with a verb, keep it as is
  const actionVerbs = ['add', 'remove', 'update', 'change', 'fix', 'make', 'create', 'delete', 'modify', 'adjust', 'improve', 'refactor', 'style', 'align', 'center', 'move', 'replace', 'translate', 'convert', 'expand', 'collapse', 'show', 'hide', 'enable', 'disable'];
  const startsWithVerb = actionVerbs.some(v => label.toLowerCase().startsWith(v));
  
  // If it doesn't start with a verb and is a request, try to extract action
  if (!startsWithVerb) {
    // Look for verbs in the text
    for (const verb of actionVerbs) {
      const verbIndex = label.toLowerCase().indexOf(verb);
      if (verbIndex > 0 && verbIndex < 20) {
        // Found verb, restructure
        label = label.substring(verbIndex);
        label = label.charAt(0).toUpperCase() + label.slice(1);
        break;
      }
    }
  }
  
  // Truncate to reasonable length (50 chars) at word boundary
  if (label.length > 50) {
    label = label.substring(0, 50);
    const lastSpace = label.lastIndexOf(' ');
    if (lastSpace > 30) {
      label = label.substring(0, lastSpace);
    }
  }
  
  // Remove trailing punctuation except for meaningful ones
  label = label.replace(/[,;:]+$/, '');
  
  return label || 'Code update';
}

interface FlowItem {
  id: string;
  name: string;
  videoBlob: Blob;
  videoUrl: string;
  thumbnail?: string;
  duration: number;
  trimStart: number;
  trimEnd: number;
  isImage?: boolean;
}

interface ArchNode {
  id: string;
  name: string;
  type: "page" | "component" | "section" | "element" | "interactive";
  description?: string;
  x: number;
  y: number;
  connections?: string[];
}

// Flow = PRODUCT MAP (not timeline) - what's possible, not what happened
// Shows CONFIRMED paths (from video) + POSSIBLE paths (detected nav items)
// NEW PHILOSOPHY: "The Architectural Twin" - Video Evidence Based
interface ProductFlowNode {
  id: string;
  name: string;
  type: "view" | "section" | "modal" | "state" | "loading";
  description?: string;
  x: number;
  y: number;
  components?: string[];
  // 3-TIER STATUS SYSTEM:
  // SOLID (observed) = Seen on video for 2+ seconds OR URL change detected - 100% certain
  // DASHED (detected) = Link/button visible via OCR but not clicked - high certainty
  // GHOST (inferred/possible) = AI suggestion based on app patterns - needs user approval
  status: "observed" | "detected" | "inferred" | "possible" | "added";
  confidence: "high" | "medium" | "low";
  // VIDEO EVIDENCE - The Architectural Twin
  videoEvidence?: {
    timestamp?: number; // When this was seen in video (seconds)
    duration?: number; // How long it was visible
    urlChange?: boolean; // Did URL change when navigating here?
    hoverDetected?: boolean; // User hovered but didn't click
    loadingStateDetected?: boolean; // Spinner/skeleton seen before this
  };
  // UI State tracking
  hasLoadingState?: boolean; // Does this view show loading indicators?
  hasErrorState?: boolean; // Does this view have error handling?
  thumbnail?: string; // Screenshot from video
}

interface ProductFlowEdge {
  id: string;
  from: string;
  to: string;
  label: string;
  type: "navigation" | "action" | "scroll" | "gated" | "possible" | "hover";
  // navigation = thick solid line (route change) - SOLID
  // scroll = thin solid line (in-page) - SOLID
  // gated = dashed line with lock (auth/paywall required) - DASHED
  // action = medium solid line (user action) - SOLID
  // possible = dotted gray line (detected in nav, not implemented) - GHOST
  // hover = thin dashed line (user hovered but didn't click) - DASHED
  // VIDEO EVIDENCE
  videoEvidence?: {
    timestamp?: number; // When this transition was seen
    animationType?: "instant" | "slide" | "fade" | "modal" | "drawer";
    transitionDuration?: number; // ms
  };
}

// UX Signals detected during analysis - Technical tags
interface UXSignal {
  type: "motion" | "interaction" | "responsive" | "hierarchy" | "data";
  label: string;
  value: string;
  icon?: string; // emoji or icon identifier
  tech?: string; // technical implementation detail
}

// Component tree structure for analysis
interface ComponentTreeNode {
  name: string;
  type: "Atom" | "Molecule" | "Organism" | "Template";
  status: "waiting" | "generating" | "done";
  children?: string[];
  hasDataConnection?: boolean; // If connected to database
}

interface StyleInfo {
  colors: { name: string; value: string }[];
  fonts: { name: string; usage: string; weight: string; family: string }[];
  spacing: string;
  borderRadius: string;
  shadows: string;
}

// Generation history for persistence (saved to Supabase)
interface GenerationVersion {
  id: string;
  timestamp: number;
  label: string; // e.g., "Initial generation", "AI Edit: added header"
  code: string;
  flowNodes: ProductFlowNode[];
  flowEdges: ProductFlowEdge[];
  styleInfo: StyleInfo | null;
}

interface GenerationRecord {
  id: string;
  title: string;
  autoTitle: boolean;
  timestamp: number;
  status: "running" | "complete" | "failed";
  code: string | null;
  styleDirective: string;
  refinements: string;
  flowNodes: ProductFlowNode[];
  flowEdges: ProductFlowEdge[];
  styleInfo: StyleInfo | null;
  videoUrl?: string;
  thumbnailUrl?: string;
  versions?: GenerationVersion[]; // Version history
  publishedSlug?: string; // Persistent publish URL slug
  chatMessages?: ChatMessage[]; // Chat history per project
  tokenUsage?: {
    promptTokens: number;
    candidatesTokens: number;
    totalTokens: number;
  };
  costCredits?: number;
  // Component library data (persisted per project)
  libraryData?: LibraryData | null;
  // Owner info for access control
  user_id?: string;
  // Design System (Library) linkage
  design_system_id?: string | null;
  designSystemName?: string | null;
}

// Chat message for Agentic Sidebar
interface ChatMessage {
  id: string;
  role: "assistant" | "user";
  content: string;
  timestamp: number;
  attachments?: {
    type: "element" | "image" | "video";
    label: string;
    selector?: string;
  }[];
  quickActions?: string[];
}

// ═══════════════════════════════════════════════════════════════════════════════
// LIBRARY INTERFACES (Storybook-like component library)
// ═══════════════════════════════════════════════════════════════════════════════

type ComponentCategory = "actions" | "forms" | "data-display" | "feedback" | "navigation" | "overlays";

interface ComponentProp {
  name: string;
  type: "string" | "number" | "boolean" | "enum" | "function" | "ReactNode";
  required: boolean;
  defaultValue: any;
  description: string;
  options?: string[];  // For enums
  control: "input" | "select" | "toggle" | "range" | "color" | "object" | "action";
}

interface ComponentVariant {
  name: string;           // "Default", "Primary", "Disabled"
  props: Record<string, any>;
  screenshot?: string;
}

interface AccessibilityCheck {
  rule: string;
  status: "pass" | "fail" | "warning";
  description: string;
  count?: number;
}

interface InteractionTest {
  name: string;
  steps: string[];
  status: "pass" | "fail" | "pending";
  duration?: number;
}

interface LibraryComponent {
  id: string;
  name: string;                    // "Button"
  category: ComponentCategory;
  layer?: "foundations" | "components" | "patterns" | "templates" | "product"; // Library layer for grouping
  subcategory?: ComponentCategory; // Subcategory within components layer
  source?: "storybook" | "generated" | "manual" | "video"; // Where component came from
  description: string;             // AI generated
  
  // Code
  code: string;                    // React component code
  usage: string;                   // Import + usage example
  
  // Props (AI extracted)
  props: ComponentProp[];
  
  // Variants (AI detected from video)
  variants: ComponentVariant[];
  
  // Usage tracking (for Blueprints/Library)
  usageCount?: number;             // Number of times component is used
  usageLocations?: string[];       // Where component is used
  isNew?: boolean;                 // Was created in this generation (not from DS)
  
  // Documentation (AI generated)
  docs: {
    description: string;
    usage: string;
    accessibility: string;
    bestPractices: string[];
  };
  
  // Testing
  accessibility: AccessibilityCheck[];
  interactions: InteractionTest[];
}

interface LibraryDoc {
  id: string;
  title: string;
  type: "overview" | "getting-started" | "components" | "iconography" | "colors" | "typography" | "spacing" | "examples" | "changelog";
  content: any;  // MDX content string or AI-generated structured content object
}

interface DesignTokens {
  colors: Record<string, string>;
  typography: {
    fontFamily: Record<string, string>;
    fontSize: Record<string, string>;
    fontWeight: Record<string, number>;
    lineHeight: Record<string, string>;
  };
  spacing: Record<string, string>;
  borderRadius: Record<string, string>;
  shadows: Record<string, string>;
}

interface LibraryData {
  components: LibraryComponent[];
  docs: LibraryDoc[];
  tokens: DesignTokens;
  foundations?: {
    colors?: Record<string, string>;
    typography?: {
      fontFamily?: Record<string, string>;
      fontSize?: Record<string, string>;
      fontWeight?: Record<string, number>;
      lineHeight?: Record<string, number | string>;
    };
    spacing?: Record<string, string>;
    borderRadius?: Record<string, string>;
    shadows?: Record<string, string>;
  };
  templates?: LibraryComponent[];
  patterns?: LibraryComponent[];
  product?: LibraryComponent[];
}

// Helper function to create LibraryComponent with defaults
function createLibraryComponent(
  name: string, 
  code: string, 
  category: ComponentCategory = "data-display",
  description?: string,
  layer?: "foundations" | "components" | "patterns" | "templates" | "product",
  source?: "storybook" | "generated" | "manual" | "video",
  isNew?: boolean
): LibraryComponent {
  return {
    id: `comp-${name.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`,
    name,
    category,
    layer: layer || "components", // Default to 'components' layer
    source: source || "generated", // Default to 'generated'
    description: description || `${name} component extracted from generated code`,
    code,
    usage: `<${name} />`,
    props: [],
    variants: [],
    isNew: isNew || false,
    docs: {
      description: description || `Auto-extracted ${name} component`,
      usage: `Import and use the ${name} component in your layout`,
      accessibility: "Ensure proper ARIA labels and keyboard navigation",
      bestPractices: ["Use semantic HTML", "Maintain consistent styling"],
    },
    accessibility: [],
    interactions: [],
  };
}

// Library UI state
type LibraryPanel = "controls" | "actions" | "interactions" | "visual" | "accessibility" | "usage";
type LibrarySidebarItem = { type: "doc" | "component"; id: string; name: string; category?: string; children?: LibrarySidebarItem[] };

type ViewMode = "preview" | "code" | "flow" | "design" | "docs" | "input" | "library" | "blueprints";
type DocsSubTab = "overview" | "api" | "qa" | "deploy";
type SidebarMode = "config" | "chat";
type SidebarTab = "chat" | "tree" | "style";
type SidebarView = "projects" | "detail"; // New: toggle between project list and detail view

// Different loading messages for each tab - extended for longer generations
const STREAMING_MESSAGES_PREVIEW = [
  "Reconstructing user interface...",
  "Building visual components...",
  "Rendering pixel-perfect layout...",
  "Assembling responsive design...",
  "Crafting interactive elements...",
  "Applying style treatments...",
  "Polishing animations...",
  "Optimizing visual hierarchy...",
  "Finalizing preview render...",
  "Adding finishing touches...",
  "Rendering final output...",
  "Processing visual layers...",
  "Composing UI structure...",
  "Building interactive preview...",
  "Analyzing layout patterns...",
  "Structuring components...",
  "Generating responsive views...",
  "Fine-tuning visual elements...",
  "Completing preview generation...",
  "Almost there, perfecting details...",
  "Processing design tokens...",
  "Building component hierarchy...",
  "Applying responsive breakpoints...",
  "Generating hover states...",
  "Setting up interactions...",
  "Rendering shadow effects...",
  "Processing color palette...",
  "Building navigation structure...",
  "Finalizing button states...",
  "Applying micro-animations...",
  "Setting up form elements...",
  "Building card layouts...",
  "Processing image placements...",
  "Finalizing typography...",
  "Setting up grid system...",
  "Almost ready for preview...",
  "Completing UI assembly...",
  "Running final validation...",
  "Preview nearly complete...",
  "Just a moment more...",
];

// Messages for updating an existing project
const STREAMING_MESSAGES_UPDATE = [
  "Updating your project...",
  "Applying your changes...",
  "Refining the design...",
  "Integrating modifications...",
  "Enhancing the layout...",
  "Processing updates...",
  "Optimizing components...",
  "Polishing the result...",
  "Fine-tuning details...",
  "Completing the update...",
  "Merging your changes...",
  "Updating visual elements...",
  "Syncing modifications...",
  "Applying style updates...",
  "Almost done updating...",
];

const STREAMING_MESSAGES_CODE = [
  "Analyzing video structure...",
  "Extracting component patterns...",
  "Generating semantic HTML...",
  "Writing Tailwind classes...",
  "Structuring responsive code...",
  "Adding interactivity logic...",
  "Implementing animations...",
  "Optimizing for performance...",
  "Cleaning up code output...",
  "Finalizing code generation...",
  "Building component hierarchy...",
  "Processing UI patterns...",
  "Generating styled components...",
  "Adding responsive breakpoints...",
  "Implementing hover states...",
  "Creating animation keyframes...",
  "Structuring CSS modules...",
  "Optimizing bundle size...",
  "Validating HTML structure...",
  "Completing code generation...",
  "Processing component props...",
  "Building state management...",
  "Adding event handlers...",
  "Generating utility functions...",
  "Creating reusable hooks...",
  "Setting up component exports...",
  "Building layout system...",
  "Processing grid structure...",
  "Generating flex containers...",
  "Adding accessibility attributes...",
  "Creating form handlers...",
  "Building navigation logic...",
  "Processing image components...",
  "Adding loading states...",
  "Creating error boundaries...",
  "Building modal components...",
  "Processing dropdown menus...",
  "Almost finished coding...",
  "Running final code checks...",
  "Code generation nearly done...",
];

const STREAMING_MESSAGES_FLOW = [
  "Mapping user journey...",
  "Detecting navigation paths...",
  "Identifying entry points...",
  "Building flow topology...",
  "Connecting interaction nodes...",
  "Analyzing transition logic...",
  "Structuring product map...",
  "Detecting possible routes...",
  "Finalizing flow architecture...",
  "Preparing canvas render...",
  "Mapping screen transitions...",
  "Building navigation graph...",
  "Identifying user paths...",
  "Connecting UI states...",
  "Processing flow nodes...",
  "Generating edge connections...",
  "Analyzing page hierarchy...",
  "Building interaction map...",
  "Completing flow diagram...",
  "Rendering flow canvas...",
  "Analyzing click patterns...",
  "Detecting scroll behaviors...",
  "Mapping hover interactions...",
  "Building state transitions...",
  "Processing conditional flows...",
  "Generating decision trees...",
  "Analyzing user choices...",
  "Building branching logic...",
  "Processing parallel paths...",
  "Detecting loop patterns...",
  "Mapping exit points...",
  "Building entry conditions...",
  "Processing user triggers...",
  "Generating flow metadata...",
  "Building canvas layout...",
  "Positioning flow nodes...",
  "Calculating edge paths...",
  "Almost done with flow...",
  "Finalizing flow structure...",
  "Flow generation complete soon...",
];

const STREAMING_MESSAGES_DESIGN = [
  "Extracting color palette...",
  "Analyzing typography system...",
  "Detecting spacing patterns...",
  "Building design tokens...",
  "Mapping component styles...",
  "Identifying visual patterns...",
  "Structuring design system...",
  "Analyzing border & shadow...",
  "Finalizing style extraction...",
  "Preparing design overview...",
  "Processing color values...",
  "Detecting font families...",
  "Mapping spacing scale...",
  "Building shadow tokens...",
  "Analyzing radius patterns...",
  "Extracting gradient styles...",
  "Processing animation curves...",
  "Generating style variables...",
  "Completing design tokens...",
  "Finalizing design system...",
  "Processing primary colors...",
  "Analyzing accent hues...",
  "Building color scales...",
  "Detecting contrast ratios...",
  "Processing font weights...",
  "Analyzing line heights...",
  "Building type scale...",
  "Processing letter spacing...",
  "Detecting icon styles...",
  "Analyzing button styles...",
  "Processing input styles...",
  "Building card patterns...",
  "Detecting hover effects...",
  "Analyzing focus states...",
  "Processing active states...",
  "Building state tokens...",
  "Almost done with design...",
  "Finalizing design tokens...",
  "Design system nearly ready...",
  "Completing style analysis...",
];

// Default messages (used for general loading)
const STREAMING_MESSAGES = [
  "Scanning video frames...",
  "Extracting visual information...",
  "Identifying components...",
  "Detecting UI elements...",
  "Mapping interactions...",
  "Understanding transitions...",
  "Processing with Gemini AI...",
  "Generating optimized code...",
  "Applying style preferences...",
  "Finalizing output...",
  "Analyzing UI patterns...",
  "Processing visual data...",
  "Building component tree...",
  "Generating responsive layout...",
  "Adding interactivity...",
  "Optimizing performance...",
  "Cleaning up output...",
  "Validating structure...",
  "Completing generation...",
  "Almost done...",
  "Analyzing video content...",
  "Processing user interactions...",
  "Detecting click patterns...",
  "Mapping scroll behavior...",
  "Building hover states...",
  "Processing form elements...",
  "Generating button styles...",
  "Creating navigation logic...",
  "Building page structure...",
  "Processing image assets...",
  "Generating icon elements...",
  "Creating card components...",
  "Building modal dialogs...",
  "Processing dropdown menus...",
  "Generating list items...",
  "Creating table structures...",
  "Building footer elements...",
  "Processing header components...",
  "Almost finished generating...",
  "Just a few more seconds...",
];

// Tips & Tricks shown during generation - technical, monospace style (NO "TIP:" prefix!)
const GENERATION_TIPS = [
  "Click, don't just watch. Interacting helps the engine differentiate functional elements from static containers.",
  "Cursor movement matters. Slow down over interactive elements to help us capture hover states accurately.",
  "Context is King. Providing specific context clues (e.g., 'Admin Dashboard') improves component density and typography.",
  "Don't be afraid to scroll. Replay can reconstruct long pages — just scroll slowly to ensure every section is captured.",
  "Use the chat to refine specific parts after generation — like 'make the button bigger' or 'add hover effect'.",
  "Record interactions, not just static views. Clicking, hovering, and scrolling help AI understand your UI better.",
  "Style injection is powerful. Specify 'Apple-style' or 'Linear dark mode' for consistent design language.",
  "Shorter videos often work better. Focus on one flow or feature at a time for more accurate results.",
  "Select a style preset before generating to match your design system — or use Auto-Detect to match the video.",
  "After generation, check the Flow Map tab to see how Replay understood your UI's navigation structure.",
  "Use 'Componentized' mode in the Code tab to get organized, production-ready component files.",
  "Replay extracts colors, fonts, and spacing into a reusable design system — check the Design tab.",
  "Show hover states in your video — Replay will recreate them with smooth CSS transitions.",
];

// Apply props override to component code (for live Storybook-like preview)
const applyPropsToCode = (code: string, props: any[], propsOverride: Record<string, any>): string => {
  if (!code) return code;
  
  let modifiedCode = code;
  
  // Build a style injection object for all overrides
  const styleOverrides: string[] = [];
  const textReplacements: { from: string; to: string }[] = [];
  
  // Process each prop with an override value
  Object.entries(propsOverride).forEach(([propName, overrideValue]) => {
    if (overrideValue === undefined || overrideValue === '') return;
    
    const prop = props?.find(p => p.name === propName);
    const defaultValue = prop?.defaultValue || '';
    const propNameLower = propName.toLowerCase();
    
    // Color properties - SAFE replacement: only replace the SPECIFIC default value
    if (propNameLower.includes('color') || propNameLower.includes('colour')) {
      const hexMatch = String(overrideValue).match(/^#[0-9A-Fa-f]{3,8}$/);
      const escapedDefault = defaultValue ? String(defaultValue).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
      const defaultStr = String(defaultValue || '');
      
      // ONLY replace the EXACT default value, nothing else!
      if (escapedDefault && escapedDefault.length > 1) {
        // If default is a Tailwind class (bg-blue-500), replace with arbitrary value
        if (defaultStr.startsWith('bg-') && hexMatch) {
          modifiedCode = modifiedCode.replace(new RegExp(escapedDefault, 'g'), `bg-[${overrideValue}]`);
        } else if (defaultStr.startsWith('text-') && hexMatch) {
          modifiedCode = modifiedCode.replace(new RegExp(escapedDefault, 'g'), `text-[${overrideValue}]`);
        } else if (defaultStr.startsWith('border-') && hexMatch) {
          modifiedCode = modifiedCode.replace(new RegExp(escapedDefault, 'g'), `border-[${overrideValue}]`);
        } else if (defaultStr.match(/^#[0-9A-Fa-f]{3,8}$/) && hexMatch) {
          // Replace hex with hex
          modifiedCode = modifiedCode.replace(new RegExp(escapedDefault, 'gi'), overrideValue);
        } else {
          // Generic replacement
          modifiedCode = modifiedCode.replace(new RegExp(escapedDefault, 'g'), String(overrideValue));
        }
      }
    }
    
    // Speed/duration/animation properties - inject via style
    if (propNameLower.includes('speed') || propNameLower.includes('duration') || propNameLower.includes('delay')) {
      styleOverrides.push(`animation-duration: ${overrideValue}`);
      styleOverrides.push(`transition-duration: ${overrideValue}`);
      // Replace in Tailwind animation classes
      modifiedCode = modifiedCode.replace(/duration-\[\d+s?\]/g, `duration-[${overrideValue}]`);
      modifiedCode = modifiedCode.replace(/animate-\[[\w\s]+\d+s[^\]]*\]/g, (match) => {
        return match.replace(/\d+s/, overrideValue);
      });
    }
    
    // Font size properties
    if (propNameLower.includes('fontsize') || propNameLower.includes('size') && !propNameLower.includes('color')) {
      if (overrideValue.startsWith('text-')) {
        // Tailwind class - replace existing text-* class
        modifiedCode = modifiedCode.replace(/text-(xs|sm|base|lg|xl|2xl|3xl|4xl|5xl|6xl|7xl|8xl|9xl)/g, overrideValue);
      } else {
        styleOverrides.push(`font-size: ${overrideValue}`);
      }
    }
    
    // Text content replacement
    if (propNameLower.includes('text') || propNameLower.includes('label') || propNameLower.includes('title') || propNameLower.includes('content')) {
      if (typeof defaultValue === 'string' && defaultValue.length > 2) {
        const escapedDefault = defaultValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        modifiedCode = modifiedCode.replace(new RegExp(`>${escapedDefault}<`, 'g'), `>${overrideValue}<`);
        modifiedCode = modifiedCode.replace(new RegExp(`"${escapedDefault}"`, 'g'), `"${overrideValue}"`);
      }
    }
    
    // Generic string replacement for other props
    if (typeof defaultValue === 'string' && defaultValue.length > 1 && typeof overrideValue === 'string') {
      const escapedDefault = defaultValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      modifiedCode = modifiedCode.replace(new RegExp(`>${escapedDefault}<`, 'g'), `>${overrideValue}<`);
      modifiedCode = modifiedCode.replace(new RegExp(`="${escapedDefault}"`, 'g'), `="${overrideValue}"`);
      modifiedCode = modifiedCode.replace(new RegExp(`='${escapedDefault}'`, 'g'), `='${overrideValue}'`);
    }
  });
  
  // Inject collected style overrides into ALL relevant elements
  if (styleOverrides.length > 0) {
    const styleString = styleOverrides.join('; ');
    
    // Inject into first element
    if (modifiedCode.match(/<[^>]+style="[^"]*"/)) {
      modifiedCode = modifiedCode.replace(
        /(<[^>]+style=")([^"]*)(")/,
        `$1$2; ${styleString}$3`
      );
    } else {
      modifiedCode = modifiedCode.replace(
        /(<\w+)(\s|>)/,
        `$1 style="${styleString}"$2`
      );
    }
    
    // Don't inject global styles - it breaks components with multiple colors
  }
  
  // Handle className override - add classes to root element
  if (propsOverride['className'] && typeof propsOverride['className'] === 'string') {
    const additionalClasses = propsOverride['className'].trim();
    if (additionalClasses) {
      // Find first element with className and append
      modifiedCode = modifiedCode.replace(
        /className="([^"]*)"/,
        `className="$1 ${additionalClasses}"`
      );
    }
  }
  
  // Handle children override - replace text content in first text-containing element
  if (propsOverride['children'] && typeof propsOverride['children'] === 'string') {
    const newChildren = propsOverride['children'];
    // Find first element with text content and replace it
    // Match >text< pattern (text between tags)
    const textMatch = modifiedCode.match(/>([^<>]{2,50})</);
    if (textMatch) {
      modifiedCode = modifiedCode.replace(
        `>${textMatch[1]}<`,
        `>${newChildren}<`
      );
    }
  }
  
  return modifiedCode;
};

// Generate live code preview with current prop values
const generateLiveCode = (componentName: string, props: any[], propsOverride: Record<string, any>): string => {
  // Clean component name for import
  const cleanName = componentName.replace(/[^a-zA-Z0-9]/g, '');
  const kebabName = componentName.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2').replace(/[\s_]+/g, '-').toLowerCase();
  
  // Generate import statement
  const importLine = `import { ${cleanName} } from '@/components/ui/${kebabName}'`;
  
  // Generate props
  const propsString = (props || []).map((prop: any) => {
    const value = propsOverride[prop.name] ?? prop.defaultValue;
    if (value === undefined || value === '') return null;
    if (typeof value === 'boolean') return value ? prop.name : null;
    if (typeof value === 'number') return `${prop.name}={${value}}`;
    return `${prop.name}="${value}"`;
  }).filter(Boolean).join('\n    ');
  
  // Build usage
  const usage = propsString 
    ? `<${cleanName}\n    ${propsString}\n  >\n    {/* content */}\n  </${cleanName}>`
    : `<${cleanName}>\n    {/* content */}\n  </${cleanName}>`;
  
  return `// Import\n${importLine}\n\n// Usage\n${usage}`;
};

// ==========================================
// LIVE BLUEPRINT EDITOR - JSON RENDERER
// ==========================================

// Component Registry for JSON-based rendering
const ComponentRegistry: Record<string, React.FC<any>> = {
  // Container
  Container: ({ children, padding = 'p-4', gap = 'gap-4', layout = 'flex', direction = 'col', align, justify, className = '' }) => (
    <div className={cn(
      layout === 'grid' ? 'grid' : 'flex',
      layout === 'flex' && (direction === 'row' ? 'flex-row' : 'flex-col'),
      padding, gap, align, justify, className
    )}>
      {children}
    </div>
  ),
  
  // Card
  Card: ({ children, elevation = 'md', border = true, padding = 'p-6', rounded = 'lg', className = '' }) => (
    <div className={cn(
      'bg-zinc-900',
      elevation === 'sm' && 'shadow-sm',
      elevation === 'md' && 'shadow-md',
      elevation === 'lg' && 'shadow-lg shadow-black/20',
      border && 'border border-zinc-800',
      padding,
      rounded === 'sm' && 'rounded-sm',
      rounded === 'md' && 'rounded-md',
      rounded === 'lg' && 'rounded-lg',
      rounded === 'xl' && 'rounded-xl',
      className
    )}>
      {children}
    </div>
  ),
  
  // Button
  Button: ({ children, variant = 'primary', size = 'md', icon, iconPosition = 'left', disabled, loading, className = '' }) => {
    const IconComponent = icon ? (LucideIcons as any)[icon] : null;
    return (
      <button className={cn(
        'inline-flex items-center justify-center font-medium transition-all rounded-lg',
        // Size
        size === 'xs' && 'px-2 py-1 text-xs gap-1',
        size === 'sm' && 'px-3 py-1.5 text-sm gap-1.5',
        size === 'md' && 'px-4 py-2 text-sm gap-2',
        size === 'lg' && 'px-6 py-3 text-base gap-2',
        // Variant
        variant === 'primary' && 'bg-blue-600 text-white hover:bg-blue-700',
        variant === 'secondary' && 'bg-zinc-700 text-white hover:bg-zinc-600',
        variant === 'danger' && 'bg-red-600 text-white hover:bg-red-700',
        variant === 'outline' && 'border border-zinc-600 text-zinc-300 hover:bg-zinc-800',
        variant === 'ghost' && 'text-zinc-400 hover:bg-zinc-800 hover:text-white',
        disabled && 'opacity-50 cursor-not-allowed',
        className
      )} disabled={disabled}>
        {loading && <Loader2 className="w-4 h-4 animate-spin" />}
        {!loading && IconComponent && iconPosition === 'left' && <IconComponent className="w-4 h-4" />}
        {children}
        {!loading && IconComponent && iconPosition === 'right' && <IconComponent className="w-4 h-4" />}
      </button>
    );
  },
  
  // Badge
  Badge: ({ children, status = 'neutral', size = 'md', className = '' }) => (
    <span className={cn(
      'inline-flex items-center font-medium rounded-full',
      size === 'sm' && 'px-2 py-0.5 text-xs',
      size === 'md' && 'px-2.5 py-1 text-xs',
      status === 'success' && 'bg-emerald-500/20 text-emerald-400',
      status === 'warning' && 'bg-yellow-500/20 text-yellow-400',
      status === 'error' && 'bg-red-500/20 text-red-400',
      status === 'info' && 'bg-blue-500/20 text-blue-400',
      status === 'neutral' && 'bg-zinc-700 text-zinc-300',
      className
    )}>
      {children}
    </span>
  ),
  
  // Alert
  Alert: ({ severity = 'info', title, message, icon, dismissible, onDismiss, className = '' }) => {
    const icons: Record<string, any> = {
      info: Info,
      success: CheckCircle,
      warning: AlertTriangle,
      error: AlertCircle,
    };
    const IconComponent = icon ? (LucideIcons as any)[icon] : icons[severity];
    return (
      <div className={cn(
        'p-4 rounded-lg border flex gap-3',
        severity === 'info' && 'bg-blue-500/10 border-blue-500/30 text-blue-400',
        severity === 'success' && 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400',
        severity === 'warning' && 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400',
        severity === 'error' && 'bg-red-500/10 border-red-500/30 text-red-400',
        className
      )}>
        {IconComponent && <IconComponent className="w-5 h-5 flex-shrink-0 mt-0.5" />}
        <div className="flex-1 min-w-0">
          {title && <div className="font-semibold mb-1">{title}</div>}
          {message && <div className="text-sm opacity-90">{message}</div>}
        </div>
        {dismissible && (
          <button onClick={onDismiss} className="p-1 hover:bg-white/10 rounded">
            <X className="w-4 h-4" />
          </button>
        )}
      </div>
    );
  },
  
  // Text
  Text: ({ children, size = 'base', weight = 'normal', color = 'text-zinc-300', className = '' }) => (
    <p className={cn(
      size === 'xs' && 'text-xs',
      size === 'sm' && 'text-sm',
      size === 'base' && 'text-base',
      size === 'lg' && 'text-lg',
      size === 'xl' && 'text-xl',
      size === '2xl' && 'text-2xl',
      size === '3xl' && 'text-3xl',
      weight === 'normal' && 'font-normal',
      weight === 'medium' && 'font-medium',
      weight === 'semibold' && 'font-semibold',
      weight === 'bold' && 'font-bold',
      color,
      className
    )}>
      {children}
    </p>
  ),
  
  // Heading
  Heading: ({ children, level = 2, className = '' }) => {
    const sizes: Record<number, string> = {
      1: 'text-4xl font-bold',
      2: 'text-3xl font-bold',
      3: 'text-2xl font-semibold',
      4: 'text-xl font-semibold',
      5: 'text-lg font-medium',
      6: 'text-base font-medium',
    };
    return <div className={cn(sizes[level], 'text-white', className)}>{children}</div>;
  },
  
  // Input
  Input: ({ type = 'text', placeholder, label, error, disabled, className = '' }) => (
    <div className={cn('space-y-1.5', className)}>
      {label && <label className="text-sm font-medium text-zinc-400">{label}</label>}
      <input
        type={type}
        placeholder={placeholder}
        disabled={disabled}
        className={cn(
          'w-full px-3 py-2 bg-zinc-800 border rounded-lg text-white placeholder:text-zinc-500 focus:outline-none focus:ring-2',
          error ? 'border-red-500 focus:ring-red-500/30' : 'border-zinc-700 focus:ring-blue-500/30 focus:border-blue-500',
          disabled && 'opacity-50 cursor-not-allowed'
        )}
      />
      {error && <p className="text-xs text-red-400">{error}</p>}
    </div>
  ),
  
  // Avatar
  Avatar: ({ src, alt, size = 'md', fallback, className = '' }) => {
    const sizes: Record<string, string> = {
      xs: 'w-6 h-6 text-xs',
      sm: 'w-8 h-8 text-sm',
      md: 'w-10 h-10 text-base',
      lg: 'w-12 h-12 text-lg',
      xl: 'w-16 h-16 text-xl',
    };
    return (
      <div className={cn(
        'rounded-full bg-zinc-700 flex items-center justify-center overflow-hidden',
        sizes[size],
        className
      )}>
        {src ? (
          <img src={src} alt={alt || ''} className="w-full h-full object-cover" />
        ) : (
          <span className="text-zinc-400 font-medium">{fallback || '?'}</span>
        )}
      </div>
    );
  },
  
  // Icon
  Icon: ({ name, size = 'md', color = 'text-zinc-400', className = '' }) => {
    const IconComponent = (LucideIcons as any)[name];
    if (!IconComponent) return null;
    const sizes: Record<string, string> = { sm: 'w-4 h-4', md: 'w-5 h-5', lg: 'w-6 h-6' };
    return <IconComponent className={cn(sizes[size], color, className)} />;
  },
  
  // Divider
  Divider: ({ orientation = 'horizontal', className = '' }) => (
    <div className={cn(
      'bg-zinc-800',
      orientation === 'horizontal' ? 'h-px w-full' : 'w-px h-full',
      className
    )} />
  ),
  
  // Progress
  Progress: ({ value = 0, size = 'md', color = 'bg-blue-500', showLabel, className = '' }) => (
    <div className={cn('w-full', className)}>
      <div className={cn(
        'w-full bg-zinc-800 rounded-full overflow-hidden',
        size === 'sm' && 'h-1',
        size === 'md' && 'h-2',
        size === 'lg' && 'h-3',
      )}>
        <div 
          className={cn('h-full transition-all duration-300', color)}
          style={{ width: `${Math.min(100, Math.max(0, value))}%` }}
        />
      </div>
      {showLabel && <div className="text-xs text-zinc-500 mt-1 text-right">{value}%</div>}
    </div>
  ),
  
  // Image
  Image: ({ src, alt, rounded = 'md', aspectRatio = 'auto', className = '' }) => (
    <div className={cn(
      'overflow-hidden bg-zinc-800',
      rounded === 'sm' && 'rounded-sm',
      rounded === 'md' && 'rounded-md',
      rounded === 'lg' && 'rounded-lg',
      rounded === 'full' && 'rounded-full',
      aspectRatio === 'square' && 'aspect-square',
      aspectRatio === 'video' && 'aspect-video',
      aspectRatio === 'wide' && 'aspect-[21/9]',
      className
    )}>
      <img src={src || 'https://picsum.photos/400/300'} alt={alt || ''} className="w-full h-full object-cover" />
    </div>
  ),
  
  // Spacer
  Spacer: ({ size = 'md' }) => {
    const sizes: Record<string, string> = {
      xs: 'h-2', sm: 'h-4', md: 'h-6', lg: 'h-8', xl: 'h-12'
    };
    return <div className={sizes[size]} />;
  },
  
  // Grid
  Grid: ({ children, cols = 2, gap = 'gap-4', className = '' }) => (
    <div className={cn(
      'grid',
      cols === 1 && 'grid-cols-1',
      cols === 2 && 'grid-cols-2',
      cols === 3 && 'grid-cols-3',
      cols === 4 && 'grid-cols-4',
      cols === 6 && 'grid-cols-6',
      cols === 12 && 'grid-cols-12',
      gap,
      className
    )}>
      {children}
    </div>
  ),
};

// JSON Renderer - renders JSON schema to live components
const JsonRenderer: React.FC<{ schema: any; depth?: number }> = ({ schema, depth = 0 }) => {
  // Prevent infinite recursion
  if (depth > 20) return null;
  
  // Handle null/undefined
  if (schema === null || schema === undefined) return null;
  
  // If it's a string, render as text
  if (typeof schema === 'string') return <>{schema}</>;
  
  // If it's a number or boolean, render as string
  if (typeof schema === 'number' || typeof schema === 'boolean') {
    return <>{String(schema)}</>;
  }
  
  // If it's an array, render each item
  if (Array.isArray(schema)) {
    return <>{schema.map((item, i) => <JsonRenderer key={i} schema={item} depth={depth + 1} />)}</>;
  }
  
  // Must be an object with component property
  if (typeof schema !== 'object' || !schema.component) {
    // Not a valid component schema - render as debug info
    console.warn('[JsonRenderer] Invalid schema:', schema);
    return null;
  }
  
  const { component, props = {}, children, className } = schema;
  
  // Get component from registry
  const Component = ComponentRegistry[component];
  
  if (!Component) {
    // Fallback for unknown components
    return (
      <div className="p-2 border border-dashed border-yellow-500/50 rounded text-yellow-500 text-xs">
        Unknown: {component}
      </div>
    );
  }
  
  // Render children recursively
  const renderedChildren = children ? (
    typeof children === 'string' ? children : <JsonRenderer schema={children} depth={depth + 1} />
  ) : null;
  
  return (
    <Component {...props} className={cn(props.className, className)}>
      {renderedChildren}
    </Component>
  );
};

// Syntax highlighter for code display - Storybook-like colors
const highlightCode = (code: string): string => {
  if (!code) return '';
  
  let highlighted = code
    // Escape HTML first
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
  
  // Opening tag brackets and tag name - cyan for tag, gray for brackets
  highlighted = highlighted.replace(
    /(&lt;)(\/?)([\w-]+)/g,
    '<span class="text-zinc-500">$1</span>$2<span class="text-cyan-400">$3</span>'
  );
  
  // Closing brackets - gray
  highlighted = highlighted.replace(
    /(\/?&gt;)/g,
    '<span class="text-zinc-500">$1</span>'
  );
  
  // Attributes before = sign - purple/violet
  highlighted = highlighted.replace(
    /\s([\w-]+)(=)/g,
    ' <span class="text-purple-400">$1</span><span class="text-zinc-500">$2</span>'
  );
  
  // String values in double quotes - amber/orange
  highlighted = highlighted.replace(
    /"([^"]*)"/g,
    '<span class="text-zinc-500">"</span><span class="text-amber-400">$1</span><span class="text-zinc-500">"</span>'
  );
  
  // String values in single quotes - amber/orange  
  highlighted = highlighted.replace(
    /'([^']*)'/g,
    '<span class="text-zinc-500">\'</span><span class="text-amber-400">$1</span><span class="text-zinc-500">\'</span>'
  );
  
  // Numbers - blue
  highlighted = highlighted.replace(
    /\b(\d+\.?\d*)\b/g,
    '<span class="text-blue-400">$1</span>'
  );
  
  // Comments - muted gray
  highlighted = highlighted.replace(
    /(\/\/[^\n]*)/g,
    '<span class="text-zinc-600 italic">$1</span>'
  );
  highlighted = highlighted.replace(
    /(\/\*[\s\S]*?\*\/)/g,
    '<span class="text-zinc-600 italic">$1</span>'
  );
  
  // JSX expressions {..} - yellow/gold
  highlighted = highlighted.replace(
    /(\{[^}]*\})/g,
    '<span class="text-yellow-300">$1</span>'
  );
  
  // Boolean and special keywords - pink
  highlighted = highlighted.replace(
    /\b(true|false|null|undefined)\b/g,
    '<span class="text-pink-400">$1</span>'
  );
  
  // Component names (PascalCase) - emerald
  highlighted = highlighted.replace(
    /(&lt;\/?)(<span class="text-cyan-400">)([A-Z][A-Za-z0-9]*)/g,
    '$1$2<span class="text-emerald-400">$3</span>'
  );
  
  return highlighted;
};

// Convert JSX code to plain HTML for rendering (Storybook-like preview)
// Uses stable hash-based IDs for images to prevent random changes on re-render
const jsxToHtml = (jsxCode: string): string => {
  if (!jsxCode) return '';
  
  // Create a stable seed from the code itself - this ensures same code = same images
  const codeSeed = simpleHash(jsxCode);
  // VERIFIED working picsum IDs for stable image selection
  const validPicsumIds = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70];
  // Helper to get stable image ID based on seed and offset
  const getStableImageId = (offset: number) => validPicsumIds[(codeSeed + offset) % validPicsumIds.length];
  
  let html = jsxCode;
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STRIP JSX/REACT BOILERPLATE - Extract only the JSX content
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Remove leading comments like "// Next.js App Router Page // ..."
  html = html.replace(/^(\/\/[^\n]*\n?)+/gm, '');
  
  // Remove "use client" directive
  html = html.replace(/^['"]use client['"];\s*/m, '');
  
  // Remove import statements
  html = html.replace(/^import\s+[^;]+;\s*/gm, '');
  
  // Extract content from "export default function ...() { return (...) }"
  // Match the return statement and extract JSX inside
  const returnMatch = html.match(/return\s*\(\s*([\s\S]*)\s*\)\s*;?\s*\}?\s*$/);
  if (returnMatch && returnMatch[1]) {
    html = returnMatch[1].trim();
    // Remove trailing );}
    html = html.replace(/\s*\)\s*;?\s*\}?\s*$/, '');
  } else {
    // Try to find JSX starting with < after function declaration
    const jsxStartMatch = html.match(/(?:function\s+\w+\s*\([^)]*\)\s*\{[\s\S]*?return\s*\()?\s*(<[\s\S]+)/);
    if (jsxStartMatch && jsxStartMatch[1]) {
      html = jsxStartMatch[1].trim();
      // Clean up any trailing function closure
      html = html.replace(/\s*\)\s*;?\s*\}?\s*$/, '');
    }
  }
  
  // Remove function declarations that might still be at the start
  html = html.replace(/^(export\s+)?(default\s+)?function\s+\w+\s*\([^)]*\)\s*\{\s*/m, '');
  html = html.replace(/^const\s+\w+\s*=\s*\([^)]*\)\s*=>\s*\{?\s*/m, '');
  html = html.replace(/^const\s+\w+\s*=\s*\(\)\s*=>\s*\(?\s*/m, '');
  
  // Remove any "// Mock state" or similar comments
  html = html.replace(/\/\/[^\n]*\n/g, '');
  
  // Remove const declarations (state, variables)
  html = html.replace(/const\s+\w+\s*=\s*[^;]+;\s*/g, '');
  
  // ═══════════════════════════════════════════════════════════════════════════
  // FIX INCOMPLETE/BROKEN CSS CLASSES (common AI generation errors)
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Fix incomplete Tailwind classes ending with hyphen (e.g., "animate-" -> "animate-pulse")
  // These cause Babel syntax errors: "Unterminated string constant"
  html = html.replace(/class="([^"]*)"/g, (match, classes) => {
    const fixedClasses = classes
      // Fix incomplete animate- classes
      .replace(/\banimate-(?=\s|"|$)/g, 'animate-pulse ')
      // Fix incomplete text- classes
      .replace(/\btext-(?=\s|"|$)/g, 'text-base ')
      // Fix incomplete bg- classes
      .replace(/\bbg-(?=\s|"|$)/g, 'bg-zinc-900 ')
      // Fix incomplete border- classes
      .replace(/\bborder-(?=\s|"|$)/g, 'border-zinc-700 ')
      // Fix incomplete p- classes
      .replace(/\bp-(?=\s|"|$)/g, 'p-4 ')
      // Fix incomplete m- classes
      .replace(/\bm-(?=\s|"|$)/g, 'm-0 ')
      // Fix incomplete rounded- classes
      .replace(/\brounded-(?=\s|"|$)/g, 'rounded-lg ')
      // Fix incomplete flex- classes
      .replace(/\bflex-(?=\s|"|$)/g, 'flex-1 ')
      // Fix incomplete gap- classes
      .replace(/\bgap-(?=\s|"|$)/g, 'gap-4 ')
      // Fix incomplete w- classes
      .replace(/\bw-(?=\s|"|$)/g, 'w-full ')
      // Fix incomplete h- classes
      .replace(/\bh-(?=\s|"|$)/g, 'h-auto ')
      // Remove any class that still ends with hyphen (catch-all)
      .replace(/\b[a-z]+-(?=\s|$)/g, '')
      // Clean up multiple spaces
      .replace(/\s+/g, ' ')
      .trim();
    return `class="${fixedClasses}"`;
  });
  
  // Also fix className (before conversion to class)
  html = html.replace(/className="([^"]*)"/g, (match, classes) => {
    const fixedClasses = classes
      .replace(/\banimate-(?=\s|"|$)/g, 'animate-pulse ')
      .replace(/\btext-(?=\s|"|$)/g, 'text-base ')
      .replace(/\bbg-(?=\s|"|$)/g, 'bg-zinc-900 ')
      .replace(/\bborder-(?=\s|"|$)/g, 'border-zinc-700 ')
      .replace(/\bp-(?=\s|"|$)/g, 'p-4 ')
      .replace(/\bm-(?=\s|"|$)/g, 'm-0 ')
      .replace(/\brounded-(?=\s|"|$)/g, 'rounded-lg ')
      .replace(/\bflex-(?=\s|"|$)/g, 'flex-1 ')
      .replace(/\bgap-(?=\s|"|$)/g, 'gap-4 ')
      .replace(/\bw-(?=\s|"|$)/g, 'w-full ')
      .replace(/\bh-(?=\s|"|$)/g, 'h-auto ')
      .replace(/\b[a-z]+-(?=\s|$)/g, '')
      .replace(/\s+/g, ' ')
      .trim();
    return `className="${fixedClasses}"`;
  });
  
  // First: Convert class={...} to class="..." (handle JSX curly brace classes)
  // This handles: class={`...`} or class={'...'} or class={"..."}
  html = html.replace(/class=\{[`'"](.*?)[`'"]\}/g, 'class="$1"');
  html = html.replace(/class=\{([^}]+)\}/g, (match, content) => {
    // Try to extract string value from expressions like cn('...', ...) or clsx(...)
    const stringMatch = content.match(/['"`]([^'"`]+)['"`]/);
    if (stringMatch) {
      return `class="${stringMatch[1]}"`;
    }
    // Fallback: just remove the attribute if we can't parse it
    return '';
  });
  
  // Replace className with class (JSX -> HTML)
  html = html.replace(/className=/g, 'class=');
  
  // Handle className={...} same way
  html = html.replace(/class=\{[`'"](.*?)[`'"]\}/g, 'class="$1"');
  html = html.replace(/class=\{([^}]+)\}/g, (match, content) => {
    const stringMatch = content.match(/['"`]([^'"`]+)['"`]/);
    if (stringMatch) return `class="${stringMatch[1]}"`;
    return '';
  });
  
  // Replace htmlFor with for
  html = html.replace(/htmlFor=/g, 'for=');
  
  // Replace tabIndex with tabindex
  html = html.replace(/tabIndex=/g, 'tabindex=');
  
  // Remove React-specific attributes (all event handlers)
  html = html.replace(/\s+(on[A-Z][a-zA-Z]*)=\{[^}]*\}/g, '');
  html = html.replace(/\s+key=\{[^}]*\}/g, '');
  html = html.replace(/\s+ref=\{[^}]*\}/g, '');
  
  // Convert style={{ ... }} to style="..."
  html = html.replace(/style=\{\{([^}]+)\}\}/g, (match, styles) => {
    const cssString = styles
      .replace(/([a-zA-Z]+):/g, (m: string, prop: string) => {
        // Convert camelCase to kebab-case
        return prop.replace(/([A-Z])/g, '-$1').toLowerCase() + ':';
      })
      .replace(/,\s*/g, '; ')
      .replace(/'/g, '')
      .replace(/"/g, '');
    return `style="${cssString}"`;
  });
  
  // ═══════════════════════════════════════════════════════════════════════════
  // LUCIDE ICONS CONVERSION - Map React component names to Lucide icon names
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Map React icon component names to Lucide data-lucide attribute names
  const lucideIconMap: Record<string, string> = {
    // Navigation & Menu
    'home': 'home', 'menu': 'menu', 'x': 'x', 'close': 'x',
    'chevronright': 'chevron-right', 'chevronleft': 'chevron-left',
    'chevrondown': 'chevron-down', 'chevronup': 'chevron-up',
    'arrowright': 'arrow-right', 'arrowleft': 'arrow-left',
    'arrowup': 'arrow-up', 'arrowdown': 'arrow-down',
    'externallink': 'external-link', 'morevertical': 'more-vertical',
    'morehorizontal': 'more-horizontal',
    
    // Actions
    'search': 'search', 'plus': 'plus', 'minus': 'minus',
    'check': 'check', 'trash': 'trash-2', 'trash2': 'trash-2',
    'edit': 'edit', 'edit2': 'edit-2', 'edit3': 'edit-3',
    'copy': 'copy', 'download': 'download', 'upload': 'upload',
    'share': 'share-2', 'share2': 'share-2', 'refresh': 'refresh-cw',
    'filter': 'filter', 'sort': 'arrow-up-down',
    
    // Media
    'play': 'play', 'pause': 'pause', 'stop': 'stop-circle',
    'playcircle': 'play-circle', 'pausecircle': 'pause-circle',
    'skipforward': 'skip-forward', 'skipback': 'skip-back',
    'volume': 'volume-2', 'volume2': 'volume-2', 'volumex': 'volume-x',
    'mic': 'mic', 'micoff': 'mic-off', 'camera': 'camera',
    'image': 'image', 'video': 'video', 'music': 'music',
    'youtube': 'youtube', 'tv': 'tv',
    
    // Communication
    'mail': 'mail', 'inbox': 'inbox', 'send': 'send',
    'messagesquare': 'message-square', 'messagecircle': 'message-circle',
    'phone': 'phone', 'phonecall': 'phone-call',
    'bell': 'bell', 'belloff': 'bell-off', 'bellring': 'bell-ring',
    
    // Social & Favorites
    'heart': 'heart', 'star': 'star', 'thumbsup': 'thumbs-up',
    'thumbsdown': 'thumbs-down', 'bookmark': 'bookmark',
    
    // User & Account
    'user': 'user', 'users': 'users', 'user2': 'user',
    'userplus': 'user-plus', 'userminus': 'user-minus',
    'usercheck': 'user-check', 'userx': 'user-x',
    'settings': 'settings', 'cog': 'cog', 'sliders': 'sliders',
    'logout': 'log-out', 'login': 'log-in',
    
    // Status & Feedback
    'checkcircle': 'check-circle', 'checkcircle2': 'check-circle-2',
    'xcircle': 'x-circle', 'alertcircle': 'alert-circle',
    'alerttriangle': 'alert-triangle', 'info': 'info',
    'helpercircle': 'help-circle', 'loader': 'loader', 'loader2': 'loader-2',
    
    // Interface
    'eye': 'eye', 'eyeoff': 'eye-off',
    'grid': 'grid', 'grid3x3': 'grid-3x3', 'list': 'list',
    'layout': 'layout', 'layoutdashboard': 'layout-dashboard',
    'layoutgrid': 'layout-grid', 'columns': 'columns',
    'maximize': 'maximize', 'maximize2': 'maximize-2',
    'minimize': 'minimize', 'minimize2': 'minimize-2',
    'expand': 'expand', 'shrink': 'shrink',
    'fullscreen': 'maximize', 'exitfullscreen': 'minimize',
    
    // Commerce
    'shoppingcart': 'shopping-cart', 'shoppingbag': 'shopping-bag',
    'creditcard': 'credit-card', 'package': 'package',
    'truck': 'truck', 'gift': 'gift', 'tag': 'tag', 'tags': 'tags',
    'receipt': 'receipt', 'wallet': 'wallet',
    
    // Time & Date
    'clock': 'clock', 'calendar': 'calendar', 'timer': 'timer',
    'history': 'history', 'alarm': 'alarm-clock',
    
    // Files & Folders
    'file': 'file', 'filetext': 'file-text', 'filex': 'file-x',
    'folder': 'folder', 'folderopen': 'folder-open',
    'folderplus': 'folder-plus', 'archive': 'archive',
    
    // Weather
    'sun': 'sun', 'moon': 'moon', 'cloud': 'cloud',
    'cloudrain': 'cloud-rain', 'cloudsun': 'cloud-sun',
    'wind': 'wind', 'thermometer': 'thermometer',
    
    // Security
    'lock': 'lock', 'unlock': 'unlock', 'key': 'key',
    'shield': 'shield', 'shieldcheck': 'shield-check',
    
    // Tech & Devices
    'monitor': 'monitor', 'smartphone': 'smartphone',
    'tablet': 'tablet', 'laptop': 'laptop',
    'server': 'server', 'database': 'database',
    'wifi': 'wifi', 'wifioff': 'wifi-off',
    'bluetooth': 'bluetooth', 'cpu': 'cpu',
    'harddrive': 'hard-drive', 'usb': 'usb',
    
    // Objects
    'zap': 'zap', 'flame': 'flame', 'fire': 'flame',
    'rocket': 'rocket', 'target': 'target',
    'award': 'award', 'crown': 'crown', 'trophy': 'trophy',
    'flag': 'flag', 'globe': 'globe', 'map': 'map',
    'mappin': 'map-pin', 'navigation': 'navigation',
    'compass': 'compass', 'anchor': 'anchor',
    
    // Shapes & Misc
    'circle': 'circle', 'square': 'square',
    'triangle': 'triangle', 'diamond': 'diamond',
    'hexagon': 'hexagon', 'octagon': 'octagon',
    'percent': 'percent', 'hash': 'hash', 'athsign': 'at-sign',
    'link': 'link', 'link2': 'link-2', 'unlink': 'unlink',
    'paperclip': 'paperclip', 'scissors': 'scissors',
    'code': 'code', 'code2': 'code-2', 'terminal': 'terminal',
    'braces': 'braces', 'brackets': 'brackets',
    
    // Arrows & Directions
    'moveup': 'move-up', 'movedown': 'move-down',
    'moveleft': 'move-left', 'moveright': 'move-right',
    'cornerdownleft': 'corner-down-left', 'cornerdownright': 'corner-down-right',
    'cornerupleft': 'corner-up-left', 'cornerupright': 'corner-up-right',
    'rotateccw': 'rotate-ccw', 'rotatecw': 'rotate-cw',
    'repeat': 'repeat', 'shuffle': 'shuffle',
    
    // Misc fallbacks
    'dot': 'circle', 'dots': 'more-horizontal', 'ellipsis': 'more-horizontal',
    'grip': 'grip-vertical', 'gripvertical': 'grip-vertical',
    'griphorizontal': 'grip-horizontal',
  };
  
  // Convert <IconName /> React components to Lucide <i data-lucide="...">
  for (const [componentName, lucideName] of Object.entries(lucideIconMap)) {
    // Match: <Home />, <HomeIcon />, <Home className="..." />, etc.
    const regex = new RegExp(`<${componentName}(icon)?\\s*([^>]*)\\s*\\/?>`, 'gi');
    html = html.replace(regex, (match, iconSuffix, attrs) => {
      // Extract className if present
      const classMatch = attrs?.match(/className="([^"]+)"/i) || attrs?.match(/class="([^"]+)"/i);
      const classes = classMatch ? classMatch[1] : 'w-5 h-5';
      return `<i data-lucide="${lucideName}" class="${classes}"></i>`;
    });
  }
  
  // Fallback: Convert any remaining <PascalCaseIcon /> to Lucide kebab-case
  html = html.replace(/<([A-Z][a-zA-Z]+)(Icon)?\s*([^>]*)\s*\/?>/g, (match, name, iconSuffix, attrs) => {
    // Skip known HTML elements
    const htmlElements = ['Div', 'Span', 'Button', 'Input', 'Form', 'Section', 'Header', 'Footer', 'Nav', 'Main', 'Article', 'Aside'];
    if (htmlElements.includes(name)) return match;
    
    // Convert PascalCase to kebab-case for Lucide
    const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
    const classMatch = attrs?.match(/className="([^"]+)"/i) || attrs?.match(/class="([^"]+)"/i);
    const classes = classMatch ? classMatch[1] : 'w-5 h-5';
    
    // Return Lucide icon element
    return `<i data-lucide="${kebabName}" class="${classes}"></i>`;
  });
  
  // Remove any remaining self-closing JSX components silently (they're likely already converted)
  html = html.replace(/<([A-Z][a-zA-Z]*)\s+[^>]*\/>/g, '');
  html = html.replace(/<([A-Z][a-zA-Z]*)\s*\/>/g, '');
  
  // ═══════════════════════════════════════════════════════════════════════════
  // CONVERT JSX src/href EXPRESSIONS TO PLAIN STRINGS FIRST
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Convert src={`...`} template literals to src="..."
  html = html.replace(/src=\{`([^`]+)`\}/g, 'src="$1"');
  html = html.replace(/href=\{`([^`]+)`\}/g, 'href="$1"');
  
  // Convert src={variable} or src={"..."} to src="..."
  html = html.replace(/src=\{"([^"]+)"\}/g, 'src="$1"');
  html = html.replace(/src=\{'([^']+)'\}/g, 'src="$1"');
  html = html.replace(/href=\{"([^"]+)"\}/g, 'href="$1"');
  html = html.replace(/href=\{'([^']+)'\}/g, 'href="$1"');
  
  // Convert src={props.imageUrl} or src={imageUrl} or src={image} to placeholder
  html = html.replace(/src=\{[a-zA-Z_.[\]]+\}/g, 'src="https://picsum.photos/id/42/400/300"');
  html = html.replace(/href=\{[a-zA-Z_.[\]]+\}/g, 'href="#"');
  
  // AGGRESSIVE: Fix ALL remaining src with curly braces (JSX expressions)
  html = html.replace(/src=\{[^}]+\}/g, 'src="https://picsum.photos/id/43/400/300"');
  
  // Remove JSX expressions like {variable} - but be careful not to break template literals
  // Only remove if it's clearly a JSX expression (not inside an attribute value)
  html = html.replace(/>\s*\{[^{}]*\}\s*</g, '><'); // Remove expressions between tags
  html = html.replace(/\{[^{}]*\}/g, ''); // Remove remaining expressions
  
  // Remove React fragments
  html = html.replace(/<React\.Fragment>/g, '');
  html = html.replace(/<\/React\.Fragment>/g, '');
  html = html.replace(/<>/g, '');
  html = html.replace(/<\/>/g, '');
  
  // Clean up whitespace
  html = html.replace(/\s+>/g, '>');
  html = html.replace(/\s+class="/g, ' class="');
  html = html.replace(/class="\s+/g, 'class="');
  html = html.replace(/"\s+>/g, '">');
  
  // Remove empty class attributes
  html = html.replace(/\s+class=""/g, '');
  
  // ═══════════════════════════════════════════════════════════════════════════
  // FIX BROKEN IMAGE URLs (common AI generation errors)
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Fix URLs with trailing )} from template literal errors
  html = html.replace(/src="([^"]+)\)?\}"/g, (match, url) => {
    const cleanUrl = url.replace(/[\)\}\`]+$/, '').replace(/\$\{.*$/, '');
    return `src="${cleanUrl}"`;
  });
  
  // Fix picsum.photos URLs with syntax errors
  html = html.replace(/https:\/\/picsum\.photos\/[^"'\s>]+/g, (url) => {
    // Clean up any trailing garbage
    return url.replace(/[\)\}\`\$\{]+/g, '').replace(/[^0-9a-zA-Z\/\.\-\?=&]/g, '');
  });
  
  // Replace broken/invalid image sources with working placeholders
  html = html.replace(/src="[^"]*undefined[^"]*"/g, 'src="https://picsum.photos/400/300"');
  html = html.replace(/src=""/g, 'src="https://picsum.photos/400/300"');
  html = html.replace(/src="\$\{[^}]*\}"/g, 'src="https://picsum.photos/400/300"');
  
  // ═══════════════════════════════════════════════════════════════════════════
  // INJECT PLACEHOLDER IMAGES FOR COMPONENTS THAT SHOULD HAVE IMAGES
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Check if this looks like a card/hero/banner but has no images
  const looksLikeImageComponent = /card|hero|banner|feature|testimonial|product|profile|avatar|team|gallery|poster|thumbnail|cover/i.test(html);
  const hasNoImages = !/<img\s/i.test(html);
  const hasImagePlaceholder = /\[Image\]|\[Placeholder\]|image-placeholder/i.test(html);
  
  // If it looks like it should have images but doesn't, inject one
  if ((looksLikeImageComponent || hasImagePlaceholder) && hasNoImages) {
    // Find a good place to inject - after opening div or at start of content
    const imageId = getStableImageId(0); // Stable id based on code hash
    const placeholderImg = `<img src="https://picsum.photos/id/${imageId}/400/300" class="w-full h-48 object-cover rounded-lg mb-4" alt="Preview" />`;
    
    // Try to inject after first opening tag
    if (html.match(/^<[a-z]+[^>]*>/i)) {
      html = html.replace(/^(<[a-z]+[^>]*>)/i, `$1${placeholderImg}`);
    }
  }
  
  // Fix any remaining broken image patterns
  // src with curly braces anywhere
  html = html.replace(/src="\{[^"]*\}"/g, 'src="https://picsum.photos/id/44/400/300"');
  // src with backticks
  html = html.replace(/src="`[^`]*`"/g, 'src="https://picsum.photos/id/45/400/300"');
  // src pointing to localhost or relative paths
  html = html.replace(/src="\/[^"]*"/g, 'src="https://picsum.photos/id/46/400/300"');
  html = html.replace(/src="\.\.?\/[^"]*"/g, 'src="https://picsum.photos/id/47/400/300"');
  // Empty or whitespace-only src
  html = html.replace(/src="\s*"/g, 'src="https://picsum.photos/id/48/400/300"');
  // src with undefined or null text
  html = html.replace(/src="undefined"/g, 'src="https://picsum.photos/id/49/400/300"');
  html = html.replace(/src="null"/g, 'src="https://picsum.photos/id/50/400/300"');
  // src with just a variable name
  html = html.replace(/src="[a-zA-Z_]+"/g, (match) => {
    // Don't replace valid URLs
    if (match.includes('http') || match.includes('data:')) return match;
    return 'src="https://picsum.photos/id/51/400/300"';
  });
  
  // For avatar-like components, use pravatar
  if (/avatar|profile|user|team|author/i.test(html)) {
    const userId = (codeSeed % 70) + 1; // Stable user ID based on code hash
    html = html.replace(/src="https:\/\/picsum\.photos\/[^"]+"/g, `src="https://i.pravatar.cc/150?img=${userId}"`);
  }
  
  // FINAL FIX: Ensure ALL <img> tags have valid src
  // Find <img> tags without src or with broken src
  let imgCounter = 0;
  html = html.replace(/<img([^>]*)>/gi, (match, attrs) => {
    // Check if has valid src
    if (attrs.includes('src="http') || attrs.includes("src='http") || attrs.includes('src="data:')) {
      return match; // Already has valid src
    }
    // If has no src attribute or empty/broken src, add one
    if (!attrs.includes('src=') || attrs.match(/src=["']\s*["']/)) {
      const imgId = getStableImageId(10 + imgCounter++); // Stable id based on code hash + counter
      // Add src attribute
      return `<img src="https://picsum.photos/id/${imgId}/400/300"${attrs.replace(/src=["'][^"']*["']/g, '')}>`;
    }
    return match;
  });
  
  // Also fix background-image URLs
  let bgCounter = 0;
  html = html.replace(/background-image:\s*url\(\s*['"]?([^)'"]+)['"]?\s*\)/gi, (match, url) => {
    if (url.startsWith('http') || url.startsWith('data:')) return match;
    const imgId = getStableImageId(30 + bgCounter++); // Stable id based on code hash + counter
    return `background-image: url('https://picsum.photos/id/${imgId}/800/600')`;
  });
  
  return html;
};

// Iframe Preview Component (like Storybook)
// Uses iframe with Tailwind CDN for full CSS support
const ShadowPreview = ({ 
  html, 
  background = "dark",
  className = ""
}: {
  html: string;
  background?: "light" | "dark" | "transparent";
  className?: string;
}) => {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const [iframeHeight, setIframeHeight] = useState(200);
  
  // Convert JSX to HTML
  const cleanHtml = useMemo(() => jsxToHtml(html || ''), [html]);
  
  // Create full HTML document for iframe
  const iframeDoc = useMemo(() => `<!DOCTYPE html>
<html lang="en" class="${background === "dark" ? "dark" : ""}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' },
            zinc: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b', 950: '#09090b' }
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; max-width: 100%; }
    html, body { 
      font-family: 'Inter', system-ui, sans-serif;
      background: ${background === "light" ? "#ffffff" : "#18181b"};
      color: ${background === "light" ? "#18181b" : "#ffffff"};
      overflow-x: hidden;
    }
    body {
      padding: 16px;
      max-width: 100%;
      overflow-x: hidden;
    }
    .preview-wrapper {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }
    /* Force responsive */
    img, video, iframe, svg { max-width: 100%; height: auto; }
    /* Image error state - placeholder */
    img[data-error="true"] {
      background: linear-gradient(135deg, #27272a 0%, #18181b 100%);
      display: flex !important;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      border-radius: 8px;
    }
    img[data-error="true"]::after {
      content: "Image";
      color: #52525b;
      font-size: 12px;
    }
    div, section, aside, nav, header, footer, main, article { max-width: 100%; overflow-x: hidden; }
    /* Marquee animation */
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .animate-marquee { animation: marquee 20s linear infinite; }
    /* Glass effect */
    .glass, [class*="backdrop-blur"] {
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    /* Fix flex layouts */
    .flex { display: flex !important; }
    .inline-flex { display: inline-flex !important; }
    .items-center { align-items: center !important; }
    .justify-between { justify-content: space-between !important; }
    .justify-center { justify-content: center !important; }
    .gap-1 { gap: 0.25rem !important; }
    .gap-2 { gap: 0.5rem !important; }
    .gap-3 { gap: 0.75rem !important; }
    .gap-4 { gap: 1rem !important; }
    .gap-6 { gap: 1.5rem !important; }
    /* Force visible text */
    [class*="text-white"] { color: white !important; }
    [class*="text-black"] { color: black !important; }
    /* Buttons base */
    button, [class*="btn"], a[class*="px-"] {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: transparent;
    }
    /* Common backgrounds */
    .bg-black { background-color: #000 !important; }
    .bg-white { background-color: #fff !important; }
    .bg-zinc-900 { background-color: #18181b !important; }
    .bg-zinc-800 { background-color: #27272a !important; }
    .bg-zinc-950 { background-color: #09090b !important; }
    /* Borders */
    .border { border-width: 1px !important; }
    .border-white\\/10 { border-color: rgba(255,255,255,0.1) !important; }
    .border-zinc-800 { border-color: #27272a !important; }
    .rounded-lg { border-radius: 0.5rem !important; }
    .rounded-xl { border-radius: 0.75rem !important; }
    .rounded-full { border-radius: 9999px !important; }
    /* Padding */
    .p-2 { padding: 0.5rem !important; }
    .p-3 { padding: 0.75rem !important; }
    .p-4 { padding: 1rem !important; }
    .px-3 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
    .px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
    .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
    .py-3 { padding-top: 0.75rem !important; padding-bottom: 0.75rem !important; }
    /* Text sizes */
    .text-xs { font-size: 0.75rem !important; }
    .text-sm { font-size: 0.875rem !important; }
    .text-base { font-size: 1rem !important; }
    .text-lg { font-size: 1.125rem !important; }
    .text-xl { font-size: 1.25rem !important; }
    .font-medium { font-weight: 500 !important; }
    .font-semibold { font-weight: 600 !important; }
    .font-bold { font-weight: 700 !important; }
    
    /* ═══════════════════════════════════════════════════════════════════════════ */
    /* FIX INVISIBLE ELEMENTS - AI often generates opacity:0 for animations       */
    /* ═══════════════════════════════════════════════════════════════════════════ */
    /* Force all elements visible */
    [style*="opacity: 0"], [style*="opacity:0"] {
      opacity: 1 !important;
    }
    /* Fix elements with transform animations that start hidden */
    [style*="translate"] {
      opacity: 1 !important;
      transform: none !important;
    }
    /* Common animation classes that hide elements initially */
    .fade-up, .fade-in, .fade-down, .slide-up, .slide-in, .animate-fade,
    [class*="fade-"], [class*="slide-"], [class*="stagger-"] {
      opacity: 1 !important;
      transform: none !important;
    }
    /* Framer Motion / GSAP style hidden states */
    [data-state="hidden"], [data-visible="false"] {
      opacity: 1 !important;
      visibility: visible !important;
    }
  </style>
</head>
<body>
  <div class="preview-wrapper" id="preview-content">${cleanHtml}</div>
  <script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FIX INVISIBLE ELEMENTS - Force all elements to be visible
    // ═══════════════════════════════════════════════════════════════════════════
    function forceVisible() {
      // Find all elements with inline opacity:0 and fix them
      document.querySelectorAll('*').forEach(el => {
        const style = el.getAttribute('style') || '';
        if (style.includes('opacity') && (style.includes('opacity: 0') || style.includes('opacity:0'))) {
          el.style.opacity = '1';
        }
        // Also fix transform with translateY for fade-up animations
        if (style.includes('translate') && style.includes('opacity')) {
          el.style.opacity = '1';
          el.style.transform = 'none';
        }
      });
    }
    
    // Auto-resize iframe to content
    function sendHeight() {
      const height = document.getElementById('preview-content')?.scrollHeight || 200;
      window.parent.postMessage({ type: 'IFRAME_HEIGHT', height: Math.max(height + 32, 120) }, '*');
    }
    
    // Send on load and after Tailwind processes
    window.addEventListener('load', () => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      forceVisible();
      setTimeout(sendHeight, 100);
    });
    
    // Run multiple times to catch dynamically rendered content
    setTimeout(() => { forceVisible(); sendHeight(); }, 100);
    setTimeout(() => { forceVisible(); sendHeight(); }, 500);
    setTimeout(() => { forceVisible(); sendHeight(); }, 1000);
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FIX BROKEN IMAGES - Replace failed images with Unsplash placeholders
    // ═══════════════════════════════════════════════════════════════════════════
    function fixBrokenImages() {
      document.querySelectorAll('img').forEach((img, index) => {
        // Skip if already processed or loading
        if (img.dataset.fixed) return;
        
        // Fix relative URLs and broken sources
        const src = img.getAttribute('src') || '';
        
        // Check for obviously broken sources
        const isBroken = !src || 
          src === '' || 
          src.startsWith('/') || 
          src.startsWith('./') || 
          src.startsWith('../') ||
          src.includes('placeholder') ||
          src.includes('example.com') ||
          src.includes('undefined') ||
          src.includes('null');
        
        if (isBroken) {
          // Replace with Unsplash placeholder based on context
          const alt = (img.getAttribute('alt') || '').toLowerCase();
          const className = (img.className || '').toLowerCase();
          const parentText = (img.parentElement?.textContent || '').toLowerCase();
          
          // Determine image type from context
          let unsplashQuery = 'abstract';
          if (alt.includes('avatar') || alt.includes('profile') || alt.includes('user') || className.includes('avatar') || className.includes('rounded-full')) {
            unsplashQuery = 'portrait,face';
          } else if (alt.includes('blog') || alt.includes('cover') || alt.includes('hero') || alt.includes('banner')) {
            unsplashQuery = 'technology,minimal';
          } else if (alt.includes('product') || alt.includes('item')) {
            unsplashQuery = 'product,minimal';
          } else if (alt.includes('team') || alt.includes('company')) {
            unsplashQuery = 'team,office';
          } else if (alt.includes('logo') || alt.includes('icon')) {
            unsplashQuery = 'abstract,geometric';
          }
          
          // Get dimensions from styles or defaults
          const width = img.offsetWidth || 400;
          const height = img.offsetHeight || 300;
          
          img.src = 'https://images.unsplash.com/photo-' + ['1618005182384-a83a8bd57fbe', '1557683316-973673baf926', '1579546929518-9e396f3cc809', '1558591710-4b4a1ae0f04d', '1557804506-669a67965ba0'][index % 5] + '?w=' + width + '&h=' + height + '&fit=crop&auto=format';
          img.dataset.fixed = 'true';
        }
        
        // Add error handler for images that fail to load later
        img.onerror = function() {
          if (!this.dataset.errorFixed) {
            const w = this.offsetWidth || 400;
            const h = this.offsetHeight || 300;
            this.src = 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=' + w + '&h=' + h + '&fit=crop&auto=format';
            this.dataset.errorFixed = 'true';
          }
        };
      });
    }
    
    // Run image fix on load and after delays
    window.addEventListener('load', fixBrokenImages);
    setTimeout(fixBrokenImages, 200);
    setTimeout(fixBrokenImages, 600);
  </script>
</body>
</html>`, [cleanHtml, background]);

  // Listen for height messages from iframe
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      if (event.data?.type === 'IFRAME_HEIGHT' && typeof event.data.height === 'number') {
        setIframeHeight(event.data.height);
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  return (
    <iframe
      ref={iframeRef}
      srcDoc={iframeDoc}
      className={cn("w-full border-0", className)}
      style={{ height: `${iframeHeight}px`, background: 'transparent', minHeight: '120px' }}
      sandbox="allow-scripts allow-same-origin"
      referrerPolicy="no-referrer"
      title="Component Preview"
    />
  );
};

// Interactive React Preview - Real React components with Tailwind + interactivity!
// Uses iframe with React runtime for full functionality (like Storybook/Sandpack)
const InteractiveReactPreview = ({ 
  code, 
  background = "dark",
  className = "",
  onSizeChange,
  onAccessibilityResults,
  isFullWidth = false,
  componentId
}: {
  code: string;
  background?: "light" | "dark" | "transparent";
  className?: string;
  onSizeChange?: (size: { width: number; height: number }) => void;
  onAccessibilityResults?: (results: { violations: any[]; passes: any[]; incomplete: any[] }) => void;
  isFullWidth?: boolean;
  componentId?: string;
}) => {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const [iframeHeight, setIframeHeight] = useState(200);
  const [iframeWidth, setIframeWidth] = useState(200);
  const [error, setError] = useState<string | null>(null);

  // Build full React app in iframe
  const iframeDoc = useMemo(() => {
    if (!code) return '';
    
    // Clean up code for React rendering
    let jsxCode = code;
    
    // Remove imports (we provide React globally)
    jsxCode = jsxCode.replace(/import\s+.*from\s+['"][^'"]+['"];?\n?/g, '');
    
    // CRITICAL: Convert HTML comments to JSX comments
    // <!-- comment --> -> {/* comment */}
    jsxCode = jsxCode.replace(/<!--\s*([\s\S]*?)\s*-->/g, '{/* $1 */}');
    
    // CRITICAL: Convert HTML void tags to JSX self-closing format
    // <br> -> <br />
    jsxCode = jsxCode.replace(/<br\s*>/gi, '<br />');
    // <hr> -> <hr />
    jsxCode = jsxCode.replace(/<hr\s*>/gi, '<hr />');
    // <img ...> -> <img ... /> (if not already self-closing)
    jsxCode = jsxCode.replace(/<img([^>]*[^\/])>/gi, '<img$1 />');
    // <input ...> -> <input ... />
    jsxCode = jsxCode.replace(/<input([^>]*[^\/])>/gi, '<input$1 />');
    // <meta ...> -> <meta ... />
    jsxCode = jsxCode.replace(/<meta([^>]*[^\/])>/gi, '<meta$1 />');
    // <link ...> -> <link ... />
    jsxCode = jsxCode.replace(/<link([^>]*[^\/])>/gi, '<link$1 />');
    // <source ...> -> <source ... />
    jsxCode = jsxCode.replace(/<source([^>]*[^\/])>/gi, '<source$1 />');
    // <area ...> -> <area ... />
    jsxCode = jsxCode.replace(/<area([^>]*[^\/])>/gi, '<area$1 />');
    // <embed ...> -> <embed ... />
    jsxCode = jsxCode.replace(/<embed([^>]*[^\/])>/gi, '<embed$1 />');
    
    // If code is wrapped in function component, extract it
    const componentMatch = jsxCode.match(/(?:export\s+default\s+)?function\s+(\w+)\s*\([^)]*\)\s*\{([\s\S]*)\}/);
    let componentName = 'PreviewComponent';
    let componentBody = jsxCode;
    
    if (componentMatch) {
      componentName = componentMatch[1] || 'PreviewComponent';
      componentBody = componentMatch[2];
    }
    
    // If it's just JSX (starts with <), wrap in component
    if (jsxCode.trim().startsWith('<') && !componentMatch) {
      componentBody = `return (${jsxCode})`;
    }

    // Background prop only affects workspace, NOT component styles
    // Components define their own colors via Tailwind classes
    const _bgColor = background; // unused - kept for API compatibility

    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axe-core/4.8.4/axe.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      background: ${background === "transparent" ? "transparent" : background === "dark" ? "#18181b" : "#ffffff"};
      color: ${background === "transparent" || background === "dark" ? "#fafafa" : "#18181b"};
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      /* Fill iframe viewport - content will be responsive */
      width: 100%;
      height: 100%;
      min-height: 100%;
      overflow: hidden !important;
    }
    #root { 
      /* Fill viewport - responsive layout */
      width: 100%;
      min-height: 100%;
      overflow: hidden !important;
      background: inherit;
    }
    /* Dark mode: convert white backgrounds to dark */
    ${background === "dark" ? `
    .bg-white { background-color: #27272a !important; }
    .bg-gray-50, .bg-zinc-50, .bg-slate-50 { background-color: #1f1f23 !important; }
    .bg-gray-100, .bg-zinc-100, .bg-slate-100 { background-color: #27272a !important; }
    .text-gray-900, .text-zinc-900, .text-slate-900 { color: #fafafa !important; }
    .text-gray-800, .text-zinc-800, .text-slate-800 { color: #e4e4e7 !important; }
    .text-gray-700, .text-zinc-700, .text-slate-700 { color: #d4d4d8 !important; }
    .border-gray-200, .border-zinc-200, .border-slate-200 { border-color: #3f3f46 !important; }
    .border-gray-300, .border-zinc-300, .border-slate-300 { border-color: #52525b !important; }
    .shadow-lg, .shadow-xl, .shadow-2xl { box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important; }
    ` : background === "transparent" ? `
    .bg-white, .bg-gray-50, .bg-zinc-50, .bg-slate-50, .bg-gray-100, .bg-zinc-100, .bg-slate-100 { background-color: transparent !important; }
    .text-gray-900, .text-zinc-900, .text-slate-900 { color: #fafafa !important; }
    .text-gray-800, .text-zinc-800, .text-slate-800 { color: #e4e4e7 !important; }
    .text-gray-700, .text-zinc-700, .text-slate-700 { color: #d4d4d8 !important; }
    .border-gray-200, .border-zinc-200, .border-slate-200 { border-color: #3f3f46 !important; }
    .border-gray-300, .border-zinc-300, .border-slate-300 { border-color: #52525b !important; }
    ` : ""}
    /* No scrollbars */
    ::-webkit-scrollbar { display: none !important; }
    * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
    .error-display {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    /* Icon placeholders */
    .icon-placeholder { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      width: 1em; 
      height: 1em; 
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════ */
    /* FIX INVISIBLE ELEMENTS - AI often generates opacity:0 for animations       */
    /* ═══════════════════════════════════════════════════════════════════════════ */
    /* Force all elements visible */
    [style*="opacity: 0"], [style*="opacity:0"] {
      opacity: 1 !important;
    }
    /* Fix elements with transform animations that start hidden */
    [style*="translate"] {
      opacity: 1 !important;
      transform: none !important;
    }
    /* Common animation classes that hide elements initially */
    .fade-up, .fade-in, .fade-down, .slide-up, .slide-in, .animate-fade,
    [class*="fade-"], [class*="slide-"], [class*="stagger-"] {
      opacity: 1 !important;
      transform: none !important;
    }
    /* Framer Motion / GSAP style hidden states */
    [data-state="hidden"], [data-visible="false"] {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* ═══════════════════════════════════════════════════════════════════════════ */
    /* GRADIENT ORBS & ANIMATED BACKGROUNDS - Make them look like glowing blurs   */
    /* ═══════════════════════════════════════════════════════════════════════════ */
    .gradient-orb, [class*="gradient-orb"], [class*="glow-"], [class*="blur-orb"],
    [class*="bg-gradient"][class*="rounded-full"], [class*="animate-pulse"][class*="rounded-full"] {
      border-radius: 50% !important;
      filter: blur(60px) !important;
      opacity: 0.6 !important;
      animation: float-orb 8s ease-in-out infinite !important;
    }
    
    /* Specific gradient orb positioning helpers */
    .gradient-orb {
      position: absolute !important;
      pointer-events: none !important;
    }
    
    /* Floating animation for orbs */
    @keyframes float-orb {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(10px, -15px) scale(1.05); }
      50% { transform: translate(-5px, 10px) scale(0.95); }
      75% { transform: translate(-10px, -5px) scale(1.02); }
    }
    
    /* Pulsing glow effect */
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.4; filter: blur(60px); }
      50% { opacity: 0.7; filter: blur(80px); }
    }
    
    /* Hero backgrounds with animated gradients */
    [class*="bg-gradient-to"], .hero-gradient, .gradient-bg {
      background-size: 200% 200% !important;
      animation: gradient-shift 15s ease infinite !important;
    }
    
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Shimmer/skeleton loading animations */
    .animate-shimmer, [class*="shimmer"], .skeleton {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent) !important;
      background-size: 200% 100% !important;
      animation: shimmer 2s infinite !important;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes scaleUp {
      0% { transform: scale(0.95); opacity: 0.8; }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Breathing/pulse animations for elements */
    .animate-breathe, [class*="breathe"] {
      animation: breathe 4s ease-in-out infinite !important;
    }
    
    @keyframes breathe {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.02); opacity: 0.9; }
    }
    
    /* Custom scrollbar for preview panel */
    .custom-scrollbar::-webkit-scrollbar {
      display: block !important;
      width: 8px;
      height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(39, 39, 42, 0.5);
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(82, 82, 91, 0.8);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(113, 113, 122, 0.9);
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    .custom-scrollbar {
      scrollbar-width: thin !important;
      scrollbar-color: rgba(82, 82, 91, 0.8) rgba(39, 39, 42, 0.5) !important;
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: '#3b82f6',
            secondary: '#6366f1',
          }
        }
      }
    }
  </script>
</head>
<body class="${background === 'dark' || background === 'transparent' ? 'dark' : ''}">
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useCallback, useMemo, useRef, Fragment } = React;
    
    // Mock common icon components
    const ChevronDown = () => <span className="icon-placeholder">▼</span>;
    const ChevronUp = () => <span className="icon-placeholder">▲</span>;
    const ChevronLeft = () => <span className="icon-placeholder">◀</span>;
    const ChevronRight = () => <span className="icon-placeholder">▶</span>;
    const Check = () => <span className="icon-placeholder">✓</span>;
    const X = () => <span className="icon-placeholder">✕</span>;
    const Search = () => <span className="icon-placeholder">🔍</span>;
    const Menu = () => <span className="icon-placeholder">☰</span>;
    const Plus = () => <span className="icon-placeholder">+</span>;
    const Minus = () => <span className="icon-placeholder">−</span>;
    const Star = () => <span className="icon-placeholder">★</span>;
    const Heart = () => <span className="icon-placeholder">♥</span>;
    const User = () => <span className="icon-placeholder">👤</span>;
    const Settings = () => <span className="icon-placeholder">⚙</span>;
    const Home = () => <span className="icon-placeholder">🏠</span>;
    const Mail = () => <span className="icon-placeholder">✉</span>;
    const Phone = () => <span className="icon-placeholder">📞</span>;
    const Calendar = () => <span className="icon-placeholder">📅</span>;
    const Clock = () => <span className="icon-placeholder">🕐</span>;
    const Image = () => <span className="icon-placeholder">🖼</span>;
    const Video = () => <span className="icon-placeholder">🎬</span>;
    const Music = () => <span className="icon-placeholder">🎵</span>;
    const File = () => <span className="icon-placeholder">📄</span>;
    const Folder = () => <span className="icon-placeholder">📁</span>;
    const Download = () => <span className="icon-placeholder">⬇</span>;
    const Upload = () => <span className="icon-placeholder">⬆</span>;
    const Share = () => <span className="icon-placeholder">↗</span>;
    const Copy = () => <span className="icon-placeholder">📋</span>;
    const Trash = () => <span className="icon-placeholder">🗑</span>;
    const Edit = () => <span className="icon-placeholder">✏</span>;
    const Eye = () => <span className="icon-placeholder">👁</span>;
    const EyeOff = () => <span className="icon-placeholder">👁‍🗨</span>;
    const Lock = () => <span className="icon-placeholder">🔒</span>;
    const Unlock = () => <span className="icon-placeholder">🔓</span>;
    const Bell = () => <span className="icon-placeholder">🔔</span>;
    const Info = () => <span className="icon-placeholder">ℹ</span>;
    const AlertCircle = () => <span className="icon-placeholder">⚠</span>;
    const CheckCircle = () => <span className="icon-placeholder">✅</span>;
    const XCircle = () => <span className="icon-placeholder">❌</span>;
    const ArrowRight = () => <span className="icon-placeholder">→</span>;
    const ArrowLeft = () => <span className="icon-placeholder">←</span>;
    const ArrowUp = () => <span className="icon-placeholder">↑</span>;
    const ArrowDown = () => <span className="icon-placeholder">↓</span>;
    const ExternalLink = () => <span className="icon-placeholder">↗</span>;
    const Loader2 = () => <span className="icon-placeholder animate-spin">⟳</span>;
    const MoreHorizontal = () => <span className="icon-placeholder">⋯</span>;
    const MoreVertical = () => <span className="icon-placeholder">⋮</span>;
    
    // cn utility (simplified)
    const cn = (...classes) => classes.filter(Boolean).join(' ');
    
    // Recharts mock components (Recharts doesn't have UMD build, so we provide Chart.js-based fallbacks)
    const ResponsiveContainer = ({ children, width, height }) => (
      <div style={{ width: width || '100%', height: height || 300 }}>{children}</div>
    );
    const LineChart = ({ children, data, width, height }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current || !window.Chart || !data) return;
        const chart = new window.Chart(canvasRef.current, {
          type: 'line',
          data: { labels: data.map((d, i) => d.name || i), datasets: [{ data: data.map(d => d.value || d.uv || d.pv || 0), borderColor: '#6366f1', tension: 0.4 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        return () => chart.destroy();
      }, [data]);
      return <div style={{ width: width || '100%', height: height || 300 }}><canvas ref={canvasRef} /></div>;
    };
    const AreaChart = LineChart;
    const BarChart = ({ children, data, width, height }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current || !window.Chart || !data) return;
        const chart = new window.Chart(canvasRef.current, {
          type: 'bar',
          data: { labels: data.map((d, i) => d.name || i), datasets: [{ data: data.map(d => d.value || d.uv || d.pv || 0), backgroundColor: '#6366f1' }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        return () => chart.destroy();
      }, [data]);
      return <div style={{ width: width || '100%', height: height || 300 }}><canvas ref={canvasRef} /></div>;
    };
    const PieChart = ({ children, data, width, height }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current || !window.Chart || !data) return;
        const chart = new window.Chart(canvasRef.current, {
          type: 'doughnut',
          data: { labels: data.map((d, i) => d.name || i), datasets: [{ data: data.map(d => d.value || 0), backgroundColor: ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'] }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
        return () => chart.destroy();
      }, [data]);
      return <div style={{ width: width || '100%', height: height || 300 }}><canvas ref={canvasRef} /></div>;
    };
    // Recharts sub-components (no-op, data is passed to parent)
    const Line = () => null;
    const Area = () => null;
    const Bar = () => null;
    const Pie = () => null;
    const XAxis = () => null;
    const YAxis = () => null;
    const CartesianGrid = () => null;
    const Tooltip = () => null;
    const Legend = () => null;
    const Cell = () => null;
    
    // Chart.js component wrapper
    const ChartComponent = ({ type = 'line', data, options, className = '' }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      
      useEffect(() => {
        if (!canvasRef.current || !window.Chart) return;
        
        // Destroy existing chart
        if (chartRef.current) {
          chartRef.current.destroy();
        }
        
        // Create new chart
        chartRef.current = new window.Chart(canvasRef.current, {
          type,
          data: data || { labels: ['Jan', 'Feb', 'Mar'], datasets: [{ data: [10, 20, 30] }] },
          options: { responsive: true, maintainAspectRatio: false, ...options }
        });
        
        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [type, data, options]);
      
      return <canvas ref={canvasRef} className={className} />;
    };
    
    // Component code
    function ${componentName}() {
      ${componentBody}
    }
    
    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<${componentName} />);
    
    // Initialize Lucide icons after React render
    setTimeout(() => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }, 100);
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FIX INVISIBLE ELEMENTS - Force all elements to be visible
    // ═══════════════════════════════════════════════════════════════════════════
    const forceVisible = () => {
      document.querySelectorAll('*').forEach(el => {
        const style = el.getAttribute('style') || '';
        if (style.includes('opacity') && (style.includes('opacity: 0') || style.includes('opacity:0'))) {
          el.style.opacity = '1';
        }
        if (style.includes('translate') && style.includes('opacity')) {
          el.style.opacity = '1';
          el.style.transform = 'none';
        }
      });
    };
    
    // Size reporting - measure actual rendered content
    const sendSize = () => {
      const root = document.getElementById('root');
      if (!root) return;
      
      // Get the actual rendered size of the content
      const rect = root.getBoundingClientRect();
      const height = Math.max(rect.height, root.scrollHeight, 100);
      const width = Math.max(rect.width, root.scrollWidth, 200);
      
      window.parent.postMessage({ type: 'IFRAME_SIZE', height, width }, '*');
    };
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FIX BROKEN IMAGES - Replace failed images with Unsplash placeholders
    // ═══════════════════════════════════════════════════════════════════════════
    const fixBrokenImages = () => {
      document.querySelectorAll('img').forEach((img, index) => {
        if (img.dataset.fixed) return;
        
        const src = img.getAttribute('src') || '';
        const isBroken = !src || src === '' || 
          src.startsWith('/') || src.startsWith('./') || src.startsWith('../') ||
          src.includes('placeholder') || src.includes('example.com') ||
          src.includes('undefined') || src.includes('null');
        
        if (isBroken) {
          const alt = (img.getAttribute('alt') || '').toLowerCase();
          const className = (img.className || '').toLowerCase();
          
          let query = 'abstract';
          if (alt.includes('avatar') || alt.includes('profile') || className.includes('avatar') || className.includes('rounded-full')) {
            query = 'portrait,face';
          } else if (alt.includes('blog') || alt.includes('cover') || alt.includes('hero')) {
            query = 'technology,minimal';
          } else if (alt.includes('product')) {
            query = 'product,minimal';
          }
          
          const photos = ['1618005182384-a83a8bd57fbe', '1557683316-973673baf926', '1579546929518-9e396f3cc809', '1558591710-4b4a1ae0f04d', '1557804506-669a67965ba0'];
          img.src = 'https://images.unsplash.com/photo-' + photos[index % 5] + '?w=400&h=300&fit=crop&auto=format';
          img.dataset.fixed = 'true';
        }
        
        img.onerror = function() {
          if (!this.dataset.errorFixed) {
            this.src = 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&h=300&fit=crop&auto=format';
            this.dataset.errorFixed = 'true';
          }
        };
      });
    };
    
    // Listen for parent resize messages (when user manually resizes in Blueprints)
    // Simple approach: let container control size, content clips naturally
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'PARENT_RESIZE') {
        // Just ensure no scrollbars - container handles clipping
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      }
    });
    
    // Run axe-core accessibility tests and report results
    const runAccessibilityCheck = () => {
      if (typeof axe !== 'undefined') {
        axe.run('#root', {
          rules: {
            'color-contrast': { enabled: true },
            'button-name': { enabled: true },
            'image-alt': { enabled: true },
            'label': { enabled: true },
            'link-name': { enabled: true },
            'aria-roles': { enabled: true },
            'aria-required-attr': { enabled: true },
            'aria-valid-attr-value': { enabled: true },
            'duplicate-id': { enabled: true },
            'nested-interactive': { enabled: true },
            'tabindex': { enabled: true },
          }
        }).then(results => {
          window.parent.postMessage({
            type: 'ACCESSIBILITY_RESULTS',
            violations: results.violations.map(v => ({
              id: v.id,
              impact: v.impact,
              description: v.description,
              help: v.help,
              helpUrl: v.helpUrl,
              nodes: v.nodes.map(n => ({ html: n.html, failureSummary: n.failureSummary }))
            })),
            passes: results.passes.map(p => ({
              id: p.id,
              description: p.description,
              help: p.help,
              nodes: p.nodes.map(n => ({ html: n.html }))
            })),
            incomplete: results.incomplete.map(i => ({
              id: i.id,
              impact: i.impact,
              description: i.description,
              help: i.help,
              nodes: i.nodes.map(n => ({ html: n.html }))
            }))
          }, '*');
        }).catch(err => {
          console.warn('Axe accessibility check failed:', err);
        });
      }
    };
    
    // Initial + resize + mutation observer
    setTimeout(() => { forceVisible(); fixBrokenImages(); sendSize(); }, 100);
    setTimeout(() => { forceVisible(); fixBrokenImages(); sendSize(); }, 500);
    setTimeout(() => { forceVisible(); fixBrokenImages(); sendSize(); runAccessibilityCheck(); }, 1500);
    window.addEventListener('resize', sendSize);
    
    const observer = new MutationObserver(() => { forceVisible(); fixBrokenImages(); sendSize(); });
    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
  </script>
</body>
</html>`;
  }, [code, background, isFullWidth]);
  
  // Listen for size messages - ONLY from THIS iframe (not all iframes!)
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      // CRITICAL: Only handle messages from OUR iframe, not all iframes on the page
      // This prevents one component's size change from affecting all other components
      if (event.source !== iframeRef.current?.contentWindow) {
        return;
      }
      
      if (event.data?.type === 'IFRAME_SIZE') {
        const newHeight = typeof event.data.height === 'number' ? Math.min(event.data.height + 20, 800) : null;
        const newWidth = typeof event.data.width === 'number' ? event.data.width + 20 : null;
        
        if (newHeight !== null) setIframeHeight(newHeight);
        if (newWidth !== null) setIframeWidth(newWidth);
        
        // Call size change callback
        if (onSizeChange && newWidth !== null && newHeight !== null) {
          onSizeChange({ width: event.data.width, height: event.data.height });
        }
      }
      // Backwards compatibility
      if (event.data?.type === 'IFRAME_HEIGHT' && typeof event.data.height === 'number') {
        setIframeHeight(Math.min(event.data.height + 20, 800));
      }
      // Accessibility results from axe-core
      if (event.data?.type === 'ACCESSIBILITY_RESULTS' && onAccessibilityResults) {
        onAccessibilityResults({
          violations: event.data.violations || [],
          passes: event.data.passes || [],
          incomplete: event.data.incomplete || []
        });
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [onSizeChange, onAccessibilityResults]);

  // Container controls size, iframe fills it at 100% for responsiveness
  // When container is resized, iframe content responds like a real browser window
  return (
    <div 
      className={cn("relative", isFullWidth ? "w-full" : "", className)}
      style={{
        // Full-width components: fill 100% of parent container
        // Regular components: use content width from iframe, with min 300px
        width: isFullWidth ? '100%' : (iframeWidth > 100 ? `${iframeWidth}px` : '100%'),
        minWidth: isFullWidth ? undefined : '300px', // Min width for regular components
        maxWidth: '100%', // Never exceed container
        // Height: use reported height but allow shrinking, no fixed minHeight that causes empty space
        height: iframeHeight > 50 ? `${iframeHeight}px` : 'auto',
        minHeight: '50px', // Small minimum to prevent collapse
      }}
    >
      {error && (
        <div className="absolute top-2 left-2 right-2 z-10 bg-red-500/90 text-white text-xs p-2 rounded">
          {error}
        </div>
      )}
      <iframe
        ref={iframeRef}
        id={componentId ? `iframe-${componentId}` : undefined}
        srcDoc={iframeDoc}
        className="border-0"
        style={{ 
          // Iframe fills container 100% - makes content responsive to container size
          width: '100%',
          height: '100%',
          background: 'transparent',
        }}
        sandbox="allow-scripts allow-same-origin"
        title="Interactive React Preview"
      />
    </div>
  );
};

const LogoIcon = ({ className, color = "currentColor" }: { className?: string; color?: string }) => (
  <svg className={className} viewBox="0 0 82 109" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M68.099 37.2285C78.1678 43.042 78.168 57.5753 68.099 63.3887L29.5092 85.668C15.6602 93.6633 0.510418 77.4704 9.40857 64.1836L17.4017 52.248C18.1877 51.0745 18.1876 49.5427 17.4017 48.3691L9.40857 36.4336C0.509989 23.1467 15.6602 6.95306 29.5092 14.9482L68.099 37.2285Z" stroke={color} strokeWidth="11.6182" strokeLinejoin="round"/>
    <rect x="34.054" y="98.6841" width="48.6555" height="11.6182" rx="5.80909" transform="rotate(-30 34.054 98.6841)" fill={color}/>
  </svg>
);

const getNodeIcon = (type: string) => {
  switch (type) {
    case "page": return Layout;
    case "component": return Box;
    case "section": return Layers;
    case "element": return Type;
    case "interactive": return MousePointer;
    default: return Box;
  }
};

// Function to analyze what changed between two code versions - HUMAN STYLE
const analyzeCodeChanges = (oldCode: string, newCode: string, userRequest: string): string => {
  const insights: string[] = [];
  const requestLower = userRequest.toLowerCase();
  
  // Detect the TYPE of change and respond appropriately
  const isAnimation = requestLower.includes('animat') || requestLower.includes('transition') || requestLower.includes('smooth') || requestLower.includes('fade') || requestLower.includes('płynn');
  const isResponsive = requestLower.includes('mobile') || requestLower.includes('responsive') || requestLower.includes('tablet') || requestLower.includes('telefon') || requestLower.includes('komórk');
  const isLayout = requestLower.includes('layout') || requestLower.includes('grid') || requestLower.includes('flex') || requestLower.includes('spacing') || requestLower.includes('odstęp') || requestLower.includes('układ');
  const isColors = requestLower.includes('color') || requestLower.includes('kolor') || requestLower.includes('theme') || requestLower.includes('dark') || requestLower.includes('ciemn') || requestLower.includes('jasn');
  const isButtons = requestLower.includes('button') || requestLower.includes('przycisk') || requestLower.includes('cta') || requestLower.includes('klik');
  const isNav = requestLower.includes('nav') || requestLower.includes('menu') || requestLower.includes('header') || requestLower.includes('sidebar') || requestLower.includes('nagłów');
  const isFix = requestLower.includes('fix') || requestLower.includes('napraw') || requestLower.includes('bug') || requestLower.includes('błąd') || requestLower.includes('zepsu') || requestLower.includes('wrong');
  const isAdd = requestLower.includes('add') || requestLower.includes('dodaj') || requestLower.includes('missing') || requestLower.includes('brakuj') || requestLower.includes('potrzeb');
  
  // Check for specific technical changes
  const addedTailwind = (newCode.match(/class="[^"]*(?:flex|grid|gap-|p-|m-|text-|bg-|rounded)/g) || []).length > (oldCode.match(/class="[^"]*(?:flex|grid|gap-|p-|m-|text-|bg-|rounded)/g) || []).length;
  const addedAnimations = (newCode.match(/@keyframes|animation:|transition:|animate-/g) || []).length > (oldCode.match(/@keyframes|animation:|transition:|animate-/g) || []).length;
  const addedAlpine = (newCode.match(/x-data|x-show|x-on:|@click/g) || []).length > (oldCode.match(/x-data|x-show|x-on:|@click/g) || []).length;
  const addedMedia = (newCode.match(/@media|sm:|md:|lg:|xl:/g) || []).length > (oldCode.match(/@media|sm:|md:|lg:|xl:/g) || []).length;
  const addedBackdrop = newCode.includes('backdrop-blur') && !oldCode.includes('backdrop-blur');
  const addedGradient = (newCode.match(/gradient/g) || []).length > (oldCode.match(/gradient/g) || []).length;
  
  // Build conversational response based on context - PROSTE, PO POLSKU
  if (isAnimation && addedAnimations) {
    insights.push("Dodałem płynne animacje ✨");
  } else if (isAnimation) {
    insights.push("Poprawiłem animacje - teraz są płynniejsze");
  }
  
  if (isResponsive || addedMedia) {
    insights.push("Dodałem responsywność - działa na mobile 📱");
  }
  
  if (isLayout && addedTailwind) {
    insights.push("Naprawiłem układ - lepsze odstępy");
  }
  
  if (isColors || addedGradient) {
    insights.push("Zmieniłem kolory");
  }
  
  if (isButtons) {
    insights.push("Ulepszyłem przyciski");
  }
  
  if (isNav) {
    insights.push("Rozbudowałem nawigację");
  }
  
  if (addedAlpine && !isNav) {
    insights.push("Dodałem interaktywność");
  }
  
  if (addedBackdrop) {
    insights.push("Dodałem efekt szkła");
  }
  
  if (isFix) {
    insights.push("Naprawione!");
  }
  
  if (isAdd && insights.length === 0) {
    insights.push("Dodane!");
  }
  
  // If no specific insights, provide a generic but still human response
  if (insights.length === 0) {
    insights.push("Zastosowałem zmiany zgodnie z Twoją prośbą");
  }
  
  // Build a descriptive response
  let response = `**Zmiany wprowadzone:**\n\n`;
  insights.forEach(insight => {
    response += `• ${insight}\n`;
  });
  response += `\n**Preview zaktualizowany** - sprawdź rezultat!`;
  
  return response;
};

function ReplayToolContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { pending, setPending, clearPending } = usePendingFlow();
  const { user, isLoading: authLoading, signOut } = useAuth();
  const { totalCredits: userTotalCredits, wallet, membership, canAfford, refreshCredits, isLoading: creditsLoading, isSandbox, isPaidPlan } = useCredits();
  const { profile } = useProfile();
  const { toast, showToast, hideToast } = useToast();
  
  // Check if mobile (show "Desktop only" message)
  const isMobile = useIsMobile();
  
  // Demo mode state - for cached demo results
  const [isDemoMode, setIsDemoMode] = useState(false);
  
  // Demo project IDs that should NOT be saved to user's account
  const DEMO_PROJECT_IDS = useMemo(() => new Set([
    "flow_1767827812458_823lpezg8", // dashboard - UBOLD Premium Admin
    "flow_1767826711350_55giwb69y", // yc - Y Combinator
    "flow_1767812494307_4c540djzy", // landing - Flooks
    "flow_1769444036799_r8hrcxyx2", // showcase - Enterprise Dashboard (old)
    "flow_1769991250167_jr2x4utrt", // showcase - Enterprise Claims Manager v1.4
  ]), []);
  
  // Demo showcase project (the main one for landing page)
  const SHOWCASE_PROJECT_ID = "flow_1769991250167_jr2x4utrt";
  
  const [flows, setFlows] = useState<FlowItem[]>([]);
  const hasRestoredFlowsRef = useRef(false);
  // Map of style IDs to their full names (for converting Settings preferences)
  const STYLE_ID_TO_NAME: Record<string, string> = {
    "auto-detect": "",
    "custom": "",
    "aura-glass": "High-End Dark Glass",
    "void-spotlight": "Void Spotlight",
    "dark-cosmos": "Dark Cosmos",
    "linear": "Linear",
    "liquid-chrome": "Liquid Chrome",
    "molten-aurora": "Molten Aurora SaaS",
    "midnight-aurora": "Midnight Aurora",
    "glass-cascade": "Glass Blue Tech",
    "glowframe-product": "Dark Product Glowframe",
    "swiss-grid": "Swiss Grid",
    "soft-organic": "Soft Organic",
    "silent-luxury": "Silent Luxury",
    "ethereal-mesh": "Ethereal Mesh",
    "glassmorphism": "Glassmorphism",
    "neubrutalism": "Neo-Brutalism",
    "kinetic-brutalism": "Kinetic Brutalism",
    "spatial-glass": "Spatial Glass",
    "particle-brain": "Particle Brain",
    "old-money": "Old Money Heritage",
    "tactical-hud": "Tactical HUD",
    "urban-grunge": "Urban Grunge",
    "ink-zen": "Ink & Zen",
    "infinite-tunnel": "Infinite Tunnel",
    "frosted-acrylic": "Frosted Acrylic",
    "datamosh": "Datamosh Glitch",
    "origami-fold": "Origami Fold",
    "gravity-physics": "Gravity Physics",
    "neo-retro-os": "Neo-Retro OS",
    "soft-clay-pop": "Soft Clay Pop",
    "deconstructed-editorial": "Deconstructed Editorial",
    "cinematic-product": "Cinematic Product",
    "digital-collage": "Digital Collage",
    "halftone-beam": "Halftone Solar Beam",
    "mono-wave": "Monochrome Wave",
    "fractured-grid": "Fractured Grid",
    "matrix-rain": "Matrix Rain",
    "xray-blueprint": "X-Ray Blueprint",
    "opposing-scroll": "Opposing Scroll",
    "stacked-cards": "Stacked Card Deck",
    "horizontal-inertia": "Horizontal Inertia",
    "split-curtain": "Split Curtain Reveal",
    "phantom-border": "Phantom Border UI",
    "inverted-lens": "Inverted Lens Cursor",
    "elastic-sidebar": "Elastic Sidebar",
    "morphing-nav": "Morphing Fluid Nav",
    "liquid-neon": "Liquid Neon",
    "chromatic-dispersion": "Chromatic Dispersion",
    "viscous-hover": "Viscous Hover",
    "globe-data": "Interactive Globe",
    "liquid-text-mask": "Liquid Text Masking",
    "noise-gradient": "Dynamic Noise Gradient",
    "fluid-prismatic": "Fluid Prismatic",
    "paper-shader-mesh": "Paper Shader Mesh",
    "gradient-bar-waitlist": "Gradient Bar Waitlist",
    "earthy-grid-reveal": "Earthy Grid Reveal",
    "gyroscopic-levitation": "Gyroscopic Levitation",
    "exploded-view": "Exploded View Scroll",
    "skeuomorphic": "Skeuomorphic Controls",
    "messy-physics": "Messy Colorful Physics",
    "apple": "Apple Style",
    "stripe": "Stripe Design",
    "vercel": "Vercel",
    "live-dashboard": "Live Dashboard",
    "crt-noise": "CRT Signal Noise",
    "airy-blue-aura": "Airy Blue Aura",
    "blur-hero-minimal": "Blur Hero Minimal",
    "myna-ai-mono": "Myna AI Mono",
    "acme-clean-rounded": "Acme Clean Rounded",
    "deadpan-documentation": "Deadpan Documentation",
    "bureaucratic-void": "Bureaucratic Void",
    "cctv-drift": "CCTV Drift",
    "abrupt-termination": "Abrupt Termination",
    "indifferent-kinetic": "Indifferent Kinetic",
    "inefficient-loop": "Inefficient Loop",
    "accidental-capture": "Accidental Capture",
    "biomimetic-organic": "Biomimetic Organic",
    "generative-ascii": "Generative ASCII",
    "cinematic-portals": "Cinematic Portals",
    "typographic-architecture": "Typographic Architecture",
  };
  
  // Helper function to get default style name from localStorage (only call client-side)
  const getDefaultStyleName = () => {
    if (typeof window === 'undefined') return "";
    const defaultPreset = localStorage.getItem("replay_default_style_preset");
    if (!defaultPreset || defaultPreset === "auto-detect") return "";
    return STYLE_ID_TO_NAME[defaultPreset] || "";
  };
  
  // Initialize to empty string to avoid hydration mismatch
  const [styleDirective, setStyleDirective] = useState("");
  
  // Enterprise removed - using system-prompt.ts only for premium styling
  
  // Load default style from localStorage after mount
  useEffect(() => {
    const savedStyle = getDefaultStyleName();
    if (savedStyle) {
      setStyleDirective(savedStyle);
    }
    // Enterprise preset loading removed - always use Creative mode
  }, []);
  
  
  const [styleReferenceImage, setStyleReferenceImage] = useState<{ url: string; name: string } | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [compressionProgress, setCompressionProgress] = useState(0);
  const [isMobileScanning, setIsMobileScanning] = useState(false);
  const [generatedCode, setGeneratedCode] = useState<string | null>(null);
  const [hasLoadedFromStorage, setHasLoadedFromStorage] = useState(false);
  const [displayedCode, setDisplayedCode] = useState<string>("");
  const [editableCode, setEditableCode] = useState<string>("");
  const [isCodeEditable, setIsCodeEditable] = useState(false);
  const [isStreamingCode, setIsStreamingCode] = useState(false);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [viewMode, setViewMode] = useState<ViewMode>("preview");
  const [isCommentMode, setIsCommentMode] = useState(false);
  const [docsSubTab, setDocsSubTab] = useState<DocsSubTab>("overview");
  const [selectedFlowId, setSelectedFlowId] = useState<string | null>(null);
  // const [showUserMenu, setShowUserMenu] = useState(false); // Removed in favor of direct link
  // streamingMessage state removed - loading handled in LoadingState component
  const [generationSessionId, setGenerationSessionId] = useState<string | null>(null); // Track current generation to hide old content
  
  // Auth/Credits modals
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [showOutOfCreditsModal, setShowOutOfCreditsModal] = useState(false);
  const [showFeedbackModal, setShowFeedbackModal] = useState(false);
  const [hasShownFeedback, setHasShownFeedback] = useState(false);
  
  // Flow node edit/delete modal
  const [flowNodeModal, setFlowNodeModal] = useState<{
    type: "rename" | "delete";
    nodeId: string;
    nodeName: string;
  } | null>(null);
  const [flowNodeRenameValue, setFlowNodeRenameValue] = useState("");
  
  // AI-Generated Enterprise Documentation State
  const [aiDocsOverview, setAiDocsOverview] = useState<any>(null);
  const [aiDocsApi, setAiDocsApi] = useState<any>(null);
  const [aiDocsQa, setAiDocsQa] = useState<any>(null);
  const [aiDocsDeploy, setAiDocsDeploy] = useState<any>(null);
  const [aiFlows, setAiFlows] = useState<any>(null);
  const [aiDesignSystem, setAiDesignSystem] = useState<any>(null);
  const [isGeneratingDocs, setIsGeneratingDocs] = useState<string | null>(null); // Which doc is being generated
  const [isGeneratingFlows, setIsGeneratingFlows] = useState(false);
  const [isGeneratingDesign, setIsGeneratingDesign] = useState(false);
  const [needsAutoGenDocs, setNeedsAutoGenDocs] = useState(false); // Flag to trigger auto-gen after main generation
  
  // Multi-Pass Pipeline v2.0 - New outputs
  const [scanData, setScanData] = useState<any>(null); // Unified scan result (Source of Truth)
  const [apiContracts, setApiContracts] = useState<any>(null); // Swagger/TypeScript specs
  const [debtAudit, setDebtAudit] = useState<any>(null); // Technical Debt Reduction Report
  const [e2eTests, setE2eTests] = useState<any>(null); // Playwright/Cypress tests
  const [isGeneratingApiContracts, setIsGeneratingApiContracts] = useState(false);
  const [isGeneratingDebtAudit, setIsGeneratingDebtAudit] = useState(false);
  const [isGeneratingE2ETests, setIsGeneratingE2ETests] = useState(false);
  const [isDownloadingPackage, setIsDownloadingPackage] = useState(false);
  
  // Upgrade modal for FREE users
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const [upgradeFeature, setUpgradeFeature] = useState<"code" | "download" | "publish" | "supabase" | "general">("general");
  const [isUpgradeCheckingOut, setIsUpgradeCheckingOut] = useState(false);
  const [selectedUpgradePlan, setSelectedUpgradePlan] = useState<"pro">("pro");
  const [selectedProTierIndex, setSelectedProTierIndex] = useState(0);
  const [showProTierDropdown, setShowProTierDropdown] = useState(false);
  
  // Price IDs for checkout
  const STARTER_PACK_PRICE_ID = "price_1Spo05Axch1s4iBGydOPAd2i"; // $9 one-time
  
  // PRO Subscription tiers (same as pricing page)
  const PRO_TIERS = [
    { id: 'pro25', credits: 1500, price: 25, priceId: "price_1SotL1Axch1s4iBGWMvO0JBZ" },
    { id: 'pro50', credits: 3300, price: 50, priceId: "price_1SotLqAxch1s4iBG1ViXkfc2" },
    { id: 'pro100', credits: 7500, price: 100, priceId: "price_1SotMYAxch1s4iBGLZZ7ATBs" },
    { id: 'pro200', credits: 16500, price: 200, priceId: "price_1SotN4Axch1s4iBGUJEfzznw" },
    { id: 'pro300', credits: 25500, price: 300, priceId: "price_1SotNMAxch1s4iBGzRD7B7VI" },
    { id: 'pro500', credits: 45000, price: 500, priceId: "price_1SotNuAxch1s4iBGPl81sHqx" },
  ];
  const selectedProTier = PRO_TIERS[selectedProTierIndex];
  
  // Handler for direct checkout (used in inline upgrade buttons)
  const handleUpgradeCheckout = async (plan?: "pro") => {
    const selectedPlan = plan || selectedUpgradePlan;
    
    if (!user) {
      setShowAuthModal(true);
      return;
    }
    
    setIsUpgradeCheckingOut(true);
    try {
      const isStarter = false;
      
      const res = await fetch("/api/billing/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: isStarter ? "starter" : "subscription",
          priceId: isStarter ? STARTER_PACK_PRICE_ID : selectedProTier.priceId,
          tierId: isStarter ? "starter" : selectedProTier.id,
          credits: isStarter ? 200 : selectedProTier.credits,
          interval: "monthly"
        }),
      });
      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else if (data.error) {
        console.error("Checkout error:", data.error);
        showToast("Failed to start checkout: " + data.error, "error");
      }
    } catch (error) {
      console.error("Checkout error:", error);
      showToast("Failed to start checkout. Please try again.", "error");
    } finally {
      setIsUpgradeCheckingOut(false);
    }
  };
  
  // isPaidPlan is now provided by useCredits() hook
  const [pendingAction, setPendingAction] = useState<"generate" | "edit" | null>(null);
  const [analysisDescription, setAnalysisDescription] = useState<string>("");
  const [editInput, setEditInput] = useState("");
  const [isMobilePreview, setIsMobilePreview] = useState(false);
  const [isPointAndEdit, setIsPointAndEdit] = useState(false);
  const [refinements, setRefinements] = useState("");
  const [contextImages, setContextImages] = useState<{ id: string; url: string; name: string; uploading?: boolean }[]>([]);
  const [analysisSection, setAnalysisSection] = useState<"style" | "layout" | "components">("style");
  const contextImageInputRef = useRef<HTMLInputElement>(null);
  
  // Mobile state - input visible by default, chat after generation
  const [mobilePanel, setMobilePanel] = useState<"input" | "preview" | "code" | "flow" | "design" | "chat" | null>("input");
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [showProfileMenu, setShowProfileMenu] = useState(false);
  const profileMenuRef = useRef<HTMLDivElement>(null);
  
  // Close profile menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (profileMenuRef.current && !profileMenuRef.current.contains(e.target as Node)) {
        setShowProfileMenu(false);
      }
    };
    if (showProfileMenu) {
      document.addEventListener("mousedown", handleClickOutside);
    }
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [showProfileMenu]);
  
  const [showMobileBanner, setShowMobileBanner] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem("replay_mobile_banner_dismissed") !== "true";
    }
    return true;
  });
  
  // Mobile Project Synced modal - shows after generation on mobile (only once per generation)
  const [showMobileSyncModal, setShowMobileSyncModal] = useState(false);
  const [mobileSyncShownForGeneration, setMobileSyncShownForGeneration] = useState<string | null>(null);
  
  // Live analysis state for "Matrix" view
  interface AnalysisPhase {
    palette: string[];
    typography: string;
    vibe: string;
    layout: string;
    container: string;
    responsive: string;
    components: { name: string; status: "waiting" | "generating" | "done" }[];
    stats?: { tech: string; componentCount: number; imageCount: number; theme: string };
    // UX Signals - Technical analysis tags
    uxSignals?: UXSignal[];
    // Component tree structure (hierarchical)
    structureItems?: { name: string; status: "waiting" | "generating" | "done" }[];
    componentTree?: ComponentTreeNode[];
    // Detected data patterns for database connections
    dataPatterns?: { pattern: string; component: string; suggestedTable?: string }[];
  }
  const [analysisPhase, setAnalysisPhase] = useState<AnalysisPhase | null>(null);
  const [isSupabaseConnected, setIsSupabaseConnected] = useState(false);
  
  // Flow state = PRODUCT MAP (canvas with nodes/edges)
  const [flowNodes, setFlowNodes] = useState<ProductFlowNode[]>([]);
  const [flowEdges, setFlowEdges] = useState<ProductFlowEdge[]>([]);
  const [flowBuilding, setFlowBuilding] = useState(false);
  const [selectedFlowNode, setSelectedFlowNode] = useState<string | null>(null);
  const [hasAutoLayouted, setHasAutoLayouted] = useState(false);
  const [showStructureInFlow, setShowStructureInFlow] = useState(true); // Toggle to show components under nodes - default ON
  const [showPossiblePaths, setShowPossiblePaths] = useState(false); // Toggle to show/hide possible paths in Flow - default OFF to show only observed
  const [showPreviewsInFlow, setShowPreviewsInFlow] = useState(true); // Always show iframe previews in flow nodes by default
  const [showBusinessProcess, setShowBusinessProcess] = useState(false); // Toggle Business Process Architecture panel
  const [generationComplete, setGenerationComplete] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [showFloatingEdit, setShowFloatingEdit] = useState(false);
  const [editImages, setEditImages] = useState<{ id: string; url: string; name: string; file?: File; uploading?: boolean }[]>([]);
  const [architecture, setArchitecture] = useState<ArchNode[]>([]);
  const [archBuilding, setArchBuilding] = useState(false);
  const [selectedArchNode, setSelectedArchNode] = useState<string | null>(null);
  const [styleInfo, setStyleInfo] = useState<StyleInfo | null>(null);
  
  // Library state (Storybook-like component library)
  const [libraryData, setLibraryData] = useState<LibraryData | null>(null);
  const [selectedLibraryItem, setSelectedLibraryItem] = useState<string | null>(null);
  const [libraryPanel, setLibraryPanel] = useState<LibraryPanel>("controls");
  const [libraryPropsOverride, setLibraryPropsOverride] = useState<Record<string, any>>({});
  const [librarySearchQuery, setLibrarySearchQuery] = useState("");
  const [libraryZoom, setLibraryZoom] = useState(100);
  const [libraryBackground, setLibraryBackground] = useState<"light" | "dark" | "transparent">("dark");
  const [libraryNeedsRegeneration, setLibraryNeedsRegeneration] = useState(false);
  const [libraryCodeHash, setLibraryCodeHash] = useState<string | null>(null); // Track which code library was generated from
  const [showLibraryGrid, setShowLibraryGrid] = useState(false);
  
  // Design System state
  const [showImportLibraryModal, setShowImportLibraryModal] = useState(false);
  const [isImportingLibrary, setIsImportingLibrary] = useState(false);
  const [localComponents, setLocalComponents] = useState<LocalComponent[]>([]);
  const { designSystems, refetch: refetchDesignSystems, getDefault: getDefaultDesignSystem } = useDesignSystems();
  
  // Build imported styles list for StyleInjector from design systems
  const importedStylesList = useMemo(() => {
    return (designSystems || []).map((ds: any) => ({
      id: ds.id,
      name: ds.name,
      source_url: ds.source_url,
      tokenCount: ds.token_count || 0,
      componentCount: ds.component_count || 0,
    }));
  }, [designSystems]);

  // Delete an imported Design System
  const handleDeleteDS = useCallback(async (dsId: string) => {
    try {
      const res = await fetch(`/api/design-systems/${dsId}`, { method: "DELETE" });
      if (res.ok || res.status === 404) {
        // 404 means already deleted — treat as success
        console.log("[DS] Deleted design system:", dsId);
        refetchDesignSystems();
        // If this DS was selected, clear selection
        if (styleDirective.includes(dsId)) {
          setStyleDirective("");
        }
      } else {
        const errText = await res.text();
        console.error("[DS] Failed to delete:", errText);
      }
    } catch (err) {
      console.error("[DS] Delete error:", err);
    }
  }, [refetchDesignSystems, styleDirective]);
  
  // Library sidebar collapse states
  const [librarySectionsExpanded, setLibrarySectionsExpanded] = useState<Record<string, boolean>>({ docs: true, foundations: true, components: true, patterns: true, templates: true, product: true });
  const [libraryCategoriesExpanded, setLibraryCategoriesExpanded] = useState<Record<string, boolean>>({});
  const [showLibraryOutline, setShowLibraryOutline] = useState(false);
  const [showLibraryCode, setShowLibraryCode] = useState(false);
  const [showLibraryRuler, setShowLibraryRuler] = useState(false);
  const [libraryVisionMode, setLibraryVisionMode] = useState<"none" | "blur" | "deuteranopia" | "protanopia" | "tritanopia" | "grayscale">("none");
  const [libraryViewport, setLibraryViewport] = useState<"desktop" | "mobile">("desktop");
  const [libraryPreviewSize, setLibraryPreviewSize] = useState<{ width: number; height: number }>({ width: 0, height: 0 });
  const [accessibilityResults, setAccessibilityResults] = useState<{
    violations: Array<{ id: string; impact: string; description: string; help: string; helpUrl: string; nodes: Array<{ html: string; failureSummary: string }> }>;
    passes: Array<{ id: string; description: string; help: string; nodes: Array<{ html: string }> }>;
    incomplete: Array<{ id: string; impact: string; description: string; help: string; nodes: Array<{ html: string }> }>;
  } | null>(null);
  const [isLibraryFullscreen, setIsLibraryFullscreen] = useState(false);
  const [libraryPanelCollapsed, setLibraryPanelCollapsed] = useState(false);
  const [isGeneratingLibraryDocs, setIsGeneratingLibraryDocs] = useState(false);
  const [libraryDocsGenerated, setLibraryDocsGenerated] = useState(false);
  
  // Handle Escape key to close fullscreen
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isLibraryFullscreen) {
        setIsLibraryFullscreen(false);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isLibraryFullscreen]);

  // DS style selection - only load tokens/foundations for display, NOT components
  // Components should ONLY appear in Library after user clicks "Extract New Components" on generated code
  const activeDSId = useMemo(() => styleDirective.startsWith("DS_STYLE::") ? styleDirective.split("::")[1] : null, [styleDirective]);
  
  useEffect(() => {
    if (!activeDSId) return;
    
    const loadDesignSystemTokens = async () => {
      try {
        console.log("[Library] Loading DS tokens only (not components):", activeDSId);
        const dsResponse = await fetch(`/api/design-systems/${activeDSId}`);
        
        if (!dsResponse.ok) return;
        
        const dsData = await dsResponse.json();
        const dsTokens = dsData.designSystem?.tokens || {};
        
        let colors: Record<string, string> = {};
        if (dsTokens.colors && Object.keys(dsTokens.colors).length > 0) {
          colors = { ...dsTokens.colors };
        }
        
        const typography = dsTokens.typography || { fontFamily: {}, fontSize: {}, fontWeight: {}, lineHeight: {} };
        
        // Only set tokens/foundations - NO components (those come from Extract only)
        setLibraryData(prev => ({
          components: prev?.components || [],
          docs: prev?.docs || [],
          tokens: { colors, spacing: dsTokens.spacing || {}, typography, borderRadius: dsTokens.borderRadius || {}, shadows: dsTokens.shadows || {} },
          foundations: { colors, typography, spacing: dsTokens.spacing || {}, borderRadius: dsTokens.borderRadius || {}, shadows: dsTokens.shadows || {} },
        }));
        
        console.log("[Library] Set DS tokens only:", Object.keys(colors).length, "colors (0 components - Extract only)");
      } catch (err) {
        console.error("[Library] Error loading DS tokens:", err);
      }
    };
    
    loadDesignSystemTokens();
  }, [activeDSId]);
  
  const [blueprintsZoom, setBlueprintsZoom] = useState(100);
  const [blueprintsOffset, setBlueprintsOffset] = useState({ x: 0, y: 0 });
  const [isBlueprintsPanning, setIsBlueprintsPanning] = useState(false);
  const [blueprintsPanStart, setBlueprintsPanStart] = useState({ x: 0, y: 0 });
  const [blueprintsComponentPrompt, setBlueprintsComponentPrompt] = useState("");
  const [isGeneratingBlueprintsComponent, setIsGeneratingBlueprintsComponent] = useState(false);
  const [blueprintsBackground, setBlueprintsBackground] = useState<"dark" | "light" | "transparent">("dark");
  const [showBlueprintsGrid, setShowBlueprintsGrid] = useState(false);
  const [showBlueprintsOutline, setShowBlueprintsOutline] = useState(false);
  const [showBlueprintsRuler, setShowBlueprintsRuler] = useState(false);
  const [blueprintsVisionMode, setBlueprintsVisionMode] = useState<"none" | "blur" | "deuteranopia" | "protanopia" | "tritanopia" | "grayscale">("none");
  const [blueprintsViewport, setBlueprintsViewport] = useState<"desktop" | "mobile">("desktop");
  const [isBlueprintsFullscreen, setIsBlueprintsFullscreen] = useState(false);
  // Dropdown open states
  const [showLibraryBgDropdown, setShowLibraryBgDropdown] = useState(false);
  const [showLibraryVisionDropdown, setShowLibraryVisionDropdown] = useState(false);
  const [showBlueprintsBgDropdown, setShowBlueprintsBgDropdown] = useState(false);
  const [showBlueprintsVisionDropdown, setShowBlueprintsVisionDropdown] = useState(false);
  
  // Blueprints Analysis State (Single Source of Truth)
  const [blueprintsAnalysis, setBlueprintsAnalysis] = useState<any>(null);
  const [isAnalyzingBlueprints, setIsAnalyzingBlueprints] = useState(false);
  const [blueprintDetailView, setBlueprintDetailView] = useState<"ai" | "props" | "variants" | "code" | "usage">("ai");
  const [blueprintStatuses, setBlueprintStatuses] = useState<Record<string, "draft" | "approved" | "deprecated">>({});
  const [blueprintPropsOverride, setBlueprintPropsOverride] = useState<Record<string, any>>({}); // Live props editing
  // JSON Live Editor state
  const [blueprintJsonSchema, setBlueprintJsonSchema] = useState<any>(null);
  const [blueprintEditedCode, setBlueprintEditedCode] = useState<string | null>(null); // Edited component code
  const [blueprintChatInput, setBlueprintChatInput] = useState("");
  const [blueprintChatHistory, setBlueprintChatHistory] = useState<{role: 'user' | 'ai', content: string}[]>([]);
  const [isEditingBlueprint, setIsEditingBlueprint] = useState(false);
  const [generatingBlueprintId, setGeneratingBlueprintId] = useState<string | null>(null); // Which component is being generated
  const [recentlyGeneratedId, setRecentlyGeneratedId] = useState<string | null>(null); // For scale animation after generation
  const [blueprintContextImage, setBlueprintContextImage] = useState<string | null>(null); // Base64 image for context
  const [blueprintSurveyData, setBlueprintSurveyData] = useState<any>(null); // Hard data from Agentic Vision Surveyor
  const [blueprintQaReport, setBlueprintQaReport] = useState<any>(null); // QA report comparing reference vs generated
  const [isSurveyingBlueprint, setIsSurveyingBlueprint] = useState(false); // Loading state for surveyor
  const [showJsonView, setShowJsonView] = useState(false);
  const [showGenerateModal, setShowGenerateModal] = useState(false);
  const [generatePromptInput, setGeneratePromptInput] = useState("");
  const [blueprintSearchQuery, setBlueprintSearchQuery] = useState("");
  const blueprintsCanvasRef = useRef<HTMLDivElement>(null);
  // Draggable component positions on canvas
  const [blueprintPositions, setBlueprintPositions] = useState<Record<string, { x: number; y: number }>>({});
  const [blueprintSizes, setBlueprintSizes] = useState<Record<string, { width: number; height: number }>>({});
  const [draggingComponent, setDraggingComponent] = useState<string | null>(null);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [selectedBlueprintComponent, setSelectedBlueprintComponent] = useState<string | null>(null);
  const [resizingComponent, setResizingComponent] = useState<{ id: string; handle: string } | null>(null);
  const [resizeStart, setResizeStart] = useState({ x: 0, y: 0, width: 0, height: 0, posX: 0, posY: 0 });
  
  // Global mouseup listener for resize - ensures resize works even if mouse leaves canvas
  useEffect(() => {
    if (!resizingComponent) return;
    
    const handleGlobalMouseUp = () => {
      if (resizingComponent) {
        setManuallyResizedComponents(prev => new Set([...prev, resizingComponent.id]));
      }
      setResizingComponent(null);
    };
    
    document.addEventListener('mouseup', handleGlobalMouseUp);
    return () => document.removeEventListener('mouseup', handleGlobalMouseUp);
  }, [resizingComponent]);
  
  const [editingComponentName, setEditingComponentName] = useState<string | null>(null); // For inline name editing
  const [editingNameValue, setEditingNameValue] = useState("");
  
  // Vision Import state (Import components from screenshots/Figma frames)
  const [showVisionImportModal, setShowVisionImportModal] = useState(false);
  const [visionImportImage, setVisionImportImage] = useState<string | null>(null);
  const [visionImportLoading, setVisionImportLoading] = useState(false);
  const [visionImportProgress, setVisionImportProgress] = useState("");
  const [visionImportInstructions, setVisionImportInstructions] = useState("");
  const [visionImportComponentName, setVisionImportComponentName] = useState("");
  const [visionImportMode, setVisionImportMode] = useState<"image" | "describe">("image"); // Toggle between image import and describe
  const [visionImportDescription, setVisionImportDescription] = useState(""); // For creating components from description
  const [isDraggingOverCanvas, setIsDraggingOverCanvas] = useState(false);
  const visionFileInputRef = useRef<HTMLInputElement>(null);
  
  // Auto layout function for Blueprints - SMART GRID that prevents overlap
  const autoLayoutBlueprints = useCallback(() => {
    if (!libraryData?.components || libraryData.components.length === 0) return;
    
    const newPositions: Record<string, { x: number; y: number }> = {};
    
    // Layout config - generous spacing for large sections
    const GAP = 40; // Gap between components
    const START_X = 40;
    const START_Y = 40;
    const MAX_ROW_WIDTH = 2000; // Max width before wrapping - allow large sections side by side
    
    // Get actual or estimated sizes for each component
    const getComponentSize = (comp: any) => {
      const id = `comp-${comp.id}`;
      const actualSize = blueprintSizes[id];
      if (actualSize?.width && actualSize?.height) {
        return { width: actualSize.width + 32, height: actualSize.height + 60 }; // Add padding for label/border
      }
      // Estimate based on layer/category - REALISTIC sizes for each type
      const layer = (comp.layer || comp.category || '').toLowerCase();
      const name = (comp.name || '').toLowerCase();
      
      // Full-width sections (hero, footer, header, pricing, features) - typically 1200px+ wide
      if (layer === 'product' || name.includes('hero') || name.includes('section') || 
          name.includes('footer') || name.includes('header') || name.includes('pricing') ||
          name.includes('feature') || name.includes('cta') || name.includes('banner')) {
        return { width: 900, height: 400 };
      }
      // Large templates (page layouts, app shells)
      if (layer === 'templates' || name.includes('layout') || name.includes('shell') ||
          name.includes('page') || name.includes('dashboard')) {
        return { width: 600, height: 350 };
      }
      // Medium-large patterns (cards, listings, rows)
      if (layer === 'patterns' || name.includes('card') || name.includes('listing') ||
          name.includes('row') || name.includes('item')) {
        return { width: 400, height: 280 };
      }
      // Medium components (navbar, sidebar, form)
      if (layer === 'components' || name.includes('nav') || name.includes('form') ||
          name.includes('modal') || name.includes('sidebar')) {
        return { width: 350, height: 200 };
      }
      // Small action components (buttons, badges, icons, text, divider)
      if (name.includes('button') || name.includes('badge') ||
          name.includes('icon') || name.includes('text') || name.includes('divider')) {
        return { width: 200, height: 100 };
      }
      // Default medium
      return { width: 320, height: 180 };
    };

    // Group by layer for organized layout - LARGEST FIRST (product -> foundations)
    const layers = ['product', 'templates', 'patterns', 'components', 'foundations'];
    const componentsByLayer: Record<string, any[]> = {};
    layers.forEach(l => componentsByLayer[l] = []);
    
    libraryData.components.forEach((comp: any) => {
      let layer = (comp.layer || 'components').toLowerCase();
      // Backward compat: remap old layer names
      if (layer === 'primitives' || layer === 'elements') layer = 'components';
      if (componentsByLayer[layer]) {
        componentsByLayer[layer].push(comp);
      } else {
        componentsByLayer.components.push(comp);
      }
    });
    
    // Layout each layer in rows, wrapping when exceeding MAX_ROW_WIDTH
    let currentY = START_Y;
    
    layers.forEach(layer => {
      const comps = componentsByLayer[layer];
      if (comps.length === 0) return;

      // Store a label position for this layer section
      newPositions[`label-${layer}`] = { x: START_X, y: currentY };
      currentY += 28; // space for label

      let currentX = START_X;
      let rowMaxHeight = 0;

      comps.forEach((comp: any) => {
        const id = `comp-${comp.id}`;
        const size = getComponentSize(comp);

        // Wrap to next row if exceeding max width
        if (currentX + size.width > MAX_ROW_WIDTH && currentX > START_X) {
          currentX = START_X;
          currentY += rowMaxHeight + GAP;
          rowMaxHeight = 0;
        }

        newPositions[id] = { x: currentX, y: currentY };
        currentX += size.width + GAP;
        rowMaxHeight = Math.max(rowMaxHeight, size.height);
      });

      // Move to next section
      currentY += rowMaxHeight + GAP * 2;
    });
    
    setBlueprintPositions(newPositions);
    // Reset zoom to fit
    setBlueprintsZoom(100);
    setBlueprintsOffset({ x: 0, y: 0 });
  }, [libraryData?.components, blueprintSizes]);

  // Vision Import - Convert image/screenshot OR description to component code
  const processVisionImport = useCallback(async (imageBase64: string | null, description?: string) => {
    if (!imageBase64 && !description) return;
    
    setVisionImportLoading(true);
    setVisionImportProgress(imageBase64 ? "Analyzing image with AI Vision..." : "Creating component from description...");
    
    try {
      // Compress image if it's too large using inline compression
      let processedImage = imageBase64;
      if (imageBase64) {
        // Check size (rough estimate: base64 is ~1.37x the original)
        const estimatedSize = (imageBase64.length * 0.75) / (1024 * 1024); // MB
        if (estimatedSize > 3) {
          setVisionImportProgress("Compressing image...");
          // Inline compression for base64
          processedImage = await new Promise<string>((resolve) => {
            const img = document.createElement('img');
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const maxWidth = 1000;
              let { width, height } = img;
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx?.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = imageBase64;
          });
        }
      }
      
      const response = await fetch('/api/blueprint/vision', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          imageBase64: processedImage,
          description: description || undefined,
          componentName: visionImportComponentName || undefined,
          additionalInstructions: visionImportInstructions || undefined
        })
      });
      
      if (!response.ok) throw new Error('Vision API error');
      
      const reader = response.body?.getReader();
      if (!reader) throw new Error('No reader');
      
      const decoder = new TextDecoder();
      let generatedCode = '';
      let componentName = 'ImportedComponent';
      let category = 'atoms';
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n').filter(l => l.startsWith('data: '));
        
        for (const line of lines) {
          try {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'partial') {
              generatedCode = data.code;
              setVisionImportProgress("Generating code...");
            } else if (data.type === 'done') {
              generatedCode = data.code;
              componentName = data.componentName || 'ImportedComponent';
              category = data.category || 'atoms';
            } else if (data.type === 'error') {
              throw new Error(data.error);
            }
          } catch (e) {}
        }
      }
      
      // Create new component in library
      const newId = `vision-${Date.now()}`;
      const newComp = {
        id: newId,
        name: visionImportComponentName || componentName,
        category: category,
        code: generatedCode,
        description: 'Imported from image using AI Vision',
        props: [],
        variants: []
      };
      
      setLibraryData((prev: any) => ({
        ...prev,
        components: [...(prev?.components || []), newComp]
      }));
      
      // Position the new component on canvas
      const rect = blueprintsCanvasRef.current?.getBoundingClientRect();
      const scale = blueprintsZoom / 100;
      const canvasCenter = rect ? {
        x: (rect.width / 2 - blueprintsOffset.x) / scale,
        y: (rect.height / 2 - blueprintsOffset.y) / scale
      } : { x: 200, y: 200 };
      
      setBlueprintPositions(prev => ({
        ...prev,
        [`comp-${newId}`]: canvasCenter
      }));
      
      // Select the new component
      setSelectedBlueprintComponent(`comp-${newId}`);
      
      // Broadcast to other users
      broadcastLibraryComponentAdd(newComp);
      broadcastBlueprintPosition(`comp-${newId}`, canvasCenter.x, canvasCenter.y);
      
      showToast(imageBase64 ? "Component imported from image!" : "Component created from description!", "success");
      setShowVisionImportModal(false);
      setVisionImportImage(null);
      setVisionImportInstructions("");
      setVisionImportComponentName("");
      setVisionImportDescription("");
      
    } catch (error: any) {
      console.error("Vision import error:", error);
      showToast("Failed to import component", "error");
    } finally {
      setVisionImportLoading(false);
      setVisionImportProgress("");
    }
  }, [visionImportComponentName, visionImportInstructions, blueprintsZoom, blueprintsOffset, showToast]);

  // Helper: Fit component in view after generation
  const fitComponentInView = useCallback((componentId: string) => {
    setTimeout(() => {
      const rect = blueprintsCanvasRef.current?.getBoundingClientRect();
      if (!rect) return;
      
      const pos = blueprintPositions[componentId];
      const size = blueprintSizes[componentId] || { width: 400, height: 300 };
      if (!pos) return;
      
      // Calculate offset to center the component
      const targetZoom = 100; // Reset to 100% for visibility
      const scale = targetZoom / 100;
      const offsetX = rect.width / 2 - (pos.x + size.width / 2) * scale;
      const offsetY = rect.height / 2 - (pos.y + size.height / 2) * scale;
      
      setBlueprintsZoom(targetZoom);
      setBlueprintsOffset({ x: offsetX, y: offsetY });
    }, 100);
  }, [blueprintPositions, blueprintSizes]);

  // Handle paste event for Vision import (Ctrl+V on Blueprint canvas)
  const handleBlueprintPaste = useCallback(async (e: ClipboardEvent) => {
    if (viewMode !== 'blueprints') return;
    
    const clipboardData = e.clipboardData;
    if (!clipboardData) return;
    
    const files = clipboardData.files;
    const items = clipboardData.items;
    
    let imageFile: File | null = null;
    
    // Check for files first
    for (let i = 0; i < files.length; i++) {
      if (files[i].type.startsWith('image/')) {
        imageFile = files[i];
        break;
      }
    }
    
    // Check items if no file found
    if (!imageFile && items) {
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          imageFile = items[i].getAsFile();
          if (imageFile) break;
        }
      }
    }
    
    if (!imageFile) return;
    
    e.preventDefault();
    
    // Convert to base64
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result as string;
      setVisionImportImage(base64);
      setShowVisionImportModal(true);
    };
    reader.readAsDataURL(imageFile);
  }, [viewMode]);

  // Handle file input for Vision import
  const handleVisionFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result as string;
      setVisionImportImage(base64);
      setShowVisionImportModal(true);
    };
    reader.readAsDataURL(file);
    
    // Reset input
    if (visionFileInputRef.current) {
      visionFileInputRef.current.value = '';
    }
  }, []);

  // Handle drag & drop for Vision import
  const handleBlueprintDragOver = useCallback((e: React.DragEvent) => {
    if (viewMode !== 'blueprints') return;
    e.preventDefault();
    setIsDraggingOverCanvas(true);
  }, [viewMode]);

  const handleBlueprintDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDraggingOverCanvas(false);
  }, []);

  const handleBlueprintDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDraggingOverCanvas(false);
    
    if (viewMode !== 'blueprints') return;
    
    const files = e.dataTransfer.files;
    for (let i = 0; i < files.length; i++) {
      if (files[i].type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result as string;
          setVisionImportImage(base64);
          setShowVisionImportModal(true);
        };
        reader.readAsDataURL(files[i]);
        break;
      }
    }
  }, [viewMode]);

  // Attach paste listener for Blueprint canvas
  useEffect(() => {
    document.addEventListener('paste', handleBlueprintPaste);
    return () => document.removeEventListener('paste', handleBlueprintPaste);
  }, [handleBlueprintPaste]);

  // Track if blueprint positions have been loaded from localStorage
  const [blueprintLayoutLoaded, setBlueprintLayoutLoaded] = useState(false);
  const lastLayoutedComponentCount = useRef(0);
  
  // Initialize positions when library data changes - ALWAYS auto-layout new components properly
  useEffect(() => {
    if (!libraryData?.components || libraryData.components.length === 0) return;
    
    const componentCount = libraryData.components.length;
    const componentIds = libraryData.components.map((c: any) => `comp-${c.id}`);
    const existingPositionIds = Object.keys(blueprintPositions);
    const newComponentsWithoutPositions = componentIds.filter((id: string) => !existingPositionIds.includes(id));
    
    // Skip if all components already have positions
    if (newComponentsWithoutPositions.length === 0) {
      setBlueprintLayoutLoaded(true);
      return;
    }
    
    // If no existing positions OR this is a fresh load, do full auto-layout
    if (existingPositionIds.length === 0 || lastLayoutedComponentCount.current === 0) {
      lastLayoutedComponentCount.current = componentCount;
      autoLayoutBlueprints();
      setBlueprintLayoutLoaded(true);
      return;
    }
    
    // Otherwise, position new components using masonry-style layout
    // Find the rightmost and bottom positions of existing components
    let maxY = 0;
    let rightmostX = 60;
    existingPositionIds.forEach(id => {
      const pos = blueprintPositions[id];
      if (pos) {
        if (pos.y > maxY) maxY = pos.y;
        if (pos.x > rightmostX) rightmostX = pos.x;
      }
    });
    
    // Create new positions for components without positions - match autoLayoutBlueprints settings
    const newPositions: Record<string, { x: number; y: number }> = {};
    const GAP_X = 40;
    const GAP_Y = 40;
    const COLUMN_WIDTH = 320;
    const NUM_COLUMNS = 4;
    const START_Y = maxY + 100; // Start below existing components
    
    // 4-column masonry for new components
    const columnHeights = Array(NUM_COLUMNS).fill(0);
    newComponentsWithoutPositions.forEach((id: string, idx: number) => {
      // Find the component to estimate height
      const comp = libraryData.components.find((c: any) => `comp-${c.id}` === id);
      let estimatedHeight = 200;
      const name = (comp?.name || '').toLowerCase();
      if (name.includes('navbar') || name.includes('navigation') || name.includes('sidebar')) estimatedHeight = 100;
      else if (name.includes('hero') || name.includes('section')) estimatedHeight = 300;
      else if (name.includes('card')) estimatedHeight = 280;
      else if (name.includes('form') || name.includes('contact')) estimatedHeight = 350;
      else if (name.includes('pricing')) estimatedHeight = 400;
      else if (name.includes('button') || name.includes('badge')) estimatedHeight = 80;
      else if (name.includes('banner') || name.includes('marquee')) estimatedHeight = 100;
      
      // Find shortest column
      let shortestCol = 0;
      for (let i = 1; i < NUM_COLUMNS; i++) {
        if (columnHeights[i] < columnHeights[shortestCol]) {
          shortestCol = i;
        }
      }
      
      newPositions[id] = {
        x: 60 + shortestCol * (COLUMN_WIDTH + GAP_X),
        y: START_Y + columnHeights[shortestCol]
      };
      
      columnHeights[shortestCol] += estimatedHeight + GAP_Y;
    });
    
    // Update positions all at once
    setBlueprintPositions(prev => ({
      ...prev,
      ...newPositions
    }));
    
    lastLayoutedComponentCount.current = componentCount;
    setBlueprintLayoutLoaded(true);
  }, [libraryData?.components?.length, autoLayoutBlueprints]);
  
  // Track which components have been manually resized by user
  const [manuallyResizedComponents, setManuallyResizedComponents] = useState<Set<string>>(new Set());
  
  // Handle resize messages from blueprint iframes for "hug contents" behavior
  useEffect(() => {
    const handleResize = (e: MessageEvent) => {
      if (e.data?.type === 'resize' && e.data?.id && e.data?.width && e.data?.height) {
        const compId = `comp-${e.data.id}`;
        const w = e.data.width;
        const h = e.data.height;
        
        // Update iframe size directly
        const iframe = document.getElementById(`iframe-${e.data.id}`) as HTMLIFrameElement;
        if (iframe) {
          iframe.style.width = `${w}px`;
          iframe.style.height = `${h}px`;
        }
        
        // ONLY update blueprintSizes if component hasn't been manually resized
        // AND is not currently being resized (prevents "jump" on first click)
        setBlueprintSizes(prev => {
          // Skip if manually resized OR currently being resized
          if (manuallyResizedComponents.has(compId) || resizingComponent?.id === compId) {
            return prev;
          }
          const existing = prev[compId];
          // Only update if size changed significantly (avoid unnecessary re-renders)
          if (existing && Math.abs(existing.width - w) < 5 && Math.abs(existing.height - h) < 5) {
            return prev;
          }
          return { ...prev, [compId]: { width: w, height: h } };
        });
      }
    };
    window.addEventListener('message', handleResize);
    return () => window.removeEventListener('message', handleResize);
  }, [manuallyResizedComponents, resizingComponent]);
  
  const [isGeneratingLibrary, setIsGeneratingLibrary] = useState(false);
  
  const [archZoom, setArchZoom] = useState(1);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedNodeModal, setSelectedNodeModal] = useState<ArchNode | null>(null);
  
  // Generation history for persistence  
  const [generations, setGenerations] = useState<GenerationRecord[]>([]);
  const [isLoadingHistory, setIsLoadingHistory] = useState(true); // Show loading until first Supabase fetch
  const [activeGeneration, setActiveGeneration] = useState<GenerationRecord | null>(null);
  const [generationTitle, setGenerationTitle] = useState<string>("Untitled Project");
  
  // Pagination & Search state for history
  const [historyOffset, setHistoryOffset] = useState(0);
  const [historyTotal, setHistoryTotal] = useState(0);
  const [historySearch, setHistorySearch] = useState("");
  const [isLoadingMore, setIsLoadingMore] = useState(false);
  const [hasMoreHistory, setHasMoreHistory] = useState(true);
  const searchDebounceRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const HISTORY_PAGE_SIZE = 10;
  
  // Initialize showHistoryMode - default to true so users see their projects first
  const [showHistoryMode, setShowHistoryMode] = useState(() => {
    // Check URL params for explicit override
    if (typeof window !== 'undefined') {
      const urlParams = new URLSearchParams(window.location.search);
      // If ?new=true, start with empty project
      if (urlParams.get('new') === 'true') {
        return false;
      }
      // Also check localStorage as fallback for explicit new project request
      const openFromStorage = localStorage.getItem("replay_open_projects");
      if (openFromStorage === "false") {
        localStorage.removeItem("replay_open_projects");
        return false;
      }
    }
    // Default: show projects list
    return true;
  });
  const [showProjectSettings, setShowProjectSettings] = useState(false);
  const [historyMenuOpen, setHistoryMenuOpen] = useState<string | null>(null);
  const [renamingId, setRenamingId] = useState<string | null>(null);
  const [renameValue, setRenameValue] = useState("");
  // historySearch is defined earlier in pagination state
  const [expandedVersions, setExpandedVersions] = useState<string | null>(null); // Which generation's versions are shown
  
  // Agentic Chat Sidebar
  const [sidebarMode, setSidebarMode] = useState<SidebarMode>("config");
  const [sidebarTab, setSidebarTab] = useState<SidebarTab>("chat");
  const [sidebarView, setSidebarView] = useState<SidebarView>("detail"); // projects list vs detail view
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false); // collapsed sidebar state
  const [projectMenuOpen, setProjectMenuOpen] = useState<string | null>(null); // context menu for projects
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [chatInput, setChatInput] = useState("");
  const [selectedElement, setSelectedElement] = useState<string | null>(null);
  const [isSelectingElement, setIsSelectingElement] = useState(false);
  const [isPlanMode, setIsPlanMode] = useState(false); // Plan mode - discuss without executing
  const [streamingStatus, setStreamingStatus] = useState<string | null>(null); // Streaming status message
  const [streamingCode, setStreamingCode] = useState<string | null>(null); // Code being streamed
  const [streamingLines, setStreamingLines] = useState<number>(0); // Number of lines being written
  
  // Publishing state
  const [isPublishing, setIsPublishing] = useState(false);
  const [publishedUrl, setPublishedUrl] = useState<string | null>(null);
  const [showPublishModal, setShowPublishModal] = useState(false);
  
  // Storybook / Design System state
  
  // Delete confirmation modal
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deleteTargetId, setDeleteTargetId] = useState<string | null>(null);
  const [deleteTargetTitle, setDeleteTargetTitle] = useState<string>("");
  
  // Delete component modal (for Blueprints)
  const [showDeleteComponentModal, setShowDeleteComponentModal] = useState(false);
  const [deleteComponentTarget, setDeleteComponentTarget] = useState<{ id: string; name: string } | null>(null);
  
  // Direct text editing mode (like Framer)
  const [isDirectEditMode, setIsDirectEditMode] = useState(false);
  const [pendingTextEdits, setPendingTextEdits] = useState<{ originalText: string; newText: string; elementPath: string }[]>([]);
  
  // Assets modal state
  const [showAssetsModal, setShowAssetsModal] = useState(false);
  const [selectedAssetUrl, setSelectedAssetUrl] = useState<string | null>(null);
  const [selectedAssetOccurrence, setSelectedAssetOccurrence] = useState<number | null>(null);
  
  // Video preview modal
  const [videoPreviewModal, setVideoPreviewModal] = useState<{ open: boolean; url: string; name: string } | null>(null);
  
  // Helper to inject image click handlers into preview HTML
  const injectAssetClickHandler = useCallback((html: string): string => {
    // Simple CSS - outline without offset to not break layout
    const CSS_STYLES = 'img { cursor: pointer !important; outline: 2px dashed var(--accent-orange) !important; outline-offset: -2px !important; } img:hover { outline-width: 3px !important; filter: brightness(1.06) !important; } [data-has-bg-image] { cursor: pointer !important; outline: 2px dashed var(--accent-orange) !important; outline-offset: -2px !important; } [data-has-bg-image]:hover { outline-width: 3px !important; }';
    
    const script = `<script>
(function() {
  var assetSelectorEnabled = false;
  
  function init() {
    var style = document.createElement('style');
    style.id = 'assets-selector-styles';
    document.head.appendChild(style);
    
    // Find and mark ALL elements with background images
    function markBackgroundImages() {
      var count = 0;
      document.querySelectorAll('*').forEach(function(el) {
        if (el.hasAttribute('data-has-bg-image')) return;
        
        var computed = window.getComputedStyle(el);
        var bg = computed.backgroundImage;
        
        if (bg && bg !== 'none' && bg.includes('url(')) {
          var urlMatch = bg.match(/url\\(["']?([^"')]+)["']?\\)/);
          if (urlMatch && urlMatch[1]) {
            var url = urlMatch[1];
            if (!url.includes('.svg') && !url.startsWith('data:') && !url.includes('gradient')) {
              el.setAttribute('data-has-bg-image', 'true');
              el.setAttribute('data-bg-url', url);
              count++;
            }
          }
        }
      });
      console.log('[Assets] Marked ' + count + ' elements with background images');
    }
    
    function buildAssetIndex() {
      var urlCounts = {};
      document.querySelectorAll('img').forEach(function(img) {
        var url = img.currentSrc || img.src;
        if (!url || url.includes('.svg') || url.startsWith('data:')) return;
        var count = urlCounts[url] || 0;
        img.setAttribute('data-asset-url', url);
        img.setAttribute('data-asset-occurrence', String(count));
        urlCounts[url] = count + 1;
      });
      document.querySelectorAll('[data-has-bg-image]').forEach(function(el) {
        var url = el.getAttribute('data-bg-url');
        if (!url || url.includes('.svg') || url.startsWith('data:')) return;
        var count = urlCounts[url] || 0;
        el.setAttribute('data-asset-url', url);
        el.setAttribute('data-asset-occurrence', String(count));
        urlCounts[url] = count + 1;
      });
    }
    
    function countImages() {
      var imgs = document.querySelectorAll('img');
      var bgs = document.querySelectorAll('[data-has-bg-image]');
      console.log('[Assets] Found ' + imgs.length + ' img tags and ' + bgs.length + ' background images');
      return imgs.length + bgs.length;
    }
    
    window.__applyAssetStyles = function(enabled) {
      assetSelectorEnabled = enabled;
      var style = document.getElementById('assets-selector-styles');
      if (enabled) {
        markBackgroundImages();
        buildAssetIndex();
        style.textContent = ${JSON.stringify(CSS_STYLES)};
        var total = countImages();
        console.log('[Assets] Selector enabled - ' + total + ' images clickable');
      } else {
        style.textContent = '';
        console.log('[Assets] Selector disabled');
      }
    };
    
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'TOGGLE_ASSET_SELECTOR') {
        window.__applyAssetStyles(e.data.enabled);
      }
    });
    
    // Handle clicks on images AND background-images
    document.addEventListener('click', function(e) {
      if (!assetSelectorEnabled) return;
      
      var target = e.target;
      var url = null;
      var occurrence = null;
      
      // Check if clicked element or parent is an img tag
      var img = target.tagName === 'IMG' ? target : target.closest('img');
      if (img && img.src && !img.src.includes('.svg') && !img.src.startsWith('data:')) {
        url = img.currentSrc || img.src;
        occurrence = img.getAttribute('data-asset-occurrence');
        console.log('[Assets] Clicked img tag:', url);
      }
      
      // If no img found, check for background-image (including on parent elements)
      if (!url) {
        var el = target;
        // First check if we have data-bg-url from our marking
        while (el && el !== document.body) {
          if (el.hasAttribute('data-bg-url')) {
            url = el.getAttribute('data-bg-url');
            occurrence = el.getAttribute('data-asset-occurrence');
            console.log('[Assets] Clicked element with marked bg:', url);
            break;
          }
          el = el.parentElement;
        }
        
        // Fallback: check computed background-image directly
        if (!url) {
          el = target;
          while (el && el !== document.body) {
            var bg = window.getComputedStyle(el).backgroundImage;
            if (bg && bg !== 'none' && bg.includes('url(')) {
              var match = bg.match(/url\\(["']?([^"')]+)["']?\\)/);
              if (match && match[1] && !match[1].includes('.svg') && !match[1].startsWith('data:')) {
                url = match[1];
                occurrence = el.getAttribute('data-asset-occurrence');
                console.log('[Assets] Clicked element with computed bg:', url);
                break;
              }
            }
            el = el.parentElement;
          }
        }
      }
      
      if (url) {
        e.preventDefault();
        e.stopPropagation();
        console.log('[Assets] Sending ASSET_CLICK:', url);
        window.parent.postMessage({ type: 'ASSET_CLICK', url: url, occurrence: occurrence ? parseInt(occurrence, 10) : null }, '*');
      }
    }, true);
    
    console.log('[Assets] Handler initialized');
    window.parent.postMessage({ type: 'ASSET_HANDLER_READY' }, '*');
    
    // Track mouse position for live cursors
    document.addEventListener('mousemove', function(e) {
      window.parent.postMessage({ 
        type: 'IFRAME_MOUSE_MOVE', 
        x: e.clientX, 
        y: e.clientY 
      }, '*');
    });
    
    document.addEventListener('mouseleave', function() {
      window.parent.postMessage({ type: 'IFRAME_MOUSE_LEAVE' }, '*');
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>`;
    if (html.includes('</head>')) {
      return html.replace('</head>', script + '</head>');
    } else if (html.includes('<body')) {
      return html.replace('<body', script + '<body');
    }
    return script + html;
  }, []);
  
  const injectPageSelection = useCallback((code: string, pageId?: string | null): string => {
    if (!pageId) return code;
    
    // Normalize pageId for matching (lowercase, remove special chars)
    const normalizedId = pageId.toLowerCase().replace(/[^a-z0-9]/g, '');
    
    const script = `
<script>
(function() {
  var targetPage = ${JSON.stringify(pageId)};
  var normalizedTarget = ${JSON.stringify(normalizedId)};
  
  function trySetPage() {
    try {
      // 1. Try Alpine.js first (x-data with currentPage)
      var root = document.querySelector('[x-data]');
      if (root && root._x_dataStack && root._x_dataStack[0]) {
        var data = root._x_dataStack[0];
        if (data.currentPage !== undefined) { data.currentPage = targetPage; return; }
        if (data.page !== undefined) { data.page = targetPage; return; }
        if (data.activeTab !== undefined) { data.activeTab = targetPage; return; }
        if (data.activeView !== undefined) { data.activeView = targetPage; return; }
      }
      
      // 2. Try React - trigger click on nav item
      var navItems = document.querySelectorAll('nav button, nav a, [class*="nav"] button, header button, header a');
      for (var i = 0; i < navItems.length; i++) {
        var text = (navItems[i].textContent || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (text === normalizedTarget || text.includes(normalizedTarget)) {
          navItems[i].click();
          return;
        }
      }
      
      // 3. Fallback - scroll to section with matching id/class/heading
      var selectors = [
        '#' + targetPage,
        '#' + normalizedTarget,
        '[id*="' + normalizedTarget + '"]',
        'section[class*="' + normalizedTarget + '"]',
        '[class*="' + normalizedTarget + '"]'
      ];
      for (var j = 0; j < selectors.length; j++) {
        try {
          var el = document.querySelector(selectors[j]);
          if (el) {
            el.scrollIntoView({ behavior: 'instant', block: 'start' });
            return;
          }
        } catch(e) {}
      }
      
      // 4. Search for heading with matching text
      var headings = document.querySelectorAll('h1, h2, h3, section > div:first-child');
      for (var k = 0; k < headings.length; k++) {
        var hText = (headings[k].textContent || '').toLowerCase().replace(/[^a-z0-9]/g, '');
        if (hText.includes(normalizedTarget) || normalizedTarget.includes(hText.slice(0, 6))) {
          headings[k].scrollIntoView({ behavior: 'instant', block: 'start' });
          return;
        }
      }
    } catch (e) { console.log('Page selection error:', e); }
  }
  
  document.addEventListener('alpine:init', trySetPage);
  document.addEventListener('alpine:initialized', trySetPage);
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(trySetPage, 50);
    setTimeout(trySetPage, 200);
    setTimeout(trySetPage, 500);
  });
  if (document.readyState === 'complete') {
    setTimeout(trySetPage, 50);
  }
})();
</script>`;
    if (code.includes('</body>')) return code.replace('</body>', script + '</body>');
    return code + script;
  }, []);
  
  // Create preview URL with asset click handlers and stabilized picsum URLs
  const createPreviewUrl = useCallback((code: string): string => {
    // First stabilize any picsum URLs to prevent images from randomly changing
    let processedCode = stabilizePicsumUrls(code);
    
    // DETECT JSX/React code and convert to HTML
    // JSX code typically starts with comments, imports, or function declarations
    const isJsxCode = /^\/\/\s*(Next\.js|React|App|Page|Component)/i.test(processedCode.trim()) ||
                      /^(import\s|export\s+default\s+function|function\s+\w+Page)/i.test(processedCode.trim()) ||
                      /^['"]use client['"]/.test(processedCode.trim());
    
    if (isJsxCode) {
      console.log("[Preview] Detected JSX code, converting to HTML...");
      processedCode = jsxToHtml(processedCode);
    }
    
    // FIX INVISIBLE ELEMENTS - CSS to force visibility (AI generates opacity:0 for animations)
    const invisibleFixStyles = `
<style id="invisible-fix">
  /* Force all elements visible - fix AI generated fade/slide animations */
  [style*="opacity: 0"], [style*="opacity:0"] { opacity: 1 !important; }
  [style*="visibility: hidden"], [style*="visibility:hidden"] { visibility: visible !important; }
  [style*="translate"] { opacity: 1 !important; }
  .fade-up, .fade-in, .fade-down, .slide-up, .slide-in, .animate-fade,
  [class*="fade-"], [class*="slide-"], [class*="stagger-"], [class*="animate-"] {
    opacity: 1 !important;
    visibility: visible !important;
  }
  [data-state="hidden"], [data-visible="false"], [data-aos] {
    opacity: 1 !important;
    visibility: visible !important;
    transform: none !important;
  }
  /* Fix Lucide icons - make invisible instead of hidden to preserve layout */
  i[data-lucide]:empty { opacity: 0; width: 1em; height: 1em; display: inline-block; }
  i[data-lucide]:not(:has(svg)) { opacity: 0; width: 1em; height: 1em; display: inline-block; }
  i[data-lucide]:has(svg) { opacity: 1 !important; }
  /* Fix sections with no content showing */
  section:empty { min-height: 0 !important; }
  /* Ensure grid/flex children are visible */
  .grid > *, .flex > * { opacity: 1 !important; visibility: visible !important; }
</style>
<script>
// Force all elements visible after load
function forceVisible() {
  document.querySelectorAll('*').forEach(function(el) {
    var style = window.getComputedStyle(el);
    var inlineStyle = el.getAttribute('style') || '';
    
    // Fix opacity:0
    if (style.opacity === '0' || inlineStyle.includes('opacity:0') || inlineStyle.includes('opacity: 0')) {
      el.style.opacity = '1';
    }
    
    // Fix visibility:hidden
    if (style.visibility === 'hidden') {
      el.style.visibility = 'visible';
    }
    
    // Fix elements positioned off-screen
    if (el.getBoundingClientRect && el.offsetParent !== null) {
      var rect = el.getBoundingClientRect();
      if (rect.top < -1000 || rect.left < -1000) {
        el.style.transform = 'none';
        el.style.top = 'auto';
        el.style.left = 'auto';
      }
    }
  });
}
window.addEventListener('load', forceVisible);
setTimeout(forceVisible, 100);
setTimeout(forceVisible, 500);
setTimeout(forceVisible, 1000);
// Initialize Lucide icons if available
window.addEventListener('load', function() {
  if (typeof lucide !== 'undefined') {
    try { lucide.createIcons(); } catch(e) {}
  }
});
</script>`;
    
    // Ensure Tailwind CSS is included (inject if missing)
    if (!processedCode.includes('cdn.tailwindcss.com') && !processedCode.includes('tailwindcss')) {
      const tailwindScript = '<script src="https://cdn.tailwindcss.com"></script>';
      const gsapScript = '<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>';
      const alpineScript = '<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>';
      const lucideScript = '<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>';
      
      if (processedCode.includes('</head>')) {
        // Inject before </head>
        processedCode = processedCode.replace('</head>', `${tailwindScript}\n${gsapScript}\n${alpineScript}\n${lucideScript}\n${invisibleFixStyles}\n</head>`);
      } else if (processedCode.includes('<body')) {
        // Inject before <body>
        processedCode = processedCode.replace(/<body/, `<head>${tailwindScript}\n${gsapScript}\n${alpineScript}\n${lucideScript}${invisibleFixStyles}</head>\n<body`);
      } else {
        // Wrap in full HTML structure
        processedCode = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  ${tailwindScript}
  ${gsapScript}
  ${alpineScript}
  ${lucideScript}
  ${invisibleFixStyles}
  <style>* { margin: 0; padding: 0; box-sizing: border-box; }</style>
</head>
<body class="min-h-screen">
${processedCode}
</body>
</html>`;
      }
    } else {
      // Tailwind already present, just add the fix
      if (processedCode.includes('</head>')) {
        processedCode = processedCode.replace('</head>', `${invisibleFixStyles}\n</head>`);
      } else if (processedCode.includes('</body>')) {
        processedCode = processedCode.replace('</body>', `${invisibleFixStyles}\n</body>`);
      }
    }
    
    // FOUC fix: detect dark background from Tailwind classes and add inline style
    // so the page doesn't flash white while Tailwind CDN loads
    const darkBgClasses = ['bg-zinc-950', 'bg-zinc-900', 'bg-gray-950', 'bg-gray-900', 'bg-slate-950', 'bg-slate-900', 'bg-neutral-950', 'bg-neutral-900', 'bg-black', 'bg-stone-950', 'bg-stone-900'];
    const darkBgMap: Record<string, string> = {
      'bg-zinc-950': '#09090b', 'bg-zinc-900': '#18181b', 'bg-gray-950': '#030712', 'bg-gray-900': '#111827',
      'bg-slate-950': '#020617', 'bg-slate-900': '#0f172a', 'bg-neutral-950': '#0a0a0a', 'bg-neutral-900': '#171717',
      'bg-black': '#000000', 'bg-stone-950': '#0c0a09', 'bg-stone-900': '#1c1917'
    };
    // Check body tag and html tag for dark background classes
    const bodyMatch = processedCode.match(/<body[^>]*class="([^"]*)"/);
    const htmlMatch = processedCode.match(/<html[^>]*class="([^"]*)"/);
    const bodyClasses = (bodyMatch?.[1] || '') + ' ' + (htmlMatch?.[1] || '');
    let inlineBgColor = '';
    for (const cls of darkBgClasses) {
      if (bodyClasses.includes(cls)) {
        inlineBgColor = darkBgMap[cls];
        break;
      }
    }
    // Also check for inline background-color or hex in style attribute
    if (!inlineBgColor) {
      const bodyStyleMatch = processedCode.match(/<body[^>]*style="([^"]*)"/);
      const bgColorMatch = bodyStyleMatch?.[1]?.match(/background(?:-color)?:\s*(#[0-9a-fA-F]{3,8}|rgb[^;)]+\))/);
      if (bgColorMatch) inlineBgColor = bgColorMatch[1];
    }
    if (inlineBgColor) {
      const foucFix = `<style>html,body{background-color:${inlineBgColor} !important;}</style>`;
      if (processedCode.includes('</head>')) {
        processedCode = processedCode.replace('</head>', `${foucFix}\n</head>`);
      } else if (processedCode.includes('<body')) {
        processedCode = processedCode.replace(/<body/, `${foucFix}\n<body`);
      }
    }

    const codeWithHandler = injectAssetClickHandler(processedCode);
    return URL.createObjectURL(new Blob([codeWithHandler], { type: "text/html" }));
  }, [injectAssetClickHandler]);
  
  // Track if iframe handler is ready
  const iframeHandlerReady = useRef(false);
  
  // Listen for asset clicks and handler ready from preview iframe
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      if (event.data?.type === 'ASSET_CLICK' && event.data?.url) {
        console.log('[Assets] Image clicked in preview:', event.data.url);
        setSelectedAssetUrl(event.data.url);
        setSelectedAssetOccurrence(
          typeof event.data.occurrence === "number" ? event.data.occurrence : null
        );
        setShowAssetsModal(true);
      }
      if (event.data?.type === 'ASSET_HANDLER_READY') {
        console.log('[Assets] Handler ready in iframe');
        iframeHandlerReady.current = true;
        // If Assets modal is already open, send the toggle message
        if (showAssetsModal && previewIframeRef.current?.contentWindow) {
          previewIframeRef.current.contentWindow.postMessage({ type: 'TOGGLE_ASSET_SELECTOR', enabled: true }, '*');
        }
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [showAssetsModal]);
  
  // Toggle asset selector styles in iframe when Assets modal opens/closes (no reload)
  useEffect(() => {
    const sendToggleMessage = () => {
      if (previewIframeRef.current?.contentWindow) {
        previewIframeRef.current.contentWindow.postMessage({ type: 'TOGGLE_ASSET_SELECTOR', enabled: showAssetsModal }, '*');
      }
    };
    
    // Send immediately
    sendToggleMessage();
    
    // Also send after a short delay to ensure iframe is ready
    const timeout = setTimeout(sendToggleMessage, 100);
    const timeout2 = setTimeout(sendToggleMessage, 500);
    
    return () => {
      clearTimeout(timeout);
      clearTimeout(timeout2);
    };
  }, [showAssetsModal, previewUrl]); // Also re-send when previewUrl changes (new iframe content)
  
  // Dragging state for flow nodes
  const [draggingNodeId, setDraggingNodeId] = useState<string | null>(null);
  const dragStartPos = useRef({ x: 0, y: 0, nodeX: 0, nodeY: 0 });
  
  // Code tab state - Single-file (default for HTML output) vs Componentized mode
  const [codeMode, setCodeMode] = useState<CodeMode>("single-file");
  const [generatedFiles, setGeneratedFiles] = useState<FileNode[]>([]);
  const [activeFilePath, setActiveFilePath] = useState<string>("/pages/index.html");
  const [generatingFilePath, setGeneratingFilePath] = useState<string | null>(null); // Track which file is being generated
  const [codeReferenceMap, setCodeReferenceMap] = useState<CodeReferenceMap[]>([]);
  const [expandedFolders, setExpandedFolders] = useState<Set<string>>(new Set(["/pages", "/components"]));
  
  // Agent Mode - Enhanced code with AI context for Cursor/v0
  const [agentMode, setAgentMode] = useState(false);
  const [showCopyDropdown, setShowCopyDropdown] = useState(false);
  const [highlightedLines, setHighlightedLines] = useState<{ start: number; end: number } | null>(null);
  
  // Canvas pan state for architecture - start centered
  const [canvasPan, setCanvasPan] = useState({ x: -200, y: 50 });
  const [isPanning, setIsPanning] = useState(false);
  const panStartRef = useRef({ x: 0, y: 0, panX: 0, panY: 0 });
  const archCanvasRef = useRef<HTMLDivElement>(null);
  const editInputRef = useRef<HTMLInputElement>(null);
  const titleInputRef = useRef<HTMLInputElement>(null);
  const previewIframeRef = useRef<HTMLIFrameElement>(null);
  
  // Video player state
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [isDraggingTrim, setIsDraggingTrim] = useState<"start" | "end" | null>(null);
  const [trimPreviewTime, setTrimPreviewTime] = useState<number | null>(null);
  
  const [isRecording, setIsRecording] = useState(false);
  const [recordingDuration, setRecordingDuration] = useState(0);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const videoRef = useRef<HTMLVideoElement>(null);
  const trimBarRef = useRef<HTMLDivElement>(null);
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  const analysisRef = useRef<HTMLDivElement>(null);
  const codeContainerRef = useRef<HTMLDivElement>(null);
  const completionAudioRef = useRef<HTMLAudioElement | null>(null);
  
  // Pre-load completion audio and request notification permission
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // Pre-load audio
      const audio = new Audio("/finish.mp3");
      audio.volume = 1.0;
      audio.preload = "auto";
      audio.load();
      completionAudioRef.current = audio;
      
      // Request notification permission for background tab alerts
      if ('Notification' in window && Notification.permission === 'default') {
        // Request permission when user interacts (deferred)
        const requestPermission = () => {
          Notification.requestPermission();
          document.removeEventListener('click', requestPermission);
        };
        document.addEventListener('click', requestPermission, { once: true });
      }
    }
  }, []);

  const selectedFlow = flows.find(f => f.id === selectedFlowId);

  // Regenerate thumbnail from video URL (for restored flows)
  const regenerateThumbnail = useCallback(async (flowId: string, videoUrl: string) => {
    try {
      const video = document.createElement("video");
      video.crossOrigin = "anonymous";
      video.preload = "metadata";
      video.muted = true;
      
      video.onloadeddata = () => {
        video.currentTime = 0.5; // Seek to get a good frame
      };
      
      video.onseeked = () => {
        try {
          const canvas = document.createElement("canvas");
          const vw = video.videoWidth || 640;
          const vh = video.videoHeight || 360;
          canvas.width = 320; // Higher quality thumbnail
          canvas.height = Math.round((320 / vw) * vh) || 180;
          const ctx = canvas.getContext("2d");
          if (ctx && vw > 0 && vh > 0) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            if (dataUrl.length > 1000) {
              setFlows(prev => prev.map(f => 
                f.id === flowId ? { ...f, thumbnail: dataUrl } : f
              ));
            }
          }
        } catch (e) {
          console.error("Failed to regenerate thumbnail:", e);
        }
      };
      
      video.src = videoUrl;
      video.load();
    } catch (e) {
      console.error("Failed to load video for thumbnail:", e);
    }
  }, []);

  // Get suggestions for @ mentions
  const getSuggestions = () => {
    if (!editInput.includes("@")) return [];
    const lastAt = editInput.lastIndexOf("@");
    const query = editInput.slice(lastAt + 1).toLowerCase();
    return architecture.filter(node => 
      node.id.toLowerCase().includes(query) || 
      node.name.toLowerCase().includes(query)
    ).slice(0, 5);
  };

  const suggestions = getSuggestions();

  // Show suggestions when typing @
  useEffect(() => {
    setShowSuggestions(editInput.includes("@") && suggestions.length > 0 && showFloatingEdit);
  }, [editInput, suggestions.length, showFloatingEdit]);

  // Get messages based on current tab
  const getStreamingMessages = useCallback(() => {
    switch (viewMode) {
      case "preview": return STREAMING_MESSAGES_PREVIEW;
      case "code": return STREAMING_MESSAGES_CODE;
      case "flow": return STREAMING_MESSAGES_FLOW;
      case "design": return STREAMING_MESSAGES_DESIGN;
      default: return STREAMING_MESSAGES;
    }
  }, [viewMode]);

  // Get messages based on mobile panel
  const getMobileStreamingMessages = useCallback(() => {
    switch (mobilePanel) {
      case "preview": return STREAMING_MESSAGES_PREVIEW;
      case "code": return STREAMING_MESSAGES_CODE;
      case "flow": return STREAMING_MESSAGES_FLOW;
      case "design": return STREAMING_MESSAGES_DESIGN;
      default: return STREAMING_MESSAGES;
    }
  }, [mobilePanel]);

  // Track if we have pending code to show (generation finished while tab was hidden)
  const pendingCodeRef = useRef<string | null>(null);
  const streamingCompleteRef = useRef(false);
  const generationStartTimeRef = useRef<number | null>(null);
  
  // Max generation time (6 minutes on mobile, 4 on desktop) - after this, consider it stuck/failed
  const isMobileDevice = typeof navigator !== 'undefined' && /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
  // 5 minutes on desktop (Vercel limit is 300s), 6 minutes on mobile
  const MAX_GENERATION_TIME_MS = isMobileDevice ? 6 * 60 * 1000 : 5 * 60 * 1000;
  
  // Complete generation and show results
  const completeGeneration = useCallback((code: string) => {
    if (streamingCompleteRef.current) return;
    streamingCompleteRef.current = true;
    pendingCodeRef.current = null;
    generationStartTimeRef.current = null;
    
    console.log("Completing generation - showing result immediately");
    
    // Play notification sound and show browser notification if tab is hidden
    try {
      const soundEnabled = localStorage.getItem("replay_sound_on_complete");
      const isTabHidden = typeof document !== 'undefined' && document.hidden;
      
      // Show browser notification if tab is hidden (works in background!)
      if (isTabHidden && 'Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification('Replay - Generation Complete!', {
          body: 'Your interface is ready. Click to view.',
          icon: '/favicon.ico',
          tag: 'replay-generation-complete',
          requireInteraction: true // Keep notification visible until clicked
        });
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
      
      // Play sound (may not work in background tab, but notification will)
      if (soundEnabled !== "false") {
        if (completionAudioRef.current) {
          completionAudioRef.current.currentTime = 0;
          completionAudioRef.current.play().catch((err) => {
            console.log("Audio play failed (likely background tab):", err);
          });
        } else {
          const audio = new Audio("/finish.mp3");
          audio.volume = 1.0;
          audio.play().catch(() => {});
        }
      }
    } catch (e) { 
      console.log("Notification/Audio error:", e);
    }
    
    // Track successful generation (FB Pixel + CAPI)
    trackViewContent("Generation Complete", user?.id);
    
    setDisplayedCode(code);
    setEditableCode(code);
    setIsStreamingCode(false);
    setIsProcessing(false);
    setGenerationComplete(true);
    setViewMode("preview");
    
    // Clear streaming state
    setStreamingStatus(null);
    setStreamingCode(null);
    setStreamingLines(0);
    
    // Mark that we need to auto-generate docs (will be picked up by useEffect)
    setNeedsAutoGenDocs(true);
    
    // Mark that Library needs regeneration with new code
    setLibraryNeedsRegeneration(true);
    
    // Mark all components as done
    setAnalysisPhase(prev => prev ? {
      ...prev,
      components: prev.components.map(c => ({ ...c, status: "done" as const }))
    } : prev);
    
    // Auto-switch to preview on mobile and show sync modal (only once per generation)
    if (typeof window !== "undefined" && window.innerWidth < 768) {
      setMobilePanel("preview");
      // Only show modal if not already shown for this generation (use timestamp as unique ID)
      const currentGenId = `gen_${Date.now()}`;
      if (!mobileSyncShownForGeneration) {
        setShowMobileSyncModal(true);
        setMobileSyncShownForGeneration(currentGenId);
      }
    }
    
    // Generate description
    const description = generateAnalysisDescription(code, styleDirective);
    typeText(description, (typed) => setAnalysisDescription(typed), 15);
    
    // Update preview URL
    setPreviewUrl(createPreviewUrl(code));
    
    // TRANSFORM SIDEBAR TO AGENTIC CHAT
    setSidebarMode("chat");
    setSidebarTab("chat");
    setSidebarView("detail"); // Ensure we're in detail view to show Replay AI / Input tabs
    setSidebarCollapsed(false); // Ensure sidebar is visible
    setMobilePanel("chat"); // Also switch mobile to chat
    setGenerationComplete(true); // Mark generation as complete to show chat view
    
    // Generate AI summary message
    const componentCount = (code.match(/<(?:div|section|header|footer|nav|aside|main|article)[^>]*>/gi) || []).length;
    const hasNav = /<nav/i.test(code);
    const hasHeader = /<header/i.test(code);
    const hasFooter = /<footer/i.test(code);
    const hasForms = /<form/i.test(code);
    const hasCards = /card/gi.test(code);
    
    const features: string[] = [];
    if (hasNav) features.push("Navigation");
    if (hasHeader) features.push("Header");
    if (hasFooter) features.push("Footer");
    if (hasForms) features.push("Forms");
    if (hasCards) features.push("Cards");
    
    // Build a more human description of what was built
    const techStack: string[] = ["Tailwind CSS"];
    if (hasNav) techStack.push("Alpine.js navigation");
    if (hasForms) techStack.push("form components");
    if (hasCards) techStack.push("card layouts");
    
    const summaryMessage: ChatMessage = {
      id: generateId(),
      role: "assistant",
      content: `**Boom. UI Reconstructed.**\n\nMatched the layout from your video using ${techStack.slice(0, 3).join(", ")} for clean, maintainable code.\n\n${features.length > 0 ? `**Key sections:** ${features.join(" • ")}\n\n` : ""}Ready to refine? Just tell me what to tweak.`,
      timestamp: Date.now(),
      quickActions: [
        "Make it mobile-friendly",
        "Tweak the colors",
        "Add hover effects",
        "Improve the spacing"
      ]
    };
    setChatMessages([summaryMessage]);
  }, [styleDirective]);
  
  // Reset stuck generation
  const resetStuckGeneration = useCallback(() => {
    console.log("Resetting stuck generation");
    setIsProcessing(false);
    setIsStreamingCode(false);
    generationStartTimeRef.current = null;
    pendingCodeRef.current = null;
    streamingCompleteRef.current = false;
    showToast("Generation timed out. Please try again.", "error");
  }, [showToast]);
  
  // Reset to new project - clears all state and URL
  const resetToNewProject = useCallback(() => {
    // Reset all state
    setGeneratedCode(null);
    setDisplayedCode("");
    setEditableCode("");
    setPreviewUrl(null);
    setGenerationComplete(false);
    setSidebarMode("config");
    setChatMessages([]);
    setActiveGeneration(null);
    setGenerationTitle("Untitled Project");
    setFlowNodes([]);
    setFlowEdges([]);
    setStyleInfo(null);
    setPublishedUrl(null);
    setStyleDirective(getDefaultStyleName());
    setStyleReferenceImage(null);
    setFlows([]);
    setSelectedFlowId(null);
    setSidebarView("detail");
    setRefinements("");
    setMobilePanel("input");
    
    // Clear localStorage
    localStorage.removeItem("replay_sidebar_mode");
    localStorage.removeItem("replay_generated_code");
    localStorage.removeItem("replay_generation_title");
    
    // Clear URL project parameter - go back to clean /tool
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.delete('project');
    window.history.replaceState({}, '', newUrl.toString());
    
    console.log("[New Project] Reset to clean state");
  }, [getDefaultStyleName]);
  
  // Handle tab visibility change - show pending result, detect stuck generation, OR recover job
  useEffect(() => {
    const handleVisibilityChange = async () => {
      if (!document.hidden) {
        // Tab became visible
        
        // Check if we have pending code to show
        if (pendingCodeRef.current && !streamingCompleteRef.current) {
          console.log("Tab visible - showing pending generation result");
          completeGeneration(pendingCodeRef.current);
          return;
        }
        
        // Check if generation is stuck (running too long)
        if (generationStartTimeRef.current && isProcessing) {
          const elapsedTime = Date.now() - generationStartTimeRef.current;
          console.log("Tab visible - checking generation status, elapsed:", elapsedTime / 1000, "s");
          
          if (elapsedTime > MAX_GENERATION_TIME_MS) {
            console.log("Generation stuck - elapsed time exceeds max");
            resetStuckGeneration();
          }
        }
      }
    };
    
    document.addEventListener("visibilitychange", handleVisibilityChange);
    window.addEventListener("focus", handleVisibilityChange);
    
    return () => {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
      window.removeEventListener("focus", handleVisibilityChange);
    };
  }, [completeGeneration, resetStuckGeneration, isProcessing, generatedCode, showToast]);
  
  // Auto-timeout for stuck generations (runs every 30s)
  useEffect(() => {
    if (!isProcessing || !generationStartTimeRef.current) return;
    
    const checkInterval = setInterval(() => {
      if (generationStartTimeRef.current) {
        const elapsed = Date.now() - generationStartTimeRef.current;
        if (elapsed > MAX_GENERATION_TIME_MS) {
          console.log("Generation timeout - auto-resetting");
          resetStuckGeneration();
        }
      }
    }, 30000); // Check every 30 seconds
    
    return () => clearInterval(checkInterval);
  }, [isProcessing, resetStuckGeneration]);

  // Load demo from API if ?demo= parameter is present (instant load, no AI cost!)
  useEffect(() => {
    const demoId = searchParams.get('demo');
    if (demoId && !hasLoadedFromStorage) {
      console.log("Loading demo from API:", demoId);
      
      // Fetch demo data from API
      fetch(`/api/demo/${demoId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.generation) {
            const gen = data.generation;
            console.log("Demo loaded successfully:", gen.title);
            
            setIsDemoMode(true);
            setGeneratedCode(gen.code);
            setDisplayedCode(gen.code);
            setEditableCode(gen.code);
            setGenerationTitle(gen.title);
            setGenerationComplete(true);
            setSidebarMode("chat");
            
            // Load flow data
            if (gen.flowNodes?.length > 0) {
              setFlowNodes(gen.flowNodes);
            }
            if (gen.flowEdges?.length > 0) {
              setFlowEdges(gen.flowEdges);
            }
            
            // Load design system / style info
            if (gen.styleInfo) {
              setStyleInfo(gen.styleInfo);
            }
            
            // Load style directive
            if (gen.styleDirective) {
              setStyleDirective(gen.styleDirective);
            }
            
            // Load video input to show in sidebar and Input tab
            if (gen.videoUrl) {
              const demoFlowId = `demo_${demoId}`;
              // Create a demo flow item to show video was used
              setFlows([{
                id: demoFlowId,
                name: gen.title || "Demo Video",
                videoBlob: new Blob(), // Empty blob for demo
                videoUrl: gen.videoUrl,
                thumbnail: undefined,
                duration: 30, // Approximate
                trimStart: 0,
                trimEnd: 30,
              }]);
              setSelectedFlowId(demoFlowId);
              
              // Generate thumbnail from video URL
              regenerateThumbnail(demoFlowId, gen.videoUrl);
            }
            
            // Set activeGeneration so edits can be saved (for authenticated owners)
            const demoGeneration: GenerationRecord = {
              id: gen.id,
              title: gen.title,
              autoTitle: false,
              timestamp: gen.timestamp || Date.now(),
              status: "complete",
              code: gen.code,
              styleDirective: gen.styleDirective || "",
              refinements: gen.refinements || "",
              flowNodes: gen.flowNodes || [],
              flowEdges: gen.flowEdges || [],
              styleInfo: gen.styleInfo,
              videoUrl: gen.videoUrl,
              versions: gen.versions || [],
              publishedSlug: gen.publishedSlug,
            };
            setActiveGeneration(demoGeneration);
            setGenerations([demoGeneration]);
            
            // Add welcome message in chat explaining this is a real demo
            setChatMessages([{
              id: `demo_welcome_${Date.now()}`,
              role: "assistant",
              content: `🎬 **This is a real Replay generation!**

This UI was reconstructed entirely from a screen recording using Replay's AI.

**What you're seeing:**
• Pixel-perfect layout extracted from video
• All text content via OCR
• Interactive components with Alpine.js
• Responsive design with Tailwind CSS
• Flow map showing detected navigation

**Try it yourself:**
1. Click tabs above to explore Code, Flow, Design System
2. Sign up free to upload your own video
3. Get 1 free generation - no credit card required!

*Ready to reconstruct your own interfaces?*`,
              timestamp: Date.now()
            }]);
            
            // Create blob URL for preview
            setPreviewUrl(createPreviewUrl(gen.code));
            
            // On mobile, show preview tab immediately
            setMobilePanel("preview");
            
            // Show toast - better formatted
            showToast("Demo loaded!\nSign up free to generate your own projects.", "info");
            
            setHasLoadedFromStorage(true);
          } else {
            console.error("Failed to load demo:", data.error);
            showToast("Demo not available yet. Try generating your own!", "error");
          }
        })
        .catch(err => {
          console.error("Error loading demo:", err);
          showToast("Failed to load demo.", "error");
        });
    }
  }, [searchParams, hasLoadedFromStorage, showToast, regenerateThumbnail]);

  // Handle ?projects=true URL param - set history mode and clean up URL
  useEffect(() => {
    const openProjects = searchParams.get('projects');
    if (openProjects === 'true') {
      // Ensure history mode is open
      if (!showHistoryMode) {
        setShowHistoryMode(true);
      }
      // Clean up URL after state is set
      const timer = setTimeout(() => {
        window.history.replaceState({}, '', window.location.pathname);
      }, 200);
      return () => clearTimeout(timer);
    }
  }, [searchParams, showHistoryMode]);

  // AUTO-UPDATE URL when project changes - enables shareable links for multiplayer
  useEffect(() => {
    if (!activeGeneration?.id) return;
    
    // Don't update if URL already has this project
    const currentProjectId = searchParams.get('project');
    if (currentProjectId === activeGeneration.id) return;
    
    // Don't update URL in demo mode
    if (isDemoMode) return;
    
    // Update URL with project ID (without page reload)
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set('project', activeGeneration.id);
    window.history.replaceState({}, '', newUrl.toString());
    
    console.log("[Project URL] Updated to:", activeGeneration.id);
  }, [activeGeneration?.id, searchParams, isDemoMode]);

  // Handle ?project=xxx URL param - load specific project for multiplayer collaboration
  const [hasLoadedFromUrl, setHasLoadedFromUrl] = useState(false);
  useEffect(() => {
    const projectIdParam = searchParams.get('project');
    // Skip if no project param, already loaded this project from URL, or code already exists for this project
    if (!projectIdParam || hasLoadedFromUrl) return;
    if (activeGeneration?.id === projectIdParam && generatedCode) return; // Already have this project with code
    
    const projectId = projectIdParam;
    
    console.log("[Project URL] Loading project from URL:", projectId, "| hasLoadedFromUrl:", hasLoadedFromUrl);
    
    async function loadProjectFromUrl() {
      try {
        // First check localStorage (set by /project/[id] redirect)
        const cachedProject = localStorage.getItem(`replay_project_${projectId}`);
        if (cachedProject) {
          const cached = JSON.parse(cachedProject);
          // Only use cache if it's fresh (< 5 minutes old)
          if (Date.now() - cached.loadedAt < 5 * 60 * 1000) {
            console.log("[Project URL] Using cached project data");
            localStorage.removeItem(`replay_project_${projectId}`);
          }
        }
        
        // Always fetch fresh data from Supabase
        const supabase = createSupabaseClient();
        const { data: gen, error } = await supabase
          .from("generations")
          .select("*")
          .eq("id", projectId)
          .single();
        
        if (error || !gen) {
          console.log("[Project URL] Project not found in Supabase, error:", error?.message);
          
          // Check if we have this project in localStorage (unsaved local project)
          const localKey = `replay_local_project_${projectId}`;
          const localProject = localStorage.getItem(localKey);
          
          if (localProject) {
            try {
              const parsed = JSON.parse(localProject);
              console.log("[Project URL] Found local project, restoring...");
              
              if (parsed.code && parsed.code.length > 0) {
                setGeneratedCode(parsed.code);
                setDisplayedCode(parsed.code);
                setEditableCode(parsed.code);
                setGenerationComplete(true);
                setSidebarMode("chat");
                if (previewUrl) URL.revokeObjectURL(previewUrl);
                setPreviewUrl(createPreviewUrl(parsed.code));
              }
              
              if (parsed.title) setGenerationTitle(parsed.title);
              if (parsed.flowNodes) setFlowNodes(parsed.flowNodes);
              if (parsed.flowEdges) setFlowEdges(parsed.flowEdges);
              if (parsed.libraryData) setLibraryData(parsed.libraryData);
              
              setActiveGeneration({
                id: projectId,
                title: parsed.title || "Untitled Project",
                autoTitle: !parsed.title,
                timestamp: parsed.timestamp || Date.now(),
                status: "complete",
                code: parsed.code || "",
                styleDirective: parsed.styleDirective || "",
                refinements: parsed.refinements || "",
                flowNodes: parsed.flowNodes || [],
                flowEdges: parsed.flowEdges || [],
                versions: parsed.versions || [],
                styleInfo: parsed.styleInfo || null,
                libraryData: parsed.libraryData || null,
              });
              
              showToast("Project restored from local storage", "info");
              setHasLoadedFromUrl(true);
              return;
            } catch (e) {
              console.error("[Project URL] Failed to parse local project:", e);
            }
          }
          
          // No local data either - show message and create empty session
          console.log("[Project URL] No local data found, creating new session");
          showToast("Project not found. It may not have been saved yet.", "error");
          
          // Project doesn't exist - this is a new collaboration session
          // Just set the project ID for Liveblocks room
          setActiveGeneration({
            id: projectId,
            title: "Untitled Project",
            autoTitle: true,
            timestamp: Date.now(),
            status: "complete",
            code: "",
            styleDirective: "",
            refinements: "",
            flowNodes: [],
            flowEdges: [],
            versions: [],
            styleInfo: null,
          });
          return;
        }
        
        console.log("[Project URL] Loaded from Supabase:", gen.title, "| code length:", gen.output_code?.length || 0);
        
        // Load the project data - column is output_code in Supabase
        if (gen.output_code && gen.output_code.length > 0) {
          setGeneratedCode(gen.output_code);
          setDisplayedCode(gen.output_code);
          setEditableCode(gen.output_code);
          setGenerationComplete(true);
          setSidebarMode("chat");
          
          // CRITICAL: Create preview URL so iframe displays the code
          if (previewUrl) URL.revokeObjectURL(previewUrl);
          setPreviewUrl(createPreviewUrl(gen.output_code));
          console.log("[Project URL] Preview URL created");
          
          // CRITICAL: Switch to preview mode so user sees the UI
          setViewMode("preview");
          console.log("[Project URL] Project fully loaded and displayed");
        }
        
        const loadedTitle = gen.title || "Untitled Project";
        setGenerationTitle(loadedTitle);
        // Also save to localStorage so title persists on refresh
        try {
          localStorage.setItem("replay_generation_title", loadedTitle);
        } catch (e) {}
        
        // Load flow data - stored as output_architecture.flowNodes/flowEdges in Supabase
        if (gen.output_architecture?.flowNodes?.length > 0) {
          setFlowNodes(gen.output_architecture.flowNodes);
        }
        if (gen.output_architecture?.flowEdges?.length > 0) {
          setFlowEdges(gen.output_architecture.flowEdges);
        }
        
        // Load style info - stored as output_design_system in Supabase
        if (gen.output_design_system) {
          setStyleInfo(gen.output_design_system);
        }
        // input_style in Supabase
        if (gen.input_style) {
          setStyleDirective(gen.input_style);
        }
        // input_context in Supabase
        if (gen.input_context) {
          setRefinements(gen.input_context);
        }
        
        // Load files if componentized
        if (gen.files) {
          try {
            const files = typeof gen.files === 'string' ? JSON.parse(gen.files) : gen.files;
            setGeneratedFiles(files);
          } catch (e) {
            console.error("[Project URL] Error parsing files:", e);
          }
        }
        
        // Load library data (component library)
        if (gen.library_data) {
          console.log("[Project URL] Loading library data");
          setLibraryData(gen.library_data);
        }
        
        // Set active generation for editing and Liveblocks room
        // IMPORTANT: Use correct Supabase column names (output_code, input_style, input_context, etc.)
        const loadedGeneration: GenerationRecord = {
          id: gen.id,
          title: gen.title || "Untitled Project",
          autoTitle: gen.auto_title ?? true,
          timestamp: gen.created_at ? new Date(gen.created_at).getTime() : Date.now(),
          status: "complete",
          code: gen.output_code || "", // Supabase column is output_code
          styleDirective: gen.input_style || "", // Supabase column is input_style
          refinements: gen.input_context || "", // Supabase column is input_context
          flowNodes: gen.output_architecture?.flowNodes || [],
          flowEdges: gen.output_architecture?.flowEdges || [],
          styleInfo: gen.output_design_system,
          videoUrl: gen.input_video_url,
          versions: gen.versions || [],
          publishedSlug: gen.published_slug,
          chatMessages: gen.chat_messages,
          libraryData: gen.library_data,
        };
        setActiveGeneration(loadedGeneration);
        
        // CRITICAL: Restore published URL if project was published
        if (gen.published_slug) {
          setPublishedUrl(`https://www.replay.build/p/${gen.published_slug}`);
          console.log("[Project URL] Restored published URL:", gen.published_slug);
        }
        
        // Load chat messages if any
        if (gen.chat_messages?.length > 0) {
          setChatMessages(gen.chat_messages);
        }
        
        // IMPORTANT: Load video into flows if present
        if (gen.input_video_url && gen.input_video_url.length > 0) {
          console.log("[Project URL] Loading video into flows:", gen.input_video_url);
          const flowId = generateId();
          
          // Create flow with placeholder duration first
          const videoFlow: FlowItem = {
            id: flowId,
            name: gen.title || "Project Video",
            videoBlob: new Blob(), // Empty blob as placeholder
            videoUrl: gen.input_video_url,
            duration: 30, // Default duration, will be updated
            thumbnail: gen.input_thumbnail_url || "",
            trimStart: 0,
            trimEnd: 30,
          };
          setFlows([videoFlow]);
          setSelectedFlowId(flowId);
          
          // Load actual duration AND thumbnail from video metadata (handles WebM with Infinity duration)
          const tempVideo = document.createElement('video');
          tempVideo.preload = 'metadata';
          tempVideo.crossOrigin = 'anonymous';
          tempVideo.muted = true;
          let durationFixed = false;
          
          const updateFlowDuration = () => {
            if (durationFixed) return;
            const d = tempVideo.duration;
            if (d && isFinite(d) && d > 0) {
              durationFixed = true;
              const realDuration = Math.round(d);
              let thumbnailUrl = gen.input_thumbnail_url || "";
              try {
                const canvas = document.createElement("canvas");
                const vw = tempVideo.videoWidth || 640;
                const vh = tempVideo.videoHeight || 360;
                canvas.width = 320;
                canvas.height = Math.round((320 / vw) * vh) || 180;
                const ctx = canvas.getContext("2d");
                if (ctx && vw > 0 && vh > 0) {
                  ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                  thumbnailUrl = canvas.toDataURL("image/jpeg", 0.8);
                }
              } catch (e) {
                console.error("[Project URL] Thumbnail generation error:", e);
              }
              console.log("[Project URL] Duration fixed:", realDuration, "s");
              setFlows(prev => prev.map(f => 
                f.id === flowId 
                  ? { ...f, duration: realDuration, trimEnd: realDuration, thumbnail: thumbnailUrl || f.thumbnail }
                  : f
              ));
            }
          };
          
          tempVideo.onloadedmetadata = () => {
            // WebM fix: if duration is Infinity, seek far to force calculation
            if (!isFinite(tempVideo.duration) || tempVideo.duration <= 0) {
              console.log("[Project URL] WebM detected, seeking to get duration...");
              tempVideo.currentTime = 1e10;
            } else {
              tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.25);
              updateFlowDuration();
            }
          };
          
          tempVideo.onseeked = () => {
            updateFlowDuration();
            // After getting duration, seek to thumbnail frame
            if (!durationFixed && isFinite(tempVideo.duration) && tempVideo.duration > 0) {
              tempVideo.currentTime = Math.min(1, tempVideo.duration * 0.25);
            }
          };
          
          tempVideo.ondurationchange = () => updateFlowDuration();
          tempVideo.onerror = () => console.log("[Project URL] Could not load video");
          tempVideo.src = gen.input_video_url;
          
          // Fallback: if after 5s we still don't have duration, keep placeholder (30s) - some WebM never report duration
          setTimeout(() => {
            if (!durationFixed) {
              console.log("[Project URL] Duration fallback - keeping placeholder 30s");
            }
          }, 5000);
        }
        
        // For showcase demo project, add welcome message explaining what this is
        if (projectId === "flow_1769991250167_jr2x4utrt" || projectId === "flow_1769444036799_r8hrcxyx2") {
          const showcaseWelcome = {
            id: "showcase-welcome",
            role: "assistant" as const,
            content: `Welcome to the Replay Demo!

This is a fully functional showcase demonstrating Replay's capabilities.

What you're seeing:
This Enterprise Claims Manager was automatically generated from a screen recording. Replay analyzed the video and produced complete production-ready output.

What was generated:
• Complete UI Code (React + Tailwind)
• Flow Map with navigation structure
• Component Library inventory  
• Design System tokens (colors, typography, spacing)

Explore the tabs above:
• Preview - Live rendered UI with working navigation
• Code - Generated source code
• Flow - Screen navigation map
• Design - Extracted design tokens
• Library - Component library

Ready to generate from your own videos? Upgrade to Pro to start creating your own projects!`,
            timestamp: Date.now()
          };
          setChatMessages([showcaseWelcome]);
        }
        
        // Clear the localStorage redirect flag
        localStorage.removeItem("replay_load_project");
        
        // Mark as loaded from URL to prevent re-loading
        setHasLoadedFromUrl(true);
        
        console.log("[Project URL] Project fully loaded and displayed");
        
      } catch (err) {
        console.error("[Project URL] Error loading project:", err);
        showToast("Failed to load project", "error");
        setHasLoadedFromUrl(true); // Prevent infinite retry
      }
    }
    
    loadProjectFromUrl();
  }, [searchParams, hasLoadedFromUrl, activeGeneration?.id, generatedCode, showToast]);

  // FALLBACK: If we have code but no preview URL, create it (with delay to avoid race conditions)
  // This fixes black screen after refresh
  useEffect(() => {
    if (generatedCode && generatedCode.length > 50 && !previewUrl && !isStreamingCode) {
      // Wait 200ms to let other processes (like restoreVersion setTimeout) complete first
      const timer = setTimeout(() => {
        // Double-check preview still doesn't exist
        if (!previewUrl) {
          console.log('[Preview Fallback] Code exists but no preview after delay, creating...');
          const newUrl = createPreviewUrl(generatedCode);
          setPreviewUrl(newUrl);
          if (viewMode === "input") {
            setViewMode("preview");
          }
        }
      }, 200);
      return () => clearTimeout(timer);
    }
  }, [generatedCode, previewUrl, isStreamingCode, createPreviewUrl, viewMode]);

  // When new code arrives, either stream it or mark as pending
  useEffect(() => {
    if (!generatedCode || !isStreamingCode) return;
    
    // Reset completion flag for new generation
    streamingCompleteRef.current = false;
    
    // If tab is hidden, store as pending and complete immediately (state-wise)
    if (document.hidden) {
      console.log("Tab hidden - storing code as pending, will show when visible");
      pendingCodeRef.current = generatedCode;
      // Don't animate, just mark internally as ready
      // The visibility handler will show it when user returns
      return;
    }
    
    // Tab is visible - animate the streaming
    let index = 0;
    const chunkSize = 20;
    let lastTime = Date.now();
    
    const interval = setInterval(() => {
      if (streamingCompleteRef.current) {
        clearInterval(interval);
        return;
      }
      
      const now = Date.now();
      
      // If tab became hidden, store as pending and stop
      if (document.hidden) {
        console.log("Tab became hidden - storing pending code");
        pendingCodeRef.current = generatedCode;
        clearInterval(interval);
        return;
      }
      
      // Fast-forward if there was a gap
      const elapsed = now - lastTime;
      if (elapsed > 200) {
        completeGeneration(generatedCode);
        clearInterval(interval);
        return;
      }
      lastTime = now;
      
      if (index < generatedCode.length) {
        setDisplayedCode(generatedCode.slice(0, index + chunkSize));
        setEditableCode(generatedCode.slice(0, index + chunkSize));
        index += chunkSize;
        if (codeContainerRef.current) codeContainerRef.current.scrollTop = codeContainerRef.current.scrollHeight;
      } else {
        completeGeneration(generatedCode);
        clearInterval(interval);
      }
    }, 8);
    
    return () => clearInterval(interval);
  }, [generatedCode, isStreamingCode, completeGeneration]);
  
  // SAFEGUARD: Ensure code is visible when generation is complete
  // This fixes cases where streaming failed or sidebar wasn't set
  useEffect(() => {
    if (generatedCode && !isStreamingCode && !isProcessing) {
      // Ensure displayedCode is set
      if (!displayedCode && generatedCode) {
        console.log("[Safeguard] displayedCode was empty but generatedCode exists - fixing");
        setDisplayedCode(generatedCode);
        setEditableCode(generatedCode);
      }
      // Ensure sidebar is in chat mode when we have code
      if (sidebarMode !== "chat" && generatedCode) {
        console.log("[Safeguard] sidebarMode was not chat but code exists - fixing");
        setSidebarMode("chat");
        setGenerationComplete(true);
      }
    }
  }, [generatedCode, displayedCode, isStreamingCode, isProcessing, sidebarMode]);
  
  // Show feedback modal after generation (separate effect)
  // Feedback modal effect removed
  /*
  useEffect(() => {
    if (generationComplete && !hasShownFeedback) {
      const timer = setTimeout(() => {
        setShowFeedbackModal(true);
        setHasShownFeedback(true);
        localStorage.setItem("replay_feedback_shown", "true");
      }, 10000);
      return () => clearTimeout(timer);
    }
  }, [generationComplete, hasShownFeedback]);
  */

  useEffect(() => {
    return () => {
      if (streamRef.current) streamRef.current.getTracks().forEach(track => track.stop());
      if (timerRef.current) clearInterval(timerRef.current);
    };
  }, []);

  // Load on mount - Supabase is primary, localStorage is quick cache
  useEffect(() => {
    const loadData = async () => {
      try {
        const savedFeedbackShown = localStorage.getItem("replay_feedback_shown");
        if (savedFeedbackShown === "true") {
          setHasShownFeedback(true);
        }
        
        // Quick cache: load minimal index from localStorage for instant History display
        // NOTE: Cache is user-specific, loaded after we know user ID (see separate useEffect)
        
        // Load saved code from localStorage ONLY if it's a recent refresh (< 2 min)
        // This prevents old projects from loading when user visits /tool fresh
        const savedCode = localStorage.getItem("replay_generated_code");
        const lastEditTime = localStorage.getItem("replay_last_edit_time");
        const projectParam = new URLSearchParams(window.location.search).get('project');
        
        // Only restore if:
        // 1. There's saved code
        // 2. Last edit was within 2 minutes (likely a page refresh, not new visit)
        // 3. No project param in URL (project param = explicit project load)
        const isRecentRefresh = lastEditTime && (Date.now() - parseInt(lastEditTime)) < 2 * 60 * 1000;
        
        if (savedCode && savedCode.length > 100 && isRecentRefresh && !projectParam) {
          console.log("[Load] Restoring code from localStorage (recent refresh):", savedCode.length, "chars");
          setGeneratedCode(savedCode);
          setDisplayedCode(savedCode);
          setEditableCode(savedCode);
          setGenerationComplete(true);
          setSidebarMode("chat");
        } else if (savedCode && !isRecentRefresh) {
          // Clear stale localStorage if it's an old session
          console.log("[Load] Clearing stale localStorage (last edit:", lastEditTime ? `${Math.round((Date.now() - parseInt(lastEditTime)) / 1000)}s ago` : "unknown", ")");
          localStorage.removeItem("replay_generated_code");
          localStorage.removeItem("replay_last_edit_time");
        }
        
        setHasLoadedFromStorage(true);
      } catch (e) {
        console.error("Error loading initial data:", e);
        setHasLoadedFromStorage(true);
      }
    };
    
    loadData();
  }, []);

  // Save flows to localStorage (but not blob URLs - they don't persist)
  useEffect(() => {
    if (!hasLoadedFromStorage) return; // Don't save until we've loaded
    
    try {
      // Don't save blob URLs as they won't work after reload
      const flowsToSave = flows.map(f => ({
        ...f,
        // Keep data URLs (base64 thumbnails), but clear blob URLs
        videoUrl: f.videoUrl?.startsWith("blob:") ? "" : f.videoUrl,
        // Keep data: URLs for thumbnails (base64), only clear blob: URLs
        thumbnail: f.thumbnail?.startsWith("data:") ? f.thumbnail : (f.thumbnail?.startsWith("blob:") ? "" : f.thumbnail),
        // Don't save the videoBlob - it's not serializable
        videoBlob: undefined,
      })).filter(f => f.videoUrl); // Only save flows with valid URLs
      
      if (flowsToSave.length > 0) {
        console.log("Saving flows to localStorage:", flowsToSave.map(f => ({ 
          id: f.id, 
          name: f.name,
          hasVideoUrl: !!f.videoUrl, 
          hasThumbnail: !!f.thumbnail,
          thumbnailLength: f.thumbnail?.length || 0
        })));
      }
      
      localStorage.setItem("replay_flows", JSON.stringify(flowsToSave));
    } catch (e) {
      console.error("Error saving flows:", e);
    }
  }, [flows, hasLoadedFromStorage]);

  // Save generated code to localStorage with timestamp
  useEffect(() => {
    if (!hasLoadedFromStorage || !generatedCode) return;
    try {
      localStorage.setItem("replay_generated_code", generatedCode);
      localStorage.setItem("replay_last_edit_time", Date.now().toString());
    } catch (e) {
      console.error("Error saving code:", e);
    }
  }, [generatedCode, hasLoadedFromStorage]);

  // Restore previewUrl when code is loaded but previewUrl is missing (after refresh)
  useEffect(() => {
    if (editableCode && editableCode.length > 100 && !previewUrl) {
      console.log("[Preview] Restoring preview URL from loaded code");
      setPreviewUrl(createPreviewUrl(editableCode));
    }
  }, [editableCode, previewUrl, createPreviewUrl]);

  // Save style to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage) return;
    try {
      localStorage.setItem("replay_style", styleDirective);
      localStorage.setItem("replay_refinements", refinements);
    } catch (e) {
      console.error("Error saving style:", e);
    }
  }, [styleDirective, refinements, hasLoadedFromStorage]);
  
  // Save chat state to activeGeneration (per-project chat)
  // Using useRef to track the last saved state and debounce saves
  const lastSavedChatRef = useRef<string>("");
  const lastProjectIdRef = useRef<string | null>(null);
  const chatSaveTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  
  // Reset chat ref when switching projects
  useEffect(() => {
    if (activeGeneration?.id !== lastProjectIdRef.current) {
      lastSavedChatRef.current = "";
      lastProjectIdRef.current = activeGeneration?.id || null;
    }
  }, [activeGeneration?.id]);
  
  // Debounced chat save - only save after 500ms of no changes
  useEffect(() => {
    if (!hasLoadedFromStorage || !activeGeneration) return;
    
    const currentChatHash = JSON.stringify(chatMessages.map(m => m.id));
    if (currentChatHash === lastSavedChatRef.current) return;
    
    // Clear previous timeout
    if (chatSaveTimeoutRef.current) {
      clearTimeout(chatSaveTimeoutRef.current);
    }
    
    // Debounce save by 500ms
    chatSaveTimeoutRef.current = setTimeout(() => {
      const updatedGen = { ...activeGeneration, chatMessages };
      setGenerations(prev => prev.map(g => 
        g.id === activeGeneration.id ? updatedGen : g
      ));
      lastSavedChatRef.current = currentChatHash;
      localStorage.setItem("replay_sidebar_mode", sidebarMode);
      
      // CRITICAL: Also save to Supabase so chat history persists
      if (user) {
        saveGenerationToSupabase(updatedGen);
      }
    }, 500);
    
    return () => {
      if (chatSaveTimeoutRef.current) {
        clearTimeout(chatSaveTimeoutRef.current);
      }
    };
  }, [chatMessages, sidebarMode, hasLoadedFromStorage, activeGeneration?.id]);
  
  // Validate Supabase credentials format
  const isValidSupabaseUrl = (url: string): boolean => {
    if (!url || url.trim().length === 0) return false;
    // Must be https://*.supabase.co format
    const pattern = /^https:\/\/[a-zA-Z0-9-]+\.supabase\.co\/?$/;
    return pattern.test(url.trim());
  };
  
  const isValidSupabaseKey = (key: string): boolean => {
    if (!key || key.trim().length === 0) return false;
    // JWT tokens start with eyJ (base64 encoded {"alg":...)
    return key.trim().startsWith('eyJ') && key.trim().length > 100;
  };

  // Clean up invalid/legacy Supabase data on mount
  useEffect(() => {
    if (typeof window === "undefined") return;
    
    // Remove global fallback keys (legacy) - we only use project-specific now
    localStorage.removeItem("replay_supabase_url");
    localStorage.removeItem("replay_supabase_key");
    
    console.log("[Supabase Cleanup] Removed legacy global keys");
  }, []);

  // Check Supabase connection status - validates format strictly
  // Only check once on project change, not continuously
  useEffect(() => {
    if (typeof window === "undefined" || !activeGeneration?.id) {
      setIsSupabaseConnected(false);
      return;
    }
    
    const projectId = activeGeneration.id;
    let connected = false;
    
    try {
      const stored = localStorage.getItem(`replay_secrets_${projectId}`);
      
      if (stored) {
        const secrets = JSON.parse(stored);
        const url = secrets.supabaseUrl || '';
        const key = secrets.supabaseAnonKey || '';
        
        // Strict validation
        const urlValid = url && /^https:\/\/[a-zA-Z0-9-]+\.supabase\.co\/?$/.test(url.trim());
        const keyValid = key && key.trim().length >= 100 && key.trim().startsWith('eyJ');
        
        connected = urlValid && keyValid;
      }
    } catch (e) {
      // Silent fail - no connection
    }
    
    setIsSupabaseConnected(connected);
  }, [activeGeneration?.id]);
  
  // Save flow nodes and edges to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage || flowNodes.length === 0) return;
    try {
      localStorage.setItem("replay_flow_nodes", JSON.stringify(flowNodes));
      localStorage.setItem("replay_flow_edges", JSON.stringify(flowEdges));
    } catch (e) {
      console.error("Error saving flow:", e);
    }
  }, [flowNodes, flowEdges, hasLoadedFromStorage]);
  
  // Save style info to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage || !styleInfo) return;
    try {
      localStorage.setItem("replay_style_info", JSON.stringify(styleInfo));
    } catch (e) {
      console.error("Error saving style info:", e);
    }
  }, [styleInfo, hasLoadedFromStorage]);
  
  // Save blueprint positions to localStorage (per-project)
  useEffect(() => {
    if (!hasLoadedFromStorage || !activeGeneration?.id) return;
    if (Object.keys(blueprintPositions).length === 0) return;
    try {
      const key = `replay_blueprint_positions_${activeGeneration.id}`;
      localStorage.setItem(key, JSON.stringify(blueprintPositions));
    } catch (e) {
      console.error("Error saving blueprint positions:", e);
    }
  }, [blueprintPositions, hasLoadedFromStorage, activeGeneration?.id]);
  
  // Save blueprint sizes to localStorage (per-project)
  useEffect(() => {
    if (!hasLoadedFromStorage || !activeGeneration?.id) return;
    if (Object.keys(blueprintSizes).length === 0) return;
    try {
      const key = `replay_blueprint_sizes_${activeGeneration.id}`;
      localStorage.setItem(key, JSON.stringify(blueprintSizes));
    } catch (e) {
      console.error("Error saving blueprint sizes:", e);
    }
  }, [blueprintSizes, hasLoadedFromStorage, activeGeneration?.id]);
  
  // Load blueprint positions and sizes when project changes
  useEffect(() => {
    if (!activeGeneration?.id) return;
    try {
      const posKey = `replay_blueprint_positions_${activeGeneration.id}`;
      const sizeKey = `replay_blueprint_sizes_${activeGeneration.id}`;
      
      const savedPositions = localStorage.getItem(posKey);
      const savedSizes = localStorage.getItem(sizeKey);
      
      if (savedPositions) {
        const parsed = JSON.parse(savedPositions);
        if (Object.keys(parsed).length > 0) {
          console.log("[Blueprint] Loaded positions for project:", activeGeneration.id);
          setBlueprintPositions(parsed);
        }
      }
      
      if (savedSizes) {
        const parsed = JSON.parse(savedSizes);
        if (Object.keys(parsed).length > 0) {
          console.log("[Blueprint] Loaded sizes for project:", activeGeneration.id);
          setBlueprintSizes(parsed);
        }
      }
    } catch (e) {
      console.error("Error loading blueprint layout:", e);
    }
  }, [activeGeneration?.id]);
  
  // Save generation history - PRIMARY: Supabase, SECONDARY: minimal localStorage cache
  const lastSavedGenerationsRef = useRef<string>("");
  const generationsSaveTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const isLoadingProjectRef = useRef(false); // Flag to prevent saves during project load
  
  useEffect(() => {
    if (!hasLoadedFromStorage || generations.length === 0) return;
    
    // Skip save if we're just loading a project (not editing)
    if (isLoadingProjectRef.current) {
      isLoadingProjectRef.current = false;
      return;
    }
    
    // Create a simple hash to detect real changes (includes title for rename detection!)
    const currentHash = generations.map(g => `${g.id}:${g.title}:${g.chatMessages?.length || 0}:${g.versions?.length || 0}`).join('|');
    if (currentHash === lastSavedGenerationsRef.current) return;
    
    // Clear previous timeout
    if (generationsSaveTimeoutRef.current) {
      clearTimeout(generationsSaveTimeoutRef.current);
    }
    
    // Debounce save by 2 seconds
    generationsSaveTimeoutRef.current = setTimeout(async () => {
      lastSavedGenerationsRef.current = currentHash;
      
      // PRIMARY: Save to Supabase (if logged in) - full data, no limits
      if (user) {
        for (const gen of generations) {
          if (gen.status === "complete" && gen.code) {
            try {
              await fetch("/api/generations", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  id: gen.id,
                  title: gen.title,
                  code: gen.code, // Full code - no limit
                  timestamp: gen.timestamp,
                  publishedSlug: gen.publishedSlug,
                  chatMessages: gen.chatMessages, // Full chat history
                  versions: gen.versions, // All versions
                  status: gen.status,
                  videoUrl: gen.videoUrl,
                  thumbnailUrl: gen.thumbnailUrl,
                }),
              });
            } catch (e) {
              console.error("Error saving to Supabase:", e);
            }
          }
        }
      }
      
      // SECONDARY: Save ONLY index to localStorage (cache for quick History list)
      // Use user-specific key to prevent cross-account data leakage
      if (user?.id) {
        try {
          const historyIndex = generations.slice(-100).map(gen => ({
            id: gen.id,
            title: gen.title,
            timestamp: gen.timestamp,
            status: gen.status,
            thumbnailUrl: gen.thumbnailUrl?.substring(0, 200) || '',
          }));
          const cacheKey = `replay_generation_index_${user.id}`;
          localStorage.setItem(cacheKey, JSON.stringify(historyIndex));
          // Clear old non-user-specific cache
          localStorage.removeItem("replay_generation_index");
        } catch (e) {
          // Ignore localStorage errors - Supabase is primary
          console.log("localStorage cache skipped (quota)");
        }
      }
    }, 2000);
    
    return () => {
      if (generationsSaveTimeoutRef.current) {
        clearTimeout(generationsSaveTimeoutRef.current);
      }
    };
  }, [generations, hasLoadedFromStorage, user]);
  
  // Load user-specific cache from localStorage after user is known
  useEffect(() => {
    if (!user?.id || !hasLoadedFromStorage) return;
    
    try {
      const cacheKey = `replay_generation_index_${user.id}`;
      const cachedIndex = localStorage.getItem(cacheKey);
      if (cachedIndex) {
        const index = JSON.parse(cachedIndex);
        // Only use cache if generations list is empty (before Supabase loads)
        if (generations.length === 0) {
          const sorted = index
            .map((g: any) => ({ ...g, code: '' }))
            .sort((a: any, b: any) => b.timestamp - a.timestamp);
          setGenerations(sorted);
          console.log("[Cache] Loaded", sorted.length, "projects from user-specific cache");
        }
      }
      // Clear old non-user-specific cache (legacy cleanup)
      localStorage.removeItem("replay_generation_index");
    } catch (e) {
      console.log("[Cache] Error loading cache:", e);
    }
  }, [user?.id, hasLoadedFromStorage]); // Note: NOT including generations to avoid loop
  
  // Fetch lock to prevent multiple simultaneous requests
  const isFetchingRef = useRef(false);
  const lastFetchTimeRef = useRef(0);
  
  // Fetch generations from Supabase with pagination and search
  const fetchGenerations = useCallback(async (options: { 
    reset?: boolean; 
    search?: string;
    loadMore?: boolean;
  } = {}) => {
    const { reset = false, search = historySearch, loadMore = false } = options;
    
    if (!user) return;
    
    // Prevent concurrent fetches
    if (isFetchingRef.current && !reset) {
      console.log("[Supabase] Fetch already in progress, skipping");
      return;
    }
    
    isFetchingRef.current = true;
    if (loadMore) {
      setIsLoadingMore(true);
    } else if (reset) {
      setIsLoadingHistory(true);
    }
    
    try {
      const offset = reset ? 0 : historyOffset;
      const searchParam = search ? `&search=${encodeURIComponent(search)}` : '';
      const url = `/api/generations?minimal=true&limit=${HISTORY_PAGE_SIZE}&offset=${offset}${searchParam}`;
      
      const response = await fetch(url);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.generations) {
          // Update total and hasMore
          setHistoryTotal(data.total || 0);
          setHasMoreHistory(offset + data.generations.length < (data.total || 0));
          setHistoryOffset(offset + data.generations.length);
          
          if (reset) {
            // Replace all generations (search or initial load)
            setGenerations(data.generations);
          } else {
            // Append to existing (load more)
            setGenerations(prev => {
              const existingIds = new Set(prev.map(g => g.id));
              const newGens = data.generations.filter((g: GenerationRecord) => !existingIds.has(g.id));
              return [...prev, ...newGens];
            });
          }
          
          console.log(`[Supabase] Loaded ${data.generations.length} generations (offset: ${offset}, total: ${data.total})`);
        }
      }
    } catch (e) {
      console.error("Error fetching from Supabase:", e);
    } finally {
      isFetchingRef.current = false;
      setIsLoadingHistory(false);
      setIsLoadingMore(false);
    }
  }, [user, historyOffset, historySearch, HISTORY_PAGE_SIZE]);
  
  // Load more generations
  const loadMoreGenerations = useCallback(() => {
    if (!isLoadingMore && hasMoreHistory) {
      fetchGenerations({ loadMore: true });
    }
  }, [fetchGenerations, isLoadingMore, hasMoreHistory]);
  
  // Search generations (server-side)
  const searchGenerations = useCallback((searchTerm: string) => {
    setHistorySearch(searchTerm);
    setHistoryOffset(0);
    fetchGenerations({ reset: true, search: searchTerm });
  }, [fetchGenerations]);
  
  // PRIMARY DATA SOURCE: Supabase - load first page when user logs in
  const hasFetchedInitialRef = useRef(false);
  const lastUserIdRef = useRef<string | null>(null);
  
  useEffect(() => {
    if (!user || !hasLoadedFromStorage) {
      // If no user, mark history as loaded (empty)
      if (!user && hasLoadedFromStorage) {
        setIsLoadingHistory(false);
        hasFetchedInitialRef.current = false; // Reset on logout
        lastUserIdRef.current = null;
      }
      return;
    }
    
    // Prevent duplicate fetches - only fetch if user changed or first time
    if (hasFetchedInitialRef.current && lastUserIdRef.current === user.id) {
      return;
    }
    
    hasFetchedInitialRef.current = true;
    lastUserIdRef.current = user.id;
    
    // Initial fetch - only first 10 projects
    fetchGenerations({ reset: true });
    
    // No periodic sync - too expensive. User can refresh manually or load more
  }, [user, hasLoadedFromStorage]); // eslint-disable-line react-hooks/exhaustive-deps
  
  // Auto-load demo for FREE users with no projects (so they see something, not empty screen)
  const hasAutoLoadedDemoRef = useRef(false);
  useEffect(() => {
    // Only auto-load once per session
    if (hasAutoLoadedDemoRef.current) return;
    
    // Wait for loading to complete
    if (isLoadingHistory || !hasLoadedFromStorage) return;
    
    // Only for logged-in users with no projects
    if (!user || generations.length > 0) return;
    
    // Don't auto-load if already in demo mode or has active generation
    if (isDemoMode || activeGeneration) return;
    
    // Don't auto-load if URL has project param (loading specific project)
    if (searchParams.get('project') || searchParams.get('demo')) return;
    
    console.log("[Auto-Demo] Loading showcase demo for new user");
    hasAutoLoadedDemoRef.current = true;
    
    // Load the showcase demo
    fetch(`/api/demo/${SHOWCASE_PROJECT_ID}`)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.generation) {
          const gen = data.generation;
          setIsDemoMode(true);
          setGenerationTitle(gen.title || "Showcase Demo");
          setActiveGeneration(gen);
          setGeneratedCode(gen.code);
          setDisplayedCode(gen.code);
          setEditableCode(gen.code);
          setFlowNodes(gen.flowNodes || []);
          setFlowEdges(gen.flowEdges || []);
          setStyleInfo(gen.styleInfo || null);
          setLibraryData(gen.libraryData || null);
          setChatMessages(gen.chatMessages || []);
          setGenerationComplete(true);
          setViewMode("preview");
          setShowHistoryMode(false);
          showToast("Welcome! Explore this demo project to see what Replay can do.", "info");
        }
      })
      .catch(err => {
        console.error("[Auto-Demo] Failed to load demo:", err);
      });
  }, [user, generations.length, isLoadingHistory, hasLoadedFromStorage, isDemoMode, activeGeneration, searchParams, SHOWCASE_PROJECT_ID, showToast]);
  
  
  // Save active generation to Supabase when complete
  // Track failed saves to prevent spam
  const failedSavesRef = useRef<Set<string>>(new Set());
  
  const saveGenerationToSupabase = useCallback(async (gen: GenerationRecord) => {
    if (!user) {
      console.log("[Save] Skipping - no user logged in");
      return;
    }
    
    // Only skip demo saves if in demo mode (user came via ?demo= URL, not logged in as owner)
    // The owner CAN save changes to demo projects when loaded from their history
    if (isDemoMode && DEMO_PROJECT_IDS.has(gen.id)) {
      console.log("[Save] Skipping demo project in demo mode:", gen.id);
      return;
    }
    
    // Don't retry if already failed for this generation
    if (failedSavesRef.current.has(gen.id)) {
      console.log("[Save] Skipping - previously failed:", gen.id);
      return;
    }
    
    console.log("[Save] Saving to Supabase:", gen.id, "title:", gen.title);
    
    try {
      const response = await fetch("/api/generations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(gen),
      });
      
      const data = await response.json();
      if (!response.ok) {
        console.error("Error saving generation:", data);
        // Mark as failed to prevent retries
        failedSavesRef.current.add(gen.id);
      }
    } catch (e) {
      console.error("Error saving to Supabase:", e);
      failedSavesRef.current.add(gen.id);
    }
  }, [user, isDemoMode, DEMO_PROJECT_IDS]);
  
  // Lazy load full generation data (called when user selects from history)
  const loadFullGeneration = useCallback(async (genId: string): Promise<GenerationRecord | null> => {
    try {
      // Check if this is a demo project - use demo API instead
      const isDemo = DEMO_PROJECT_IDS.has(genId);
      const endpoint = isDemo 
        ? `/api/demo/${genId}` 
        : `/api/generations?id=${genId}`;
      
      console.log(`[History] Loading ${isDemo ? 'demo' : 'user'} generation: ${genId}`);
      
      const response = await fetch(endpoint);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.generation) {
          // Update in generations list
          const fullGen = data.generation as GenerationRecord;
          setGenerations(prev => prev.map(g => g.id === genId ? fullGen : g));
          console.log(`[History] Loaded full data for generation ${genId}`);
          return fullGen;
        }
      } else {
        console.error(`[History] Failed to load generation ${genId}:`, response.status);
      }
    } catch (e) {
      console.error("Error loading full generation:", e);
    }
    return null;
  }, [DEMO_PROJECT_IDS]);
  
  // Save generation title to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage) return;
    try {
      localStorage.setItem("replay_generation_title", generationTitle);
    } catch (e) {
      console.error("Error saving title:", e);
    }
  }, [generationTitle, hasLoadedFromStorage]);
  
  // Save analysis phase to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage || !analysisPhase) return;
    try {
      localStorage.setItem("replay_analysis_phase", JSON.stringify(analysisPhase));
    } catch (e) {
      console.error("Error saving analysis phase:", e);
    }
  }, [analysisPhase, hasLoadedFromStorage]);
  
  // Save analysis description to localStorage
  useEffect(() => {
    if (!hasLoadedFromStorage || !analysisDescription) return;
    try {
      localStorage.setItem("replay_analysis_description", analysisDescription);
    } catch (e) {
      console.error("Error saving analysis description:", e);
    }
  }, [analysisDescription, hasLoadedFromStorage]);
  
  // Update active generation when code/flow changes (for persistence)
  useEffect(() => {
    if (!activeGeneration || !generatedCode || !generationComplete) return;
    
    // Update the active generation with latest state
    const updatedGen: GenerationRecord = {
      ...activeGeneration,
      code: generatedCode,
      flowNodes: flowNodes,
      flowEdges: flowEdges,
      styleInfo: styleInfo,
      styleDirective: styleDirective,
      title: generationTitle || activeGeneration.title,
      status: "complete",
      // Persist component library data
      libraryData: libraryData,
    };
    
    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
    
    // Sync to Supabase
    saveGenerationToSupabase(updatedGen);
  }, [generatedCode, flowNodes, flowEdges, styleInfo, styleDirective, generationTitle, generationComplete, activeGeneration?.id, saveGenerationToSupabase, libraryData]);
  
  // Separate effect for Library data persistence (can update even without code changes)
  useEffect(() => {
    if (!activeGeneration || !libraryData) return;
    
    // Only save if library data actually changed
    const currentLibrary = JSON.stringify(libraryData);
    const savedLibrary = JSON.stringify(activeGeneration.libraryData);
    if (currentLibrary === savedLibrary) return;
    
    console.log("[Library] Saving library data to project:", activeGeneration.id);
    
    const updatedGen: GenerationRecord = {
      ...activeGeneration,
      libraryData: libraryData,
    };
    
    setActiveGeneration(updatedGen);
    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
    saveGenerationToSupabase(updatedGen);
  }, [libraryData, activeGeneration?.id]);

  // Video time update
  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;
    const handleTimeUpdate = () => setCurrentTime(video.currentTime);
    video.addEventListener("timeupdate", handleTimeUpdate);
    return () => video.removeEventListener("timeupdate", handleTimeUpdate);
  }, [selectedFlowId]);

  // Close history menu when clicking outside
  useEffect(() => {
    if (!historyMenuOpen) return;
    const handleClick = () => setHistoryMenuOpen(null);
    document.addEventListener("click", handleClick);
    return () => document.removeEventListener("click", handleClick);
  }, [historyMenuOpen]);

  // Point-and-edit: listen for messages from iframe
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      if (event.data?.type === 'element-selected') {
        const { tagName, id, className, textContent, isSvg, svgType } = event.data;
        // Build a descriptive element reference (not CSS selector format)
        let elementDesc = '';
        const tag = tagName?.toLowerCase() || 'element';
        
        // Handle SVG elements specially
        if (isSvg) {
          if (tag === 'svg') {
            elementDesc = id ? `the SVG icon with id "${id}"` : (className ? `the SVG icon with class "${className.split(' ')[0]}"` : 'the SVG icon/graphic');
          } else if (svgType) {
            // It's an element inside an SVG (path, circle, rect, etc.)
            elementDesc = `the ${svgType} inside the SVG icon`;
          } else {
            elementDesc = 'the SVG element';
          }
        } else if (textContent && textContent.length > 0 && textContent.length < 40) {
          // Use text content as primary identifier - most intuitive
          elementDesc = `the "${textContent.substring(0, 35).trim()}" ${tag}`;
        } else if (id) {
          elementDesc = `the ${tag} with id "${id}"`;
        } else if (className) {
          const firstClass = className.split(' ')[0];
          elementDesc = `the ${tag} with class "${firstClass}"`;
        } else {
          elementDesc = `the ${tag} element`;
        }
        
        setSelectedElement(elementDesc);
        // Don't use @ - just describe the element naturally
        // Only change if not currently editing
        if (!isEditing) {
          setEditInput(`For ${elementDesc}: `);
        }
        setIsPointAndEdit(false);
        editInputRef.current?.focus();
      }
    };
    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, []);

  // Inject pointer script into iframe when point-and-edit is enabled
  useEffect(() => {
    if (!isPointAndEdit || !previewIframeRef.current) return;
    
    const iframe = previewIframeRef.current;
    const injectScript = () => {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        if (!doc) return;
        
        // Check if already injected
        if (doc.getElementById('point-and-edit-script')) return;
        
        const script = doc.createElement('script');
        script.id = 'point-and-edit-script';
        script.textContent = `
          (function() {
            let hovered = null;
            const overlay = document.createElement('div');
            overlay.id = 'point-edit-overlay';
            overlay.style.cssText = 'position:fixed;pointer-events:none;border:2px solid var(--accent-orange);background:rgba(82,82,91,0.2);z-index:99999;transition:all 0.1s ease;display:none;';
            document.body.appendChild(overlay);
            
            document.addEventListener('mousemove', function(e) {
              const el = document.elementFromPoint(e.clientX, e.clientY);
              if (el && el !== hovered && el !== overlay) {
                hovered = el;
                const rect = el.getBoundingClientRect();
                overlay.style.display = 'block';
                overlay.style.left = rect.left + 'px';
                overlay.style.top = rect.top + 'px';
                overlay.style.width = rect.width + 'px';
                overlay.style.height = rect.height + 'px';
              }
            });
            
            document.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const el = document.elementFromPoint(e.clientX, e.clientY);
              if (el && el !== overlay) {
                // Get className safely - SVG elements have SVGAnimatedString which can't be cloned
                let classValue = '';
                if (el.className) {
                  if (typeof el.className === 'string') {
                    classValue = el.className;
                  } else if (el.className.baseVal !== undefined) {
                    // SVG element - use baseVal
                    classValue = el.className.baseVal;
                  } else {
                    classValue = el.getAttribute('class') || '';
                  }
                }
                window.parent.postMessage({
                  type: 'element-selected',
                  tagName: el.tagName,
                  id: el.id || '',
                  className: classValue,
                  textContent: el.textContent?.trim().substring(0, 50) || '',
                  // Add SVG-specific info
                  isSvg: el.tagName === 'svg' || el.closest('svg') !== null,
                  svgType: el.closest('svg') ? el.tagName.toLowerCase() : null
                }, '*');
              }
            }, true);
          })();
        `;
        doc.body.appendChild(script);
        
        // Add cursor style
        const style = doc.createElement('style');
        style.id = 'point-and-edit-style';
        style.textContent = 'body, body * { cursor: crosshair !important; }';
        doc.head.appendChild(style);
      } catch (e) {
        console.log('Cannot inject into iframe:', e);
      }
    };
    
    // Wait for iframe to load
    if (iframe.contentDocument?.readyState === 'complete') {
      injectScript();
    } else {
      iframe.addEventListener('load', injectScript);
      return () => iframe.removeEventListener('load', injectScript);
    }
  }, [isPointAndEdit, previewUrl]);

  // Clean up pointer script when disabled
  useEffect(() => {
    if (isPointAndEdit || !previewIframeRef.current) return;
    try {
      const doc = previewIframeRef.current.contentDocument;
      if (doc) {
        doc.getElementById('point-and-edit-script')?.remove();
        doc.getElementById('point-and-edit-style')?.remove();
        doc.getElementById('point-edit-overlay')?.remove();
      }
    } catch (e) { /* ignore */ }
  }, [isPointAndEdit]);

  // Direct text editing mode - inject contenteditable script
  useEffect(() => {
    if (!isDirectEditMode || !previewIframeRef.current) return;
    
    const iframe = previewIframeRef.current;
    const injectDirectEditScript = () => {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        if (!doc) return;
        
        if (doc.getElementById('direct-edit-script')) return;
        
        const script = doc.createElement('script');
        script.id = 'direct-edit-script';
        script.textContent = `
          (function() {
            let activeElement = null;
            let originalText = '';
            
            // Editable tags list
            const editableTags = ['H1','H2','H3','H4','H5','H6','P','SPAN','A','BUTTON','LI','LABEL','TD','TH','STRONG','EM','B','I','SMALL','FOOTER','DIV','SECTION','ARTICLE','ASIDE','NAV','HEADER','TIME','ADDRESS','FIGCAPTION','BLOCKQUOTE','CITE','CODE','PRE','MARK','DEL','INS','SUB','SUP'];
            
            // Start editing function
            function startEdit(el) {
              if (activeElement) {
                finishEdit();
              }
              if (el.children.length > 3 && el.tagName !== 'A' && el.tagName !== 'BUTTON') return;
              if (!editableTags.includes(el.tagName)) return;
              
              activeElement = el;
              originalText = el.textContent;
              el.contentEditable = 'true';
              el.style.outline = '2px solid var(--accent-orange)';
              el.style.outlineOffset = '2px';
              el.focus();
              
              // Select all text
              setTimeout(function() {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
              }, 10);
            }
            
            function finishEdit(cancelled) {
              if (!activeElement) return;
              
              const newText = activeElement.textContent.trim();
              activeElement.contentEditable = 'false';
              activeElement.style.outline = '';
              activeElement.style.outlineOffset = '';
              
              if (!cancelled && newText !== originalText.trim()) {
                const path = getElementPath(activeElement);
                window.parent.postMessage({
                  type: 'text-edited',
                  originalText: originalText.trim(),
                  newText: newText,
                  elementPath: path,
                  tagName: activeElement.tagName
                }, '*');
              }
              
              activeElement = null;
              originalText = '';
            }
            
            function getElementPath(el) {
              const parts = [];
              while (el && el.tagName !== 'HTML') {
                let selector = el.tagName.toLowerCase();
                if (el.id) selector += '#' + el.id;
                else if (el.className && typeof el.className === 'string') {
                  selector += '.' + el.className.split(' ').filter(function(c) { return c; }).join('.');
                }
                parts.unshift(selector);
                el = el.parentElement;
              }
              return parts.join(' > ');
            }
            
            // Block form submissions
            document.addEventListener('submit', function(e) {
              e.preventDefault();
              e.stopPropagation();
            }, true);
            
            // Single click handler - for buttons/links, start edit; for others, finish edit if clicking outside
            document.addEventListener('click', function(e) {
              const el = e.target;
              
              // Always prevent navigation on links
              const closestLink = el.closest('a');
              if (closestLink) {
                e.preventDefault();
              }
              
              // If clicking on a button or link (or inside one), start editing it
              const closestButton = el.closest('button');
              if (closestButton || closestLink) {
                e.preventDefault();
                e.stopPropagation();
                const target = closestButton || closestLink;
                if (target !== activeElement) {
                  startEdit(target);
                }
                return;
              }
              
              // If currently editing and clicked outside, finish edit
              if (activeElement && el !== activeElement && !activeElement.contains(el)) {
                finishEdit();
              }
            }, true);
            
            // Double-click on other text elements
            document.addEventListener('dblclick', function(e) {
              const el = e.target;
              
              // Skip if inside button/link (handled by single click)
              if (el.closest('button') || el.closest('a')) return;
              
              if (!editableTags.includes(el.tagName)) return;
              
              e.preventDefault();
              e.stopPropagation();
              startEdit(el);
            });
            
            // Handle Enter/Escape to finish editing
            document.addEventListener('keydown', function(e) {
              if (!activeElement) return;
              
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                finishEdit();
              } else if (e.key === 'Escape') {
                e.preventDefault();
                activeElement.textContent = originalText;
                finishEdit(true);
              }
            });
            
            // Visual indicator that editing mode is active
            const indicator = document.createElement('div');
            indicator.id = 'direct-edit-indicator';
            indicator.style.cssText = 'position:fixed;top:8px;right:8px;padding:4px 10px;background:var(--accent-orange);color:white;font-size:11px;font-family:system-ui;border-radius:4px;z-index:99999;pointer-events:none;';
            indicator.textContent = '✎ Editing Mode (click buttons/links, double-click text)';
            document.body.appendChild(indicator);
          })();
        `;
        doc.body.appendChild(script);
        
        // Add hover highlight style and disable all interactivity
        const style = doc.createElement('style');
        style.id = 'direct-edit-style';
        style.textContent = 'a, button, input, select, textarea, [onclick], [href] { pointer-events: auto !important; cursor: text !important; } a:hover, button:hover { outline: 2px dashed var(--accent-orange) !important; outline-offset: 2px; } h1,h2,h3,h4,h5,h6,p,span,li,label,td,th,strong,em,b,i,small,div,section,article,aside,nav,header,time,address,figcaption,blockquote,cite,code,pre,mark,del,ins,sub,sup { transition: outline 0.1s; } h1:hover,h2:hover,h3:hover,h4:hover,h5:hover,h6:hover,p:hover,span:hover,li:hover,label:hover,td:hover,th:hover,strong:hover,em:hover,b:hover,i:hover,small:hover,div:hover,section:hover,article:hover,aside:hover,nav:hover,header:hover,time:hover,address:hover,figcaption:hover,blockquote:hover,cite:hover,code:hover,pre:hover,mark:hover,del:hover,ins:hover,sub:hover,sup:hover { outline: 1px dashed rgba(82,82,91,0.2); outline-offset: 2px; cursor: text; }';
        doc.head.appendChild(style);
      } catch (e) {
        console.log('Cannot inject direct edit script:', e);
      }
    };
    
    if (iframe.contentDocument?.readyState === 'complete') {
      injectDirectEditScript();
    } else {
      iframe.addEventListener('load', injectDirectEditScript);
      return () => iframe.removeEventListener('load', injectDirectEditScript);
    }
  }, [isDirectEditMode, previewUrl]);

  // Clean up direct edit script when disabled
  useEffect(() => {
    if (isDirectEditMode || !previewIframeRef.current) return;
    try {
      const doc = previewIframeRef.current.contentDocument;
      if (doc) {
        doc.getElementById('direct-edit-script')?.remove();
        doc.getElementById('direct-edit-style')?.remove();
        doc.getElementById('direct-edit-indicator')?.remove();
      }
    } catch (e) { /* ignore */ }
  }, [isDirectEditMode]);

  // Reset editing modes when changing tabs
  useEffect(() => {
    if (viewMode !== "preview") {
      setIsDirectEditMode(false);
      setIsPointAndEdit(false);
      // If there were pending edits and user switched tabs, discard them
      if (pendingTextEdits.length > 0) {
        setPendingTextEdits([]);
        // Refresh preview to original code
        if (editableCode) {
          setPreviewUrl(createPreviewUrl(editableCode));
        }
      }
    }
  }, [viewMode]);

  // Listen for text edit messages from iframe
  useEffect(() => {
    const handleTextEdit = (event: MessageEvent) => {
      if (event.data?.type === 'text-edited') {
        const { originalText, newText, elementPath, tagName } = event.data;
        setPendingTextEdits(prev => {
          // Check if this edit already exists (update it)
          const existing = prev.findIndex(e => e.originalText === originalText);
          if (existing >= 0) {
            const updated = [...prev];
            updated[existing] = { originalText, newText, elementPath };
            return updated;
          }
          return [...prev, { originalText, newText, elementPath }];
        });
      }
    };
    window.addEventListener('message', handleTextEdit);
    return () => window.removeEventListener('message', handleTextEdit);
  }, []);

  // Apply pending text edits to the code
  const applyPendingTextEdits = useCallback(() => {
    if (pendingTextEdits.length === 0 || !editableCode) return;
    
    let newCode = editableCode;
    let appliedCount = 0;
    
    for (const edit of pendingTextEdits) {
      // Simple text replacement - find the original text and replace with new
      // We need to be careful to only replace text content, not attribute values
      const escapedOriginal = edit.originalText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      
      let matched = false;
      
      // Strategy 1: Match text between tags (strict)
      const regex1 = new RegExp(`(>\\s*)${escapedOriginal}(\\s*<)`, 'g');
      let newCodeAfter = newCode.replace(regex1, `$1${edit.newText}$2`);
      if (newCodeAfter !== newCode) {
        newCode = newCodeAfter;
        matched = true;
      }
      
      // Strategy 2: Match text with possible whitespace/newlines around it
      if (!matched) {
        const regex2 = new RegExp(`(>[^<]*?)${escapedOriginal}([^<]*?<)`, 'g');
        newCodeAfter = newCode.replace(regex2, `$1${edit.newText}$2`);
        if (newCodeAfter !== newCode) {
          newCode = newCodeAfter;
          matched = true;
        }
      }
      
      // Strategy 3: Simple replace but avoid attribute values (check not inside quotes)
      if (!matched) {
        // Find all occurrences and only replace those not inside attribute values
        const parts = newCode.split(edit.originalText);
        if (parts.length > 1) {
          let result = parts[0];
          for (let i = 1; i < parts.length; i++) {
            // Check if we're inside an attribute (count quotes before this position)
            const before = result;
            const doubleQuotes = (before.match(/"/g) || []).length;
            const singleQuotes = (before.match(/'/g) || []).length;
            // If odd number of quotes, we're inside an attribute - don't replace
            if (doubleQuotes % 2 === 0 && singleQuotes % 2 === 0) {
              result += edit.newText + parts[i];
              matched = true;
            } else {
              result += edit.originalText + parts[i];
            }
          }
          if (matched) {
            newCode = result;
          }
        }
      }
      
      if (matched) {
        appliedCount++;
      }
    }
    
    if (appliedCount > 0) {
      setEditableCode(newCode);
      setDisplayedCode(newCode);
      setGeneratedCode(newCode);
      setPreviewUrl(createPreviewUrl(newCode));
      
      // Save version
      if (activeGeneration) {
        const versionLabel = `Text edits (${appliedCount} changes)`;
        const updatedGen = { 
          ...activeGeneration, 
          code: newCode, 
          versions: [...(activeGeneration.versions || []), { 
            id: generateId(), 
            timestamp: Date.now(), 
            label: versionLabel, 
            code: newCode, 
            flowNodes, 
            flowEdges, 
            styleInfo 
          }] 
        };
        setActiveGeneration(updatedGen);
        setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
        saveGenerationToSupabase(updatedGen);
      }
      
      showToast(`Applied ${appliedCount} text edit${appliedCount > 1 ? 's' : ''}`, "success");
    }
    
    setPendingTextEdits([]);
    setIsDirectEditMode(false);
  }, [pendingTextEdits, editableCode, activeGeneration, flowNodes, flowEdges, styleInfo]);

  const handleAssetCodeUpdate = useCallback((newCode: string) => {
    if (!newCode) return;
    setEditableCode(newCode);
    setDisplayedCode(newCode);
    setGeneratedCode(newCode);
    setPreviewUrl(prev => {
      if (prev) URL.revokeObjectURL(prev);
      return createPreviewUrl(newCode);
    });

    const files = generateFileStructure(newCode, flowNodes, codeMode);
    setGeneratedFiles(files);

    if (activeGeneration) {
      const versionLabel = "Asset update";
      const updatedGen = {
        ...activeGeneration,
        code: newCode,
        versions: [
          ...(activeGeneration.versions || []),
          {
            id: generateId(),
            timestamp: Date.now(),
            label: versionLabel,
            code: newCode,
            flowNodes,
            flowEdges,
            styleInfo,
          },
        ],
      };
      setActiveGeneration(updatedGen);
      setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
      saveGenerationToSupabase(updatedGen);
    }
  }, [activeGeneration, codeMode, createPreviewUrl, flowEdges, flowNodes, saveGenerationToSupabase, styleInfo]);

  const assetCode = editableCode || displayedCode || generatedCode || "";

  // Build architecture from code - better positioning with no overlaps
  const buildArchitectureLive = async (code: string) => {
    setArchBuilding(true);
    setArchitecture([]);
    
    const addNode = async (node: ArchNode) => {
      await new Promise(r => setTimeout(r, 120));
      setArchitecture(prev => [...prev, node]);
    };
    
    // Better layout - tree structure with proper spacing
    const centerX = 400;
    let currentY = 40;
    const rowHeight = 120;
    const colWidth = 250;
    
    // Analyze code for smarter naming
    const hasNav = /<nav/i.test(code);
    const hasHeader = /<header/i.test(code);
    const hasSidebar = /sidebar|aside/i.test(code);
    const hasHero = /hero|banner|jumbotron/i.test(code);
    const hasCards = /card/gi.test(code);
    const hasForms = /<form/i.test(code);
    const hasTable = /<table/i.test(code);
    
    await addNode({ id: "root", name: "Document", type: "page", description: "HTML root", x: centerX, y: currentY, connections: [] });
    currentY += rowHeight;
    
    // Row 2: Layout structure
    const row2Nodes: string[] = [];
    if (hasNav || hasHeader) {
      await addNode({ id: "nav", name: hasNav ? "Navigation" : "Header", type: "component", description: hasNav ? "Site navigation menu" : "Page header", x: centerX - colWidth, y: currentY, connections: ["root"] });
      row2Nodes.push("nav");
    }
    
    await addNode({ id: "content", name: "Content Area", type: "section", description: "Main page content", x: centerX, y: currentY, connections: ["root"] });
    row2Nodes.push("content");
    
    if (hasSidebar) {
      await addNode({ id: "sidebar", name: "Sidebar", type: "component", description: "Side navigation", x: centerX + colWidth, y: currentY, connections: ["root"] });
    }
    
    currentY += rowHeight;
    
    // Row 3: Content sections
    const row3Nodes: { id: string; name: string; desc: string }[] = [];
    if (hasHero) row3Nodes.push({ id: "hero", name: "Hero Section", desc: "Main visual banner" });
    if (hasCards) row3Nodes.push({ id: "cards", name: "Card Grid", desc: "Content cards layout" });
    if (hasForms) row3Nodes.push({ id: "forms", name: "Form Block", desc: "User input forms" });
    if (hasTable) row3Nodes.push({ id: "table", name: "Data Table", desc: "Tabular data display" });
    
    // Add generic sections if none detected
    const sections = (code.match(/<section/gi) || []).length;
    if (row3Nodes.length === 0 && sections > 0) {
      for (let i = 0; i < Math.min(sections, 3); i++) {
        row3Nodes.push({ id: `section-${i}`, name: `Section ${i + 1}`, desc: "Content section" });
      }
    }
    
    const spacing3 = colWidth;
    const startX3 = centerX - ((row3Nodes.length - 1) * spacing3) / 2;
    for (let i = 0; i < row3Nodes.length; i++) {
      await addNode({ 
        id: row3Nodes[i].id, 
        name: row3Nodes[i].name, 
        type: "component",
        description: row3Nodes[i].desc,
        x: startX3 + (i * spacing3), 
        y: currentY, 
        connections: ["content"] 
      });
    }
    
    currentY += rowHeight;
    
    // Row 4: Elements
    const buttons = (code.match(/<button/gi) || []).length;
    const images = (code.match(/<img/gi) || []).length;
    const inputs = (code.match(/<input/gi) || []).length;
    const links = (code.match(/<a /gi) || []).length;
    
    const row4Nodes: { id: string; name: string; type: "interactive" | "element"; desc: string }[] = [];
    if (buttons > 0) row4Nodes.push({ id: "btns", name: `${buttons} Buttons`, type: "interactive", desc: "Click actions" });
    if (links > 5) row4Nodes.push({ id: "links", name: `${links} Links`, type: "interactive", desc: "Navigation links" });
    if (images > 0) row4Nodes.push({ id: "imgs", name: `${images} Images`, type: "element", desc: "Visual media" });
    if (inputs > 0) row4Nodes.push({ id: "inputs", name: `${inputs} Inputs`, type: "interactive", desc: "Form fields" });
    
    const spacing4 = colWidth;
    const startX4 = centerX - ((row4Nodes.length - 1) * spacing4) / 2;
    const parentNode = row3Nodes.length > 0 ? row3Nodes[0].id : "content";
    for (let i = 0; i < row4Nodes.length; i++) {
      await addNode({ 
        id: row4Nodes[i].id, 
        name: row4Nodes[i].name, 
        type: row4Nodes[i].type, 
        description: row4Nodes[i].desc, 
        x: startX4 + (i * spacing4), 
        y: currentY, 
        connections: [parentNode] 
      });
    }
    
    currentY += rowHeight;
    
    // Row 5: Footer
    if (/<footer/i.test(code)) {
      await addNode({ id: "footer", name: "Footer", type: "component", description: "Page footer & links", x: centerX, y: currentY, connections: ["root"] });
    }
    
    setArchBuilding(false);
  };

  // Build PRODUCT FLOW MAP from ACTUAL code content or SCAN DATA
  // Analyzes the generated code to detect:
  // - CONFIRMED pages: x-show Alpine.js pages with actual content OR scanData.pages
  // - POSSIBLE pages: Navigation items without content (marked with comments)
  // - Flow edges: Navigation relationships between pages
  const buildFlowLive = async (code: string) => {
    console.log('[buildFlowLive] Starting flow build, code length:', code.length);
    setFlowBuilding(true);
    setFlowNodes([]);
    setFlowEdges([]);
    
    // ═══════════════════════════════════════════════════════════════════════════
    // VALIDATION: Comprehensive page name validation to filter placeholders
    // ═══════════════════════════════════════════════════════════════════════════
    const isValidPageName = (name: string): boolean => {
      if (!name || typeof name !== 'string') return false;
      const trimmed = name.trim();
      // Must be 2-50 characters
      if (trimmed.length < 2 || trimmed.length > 50) return false;
      // No template placeholders like {xxx} or {xxx.yyy}
      if (/\{.*\}/.test(trimmed)) return false;
      // No code-like patterns: .headline, .title, variable.property
      if (/\.[a-z]+/i.test(trimmed)) return false;
      // Must start with a letter (allow unicode for international names)
      if (!/^[A-Za-zÀ-ÿĄĘŁŃÓŚŹŻąęłńóśźż]/.test(trimmed)) return false;
      // No HTML/code/special characters
      if (/[<>=\[\]`$@#%^&*()_+=|\\:";'?/]/.test(trimmed)) return false;
      // Skip common non-page elements (buttons, actions)
      const skipWords = [
        'apply', 'login', 'logout', 'sign up', 'signup', 'sign in', 'signin', 
        'search', 'menu', 'get started', 'download', 'submit', 'send', 'close',
        'cancel', 'ok', 'yes', 'no', 'save', 'delete', 'edit', 'view', 'more',
        'back', 'next', 'previous', 'continue', 'skip', 'done', 'finish'
      ];
      if (skipWords.includes(trimmed.toLowerCase())) return false;
      // No purely numeric or single-word generic names
      if (/^\d+$/.test(trimmed)) return false;
      return true;
    };
    
    // Synchronous duplicate tracker — prevents race conditions from async state updates
    const addedNodeNames = new Set<string>();
    const addedNodeIds = new Set<string>();

    const addNode = async (node: ProductFlowNode) => {
      await new Promise(r => setTimeout(r, 30));
      if (!isValidPageName(node.name)) {
        console.log('[addNode] Skipping invalid name:', node.name);
        return;
      }
      const normalizedName = node.name.toLowerCase().trim();
      // Synchronous check FIRST (prevents race condition)
      if (addedNodeIds.has(node.id) || addedNodeNames.has(normalizedName)) {
        console.log('[addNode] Skipping duplicate:', node.name);
        return;
      }
      addedNodeIds.add(node.id);
      addedNodeNames.add(normalizedName);
      setFlowNodes(prev => [...prev, node]);
    };
    
    const addEdge = async (edge: ProductFlowEdge) => {
      await new Promise(r => setTimeout(r, 15));
      setFlowEdges(prev => [...prev, edge]);
    };
    
    // ═══════════════════════════════════════════════════════════════════════════
    // PRIORITY: Use scanData.pages if available (from video analysis)
    // Handle BOTH formats: flat array OR { detected: [...] } object
    // ═══════════════════════════════════════════════════════════════════════════

    // Normalize scanData.pages — transmute.ts returns { detected: [...] } object,
    // but we need a flat array for processing
    const rawPages = scanData?.pages;
    const pagesArray: any[] = Array.isArray(rawPages)
      ? rawPages
      : Array.isArray(rawPages?.detected)
        ? rawPages.detected
        : [];

    if (pagesArray.length > 0) {
      console.log('[buildFlowLive] Using scanData.pages:', pagesArray.length, 'pages (format:', Array.isArray(rawPages) ? 'flat' : 'nested', ')');
      
      // ═══════════════════════════════════════════════════════════════════════════
      // IMPORTANT: Cross-check scanData with actual code content
      // A page that was "detected" but now has x-show content = NOW OBSERVED
      // This handles the case when user reconstructs a page via edit
      // ═══════════════════════════════════════════════════════════════════════════
      
      // Helper: Check if a page has actual content in the code
      const pageHasContentInCode = (pageName: string): boolean => {
        const normalizedName = pageName.toLowerCase().replace(/[^a-z0-9]+/g, '');
        const escapedName = pageName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Check for Alpine.js x-show with this page name — all common variable names
        const varNames = '(?:page|currentPage|activeTab|activeView|selected|active|current|tab|view|section)';
        const xShowPatterns = [
          new RegExp(`x-show\\s*=\\s*["']\\s*${varNames}\\s*===?\\s*['"]${normalizedName}['"]`, 'i'),
          new RegExp(`x-show\\s*=\\s*["']\\s*${varNames}\\s*===?\\s*['"]${escapedName}['"]`, 'i'),
          new RegExp(`x-show\\s*=\\s*["']\\s*${varNames}\\s*===?\\s*['"][^'"]*${normalizedName}[^'"]*['"]`, 'i'),
        ];
        return xShowPatterns.some(pattern => pattern.test(code));
      };
      
      // Separate pages - use code content as source of truth for "observed" status
      const observedPages = pagesArray.filter((p: any) => {
        const name = p.title || p.name || p.navLabel || p.id || '';
        if (!isValidPageName(name)) return false;
        // Page is observed if: originally seen in video OR now has content in code (was reconstructed)
        return p.seenInVideo === true || p.isVisible === true || p.isDefault || pageHasContentInCode(name);
      });
      const possiblePages = pagesArray.filter((p: any) => {
        const name = p.title || p.name || p.navLabel || p.id || '';
        if (!isValidPageName(name)) return false;
        // Page is possible only if NOT in video AND NOT has content in code
        return (p.seenInVideo === false || p.isVisible === false) && !p.isDefault && !pageHasContentInCode(name);
      });
      
      console.log('[buildFlowLive] Observed:', observedPages.length, 'Possible:', possiblePages.length);
      
      // Add OBSERVED nodes first (pages that were shown and generated from video)
      for (let i = 0; i < observedPages.length; i++) {
        const page = observedPages[i];
        await addNode({
          id: page.id || `page-${i}`,
          name: page.title || page.name || page.navLabel || page.id,
          type: 'view',
          status: 'observed',
          description: page.description || `Path: ${page.path || '/'}`,
          x: 100 + (i % 3) * 300,
          y: 100 + Math.floor(i / 3) * 220,
          confidence: 'high'
        });
      }
      
      // Add DETECTED nodes (visible in navigation but not clicked/visited)
      for (let i = 0; i < possiblePages.length; i++) {
        const page = possiblePages[i];
        await addNode({
          id: page.id || `possible-${i}`,
          name: page.title || page.name || page.navLabel || page.id,
          type: 'view',
          status: 'detected',
          description: page.description || `Present in navigation, not shown in video`,
          x: 100 + (i % 3) * 300,
          y: 400 + Math.floor(i / 3) * 220,
          confidence: 'medium'
        });
      }
      
      // Also add EXTRA possible pages from sidebar navigation items not in pages array
      // Add EXTRA possible pages from sidebar navigation items not already added
      if (scanData?.ui?.navigation?.sidebar?.items) {
        const navItems = scanData.ui.navigation.sidebar.items;
        let extraIndex = possiblePages.length;
        for (const item of navItems) {
          const itemName = item.label || item.name || '';
          if (!isValidPageName(itemName)) continue;
          const itemId = itemName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          // addNode already deduplicates via addedNodeNames/addedNodeIds
          if (itemId) {
            await addNode({
              id: itemId,
              name: itemName,
              type: 'view',
              status: 'detected',
              description: `Navigation item - not visited in video`,
              x: 100 + (extraIndex % 3) * 300,
              y: 400 + Math.floor(extraIndex / 3) * 220,
              confidence: 'low'
            });
            extraIndex++;
          }
        }
      }

      // Also add HEADER navigation items (About, Companies, Startup Jobs, etc.)
      if (scanData?.ui?.navigation?.header?.items) {
        const headerItems = scanData.ui.navigation.header.items;
        let headerIndex = possiblePages.length + (scanData?.ui?.navigation?.sidebar?.items?.length || 0);
        for (const item of headerItems) {
          const itemName = item.label || item.name || '';
          if (!isValidPageName(itemName)) continue;
          const itemId = itemName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          // addNode already deduplicates via addedNodeNames/addedNodeIds
          if (itemId) {
            await addNode({
              id: itemId,
              name: itemName,
              type: 'view',
              status: 'detected',
              description: `Header link - not visited in video`,
              x: 100 + (headerIndex % 4) * 280,
              y: 500 + Math.floor(headerIndex / 4) * 200,
              confidence: 'medium'
            });
            headerIndex++;
          }
        }
      }
      
      // Add edges between OBSERVED pages (sequential navigation flow)
      const observedIds = observedPages.map((p: any) => p.id || '').filter(Boolean);
      for (let i = 0; i < observedIds.length - 1; i++) {
        if (observedIds[i] && observedIds[i + 1]) {
          await addEdge({
            id: `edge-${observedIds[i]}-${observedIds[i+1]}`,
            from: observedIds[i],
            to: observedIds[i + 1],
            label: 'navigates',
            type: 'navigation'
          });
        }
      }

      // Add POSSIBLE edges from first observed page → each detected page
      // (detected pages come from nav, so the main page links to them)
      const mainPageId = observedIds[0] || '';
      if (mainPageId) {
        const allDetectedIds = possiblePages.map((p: any) => p.id || '').filter(Boolean);
        for (const detId of allDetectedIds) {
          await addEdge({
            id: `edge-${mainPageId}-${detId}`,
            from: mainPageId,
            to: detId,
            label: 'possible',
            type: 'possible'
          });
        }
      }
      
      setFlowBuilding(false);
      return; // Done - skip old detection logic
    }
    
    console.log('[buildFlowLive] No scanData.pages, falling back to AGGRESSIVE code analysis');
    
    // ═══════════════════════════════════════════════════════════════════════════
    // AGGRESSIVE FALLBACK: Extract ALL navigation from code
    // ═══════════════════════════════════════════════════════════════════════════
    
    interface DetectedPage {
      id: string;
      name: string;
      isConfirmed: boolean;
      hasContent: boolean;
      contentPreview?: string;
      isAddedByAI?: boolean;
    }
    
    const detectedPages: DetectedPage[] = [];
    const processedIds = new Set<string>();
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STEP 1: AGGRESSIVE extraction of ALL navigation items from entire code
    // ═══════════════════════════════════════════════════════════════════════════
    
    const navNames = new Set<string>();
    
    // Pattern 1: ALL anchor links with text
    const linkRegex = /<a[^>]*>([^<]{2,30})<\/a>/gi;
    let m;
    while ((m = linkRegex.exec(code)) !== null) {
      const text = m[1].trim().replace(/\s+/g, ' ');
      // Use comprehensive validation
      if (isValidPageName(text)) {
        navNames.add(text);
      }
    }
    
    // Pattern 2: Navigation menu items - look for text in common nav patterns
    const navPatterns = [
      // Items in nav/header/sidebar
      /<(?:nav|header|aside|ul)[^>]*class\s*=\s*["'][^"']*(?:nav|menu|sidebar|header)[^"']*["'][^>]*>[\s\S]*?<\/(?:nav|header|aside|ul)>/gi,
      // Flex containers in header
      /<div[^>]*class\s*=\s*["'][^"']*(?:flex|gap)[^"']*["'][^>]*>[\s\S]*?<\/div>/gi,
    ];
    
    for (const pattern of navPatterns) {
      let areaMatch;
      while ((areaMatch = pattern.exec(code)) !== null) {
        const area = areaMatch[0];
        // Extract all text from links in this area
        const innerLinkRegex = /<a[^>]*>([^<]{2,25})<\/a>/gi;
        let linkMatch;
        while ((linkMatch = innerLinkRegex.exec(area)) !== null) {
          const text = linkMatch[1].trim();
          if (isValidPageName(text)) {
            navNames.add(text);
          }
        }
        // Extract button text
        const btnRegex = /<button[^>]*>([^<]{2,20})<\/button>/gi;
        while ((linkMatch = btnRegex.exec(area)) !== null) {
          const text = linkMatch[1].trim();
          if (isValidPageName(text)) {
            navNames.add(text);
          }
        }
      }
    }
    
    // Pattern 3: Common navigation words that appear near "href" or "@click"
    const navContextRegex = /(?:href|@click)[^>]*>([A-Za-zĄĘŁŃÓŚŹŻąęłńóśźż][A-Za-z0-9ĄĘŁŃÓŚŹŻąęłńóśźż\s]{1,25})</gi;
    while ((m = navContextRegex.exec(code)) !== null) {
      const text = m[1].trim();
      if (isValidPageName(text)) {
        navNames.add(text);
      }
    }

    // Pattern 4: Anchor-based navigation (href="#section-id") with matching section ids
    const anchorRegex = /href\s*=\s*["']#([a-zA-Z][\w-]{1,30})["']/gi;
    while ((m = anchorRegex.exec(code)) !== null) {
      const sectionId = m[1];
      // Check if a matching section/div with that ID exists in the code
      const hasSection = new RegExp(`<(?:section|div|main|article)[^>]*id\\s*=\\s*["']${sectionId}["']`, 'i').test(code);
      if (hasSection) {
        const name = sectionId.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        if (isValidPageName(name)) navNames.add(name);
      }
    }

    // Pattern 5: Multiple <section> elements with IDs (common multi-page layout)
    const sectionIdRegex = /<section[^>]*id\s*=\s*["']([a-zA-Z][\w-]{2,30})["']/gi;
    const sectionIds: string[] = [];
    while ((m = sectionIdRegex.exec(code)) !== null) {
      sectionIds.push(m[1]);
    }
    if (sectionIds.length >= 2) {
      for (const sid of sectionIds) {
        const name = sid.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        if (isValidPageName(name)) navNames.add(name);
      }
    }

    // Final filter using comprehensive validation (double-check all entries)
    const filteredNavNames = Array.from(navNames).filter(name => isValidPageName(name));
    
    console.log('[buildFlowLive] Found nav names (aggressive):', filteredNavNames);
    
    // Check if code has Alpine.js multi-page structure
    const hasAlpinePages = /x-show\s*=\s*["'](?:currentPage|page|activeTab|activeView)/i.test(code);
    console.log('[buildFlowLive] hasAlpinePages:', hasAlpinePages);
    
    // Pattern 1: Find ALL x-show page identifiers first
    // Support multiple patterns: activeTab === 'Dashboard', currentPage === "home", etc.
    const pageIdentifiers: string[] = [];
    const pageIdPatterns = [
      // x-show="activeTab === 'Dashboard'" or x-show='activeTab === "Dashboard"'
      /x-show\s*=\s*["'](?:currentPage|page|activeTab|activeView)\s*===?\s*['"]([^'"]+)['"]/gi,
      // x-show="tab === 'analytics'"
      /x-show\s*=\s*["']tab\s*===?\s*['"]([^'"]+)['"]/gi,
      // x-show="selected === 'settings'"  
      /x-show\s*=\s*["'](?:selected|active|current)\s*===?\s*['"]([^'"]+)['"]/gi,
    ];
    
    let match;
    for (const pageIdRegex of pageIdPatterns) {
      while ((match = pageIdRegex.exec(code)) !== null) {
        const pageId = match[1];
        if (pageId && !pageIdentifiers.includes(pageId) && pageId.length > 1 && pageId.length < 50) {
          pageIdentifiers.push(pageId);
        }
      }
    }
    console.log('[buildFlowLive] Found page identifiers:', pageIdentifiers);
    
    // For each page identifier, check if it has real content
    // ALL pages with x-show content should be marked as OBSERVED (they exist in the generated code)
    for (const pageId of pageIdentifiers) {
      const normalizedId = pageId.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      if (processedIds.has(normalizedId)) continue;
      processedIds.add(normalizedId);
      
      // Look for the content of this page - check ALL x-show patterns
      const escapedPageId = pageId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const contentPatterns = [
        new RegExp(`x-show\\s*=\\s*["'](?:currentPage|page|activeTab|activeView|tab|selected|active|current)\\s*===?\\s*['"]${escapedPageId}['"][^>]*>([\\s\\S]*?)(?=<(?:main|div|section)[^>]*x-show\\s*=|</body>|$)`, 'i'),
      ];
      
      let content = '';
      for (const contentRegex of contentPatterns) {
        const contentMatch = code.match(contentRegex);
        if (contentMatch && contentMatch[1]) {
          content = contentMatch[1];
          break;
        }
      }
      
      // Check if has real content (not placeholder)
      const hasRealContent = content.length > 50 && 
                            !content.includes('Page not shown in video') &&
                            !content.includes('POSSIBLE:') &&
                            !content.includes('not yet created') &&
                            (/<(?:div|section|article|img|h[1-6]|p|ul|table|form|canvas|svg)/i.test(content));
      
      const pageName = pageId
        .replace(/[-_]/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
      
      // Check if this page was added by AI (has our marker comment)
      const aiMarkerRegex = new RegExp(`<!--\\s*=+\\s*${pageId.toUpperCase()}\\s+PAGE\\s*=+\\s*-->`, 'i');
      const isAddedByAI = aiMarkerRegex.test(code);
      
      // If page has x-show content, it's CONFIRMED (observed in generated code)
      detectedPages.push({
        id: normalizedId,
        name: pageName,
        isConfirmed: hasRealContent, // Pages with real content are OBSERVED
        hasContent: hasRealContent,
        contentPreview: content.slice(0, 100),
        isAddedByAI
      });
      
      console.log('[buildFlowLive] Page detected:', pageName, '| hasContent:', hasRealContent, '| contentLen:', content.length);
    }
    
    // Pattern 2: Navigation buttons that set page variables (to find pages we might have missed)
    const navButtonRegex = /@click\s*=\s*["'](?:currentPage|page|activeTab|activeView|selected|active|current|tab|view|section)\s*=\s*['"]([^'"]+)['"]/gi;
    while ((match = navButtonRegex.exec(code)) !== null) {
      const pageId = match[1].toLowerCase().replace(/[^a-z0-9]+/g, '-');
      
      if (processedIds.has(pageId)) continue;
      processedIds.add(pageId);
      
      // Check if this page has x-show content
      const hasXShow = new RegExp(`x-show\\s*=\\s*["'][^"']*${match[1]}`, 'i').test(code);
      
      detectedPages.push({
        id: pageId,
        name: match[1].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        isConfirmed: hasXShow,
        hasContent: hasXShow
      });
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STEP 2: Detect navigation items from sidebar/header/nav/tabs (POSSIBLE paths)
    // ═══════════════════════════════════════════════════════════════════════════
    
    // Get navigation areas - look for nav, header, aside, sidebar, tabs sections
    const navAreaMatches = [
      ...(code.match(/<aside[^>]*>[\s\S]*?<\/aside>/gi) || []),
      ...(code.match(/<nav[^>]*>[\s\S]*?<\/nav>/gi) || []),
      ...(code.match(/<header[^>]*>[\s\S]*?<\/header>/gi) || []),
      ...(code.match(/<footer[^>]*>[\s\S]*?<\/footer>/gi) || []), // Footer often has nav links
      ...(code.match(/<div[^>]*class\s*=\s*["'][^"']*(?:sidebar|menu|navigation|nav-|topbar|tabs?|tab-)[^"']*["'][^>]*>[\s\S]*?<\/div>/gi) || []),
      ...(code.match(/<ul[^>]*class\s*=\s*["'][^"']*(?:nav|menu|tabs?)[^"']*["'][^>]*>[\s\S]*?<\/ul>/gi) || []),
      // Also match role="tablist" and similar
      ...(code.match(/<[^>]*role\s*=\s*["'](?:tablist|navigation|menu)['""][^>]*>[\s\S]*?<\/[^>]+>/gi) || []),
    ];
    const navAreas = navAreaMatches.join(' ');
    
    // Also detect tabs/panels that might be page-like
    const tabPanelRegex = /(?:role\s*=\s*["']tabpanel["']|class\s*=\s*["'][^"']*tab-(?:panel|content|pane)[^"']*["'])[^>]*>/gi;
    const tabPanels = code.match(tabPanelRegex) || [];
    console.log('[buildFlowLive] Found tab panels:', tabPanels.length);
    
    // ALSO look in the ENTIRE code for @click navigation buttons
    // This catches Alpine.js navigation buttons anywhere in the page
    // These are items in navigation that the user CAN click - mark as DETECTED
    const alpineNavPatterns = [
      /@click\s*=\s*["'](?:currentPage|page|activeTab|activeView|tab|selected)\s*=\s*['"]([^'"]+)['"]['"]/gi,
      /@click\s*=\s*["'](?:currentPage|page|activeTab|activeView|tab|selected)\s*=\s*['"]([^'"]+)['"]/gi,
    ];
    
    for (const alpineNavRegex of alpineNavPatterns) {
      while ((match = alpineNavRegex.exec(code)) !== null) {
        const rawPageId = match[1];
        const pageId = rawPageId.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        if (!processedIds.has(pageId) && pageId.length > 1) {
          processedIds.add(pageId);
          // Check if this page has x-show content
          const hasContent = new RegExp(`x-show\\s*=\\s*["'][^"']*['"]${rawPageId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}['"]`, 'i').test(code);
          
          const pageName = rawPageId.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          console.log('[buildFlowLive] Nav button found:', pageName, '| hasContent:', hasContent);
          
          detectedPages.push({
            id: pageId,
            name: pageName,
            isConfirmed: hasContent, // If has x-show content = observed, otherwise detected
            hasContent: hasContent
          });
        }
      }
    }
    
    // Extract navigation items from nav areas
    // STRICT patterns - only actual clickable navigation elements
    const navItemPatterns = [
      // Links with href that look like navigation
      /<a[^>]*href\s*=\s*["'](?:\/|#)[^"']*["'][^>]*>([A-Za-z][A-Za-z0-9\s]{1,30})<\/a>/gi,
      // Buttons with click handlers (Alpine.js or onclick)
      /<button[^>]*(?:@click|onclick)[^>]*>([A-Za-z][A-Za-z0-9\s]{1,25})<\/button>/gi,
      // List items that contain links
      /<li[^>]*>\s*<a[^>]*>([A-Za-z][A-Za-z0-9\s]{1,25})<\/a>/gi,
      // Span/div with navigation-like text after icons (common pattern in sidebars)
      /<(?:span|div)[^>]*class\s*=\s*["'][^"']*(?:nav|menu|sidebar|item)[^"']*["'][^>]*>([A-Za-z][A-Za-z0-9\s]{2,20})<\/(?:span|div)>/gi,
    ];
    
    // ALSO extract sidebar items with icons (very common pattern)
    // Pattern: <li><button @click="..."><Icon /><span>Dashboard</span></button></li>
    const sidebarItemRegex = /<(?:li|button|a|div)[^>]*@click[^>]*>[\s\S]*?(?:<span[^>]*>|>)([A-Za-z][A-Za-z\s]{2,20})(?:<\/span>|<)/gi;
    while ((match = sidebarItemRegex.exec(navAreas)) !== null) {
      const text = match[1].trim();
      if (text.length > 2 && text.length < 25 && /^[A-Za-z]/.test(text)) {
        const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        if (!processedIds.has(id)) {
          processedIds.add(id);
          // Check if this has x-show content
          const hasContent = pageIdentifiers.some(p => p.toLowerCase() === text.toLowerCase());
          console.log('[buildFlowLive] Sidebar item:', text, '| hasContent:', hasContent);
          detectedPages.push({
            id,
            name: text,
            isConfirmed: hasContent,
            hasContent: hasContent
          });
        }
      }
    }
    
    // ALSO search the entire code for any Alpine.js click handlers that navigate
    const globalAlpineNavRegex = /@click\s*=\s*["'][^"']*(?:currentPage|page|activeTab)\s*=\s*['"]([^'"]+)['"]/gi;
    while ((match = globalAlpineNavRegex.exec(code)) !== null) {
      const pageId = match[1].trim();
      if (pageId && !processedIds.has(pageId.toLowerCase())) {
        const id = pageId.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        processedIds.add(id);
        detectedPages.push({
          id,
          name: pageId.charAt(0).toUpperCase() + pageId.slice(1).replace(/-/g, ' '),
          isConfirmed: false,
          hasContent: false
        });
      }
    }
    
    for (const pattern of navItemPatterns) {
      pattern.lastIndex = 0;
      while ((match = pattern.exec(navAreas)) !== null) {
        let text = match[1].trim();
        
        // Clean up text - remove extra whitespace
        text = text.replace(/\s+/g, ' ').trim();
        
        // STRICT filtering - only actual navigation page names
        if (
          text.length < 3 ||                 // Min 3 chars for page name
          text.length > 30 ||                // Max 30 chars
          /^\d/.test(text) ||                // Starts with number
          /\d{2,}/.test(text) ||             // Contains 2+ consecutive digits  
          /[<>={}()]/.test(text) ||          // Contains code characters
          /\.\.\.$/.test(text) ||            // Truncated text
          /^[\s\W]+$/.test(text) ||          // Only whitespace/symbols
          // Common UI labels that are NOT pages
          /^(submit|send|search|login|logout|wyloguj|zaloguj|cancel|ok|save|close|back|next|prev|more|less|see all|view all|expand|collapse|add|edit|delete|remove|update|create|new|copy|share|download|upload|settings|help|profile|menu|toggle|show|hide)$/i.test(text) ||
          // Actions
          /^(click|tap|press|select|choose)$/i.test(text) ||
          // Common button text
          /^(get started|sign up|sign in|learn more|read more|contact us|buy now|shop now|subscribe)$/i.test(text)
        ) continue;
        
        const id = text.toLowerCase().replace(/[^a-z0-9ąęłńóśźżć]+/g, '-').replace(/^-|-$/g, '');
        if (!id || id.length < 2 || processedIds.has(id)) continue;
        processedIds.add(id);
        
        detectedPages.push({
          id,
          name: text,
          isConfirmed: false, // Navigation item without confirmed page
          hasContent: false
        });
      }
    }
    
    console.log('[buildFlowLive] Total detected pages after nav extraction:', detectedPages.length);
    
    // ═════ ADD navigation names as POSSIBLE pages (AGGRESSIVE) ═════
    for (const navName of filteredNavNames) {
      const id = navName.toLowerCase().replace(/[^a-z0-9ąęłńóśźżć]+/g, '-').replace(/^-|-$/g, '');
      if (!processedIds.has(id) && id.length > 1) {
        processedIds.add(id);
        detectedPages.push({
          id,
          name: navName,
          isConfirmed: false,
          hasContent: false
        });
      }
    }
    console.log('[buildFlowLive] After adding filtered nav names:', detectedPages.length, 'pages');
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STEP 3: Check for POSSIBLE comments in code
    // Pattern: <!-- POSSIBLE: Page not shown in video -->
    // ═══════════════════════════════════════════════════════════════════════════
    
    const possibleCommentRegex = /<!--\s*POSSIBLE:\s*([^-]+)\s*-->/gi;
    while ((match = possibleCommentRegex.exec(code)) !== null) {
      const possiblePage = match[1].trim().toLowerCase().replace(/[^a-z0-9]+/g, '-');
      const existing = detectedPages.find(p => p.id === possiblePage);
      if (existing) {
        existing.isConfirmed = false;
        existing.hasContent = false;
      }
    }
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STEP 4: Detect structural components for Home page
    // ═══════════════════════════════════════════════════════════════════════════
    
    const mainComponents: string[] = [];
    
    if (/<header/i.test(code)) mainComponents.push("Header");
    if (/<aside|sidebar/i.test(code)) mainComponents.push("Sidebar");
    if (/<nav/i.test(code)) mainComponents.push("Navigation");
    if (/grid|cards?/i.test(code)) mainComponents.push("Content Grid");
    if (/<main/i.test(code)) mainComponents.push("Main Content");
    if (/<footer/i.test(code)) mainComponents.push("Footer");
    
    if (mainComponents.length === 0) mainComponents.push("Page Content");
    
    // ═══════════════════════════════════════════════════════════════════════════
    // STEP 5: Build Flow Map with CONFIRMED and POSSIBLE nodes
    // ═══════════════════════════════════════════════════════════════════════════
    
    const centerX = 400;
    let currentY = 60;
    const rowHeight = 160;
    const colWidth = 200;
    
    // Separate confirmed from possible pages
    let confirmedPages = detectedPages.filter(p => p.isConfirmed);
    let possiblePages = detectedPages.filter(p => !p.isConfirmed);
    
    console.log('[buildFlowLive] Before fallback - confirmed:', confirmedPages.length, 'possible:', possiblePages.length);
    
    // ═══════════════════════════════════════════════════════════════════════════
    // FALLBACK: If no pages detected, extract from common page sections
    // ═══════════════════════════════════════════════════════════════════════════
    if (possiblePages.length === 0) {
      // Look for h1/h2 headings that might indicate page sections
      const headingRegex = /<h[12][^>]*>([^<]{3,40})<\/h[12]>/gi;
      let hm;
      while ((hm = headingRegex.exec(code)) !== null) {
        const text = hm[1].trim();
        const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        if (id.length > 2 && !processedIds.has(id)) {
          processedIds.add(id);
          possiblePages.push({
            id,
            name: text,
            isConfirmed: false,
            hasContent: false
          });
        }
      }
      console.log('[buildFlowLive] Added headings as pages:', possiblePages.length);
    }
    
    // If we have generated code but no confirmed pages, the entire page is "Home" - CONFIRMED
    if (confirmedPages.length === 0 && code.length > 500) {
      confirmedPages = [{
        id: 'home',
        name: 'Home',
        isConfirmed: true,
        hasContent: true,
        isAddedByAI: false
      }];
      
      // ALSO: Look for page titles/headings that indicate we visited specific pages
      // Common pattern: <h1>Startup Jobs</h1> means we visited "Startup Jobs" page
      const titleRegex = /<title>([^<]+)<\/title>|<h1[^>]*>([^<]{3,50})<\/h1>/gi;
      let titleMatch;
      while ((titleMatch = titleRegex.exec(code)) !== null) {
        const title = (titleMatch[1] || titleMatch[2] || '').trim();
        if (title && title.length > 2 && title.length < 50) {
          const pageId = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
          // Check if this title indicates a specific page (not just site name)
          const isSpecificPage = !/(home|main|welcome|index)/i.test(pageId) && 
                                 pageId.length > 3 &&
                                 !processedIds.has(pageId);
          if (isSpecificPage) {
            processedIds.add(pageId);
            // Move from possible to confirmed if it exists there
            const inPossibleIdx = possiblePages.findIndex(p => 
              p.id === pageId || 
              p.name.toLowerCase() === title.toLowerCase() ||
              p.id.includes(pageId) ||
              pageId.includes(p.id)
            );
            if (inPossibleIdx >= 0) {
              const page = possiblePages.splice(inPossibleIdx, 1)[0];
              page.isConfirmed = true;
              page.hasContent = true;
              confirmedPages.push(page);
              console.log('[buildFlowLive] Promoted to confirmed from title:', title);
            } else {
              confirmedPages.push({
                id: pageId,
                name: title,
                isConfirmed: true,
                hasContent: true,
                isAddedByAI: false
              });
              console.log('[buildFlowLive] Added confirmed from title:', title);
            }
          }
        }
      }
    }
    
    // Make sure Home is in confirmed if it exists
    const homeInPossible = possiblePages.findIndex(p => p.id === 'home' || p.id === 'glowna' || p.id === 'main');
    if (homeInPossible >= 0) {
      const homePage = possiblePages.splice(homeInPossible, 1)[0];
      homePage.isConfirmed = true;
      homePage.hasContent = true;
      confirmedPages.unshift(homePage);
    }
    
    // Entry node (Home or first confirmed page)
    const entryPage = confirmedPages[0] || { id: 'home', name: 'Home', isConfirmed: true, hasContent: true, isAddedByAI: false };
    
    await addNode({
      id: entryPage.id,
      name: entryPage.name,
      type: "view",
      description: entryPage.isAddedByAI ? "Generated by AI based on site context" : "Shown and confirmed in the video recording",
      x: centerX,
      y: currentY,
      components: mainComponents,
      status: entryPage.isAddedByAI ? "added" : "observed",
      confidence: entryPage.isAddedByAI ? "medium" : "high"
    });
    
    currentY += rowHeight;
    
    // Add CONFIRMED pages (other than entry)
    const otherConfirmed = confirmedPages.filter(p => p.id !== entryPage.id);
    if (otherConfirmed.length > 0) {
      const startX = centerX - ((otherConfirmed.length - 1) * colWidth) / 2;
      
      for (let i = 0; i < otherConfirmed.length; i++) {
        const page = otherConfirmed[i];
        const x = startX + i * colWidth;
        
        await addNode({
          id: page.id,
          name: page.name,
          type: "view",
          description: page.isAddedByAI ? "Generated by AI based on site context" : "Shown and confirmed in the video recording",
          x: x,
          y: currentY,
          components: page.hasContent ? ["Content"] : [],
          status: page.isAddedByAI ? "added" : "observed",
          confidence: page.isAddedByAI ? "medium" : "high"
        });
        
        await addEdge({
          id: `${entryPage.id}-${page.id}`,
          from: entryPage.id,
          to: page.id,
          label: "Navigate",
          type: "navigation"
        });
      }
      
      currentY += rowHeight;
    }
    
    // Add POSSIBLE pages (navigation items not shown in video)
    // Use wider spacing to prevent overlap - nodes are ~200px wide
    if (possiblePages.length > 0) {
      // Show ALL possible pages, not just 8 - user wants full detection
      const displayItems = possiblePages.slice(0, 24); // Allow up to 24 items
      const nodeSpacing = 240; // Width of node + gap (prevents overlap)
      
      // Calculate how many can fit per row (max 5 per row for wider displays)
      const nodesPerRow = Math.min(5, Math.max(3, Math.ceil(displayItems.length / 4)));
      const totalRows = Math.ceil(displayItems.length / nodesPerRow);
      
      console.log('[buildFlowLive] Displaying', displayItems.length, 'possible pages in', totalRows, 'rows');
      
      for (let row = 0; row < totalRows; row++) {
        const rowItems = displayItems.slice(row * nodesPerRow, (row + 1) * nodesPerRow);
        const rowStartX = centerX - ((rowItems.length - 1) * nodeSpacing) / 2;
        
        for (let i = 0; i < rowItems.length; i++) {
          const page = rowItems[i];
          const x = rowStartX + i * nodeSpacing;
          const y = currentY + row * rowHeight;
          
          await addNode({
            id: page.id,
            name: page.name,
            type: "view",
            description: "Present in navigation, but not shown in video",
            x: x,
            y: y,
            components: [],
            status: "detected",
            confidence: "medium"
          });
          
          await addEdge({
            id: `${entryPage.id}-${page.id}`,
            from: entryPage.id,
            to: page.id,
            label: "Possible",
            type: "possible"
          });
        }
      }
      
      // Update currentY for any future nodes
      currentY += totalRows * rowHeight;
    }
    
    setFlowBuilding(false);
  };

  // Extract style info from code - with actual fonts and colors
  const extractStyleInfo = (code: string): StyleInfo => {
    const colors: { name: string; value: string }[] = [];
    
    // Extract hex colors
    const hexMatches = code.match(/#[0-9A-Fa-f]{6}|#[0-9A-Fa-f]{3}/g) || [];
    // Extract rgb/rgba colors
    const rgbMatches = code.match(/rgba?\([^)]+\)/g) || [];
    
    // Prioritize actual color values, filter out common neutrals at the end
    const allColors = [...hexMatches, ...rgbMatches];
    const neutrals = ['#fff', '#ffffff', '#000', '#000000', '#fff', 'rgba(0', 'rgb(0', 'rgba(255', 'rgb(255'];
    
    const colorFrequency: Record<string, number> = {};
    allColors.forEach(c => {
      const normalized = c.toLowerCase();
      colorFrequency[normalized] = (colorFrequency[normalized] || 0) + 1;
    });
    
    // Sort by frequency and filter out pure black/white
    const sortedColors = Object.entries(colorFrequency)
      .sort((a, b) => b[1] - a[1])
      .filter(([c]) => !neutrals.some(n => c.startsWith(n)))
      .slice(0, 4);
    
    // Add back black/white at end if space
    const finalColors = sortedColors.map(([c]) => c);
    if (finalColors.length < 6 && hexMatches.some(c => c.toLowerCase() === '#ffffff' || c.toLowerCase() === '#fff')) {
      finalColors.push('#ffffff');
    }
    if (finalColors.length < 6 && hexMatches.some(c => c.toLowerCase() === '#000000' || c.toLowerCase() === '#000')) {
      finalColors.push('#000000');
    }
    
    finalColors.slice(0, 6).forEach((c, i) => {
      const names = ["Primary", "Secondary", "Accent", "Background", "Text", "Border"];
      colors.push({ name: names[i] || `Color ${i + 1}`, value: c });
    });
    
    // If no colors found, use defaults
    if (colors.length === 0) {
      colors.push({ name: "Primary", value: "#6366f1" });
      colors.push({ name: "Background", value: "#ffffff" });
    }
    
    const fonts: { name: string; usage: string; weight: string; family: string }[] = [];
    
    // Extract actual font families from code
    const fontFamilyMatch = code.match(/font-family:\s*['"]?([^'";,]+)/gi) || [];
    const googleFontsMatch = code.match(/family=([^&:]+)/gi) || [];
    
    const detectedFonts = new Set<string>();
    
    fontFamilyMatch.forEach(f => {
      const name = f.replace(/font-family:\s*['"]?/i, '').trim();
      if (name && !name.includes('sans-serif') && !name.includes('system') && name.length < 30) {
        detectedFonts.add(name);
      }
    });
    
    googleFontsMatch.forEach(f => {
      const name = f.replace(/family=/i, '').replace(/\+/g, ' ').split(':')[0].trim();
      if (name && name.length < 30) detectedFonts.add(name);
    });
    
    // Check for common font names in code
    const commonFonts = ["Inter", "Space Grotesk", "Poppins", "Roboto", "Open Sans", "Montserrat", "Nunito", "Lato", "Raleway", "Playfair Display"];
    commonFonts.forEach(font => {
      if (code.includes(font)) detectedFonts.add(font);
    });
    
    Array.from(detectedFonts).slice(0, 4).forEach((font, i) => {
      fonts.push({ 
        name: font, 
        usage: i === 0 ? "Primary font" : i === 1 ? "Secondary font" : "Accent font",
        weight: "400-700",
        family: `'${font}', sans-serif`
      });
    });
    
    if (fonts.length === 0) {
      fonts.push({ name: "System UI", usage: "Default", weight: "400", family: "system-ui, sans-serif" });
    }
    
    return {
      colors,
      fonts,
      spacing: code.includes("gap-") || code.includes("space-") ? "Tailwind spacing scale" : "Custom spacing",
      borderRadius: code.includes("rounded-xl") || code.includes("rounded-2xl") ? "Large (12-16px)" : code.includes("rounded-lg") ? "Medium (8px)" : "Small (4px)",
      shadows: code.includes("shadow-xl") || code.includes("shadow-2xl") ? "Prominent shadows" : code.includes("shadow") ? "Subtle shadows" : "Minimal shadows"
    };
  };

  // Generate file structure from code based on Structure/Flow nodes
  // Supports both single-file (HTML) and componentized (TSX) modes
  const generateFileStructure = useCallback((code: string, nodes: ProductFlowNode[], mode: CodeMode): FileNode[] => {
    const files: FileNode[] = [];
    
    // Extract Alpine.js pages from the code - IMPROVED detection
    const extractAlpinePages = (): { id: string; name: string; content: string; isConfirmed: boolean }[] => {
      const pages: { id: string; name: string; content: string; isConfirmed: boolean }[] = [];
      const processedIds = new Set<string>();
      
      // First find all page identifiers
      const pageIdRegex = /x-show\s*=\s*["'](?:currentPage|page|activeTab|activeView)\s*===?\s*['"]([^'"]+)['"]/gi;
      const pageIdentifiers: string[] = [];
      let match;
      
      while ((match = pageIdRegex.exec(code)) !== null) {
        if (!pageIdentifiers.includes(match[1])) {
          pageIdentifiers.push(match[1]);
        }
      }
      
      // For each identifier, extract its content
      for (const pageId of pageIdentifiers) {
        const normalizedId = pageId.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        if (processedIds.has(normalizedId)) continue;
        processedIds.add(normalizedId);
        
        // Look for the content - find the element with x-show and get its innerHTML
        const escapedPageId = pageId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const contentRegex = new RegExp(
          `<(?:main|div|section)[^>]*x-show\\s*=\\s*["'](?:currentPage|page|activeTab|activeView)\\s*===?\\s*['"]${escapedPageId}['"][^>]*>([\\s\\S]*?)(?=<(?:main|div|section)[^>]*x-show\\s*=|</body>|$)`,
          'i'
        );
        const contentMatch = code.match(contentRegex);
        const content = contentMatch ? contentMatch[0] : '';
        
        const isConfirmed = content.length > 100 && 
                           !content.includes('POSSIBLE:') && 
                           !content.includes('Page not shown in video') &&
                           !content.includes('not yet created');
        
        pages.push({
          id: normalizedId,
          name: pageId.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
          content: content,
          isConfirmed
        });
      }
      
      return pages;
    };
    
    const detectedPages = extractAlpinePages();
    const confirmedPages = detectedPages.filter(p => p.isConfirmed);
    
    if (mode === "single-file") {
      // Single-file mode: main HTML file with all pages in one file
      files.push({
        path: "/pages/index.html",
        name: "index.html",
        content: code,
        type: "page",
        language: "html",
        sourceNodeId: "home",
        lineCount: code.split('\n').length
      });
      
      // Show confirmed pages as indicators in file tree (but they're in main file)
      confirmedPages.forEach(page => {
        if (page.id !== 'home' && page.id !== 'glowna' && page.id !== 'main') {
          files.push({
            path: `/pages/${page.id}.html`,
            name: `${page.id}.html`,
            content: `<!-- This page is embedded in index.html as Alpine.js view: ${page.name} -->
<!-- To view, look for: x-show="currentPage === '${page.id}'" in index.html -->
${page.content}`,
            type: "page",
            language: "html",
            sourceNodeId: page.id,
            lineCount: page.content.split('\n').length
          });
        }
      });
      
      // Only add stub files for detected/possible pages (not observed yet)
      nodes.filter(n => (n.status === "detected" || n.status === "possible") && n.type === "view").forEach(node => {
        // Don't add stub if we already have this page
        if (files.some(f => f.sourceNodeId === node.id)) return;
        
        const stubContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${node.name}</title>
</head>
<body>
  <!-- POSSIBLE: This page was in navigation but not shown in video -->
  <div class="min-h-screen bg-gray-900 text-white flex items-center justify-center">
    <div class="text-center">
      <h1 class="text-3xl font-bold mb-4">${node.name}</h1>
      <p class="text-gray-400">Page not yet created. Click "Create" to generate this page.</p>
    </div>
  </div>
</body>
</html>`;
        files.push({
          path: `/pages/${node.id}.html`,
          name: `${node.id}.html`,
          content: stubContent,
          type: "stub",
          language: "html",
          sourceNodeId: node.id,
          isStub: true,
          lineCount: stubContent.split('\n').length
        });
      });
    } else {
      // Componentized mode: Create proper Next.js pages from detected Alpine.js pages
      const homeNode = nodes.find(n => n.id === "home" || n.id === "dashboard");
      const components = homeNode?.components || [];
      const componentFiles: FileNode[] = [];
      
      // Extract body content from full HTML
      const bodyMatch = code.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      const fullBodyContent = bodyMatch ? bodyMatch[1] : code;
      
      // Also detect all Alpine.js pages in the code
      const alpinePageRegex = /x-show\s*=\s*["'](?:currentPage|page|activeTab|activeView)\s*===?\s*['"]([^'"]+)['"][^>]*>([\s\S]*?)(?=<(?:main|div|section)[^>]*x-show\s*=|<\/body>)/gi;
      const detectedAlpinePages: { id: string; name: string; content: string }[] = [];
      let alpineMatch;
      while ((alpineMatch = alpinePageRegex.exec(code)) !== null) {
        const pageId = alpineMatch[1].toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const pageName = alpineMatch[1].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const content = alpineMatch[0];
        // Include pages with actual content
        if (content.length > 100 && !content.includes('POSSIBLE:') && !content.includes('not shown in video')) {
          detectedAlpinePages.push({ id: pageId, name: pageName, content });
        }
      }
      
      console.log('[generateFileStructure] Detected Alpine pages:', detectedAlpinePages.map(p => p.id));
      
      // Better extraction patterns for actual HTML sections
      const extractComponent = (compName: string): string => {
        const compId = compName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        const compNameClean = compName.toLowerCase();
        
        let extracted = '';
        
        // 1. Try to find semantic HTML elements directly
        if (compNameClean.includes('navigation') || compNameClean.includes('nav') || compNameClean.includes('sidebar')) {
          // Try nav first, then aside (sidebar)
          const navMatch = code.match(/<nav[^>]*>[\s\S]*?<\/nav>/i);
          const asideMatch = code.match(/<aside[^>]*>[\s\S]*?<\/aside>/i);
          extracted = navMatch?.[0] || asideMatch?.[0] || '';
        } else if (compNameClean.includes('header')) {
          const headerMatch = code.match(/<header[^>]*>[\s\S]*?<\/header>/i);
          extracted = headerMatch?.[0] || '';
        } else if (compNameClean.includes('footer')) {
          const footerMatch = code.match(/<footer[^>]*>[\s\S]*?<\/footer>/i);
          extracted = footerMatch?.[0] || '';
        } else if (compNameClean.includes('hero')) {
          // Hero is usually first section or div with hero class
          const heroMatch = code.match(/<section[^>]*class="[^"]*hero[^"]*"[^>]*>[\s\S]*?<\/section>/i) ||
                          code.match(/<div[^>]*class="[^"]*hero[^"]*"[^>]*>[\s\S]*?<\/div>/i) ||
                          code.match(/<section[^>]*>[\s\S]*?<\/section>/i); // First section as fallback
          extracted = heroMatch?.[0] || '';
        } else if (compNameClean.includes('main') || compNameClean.includes('content')) {
          const mainMatch = code.match(/<main[^>]*>[\s\S]*?<\/main>/i);
          extracted = mainMatch?.[0] || '';
        } else if (compNameClean.includes('grid') || compNameClean.includes('card')) {
          // Look for grid/card containers
          const gridMatch = code.match(/<div[^>]*class="[^"]*(?:grid|cards)[^"]*"[^>]*>[\s\S]*?<\/div>/i);
          extracted = gridMatch?.[0] || '';
        } else if (compNameClean.includes('section')) {
          // Get all sections
          const sectionMatches = code.match(/<section[^>]*>[\s\S]*?<\/section>/gi) || [];
          extracted = sectionMatches.join('\n\n');
        } else {
          // 2. Try to find element with matching ID or class
          const patterns = [
            new RegExp(`<section[^>]*id="[^"]*${compId}[^"]*"[^>]*>[\\s\\S]*?</section>`, 'i'),
            new RegExp(`<section[^>]*class="[^"]*${compId}[^"]*"[^>]*>[\\s\\S]*?</section>`, 'i'),
            new RegExp(`<div[^>]*id="[^"]*${compId}[^"]*"[^>]*>[\\s\\S]*?</div>`, 'i'),
            new RegExp(`<div[^>]*class="[^"]*${compId}[^"]*"[^>]*>[\\s\\S]*?</div>`, 'i'),
          ];
          
          for (const pattern of patterns) {
            const match = code.match(pattern);
            if (match) {
              extracted = match[0];
              break;
            }
          }
          
          // 3. Try to find a section that contains a heading with this name
          if (!extracted) {
            const sectionRegex = /<section[^>]*>([\s\S]*?)<\/section>/gi;
            let match;
            while ((match = sectionRegex.exec(code)) !== null) {
              const sectionContent = match[0];
              // Check if section contains heading with component name (case insensitive)
              const nameWords = compName.split(/\s+/).filter(w => w.length > 2);
              const hasMatch = nameWords.some(word => 
                new RegExp(`<h[1-3][^>]*>[^<]*${word}[^<]*</h[1-3]>`, 'i').test(sectionContent)
              );
              if (hasMatch) {
                extracted = sectionContent;
                break;
              }
            }
          }
        }
        
        // If still nothing, return a meaningful placeholder
        if (!extracted) {
          return `<!-- ${compName}: Component content not found in generated HTML -->
<div class="${compId}">
  <!-- This component could not be automatically extracted -->
  <!-- The original HTML may not have a distinct section for "${compName}" -->
</div>`;
        }
        
        return extracted;
      };
      
      // Extract each component
      components.forEach((compName) => {
        const compId = compName.toLowerCase().replace(/\s+/g, '-');
        const componentContent = extractComponent(compName);
        
        const folder = compName.toLowerCase().includes('header') || 
                      compName.toLowerCase().includes('footer') || 
                      compName.toLowerCase().includes('navigation') ||
                      compName.toLowerCase().includes('nav')
          ? 'layout' 
          : 'sections';
        
        const reactComponent = wrapAsReactComponent(compName, componentContent);
        
        componentFiles.push({
          path: `/components/${folder}/${compId}.tsx`,
          name: `${compId}.tsx`,
          content: reactComponent,
          type: "component",
          language: "tsx",
          sourceNodeId: "home",
          lineCount: reactComponent.split('\n').length
        });
      });
      
      // Main page file - use first detected page or full body content
      const mainPageId = detectedAlpinePages.length > 0 ? detectedAlpinePages[0].id : 'home';
      const mainPageContent = detectedAlpinePages.length > 0 
        ? wrapAsReactComponent(detectedAlpinePages[0].name, detectedAlpinePages[0].content)
        : generateMainPageFile(components, fullBodyContent);
      
      files.push({
        path: "/pages/index.tsx",
        name: "index.tsx",
        content: mainPageContent,
        type: "page",
        language: "tsx",
        sourceNodeId: mainPageId,
        lineCount: mainPageContent.split('\n').length
      });
      
      // Add page files for all detected Alpine.js pages (skip first one as it's index)
      detectedAlpinePages.slice(1).forEach(page => {
        // Skip home/main/index as we already have that
        if (page.id === 'home' || page.id === 'glowna' || page.id === 'main' || page.id === 'index') return;
        
        const pageComponent = wrapAsReactComponent(page.name, page.content);
        files.push({
          path: `/pages/${page.id}.tsx`,
          name: `${page.id}.tsx`,
          content: pageComponent,
          type: "page",
          language: "tsx",
          sourceNodeId: page.id,
          lineCount: pageComponent.split('\n').length
        });
      });
      
      // Also add pages from flow nodes that are observed
      nodes.filter(n => n.status === "observed" && n.type === "view")
        .forEach(node => {
          // Skip if we already have this page
          if (files.some(f => f.sourceNodeId === node.id)) return;
          // Skip generic home/index
          if (node.id === 'home' || node.id === 'index' || node.id === 'main') return;
          
          // Try to extract content for this page from the code using multiple patterns
          const patterns = [
            new RegExp(`x-show\\s*=\\s*["'][^"']*${node.id}[^"']*["'][^>]*>([\\s\\S]*?)(?=<(?:main|div|section)[^>]*x-show|<\\/body>)`, 'i'),
            new RegExp(`x-show\\s*=\\s*["']currentPage\\s*===?\\s*['"]${node.id}["'][^>]*>([\\s\\S]*?)(?=<(?:main|div|section)[^>]*x-show|<\\/body>)`, 'i'),
          ];
          
          let content = '';
          for (const pattern of patterns) {
            const match = code.match(pattern);
            if (match && match[0].length > 100) {
              content = match[0];
              break;
            }
          }
          
          // If no content found, create a proper placeholder
          if (!content || content.length < 100) {
            content = `<main className="min-h-screen bg-gray-50">
              <div className="container mx-auto px-4 py-16">
                <h1 className="text-4xl font-bold mb-8">${node.name}</h1>
                <p className="text-gray-600">This page content was not captured in the video.</p>
              </div>
            </main>`;
          }
          
          const pageComponent = wrapAsReactComponent(node.name, content);
          files.push({
            path: `/pages/${node.id}.tsx`,
            name: `${node.id}.tsx`,
            content: pageComponent,
            type: "page",
            language: "tsx",
            sourceNodeId: node.id,
            lineCount: pageComponent.split('\n').length
          });
        });
      
      // Extract and add layout components (Header, Sidebar, Navigation, Footer)
      const layoutComponents: { name: string; selector: RegExp; path: string }[] = [
        { name: 'Header', selector: /<header[^>]*>[\s\S]*?<\/header>/i, path: '/components/layout/Header.tsx' },
        { name: 'Sidebar', selector: /<aside[^>]*>[\s\S]*?<\/aside>/i, path: '/components/layout/Sidebar.tsx' },
        { name: 'Navigation', selector: /<nav[^>]*>[\s\S]*?<\/nav>/i, path: '/components/layout/Navigation.tsx' },
        { name: 'Footer', selector: /<footer[^>]*>[\s\S]*?<\/footer>/i, path: '/components/layout/Footer.tsx' },
      ];
      
      layoutComponents.forEach(({ name, selector, path }) => {
        const match = code.match(selector);
        if (match && match[0].length > 50) {
          const componentContent = wrapAsReactComponent(name, match[0]);
          files.push({
            path,
            name: `${name}.tsx`,
            content: componentContent,
            type: "component",
            language: "tsx",
            sourceNodeId: "layout",
            lineCount: componentContent.split('\n').length
          });
        }
      });
      
      files.push(...componentFiles);
      
      // === BARREL FILES FOR CLEAN IMPORTS ===
      // Generate index.ts files for each component folder
      
      // Layout barrel file
      const layoutComponentNames = files
        .filter(f => f.path.startsWith('/components/layout/') && f.name !== 'index.ts')
        .map(f => f.name.replace('.tsx', ''));
      
      if (layoutComponentNames.length > 0) {
        const layoutBarrelContent = `/**
 * Layout Components Barrel Export
 * Import: import { Header, Footer } from "@/components/layout"
 */
${layoutComponentNames.map(name => `export { ${name} } from './${name}';`).join('\n')}
`;
        files.push({
          path: "/components/layout/index.ts",
          name: "index.ts",
          content: layoutBarrelContent,
          type: "component",
          language: "ts",
          lineCount: layoutBarrelContent.split('\n').length
        });
      }
      
      // Sections barrel file
      const sectionComponents = files
        .filter(f => f.path.startsWith('/components/sections/') && f.name !== 'index.ts')
        .map(f => f.name.replace('.tsx', ''));
      
      if (sectionComponents.length > 0) {
        const sectionsBarrelContent = `/**
 * Section Components Barrel Export
 * Import: import { HeroSection, FeaturesSection } from "@/components/sections"
 */
${sectionComponents.map(name => `export { ${name} } from './${name}';`).join('\n')}
`;
        files.push({
          path: "/components/sections/index.ts",
          name: "index.ts",
          content: sectionsBarrelContent,
          type: "component",
          language: "ts",
          lineCount: sectionsBarrelContent.split('\n').length
        });
      }
      
      // UI barrel file (for common UI primitives)
      const uiBarrelContent = `/**
 * UI Primitives Barrel Export
 * Import: import { Button, Card, Badge } from "@/components/ui"
 */
// This file will contain re-exports of UI primitives
// Add your component exports here as you create them
`;
      files.push({
        path: "/components/ui/index.ts",
        name: "index.ts",
        content: uiBarrelContent,
        type: "component",
        language: "ts",
        lineCount: uiBarrelContent.split('\n').length
      });
      
      // Add layout wrapper for Next.js App Router
      const layoutContent = `// Next.js App Router Layout
import './globals.css';

export const metadata = {
  title: 'Generated App',
  description: 'Generated by Replay from video',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        {children}
      </body>
    </html>
  );
}`;
      
      files.push({
        path: "/app/layout.tsx",
        name: "layout.tsx",
        content: layoutContent,
        type: "component",
        language: "tsx",
        lineCount: layoutContent.split('\n').length
      });
      
      // Add tokens file
      const tokensContent = generateTokensFile(extractStyleInfo(code));
      files.push({
        path: "/styles/tokens.ts",
        name: "tokens.ts",
        content: tokensContent,
        type: "style",
        language: "ts",
        lineCount: tokensContent.split('\n').length
      });
      
      // Add globals.css with extracted styles
      const styleMatch = code.match(/<style[^>]*>([\s\S]*?)<\/style>/i);
      const extractedStyles = styleMatch ? styleMatch[1] : '';
      const globalsCss = `/* Generated styles from video analysis */
@tailwind base;
@tailwind components;
@tailwind utilities;

${extractedStyles}
`;
      files.push({
        path: "/app/globals.css",
        name: "globals.css",
        content: globalsCss,
        type: "style",
        language: "css",
        lineCount: globalsCss.split('\n').length
      });
    }
    
    return files;
  }, []);
  
  // Helper: Convert HTML to JSX (comprehensive conversion)
  const htmlToJsx = (html: string): string => {
    return html
      // STEP 1: Remove Vue/Alpine template wrappers - replace with content
      .replace(/<template\s+:key="[^"]*">\s*/gi, '{/* ')
      .replace(/<template\s+v-for="[^"]*">\s*/gi, '{/* ')
      .replace(/<template>\s*/gi, '')
      .replace(/\s*<\/template>/gi, ' */}')
      // STEP 2: Convert Vue :key to React key
      .replace(/:key=/g, 'key=')
      // STEP 3: Convert Vue :className to className (dynamic)
      .replace(/:className="([^"]*)"/g, 'className={$1}')
      // STEP 4: Convert Vue :class to className (dynamic)
      .replace(/:class="([^"]*)"/g, 'className={$1}')
      // STEP 5: Convert regular class to className
      .replace(/\bclass=/g, 'className=')
      // STEP 6: Convert for to htmlFor
      .replace(/\bfor=/g, 'htmlFor=')
      // STEP 7: Self-closing tags
      .replace(/<(img|input|br|hr|meta|link)([^>]*)(?<!\/)>/gi, '<$1$2 />')
      // STEP 8: Convert inline style strings to objects
      .replace(/style="([^"]*)"/g, (match, style) => {
        if (!style.trim()) return 'style={{}}';
        const jsStyle = style.split(';')
          .filter((s: string) => s.trim())
          .map((s: string) => {
            const colonIndex = s.indexOf(':');
            if (colonIndex === -1) return '';
            const prop = s.substring(0, colonIndex).trim();
            const val = s.substring(colonIndex + 1).trim();
            const camelProp = prop.replace(/-([a-z])/g, (g: string) => g[1].toUpperCase());
            // Handle numeric values
            const isNumeric = !isNaN(parseFloat(val)) && !val.includes('px') && !val.includes('%') && !val.includes('em');
            const formattedVal = isNumeric ? val : `'${val.replace(/'/g, "\\'")}'`;
            return `${camelProp}: ${formattedVal}`;
          })
          .filter(Boolean)
          .join(', ');
        return `style={{ ${jsStyle} }}`;
      })
      // STEP 9: Remove Alpine.js x-* attributes
      .replace(/\s*x-[a-z-]+="[^"]*"/gi, '')
      .replace(/\s*x-[a-z-]+/gi, '')
      // STEP 10: Remove Alpine @ event handlers
      .replace(/\s*@[a-z.]+="[^"]*"/gi, '')
      // STEP 11: Remove Vue v-* directives
      .replace(/\s*v-[a-z-]+="[^"]*"/gi, '')
      .replace(/\s*v-[a-z-]+/gi, '')
      // STEP 12: Remove inline onclick/onmouseover etc
      .replace(/\s*on[a-z]+="[^"]*"/gi, '')
      // STEP 13: Convert tabindex to tabIndex
      .replace(/\btabindex=/gi, 'tabIndex=')
      // STEP 14: Convert colspan/rowspan
      .replace(/\bcolspan=/gi, 'colSpan=')
      .replace(/\browspan=/gi, 'rowSpan=')
      // STEP 15: Convert maxlength, minlength
      .replace(/\bmaxlength=/gi, 'maxLength=')
      .replace(/\bminlength=/gi, 'minLength=')
      // STEP 16: Convert autocomplete
      .replace(/\bautocomplete=/gi, 'autoComplete=')
      // STEP 17: Convert autofocus
      .replace(/\bautofocus/gi, 'autoFocus')
      // STEP 18: Clean up escaped characters
      .replace(/`/g, "'")
      // STEP 19: Remove HTML comments
      .replace(/<!--[\s\S]*?-->/g, '')
      // STEP 20: Remove any remaining :attr Vue syntax
      .replace(/\s*:[a-z-]+="[^"]*"/gi, '')
      .trim();
  };

  // Helper: Wrap HTML content as React component (proper JSX)
  const wrapAsReactComponent = (name: string, htmlContent: string): string => {
    const componentName = name.replace(/[^a-zA-Z0-9]/g, '');
    
    // Convert HTML to JSX
    const jsxContent = htmlToJsx(htmlContent);
    
    // If content is just a comment (not extracted), create a placeholder
    if (jsxContent.startsWith('<!--') && jsxContent.length < 100) {
      return `export default function ${componentName}Page() {
  return (
    <main className="min-h-screen bg-white">
      <div className="container mx-auto px-4 py-16">
        <h1 className="text-4xl font-bold mb-8">${name}</h1>
        {/* Content will be generated here */}
      </div>
    </main>
  );
}`;
    }
    
    // For pages with actual content, wrap properly
    return `export default function ${componentName}Page() {
  return (
    <>
      ${jsxContent}
    </>
  );
}`;
  };
  
  // Helper: Generate main page file for Next.js App Router
  const generateMainPageFile = (components: string[], fullHtmlContent?: string): string => {
    // If we have full HTML content, convert it to JSX for the main page
    if (fullHtmlContent) {
      const jsxContent = htmlToJsx(fullHtmlContent);
      
      // Extract body content only (between <body> and </body>)
      const bodyMatch = jsxContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      const bodyContent = bodyMatch ? bodyMatch[1].trim() : jsxContent;
      
      return `// Next.js App Router Page
// Generated by Replay from video analysis

export default function HomePage() {
  return (
    <>
      ${bodyContent}
    </>
  );
}`;
    }
    
    // Fallback: Generate with component imports
    if (components.length === 0) {
      return `// Next.js App Router Page
// Generated by Replay

export default function HomePage() {
  return (
    <main className="min-h-screen">
      {/* Page content - switch to Single-file view to see full HTML */}
    </main>
  );
}`;
    }
    
    const imports = components.map(comp => {
      const compName = comp.replace(/\s+/g, '');
      const compId = comp.toLowerCase().replace(/\s+/g, '-');
      const folder = comp.toLowerCase().includes('header') || comp.toLowerCase().includes('footer') || comp.toLowerCase().includes('navigation') 
        ? 'layout' 
        : 'sections';
      return `import ${compName} from '@/components/${folder}/${compId}';`;
    }).join('\n');
    
    const componentUsage = components.map(comp => {
      const compName = comp.replace(/\s+/g, '');
      return `      <${compName} />`;
    }).join('\n');
    
    return `// Next.js App Router Page
${imports}

export default function HomePage() {
  return (
    <main className="min-h-screen">
${componentUsage}
    </main>
  );
}`;
  };
  
  // Helper: Generate tokens file from style info
  const generateTokensFile = (style: StyleInfo): string => {
    const colorTokens = style.colors.map(c => `  '${c.name.toLowerCase()}': '${c.value}',`).join('\n');
    const fontTokens = style.fonts.map(f => `  '${f.name.toLowerCase().replace(/\s+/g, '-')}': '${f.family}',`).join('\n');
    
    return `// Design System Tokens
// Generated from video analysis

export const colors = {
${colorTokens}
};

export const fonts = {
${fontTokens}
};

export const spacing = {
  xs: '0.25rem',
  sm: '0.5rem',
  md: '1rem',
  lg: '1.5rem',
  xl: '2rem',
  '2xl': '3rem',
};

export const borderRadius = {
  sm: '0.25rem',
  md: '0.5rem',
  lg: '0.75rem',
  xl: '1rem',
  full: '9999px',
};

export const shadows = {
  sm: '0 1px 2px rgba(0, 0, 0, 0.05)',
  md: '0 4px 6px rgba(0, 0, 0, 0.1)',
  lg: '0 10px 15px rgba(0, 0, 0, 0.1)',
  xl: '0 20px 25px rgba(0, 0, 0, 0.15)',
};
`;
  };
  
  // ===========================================
  // AGENT MODE - Generate AI-enhanced code pack
  // ===========================================
  
  // Generate Agent Pack instructions for Cursor/v0
  const generateAgentInstructions = useCallback((projectName: string, nodes: ProductFlowNode[]): string => {
    const pages = nodes.filter(n => n.type === "view");
    const components = nodes.flatMap(n => n.components || []);
    
    return `/*
╔══════════════════════════════════════════════════════════════════════════════╗
║                           REPLAY AGENT PACK                                   ║
║                    AI-Optimized Code Context for Cursor/v0                   ║
╚══════════════════════════════════════════════════════════════════════════════╝

PROJECT: ${projectName || 'Untitled Project'}
GENERATED BY: Replay (https://replay.build)
DATE: ${new Date().toLocaleDateString()}

═══════════════════════════════════════════════════════════════════════════════
                              QUICK START GUIDE
═══════════════════════════════════════════════════════════════════════════════

This code was reconstructed from a video recording by Replay AI. It includes:
• Full HTML/CSS layout with Tailwind styling
• Alpine.js for interactivity and page navigation
• Responsive design patterns
• All visible UI components from the video

🎯 HOW TO USE IN CURSOR:
1. Paste this entire file into your project
2. Ask Cursor: "Convert this to React/Next.js components"
3. Or ask: "Add [feature] to the [section]"
4. Or ask: "Change the color scheme to [theme]"

═══════════════════════════════════════════════════════════════════════════════
                              PAGE STRUCTURE
═══════════════════════════════════════════════════════════════════════════════

${pages.map(p => '• ' + p.name + ' (' + (p.status === 'observed' ? '✅ Observed in video' : '⚠️ Detected in navigation') + ')').join('\n')}

═══════════════════════════════════════════════════════════════════════════════
                              COMPONENTS
═══════════════════════════════════════════════════════════════════════════════

${components.length > 0 ? components.map(c => '• ' + c).join('\n') : '• See inline comments for component boundaries'}

═══════════════════════════════════════════════════════════════════════════════
                              AI CONTEXT MARKERS
═══════════════════════════════════════════════════════════════════════════════

Look for these markers in the code:
• <!-- COMPONENT: Name --> = Component boundary
• <!-- PAGE: Name --> = Page/view boundary  
• <!-- INTERACTIVE --> = Has click/hover behavior
• <!-- RESPONSIVE --> = Has mobile breakpoints
• <!-- NAVIGATION --> = Links to other pages

═══════════════════════════════════════════════════════════════════════════════
                              EXAMPLE PROMPTS FOR AI
═══════════════════════════════════════════════════════════════════════════════

Try these prompts in Cursor or v0:

1. "Extract the header into a reusable React component"
2. "Add a dark mode toggle that persists to localStorage"
3. "Convert the Alpine.js navigation to React Router"
4. "Add form validation to the contact form"
5. "Make the cards grid display 2 columns on mobile"
6. "Add smooth scroll animations on page load"
7. "Connect this to Supabase and fetch real data"

═══════════════════════════════════════════════════════════════════════════════
*/

`;
  }, []);
  
  // Enhance code with AI context comments
  const enhanceCodeWithAgentContext = useCallback((code: string): string => {
    let enhanced = code;
    
    // Add component boundary markers
    enhanced = enhanced
      // Mark header
      .replace(/<header([^>]*)>/gi, '<!-- COMPONENT: Header -->\n<header$1>')
      // Mark navigation
      .replace(/<nav([^>]*)>/gi, '<!-- COMPONENT: Navigation -->\n<nav$1>')
      // Mark footer  
      .replace(/<footer([^>]*)>/gi, '<!-- COMPONENT: Footer -->\n<footer$1>')
      // Mark aside/sidebar
      .replace(/<aside([^>]*)>/gi, '<!-- COMPONENT: Sidebar -->\n<aside$1>')
      // Mark main content
      .replace(/<main([^>]*)>/gi, '<!-- COMPONENT: MainContent -->\n<main$1>')
      // Mark forms
      .replace(/<form([^>]*)>/gi, '<!-- COMPONENT: Form - Add validation here -->\n<!-- INTERACTIVE -->\n<form$1>')
      // Mark buttons with actions
      .replace(/<button([^>]*@click[^>]*)>/gi, '<!-- INTERACTIVE -->\n<button$1>')
      // Mark links that navigate
      .replace(/@click="currentPage\s*=\s*'([^']+)'"/gi, '@click="currentPage=\'$1\'" <!-- NAVIGATION: to $1 -->')
      // Mark Alpine.js page views
      .replace(/x-show="currentPage\s*===?\s*'([^']+)'"/gi, 'x-show="currentPage===\'$1\'" <!-- PAGE: $1 -->');
    
    // Add section markers for common patterns
    const sectionPatterns = [
      { pattern: /<section([^>]*class="[^"]*hero[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: Hero -->\n' },
      { pattern: /<section([^>]*class="[^"]*features?[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: Features -->\n' },
      { pattern: /<section([^>]*class="[^"]*pricing[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: Pricing -->\n' },
      { pattern: /<section([^>]*class="[^"]*testimonials?[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: Testimonials -->\n' },
      { pattern: /<section([^>]*class="[^"]*faq[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: FAQ -->\n' },
      { pattern: /<section([^>]*class="[^"]*contact[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: Contact -->\n' },
      { pattern: /<section([^>]*class="[^"]*cta[^"]*"[^>]*)>/gi, marker: '<!-- SECTION: CTA -->\n' },
    ];
    
    sectionPatterns.forEach(({ pattern, marker }) => {
      enhanced = enhanced.replace(pattern, marker + '<section$1>');
    });
    
    return enhanced;
  }, []);
  
  // Get code content with optional Agent Mode enhancements
  const getAgentPackCode = useCallback((code: string): string => {
    if (!agentMode) return code;
    
    const instructions = generateAgentInstructions(generationTitle, flowNodes);
    const enhancedCode = enhanceCodeWithAgentContext(code);
    
    return instructions + enhancedCode;
  }, [agentMode, generationTitle, flowNodes, generateAgentInstructions, enhanceCodeWithAgentContext]);
  
  // Build file tree structure from files
  const buildFileTree = useCallback((files: FileNode[]): (FileTreeFolder | FileTreeFile)[] => {
    const folders: Record<string, FileTreeFolder> = {};
    
    // Create folders
    files.forEach(file => {
      const parts = file.path.split('/').filter(Boolean);
      let currentPath = '';
      
      parts.slice(0, -1).forEach(part => {
        const parentPath = currentPath;
        currentPath = currentPath ? `${currentPath}/${part}` : `/${part}`;
        
        if (!folders[currentPath]) {
          const folder: FileTreeFolder = {
            name: part,
            path: currentPath,
            type: "folder",
            children: [],
            expanded: expandedFolders.has(currentPath)
          };
          folders[currentPath] = folder;
          
          if (parentPath && folders[parentPath]) {
            folders[parentPath].children.push(folder);
          }
        }
      });
    });
    
    // Add files to their folders
    files.forEach(file => {
      const parts = file.path.split('/').filter(Boolean);
      const folderPath = '/' + parts.slice(0, -1).join('/');
      const folder = folders[folderPath];
      
      const fileNode: FileTreeFile = {
        name: file.name,
        path: file.path,
        type: "file",
        fileType: file.type,
        isStub: file.isStub,
        sourceNodeId: file.sourceNodeId
      };
      
      if (folder) {
        folder.children.push(fileNode);
      }
    });
    
    // Get root level folders
    const rootFolders: (FileTreeFolder | FileTreeFile)[] = [];
    Object.entries(folders).forEach(([path, folder]) => {
      if (path.split('/').filter(Boolean).length === 1) {
        rootFolders.push(folder);
      }
    });
    
    return rootFolders.sort((a, b) => {
      const order = { pages: 1, components: 2, styles: 3, types: 4 };
      return (order[a.name as keyof typeof order] || 99) - (order[b.name as keyof typeof order] || 99);
    });
  }, [expandedFolders]);
  
  // Get active file content
  const getActiveFileContent = useCallback((): string => {
    // First, try to find the file in generatedFiles
    const file = generatedFiles.find(f => f.path === activeFilePath);
    if (file && file.content) return file.content;
    
    // Fallback to displayedCode for the main HTML file
    if (activeFilePath === "/pages/index.html" || activeFilePath === "/pages/index.tsx") {
      return displayedCode;
    }
    
    return displayedCode;
  }, [generatedFiles, activeFilePath, displayedCode]);
  
  // Handle node click from Flow - focus on corresponding code/preview
  // IMPORTANT: Preview uses selectedFlowPage state to navigate, Code only changes file path
  const [selectedFlowPage, setSelectedFlowPage] = useState<string | null>(null);
  
  const handleFlowNodeCodeFocus = useCallback((nodeId: string, targetView?: "code" | "preview") => {
    const node = flowNodes.find(n => n.id === nodeId);
    if (!node) return;
    
    // Select the node in flow first
    setSelectedFlowNode(nodeId);
    
    // For preview - set the page name and switch to preview mode
    if (targetView === "preview") {
      setSelectedFlowPage(node.id);
      setViewMode("preview");
      return;
    }
    
    // For code view - find the specific file
    const file = generatedFiles.find(f => f.sourceNodeId === nodeId);
    
    if (file && file.content) {
      setActiveFilePath(file.path);
      setViewMode("code");
      const ref = codeReferenceMap.find(r => r.nodeId === nodeId);
      if (ref) {
        setHighlightedLines({ start: ref.startLine, end: ref.endLine });
        setTimeout(() => setHighlightedLines(null), 3000);
      }
    } else if (nodeId === "home" || nodeId.toLowerCase() === "home") {
      setViewMode("code");
    } else {
      // Node is possible but not built - set up AI edit
      if (isEditing) return;
      if (node) {
        setEditInput(`@${node.name} Create this page with full content and layout`);
        setShowFloatingEdit(true);
      }
    }
  }, [generatedFiles, codeReferenceMap, flowNodes, isEditing]);

  useEffect(() => {
    // Use displayedCode for page navigation in preview, NOT editableCode
    // This prevents Code tab file selection from affecting Preview
    if (!displayedCode || !selectedFlowPage || viewMode !== "preview") return;
    setPreviewUrl(prev => {
      if (prev) URL.revokeObjectURL(prev);
      const previewCode = injectPageSelection(displayedCode, selectedFlowPage);
      return createPreviewUrl(previewCode);
    });
  }, [displayedCode, selectedFlowPage, viewMode, createPreviewUrl, injectPageSelection]);

  const FLOW_NODE_WIDTH = 180;
  const FLOW_PREVIEW_HEIGHT = 90;
  
  const getFlowNodeHeight = useCallback((node: ProductFlowNode) => {
    // Use displayedCode (not editableCode) - Code tab file selection shouldn't affect Flow
    const hasPreview = showPreviewsInFlow && displayedCode && (node.status === "observed" || node.status === "added");
    const baseHeight = hasPreview ? FLOW_PREVIEW_HEIGHT : 0;
    const descriptionHeight = node.description ? 24 : 0;
    const structureRows = node.components?.length ? Math.ceil(node.components.length / 2) : 0;
    const structureHeight = showStructureInFlow ? (structureRows > 0 ? structureRows * 18 + 24 : 12) : 0;
    const contentHeight = 58 + descriptionHeight + structureHeight; // Reduced from 80
    return baseHeight + contentHeight;
  }, [showPreviewsInFlow, displayedCode, showStructureInFlow, FLOW_PREVIEW_HEIGHT]);

  // Auto-layout flow nodes function
  const autoLayoutFlowNodes = useCallback(() => {
    if (flowNodes.length === 0) return;
    
    const observed = flowNodes.filter(n => n.status === "observed" || n.status === "added");
    const detected = flowNodes.filter(n => n.status === "detected");
    const possible = flowNodes.filter(n => n.status === "possible");
    
    const nodeWidth = 180;
    const nodeHeight = 150;
    const gapX = 30;
    const gapY = 60;
    const cols = 5;
    const startX = 100;
    let startY = 50;
    
    const layoutNodes = (nodes: typeof flowNodes, offsetY: number) => {
      return nodes.map((node, i) => ({
        ...node,
        x: startX + (i % cols) * (nodeWidth + gapX),
        y: offsetY + Math.floor(i / cols) * (nodeHeight + gapY)
      }));
    };
    
    const observedLayout = layoutNodes(observed, startY);
    startY += Math.ceil(observed.length / cols) * (nodeHeight + gapY) + 80;
    const detectedLayout = layoutNodes(detected, startY);
    startY += Math.ceil(detected.length / cols) * (nodeHeight + gapY) + 80;
    const possibleLayout = layoutNodes(possible, startY);
    
    setFlowNodes([...observedLayout, ...detectedLayout, ...possibleLayout]);
    setArchZoom(0.6);
    setCanvasPan({ x: 0, y: 0 });
  }, [flowNodes]);

  // Auto-layout on initial load or when flow building completes
  useEffect(() => {
    if (flowNodes.length > 0 && !flowBuilding && !hasAutoLayouted) {
      // Small delay to ensure all nodes are rendered
      const timer = setTimeout(() => {
        console.log('[Flow] Auto-layout triggered, nodes:', flowNodes.length);
        autoLayoutFlowNodes();
        setHasAutoLayouted(true);
      }, 150);
      return () => clearTimeout(timer);
    }
  }, [flowNodes.length, flowBuilding, hasAutoLayouted, autoLayoutFlowNodes]);

  // Reset auto-layout flag when project changes OR when flow nodes change significantly
  useEffect(() => {
    setHasAutoLayouted(false);
  }, [activeGeneration?.id]);
  
  // Also reset when flowBuilding finishes
  useEffect(() => {
    if (!flowBuilding && flowNodes.length > 0) {
      console.log('[Flow] Building complete, resetting auto-layout flag');
      setHasAutoLayouted(false);
    }
  }, [flowBuilding]);
  
  // Toggle folder expansion
  const toggleFolder = useCallback((path: string) => {
    setExpandedFolders(prev => {
      const next = new Set(prev);
      if (next.has(path)) {
        next.delete(path);
      } else {
        next.add(path);
      }
      return next;
    });
  }, []);
  
  // Generate a suggested flow node extension - directly adds to flow and triggers AI
  const suggestFlowExtension = (fromNode: ProductFlowNode, actionType: string) => {
    // Block if currently editing
    if (isEditing) {
      showToast("Wait for current generation to finish", "info");
      return;
    }
    console.log('[suggestFlowExtension] Called with:', fromNode.name, actionType);
    
    // Generate context-aware names and prompts based on action type
    let nodeName = '';
    let nodeDescription = '';
    let edgeLabel = '';
    let aiPrompt = '';
    
    // Make unique names with timestamp
    const timestamp = Date.now();
    const existingNodeNames = flowNodes.map(n => n.name.toLowerCase());
    
    switch (actionType) {
      case 'extend':
        nodeName = `${fromNode.name}-detail`;
        nodeDescription = `Detail view for ${fromNode.name}`;
        edgeLabel = 'opens';
        aiPrompt = `@${nodeName} Create a detail page for ${fromNode.name}. Show expanded information, more details, and actions related to ${fromNode.name}. Include a back button to return. Match the existing design.`;
        break;
      case 'alternative':
        nodeName = `${fromNode.name}-v2`;
        nodeDescription = `Alternative version of ${fromNode.name}`;
        edgeLabel = 'alternative';
        aiPrompt = `@${nodeName} Create an alternative version of the ${fromNode.name} page. Keep the same purpose but use a different layout, different visual hierarchy, or different interaction pattern. Include same navigation as original.`;
        break;
      case 'subflow':
        nodeName = `${fromNode.name}-items`;
        nodeDescription = `Items/list within ${fromNode.name}`;
        edgeLabel = 'contains';
        aiPrompt = `@${nodeName} Create a list/items view within ${fromNode.name}. Show a collection of items with filtering, search, or categorization. Each item should be clickable. Match the existing design patterns.`;
        break;
      default:
        nodeName = `${fromNode.name}-next`;
        nodeDescription = `Next step from ${fromNode.name}`;
        edgeLabel = 'leads to';
        aiPrompt = `@${nodeName} Create a logical next page after ${fromNode.name}. Think about what action a user would take on ${fromNode.name} and create the resulting page.`;
    }
    
    // Make name unique if already exists
    let finalName = nodeName;
    let counter = 1;
    while (existingNodeNames.includes(finalName.toLowerCase())) {
      finalName = `${nodeName}-${counter}`;
      counter++;
    }
    nodeName = finalName;
    aiPrompt = aiPrompt.replace(/@[a-zA-Z0-9-_]+/, `@${nodeName}`);
    
    const nodeId = `node_${timestamp}`;
    
    // Position below/beside source node
    const newNode: ProductFlowNode = {
      id: nodeId,
      name: nodeName,
      type: 'view',
      description: nodeDescription,
      x: actionType === 'alternative' ? fromNode.x + 200 : fromNode.x + 50,
      y: actionType === 'alternative' ? fromNode.y : fromNode.y + 150,
      status: 'added',
      confidence: 'medium',
    };
    
    const newEdge: ProductFlowEdge = {
      id: `edge_${fromNode.id}_${nodeId}`,
      from: fromNode.id,
      to: nodeId,
      label: edgeLabel,
      type: 'navigation',
    };
    
    console.log('[suggestFlowExtension] Adding node:', newNode);
    console.log('[suggestFlowExtension] Adding edge:', newEdge);
    
    // Directly add the node and edge
    setFlowNodes(prev => [...prev, newNode]);
    setFlowEdges(prev => [...prev, newEdge]);
    
    // Close the node detail panel
    setSelectedFlowNode(null);
    
    // Open AI edit panel with context-aware prompt and auto-trigger
    setEditInput(aiPrompt);
    setShowFloatingEdit(true);
    
    // Auto-trigger AI generation
    setTimeout(() => {
      const sendBtn = document.querySelector('[data-edit-send-btn]') as HTMLButtonElement;
      if (sendBtn && !sendBtn.disabled) {
        sendBtn.click();
        showToast(`Generating ${nodeName}...`, 'info');
      }
    }, 150);
  };
  

  useEffect(() => {
    if (generatedCode && !isStreamingCode) {
      buildArchitectureLive(generatedCode);
      buildFlowLive(generatedCode);
      setStyleInfo(extractStyleInfo(generatedCode));
    }
  }, [generatedCode, isStreamingCode]);
  
  // Generate file structure when code or flow nodes change
  useEffect(() => {
    if (generatedCode && !isStreamingCode) {
      const files = generateFileStructure(generatedCode, flowNodes, codeMode);
      setGeneratedFiles(files);
      
      // Set default active file based on mode
      const newPath = codeMode === "single-file" ? "/pages/index.html" : "/pages/index.tsx";
      setActiveFilePath(newPath);
    }
  }, [generatedCode, isStreamingCode, flowNodes, codeMode, generateFileStructure]);
  
  // When activeFilePath changes, update editableCode to match the file content
  useEffect(() => {
    if (generatedFiles.length > 0 && activeFilePath) {
      const file = generatedFiles.find(f => f.path === activeFilePath);
      if (file && file.content) {
        setEditableCode(file.content);
      }
    }
  }, [activeFilePath, generatedFiles]);

  const getSupportedMimeType = () => {
    const types = ["video/webm;codecs=vp8,opus", "video/webm;codecs=vp8", "video/webm", "video/mp4"];
    for (const type of types) {
      if (MediaRecorder.isTypeSupported(type)) return type;
    }
    return "video/webm";
  };

  // Check if mobile device (function version for runtime checks)
  const checkIsMobile = () => {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           (window.innerWidth <= 768);
  };

  const [showMobileRecordingInfo, setShowMobileRecordingInfo] = useState(false);

  const startRecording = async () => {
    // Check for mobile - show custom modal
    if (checkIsMobile()) {
      setShowMobileRecordingInfo(true);
      return;
    }

    try {
      // Request HIGHEST QUALITY screen capture for AI analysis
      const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
        video: {
          width: { ideal: 2560, max: 3840 },
          height: { ideal: 1440, max: 2160 },
          frameRate: { ideal: 30, max: 60 },
          // @ts-ignore - cursor is valid for screen capture
          cursor: "always"
        }, 
        audio: false,
        // @ts-ignore - preferCurrentTab helps quality
        preferCurrentTab: false,
        // @ts-ignore - selfBrowserSurface helps quality
        selfBrowserSurface: "include"
      });
      streamRef.current = screenStream;
      chunksRef.current = [];
      const mimeType = getSupportedMimeType();
      
      // MAXIMUM QUALITY recording - 16 Mbps bitrate for crystal clear UI text
      // This is critical for AI to read small text and recognize UI elements
      const mediaRecorder = new MediaRecorder(screenStream, { 
        mimeType,
        videoBitsPerSecond: 16000000 // 16 Mbps - maximum quality for text readability
      });
      
      console.log("[Recording] Started with:", {
        mimeType,
        bitrate: "16 Mbps",
        resolution: `${screenStream.getVideoTracks()[0]?.getSettings()?.width}x${screenStream.getVideoTracks()[0]?.getSettings()?.height}`
      });
      
      mediaRecorder.ondataavailable = (e) => { 
        console.log("Data chunk received:", e.data.size);
        if (e.data.size > 0) chunksRef.current.push(e.data); 
      };
      
      let hasProcessedStop = false;
      
      mediaRecorder.onstop = async () => {
        // Guard against multiple calls
        if (hasProcessedStop) {
          console.log("onstop already processed, skipping");
          return;
        }
        hasProcessedStop = true;
        
        console.log("=== MediaRecorder.onstop fired ===");
        
        // Clear timer
        if (timerRef.current) {
          clearInterval(timerRef.current);
          timerRef.current = null;
        }
        
        // Stop all tracks
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        
        // Create blob and add to flows - copy chunks immediately
        const chunks = [...chunksRef.current];
        chunksRef.current = []; // Clear immediately to prevent reuse
        
        console.log("Chunks collected:", chunks.length);
        
        if (chunks.length > 0) {
          const blob = new Blob(chunks, { type: mimeType });
          console.log("Created blob, size:", blob.size, "bytes");
          
          // CRITICAL: Capture recording duration BEFORE reset
          // This is needed because webm duration is often Infinity and needs estimation
          const capturedDuration = recordingDuration;
          console.log("Captured recording duration:", capturedDuration, "seconds");
          
          try {
            await addVideoToFlows(blob, "", capturedDuration);
            console.log("Flow added successfully with duration:", capturedDuration);
          } catch (e) {
            console.error("Error adding flow:", e);
          }
        } else {
          console.log("WARNING: No chunks available!");
        }
        
        // Update state after flow is added
        setIsRecording(false);
        setRecordingDuration(0);
        setViewMode("input");
        mediaRecorderRef.current = null;
        
        console.log("=== Recording cleanup complete ===");
      };
      
      // Handle when user clicks "Stop sharing" in browser UI
      const videoTrack = screenStream.getVideoTracks()[0];
      if (videoTrack) {
        videoTrack.onended = () => {
          console.log("Screen sharing stopped by user (track ended)");
          if (mediaRecorderRef.current && mediaRecorderRef.current.state === "recording") {
            mediaRecorderRef.current.stop();
          }
        };
      }
      
      mediaRecorderRef.current = mediaRecorder;
      mediaRecorder.start(1000); // Collect data every second
      setIsRecording(true);
      timerRef.current = setInterval(() => setRecordingDuration(prev => prev + 1), 1000);
      console.log("Recording started");
    } catch (err) {
      console.error("Recording error:", err);
      setIsRecording(false);
    }
  };

  const stopRecording = () => {
    console.log("stopRecording called, state:", mediaRecorderRef.current?.state);
    
    // Request final data chunk before stopping
    if (mediaRecorderRef.current && mediaRecorderRef.current.state === "recording") {
      mediaRecorderRef.current.requestData(); // Get any pending data
      mediaRecorderRef.current.stop();
    }
    
    // Clear timer (onstop will also do this, but just in case)
    if (timerRef.current) {
      clearInterval(timerRef.current);
      timerRef.current = null;
    }
  };

  const addVideoToFlows = async (blob: Blob, name: string, knownDuration?: number) => {
    console.log("addVideoToFlows called, blob size:", blob.size, "type:", blob.type, "knownDuration:", knownDuration);

    // Validate blob
    if (!blob || blob.size === 0) {
      console.error("Invalid blob - empty or null");
      showToast("Invalid video file", "error");
      return;
    }

    // ═══════════════════════════════════════════════════════════════
    // RESET: Each new video must be treated as a FRESH analysis
    // Clear previous style/context so they don't leak into new video
    // ═══════════════════════════════════════════════════════════════
    setStyleDirective(getDefaultStyleName());
    setRefinements("");
    setStyleReferenceImage(null);
    setEditInput("");
    
    const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const url = URL.createObjectURL(blob);
    const video = document.createElement("video");
    video.src = url;
    video.muted = true;
    video.playsInline = true;
    video.preload = "metadata";
    video.setAttribute("webkit-playsinline", "true");
    
    // Don't set crossOrigin for local blob URLs - it can cause issues on mobile
    // video.crossOrigin = "anonymous";
    
    return new Promise<void>((resolve) => {
      let resolved = false;
      
      const generateThumbnail = (videoEl: HTMLVideoElement): string | undefined => {
        try {
          const canvas = document.createElement("canvas");
          const vw = videoEl.videoWidth || 640;
          const vh = videoEl.videoHeight || 360;
          canvas.width = 320; // Higher quality thumbnail
          canvas.height = Math.round((320 / vw) * vh) || 180;
          const ctx = canvas.getContext("2d");
          if (ctx && vw > 0 && vh > 0) {
            ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
            if (dataUrl.length > 1000) return dataUrl;
          }
        } catch (e) {
          console.error("Thumbnail error:", e);
        }
        return undefined;
      };
      
      // Get valid duration - handle Infinity for webm
      const getValidDuration = (): number => {
        const d = video.duration;
        // First try: video metadata duration (works for mp4, sometimes webm)
        if (d && isFinite(d) && !isNaN(d) && d > 0 && d < 7200) {
          console.log("Using video.duration:", d);
          return Math.round(d);
        }
        // Second try: known duration passed from recording timer (most reliable for recordings)
        if (knownDuration && knownDuration > 0) {
          console.log("Using knownDuration from recording timer:", knownDuration);
          return knownDuration;
        }
        // Third try: recordingDuration state (fallback)
        if (recordingDuration > 0) {
          console.log("Using recordingDuration state:", recordingDuration);
          return recordingDuration;
        }
        // Last resort: estimate from blob size
        // With 16 Mbps bitrate: ~2MB per second of video
        const bytesPerSecond = 2000000; // 2MB/s at 16Mbps
        const est = Math.max(5, Math.round(blob.size / bytesPerSecond));
        console.log("Estimated duration from blob size:", est, "seconds (blob size:", blob.size, "bytes)");
        return Math.min(est, 300);
      };
      
      const finishCreation = async (thumbnail?: string) => {
        if (resolved) return;
        resolved = true;

        const duration = getValidDuration();
        const flowId = generateId();

        // If duration was estimated from blob size, try to get real duration asynchronously
        // and update the flow once real metadata loads
        const d = video.duration;
        const usedEstimate = !(d && isFinite(d) && !isNaN(d) && d > 0 && d < 7200) && !(knownDuration && knownDuration > 0) && !(recordingDuration > 0);
        if (usedEstimate) {
          // Create a new video element to load metadata in the background
          const metaVideo = document.createElement('video');
          metaVideo.preload = 'metadata';
          metaVideo.src = URL.createObjectURL(blob);
          metaVideo.onloadedmetadata = () => {
            const realD = metaVideo.duration;
            if (realD && isFinite(realD) && !isNaN(realD) && realD > 0 && realD < 7200) {
              const realDuration = Math.round(realD);
              console.log('[Duration fix] Updated flow duration from', duration, 'to', realDuration);
              setFlows(prev => prev.map(f => f.id === flowId ? { ...f, duration: realDuration, trimEnd: realDuration } : f));
            }
            URL.revokeObjectURL(metaVideo.src);
          };
          // For webm, seek to end to get real duration
          metaVideo.onseeked = () => {
            const realD = metaVideo.duration;
            if (realD && isFinite(realD) && !isNaN(realD) && realD > 0 && realD < 7200) {
              const realDuration = Math.round(realD);
              console.log('[Duration fix] Updated flow duration (after seek) from', duration, 'to', realDuration);
              setFlows(prev => prev.map(f => f.id === flowId ? { ...f, duration: realDuration, trimEnd: realDuration } : f));
            }
            URL.revokeObjectURL(metaVideo.src);
          };
          metaVideo.load();
          // For webm files, try seeking to the end after metadata loads
          const origOnMeta = metaVideo.onloadedmetadata;
          metaVideo.onloadedmetadata = (e) => {
            if (origOnMeta) (origOnMeta as EventListener)(e);
            if (!isFinite(metaVideo.duration) || metaVideo.duration <= 0) {
              metaVideo.currentTime = 1e10; // Force seek to get real duration for webm
            }
          };
        }
        
        // Generate name - use file name if provided, otherwise create unique recording name
        let baseName = name && name.trim() ? name.trim() : "";
        
        // For mobile, upload to Supabase immediately for persistence
        let permanentUrl = url;
        if (isMobile && user) {
          try {
            // Get upload URL
            const uploadRes = await fetch("/api/upload-video/get-url", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                fileName: `${flowId}.${blob.type.includes("mp4") ? "mp4" : "webm"}`,
                contentType: blob.type || "video/mp4"
              }),
            });
            
            if (uploadRes.ok) {
              const { uploadUrl, publicUrl } = await uploadRes.json();
              
              // Upload video
              const upload = await fetch(uploadUrl, {
                method: "PUT",
                headers: { "Content-Type": blob.type || "video/mp4" },
                body: blob,
              });
              
              if (upload.ok) {
                permanentUrl = publicUrl;
                console.log("Video uploaded to Supabase for persistence:", publicUrl);
              }
            }
          } catch (e) {
            console.error("Background upload failed:", e);
            // Continue with blob URL - video won't persist after refresh
          }
        }
        
        setFlows(prev => {
          // If no name provided, generate based on count
          if (!baseName) {
            baseName = `Recording ${prev.length + 1}`;
          }
          
          // Ensure unique name by checking existing flows
          const existingNames = prev.map(f => f.name);
          let finalName = baseName;
          let counter = 1;
          while (existingNames.includes(finalName)) {
            counter++;
            finalName = `${baseName} (${counter})`;
          }
          
          const newFlow: FlowItem = {
            id: flowId, 
            name: finalName, 
            videoBlob: blob, 
            videoUrl: permanentUrl, 
            thumbnail: thumbnail || "",
            duration, 
            trimStart: 0, 
            trimEnd: duration,
          };
          console.log("Flow added:", newFlow.name, "duration:", duration, "blob size:", blob.size, "url:", permanentUrl.substring(0, 50));
          return [...prev, newFlow];
        });
        setSelectedFlowId(flowId);
        showToast("Video added", "success");
        resolve();
      };
      
      // Mobile: Use aggressive fast path - don't wait for all events
      if (isMobile) {
        console.log("Mobile device - using fast path");
        // Just wait a short moment for any metadata we can get, then finish
        setTimeout(() => {
          if (!resolved) {
            finishCreation(generateThumbnail(video));
          }
        }, 1500); // 1.5 seconds max wait on mobile
      }
      
      // Handle metadata when loaded
      video.onloadedmetadata = () => {
        console.log("Metadata loaded, raw duration:", video.duration);
        if (isMobile) {
          // On mobile, finish as soon as we have metadata
          setTimeout(() => finishCreation(generateThumbnail(video)), 200);
        } else if (!isFinite(video.duration) || video.duration <= 0) {
          video.currentTime = 1e10; // Seek far to get real duration for webm
        } else {
          video.currentTime = Math.min(1, video.duration * 0.25);
        }
      };
      
      // Handle canplay
      video.oncanplay = () => {
        if (resolved) return;
        console.log("Video can play");
        setTimeout(() => {
          if (!resolved) {
            finishCreation(generateThumbnail(video));
          }
        }, 300);
      };
      
      // Desktop seeking for webm duration fix
      video.onseeked = () => {
        if (resolved || isMobile) return;
        console.log("Seeked to:", video.currentTime, "duration now:", video.duration);
        if (video.currentTime > 100) {
          video.currentTime = Math.min(1, getValidDuration() * 0.25);
          return;
        }
        requestAnimationFrame(() => {
          setTimeout(() => {
            if (resolved) return;
            finishCreation(generateThumbnail(video));
          }, 100);
        });
      };
      
      video.onerror = (e) => {
        console.error("Video load error:", e);
        // Even on error, add the video with estimated data
        if (!resolved) {
          console.log("Attempting fallback despite error");
          finishCreation();
        }
      };
      
      // Ultimate fallback timeout
      setTimeout(() => {
        if (!resolved) {
          console.log("Final timeout - using estimated data");
          finishCreation(generateThumbnail(video));
        }
      }, isMobile ? 3000 : 8000);
      
      video.load();
      
      // Try to play to trigger loading (helps on some mobile browsers)
      video.play().catch(() => {
        console.log("Autoplay blocked");
      });
    });
  };

  // Import flow from landing hero (upload/record/context/style) without touching tool behavior.
  // Track processed pending flows to prevent duplicate imports
  const processedPendingRef = useRef<number | null>(null);
  
  useEffect(() => {
    if (!pending?.blob) return;
    
    // Prevent duplicate processing (React Strict Mode, fast re-renders)
    if (processedPendingRef.current === pending.createdAt) {
      return;
    }
    processedPendingRef.current = pending.createdAt;

    // Safety: only consume once per pending payload
    const payload = pending;
    (async () => {
      try {
        // Check if we already have flows - if so, just restore context/style, don't add video again
        // This happens when user clicked Reconstruct while not logged in, then logged in
        if (flows.length > 0) {
          console.log("[PendingFlow] Flows already exist, restoring context only (not adding duplicate video)");
          if (payload.context) setRefinements(payload.context);
          if (payload.styleDirective) setStyleDirective(payload.styleDirective);
        } else {
          // No flows yet - this is a fresh import from landing page
          await addVideoToFlows(payload.blob, payload.name || "Flow");
          if (payload.context) setRefinements(payload.context);
          if (payload.styleDirective) setStyleDirective(payload.styleDirective);
          setViewMode("input");
        }
      } finally {
        clearPending();
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [pending?.createdAt]);

  const handleFileInput = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      for (const file of Array.from(files)) {
        // Accept video files - be more lenient with MIME type checking for mobile
        const isVideo = file.type.startsWith("video/") || 
                        file.name.toLowerCase().match(/\.(mp4|mov|webm|avi|mkv|m4v)$/);
        if (isVideo) {
          const sizeMB = file.size / 1024 / 1024;
          console.log(`Adding video: ${file.name}, size: ${sizeMB.toFixed(1)}MB, type: ${file.type}`);
          
          // Just add the video - no size restrictions on frontend
          // Backend will handle any size issues during processing
          await addVideoToFlows(file, file.name.replace(/\.[^/.]+$/, ""));
        } else {
          showToast("Please select a video file", "error");
        }
      }
    }
    e.target.value = "";
  }, [showToast]);

  // Drag and drop handlers for video upload
  const [isDragging, setIsDragging] = useState(false);
  
  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(true);
  }, []);
  
  const handleDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
  }, []);
  
  const handleDrop = useCallback(async (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
    
    const files = e.dataTransfer.files;
    if (files && files.length > 0) {
      for (const file of Array.from(files)) {
        const isVideo = file.type.startsWith("video/") || 
                        file.name.toLowerCase().match(/\.(mp4|mov|webm|avi|mkv|m4v)$/);
        const isImage = file.type.startsWith("image/") ||
                        file.name.toLowerCase().match(/\.(png|jpg|jpeg|gif|webp)$/);
        
        if (isVideo) {
          const sizeMB = file.size / 1024 / 1024;
          console.log(`Dropped video: ${file.name}, size: ${sizeMB.toFixed(1)}MB, type: ${file.type}`);
          await addVideoToFlows(file, file.name.replace(/\.[^/.]+$/, ""));
        } else if (isImage) {
          // Handle image drop - create a flow from image
          const imageUrl = URL.createObjectURL(file);
          const flowId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const flowName = file.name.replace(/\.[^/.]+$/, "");
          
          // Create image element to get dimensions
          const img = new window.Image();
          img.src = imageUrl;
          await new Promise((resolve) => { img.onload = resolve; });
          
          // Create a canvas to generate thumbnail
          const canvas = document.createElement('canvas');
          const maxSize = 400;
          const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);
          const thumbnail = canvas.toDataURL('image/jpeg', 0.8);
          
          // Convert image to blob
          const response = await fetch(imageUrl);
          const imageBlob = await response.blob();
          
          const newFlow: FlowItem = {
            id: flowId,
            name: flowName,
            thumbnail: thumbnail,
            videoUrl: imageUrl,
            videoBlob: imageBlob,
            duration: 0,
            trimStart: 0,
            trimEnd: 0,
            isImage: true,
          };
          
          setFlows((prev) => [...prev, newFlow]);
          setSelectedFlowId(flowId);
          showToast(`Image "${flowName}" added`, "success");
        } else {
          showToast("Please drop a video or image file", "error");
        }
      }
    }
  }, [showToast]);

  const removeFlow = (flowId: string) => {
    setFlows(prev => prev.filter(f => f.id !== flowId));
    if (selectedFlowId === flowId) setSelectedFlowId(flows.length > 1 ? flows.find(f => f.id !== flowId)?.id || null : null);
  };

  // Context image/file upload handler - uploads to Supabase Storage
  const handleContextImageUpload = useCallback(async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      for (const file of Array.from(files)) {
        const id = `ctx-file-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        
        // First add with loading state (local blob for preview)
        const localUrl = URL.createObjectURL(file);
        setContextImages(prev => [...prev, { id, url: localUrl, name: file.name, uploading: true }]);
        
        // Upload to Supabase
        try {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("userId", user?.id || "anon");
          
          const response = await fetch("/api/upload-image", {
            method: "POST",
            body: formData,
          });
          
          const data = await response.json();
          
          if (data.success && data.url) {
            // Replace local URL with Supabase URL
            URL.revokeObjectURL(localUrl);
            setContextImages(prev => prev.map(img => 
              img.id === id ? { ...img, url: data.url, uploading: false } : img
            ));
            console.log("[Upload] Image uploaded to Supabase:", data.url);
          } else {
            console.error("[Upload] Failed:", data.error);
            showToast("Failed to upload image", "error");
            // Keep local URL as fallback
            setContextImages(prev => prev.map(img => 
              img.id === id ? { ...img, uploading: false } : img
            ));
          }
        } catch (error) {
          console.error("[Upload] Error:", error);
          showToast("Failed to upload image", "error");
          setContextImages(prev => prev.map(img => 
            img.id === id ? { ...img, uploading: false } : img
          ));
        }
      }
    }
    e.target.value = "";
  }, [user, showToast]);

  const removeContextImage = useCallback((id: string) => {
    setContextImages(prev => {
      const img = prev.find(i => i.id === id);
      if (img) URL.revokeObjectURL(img.url);
      return prev.filter(i => i.id !== id);
    });
  }, []);

  // CRUD operations for generations
  const renameGeneration = (id: string, newTitle: string) => {
    const updatedGen = generations.find(g => g.id === id);
    if (updatedGen) {
      // Ensure title is not empty - fallback to current title if empty
      const finalTitle = newTitle.trim() || updatedGen.title || "Untitled Project";
      console.log("[Rename] Renaming generation", id, "to:", finalTitle);
      
      const renamedGen = { ...updatedGen, title: finalTitle, autoTitle: false };
      setGenerations(prev => prev.map(g => g.id === id ? renamedGen : g));
      if (activeGeneration?.id === id) {
        setActiveGeneration(prev => prev ? { ...prev, title: finalTitle, autoTitle: false } : null);
        setGenerationTitle(finalTitle);
      }
      // Sync rename to Supabase immediately
      saveGenerationToSupabase(renamedGen);
    }
    setRenamingId(null);
    setRenameValue("");
  };
  
  // Save a version snapshot to the active generation
  const saveVersion = useCallback((label: string) => {
    if (!activeGeneration || !generatedCode) return;
    
    const newVersion: GenerationVersion = {
      id: generateId(),
      timestamp: Date.now(),
      label,
      code: generatedCode,
      flowNodes: [...flowNodes],
      flowEdges: [...flowEdges],
      styleInfo: styleInfo ? { ...styleInfo } : null,
    };
    
    // Calculate updated versions ONCE
    const existingVersions = activeGeneration.versions || [];
    const updatedVersions = [...existingVersions, newVersion].slice(-20);
    const updatedGen = { ...activeGeneration, versions: updatedVersions };
    
    // Update both states
    setGenerations(prev => prev.map(gen => 
      gen.id === activeGeneration.id ? updatedGen : gen
    ));
    setActiveGeneration(updatedGen);
    
    // CRITICAL: Save to Supabase OUTSIDE of setState
    if (user) {
      console.log('[saveVersion] Saving to Supabase, versions count:', updatedVersions.length);
      saveGenerationToSupabase(updatedGen);
    }
  }, [activeGeneration, generatedCode, flowNodes, flowEdges, styleInfo, user, saveGenerationToSupabase]);
  
  // Restore to a specific version
  const restoreVersion = useCallback((genId: string, version: GenerationVersion) => {
    console.log('[restoreVersion] Called with genId:', genId, 'version:', version.label);
    console.log('[restoreVersion] Version code length:', version.code?.length || 0);
    console.log('[restoreVersion] Version code first 100 chars:', version.code?.substring(0, 100));
    
    const gen = generations.find(g => g.id === genId);
    if (!gen) {
      console.error('[restoreVersion] Generation not found:', genId);
      showToast("Failed to restore - generation not found", "error");
      return;
    }
    
    // Check if version has code
    if (!version.code || version.code.length < 50) {
      console.error('[restoreVersion] Version has no/invalid code');
      showToast("Failed to restore - version code is missing", "error");
      return;
    }
    
    // Save current state as a version before restoring (with descriptive name)
    if (activeGeneration?.id === genId && generatedCode && generatedCode !== version.code) {
      const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      saveVersion(`Snapshot @ ${timeStr} (before "${version.label.slice(0, 20)}${version.label.length > 20 ? '...' : ''}")`);
    }
    
    // Restore the version
    console.log('[restoreVersion] Setting code states...');
    setGeneratedCode(version.code);
    setDisplayedCode(version.code);
    setEditableCode(version.code);
    setFlowNodes(version.flowNodes || []);
    setFlowEdges(version.flowEdges || []);
    if (version.styleInfo) setStyleInfo(version.styleInfo);
    
    // CRITICAL: Also update activeGeneration so UI reflects the change
    setActiveGeneration(prev => {
      if (!prev || prev.id !== genId) return prev;
      return {
        ...prev,
        code: version.code,
        flowNodes: version.flowNodes || prev.flowNodes,
        flowEdges: version.flowEdges || prev.flowEdges,
        styleInfo: version.styleInfo || prev.styleInfo,
      };
    });
    
    // Also update in generations list
    const updatedGen = {
      ...(generations.find(g => g.id === genId) || gen),
      code: version.code,
      flowNodes: version.flowNodes || gen.flowNodes,
      flowEdges: version.flowEdges || gen.flowEdges,
      styleInfo: version.styleInfo || gen.styleInfo,
    };
    
    setGenerations(prev => prev.map(g => g.id === genId ? updatedGen : g));
    
    // Save restored version to Supabase OUTSIDE of setState
    if (user) {
      console.log('[restoreVersion] Saving to Supabase');
      saveGenerationToSupabase(updatedGen);
    }
    
    // Update preview - revoke old URL and create new one immediately
    console.log('[restoreVersion] Creating preview URL...');
    if (previewUrl) {
      try { URL.revokeObjectURL(previewUrl); } catch {}
    }
    const newPreviewUrl = createPreviewUrl(version.code);
    console.log('[restoreVersion] New preview URL:', newPreviewUrl?.substring(0, 50));
    setPreviewUrl(newPreviewUrl);
    
    // Switch to preview mode to show the restored version
    setViewMode("preview");
    showToast(`Restored to: ${version.label}`, "success");
    setExpandedVersions(null);
    console.log('[restoreVersion] Complete!');
  }, [generations, activeGeneration, generatedCode, saveVersion, createPreviewUrl, showToast, user, saveGenerationToSupabase]);
  
  const duplicateGeneration = async (gen: GenerationRecord) => {
    setHistoryMenuOpen(null);
    
    // If generation doesn't have code, load full data first
    let fullGen = gen;
    if (!gen.code) {
      showToast("Loading project data...", "info");
      const loaded = await loadFullGeneration(gen.id);
      if (!loaded || !loaded.code) {
        showToast("Failed to load project data", "error");
        return;
      }
      fullGen = loaded;
    }
    
    const newGen: GenerationRecord = {
      ...fullGen,
      id: generateId(),
      title: `${fullGen.title} (Copy)`,
      timestamp: Date.now(),
      autoTitle: false,
      publishedSlug: undefined, // Don't copy published slug
    };
    setGenerations(prev => [...prev, newGen]);
    // Save duplicated generation to Supabase
    saveGenerationToSupabase(newGen);
    showToast("Project duplicated!", "success");
  };
  
  // Use project's video as input for NEW project (Untitled, clean slate, with that video)
  const useAsInput = async (gen: GenerationRecord) => {
    setHistoryMenuOpen(null);
    
    // Load full generation to get video URL
    let fullGen = gen;
    if (!gen.videoUrl) {
      showToast("Loading video...", "info");
      const loaded = await loadFullGeneration(gen.id);
      if (!loaded) {
        showToast("Failed to load project", "error");
        return;
      }
      fullGen = loaded;
    }
    
    if (!fullGen.videoUrl) {
      showToast("No video found in this project", "error");
      return;
    }
    
    // Create NEW project (Untitled) so it appears in list
    // IMPORTANT: Use empty styleDirective for fresh Auto-Detect, not copied from original!
    const newGenId = generateId();
    const newGen: GenerationRecord = {
      id: newGenId,
      title: "Untitled Project",
      autoTitle: true,
      timestamp: Date.now(),
      status: "complete",
      code: "",
      styleDirective: "", // Empty = fresh Auto-Detect, NOT copied from original project
      refinements: "",
      flowNodes: [],
      flowEdges: [],
      styleInfo: null,
      videoUrl: fullGen.videoUrl,
      versions: [],
      publishedSlug: undefined,
      chatMessages: [],
      libraryData: null,
    };
    setGenerations(prev => [...prev, newGen]);
    setActiveGeneration(newGen);
    setGenerationTitle("Untitled Project");
    setGeneratedCode(null);
    setDisplayedCode("");
    setEditableCode("");
    setPreviewUrl(null);
    setFlowNodes([]);
    setFlowEdges([]);
    setStyleInfo(null);
    setLibraryData(null);
    setLibraryDocsGenerated(false);
    setScanData(null);
    setRefinements("");
    setGenerationComplete(false);
    setChatMessages([]);
    setStyleDirective(""); // Reset to Auto-Detect for fresh generation
    setStyleReferenceImage(null);
    
    const flowId = `flow_${Date.now()}`;
    const newFlow: FlowItem = {
      id: flowId,
      name: fullGen.title || "Video Input",
      videoBlob: new Blob(),
      videoUrl: fullGen.videoUrl,
      thumbnail: fullGen.thumbnailUrl || "",
      duration: 30,
      trimStart: 0,
      trimEnd: 30,
    };
    setFlows([newFlow]);
    setSelectedFlowId(flowId);
    
    // Always regenerate thumbnail from video (thumbnailUrl may be stale or missing)
    if (fullGen.videoUrl) {
      regenerateThumbnail(flowId, fullGen.videoUrl);
    }
    
    // Load real duration from video metadata (fixes 00:00 for WebM)
    const tempV = document.createElement('video');
    tempV.preload = 'metadata';
    tempV.crossOrigin = 'anonymous';
    tempV.muted = true;
    let durationFixed = false;
    const updateDuration = () => {
      if (durationFixed) return;
      const d = tempV.duration;
      if (d && isFinite(d) && d > 0) {
        durationFixed = true;
        const dur = Math.round(d);
        let thumb = fullGen.thumbnailUrl || "";
        try {
          const c = document.createElement('canvas');
          const vw = tempV.videoWidth || 640, vh = tempV.videoHeight || 360;
          c.width = 320; c.height = Math.round((320 / vw) * vh) || 180;
          const ctx = c.getContext('2d');
          if (ctx && vw > 0 && vh > 0) {
            ctx.drawImage(tempV, 0, 0, c.width, c.height);
            thumb = c.toDataURL('image/jpeg', 0.8);
          }
        } catch (_) {}
        console.log("[UseAsInput] Video duration loaded:", dur, "s");
        setFlows(prev => prev.map(f => f.id === flowId ? { ...f, duration: dur, trimEnd: dur, thumbnail: thumb || f.thumbnail } : f));
      }
    };
    tempV.onloadedmetadata = () => {
      if (!isFinite(tempV.duration) || tempV.duration <= 0) {
        tempV.currentTime = 1e10; // Seek far to get real duration for WebM
      } else {
        tempV.currentTime = Math.min(1, tempV.duration * 0.25);
        updateDuration();
      }
    };
    tempV.onseeked = () => {
      updateDuration();
      if (!durationFixed && isFinite(tempV.duration) && tempV.duration > 0) {
        tempV.currentTime = Math.min(1, tempV.duration * 0.25);
      }
    };
    tempV.ondurationchange = () => updateDuration();
    tempV.onerror = () => console.log("[UseAsInput] Video load error");
    tempV.src = fullGen.videoUrl;
    
    setViewMode("input");
    setSidebarView("detail");
    if (user) saveGenerationToSupabase(newGen);
    showToast("New project created with this video. Configure style and generate.", "success");
  };
  
  // Open delete confirmation modal
  const confirmDeleteGeneration = (id: string, title: string) => {
    setDeleteTargetId(id);
    setDeleteTargetTitle(title || "Untitled Project");
    setShowDeleteModal(true);
    setHistoryMenuOpen(null);
  };
  
  // Actually delete after confirmation
  const deleteGeneration = async (id: string) => {
    setGenerations(prev => prev.filter(g => g.id !== id));
    if (activeGeneration?.id === id) {
      setActiveGeneration(null);
      // Reset to empty state
      setGeneratedCode(null);
      setDisplayedCode("");
      setEditableCode("");
      setPreviewUrl(null);
      setFlowNodes([]);
      setFlowEdges([]);
      setStyleInfo(null);
      setGenerationTitle("Untitled Project");
      setGenerationComplete(false);
    }
    setHistoryMenuOpen(null);
    setShowDeleteModal(false);
    setDeleteTargetId(null);
    showToast("Project deleted", "info");
    
    // Sync deletion to Supabase
    if (user) {
      try {
        await fetch(`/api/generations?id=${id}`, { method: "DELETE" });
      } catch (e) {
        console.error("Error deleting from Supabase:", e);
      }
    }
  };

  // Smooth trim handlers with live preview
  const handleTrimDrag = (e: React.MouseEvent, type: "start" | "end") => {
    e.preventDefault();
    e.stopPropagation();
    if (!trimBarRef.current || !selectedFlow) return;
    
    // Capture values at start
    const flowId = selectedFlow.id;
    const duration = selectedFlow.duration;
    
    // Guard against invalid duration
    if (!duration || !isFinite(duration) || duration <= 0) return;
    
    setIsDraggingTrim(type);
    
    const updateTrim = (clientX: number) => {
      if (!trimBarRef.current) return;
      const rect = trimBarRef.current.getBoundingClientRect();
      const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
      const percent = x / rect.width;
      let time = percent * duration;
      
      // Guard against NaN/Infinity
      if (!isFinite(time)) time = 0;
      time = Math.max(0, Math.min(time, duration));
      
      setTrimPreviewTime(time);
      
      // Seek video to show preview - guard against invalid values
      if (videoRef.current && isFinite(time)) {
        videoRef.current.currentTime = time;
      }
      
      setFlows(prev => prev.map(f => {
        if (f.id !== flowId) return f;
        if (type === "start") {
          return { ...f, trimStart: Math.min(time, f.trimEnd - 0.5) };
        }
        return { ...f, trimEnd: Math.max(time, f.trimStart + 0.5) };
      }));
    };
    
    const handleMove = (moveEvent: MouseEvent) => {
      moveEvent.preventDefault();
      requestAnimationFrame(() => updateTrim(moveEvent.clientX));
    };
    
    const handleUp = () => {
      setIsDraggingTrim(null);
      setTrimPreviewTime(null);
      document.removeEventListener("mousemove", handleMove);
      document.removeEventListener("mouseup", handleUp);
    };
    
    document.addEventListener("mousemove", handleMove);
    document.addEventListener("mouseup", handleUp);
  };

  const applyTrim = async () => {
    if (!selectedFlow) return;
    
    const trimDuration = selectedFlow.trimEnd - selectedFlow.trimStart;
    console.log(`Trim applied: ${selectedFlow.trimStart}s - ${selectedFlow.trimEnd}s (${trimDuration}s)`);
    
    // Remove any previous trim info from name and add new one
    // Match patterns like "(0s-30s)" or "(29s-30s)"
    const baseName = selectedFlow.name.replace(/\s*\(\d+s-\d+s\)\s*/g, '').trim();
    const newName = `${baseName} (${Math.round(selectedFlow.trimStart)}s-${Math.round(selectedFlow.trimEnd)}s)`;
    
    setFlows(prev => prev.map(f => 
      f.id === selectedFlow.id 
        ? { ...f, name: newName }
        : f
    ));
  };

  // Canvas pan handlers for architecture
  const handleCanvasMouseDown = (e: React.MouseEvent) => {
    if ((e.target as HTMLElement).closest('.arch-node-card')) return;
    setIsPanning(true);
    panStartRef.current = { x: e.clientX, y: e.clientY, panX: canvasPan.x, panY: canvasPan.y };
  };

  const handleCanvasMouseMove = (e: React.MouseEvent) => {
    if (!isPanning) return;
    const dx = e.clientX - panStartRef.current.x;
    const dy = e.clientY - panStartRef.current.y;
    setCanvasPan({ x: panStartRef.current.panX + dx, y: panStartRef.current.panY + dy });
  };

  const handleCanvasMouseUp = () => {
    setIsPanning(false);
  };

  // Handle suggestion click
  const handleSuggestionClick = (nodeId: string) => {
    const lastAt = editInput.lastIndexOf("@");
    setEditInput(editInput.slice(0, lastAt) + `@${nodeId} `);
    setShowSuggestions(false);
    setSelectedArchNode(nodeId);
    editInputRef.current?.focus();
  };

  const togglePlayPause = () => {
    if (!videoRef.current) return;
    if (isPlaying) videoRef.current.pause();
    else videoRef.current.play();
    setIsPlaying(!isPlaying);
  };

  const typeText = async (text: string, onUpdate: (typed: string) => void, speed = 20) => {
    for (let i = 0; i <= text.length; i++) {
      onUpdate(text.slice(0, i));
      await new Promise(r => setTimeout(r, speed));
    }
  };

  // Helper: Convert blob to base64
  const blobToBase64 = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result as string;
        // Remove data URL prefix to get just base64
        // Note: mimeType can contain commas (e.g., video/webm;codecs=vp8,opus)
        // So we need to find the actual base64 data after "base64," marker
        const base64Marker = ";base64,";
        const base64Index = result.indexOf(base64Marker);
        if (base64Index !== -1) {
          resolve(result.substring(base64Index + base64Marker.length));
        } else {
          // Fallback: try simple comma split (for types without codecs)
          const commaIndex = result.indexOf(",");
          resolve(commaIndex !== -1 ? result.substring(commaIndex + 1) : result);
        }
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  };

  // AI-Powered Documentation Generation (Gemini 3 Flash)
  const generateDocs = async (docType: "overview" | "api" | "qa" | "deploy") => {
    if (!generatedCode || isGeneratingDocs) return;
    
    setIsGeneratingDocs(docType);
    try {
      const response = await fetch("/api/generate/docs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: docType,
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          flowNodes: flowNodes.map(n => ({
            id: n.id,
            name: n.name,
            type: n.type,
            status: n.status,
            description: n.description
          })),
          styleInfo: styleInfo,
          screenCount: flowNodes.filter(n => n.status === "observed").length,
          componentCount: (editableCode || generatedCode)?.split("function ").length || 1
        })
      });
      
      const result = await response.json();
      if (result.success) {
        switch (docType) {
          case "overview": setAiDocsOverview(result.data); break;
          case "api": setAiDocsApi(result.data); break;
          case "qa": setAiDocsQa(result.data); break;
          case "deploy": setAiDocsDeploy(result.data); break;
        }
      } else {
        showToast(`Failed to generate ${docType} docs`, "error");
      }
    } catch (error) {
      console.error(`[Generate Docs] Error:`, error);
      showToast(`Error generating ${docType} documentation`, "error");
    } finally {
      setIsGeneratingDocs(null);
    }
  };

  // AI-Powered Flow Diagram Generation (Gemini 3 Pro)
  const generateFlows = async () => {
    if (!generatedCode || isGeneratingFlows) return;
    
    setIsGeneratingFlows(true);
    try {
      const response = await fetch("/api/generate/flows", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          flowNodes: flowNodes.map(n => ({
            id: n.id,
            name: n.name,
            type: n.type,
            status: n.status,
            description: n.description,
            components: n.components
          })),
          flowEdges: flowEdges.map(e => ({
            id: e.id,
            from: e.from,
            to: e.to,
            label: e.label
          }))
        })
      });
      
      const result = await response.json();
      if (result.success) {
        setAiFlows(result.data);
      } else {
        showToast("Failed to generate flow diagrams", "error");
      }
    } catch (error) {
      console.error("[Generate Flows] Error:", error);
      showToast("Error generating flow diagrams", "error");
    } finally {
      setIsGeneratingFlows(false);
    }
  };

  // Generate Library Documentation with AI - uses REAL extracted data from code
  const [libraryDocsError, setLibraryDocsError] = useState(false);
  
  const generateLibraryDocs = useCallback(async (forceRegenerate: boolean = false) => {
    if (!libraryData?.components || libraryData.components.length === 0) return;
    if (isGeneratingLibraryDocs && !forceRegenerate) return;
    
    setIsGeneratingLibraryDocs(true);
    setLibraryDocsError(false);
    try {
      // Get the full code for analysis
      const fullCode = editableCode || generatedCode || "";
      
      const response = await fetch("/api/generate/library-docs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          components: libraryData.components,
          tokens: libraryData.tokens || {},
          styleInfo: styleInfo,
          projectName: generationTitle || "Design System",
          fullCode: fullCode // Send full code for color/typography extraction
        })
      });
      
      if (!response.ok) throw new Error("Failed to generate docs");
      
      const result = await response.json();
      
      if (result.success && result.data?.docs) {
        setLibraryData((prev: any) => ({
          ...prev,
          docs: result.data.docs
        }));
        setLibraryDocsGenerated(true);
        showToast(`Documentation generated! (${result.extracted?.colors || 0} colors, ${result.extracted?.icons || 0} icons)`, "success");
      } else {
        // Set error flag to prevent infinite retries
        setLibraryDocsError(true);
      }
    } catch (error: any) {
      console.error("Library docs generation error:", error);
      showToast("Failed to generate documentation", "error");
      setLibraryDocsError(true); // Stop retrying on error
    } finally {
      setIsGeneratingLibraryDocs(false);
    }
  }, [libraryData?.components, styleInfo, generationTitle, showToast, isGeneratingLibraryDocs, editableCode, generatedCode]);

  // Auto-generate library docs ONLY when components exist but docs don't
  // Don't regenerate if docs were already loaded from database
  const lastDocsGenerationId = useRef<string | null>(null);
  
  useEffect(() => {
    const hasComponents = libraryData?.components && libraryData.components.length > 0;
    const currentGenId = activeGeneration?.id || null;
    const hasDocs = libraryData?.docs && libraryData.docs.length > 0;
    
    // Track project changes to reset error flag
    if (currentGenId && lastDocsGenerationId.current !== currentGenId) {
      lastDocsGenerationId.current = currentGenId;
      setLibraryDocsError(false);
    }
    
    // ONLY generate docs if:
    // 1. We have components AND
    // 2. NOT currently generating AND
    // 3. NO docs exist (neither in state nor loaded from DB) AND
    // 4. No error from previous attempt
    const shouldGenerate = hasComponents && 
      !isGeneratingLibraryDocs && 
      !hasDocs &&
      !libraryDocsError &&
      !libraryDocsGenerated;
    
    if (shouldGenerate) {
      generateLibraryDocs(false);
    }
  }, [libraryData?.components?.length, isGeneratingLibraryDocs, libraryData?.docs?.length, generateLibraryDocs, activeGeneration?.id, libraryDocsError, libraryDocsGenerated]);

  // AI-Powered Blueprints Analysis (Single Source of Truth)
  const analyzeBlueprints = async () => {
    if (!generatedCode || isAnalyzingBlueprints) return;
    
    setIsAnalyzingBlueprints(true);
    try {
      const response = await fetch("/api/generate/blueprints", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: editableCode || generatedCode,
          styleInfo: styleInfo
        })
      });
      
      const result = await response.json();
      if (result.success && result.data) {
        setBlueprintsAnalysis(result.data);
        // Initialize statuses for all blueprints
        const statuses: Record<string, "draft" | "approved" | "deprecated"> = {};
        result.data.blueprints?.forEach((bp: any) => {
          statuses[bp.id] = bp.status || "draft";
        });
        setBlueprintStatuses(statuses);
        console.log("[Blueprints] Analysis complete:", result.data.blueprints?.length, "blueprints found");
      } else {
        console.error("[Blueprints] Analysis failed:", result.error);
      }
    } catch (error) {
      console.error("[Blueprints] Analysis error:", error);
    } finally {
      setIsAnalyzingBlueprints(false);
    }
  };

  // AI-Powered Design System Generation (Gemini 3 Pro)
  const generateDesignSystem = async () => {
    if (!generatedCode || isGeneratingDesign) return;
    
    setIsGeneratingDesign(true);
    try {
      const response = await fetch("/api/generate/design", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          extractedColors: styleInfo?.colors,
          industry: "SaaS" // Could be detected from code patterns
        })
      });
      
      const result = await response.json();
      if (result.success) {
        setAiDesignSystem(result.data);
      } else {
        showToast("Failed to generate design system", "error");
      }
    } catch (error) {
      console.error("[Generate Design] Error:", error);
      showToast("Error generating design system", "error");
    } finally {
      setIsGeneratingDesign(false);
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════════
  // MULTI-PASS PIPELINE v2.0 - NEW GENERATORS
  // ═══════════════════════════════════════════════════════════════════════════════

  // Generate API Contracts (Swagger/TypeScript)
  const generateApiContracts = async () => {
    if (!generatedCode || isGeneratingApiContracts) return;
    
    setIsGeneratingApiContracts(true);
    try {
      const response = await fetch("/api/generate/api-contracts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          scanData: scanData
        })
      });
      
      const result = await response.json();
      if (result.success) {
        setApiContracts(result.data);
        showToast("API contracts generated successfully", "success");
      } else {
        showToast("Failed to generate API contracts", "error");
      }
    } catch (error) {
      console.error("[Generate API Contracts] Error:", error);
      showToast("Error generating API contracts", "error");
    } finally {
      setIsGeneratingApiContracts(false);
    }
  };

  // Generate Technical Debt Audit (replaces basic Design System)
  const generateDebtAudit = async () => {
    if (!generatedCode || isGeneratingDebtAudit) return;
    
    setIsGeneratingDebtAudit(true);
    try {
      const response = await fetch("/api/generate/debt-audit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          scanData: scanData
        })
      });
      
      const result = await response.json();
      if (result.success) {
        setDebtAudit(result.data);
        showToast("Debt audit generated successfully", "success");
      } else {
        showToast("Failed to generate debt audit", "error");
      }
    } catch (error) {
      console.error("[Generate Debt Audit] Error:", error);
      showToast("Error generating debt audit", "error");
    } finally {
      setIsGeneratingDebtAudit(false);
    }
  };

  // Generate E2E Tests (Playwright + Cypress)
  const generateE2ETests = async () => {
    if (!generatedCode || isGeneratingE2ETests) return;
    
    setIsGeneratingE2ETests(true);
    try {
      const response = await fetch("/api/generate/e2e-tests", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          scanData: scanData
        })
      });
      
      const result = await response.json();
      if (result.success) {
        setE2eTests(result.data);
        showToast("E2E tests generated successfully", "success");
      } else {
        showToast("Failed to generate E2E tests", "error");
      }
    } catch (error) {
      console.error("[Generate E2E Tests] Error:", error);
      showToast("Error generating E2E tests", "error");
    } finally {
      setIsGeneratingE2ETests(false);
    }
  };

  // Download Enterprise Package (ZIP with everything)
  const downloadEnterprisePackage = async () => {
    if (!generatedCode || isDownloadingPackage) return;
    
    setIsDownloadingPackage(true);
    try {
      const response = await fetch("/api/download/enterprise-package", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          projectName: activeGeneration?.title || "Generated Project",
          generatedCode: editableCode || generatedCode,
          scanData: scanData,
          apiContracts: apiContracts,
          debtAudit: debtAudit,
          e2eTests: e2eTests,
          flowDiagram: aiFlows,
          docs: {
            audit: aiDocsOverview,
            contracts: aiDocsApi,
            qa: aiDocsQa,
            handoff: aiDocsDeploy
          }
        })
      });
      
      if (!response.ok) {
        throw new Error("Failed to generate package");
      }
      
      // Download the ZIP file
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(activeGeneration?.title || "project").replace(/[^a-zA-Z0-9-_\s]/g, '')}-enterprise-package.zip`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      showToast("Enterprise package downloaded!", "success");
    } catch (error) {
      console.error("[Download Package] Error:", error);
      showToast("Error downloading enterprise package", "error");
    } finally {
      setIsDownloadingPackage(false);
    }
  };

  // AUTO-GENERATION DISABLED - saves API quota!
  // All docs/flows/design are now ON-DEMAND only (click buttons when needed)
  useEffect(() => {
    if (needsAutoGenDocs) {
      setNeedsAutoGenDocs(false); // Just reset the flag, don't auto-generate
    }
  }, [needsAutoGenDocs]);
  
  // AUTO-REGENERATE LIBRARY when code changes and library needs update
  useEffect(() => {
    if (!libraryNeedsRegeneration || !generatedCode || isGeneratingLibrary) return;
    
    // Hash the code to track what we generated from
    const codeHash = generatedCode.slice(0, 500) + generatedCode.length;
    
    // If we already generated library from this code, skip
    if (libraryCodeHash === codeHash) {
      setLibraryNeedsRegeneration(false);
      return;
    }
    
    // Auto-regenerate library DISABLED - user can click "Generate Library" button manually
    // This saves Gemini 3 Pro API quota (1 request per generation instead of 2)
    console.log("[Library] Auto-regeneration disabled. User can generate manually.");
    setLibraryNeedsRegeneration(false);
  }, [libraryNeedsRegeneration, generatedCode, editableCode, styleInfo, isGeneratingLibrary, libraryCodeHash]);

  // Auto-select Welcome when entering Library tab with generated library
  useEffect(() => {
    if (viewMode === "library" && libraryData && !selectedLibraryItem) {
      setSelectedLibraryItem("doc-welcome");
    }
  }, [viewMode, libraryData, selectedLibraryItem]);

  // Auto-generate flows DISABLED - user can click "Generate" button in Flow tab
  // useEffect removed to save API quota

  // Auto-generate design DISABLED - user can click "Generate" button in Design tab
  // useEffect removed to save API quota

  // Streaming generation - shows LIVE AI output as it happens
  const generateWithStreaming = async (
    videoBlob: Blob,
    styleDirective: string,
    databaseContext?: string,
    styleReferenceImage?: { url: string; base64?: string }
  ): Promise<{ success: boolean; code?: string; error?: string; tokenUsage?: any; scanData?: any }> => {
    try {
      // Convert video blob to base64
      setStreamingStatus("Preparing video for AI...");
      setStreamingCode(null);
      setStreamingLines(0);
      
      const videoBase64 = await blobToBase64(videoBlob);
      const mimeType = videoBlob.type || "video/mp4";
      
      const videoSizeMB = videoBlob.size / (1024 * 1024);
      console.log(`[streaming] Video size: ${videoSizeMB.toFixed(2)}MB`);
      
      setStreamingStatus("Connecting to AI...");
      
      // Call streaming endpoint
      // Create AbortController for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 280000); // 280s timeout (just under Vercel's 300s)
      
      const response = await fetch("/api/generate/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          videoBase64,
          mimeType,
          styleDirective,
          databaseContext,
          styleReferenceImage,
        }),
        signal: controller.signal,
      });
      
      clearTimeout(timeoutId);

      if (!response.ok) {
        // Handle specific status codes
        if (response.status === 413) {
          throw new Error("Video exceeds streaming limit. Switching to upload mode...");
        }
        if (response.status === 504) {
          throw new Error("Server timeout - will try backup generation method");
        }
        if (response.status === 502) {
          throw new Error("Gateway error - will try backup generation method");
        }
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Streaming request failed (${response.status})`);
      }

      // Process SSE stream
      const reader = response.body?.getReader();
      if (!reader) throw new Error("No response body");

      const decoder = new TextDecoder();
      let buffer = "";
      let fullCode = "";
      let tokenUsage: any = null;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n\n");
        buffer = lines.pop() || "";

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          
          try {
            const data = JSON.parse(line.slice(6));
            
            switch (data.type) {
              case "status":
                setStreamingStatus(data.message);
                break;
                
              case "chunk":
                // Accumulate full response
                fullCode += data.content;
                
                // Only show CODE portion in UI (after ```html or <!DOCTYPE) - hide AI preamble
                let displayCode = fullCode;
                const htmlBlockStart = fullCode.indexOf("```html");
                const doctypeStart = fullCode.indexOf("<!DOCTYPE");
                
                if (htmlBlockStart !== -1) {
                  // Extract code after ```html
                  displayCode = fullCode.slice(htmlBlockStart + 7);
                } else if (doctypeStart !== -1) {
                  // Extract from <!DOCTYPE
                  displayCode = fullCode.slice(doctypeStart);
                } else {
                  // Code hasn't started yet - just show status
                  displayCode = "";
                }
                
                setStreamingCode(displayCode || null);
                setStreamingLines(data.lineCount || 0);
                
                // Update status with line count
                if (data.lineCount > 0) {
                  setStreamingStatus(`✨ Writing code: ${data.lineCount} lines...`);
                }
                break;
                
              case "progress":
                setStreamingStatus(data.message);
                setStreamingLines(data.lineCount || 0);
                break;
                
              case "complete":
                setStreamingStatus("Generation complete!");
                tokenUsage = data.tokenUsage;
                // Save scan data from Multi-Pass Pipeline (Source of Truth)
                if (data.scanData) {
                  console.log("[streaming] Saving scanData to state");
                  setScanData(data.scanData);
                }
                // Return the clean extracted code
                return { 
                  success: true, 
                  code: data.code, 
                  tokenUsage: data.tokenUsage,
                  scanData: data.scanData
                };
                
              case "error":
                throw new Error(data.error);
            }
          } catch (e) {
            // Ignore parse errors for incomplete chunks
            if (e instanceof SyntaxError) continue;
            throw e;
          }
        }
      }

      // If we got here without complete event, return accumulated code
      if (fullCode.length > 100) {
        return { success: true, code: fullCode, tokenUsage };
      }

      return { success: false, error: "Generation incomplete" };
      
    } catch (error: any) {
      console.error("[streaming] Error:", error);
      setStreamingStatus(null);
      setStreamingCode(null);
      return { success: false, error: error.message };
    }
  };

  const handleGenerate = async () => {
    console.log("[handleGenerate] Called, flows:", flows.length, "user:", !!user);
    if (flows.length === 0) {
      console.log("[handleGenerate] No flows - returning early");
      showToast("Please upload or record a video first", "error");
      return;
    }
    
    // Auth gate: require login
    if (!user) {
      console.log("[handleGenerate] No user - showing auth modal");
      // Save flow to persistent storage so it survives auth redirect
      const flow = flows.find(f => f.id === selectedFlowId) || flows[0];
      if (flow && flow.videoBlob) {
        console.log("[handleGenerate] Saving flow to pending storage");
        await setPending({
          blob: flow.videoBlob,
          name: flow.name || "Flow",
          context: refinements?.trim() || "",
          styleDirective: styleDirective?.trim() || "Auto-Detect",
          createdAt: Date.now(),
        });
      }
      setPendingAction("generate");
      setShowAuthModal(true);
      console.log("[handleGenerate] Auth modal should now be visible");
      return;
    }
    
    // Track generation start (FB Pixel + CAPI)
    trackStartGeneration(user.id);
    
    // FREE PLAN RESTRICTIONS
    if (!isPaidPlan) {
      // Check video duration - max 5min for FREE (same as PRO)
      const flow = flows.find(f => f.id === selectedFlowId) || flows[0];
      if (flow && flow.duration && flow.duration > 300) {
        showToast("Video too long. Maximum 5 minutes allowed.", "error");
        return;
      }
      
      // Check context length - max 2000 chars for FREE
      if (refinements && refinements.length > 2000) {
        showToast(`Context too long for Free Plan. Maximum ${2000} characters allowed. You have ${refinements.length}. Upgrade to PRO for up to 20,000 characters.`, "error");
        return;
      }
    } else {
      // PRO plan limits
      const flow = flows.find(f => f.id === selectedFlowId) || flows[0];
      if (flow && flow.duration && flow.duration > 300) {
        showToast("Video too long. Maximum 5 minutes allowed.", "error");
        return;
      }
      
      if (refinements && refinements.length > 20000) {
        showToast(`Context too long. Maximum 20,000 characters allowed. You have ${refinements.length}.`, "error");
        return;
      }
    }
    
    // SMART EDIT MODE: If we already have generated code, and context has changed,
    // use AI edit instead of regenerating from scratch
    const hasExistingProject = activeGeneration && generatedCode && generationComplete;
    const contextChanged = (refinements || "").trim() !== (activeGeneration?.refinements || "").trim();
    const styleChanged = (styleDirective || "").trim() !== (activeGeneration?.styleDirective || "").trim();
    
    console.log("[handleGenerate] hasExistingProject:", hasExistingProject, "contextChanged:", contextChanged, "styleChanged:", styleChanged, "refinements:", (refinements || "").trim().substring(0, 50));
    
    if (hasExistingProject && (contextChanged || styleChanged) && (refinements || "").trim()) {
      console.log("[handleGenerate] Entering SMART EDIT mode");
      // Use Edit mode - cheaper and preserves existing structure
      const editPrompt = (refinements || "").trim() + (styleChanged ? ` Apply style: ${styleDirective}` : "");
      
      // Credits gate for edit
      console.log("[handleGenerate] Checking credits for AI_EDIT, cost:", CREDIT_COSTS.AI_EDIT, "canAfford:", canAfford(CREDIT_COSTS.AI_EDIT));
      if (!canAfford(CREDIT_COSTS.AI_EDIT)) {
        console.log("[handleGenerate] Not enough credits for AI_EDIT - showing modal");
        setShowOutOfCreditsModal(true);
        return;
      }
      
      // Spend credits for edit
      try {
        const spendRes = await fetch("/api/credits/spend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cost: CREDIT_COSTS.AI_EDIT,
            reason: "ai_edit",
            referenceId: `edit_${Date.now()}`,
          }),
        });
        const spendData = await spendRes.json();
        if (!spendData.success) {
          setShowOutOfCreditsModal(true);
          return;
        }
        refreshCredits();
      } catch (error) {
        console.error("Failed to spend credits:", error);
        return;
      }
      
      setIsEditing(true);
      showToast("Updating project with your changes...", "info");
      
      // Get database context if connected
      let dbContextStr: string | undefined;
      if (activeGeneration) {
        try {
          const dbCtx = await getDatabaseContext(activeGeneration.id);
          if (dbCtx.isConnected) {
            dbContextStr = formatDatabaseContextForPrompt(dbCtx);
          }
        } catch {}
      }
      
      try {
        const result = await editCodeWithAI(generatedCode, editPrompt, undefined, dbContextStr);
        if (result.success && result.code) {
          // Save current state as a version before applying changes
          const versionLabel = `Context update: ${refinements.slice(0, 30)}${refinements.length > 30 ? '...' : ''}`;
          
          const newVersion: GenerationVersion = {
            id: generateId(),
            timestamp: Date.now(),
            label: versionLabel,
            code: result.code,
            flowNodes: [...flowNodes],
            flowEdges: [...flowEdges],
            styleInfo: styleInfo ? { ...styleInfo } : null,
          };
          
          // Update active generation with new refinements
          const updatedGen: GenerationRecord = {
            ...activeGeneration,
            code: result.code,
            refinements: refinements,
            styleDirective: styleDirective,
            versions: [...(activeGeneration.versions || []), newVersion].slice(-20),
          };
          
          setActiveGeneration(updatedGen);
          setGenerations(prev => prev.map(g => 
            g.id === activeGeneration.id ? updatedGen : g
          ));
          saveGenerationToSupabase(updatedGen);
          
          setGeneratedCode(result.code);
          setEditableCode(result.code);
          setDisplayedCode(result.code);
          if (previewUrl) URL.revokeObjectURL(previewUrl);
          setPreviewUrl(createPreviewUrl(result.code));
          buildArchitectureLive(result.code);
          buildFlowLive(result.code);
          setStyleInfo(extractStyleInfo(result.code));
          
          const files = generateFileStructure(result.code, flowNodes, codeMode);
          setGeneratedFiles(files);
          
          // Switch to chat mode and add response message
          setSidebarMode("chat");
          setSidebarTab("chat");
          setViewMode("preview");
          
          // Add chat message about what was updated
          // Extract just the style NAME, not the full prompt instructions
          const getStyleName = (style: string) => {
            if (!style || style === 'auto' || style === 'auto-detect') return 'Auto-detect';
            // Extract first line or title (before any newlines or detailed instructions)
            const firstLine = style.split('\n')[0].trim();
            // Remove emoji and special chars, take first ~50 chars
            const cleanName = firstLine.replace(/^[^\w\s]+/, '').trim().substring(0, 50);
            return cleanName || 'Custom style';
          };
          
          const updateMsg: ChatMessage = {
            id: generateId(),
            role: "assistant",
            content: `**Project Updated!** ✨\n\nI've applied your changes:\n${contextChanged ? `- Updated context/requirements\n` : ""}${styleChanged ? `- Applied new style: ${getStyleName(styleDirective)}\n` : ""}\nThe preview is now showing your updated design. Let me know if you want any more tweaks!`,
            timestamp: Date.now(),
            quickActions: [
              "Make more changes",
              "Adjust the layout",
              "Change colors",
              "Add animations"
            ]
          };
          setChatMessages(prev => [...prev, updateMsg]);
          
          showToast("Project updated successfully!", "success");
        } else {
          showToast(result.error || "Failed to update project", "error");
        }
      } catch (error) {
        console.error("Edit error:", error);
        showToast("Failed to update project", "error");
      } finally {
        setIsEditing(false);
      }
      return;
    }
    
    // Credits gate: check if user can afford
    console.log("[handleGenerate] Full generation path - checking credits, cost:", CREDIT_COSTS.VIDEO_GENERATE, "canAfford:", canAfford(CREDIT_COSTS.VIDEO_GENERATE));
    if (!canAfford(CREDIT_COSTS.VIDEO_GENERATE)) {
      console.log("[handleGenerate] Not enough credits for VIDEO_GENERATE - showing modal");
      setShowOutOfCreditsModal(true);
      return;
    }
    
    // Spend credits before generation
    try {
      const spendRes = await fetch("/api/credits/spend", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          cost: CREDIT_COSTS.VIDEO_GENERATE,
          reason: "video_generate",
          referenceId: `gen_${Date.now()}`,
        }),
      });
      const spendData = await spendRes.json();
      if (!spendData.success) {
        setShowOutOfCreditsModal(true);
        return;
      }
      // Refresh credits after spending
      refreshCredits();
    } catch (error) {
      console.error("Failed to spend credits:", error);
      return;
    }
    
    setIsProcessing(true);
    setGenerationComplete(false);
    setAnalysisDescription("");
    setGeneratedCode(null);
    setDisplayedCode("");
    setEditableCode("");
    setMobileSyncShownForGeneration(null); // Reset so modal can show for new generation
    setLibraryData(null); // Reset library for new generation
    setLibraryPropsOverride({}); // Reset library props
    setLibraryDocsGenerated(false); // Reset docs generation flag
    // Auto-switch to Preview mode when generation starts
    setViewMode("preview");
    
    // Track generation start time for stuck detection
    generationStartTimeRef.current = Date.now();
    streamingCompleteRef.current = false;
    pendingCodeRef.current = null;
    
    // MOBILE: Request Wake Lock to prevent screen from turning off during generation
    let wakeLock: WakeLockSentinel | null = null;
    const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobile && 'wakeLock' in navigator) {
      try {
        wakeLock = await (navigator as any).wakeLock.request('screen');
        console.log("Wake Lock acquired - screen will stay on during generation");
      } catch (err) {
        console.log("Wake Lock not available:", err);
        // Show warning to user
        showToast("Keep your screen on during generation for best results", "info");
      }
    } else if (isMobile) {
      // Wake Lock not supported - warn user
      showToast("Keep your screen on during generation", "info");
    }
    setPreviewUrl(null);
    setIsCodeEditable(false);
    setArchitecture([]);
    setStyleInfo(null);
    // Reset to componentized mode for new generation
    setCodeMode("componentized");
    setActiveFilePath("/pages/index.tsx");
    // Mark new generation session - hide old content until new content arrives
    const sessionId = `session_${Date.now()}`;
    setGenerationSessionId(sessionId);
    
    // Initialize live analysis phase - Technical UX Analysis
    const initialPhase: AnalysisPhase = {
      palette: [],
      typography: "Scanning...",
      vibe: "Analyzing...",
      layout: "Detecting...",
      container: "Scanning...",
      responsive: "Checking...",
      components: [],
      uxSignals: [],
      structureItems: [],
      componentTree: [],
      dataPatterns: []
    };
    setAnalysisPhase(initialPhase);
    setAnalysisSection("style");
    
    // Real-time technical analysis - shows AI thinking like an engineer
    const updatePhaseRealTime = async () => {
      // Phase 1: UX SIGNALS (0-3s) - Detect technical patterns
      setAnalysisSection("style");
      
      // Motion Profile Detection
      await new Promise(r => setTimeout(r, 500));
      setAnalysisPhase(prev => prev ? { 
        ...prev, 
        uxSignals: [{ type: "motion", label: "Motion Profile", value: "Scanning..." }]
      } : prev);
      
      await new Promise(r => setTimeout(r, 600));
      setAnalysisPhase(prev => prev ? { 
        ...prev, 
        uxSignals: [
          { type: "motion", label: "Motion Profile", value: "CSS Transitions", tech: "transition-all" },
          { type: "interaction", label: "Interaction Model", value: "Detecting..." }
        ]
      } : prev);
      
      await new Promise(r => setTimeout(r, 700));
      setAnalysisPhase(prev => prev ? { 
        ...prev, 
        uxSignals: [
          { type: "motion", label: "Motion Profile", value: "CSS Transitions", tech: "transition-all" },
          { type: "interaction", label: "Interaction Model", value: "Click + Hover", tech: "Alpine.js x-on" },
          { type: "responsive", label: "Layout Strategy", value: "Analyzing..." }
        ]
      } : prev);
      
      await new Promise(r => setTimeout(r, 600));
      setAnalysisPhase(prev => prev ? { 
        ...prev, 
        uxSignals: [
          { type: "motion", label: "Motion Profile", value: "CSS Transitions", tech: "transition-all" },
          { type: "interaction", label: "Interaction Model", value: "Click + Hover", tech: "Alpine.js x-on" },
          { type: "responsive", label: "Layout Strategy", value: "Mobile-First", tech: "Flexbox + Grid" },
          { type: "hierarchy", label: "Visual Hierarchy", value: "Checking..." }
        ]
      } : prev);
      
      // Phase 2: STRUCTURE (3-5s) - Component Tree Detection
      await new Promise(r => setTimeout(r, 500));
      setAnalysisSection("layout");
      
      // Build component tree hierarchically
      const componentTree: ComponentTreeNode[] = [
        { name: "PageLayout", type: "Template", status: "generating", children: ["Header", "MainContent", "Footer"] }
      ];
      setAnalysisPhase(prev => prev ? { ...prev, componentTree } : prev);
      
      await new Promise(r => setTimeout(r, 400));
      componentTree[0].status = "done";
      componentTree.push({ name: "Header", type: "Organism", status: "generating", children: ["Logo", "Navigation", "CTA Button"] });
      setAnalysisPhase(prev => prev ? { ...prev, componentTree: [...componentTree] } : prev);
      
      await new Promise(r => setTimeout(r, 350));
      componentTree[1].status = "done";
      componentTree.push({ name: "HeroSection", type: "Organism", status: "generating", children: ["Headline", "Subtext", "CTAGroup"] });
      setAnalysisPhase(prev => prev ? { ...prev, componentTree: [...componentTree] } : prev);
      
      await new Promise(r => setTimeout(r, 400));
      componentTree[2].status = "done";
      componentTree.push({ name: "ContentGrid", type: "Molecule", status: "generating", hasDataConnection: true, children: ["Card (×n)"] });
      setAnalysisPhase(prev => prev ? { ...prev, componentTree: [...componentTree] } : prev);
      
      await new Promise(r => setTimeout(r, 350));
      componentTree[3].status = "done";
      componentTree.push({ name: "Footer", type: "Organism", status: "generating", children: ["FooterNav", "Copyright"] });
      setAnalysisPhase(prev => prev ? { ...prev, componentTree: [...componentTree] } : prev);
      
      // Phase 3: COMPONENTS (5s+) - Finalize analysis
      await new Promise(r => setTimeout(r, 500));
      setAnalysisSection("components");
      
      // Finalize all
      componentTree[4].status = "done";
      
      // Finalize UX signals with technical values
      setAnalysisPhase(prev => prev ? { 
        ...prev, 
        uxSignals: [
          { type: "motion", label: "Motion Profile", value: "CSS Transitions", tech: "transition-all duration-300" },
          { type: "interaction", label: "Interaction Model", value: "Click + Hover", tech: "Alpine.js x-on:click" },
          { type: "responsive", label: "Layout Strategy", value: "Mobile-First", tech: "Tailwind sm: md: lg:" },
          { type: "hierarchy", label: "Visual Hierarchy", value: "Landing Page", tech: "Hero → Content → CTA" }
        ],
        componentTree: componentTree.map(c => ({ ...c, status: "done" as const })),
        dataPatterns: [
          { pattern: "List Iteration", component: "ContentGrid", suggestedTable: "items" }
        ],
        responsive: "Mobile-First",
        layout: "Flexbox + Grid",
        container: "Centered layout"
      } : prev);
    };
    
    updatePhaseRealTime();
    
    try {
      let flow = flows[0];
      const isMobileDevice = /Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent);
      
      // Determine video URL - use existing URL if available, or upload new
      let videoUrl: string = "";
      
      // Check if we already have a valid URL (not a blob URL, not empty)
      const hasValidUrl = flow.videoUrl && 
        flow.videoUrl.startsWith("https://") && 
        !flow.videoUrl.startsWith("blob:");
      
      if (hasValidUrl) {
        // Use existing URL (flow was restored from localStorage or already uploaded)
        videoUrl = flow.videoUrl;
        console.log("Using existing video URL:", videoUrl);
      } else {
        // Need to upload the video blob
        const videoSizeMB = flow.videoBlob.size / 1024 / 1024;
        console.log(`Video size: ${videoSizeMB.toFixed(2)} MB, mobile: ${isMobileDevice}`);
        
        // Check if blob is empty (happens when flow is restored incorrectly)
        if (flow.videoBlob.size === 0) {
          showToast("Video not available. Please re-upload the video.", "error");
          setIsProcessing(false);
          generationStartTimeRef.current = null;
          return;
        }
        
        // Max 50MB
        if (videoSizeMB > 50) {
          showToast("Video too large (max 50MB). Please use a shorter recording.", "error");
          setIsProcessing(false);
          generationStartTimeRef.current = null;
          return;
        }
        
        // Upload to Supabase
        if (!videoUrl) {
          let videoContentType = flow.videoBlob.type || "video/webm";
          
          // Normalize video format
          if (!videoContentType.startsWith("video/")) {
            videoContentType = "video/mp4";
          }
          
          const fileExt = videoContentType.includes("webm") ? "webm" : "mp4";
          const uploadSizeMB = flow.videoBlob.size / (1024 * 1024);
          console.log(`Uploading video to Supabase: type=${videoContentType}, size=${uploadSizeMB.toFixed(2)}MB`);
          
          // Get signed upload URL
          const urlRes = await fetch("/api/upload-video/get-url", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: `recording-${Date.now()}.${fileExt}`,
              contentType: videoContentType,
            }),
          });
          
          if (!urlRes.ok) {
            const errorData = await urlRes.json().catch(() => ({}));
            console.error("Failed to get upload URL:", errorData);
            showToast(errorData.error || "Failed to prepare upload. Please try again.", "error");
            setIsProcessing(false);
            generationStartTimeRef.current = null;
            return;
          }
          
          const { signedUrl, publicUrl } = await urlRes.json();
          
          // Upload directly to Supabase Storage with retry logic
          let uploadRes: Response | null = null;
          let uploadAttempts = 0;
          const maxUploadAttempts = 3;
          
          while (uploadAttempts < maxUploadAttempts) {
            uploadAttempts++;
            try {
              console.log(`Upload attempt ${uploadAttempts}/${maxUploadAttempts}...`);
              uploadRes = await fetch(signedUrl, {
                method: "PUT",
                headers: { "Content-Type": videoContentType },
                body: flow.videoBlob,
              });
              
              if (uploadRes.ok) {
                console.log("Upload successful on attempt", uploadAttempts);
                break;
              } else {
                console.error(`Upload attempt ${uploadAttempts} failed:`, uploadRes.status, uploadRes.statusText);
              }
            } catch (uploadError: any) {
              console.error(`Upload attempt ${uploadAttempts} error:`, uploadError.message);
              if (uploadAttempts === maxUploadAttempts) {
                showToast("Network error during upload. Please check your connection and try again.", "error");
                setIsProcessing(false);
                generationStartTimeRef.current = null;
                return;
              }
              // Wait before retry (exponential backoff)
              await new Promise(r => setTimeout(r, 1000 * uploadAttempts));
            }
          }
          
          if (!uploadRes || !uploadRes.ok) {
            console.error("All upload attempts failed");
            showToast("Failed to upload video after multiple attempts. Please try a smaller file or check your connection.", "error");
            setIsProcessing(false);
            generationStartTimeRef.current = null;
            return;
          }
          
          videoUrl = publicUrl;
          console.log("Video uploaded to Supabase:", videoUrl);
          
          // Update flow with permanent URL
          setFlows(prev => prev.map(f => 
            f.id === flow.id ? { ...f, videoUrl: publicUrl } : f
          ));
        }
      }
      
      // Build style directive with refinements and trim info
      // When a DS_STYLE:: is selected, fetch DS tokens and build a rich style guide
      let fullStyleDirective = "";
      const isDSStyleSelected = styleDirective.startsWith("DS_STYLE::");
      
      if (isDSStyleSelected) {
        const dsId = styleDirective.split("::")[1];
        const dsName = styleDirective.split("::")[2] || "Design System";
        console.log("[Generate] DS Style selected:", dsName, dsId);
        
        try {
          // Fetch DS info (tokens) and component specs in parallel
          const [dsInfoResponse, dsComponentsResponse] = await Promise.all([
            fetch(`/api/design-systems/${dsId}`),
            fetch(`/api/design-systems/${dsId}/components`)
          ]);
          
          let tokens: any = {};
          let dsComponents: any[] = [];
          
          if (dsInfoResponse.ok) {
            const dsInfo = await dsInfoResponse.json();
            tokens = dsInfo.designSystem?.tokens || {};
            console.log("[Generate] DS tokens loaded:", Object.keys(tokens));
          }
          
          if (dsComponentsResponse.ok) {
            const dsData = await dsComponentsResponse.json();
            dsComponents = dsData.components || [];
            console.log("[Generate] DS components loaded:", dsComponents.length);
          }
          
          // Build rich style guide from tokens
          // Filter out unreliable "discovered-" colors (Storybook chrome, not actual DS tokens)
          // Also filter out misclassified size values (rem/px/em) that got into colors
          const STORYBOOK_CHROME_COLORS = new Set(["#ff4400", "#ff0000", "#f6f9fc", "#242424", "#c6c6c6", "#646464", "#e6e6e6", "#fff", "#ffffff", "#000", "#000000"]);
          const isSizeVal = (v: string) => /^[\d.]+(?:rem|em|px|%|vh|vw|ch|pt)$/i.test(v) || /^clamp\(/i.test(v) || /^calc\(/i.test(v);
          let reliableColors: Record<string, string> = {};
          const rescuedFontSizes: Record<string, string> = {}; // sizes misclassified as colors
          let hasNamedColors = false;
          if (tokens.colors) {
            for (const [k, v] of Object.entries(tokens.colors)) {
              const val = String(v).toLowerCase().trim();
              // Safeguard: if value is a size (rem/px/em), redirect to typography
              if (isSizeVal(val)) {
                rescuedFontSizes[k] = String(v);
                continue;
              }
              if (!k.startsWith("discovered-")) {
                hasNamedColors = true;
                reliableColors[k] = String(v);
              } else if (!STORYBOOK_CHROME_COLORS.has(val)) {
                reliableColors[k] = String(v);
              }
            }
          }
          const hasReliableColors = Object.keys(reliableColors).length > 0 && hasNamedColors;

          // Read typography tokens (import stores as "typography", also check "fonts" for backwards compat)
          const typo = tokens.typography || tokens.fonts || {};
          const typoEntries: [string, string][] = [];
          if (typo.fontFamily) Object.entries(typo.fontFamily).forEach(([k, v]) => typoEntries.push([`font-${k}`, String(v)]));
          if (typo.fontSize) Object.entries(typo.fontSize).forEach(([k, v]) => typoEntries.push([`size-${k}`, String(v)]));
          if (typo.fontWeight) Object.entries(typo.fontWeight).forEach(([k, v]) => typoEntries.push([`weight-${k}`, String(v)]));
          if (typo.lineHeight) Object.entries(typo.lineHeight).forEach(([k, v]) => typoEntries.push([`leading-${k}`, String(v)]));
          // Also handle flat font entries (backwards compat)
          if (typeof typo === "object" && !typo.fontFamily && !typo.fontSize) {
            Object.entries(typo).forEach(([k, v]) => { if (typeof v === "string") typoEntries.push([k, v]); });
          }
          // Add rescued font sizes that were misclassified as colors (e.g. text-lg: 1.125rem)
          for (const [k, v] of Object.entries(rescuedFontSizes)) {
            typoEntries.push([`size-${k}`, v]);
          }

          // Read border radius (import stores as "borderRadius", also check "radii")
          const radii = tokens.borderRadius || tokens.radii || {};

          fullStyleDirective = `DESIGN SYSTEM STYLE GUIDE: "${dsName}"

=== VISUAL TOKENS ===
${hasReliableColors ? `COLORS:\n${Object.entries(reliableColors).map(([k, v]) => `  ${k}: ${v}`).join("\n")}` : "COLORS: No specific color tokens defined. Use professional colors that match the brand identity and video content."}
${typoEntries.length > 0 ? `\nTYPOGRAPHY:\n${typoEntries.map(([k, v]) => `  ${k}: ${v}`).join("\n")}` : ""}
${tokens.spacing ? `\nSPACING:\n${Object.entries(tokens.spacing).map(([k, v]) => `  ${k}: ${v}`).join("\n")}` : ""}
${Object.keys(radii).length > 0 ? `\nBORDER RADIUS:\n${Object.entries(radii).map(([k, v]) => `  ${k}: ${v}`).join("\n")}` : ""}
${tokens.shadows ? `\nSHADOWS:\n${Object.entries(tokens.shadows).map(([k, v]) => `  ${k}: ${v}`).join("\n")}` : ""}

=== STYLE RULES ===
1. USE these tokens as the primary visual language
2. Extract LAYOUT structure, CONTENT, and INTERACTIONS from the video
3. Apply Design System colors, typography, spacing to the extracted layout
4. Match component purposes and naming from the DS when building UI elements
5. ⚠️ PRESERVE THE DETECTED THEME (light/dark) FROM THE VIDEO!
   - If the video shows a LIGHT theme (white/cream backgrounds), generate LIGHT theme output using DS colors adapted for light mode
   - If the video shows a DARK theme (black/dark backgrounds), generate DARK theme output using DS colors for dark mode
   - The DS tokens define the palette, but the VIDEO defines whether it's light or dark
   - Check scanData.ui.theme AND scanData.ui.colors.background to determine theme
   - DO NOT default to dark theme when the video clearly shows light backgrounds!

${dsComponents.length > 0 ? `=== COMPONENT PATTERNS ===\n${dsComponents.slice(0, 30).map((comp: any) => {
            const variants = comp.variants?.map((v: any) => v.name).filter((n: string) => n !== "Docs").join(", ") || "Default";
            return `[${comp.name}] ${comp.docs?.description || ""}\n  Variants: ${variants}${comp.docs?.usage ? `\n  Use for: ${comp.docs.usage}` : ""}`;
          }).join("\n\n")}` : ""}`;
        } catch (dsError) {
          console.error("[Generate] Failed to fetch DS data:", dsError);
          fullStyleDirective = `Design System "${dsName}" style (tokens could not be loaded)`;
        }
      } else {
        fullStyleDirective = styleDirective || "Modern, clean design with smooth animations";
      }
      
      // Add refinements if provided
      if ((refinements || "").trim()) {
        fullStyleDirective += `. Additional refinements: ${(refinements || "").trim()}`;
      }
      
      // Add trim info if applicable
      const isTrimmed = flow.trimStart > 0 || flow.trimEnd < flow.duration;
      console.log(`Flow: trimStart=${flow.trimStart}, trimEnd=${flow.trimEnd}, duration=${flow.duration}, isTrimmed=${isTrimmed}`);
      
      if (isTrimmed) {
        fullStyleDirective += `. CRITICAL: ONLY analyze video content between timestamps ${flow.trimStart.toFixed(1)}s and ${flow.trimEnd.toFixed(1)}s. Ignore ALL content before ${flow.trimStart.toFixed(1)}s and after ${flow.trimEnd.toFixed(1)}s.`;
      } else {
        // Full video selected - add explicit instruction to watch entire video
        fullStyleDirective += `. This is a ${flow.duration} second video. Watch and analyze the ENTIRE video from 0:00 to ${formatDuration(flow.duration)}. Multiple screens or states may appear - include ALL of them.`;
      }
      
      // Check for Supabase integration
      let databaseContextStr = "";
      try {
        const dbContext = await getDatabaseContext(flow.id);
        if (dbContext.isConnected && dbContext.schemaText) {
          databaseContextStr = formatDatabaseContextForPrompt(dbContext);
          console.log("[Generate] Database context found:", dbContext.tables);
        }
      } catch (err) {
        console.log("[Generate] No database context:", err);
      }
      
      console.log("[Generate] ===== STYLE REFERENCE DEBUG =====");
      console.log("[Generate] styleReferenceImage:", styleReferenceImage);
      console.log("[Generate] styleReferenceImage URL:", styleReferenceImage?.url?.substring(0, 100));
      console.log("[Generate] styleDirective:", fullStyleDirective.substring(0, 200));
      
      // When DS style is selected, don't pass style reference image (DS tokens define the style)
      const effectiveStyleRefImage = isDSStyleSelected ? undefined : styleReferenceImage;
      console.log("[Generate] effectiveStyleRefImage:", isDSStyleSelected ? "DISABLED (DS style)" : (effectiveStyleRefImage ? "provided" : "none"));
      
      // Use STREAMING for real-time AI output when we have a video blob
      let result: { success: boolean; code?: string; error?: string; tokenUsage?: any; scanData?: any };
      let videoBlobToUse = flow.videoBlob;
      
      // If blob is empty but we have a URL, fetch the video first
      if ((!videoBlobToUse || videoBlobToUse.size === 0) && flow.videoUrl) {
        console.log("[Generate] Blob empty, fetching video from URL:", flow.videoUrl);
        setStreamingStatus("📥 Loading video from storage...");
        try {
          const response = await fetch(flow.videoUrl);
          if (response.ok) {
            videoBlobToUse = await response.blob();
            console.log("[Generate] Fetched video blob, size:", videoBlobToUse.size);
          }
        } catch (fetchError) {
          console.error("[Generate] Failed to fetch video:", fetchError);
        }
      }
      
      if (videoBlobToUse && videoBlobToUse.size > 0) {
        const videoSizeMB = videoBlobToUse.size / (1024 * 1024);
        const STREAMING_SIZE_LIMIT_MB = 3; // Vercel limit is 4.5MB, but base64 adds ~33%, so 3MB raw = ~4MB base64
        
        // SMART ROUTING: Skip streaming for large videos, go directly to server action
        if (videoSizeMB > STREAMING_SIZE_LIMIT_MB) {
          console.log(`[Generate] Video ${videoSizeMB.toFixed(2)}MB > ${STREAMING_SIZE_LIMIT_MB}MB limit, using SERVER ACTION directly`);
          setStreamingStatus("🚀 Processing large video via server...");
          setStreamingCode(null);
          setStreamingLines(0);
          
          result = await transmuteVideoToCode({
            videoUrl,
            styleDirective: fullStyleDirective,
            databaseContext: databaseContextStr || undefined,
            styleReferenceImage: effectiveStyleRefImage || undefined,
          });
          if (!result) {
            result = { success: false, error: "Server timed out (504). Video may be too large or complex. Try a shorter recording." };
          }
          console.log("[Generate] Server action completed:", result?.success ? "success" : result?.error);
        } else {
          // Small video - use streaming for real-time output
          console.log(`[Generate] Video ${videoSizeMB.toFixed(2)}MB < ${STREAMING_SIZE_LIMIT_MB}MB limit, using STREAMING mode`);
          try {
            result = await generateWithStreaming(
              videoBlobToUse,
              fullStyleDirective,
              databaseContextStr || undefined,
              effectiveStyleRefImage || undefined
            );
            
            // If streaming failed for other reasons, fallback to server action
            if (!result || !result.success) {
              console.log("[Generate] Streaming failed, falling back to server action:", result?.error);
              setStreamingStatus("🔄 Switching to server processing...");
              result = await transmuteVideoToCode({
                videoUrl,
                styleDirective: fullStyleDirective,
                databaseContext: databaseContextStr || undefined,
                styleReferenceImage: effectiveStyleRefImage || undefined,
              });
              if (!result) {
                result = { success: false, error: "Server timed out (504). Video may be too large or complex. Try a shorter recording." };
              }
              console.log("[Generate] Server action completed:", result.success ? "success" : result.error);
            }
          } catch (streamError: any) {
            console.error("[Generate] Streaming error, using fallback:", streamError);
            setStreamingStatus("🔄 Switching to server processing...");
            result = await transmuteVideoToCode({
              videoUrl,
              styleDirective: fullStyleDirective,
              databaseContext: databaseContextStr || undefined,
              styleReferenceImage: effectiveStyleRefImage || undefined,
            });
            if (!result) {
              result = { success: false, error: "Server timed out (504). Video may be too large or complex. Try a shorter recording." };
            }
            console.log("[Generate] Server action completed:", result.success ? "success" : result.error);
          }
        }
      } else {
        // Fallback to server action for URL-only cases
        console.log("[Generate] Using server action (no blob available)");
        result = await transmuteVideoToCode({
          videoUrl,
          styleDirective: fullStyleDirective,
          databaseContext: databaseContextStr || undefined,
          styleReferenceImage: effectiveStyleRefImage || undefined,
        });
        if (!result) {
          result = { success: false, error: "Server timed out (504). Video may be too large or complex. Try a shorter recording." };
        }
      }
      
      // Clear streaming status after generation
      setStreamingStatus(null);
      setStreamingCode(null);
      
      console.log("Generation result:", result);
      
      if (result && result.success && result.code) {
        // Track analytics
        updateProjectAnalytics(flow.id, "generation", result.tokenUsage?.totalTokens);
        
        // Save scanData from Multi-Pass Pipeline (Source of Truth for all other generators)
        if (result.scanData) {
          console.log("[Generate] Saving scanData from result");
          setScanData(result.scanData);
        }
        
        // Set code and preview URL
        setGeneratedCode(result.code);
        setPreviewUrl(createPreviewUrl(result.code));
        
        // Check if tab is hidden - if so, store for immediate display when visible
        if (document.hidden) {
          console.log("Tab hidden - storing code for immediate display when visible");
          pendingCodeRef.current = result.code;
          // DON'T start streaming - the visibility handler will call completeGeneration
        } else {
          // Tab visible - normal streaming flow
          setIsStreamingCode(true);
        }
        // DON'T switch view here - let the streaming completion handler do it (to "preview")
        
        // Extract real stats from code - but DON'T set complete yet (streaming first)
        const buttonCount = (result.code.match(/<button/gi) || []).length;
        const imageCount = (result.code.match(/<img/gi) || []).length;
        const componentCount = (result.code.match(/<section|<header|<footer|<nav|<aside/gi) || []).length;
        
        // Store stats but don't show complete state yet
        setAnalysisPhase(prev => prev ? {
          ...prev,
          structureItems: (prev.structureItems || []).map(s => ({ ...s, status: "done" as const })),
          stats: {
            tech: "Tailwind CSS + Alpine.js",
            componentCount: componentCount + buttonCount,
            imageCount,
            theme: styleDirective || "Modern Design"
          }
        } : prev);
        
        // Add to generation history for persistence
        // Auto-generate title from code if user hasn't set one
        let currentTitle = generationTitle || "Untitled Project";
        let isAutoTitle = false;
        
        if (currentTitle === "Untitled Project") {
          const extractedName = extractProjectName(result.code);
          if (extractedName) {
            currentTitle = extractedName;
            isAutoTitle = true;
            // Update the title state so user sees it
            setGenerationTitle(extractedName);
            console.log(`[Auto-title] Generated name: "${extractedName}"`);
          }
        }
        
        // Create initial version
        const initialVersion: GenerationVersion = {
          id: generateId(),
          timestamp: Date.now(),
          label: "Initial generation",
          code: result.code,
          flowNodes: [],
          flowEdges: [],
          styleInfo: null,
        };
        
        const newGeneration: GenerationRecord = {
          id: generateId(),
          title: currentTitle,
          autoTitle: isAutoTitle,
          timestamp: Date.now(),
          status: "complete",
          code: result.code,
          styleDirective: styleDirective,
          refinements: refinements,
          flowNodes: [], // Will be populated after buildFlowLive
          flowEdges: [],
          styleInfo: null,
          videoUrl: videoUrl,
          thumbnailUrl: flow.thumbnail, // Save video thumbnail for history
          versions: [initialVersion], // Include initial version
          tokenUsage: result.tokenUsage, // Store Gemini API token usage
          costCredits: CREDIT_COSTS.VIDEO_GENERATE, // 75 credits per generation
          user_id: user?.id, // Owner of this project for access control
          design_system_id: isDSStyleSelected ? styleDirective.split("::")[1] : null, // Link to selected Design System
        };
        setGenerations(prev => [...prev, newGeneration]);
        setActiveGeneration(newGeneration);
        // Reset published URL for new project (don't show old project's publish link)
        setPublishedUrl(null);
        
        // Immediately save to Supabase for cross-device sync
        saveGenerationToSupabase(newGeneration);
        
        // === LIBRARY EXTRACTION - DISABLED (use "Extract New Components" button instead) ===
        // Components should only appear in Library after user clicks "Extract New Components"
        // Auto-extraction was showing Icon, Footer, HomePage etc. immediately after generation
        // which confused users. Now the Library starts empty until explicit extraction.
        console.log("[Library] Auto-extraction disabled. Use 'Extract New Components' button.");
        
        // Also save to localStorage as backup (for refresh before Supabase sync completes)
        try {
          const localKey = `replay_local_project_${newGeneration.id}`;
          localStorage.setItem(localKey, JSON.stringify({
            code: newGeneration.code,
            title: newGeneration.title,
            timestamp: newGeneration.timestamp,
            flowNodes: newGeneration.flowNodes,
            flowEdges: newGeneration.flowEdges,
            styleInfo: newGeneration.styleInfo,
            styleDirective: newGeneration.styleDirective,
            refinements: newGeneration.refinements,
            versions: newGeneration.versions,
            libraryData: newGeneration.libraryData,
          }));
          console.log("[Generation] Saved backup to localStorage:", newGeneration.id);
        } catch (e) {
          console.warn("[Generation] Failed to save localStorage backup:", e);
        }
        
        // Set initial chat message showing generation is complete
        setChatMessages([{
          id: generateId(),
          role: "assistant",
          content: `**Boom. UI Reconstructed.**\n\nMatched the layout from your video using Tailwind CSS and Alpine.js for interactivity.\n\nReady to refine? Just tell me what to tweak.`,
          timestamp: Date.now(),
          quickActions: ["Make it mobile-friendly", "Tweak the colors", "Add hover effects", "Improve the spacing"]
        }]);
        
        // Library extraction is now ON-DEMAND only (click "Extract Components" button)
        // This saves API requests - user can manually trigger when needed
        
        // Generation complete - no toast needed, UI shows the result
      } else {
        const errorMsg = result?.error || "Generation failed. Please try again.";
        console.error("Generation failed:", errorMsg);
        setAnalysisDescription(`Error: ${errorMsg}`);
        showToast(errorMsg, "error");
      }
    } catch (error: any) {
      console.error("Generation error:", error);
      // Check for 413 payload too large
      let errorMsg = error.message || "Unknown error occurred";
      if (errorMsg.includes("413") || errorMsg.includes("payload") || errorMsg.includes("too large")) {
        errorMsg = "Video file is too large for processing. Try a shorter clip.";
      }
      setAnalysisDescription(`Error: ${errorMsg}`);
      showToast(errorMsg, "error");
      setIsProcessing(false);
      generationStartTimeRef.current = null;
    } finally {
      // Don't set isProcessing to false here - let the streaming effect handle it
      // isProcessing will be set to false when streaming completes
      // This prevents the loading state from disappearing while code is still being streamed
      
      // Release Wake Lock when generation ends (success or error)
      if (wakeLock) {
        try {
          await wakeLock.release();
          console.log("Wake Lock released");
        } catch (e) {
          console.log("Wake Lock release failed:", e);
        }
      }
    }
  };

  // Auto-generate project name from HTML content
  const extractProjectName = (code: string): string | null => {
    // Try to extract from <title> tag
    const titleMatch = code.match(/<title[^>]*>([^<]+)<\/title>/i);
    if (titleMatch && titleMatch[1]) {
      const title = titleMatch[1].trim();
      if (title && title.length > 0 && title.length < 50 && !title.toLowerCase().includes('untitled')) {
        return title;
      }
    }
    
    // Try to extract from nav/header logo or brand text
    // Look for text in logo area, brand element, or first link in nav
    const brandPatterns = [
      /<(?:a|span|div)[^>]*class="[^"]*(?:logo|brand|site-name)[^"]*"[^>]*>([^<]+)</i,
      /<nav[^>]*>[\s\S]*?<(?:a|span|div)[^>]*>([A-Z][a-zA-Z0-9\s]{2,20})</,
      /<header[^>]*>[\s\S]*?<(?:a|span|div)[^>]*>([A-Z][a-zA-Z0-9\s]{2,20})</,
    ];
    
    for (const pattern of brandPatterns) {
      const match = code.match(pattern);
      if (match && match[1]) {
        const brand = match[1].trim().replace(/<[^>]*>/g, '');
        if (brand && brand.length >= 2 && brand.length < 30 && /^[A-Z]/.test(brand)) {
          return brand;
        }
      }
    }
    
    // Try to extract from first H1 (hero headline)
    const h1Match = code.match(/<h1[^>]*>([\s\S]*?)<\/h1>/i);
    if (h1Match && h1Match[1]) {
      // Clean HTML tags and get text
      let h1Text = h1Match[1].replace(/<[^>]*>/g, ' ').trim();
      // Remove multiple spaces
      h1Text = h1Text.replace(/\s+/g, ' ').trim();
      // Take first 3-4 words or 30 chars max
      const words = h1Text.split(' ').slice(0, 4).join(' ');
      if (words && words.length >= 3 && words.length < 40) {
        return words;
      }
    }
    
    // Try to find any prominent brand-like text (capitalized words in header area)
    const headerArea = code.match(/<(?:header|nav)[^>]*>([\s\S]*?)<\/(?:header|nav)>/i);
    if (headerArea) {
      const capitalizedMatch = headerArea[1].match(/>([A-Z][a-zA-Z0-9]+(?:\s+[A-Z]?[a-zA-Z0-9]+)?)</);
      if (capitalizedMatch && capitalizedMatch[1]) {
        const text = capitalizedMatch[1].trim();
        if (text.length >= 2 && text.length < 25) {
          return text;
        }
      }
    }
    
    return null;
  };

  // Generate description based on code content
  const generateAnalysisDescription = (code: string, style: string): string => {
    const hasHeader = /<header|<nav/i.test(code);
    const hasHero = /hero|banner|jumbotron/i.test(code);
    const hasCards = /card|grid.*card/i.test(code);
    const hasForms = /<form|<input/i.test(code);
    const hasFooter = /<footer/i.test(code);
    const buttonCount = (code.match(/<button/gi) || []).length;
    const imageCount = (code.match(/<img/gi) || []).length;
    
    let desc = `Generated a modern ${style || "clean"} web page`;
    
    const features: string[] = [];
    if (hasHeader) features.push("navigation header");
    if (hasHero) features.push("hero section");
    if (hasCards) features.push("card components");
    if (hasForms) features.push("interactive forms");
    if (hasFooter) features.push("footer");
    
    if (features.length > 0) {
      desc += ` featuring ${features.slice(0, 3).join(", ")}`;
      if (features.length > 3) desc += ` and more`;
    }
    
    desc += `. Includes ${buttonCount} interactive button${buttonCount !== 1 ? 's' : ''}`;
    if (imageCount > 0) desc += ` and ${imageCount} image${imageCount !== 1 ? 's' : ''}`;
    desc += `. Built with Tailwind CSS and Alpine.js for smooth interactions and modern styling.`;
    
    return desc;
  };

  // Compress image to reduce size (max 1MB for Edit with AI)
  const compressImage = useCallback(async (blob: Blob, maxSizeKB: number = 1024): Promise<Blob> => {
    return new Promise((resolve) => {
      const img = document.createElement('img');
      const url = URL.createObjectURL(blob);
      
      img.onload = () => {
        URL.revokeObjectURL(url);
        
        // Calculate target dimensions (max 1200px on longest side)
        const maxDim = 1200;
        let { width, height } = img;
        
        if (width > maxDim || height > maxDim) {
          if (width > height) {
            height = (height / width) * maxDim;
            width = maxDim;
          } else {
            width = (width / height) * maxDim;
            height = maxDim;
          }
        }
        
        // Create canvas and draw resized image
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        if (!ctx) { resolve(blob); return; }
        
        ctx.drawImage(img, 0, 0, width, height);
        
        // Try different quality levels until we're under maxSize
        let quality = 0.8;
        const tryCompress = () => {
          canvas.toBlob((result) => {
            if (!result) { resolve(blob); return; }
            
            if (result.size > maxSizeKB * 1024 && quality > 0.3) {
              quality -= 0.1;
              tryCompress();
            } else {
              console.log(`[compressImage] Compressed from ${(blob.size/1024).toFixed(0)}KB to ${(result.size/1024).toFixed(0)}KB`);
              resolve(result);
            }
          }, 'image/jpeg', quality);
        };
        
        tryCompress();
      };
      
      img.onerror = () => {
        URL.revokeObjectURL(url);
        resolve(blob); // Return original on error
      };
      
      img.src = url;
    });
  }, []);

  // Convert image URL to base64 (for sending to AI) - with compression
  const urlToBase64 = useCallback(async (url: string): Promise<string | null> => {
    try {
      const response = await fetch(url);
      let blob = await response.blob();
      
      // Compress if larger than 500KB
      if (blob.size > 500 * 1024) {
        console.log(`[urlToBase64] Image ${(blob.size/1024).toFixed(0)}KB - compressing...`);
        blob = await compressImage(blob, 800);
      }
      
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result as string;
          // Remove data URL prefix to get just the base64
          // Handle mimeTypes that might contain commas (e.g., codecs)
          const base64Marker = ";base64,";
          const base64Index = base64.indexOf(base64Marker);
          if (base64Index !== -1) {
            resolve(base64.substring(base64Index + base64Marker.length));
          } else {
            const commaIndex = base64.indexOf(",");
            resolve(commaIndex !== -1 ? base64.substring(commaIndex + 1) : null);
          }
        };
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.error("Error converting URL to base64:", e);
      return null;
    }
  }, [compressImage]);

  // Handle paste for images in chat/edit input (CTRL+V)
  const handlePasteImage = useCallback(async (e: React.ClipboardEvent<HTMLTextAreaElement | HTMLInputElement>) => {
    const clipboardData = e.clipboardData;
    if (!clipboardData) return;
    
    // Check for files first (screenshot, copied file)
    const files = clipboardData.files;
    const items = clipboardData.items;
    
    // Try to find an image in files
    let imageFile: File | null = null;
    
    if (files && files.length > 0) {
      for (const file of Array.from(files)) {
        if (file.type.startsWith('image/')) {
          imageFile = file;
          break;
        }
      }
    }
    
    // If no file found, check items (for some browsers)
    if (!imageFile && items) {
      for (const item of Array.from(items)) {
        if (item.type.startsWith('image/')) {
          imageFile = item.getAsFile();
          if (imageFile) break;
        }
      }
    }
    
    // If no image found, let default paste behavior happen
    if (!imageFile) return;
    
    // Prevent default to stop text paste
    e.preventDefault();
    
    // Create temporary preview immediately
    const tempId = generateId();
    const tempUrl = URL.createObjectURL(imageFile);
    const imgName = `Zdjęcie ${new Date().toLocaleTimeString()}`;
    
    // Add with uploading state
    setEditImages(prev => [...prev, { id: tempId, url: tempUrl, name: imgName, file: imageFile!, uploading: true }]);
    showToast("Wgrywanie zdjęcia...", "info");
    
    // Upload to Supabase
    try {
      const formData = new FormData();
      formData.append('file', imageFile, `pasted-${Date.now()}.png`);
      formData.append('userId', user?.id || 'anon');
      
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData,
      });
      
      if (response.ok) {
        const data = await response.json();
        // Update with real URL
        setEditImages(prev => prev.map(img => 
          img.id === tempId ? { ...img, url: data.url, uploading: false } : img
        ));
        showToast("Zdjęcie dołączone!", "success");
      } else {
        // Remove failed upload
        setEditImages(prev => prev.filter(img => img.id !== tempId));
        showToast("Nie udało się wgrać zdjęcia", "error");
      }
    } catch (err) {
      console.error("Upload error:", err);
      setEditImages(prev => prev.filter(img => img.id !== tempId));
      showToast("Błąd podczas wgrywania", "error");
    }
  }, [user?.id, showToast]);

  const handleEdit = async () => {
    // Prevent double execution
    if (isEditing) {
      console.log('[handleEdit] Already editing, skipping...');
      return;
    }
    
    console.log('[handleEdit] Starting edit...');
    console.log('[handleEdit] editInput:', editInput);
    console.log('[handleEdit] editImages:', editImages.length);
    console.log('[handleEdit] editableCode exists:', !!editableCode);
    
    if ((!(editInput || "").trim() && editImages.length === 0) || !editableCode) {
      console.log('[handleEdit] Early return - no input or no code');
      showToast("Enter a description of what to change", "error");
      return;
    }
    
    // Auth gate
    if (!user) {
      console.log('[handleEdit] No user - showing auth modal');
      setPendingAction("edit");
      setShowAuthModal(true);
      return;
    }
    
    // Credits gate
    if (!canAfford(CREDIT_COSTS.AI_EDIT)) {
      console.log('[handleEdit] Not enough credits');
      setShowOutOfCreditsModal(true);
      return;
    }
    
    // Spend credits
    try {
      console.log('[handleEdit] Spending credits...');
      const spendRes = await fetch("/api/credits/spend", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          cost: CREDIT_COSTS.AI_EDIT,
          reason: "ai_edit",
          referenceId: `edit_${Date.now()}`,
        }),
      });
      const spendData = await spendRes.json();
      console.log('[handleEdit] Spend result:', spendData);
      if (!spendData.success) {
        setShowOutOfCreditsModal(true);
        return;
      }
      refreshCredits();
    } catch (error) {
      console.error("[handleEdit] Failed to spend credits:", error);
      showToast("Failed to process credits", "error");
      return;
    }
    
    setIsEditing(true);
    
    // Extract page name from editInput to track which file is being generated
    const pageMatch = editInput.match(/@([a-zA-Z0-9-_]+)/);
    if (pageMatch) {
      const pageName = pageMatch[1].toLowerCase().replace(/[^a-z0-9]+/g, '-');
      setGeneratingFilePath(`/pages/${pageName}.html`);
    }
    
    try {
      // Include selected node context if any
      let prompt = editInput;
      if (selectedArchNode) {
        prompt = `For the @${selectedArchNode} element: ${editInput}`;
      }
      
      // Process images - use Supabase URLs directly, convert blob URLs to base64
      let imageData: { base64?: string; url?: string; mimeType: string; name: string }[] = [];
      if (editImages.length > 0) {
        console.log('[handleEdit] Processing', editImages.length, 'images');
        for (const img of editImages) {
          try {
            // Check if it's a Supabase URL (public URL)
            if (img.url.startsWith('https://') && !img.url.startsWith('blob:')) {
              // Use URL directly
              console.log('[handleEdit] Using Supabase URL:', img.url);
              imageData.push({
                url: img.url,
                mimeType: 'image/png',
                name: img.name,
              });
            } else {
              // Convert blob URL to base64
              let blob: Blob;
              if (img.file) {
                blob = img.file;
              } else {
                const response = await fetch(img.url);
                blob = await response.blob();
              }
              const base64 = await new Promise<string>((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                  const result = reader.result as string;
                  if (result) {
                    // Handle mimeTypes that might contain commas (e.g., codecs)
                    const base64Marker = ";base64,";
                    const base64Index = result.indexOf(base64Marker);
                    if (base64Index !== -1) {
                      resolve(result.substring(base64Index + base64Marker.length));
                    } else {
                      const commaIndex = result.indexOf(",");
                      resolve(commaIndex !== -1 ? result.substring(commaIndex + 1) : '');
                    }
                  } else {
                    reject(new Error('Invalid base64 result'));
                  }
                };
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(blob);
              });
              if (base64 && base64.length > 100) {
                imageData.push({
                  base64,
                  mimeType: blob.type || 'image/png',
                  name: img.name,
                });
              }
            }
          } catch (e) {
            console.error('Failed to process image:', img.name, e);
          }
        }
        console.log('[handleEdit] Successfully processed', imageData.length, 'images');
      }
      
      console.log('[handleEdit] Calling editCodeWithAI with prompt:', prompt.substring(0, 100));
      console.log('[handleEdit] Images to send:', imageData.length);
      
      // Get database context if connected
      let editDbContext: string | undefined;
      if (activeGeneration) {
        try {
          const dbCtx = await getDatabaseContext(activeGeneration.id);
          if (dbCtx.isConnected) {
            editDbContext = formatDatabaseContextForPrompt(dbCtx);
            console.log('[handleEdit] Database context loaded:', dbCtx.tables);
          }
        } catch {}
      }
      
      const result = await editCodeWithAI(editableCode, prompt, imageData.length > 0 ? imageData : undefined, editDbContext);
      
      console.log('[handleEdit] Full result:', JSON.stringify({ success: result.success, error: result.error, codeLength: result.code?.length }));
      console.log('[handleEdit] Result code exists:', !!result.code);
      console.log('[handleEdit] Result code type:', typeof result.code);
      
      if (result.success && result.code && result.code.length > 0) {
        console.log('[handleEdit] SUCCESS - Applying code changes...');
        
        // Track analytics
        if (activeGeneration) {
          updateProjectAnalytics(activeGeneration.id, "edit");
        }
        
        // Save current state as a version before applying changes
        if (activeGeneration && generatedCode) {
          console.log('[handleEdit] Saving version...');
          const versionLabel = selectedArchNode 
            ? `AI Edit: @${selectedArchNode}` 
            : `AI Edit: ${editInput.slice(0, 30)}${editInput.length > 30 ? '...' : ''}`;
          
          const newVersion: GenerationVersion = {
            id: generateId(),
            timestamp: Date.now(),
            label: versionLabel,
            code: result.code,
            flowNodes: [...flowNodes],
            flowEdges: [...flowEdges],
            styleInfo: styleInfo ? { ...styleInfo } : null,
          };
          
          setGenerations(prev => prev.map(gen => {
            if (gen.id === activeGeneration.id) {
              const existingVersions = gen.versions || [];
              const updatedVersions = [...existingVersions, newVersion].slice(-20);
              return { ...gen, versions: updatedVersions };
            }
            return gen;
          }));
          
          setActiveGeneration(prev => {
            if (!prev) return prev;
            const existingVersions = prev.versions || [];
            const updatedVersions = [...existingVersions, newVersion].slice(-20);
            // Also save to Supabase for sync
            const updatedGen: GenerationRecord = { 
              ...prev, 
              versions: updatedVersions, 
              code: result.code || prev.code 
            };
            saveGenerationToSupabase(updatedGen);
            return updatedGen;
          });
        }
        
        console.log('[handleEdit] Setting generatedCode...');
        setGeneratedCode(result.code);
        console.log('[handleEdit] Setting editableCode...');
        setEditableCode(result.code);
        console.log('[handleEdit] Setting displayedCode...');
        setDisplayedCode(result.code);
        console.log('[handleEdit] Creating preview URL...');
        if (previewUrl) URL.revokeObjectURL(previewUrl);
        const newPreviewUrl = URL.createObjectURL(new Blob([result.code], { type: "text/html" }));
        setPreviewUrl(newPreviewUrl);
        console.log('[handleEdit] Preview URL created:', newPreviewUrl);
        // Debug: Check if new page was injected
        const pageMatches = result.code.match(/x-show\s*=\s*["']currentPage\s*===\s*['"]([^'"]+)['"]/gi);
        console.log('[handleEdit] Pages found in returned code:', pageMatches?.map(m => m.match(/['"]([^'"]+)['"]$/)?.[1]));
        console.log('[handleEdit] Building architecture...');
        buildArchitectureLive(result.code);
        console.log('[handleEdit] Building flow...');
        buildFlowLive(result.code);
        console.log('[handleEdit] Extracting style info...');
        setStyleInfo(extractStyleInfo(result.code));
        
        // Regenerate file structure with the new code
        const newCode = result.code;
        setTimeout(() => {
          console.log('[handleEdit] Regenerating file structure...');
          const files = generateFileStructure(newCode, flowNodes, codeMode);
          setGeneratedFiles(files);
          setGeneratingFilePath(null);
        }, 100);
        
        console.log('[handleEdit] ALL DONE - showing toast');
        showToast("Changes applied!", "success");
        
        // CRITICAL: Save edited code to Supabase immediately!
        // The useEffect won't trigger because generationComplete check
        if (activeGeneration && user) {
          const editedGen: GenerationRecord = {
            ...activeGeneration,
            code: result.code,
            flowNodes: flowNodes,
            flowEdges: flowEdges,
            styleInfo: styleInfo,
            status: "complete",
          };
          console.log('[handleEdit] Saving edited code to Supabase...');
          saveGenerationToSupabase(editedGen);
        }
        
        // Add response to chat explaining what was done
        const responseMsg = analyzeCodeChanges(editableCode, result.code, editInput);
        setChatMessages(prev => [...prev, 
          { id: generateId(), role: "user", content: editInput, timestamp: Date.now() - 1 },
          { id: generateId(), role: "assistant", content: responseMsg, timestamp: Date.now() }
        ]);
        
        // Switch to preview tab to show the result
        setViewMode("preview");
        
        // Only close panel and clear state on success
        setIsEditing(false);
        setEditInput("");
        setSelectedElement(null);
        editImages.forEach(img => URL.revokeObjectURL(img.url));
        setEditImages([]);
        setShowFloatingEdit(false);
        setSelectedArchNode(null);
      } else {
        // Show error but keep panel open so user can retry
        console.error('[handleEdit] AI edit failed:', result.error);
        showToast(result.error || "Edit failed - try again", "error");
        setIsEditing(false);
        setSelectedElement(null); // Clear pointer selection on error
      }
    } catch (error: any) {
      console.error("Edit error:", error);
      showToast(error.message || "Failed to edit - try again", "error");
      setIsEditing(false);
      setSelectedElement(null); // Clear pointer selection on error
    }
  };

  // Stream Blueprint edit with live updates
  const streamBlueprintEdit = async (
    componentCode: string,
    componentName: string,
    userRequest: string,
    onPartial: (code: string) => void,
    onComplete: (code: string) => void,
    onError: (error: string) => void
  ) => {
    try {
      const response = await fetch('/api/blueprint/edit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          componentCode,
          componentName,
          userRequest,
          componentStyle: 'Dark theme with zinc backgrounds, rounded corners, subtle shadows'
        })
      });
      
      if (!response.ok) {
        // Try to parse as JSON error, but handle SSE format too
        const text = await response.text();
        try {
          const errorData = JSON.parse(text);
          onError(errorData.error || 'Request failed');
        } catch {
          onError(`Request failed (${response.status})`);
        }
        return;
      }
      
      const reader = response.body?.getReader();
      if (!reader) {
        onError('No response stream');
        return;
      }
      
      const decoder = new TextDecoder();
      let buffer = '';
      let lastPartialCode = '';
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        buffer += decoder.decode(value, { stream: true });
        
        // Process SSE events - split by newline(s)
        const lines = buffer.split(/\n\n+/);
        buffer = lines.pop() || '';
        
        for (const line of lines) {
          const dataLine = line.trim();
          if (dataLine.startsWith('data: ')) {
            try {
              const jsonStr = dataLine.slice(6).trim();
              if (!jsonStr) continue;
              
              const data = JSON.parse(jsonStr);
              
              if (data.type === 'partial' && data.code) {
                lastPartialCode = data.code;
                onPartial(data.code);
              } else if (data.type === 'done' && data.success && data.code) {
                onComplete(data.code);
                return; // Done, exit early
              } else if (data.type === 'error') {
                onError(data.error || 'Unknown error');
                return;
              }
            } catch (parseErr) {
              // Ignore parse errors for incomplete JSON chunks
              console.log('SSE parse skip:', dataLine.slice(0, 50));
            }
          }
        }
      }
      
      // If stream ended without 'done' event but we have partial code, use it
      if (lastPartialCode) {
        onComplete(lastPartialCode);
      }
    } catch (error: any) {
      onError(error.message || 'Network error');
    }
  };

  const applyCodeChanges = () => {
    if (editableCode) {
      // Update the source HTML
      setGeneratedCode(editableCode);
      setDisplayedCode(editableCode);
      if (previewUrl) URL.revokeObjectURL(previewUrl);
      setPreviewUrl(createPreviewUrl(editableCode));
      setIsCodeEditable(false);
      
      // Regenerate file structure with updated code
      const files = generateFileStructure(editableCode, flowNodes, codeMode);
      setGeneratedFiles(files);
    }
  };
  
  // When entering edit mode, always show the raw HTML for editing
  const handleEnterEditMode = () => {
    setEditableCode(generatedCode || displayedCode);
    setIsCodeEditable(true);
    // Switch to single-file mode for editing the actual HTML
    setCodeMode("single-file");
    setActiveFilePath("/pages/index.html");
  };

  const handleDownload = () => {
    if (!editableCode) return;
    
    // Demo mode: download is Pro feature
    if (isDemoMode) {
      setUpgradeFeature("download");
      setShowUpgradeModal(true);
      return;
    }
    
    // Not logged in: require sign up
    if (!user) {
      setShowAuthModal(true);
      showToast("Sign up free to download code. You get 1 free generation!", "info");
      return;
    }
    
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([editableCode], { type: "text/html" }));
    // Use project title for filename, sanitize for safe filename
    const filename = (generationTitle || "generated")
      .replace(/[^a-zA-Z0-9\s-]/g, "")
      .replace(/\s+/g, "-")
      .toLowerCase()
      .slice(0, 50) || "generated";
    a.download = `${filename}.html`;
    a.click();
  };

  const handlePublishClick = () => {
    if (!editableCode) return;
    
    // Demo mode: publish is Pro feature
    if (isDemoMode) {
      setUpgradeFeature("publish");
      setShowUpgradeModal(true);
      return;
    }
    
    // Not logged in: require sign up
    if (!user) {
      setShowAuthModal(true);
      showToast("Sign up free to publish. You get 1 free generation!", "info");
      return;
    }
    
    // Initialize published URL from active generation if exists
    if (activeGeneration?.publishedSlug) {
      setPublishedUrl(`https://www.replay.build/p/${activeGeneration.publishedSlug}`);
    }
    setShowPublishModal(true);
  };

  const handlePublish = async () => {
    if (!editableCode || isPublishing) return;
    
    setIsPublishing(true);
    try {
      // ONLY use the slug from the active generation - never from publishedUrl state (which could be from a different project)
      const existingSlug = activeGeneration?.publishedSlug;
      console.log('[handlePublish] existingSlug:', existingSlug, 'activeGeneration:', activeGeneration?.id);
      
      // ═══════════════════════════════════════════════════════════════════════════
      // PRIORITY ORDER for finding the best code to publish:
      // 1. generatedCode (original AI output with full React/Babel) 
      // 2. HTML file from generatedFiles
      // 3. editableCode (fallback - may be incomplete)
      // ═══════════════════════════════════════════════════════════════════════════
      let publishCode = '';
      
      // FIRST: Try to use generatedCode if it's a full HTML document with React
      if (generatedCode && (generatedCode.includes('<!DOCTYPE') || generatedCode.includes('<html'))) {
        publishCode = generatedCode;
        console.log('[handlePublish] Using generatedCode (full HTML with React/Babel)');
      } else {
        // Find HTML file in generatedFiles (flat FileNode array)
        const htmlFile = generatedFiles.find(f => 
          f.language === 'html' && (f.path.includes('index.html') || f.name === 'index.html')
        );
        
        // Try to get HTML from generatedFiles
        if (htmlFile?.content && htmlFile.content.includes('<!DOCTYPE')) {
          publishCode = htmlFile.content;
          console.log('[handlePublish] Using HTML from generatedFiles:', htmlFile.path);
        } else {
          // Fallback to editableCode
          publishCode = editableCode;
          console.log('[handlePublish] Using editableCode as fallback');
        }
      }
      
      // ═══════════════════════════════════════════════════════════════════════════
      // CRITICAL: Preserve full HTML documents with React/Babel - don't strip scripts!
      // ═══════════════════════════════════════════════════════════════════════════
      
      // If code is already a full HTML document, use it as-is (preserve React/Babel!)
      if (publishCode.includes('<!DOCTYPE') || publishCode.includes('<html')) {
        console.log('[handlePublish] Using full HTML document as-is (preserving React/Babel)');
        // Just ensure className is converted to class for static content
        // But DON'T touch script contents - React needs className there!
      } else if (!publishCode.includes('cdn.tailwindcss.com')) {
        // Code is not a full HTML document - need to wrap it
        
        // Check if this is JSX/React code
        if (publishCode.includes('export default function') || 
            publishCode.includes('const App') || 
            publishCode.includes('useState') ||
            publishCode.includes('type="text/babel"')) {
          // This is React/JSX code - wrap with React/Babel runtime!
          console.log('[handlePublish] Wrapping React/JSX code with Babel runtime');
          
          publishCode = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${generationTitle || 'Untitled Project'}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { min-height: 100vh; font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="antialiased bg-[#0a0a0a] text-white">
  <div id="root"></div>
  <script>
    // Make React hooks globally available
    const { useState, useEffect, useRef, useCallback, useMemo, useContext, useReducer, useLayoutEffect, Fragment } = React;
  </script>
  <script type="text/babel" data-presets="react">
${publishCode}
  </script>
</body>
</html>`;
        } else {
          // Plain HTML snippet without React - just wrap with CDN scripts
          console.log('[handlePublish] Wrapping plain HTML with CDN scripts');
          
          publishCode = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${generationTitle || 'Untitled Project'}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { min-height: 100vh; font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-[#0a0a0a] text-white">
${publishCode}
</body>
</html>`;
        }
      }
      
      // ═══════════════════════════════════════════════════════════════════════════
      // VALIDATION: Ensure code is valid before publishing
      // ═══════════════════════════════════════════════════════════════════════════
      const trimmedCode = publishCode.trim();
      const isValidCode = trimmedCode.startsWith('<!DOCTYPE') || 
                          trimmedCode.startsWith('<html') || 
                          trimmedCode.startsWith('<') ||
                          trimmedCode.includes('<!DOCTYPE');
      
      // Check for obviously broken code (starts with ); } or similar garbage)
      const isBrokenCode = /^[\s\)\}\];,]+/.test(trimmedCode) || 
                           trimmedCode.length < 100 ||
                           (!trimmedCode.includes('<') && !trimmedCode.includes('function'));
      
      if (!isValidCode || isBrokenCode) {
        console.error('[handlePublish] Code validation failed - code appears broken or incomplete');
        console.error('[handlePublish] First 200 chars:', trimmedCode.substring(0, 200));
        showToast("Cannot publish - code appears broken. Please regenerate the project.", "error");
        setIsPublishing(false);
        return;
      }
      
      // ═══════════════════════════════════════════════════════════════════════════
      // INJECT VISIBILITY FIX - Same as preview uses!
      // This ensures published page looks exactly like preview
      // ═══════════════════════════════════════════════════════════════════════════
      const visibilityFix = `
<style id="publish-visibility-fix">
  /* AGGRESSIVE VISIBILITY FIX - Same as preview */
  [style*="opacity: 0"], [style*="opacity:0"], [style*="opacity: 0."] { opacity: 1 !important; }
  [style*="visibility: hidden"], [style*="visibility:hidden"] { visibility: visible !important; }
  .fade-up, .fade-in, .fade-down, .slide-up, .slide-in, .slide-left, .slide-right,
  .scale-up, .rotate-in, .blur-fade, .animate-fade,
  [class*="fade-"], [class*="slide-"], [class*="stagger-"], [class*="animate-"],
  [class*="gsap"], [class*="scroll"] {
    opacity: 1 !important;
    visibility: visible !important;
  }
  .stagger-cards, .stagger-cards > *, [class*="stagger"] > * {
    opacity: 1 !important;
    visibility: visible !important;
  }
  [class*="card"], [class*="Card"], [class*="step"], [class*="Step"],
  [class*="feature"], [class*="Feature"], [class*="item"], [class*="Item"] {
    opacity: 1 !important;
    visibility: visible !important;
  }
  .grid > *, .flex > *, section > div, section > * {
    opacity: 1 !important;
    visibility: visible !important;
  }
  [data-state="hidden"], [data-visible="false"], [data-aos] {
    opacity: 1 !important;
    visibility: visible !important;
    transform: none !important;
  }
</style>
<script>
(function() {
  function forceVisible() {
    document.querySelectorAll('*').forEach(function(el) {
      var style = window.getComputedStyle(el);
      if (parseFloat(style.opacity) < 0.1) el.style.setProperty('opacity', '1', 'important');
      if (style.visibility === 'hidden') el.style.setProperty('visibility', 'visible', 'important');
    });
  }
  document.addEventListener('DOMContentLoaded', function() { forceVisible(); setTimeout(forceVisible, 100); setTimeout(forceVisible, 300); });
  window.addEventListener('load', function() { forceVisible(); setTimeout(forceVisible, 100); setTimeout(forceVisible, 500); setTimeout(forceVisible, 1000); });
  var count = 0; var iv = setInterval(function() { forceVisible(); if (++count > 20) clearInterval(iv); }, 100);
})();
</script>`;
      
      // Inject visibility fix into the code
      if (publishCode.includes('</head>')) {
        publishCode = publishCode.replace('</head>', `${visibilityFix}\n</head>`);
        console.log('[handlePublish] Injected visibility fix before </head>');
      } else if (publishCode.includes('<body')) {
        publishCode = publishCode.replace('<body', `${visibilityFix}\n<body`);
        console.log('[handlePublish] Injected visibility fix before <body>');
      } else if (publishCode.includes('</body>')) {
        publishCode = publishCode.replace('</body>', `${visibilityFix}\n</body>`);
        console.log('[handlePublish] Injected visibility fix before </body>');
      }
      
      console.log('[handlePublish] Code validation passed, publishing...');
      console.log('[handlePublish] Sending code length:', publishCode.length, 'existingSlug:', existingSlug);
      console.log('[handlePublish] Code first 100 chars:', publishCode.substring(0, 100));
      
      const response = await fetch("/api/publish", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: publishCode,
          title: generationTitle || "Untitled Project",
          thumbnailDataUrl: null,
          existingSlug,
          libraryData: libraryData || null,
        }),
      });
      
      const data = await response.json();
      console.log('[handlePublish] API response:', data);
      
      if (!response.ok) {
        console.error('[handlePublish] API error:', response.status, data);
        showToast(data.error || "Failed to update", "error");
        setIsPublishing(false);
        return;
      }
      
      if (data.success && data.url) {
        const newSlug = data.slug;
        setPublishedUrl(data.url);
        
        // Save the slug to the generation record for future updates
        if (newSlug) {
          if (activeGeneration) {
            const updatedGen: GenerationRecord = {
              ...activeGeneration,
              publishedSlug: newSlug,
            };
            setActiveGeneration(updatedGen);
            setGenerations(prev => prev.map(g => 
              g.id === activeGeneration.id ? updatedGen : g
            ));
            // Also save to Supabase
            saveGenerationToSupabase(updatedGen);
          }
          // Skip localStorage save here - let the dedicated effect handle it
          // This prevents quota issues from multiple save attempts
        }
        
        // Track export analytics
        if (activeGeneration && !data.updated) {
          updateProjectAnalytics(activeGeneration.id, "export");
        }
        
        showToast(data.updated ? "Project updated!" : "Project published!", "success");
      } else {
        showToast(data.error || "Failed to publish", "error");
      }
    } catch (error) {
      console.error("Publish error:", error);
      showToast("Failed to publish project", "error");
    } finally {
      setIsPublishing(false);
    }
  };

  const handleRefresh = () => {
    // Disable editing modes on refresh
    setIsDirectEditMode(false);
    setIsPointAndEdit(false);
    setSelectedElement(null);

    // Refresh the preview by re-creating the blob URL
    if (editableCode) {
      try {
        if (previewUrl) URL.revokeObjectURL(previewUrl);
        setPreviewUrl(createPreviewUrl(editableCode));
        // Rebuild architecture, flow and style
        buildArchitectureLive(editableCode);
        buildFlowLive(editableCode);
        setStyleInfo(extractStyleInfo(editableCode));
      } catch (err) {
        console.error('Refresh failed:', err);
        // At minimum re-create the preview URL
        try {
          setPreviewUrl(createPreviewUrl(editableCode));
        } catch (e) { /* silently fail */ }
      }
    }
  };

  // Select architecture node and open edit
  const handleArchNodeClick = (nodeId: string) => {
    if (selectedArchNode === nodeId) {
      setSelectedArchNode(null);
    } else if (!isEditing) {
      setSelectedArchNode(nodeId);
      setEditInput(`@${nodeId} `);
      setShowFloatingEdit(true);
    }
  };

  // File Tree Item Component for Code tab
  const FileTreeItem = ({ 
    item, 
    activeFilePath, 
    onFileClick, 
    onFolderToggle,
    expandedFolders,
    generatingPath,
    depth = 0 
  }: { 
    item: FileTreeFolder | FileTreeFile;
    activeFilePath: string;
    onFileClick: (path: string, isStub?: boolean, nodeId?: string) => void;
    onFolderToggle: (path: string) => void;
    expandedFolders: Set<string>;
    generatingPath?: string | null;
    depth?: number;
  }) => {
    const paddingLeft = depth * 12 + 4;
    
    if (item.type === "folder") {
      const folder = item as FileTreeFolder;
      const isExpanded = expandedFolders.has(folder.path);
      const folderColors: Record<string, string> = {
        pages: "text-blue-400/60",
        components: "text-yellow-400/60",
        styles: "text-purple-400/60",
        types: "text-green-400/60",
        layout: "text-cyan-400/60",
        sections: "text-zinc-300/60"
      };
      const colorClass = folderColors[folder.name] || "text-zinc-500";
      
      return (
        <div>
          <button
            onClick={() => onFolderToggle(folder.path)}
            className="w-full flex items-center gap-1 px-1 py-0.5 hover:bg-zinc-800/50 rounded text-zinc-500 transition-colors min-w-0"
            style={{ paddingLeft }}
          >
            <ChevronRight className={cn("w-2.5 h-2.5 flex-shrink-0 transition-transform", isExpanded && "rotate-90")} />
            <Folder className={cn("w-3 h-3 flex-shrink-0", colorClass)} />
            <span className="text-[10px] truncate">{folder.name}</span>
            <span className="flex-shrink-0 ml-auto text-[8px] text-white/20">{folder.children.length}</span>
          </button>
          {isExpanded && (
            <div>
              {folder.children
                .sort((a, b) => {
                  // Folders first, then files
                  if (a.type !== b.type) return a.type === "folder" ? -1 : 1;
                  return a.name.localeCompare(b.name);
                })
                .map((child) => (
                  <FileTreeItem
                    key={child.path}
                    item={child}
                    activeFilePath={activeFilePath}
                    onFileClick={onFileClick}
                    onFolderToggle={onFolderToggle}
                    expandedFolders={expandedFolders}
                    generatingPath={generatingPath}
                    depth={depth + 1}
                  />
                ))}
            </div>
          )}
        </div>
      );
    }
    
    // File
    const file = item as FileTreeFile;
    const isActive = file.path === activeFilePath;
    const isStub = file.isStub;
    const isGenerating = generatingPath === file.path || generatingPath === file.sourceNodeId;
    
    const fileIcons: Record<string, { icon: typeof FileCode; color: string }> = {
      page: { icon: FileCode, color: "text-blue-400" },
      component: { icon: Box, color: "text-yellow-400" },
      style: { icon: Paintbrush, color: "text-purple-400" },
      type: { icon: FileCode, color: "text-green-400" },
      stub: { icon: FileCode, color: "text-white/20" }
    };
    const { icon: FileIcon, color: iconColor } = fileIcons[file.fileType] || fileIcons.page;
    
    return (
      <button
        onClick={() => !isGenerating && onFileClick(file.path, isStub, file.sourceNodeId)}
        className={cn(
          "w-full flex items-center gap-1.5 px-1.5 py-0.5 rounded text-[10px] transition-colors min-w-0",
          isGenerating 
            ? "bg-zinc-800/5 text-zinc-300/70 animate-pulse"
            : isActive 
              ? "bg-zinc-800/10 text-zinc-300" 
              : isStub 
                ? "text-white/20 hover:bg-zinc-800/50 italic" 
                : "text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-400"
        )}
        style={{ paddingLeft: paddingLeft + 14 }}
        title={isGenerating ? `Generating ${file.name}...` : isStub ? `${file.name} - Click to create with AI` : file.name}
        disabled={isGenerating}
      >
        {isGenerating ? (
          <Loader2 className="w-3 h-3 flex-shrink-0 text-zinc-300 animate-spin" />
        ) : (
          <FileIcon className={cn("w-3 h-3 flex-shrink-0", isActive ? "text-zinc-300" : isStub ? "opacity-30" : iconColor)} />
        )}
        <span className={cn("truncate", isStub && "opacity-60", isGenerating && "text-zinc-300/70")}>{file.name}</span>
        {isGenerating && <span className="flex-shrink-0 ml-auto text-[8px] text-zinc-300/60 animate-pulse">...</span>}
        {isStub && !isGenerating && <span className="flex-shrink-0 ml-auto text-[7px] text-zinc-300/50">+</span>}
      </button>
    );
  };

  const EmptyState = ({ icon: Icon, title, subtitle }: { icon: any; title: string; subtitle: string }) => (
    <div className="flex flex-col items-center justify-center text-center px-8 py-16">
      {/* Small subtle icon - NOT a giant logo */}
      <div className="w-12 h-12 rounded-xl bg-zinc-800/50 flex items-center justify-center mb-5">
        {Icon === "logo" ? (
          <svg className="w-6 h-6 text-zinc-600" viewBox="0 0 82 109" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M68.099 37.2285C78.1678 43.042 78.168 57.5753 68.099 63.3887L29.5092 85.668C15.6602 93.6633 0.510418 77.4704 9.40857 64.1836L17.4017 52.248C18.1877 51.0745 18.1876 49.5427 17.4017 48.3691L9.40857 36.4336C0.509989 23.1467 15.6602 6.95306 29.5092 14.9482L68.099 37.2285Z" stroke="currentColor" strokeWidth="11.6182" strokeLinejoin="round"/>
            <rect x="34.054" y="98.6841" width="48.6555" height="11.6182" rx="5.80909" transform="rotate(-30 34.054 98.6841)" fill="currentColor"/>
          </svg>
        ) : (
          <Icon className="w-6 h-6 text-zinc-600" />
        )}
      </div>
      <h3 className="text-sm font-medium text-zinc-300">{title}</h3>
      <p className="text-sm text-zinc-500 mt-1.5 max-w-xs">{subtitle}</p>
    </div>
  );

  // Stable loading message - doesn't depend on streamingMessage to prevent flickering
  const [loadingMessage, setLoadingMessage] = useState("Reconstructing from video...");
  const [currentTipIndex, setCurrentTipIndex] = useState(0);
  
  // Rotate tips every 5 seconds - AnimatePresence handles the transition
  useEffect(() => {
    if (!isProcessing && !isStreamingCode && !isEditing) return;
    
    const tipInterval = setInterval(() => {
      // Just update the index - AnimatePresence handles smooth fade
      setCurrentTipIndex(prev => (prev + 1) % GENERATION_TIPS.length);
    }, 5000);
    
    return () => clearInterval(tipInterval);
  }, [isProcessing, isStreamingCode, isEditing]);
  
  // Rotate loading messages - AnimatePresence handles the transition animation
  useEffect(() => {
    if (!isProcessing && !isStreamingCode && !isEditing) return;
    
    // Use update messages when editing, otherwise use normal streaming messages
    const msgs = isEditing ? STREAMING_MESSAGES_UPDATE : getStreamingMessages();
    const defaultMsg = isEditing ? "Updating your project..." : "Reconstructing from video...";
    let index = 0;
    
    // Set initial message
    setLoadingMessage(msgs[0] || defaultMsg);
    
    const interval = setInterval(() => {
      // Just update the message - AnimatePresence handles smooth fade
      index = (index + 1) % msgs.length;
      setLoadingMessage(msgs[index] || defaultMsg);
    }, 3000);
    
    return () => clearInterval(interval);
  }, [isProcessing, isStreamingCode, isEditing, viewMode]); // Only depend on stable values
  
  const LoadingState = ({ customMessage }: { customMessage?: string }) => {
    const defaultMsg = isEditing ? "Applying changes..." : "Reconstructing from video...";
    const displayMessage = customMessage || loadingMessage || defaultMsg;
    
    return (
      <div className="w-full h-full flex flex-col bg-[#111111] overflow-hidden">
        {/* Main Content */}
        <div className="flex-1 flex flex-col items-center justify-center p-6">
          
          {/* Animated Loading Skeleton */}
          <AnimatedLoadingSkeleton />
          
          {/* Status Message */}
          <div className="h-8 mt-6 flex items-center justify-center">
            <p className="text-sm text-zinc-500 text-center">
              {displayMessage}
            </p>
          </div>
          
          {/* Tip Banner */}
          <div className="w-full max-w-lg mt-4 h-12 flex items-center justify-center">
            <p className="font-mono text-[10px] text-zinc-600 leading-relaxed text-center">
              {GENERATION_TIPS[currentTipIndex]}
            </p>
          </div>

        </div>
      </div>
    );
  };

  // Render edit input with highlighted @tags
  const renderEditDisplay = () => {
    const parts = editInput.split(/(@\w+)/g);
    return parts.map((part, i) => {
      if (part.startsWith("@")) {
        return <span key={i} className="at-tag">{part}</span>;
      }
      return part;
    });
  };

  // ====== MOBILE SAVE GENERATION HANDLER ======
  // Must be defined BEFORE any early returns to follow React hooks rules
  const handleMobileSaveGeneration = useCallback((data: { title: string; code: string; videoUrl?: string }) => {
    console.log("[MOBILE] Saving generation to history:", data.title);
    
    // Create initial version
    const initialVersion: GenerationVersion = {
      id: generateId(),
      timestamp: Date.now(),
      label: "Initial generation",
      code: data.code,
      flowNodes: [],
      flowEdges: [],
      styleInfo: null,
    };
    
    // Create generation record (same structure as desktop)
    const newGeneration: GenerationRecord = {
      id: generateId(),
      title: data.title,
      autoTitle: true,
      timestamp: Date.now(),
      status: "complete",
      code: data.code,
      styleDirective: "Mobile generation",
      refinements: "",
      flowNodes: [],
      flowEdges: [],
      styleInfo: null,
      videoUrl: data.videoUrl,
      versions: [initialVersion],
      costCredits: CREDIT_COSTS.VIDEO_GENERATE,
      user_id: user?.id, // Owner of this project for access control
    };
    
    // Add to local state
    setGenerations(prev => [...prev, newGeneration]);
    setActiveGeneration(newGeneration);
    setGeneratedCode(data.code);
    
    // Save to Supabase for cross-device sync
    saveGenerationToSupabase(newGeneration);
    
    console.log("[MOBILE] Generation saved:", newGeneration.id);
  }, [saveGenerationToSupabase]);

  // ====== DEVICE DETECTION LOADING ======
  if (isMobile === null) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center">
        <div className="w-10 h-10 border-2 border-[var(--accent-orange)] border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // ====== MOBILE HARD FORK ======
  // Mobile ALWAYS uses MobileLayout - no exceptions
  // This prevents PC overlays from showing on mobile
  if (isMobile === true) {
    // Wrapper to convert simple save data to GenerationRecord format
    const handleMobileSave = async (data: { title: string; code: string; videoUrl?: string }) => {
      const genRecord: GenerationRecord = {
        id: generateId(),
        title: data.title,
        autoTitle: false,
        timestamp: Date.now(),
        status: "complete",
        code: data.code,
        styleDirective: "",
        refinements: "",
        flowNodes: [],
        flowEdges: [],
        styleInfo: null,
        videoUrl: data.videoUrl,
      };
      await saveGenerationToSupabase(genRecord);
    };

    return (
      <MobileLayout
        user={user}
        isPro={isPaidPlan}
        plan={membership?.plan || "free"}
        credits={userTotalCredits}
        creditsLoading={creditsLoading}
        onLogin={() => setShowAuthModal(true)}
        onOpenCreditsModal={() => setShowOutOfCreditsModal(true)}
        onCreditsRefresh={refreshCredits}
        onSaveGeneration={handleMobileSave}
      />
    );
  }

  // ====== DESKTOP APP ======
  return (
    <LiveCollaboration
      projectId={activeGeneration?.id || null}
      isCommentMode={isCommentMode}
      onToggleCommentMode={() => setIsCommentMode(!isCommentMode)}
      currentTab={viewMode}
      isOwner={!!user?.id && (!activeGeneration?.user_id || activeGeneration?.user_id === user?.id)}
      // Receive changes from other users
      onBlueprintPositionChange={(id, x, y) => {
        setBlueprintPositions(prev => ({ ...prev, [id]: { x, y } }));
      }}
      onBlueprintSizeChange={(id, width, height) => {
        setBlueprintSizes(prev => ({ ...prev, [id]: { width, height } }));
      }}
      onBlueprintCodeChange={(id, code) => {
        // Update component code in library data
        setLibraryData((prev: any) => ({
          ...prev,
          components: prev?.components?.map((c: any) =>
            `comp-${c.id}` === id ? { ...c, jsxCode: code } : c
          ),
        }));
      }}
      onLibraryComponentChange={(id, data) => {
        setLibraryData((prev: any) => ({
          ...prev,
          components: prev?.components?.map((c: any) =>
            c.id === id ? { ...c, ...data } : c
          ),
        }));
      }}
      onLibraryComponentDelete={(id) => {
        setLibraryData((prev: any) => ({
          ...prev,
          components: prev?.components?.filter((c: any) => c.id !== id),
        }));
        // Also remove from blueprint positions
        setBlueprintPositions(prev => {
          const newPositions = { ...prev };
          delete newPositions[`comp-${id}`];
          return newPositions;
        });
      }}
      onLibraryComponentAdd={(component) => {
        setLibraryData((prev: any) => ({
          ...prev,
          components: [...(prev?.components || []), component],
        }));
      }}
    >
    <div className="h-screen flex flex-col bg-[#111111] overflow-hidden">
      {/* SVG Filters for Vision Simulator */}
      <svg className="absolute w-0 h-0 overflow-hidden" aria-hidden="true">
        <defs>
          {/* Deuteranopia (green-blind) */}
          <filter id="deuteranopia">
            <feColorMatrix type="matrix" values="0.625 0.375 0 0 0 0.7 0.3 0 0 0 0 0.3 0.7 0 0 0 0 0 1 0" />
          </filter>
          {/* Protanopia (red-blind) */}
          <filter id="protanopia">
            <feColorMatrix type="matrix" values="0.567 0.433 0 0 0 0.558 0.442 0 0 0 0 0.242 0.758 0 0 0 0 0 1 0" />
          </filter>
          {/* Tritanopia (blue-blind) */}
          <filter id="tritanopia">
            <feColorMatrix type="matrix" values="0.95 0.05 0 0 0 0 0.433 0.567 0 0 0 0.475 0.525 0 0 0 0 0 1 0" />
          </filter>
        </defs>
      </svg>

      <AssetsModal
        isOpen={showAssetsModal}
        onClose={() => setShowAssetsModal(false)}
        code={assetCode}
        onCodeUpdate={handleAssetCodeUpdate}
        initialSelectedUrl={selectedAssetUrl}
        initialSelectedOccurrence={selectedAssetOccurrence}
        onClearSelection={() => {
          setSelectedAssetUrl(null);
          setSelectedAssetOccurrence(null);
        }}
      />
      
      {/* Video Preview Modal */}
      <AnimatePresence>
        {videoPreviewModal?.open && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm"
            onClick={() => setVideoPreviewModal(null)}
          >
            <motion.div
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              className="relative w-full max-w-4xl mx-4"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-white text-sm font-medium truncate max-w-[80%]">
                  {videoPreviewModal.name}
                </h3>
                <button
                  onClick={() => setVideoPreviewModal(null)}
                  className="p-2 rounded-lg bg-zinc-800/80 hover:bg-zinc-700 text-white/70 hover:text-white transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              {/* Video Player */}
              <div className="rounded-lg overflow-hidden bg-black border border-white/10 shadow-2xl">
                <video
                  src={videoPreviewModal.url}
                  controls
                  autoPlay
                  className="w-full max-h-[70vh]"
                />
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
      
      {/* Auth Modal for Desktop */}
      <AuthModal
        isOpen={showAuthModal}
        onClose={() => {
          setShowAuthModal(false);
          setPendingAction(null);
        }}
        title="Sign in to continue"
        description="Your scans and credits are saved to your account."
      />
      
      {/* Import Library Modal */}
      <ImportLibraryModal
        isOpen={showImportLibraryModal}
        onClose={() => setShowImportLibraryModal(false)}
        onImport={async (url, name) => {
          setIsImportingLibrary(true);
          try {
            const response = await fetch("/api/design-systems/import", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, name }),
            });
            
            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.error || "Import failed");
            }
            
            const data = await response.json();
            // Auto-select the imported DS as the active style
            setStyleDirective(`DS_STYLE::${data.designSystem.id}::${data.designSystem.name}`);
            showToast(`Imported "${data.designSystem.name}" as style reference (${data.components} component specs)`, "success");
            // Refetch design systems to update the styles list
            refetchDesignSystems();
          } finally {
            setIsImportingLibrary(false);
          }
        }}
      />
      
      {/* Out of Credits Modal for Desktop */}
      <OutOfCreditsModal
        isOpen={showOutOfCreditsModal}
        onClose={() => setShowOutOfCreditsModal(false)}
        requiredCredits={CREDIT_COSTS.VIDEO_GENERATE}
        availableCredits={userTotalCredits}
        isSandbox={isSandbox}
      />
      
      {/* Upgrade Modal for FREE users trying to access Pro features */}
      <UpgradeModal
        isOpen={showUpgradeModal}
        onClose={() => setShowUpgradeModal(false)}
        feature={upgradeFeature}
      />
      
      {/* Project Settings Modal for Supabase Wire */}
      <ProjectSettingsModal
        isOpen={showProjectSettings}
        onClose={() => setShowProjectSettings(false)}
        project={{
          id: activeGeneration?.id || flows[0]?.id || "default",
          name: generationTitle || "Untitled Project",
        }}
        onRename={(id, newName) => {
          setGenerationTitle(newName);
          // Update in generations list too
          setGenerations(prev => prev.map(g => g.id === id ? { ...g, title: newName } : g));
        }}
      />
      
      {/* Hidden file input for video upload */}
      <input 
        type="file" 
        ref={fileInputRef} 
        className="hidden" 
        accept="video/*,.mp4,.mov,.webm,.avi,.mkv,.m4v,image/*,.png,.jpg,.jpeg,.gif,.webp"
        onChange={async (e) => {
          const files = e.target.files;
          if (files && files.length > 0) {
            for (const file of Array.from(files)) {
              const isVideo = file.type.startsWith("video/") || 
                              file.name.toLowerCase().match(/\.(mp4|mov|webm|avi|mkv|m4v)$/);
              const isImage = file.type.startsWith("image/") ||
                              file.name.toLowerCase().match(/\.(png|jpg|jpeg|gif|webp)$/);
              
              if (isVideo) {
                await addVideoToFlows(file, file.name.replace(/\.[^/.]+$/, ""));
              } else if (isImage) {
                // Handle image upload - create a flow from image
                const imageUrl = URL.createObjectURL(file);
                const flowId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const flowName = file.name.replace(/\.[^/.]+$/, "");
                
                // Create image element to get dimensions
                const img = new window.Image();
                img.src = imageUrl;
                await new Promise((resolve) => { img.onload = resolve; });
                
                // Create a canvas to generate thumbnail
                const canvas = document.createElement('canvas');
                const maxSize = 400;
                const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx?.drawImage(img, 0, 0, canvas.width, canvas.height);
                const thumbnail = canvas.toDataURL('image/jpeg', 0.8);
                
                // Convert image to blob for upload
                const response = await fetch(imageUrl);
                const imageBlob = await response.blob();
                
                const newFlow: FlowItem = {
                  id: flowId,
                  name: flowName,
                  thumbnail: thumbnail,
                  videoUrl: imageUrl,
                  videoBlob: imageBlob,
                  duration: 0, // Images have no duration
                  trimStart: 0,
                  trimEnd: 0,
                  isImage: true, // Flag to identify as image
                };
                
                setFlows((prev) => [...prev, newFlow]);
                setSelectedFlowId(flowId);
                showToast(`Image "${flowName}" added`, "success");
              } else {
                showToast("Please select a video or image file", "error");
              }
            }
          }
          e.target.value = "";
        }}
      />
      
      {/* Desktop Header removed - Logo now in sidebar, tabs in work area */}
      
      {/* Mobile Header - Fixed - Hide when panels with own headers are open */}
      {!(mobilePanel === "chat" && generatedCode) && mobilePanel !== "preview" && mobilePanel !== "code" && mobilePanel !== "flow" && mobilePanel !== "design" && mobilePanel !== "input" && (
        <header className="fixed top-0 left-0 right-0 z-50 flex md:hidden items-center justify-between px-4 py-3 border-b border-zinc-800 bg-zinc-900 backdrop-blur-xl">
          <a href="/" className="hover:opacity-80 transition-opacity">
            <Logo />
          </a>
          <button 
            onClick={() => setShowMobileMenu(!showMobileMenu)}
            className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center"
          >
            {user ? (
              <span className={cn(
                "text-xs font-semibold uppercase",
                (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
              )}>
                {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
              </span>
            ) : (
              <User className="w-5 h-5 text-zinc-400" />
            )}
          </button>
        </header>
      )}
      
      {/* Mobile Menu - Full Screen Overlay - Static */}
      {showMobileMenu && (
          <div className="fixed inset-0 z-[100] bg-[#111111] md:hidden flex flex-col">
              {/* Header */}
              <div className="flex items-center justify-between px-4 py-3 border-b border-zinc-800 safe-area-pt">
                <div className="flex items-center gap-3">
                  <User className="w-5 h-5 text-zinc-300" />
                  <span className="text-base font-semibold text-white">Account</span>
                </div>
                <button onClick={() => setShowMobileMenu(false)} className="p-3 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center">
                  <X className="w-5 h-5 text-zinc-400" />
                </button>
              </div>
              
              {/* Content */}
              <div className="flex-1 overflow-auto">
              
              {user ? (
                <>
                  {/* Credits section */}
                  {(() => {
                    const plan = membership?.plan || "free";
                    const maxCredits = plan === "agency" ? 10000 : plan === "pro" ? 3000 : 100;
                    const percentage = Math.min(100, (userTotalCredits / maxCredits) * 100);
                    return (
                      <Link 
                        href="/settings?tab=plans" 
                        onClick={() => setShowMobileMenu(false)}
                        className="block p-4 hover:bg-zinc-800/50 transition-colors border-b border-zinc-800"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-white">{userTotalCredits} credits</span>
                            {(plan === "pro" || plan === "agency" || plan === "enterprise") ? (
                              <span className="px-1.5 py-0.5 rounded text-[9px] font-semibold bg-zinc-800 text-white uppercase">
                                {plan === "agency" ? "Agency" : plan === "enterprise" ? "Enterprise" : "Pro"}
                              </span>
                            ) : (
                              <span className="px-1.5 py-0.5 rounded text-[9px] font-medium bg-white/10 text-zinc-500 uppercase">
                                Free
                              </span>
                            )}
                          </div>
                          <ChevronRight className="w-4 h-4 text-zinc-500" />
                        </div>
                        <div className="mt-1">
                          <span className="text-xs text-zinc-500">{isPaidPlan ? "Add credits →" : "Upgrade →"}</span>
                        </div>
                      </Link>
                    );
                  })()}
                  
                  <div className="p-2 space-y-1">
                    <button 
                      onClick={() => { setShowMobileMenu(false); setShowHistoryMode(true); }}
                      className="w-full flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-zinc-800/50 active:bg-white/10 text-zinc-200"
                    >
                      <History className="w-4 h-4 opacity-50" /> Projects
                    </button>
                    <Link 
                      href="/settings" 
                      onClick={() => setShowMobileMenu(false)}
                      className="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-zinc-800/50 text-zinc-200"
                    >
                      <Settings className="w-4 h-4 opacity-50" /> Settings
                    </Link>
                  </div>
                  <div className="p-4 border-t border-zinc-800 safe-area-pb">
                    <button 
                      onClick={() => { setShowMobileMenu(false); signOut(); }}
                      className="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 text-zinc-200 min-h-[48px]"
                    >
                      <LogOut className="w-5 h-5 opacity-50" /> Sign out
                    </button>
                  </div>
                </>
              ) : (
                <div className="p-4 safe-area-pb">
                  <button
                    onClick={() => { setShowMobileMenu(false); setShowAuthModal(true); }}
                    className="w-full py-4 rounded-xl bg-zinc-800 text-white font-medium active:bg-zinc-600 transition-colors min-h-[52px]"
                  >
                    Sign in
                  </button>
                </div>
              )}
              </div>
          </div>
      )}

      <div className="flex-1 flex overflow-hidden relative z-10">
        {/* Left Panel - Sidebar - Hidden on mobile */}
        <div className={cn(
          "hidden md:flex border-r border-zinc-800/50 bg-[#141414] flex-col transition-all duration-300",
          sidebarCollapsed ? "w-16" : "w-80"
        )}>
          
          {/* Logo + Collapse Button - same height as main top bar (h-12) */}
          <div className="flex-shrink-0 h-12 px-3 flex items-center justify-center border-b border-zinc-800/50">
            {sidebarCollapsed ? (
              <button
                onClick={() => setSidebarCollapsed(false)}
                className="p-2 rounded-md hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-zinc-200"
                title="Expand sidebar"
              >
                <PanelLeft className="w-5 h-5" />
              </button>
            ) : (
              <div className="flex items-center justify-between w-full">
                <a href="/" className="hover:opacity-80 transition-opacity">
                  <LogoIcon className="w-7 h-7" color="white" />
                </a>
                <button
                  onClick={() => setSidebarCollapsed(true)}
                  className="p-1.5 rounded-md hover:bg-zinc-800 transition-colors text-zinc-500 hover:text-zinc-300"
                  title="Collapse sidebar"
                >
                  <PanelLeftClose className="w-4 h-4" />
                </button>
              </div>
            )}
          </div>
          
          {/* Collapsed state - show icon buttons */}
          {sidebarCollapsed && (
            <div className="flex-1 flex flex-col items-center py-4 gap-3">
              <button 
                onClick={() => { setSidebarCollapsed(false); setSidebarView("projects"); }}
                className="w-10 h-10 rounded-lg bg-zinc-800/50 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-zinc-200 transition-all"
                title="Projects"
              >
                <Folder className="w-5 h-5" />
              </button>
              <button 
                onClick={() => { setSidebarCollapsed(false); setSidebarView("detail"); }}
                className="w-10 h-10 rounded-lg bg-zinc-800/50 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-zinc-200 transition-all"
                title="Input"
              >
                <Boxes className="w-5 h-5" />
              </button>
              <button 
                onClick={() => { setSidebarCollapsed(false); setSidebarTab("chat"); }}
                className="w-10 h-10 rounded-lg bg-zinc-800/50 hover:bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-zinc-200 transition-all"
                title="Replay AI"
              >
                <Send className="w-5 h-5" />
              </button>
            </div>
          )}
          
          {/* PROJECT Header - Clickable button to open projects dropdown */}
          {!sidebarCollapsed && (
          <div className="flex-shrink-0 px-3 py-3 border-b border-zinc-800/50">
            <button 
              className="flex items-center justify-between w-full px-3 py-2.5 rounded-lg bg-zinc-800/50 border border-zinc-700/50 cursor-pointer hover:bg-zinc-800 transition-all group"
              onClick={() => setSidebarView(sidebarView === "projects" ? "detail" : "projects")}
            >
              <div className="flex flex-col items-start min-w-0">
                <span className="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Project</span>
                <span className="text-sm font-medium text-zinc-200 truncate max-w-[220px]">
                  {generationTitle || "Untitled Project"}
                </span>
              </div>
              <ChevronDown className={cn(
                "w-4 h-4 text-zinc-500 transition-transform flex-shrink-0 group-hover:text-zinc-400",
                sidebarView === "projects" && "rotate-180"
              )} />
            </button>
          </div>
          )}
          
          {/* PROJECTS LIST VIEW */}
          {!sidebarCollapsed && sidebarView === "projects" ? (
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
              {/* + Create New Project */}
              <div className="flex-shrink-0 p-3">
                <button
                  onClick={resetToNewProject}
                  className="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-md border border-dashed border-zinc-700 text-sm font-medium text-zinc-300 hover:bg-zinc-800/10 hover:border-zinc-700 transition-colors"
                >
                  <Plus className="w-4 h-4" />
                  <span>Create New Project</span>
                </button>
              </div>
              
              {/* Search - server-side with debounce */}
              <div className="px-3 pb-2">
                <div className="relative">
                  <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-600" />
                  <input
                    type="text"
                    value={historySearch}
                    onChange={(e) => {
                      const value = e.target.value;
                      setHistorySearch(value);
                      // Debounced server-side search
                      if (searchDebounceRef.current) {
                        clearTimeout(searchDebounceRef.current);
                      }
                      searchDebounceRef.current = setTimeout(() => {
                        searchGenerations(value);
                      }, 400);
                    }}
                    placeholder="Search all projects..."
                    className="w-full pl-9 pr-8 py-2 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-sm text-zinc-300 placeholder:text-zinc-600 focus:outline-none focus:border-zinc-600"
                  />
                  {historySearch && (
                    <button
                      onClick={() => {
                        setHistorySearch("");
                        if (searchDebounceRef.current) clearTimeout(searchDebounceRef.current);
                        searchGenerations("");
                      }}
                      className="absolute right-2.5 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-zinc-300"
                    >
                      <X className="w-3.5 h-3.5" />
                    </button>
                  )}
                </div>
                <div className="flex items-center justify-between mt-1 px-1">
                  {historyTotal > 0 && (
                    <p className="text-[10px] text-zinc-600">
                      {historySearch ? `Found ${historyTotal} projects` : `${historyTotal} projects total`}
                    </p>
                  )}
                  <button
                    onClick={() => {
                      setHistoryOffset(0);
                      fetchGenerations({ reset: true });
                    }}
                    disabled={isLoadingHistory}
                    className="text-[10px] text-zinc-500 hover:text-zinc-300 flex items-center gap-1 transition-colors"
                    title="Refresh projects list"
                  >
                    <RefreshCw className={cn("w-3 h-3", isLoadingHistory && "animate-spin")} />
                    <span>Refresh</span>
                  </button>
                </div>
              </div>
              
              {/* Divider */}
              <div className="border-b border-zinc-800/50 mx-3" />
              
              {/* Generation List - sorted newest first */}
              <div 
                className="flex-1 min-h-0 overflow-y-auto p-2"
                style={{ scrollbarWidth: 'thin', scrollbarColor: 'rgba(255,255,255,0.1) transparent' }}
              >
                {isLoadingHistory ? (
                  <div className="text-center py-12">
                    <Loader2 className="w-5 h-5 text-zinc-300 animate-spin mx-auto" />
                    <p className="text-sm text-zinc-500 mt-3">Loading...</p>
                  </div>
                ) : generations.length === 0 ? (
                  <div className="text-center py-12 px-4">
                    <div className="w-10 h-10 rounded-lg bg-zinc-800/50 flex items-center justify-center mx-auto mb-3">
                      <Folder className="w-5 h-5 text-zinc-600" />
                    </div>
                    <p className="text-sm text-zinc-400">No projects yet</p>
                    <p className="text-xs text-zinc-600 mt-1">Create one to get started</p>
                  </div>
                ) : (
                  <div className="space-y-2">{generations
                      .slice()
                      .sort((a, b) => b.timestamp - a.timestamp)
                      .map((gen) => (
                      <div 
                        key={gen.id}
                        className={cn(
                          "group relative p-3 rounded-lg cursor-pointer transition-all border bg-zinc-800/30 border-zinc-700/50 hover:bg-zinc-800/60 hover:border-zinc-600",
                          activeGeneration?.id === gen.id && "bg-zinc-800 border border-zinc-700"
                        )}
                        onClick={async () => {
                          if (renamingId === gen.id) return; // Don't load while renaming
                          
                          try {
                            // If code is missing (minimal fetch), load full data first
                            let genToLoad = gen;
                            const isDemo = DEMO_PROJECT_IDS.has(gen.id);
                            if (!gen.code && (user || isDemo)) {
                              console.log("[History] Loading full data for generation:", gen.id, isDemo ? "(demo)" : "");
                              const fullGen = await loadFullGeneration(gen.id);
                              if (fullGen) {
                                genToLoad = fullGen;
                              } else {
                                console.error("[History] Failed to load generation data");
                                showToast("Failed to load project", "error");
                                return;
                              }
                            }
                            
                            // Set flag to prevent auto-save during load
                            isLoadingProjectRef.current = true;
                            
                            // Reset editing modes when switching projects
                            setIsDirectEditMode(false);
                            setIsPointAndEdit(false);
                            setPendingTextEdits([]);
                            setShowFloatingEdit(false);
                            
                            // DON'T create initial version here - UI already shows hardcoded "Initial generation" at bottom
                            // versions array should only contain EDITS made after initial generation
                            
                            // Load this generation
                            setActiveGeneration(genToLoad);
                            setGenerationTitle(genToLoad.title || "Untitled");
                            // Reset published URL state to match the loaded generation
                            setPublishedUrl(genToLoad.publishedSlug ? `https://www.replay.build/p/${genToLoad.publishedSlug}` : null);
                            setShowPublishModal(false);
                            if (genToLoad.code && genToLoad.code.length > 50) {
                              setGeneratedCode(genToLoad.code);
                              setDisplayedCode(genToLoad.code);
                              setEditableCode(genToLoad.code);
                              setPreviewUrl(createPreviewUrl(genToLoad.code));
                              // CRITICAL: Set these to show Replay AI / Input tabs
                              setGenerationComplete(true);
                              setSidebarMode("chat");
                            } else {
                              // Project has no code yet - reset to input mode
                              setGeneratedCode(null);
                              setDisplayedCode("");
                              setEditableCode("");
                              setPreviewUrl(null);
                              setGenerationComplete(false);
                              setSidebarMode("config");
                              setViewMode("input");
                            }
                            if (genToLoad.flowNodes) setFlowNodes(genToLoad.flowNodes);
                            if (genToLoad.flowEdges) setFlowEdges(genToLoad.flowEdges);
                            if (genToLoad.styleInfo) setStyleInfo(genToLoad.styleInfo);
                            setStyleDirective(genToLoad.styleDirective || '');
                            setRefinements(genToLoad.refinements || '');
                            // Load chat messages for this project
                            setChatMessages(genToLoad.chatMessages || []);
                            lastSavedChatRef.current = JSON.stringify((genToLoad.chatMessages || []).map(m => m.id));
                            
                            // Load library data for this project
                            if (genToLoad.libraryData) {
                              setLibraryData(genToLoad.libraryData);
                              setLibraryDocsGenerated(!!genToLoad.libraryData?.docs?.length);
                            } else {
                              setLibraryData(null); // Reset library when switching projects
                              setLibraryDocsGenerated(false);
                            }
                            
                            // Auto-expand versions if there are any
                            if (genToLoad.versions && genToLoad.versions.length > 0) {
                              setExpandedVersions(genToLoad.id);
                            }
                            
                            // Restore video from generation if available
                            if (genToLoad.videoUrl && !flows.some(f => f.videoUrl === genToLoad.videoUrl)) {
                              const newFlowId = generateId();
                              const newFlow: FlowItem = {
                                id: newFlowId,
                                name: genToLoad.title || "Recording",
                                videoBlob: new Blob(), // Empty blob as placeholder
                                videoUrl: genToLoad.videoUrl,
                                thumbnail: genToLoad.thumbnailUrl || "",
                                duration: 30,
                                trimStart: 0,
                                trimEnd: 30,
                              };
                              setFlows([newFlow]);
                              setSelectedFlowId(newFlowId);
                              // Load actual duration from video metadata (fixes 00:00 when loading project)
                              const tempV = document.createElement('video');
                              tempV.preload = 'metadata';
                              tempV.crossOrigin = 'anonymous';
                              tempV.muted = true;
                              let durationFixed = false;
                              const updateDuration = () => {
                                if (durationFixed) return;
                                const d = tempV.duration;
                                if (d && isFinite(d) && d > 0) {
                                  durationFixed = true;
                                  const dur = Math.round(d);
                                  let thumb = genToLoad.thumbnailUrl || "";
                                  try {
                                    const c = document.createElement('canvas');
                                    const vw = tempV.videoWidth || 640, vh = tempV.videoHeight || 360;
                                    c.width = 320; c.height = Math.round((320 / vw) * vh) || 180;
                                    const ctx = c.getContext('2d');
                                    if (ctx && vw > 0 && vh > 0) {
                                      ctx.drawImage(tempV, 0, 0, c.width, c.height);
                                      thumb = c.toDataURL('image/jpeg', 0.8);
                                    }
                                  } catch (_) {}
                                  console.log("[LoadProject] Video duration loaded:", dur, "s");
                                  setFlows(prev => prev.map(f => f.id === newFlowId ? { ...f, duration: dur, trimEnd: dur, thumbnail: thumb || f.thumbnail } : f));
                                }
                              };
                              tempV.onloadedmetadata = () => {
                                // WebM often has Infinity duration until seeked - seek far to fix
                                if (!isFinite(tempV.duration) || tempV.duration <= 0) {
                                  tempV.currentTime = 1e10; // Seek far to get real duration
                                } else {
                                  tempV.currentTime = Math.min(1, tempV.duration * 0.25);
                                  updateDuration();
                                }
                              };
                              tempV.onseeked = () => {
                                updateDuration();
                                // If still no valid duration after far seek, try seeking to thumbnail frame
                                if (!durationFixed && isFinite(tempV.duration) && tempV.duration > 0) {
                                  tempV.currentTime = Math.min(1, tempV.duration * 0.25);
                                }
                              };
                              tempV.ondurationchange = () => updateDuration();
                              tempV.onerror = () => console.log("[LoadProject] Video load error");
                              tempV.src = genToLoad.videoUrl;
                              if (!genToLoad.thumbnailUrl) regenerateThumbnail(newFlowId, genToLoad.videoUrl);
                            }
                            setSidebarView("detail"); // Switch to detail view
                            setGenerationComplete(true);
                            setSidebarMode("chat");
                            setMobilePanel("chat"); // Also switch mobile to chat
                            // Load chat messages for this project, or create initial if none exist
                            if (genToLoad.chatMessages && genToLoad.chatMessages.length > 0) {
                              setChatMessages(genToLoad.chatMessages);
                            } else if (genToLoad.code) {
                              setChatMessages([{
                                id: generateId(),
                                role: "assistant",
                                content: `**Boom. UI Reconstructed.**\n\nMatched the layout from your video using Tailwind CSS and Alpine.js for interactivity.\n\nReady to refine? Just tell me what to tweak.`,
                                timestamp: Date.now(),
                                quickActions: ["Make it mobile-friendly", "Tweak the colors", "Add hover effects", "Improve the spacing"]
                              }]);
                            }
                          } catch (e) {
                            console.error("[History] Error loading generation:", e);
                            showToast("Error loading generation", "error");
                          }
                        }}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              {renamingId === gen.id ? (
                                <input
                                  type="text"
                                  value={renameValue}
                                  onChange={(e) => setRenameValue(e.target.value)}
                                  onBlur={() => renameGeneration(gen.id, renameValue || gen.title)}
                                  onKeyDown={(e) => {
                                    if (e.key === "Enter") renameGeneration(gen.id, renameValue || gen.title);
                                    if (e.key === "Escape") { setRenamingId(null); setRenameValue(""); }
                                  }}
                                  onClick={(e) => e.stopPropagation()}
                                  autoFocus
                                  className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-zinc-800/50 border border-zinc-700 rounded px-2 py-0.5 focus:outline-none focus:border-zinc-700"
                                />
                              ) : (
                                <p className="text-sm font-medium text-zinc-200 truncate">{gen.title}</p>
                              )}
                            </div>
                            <p className="text-[10px] text-zinc-600 mt-1">
                              {new Date(gen.timestamp).toLocaleDateString()} • {new Date(gen.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </p>
                          </div>
                          
                          {/* Actions menu */}
                          <div className="relative">
                            <button 
                              onClick={(e) => { 
                                e.stopPropagation(); 
                                setHistoryMenuOpen(historyMenuOpen === gen.id ? null : gen.id);
                              }}
                              className={cn(
                                "p-1.5 rounded hover:bg-white/10 transition-opacity",
                                historyMenuOpen === gen.id ? "opacity-100" : "opacity-0 group-hover:opacity-100"
                              )}
                            >
                              <MoreVertical className="w-4 h-4 text-zinc-500" />
                            </button>
                            
                            {/* Dropdown menu */}
                            <AnimatePresence>
                              {historyMenuOpen === gen.id && (
                                <motion.div 
                                  initial={{ opacity: 0, scale: 0.95, y: -5 }}
                                  animate={{ opacity: 1, scale: 1, y: 0 }}
                                  exit={{ opacity: 0, scale: 0.95, y: -5 }}
                                  className="absolute right-0 top-8 z-50 w-32 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl overflow-hidden"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  <button
                                    onClick={() => { 
                                      setHistoryMenuOpen(null);
                                      // Start renaming this project
                                      setRenamingId(gen.id);
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-zinc-400 hover:bg-zinc-800/50 flex items-center gap-2"
                                  >
                                    <Pencil className="w-3 h-3" /> Edit Name
                                  </button>
                                  <button
                                    onClick={() => { 
                                      setHistoryMenuOpen(null);
                                      // Load this generation and open settings
                                      setActiveGeneration(gen);
                                      setGenerationTitle(gen.title || "Untitled Project");
                                      setShowProjectSettings(true);
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-zinc-400 hover:bg-zinc-800/50 flex items-center gap-2"
                                  >
                                    <Settings className="w-3 h-3" /> Settings
                                  </button>
                                  <button
                                    onClick={() => {
                                      setHistoryMenuOpen(null);
                                      duplicateGeneration(gen);
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-zinc-400 hover:bg-zinc-800/50 flex items-center gap-2"
                                  >
                                    <Copy className="w-3 h-3" /> Duplicate
                                  </button>
                                  <button
                                    onClick={() => {
                                      useAsInput(gen);
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-zinc-400 hover:bg-zinc-800/50 flex items-center gap-2"
                                    title="Use video from this project to start fresh generation"
                                  >
                                    <Video className="w-3 h-3" /> Use as Input
                                  </button>
                                  <button
                                    onClick={() => {
                                      setHistoryMenuOpen(null);
                                      // Export - download the project
                                      if (!isPaidPlan) {
                                        setUpgradeFeature("download");
                                        setShowUpgradeModal(true);
                                      } else if (gen.code) {
                                        const blob = new Blob([gen.code], { type: "text/html" });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement("a");
                                        a.href = url;
                                        a.download = `${gen.title || "project"}.html`;
                                        a.click();
                                        URL.revokeObjectURL(url);
                                        showToast("Project exported!", "success");
                                      }
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-zinc-400 hover:bg-zinc-800/50 flex items-center gap-2"
                                  >
                                    <Download className="w-3 h-3" /> Export
                                  </button>
                                  <div className="border-t border-zinc-800 my-1" />
                                  <button
                                    onClick={() => {
                                      setHistoryMenuOpen(null);
                                      confirmDeleteGeneration(gen.id, gen.title);
                                    }}
                                    className="w-full px-3 py-2 text-left text-xs text-red-400/80 hover:bg-red-500/10 flex items-center gap-2"
                                  >
                                    <Trash2 className="w-3 h-3" /> Delete
                                  </button>
                                </motion.div>
                              )}
                            </AnimatePresence>
                          </div>
                        </div>
                        
                        {/* Latest change or style info */}
                        <div className="mt-1.5 space-y-0.5">
                          {/* Library/Design System info */}
                          {gen.designSystemName && (
                            <p className="text-[10px] text-zinc-500 truncate">
                              <span className="text-[var(--accent-orange)]/60">Library:</span> {gen.designSystemName}
                            </p>
                          )}
                          {(() => {
                            const filteredVersions = (gen.versions || []).filter(v => v.label !== "Initial generation");
                            return filteredVersions.length > 0 ? (
                              <p className="text-[10px] text-zinc-500 truncate">
                                <span className="text-emerald-400/60">Latest:</span> {filteredVersions[filteredVersions.length - 1]?.label || "Code update"}
                              </p>
                            ) : (
                              <p className="text-[10px] text-white/25 truncate">
                                <span className="text-white/15">Style:</span> {gen.styleDirective?.split('.')[0]?.split('⚠️')[0]?.trim() || "Auto-Detect"}
                              </p>
                            );
                          })()}
                          {gen.refinements && (
                            <p className="text-[10px] text-white/20 truncate italic">
                              <span className="text-white/15">Context:</span> {gen.refinements}
                            </p>
                          )}
                        </div>
                        
                        {/* Version History Toggle - always show */}
                        <div className="mt-2 pt-2 border-t border-zinc-800">
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setExpandedVersions(expandedVersions === gen.id ? null : gen.id);
                            }}
                            className="flex items-center gap-2 text-[10px] text-zinc-500 hover:text-zinc-400 transition-colors"
                          >
                            <Clock className="w-3 h-3" />
                            <span>{((gen.versions || []).filter(v => v.label !== "Initial generation").length) + 1} version{((gen.versions || []).filter(v => v.label !== "Initial generation").length) >= 1 ? 's' : ''}</span>
                            <ChevronDown className={cn(
                              "w-3 h-3 transition-transform",
                              expandedVersions === gen.id && "rotate-180"
                            )} />
                          </button>
                            
                            {/* Expanded Versions List */}
                          <AnimatePresence>
                            {expandedVersions === gen.id && (
                              <motion.div
                                initial={{ opacity: 0, height: 0 }}
                                animate={{ opacity: 1, height: "auto" }}
                                exit={{ opacity: 0, height: 0 }}
                                className="mt-2 ml-1 space-y-1 overflow-hidden"
                              >
                                {/* Version timeline - newest at top, oldest at bottom */}
                                <div className="relative pl-3 border-l border-zinc-700">
                                  {/* Versions in reverse order (newest/current at top) - filter out "Initial generation" as it's shown separately below */}
                                  {(gen.versions || []).filter(v => v.label !== "Initial generation").slice().reverse().map((version, idx) => (
                                    <div 
                                      key={version.id}
                                      className="relative py-1.5 group/version"
                                    >
                                      <div className={cn(
                                        "absolute -left-[7px] top-2.5 w-2.5 h-2.5 rounded-full border-2",
                                        idx === 0 
                                          ? "bg-zinc-800 border-[var(--accent-orange)]" 
                                          : "bg-[#111111] border-white/20 group-hover/version:border-white/40"
                                      )} />
                                      
                                      <div className="flex items-center justify-between gap-2 pl-2">
                                        <div className="flex-1 min-w-0">
                                          <p className="text-[10px] text-zinc-500 truncate">{version.label}</p>
                                          <p className="text-[8px] text-white/25">
                                            {new Date(version.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                          </p>
                                        </div>
                                        
                                        {idx === 0 ? (
                                          <span className="text-[8px] text-zinc-300/60 uppercase">Current</span>
                                        ) : (
                                          <button
                                            onClick={async (e) => {
                                              e.stopPropagation();
                                              // Check if version has code
                                              if (!version.code || version.code.length < 50) {
                                                // Try to find version in activeGeneration (may have newer data)
                                                if (activeGeneration?.id === gen.id) {
                                                  const freshVersion = (activeGeneration.versions || []).find(v => v.id === version.id);
                                                  if (freshVersion?.code && freshVersion.code.length >= 50) {
                                                    restoreVersion(gen.id, freshVersion);
                                                    return;
                                                  }
                                                }
                                                // Load full data from server
                                                showToast("Loading version data...", "info");
                                                const fullGen = await loadFullGeneration(gen.id);
                                                if (fullGen) {
                                                  const freshVersion = (fullGen.versions || []).find(v => v.id === version.id);
                                                  if (freshVersion?.code && freshVersion.code.length >= 50) {
                                                    restoreVersion(gen.id, freshVersion);
                                                    return;
                                                  }
                                                }
                                                showToast("Version data not available", "error");
                                                return;
                                              }
                                              restoreVersion(gen.id, version);
                                            }}
                                            className="opacity-0 group-hover/version:opacity-100 p-1 rounded hover:bg-white/10 transition-all"
                                            title="Restore this version"
                                          >
                                            <Play className="w-3 h-3 text-zinc-300" />
                                          </button>
                                        )}
                                      </div>
                                    </div>
                                  ))}
                                  
                                  {/* Initial generation - at the bottom */}
                                  <div className="relative py-1.5 group/version">
                                    <div className={cn(
                                      "absolute -left-[7px] top-2.5 w-2.5 h-2.5 rounded-full border-2",
                                      !gen.versions?.length ? "bg-zinc-800 border-[var(--accent-orange)]" : "bg-[#111111] border-white/20 group-hover/version:border-white/40"
                                    )} />
                                    <div className="flex items-center justify-between gap-2 pl-2">
                                      <div className="flex-1 min-w-0">
                                        <p className="text-[10px] text-zinc-500 truncate">Initial generation</p>
                                        <p className="text-[8px] text-white/25">
                                          {new Date(gen.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </p>
                                      </div>
                                      {!gen.versions?.length ? (
                                        <span className="text-[8px] text-zinc-300/60 uppercase">Current</span>
                                      ) : (
                                        <button
                                          onClick={async (e) => {
                                            e.stopPropagation();
                                            // Restore to initial generation
                                            // Use activeGeneration code if same project (already loaded), otherwise load it
                                            let codeToRestore = gen.code;
                                            let flowNodesToRestore = gen.flowNodes;
                                            let flowEdgesToRestore = gen.flowEdges;
                                            let styleInfoToRestore = gen.styleInfo;
                                            
                                            if (!codeToRestore || codeToRestore.length < 50) {
                                              // Try to use activeGeneration if it's the same project
                                              if (activeGeneration?.id === gen.id && activeGeneration.code) {
                                                // Find initial version in versions array
                                                const initialVersion = (activeGeneration.versions || []).find(v => v.label === 'Initial generation');
                                                if (initialVersion?.code) {
                                                  codeToRestore = initialVersion.code;
                                                  flowNodesToRestore = initialVersion.flowNodes;
                                                  flowEdgesToRestore = initialVersion.flowEdges;
                                                  styleInfoToRestore = initialVersion.styleInfo;
                                                } else {
                                                  // No initial version saved, but we have active code - this shouldn't restore
                                                  showToast("Initial version not saved - cannot restore", "error");
                                                  return;
                                                }
                                              } else {
                                                // Load full data from server
                                                showToast("Loading version data...", "info");
                                                const fullGen = await loadFullGeneration(gen.id);
                                                if (!fullGen?.code) {
                                                  showToast("Failed to load version data", "error");
                                                  return;
                                                }
                                                codeToRestore = fullGen.code;
                                                flowNodesToRestore = fullGen.flowNodes;
                                                flowEdgesToRestore = fullGen.flowEdges;
                                                styleInfoToRestore = fullGen.styleInfo;
                                              }
                                            }
                                            
                                            restoreVersion(gen.id, { 
                                              id: 'initial', 
                                              timestamp: gen.timestamp, 
                                              label: 'Initial generation',
                                              code: codeToRestore || '',
                                              flowNodes: flowNodesToRestore,
                                              flowEdges: flowEdgesToRestore,
                                              styleInfo: styleInfoToRestore
                                            });
                                          }}
                                          className="opacity-0 group-hover/version:opacity-100 p-1 rounded hover:bg-white/10 transition-all"
                                          title="Restore to initial"
                                        >
                                          <Play className="w-3 h-3 text-zinc-300" />
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              </motion.div>
                            )}
                          </AnimatePresence>
                        </div>
                      </div>
                    ))}
                    
                    {/* Load More Button */}
                    {hasMoreHistory && (
                      <button
                        onClick={loadMoreGenerations}
                        disabled={isLoadingMore}
                        className="w-full py-2.5 mt-2 rounded-lg border border-zinc-700/50 bg-zinc-800/30 text-xs text-zinc-400 hover:bg-zinc-800/60 hover:text-zinc-300 transition-colors flex items-center justify-center gap-2"
                      >
                        {isLoadingMore ? (
                          <>
                            <Loader2 className="w-3 h-3 animate-spin" />
                            Loading...
                          </>
                        ) : (
                          <>
                            <ChevronDown className="w-3 h-3" />
                            Load more ({historyTotal - generations.length} remaining)
                          </>
                        )}
                      </button>
                    )}
                  </div>
                )}
              </div>
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" && viewMode === "blueprints" && generationComplete ? (
            /* BLUEPRINTS VIEW SIDEBAR - Figma-style Component List */
            <div className="flex-1 flex flex-col min-h-0 overflow-y-auto overflow-x-visible">
              <div className="flex-shrink-0 px-3 py-2 border-b border-zinc-800 relative z-50 overflow-visible">
                <div className="flex items-center justify-between">
                  <span className="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Layers</span>
                  {/* Hide add component button for demo projects */}
                  {!DEMO_PROJECT_IDS.has(activeGeneration?.id || '') && (
                    <button 
                      onClick={() => {
                        // Create new component with default name - no prompt
                        const newId = `new-${Date.now()}`;
                        const defaultName = "New Component";
                        const newComp = {
                          id: newId,
                          name: defaultName,
                          category: 'custom',
                          code: `<div className="p-6 bg-white rounded-xl shadow-lg border border-zinc-200"><h3 className="text-lg font-semibold text-zinc-900">${defaultName}</h3></div>`,
                          props: [],
                          variants: []
                        };
                        setLibraryData((prev: any) => ({
                          ...prev,
                          components: [...(prev?.components || []), newComp]
                        }));
                        setSelectedBlueprintComponent(`comp-${newId}`);
                        // Start inline editing immediately
                        setEditingComponentName(newId);
                        setEditingNameValue(defaultName);
                      }}
                      className="p-1 rounded hover:bg-zinc-800 text-zinc-500 hover:text-white group relative"
                    >
                      <Plus className="w-3.5 h-3.5" />
                      <span className="absolute -top-9 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-[9999] border border-zinc-700/50 shadow-lg">Add component</span>
                    </button>
                  )}
                </div>
              </div>
              {/* Search */}
              <div className="flex-shrink-0 px-3 py-2">
                <div className="relative">
                  <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-600" />
                  <input
                    type="text"
                    value={blueprintSearchQuery}
                    onChange={(e) => setBlueprintSearchQuery(e.target.value)}
                    placeholder="Search components..."
                    className="w-full pl-8 pr-3 py-1.5 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs text-zinc-300 placeholder:text-zinc-600 focus:outline-none focus:border-zinc-600"
                  />
                </div>
              </div>
              <div className="flex-1 overflow-y-auto">
                {(libraryData?.components?.length ?? 0) > 0 ? (
                  <div className="py-1">
                    {/* Group by category */}
                    {Object.entries(
                      (libraryData?.components || [])
                        .filter((comp: any) => 
                          !blueprintSearchQuery || 
                          comp.name?.toLowerCase().includes(blueprintSearchQuery.toLowerCase()) ||
                          comp.category?.toLowerCase().includes(blueprintSearchQuery.toLowerCase())
                        )
                        .reduce((acc: any, comp: any) => {
                        const cat = comp.category || 'other';
                        if (!acc[cat]) acc[cat] = [];
                        acc[cat].push(comp);
                        return acc;
                      }, {})
                    ).map(([category, comps]: [string, any]) => (
                      <div key={category} className="mb-2">
                        <div className="px-3 py-1 text-[9px] font-semibold uppercase tracking-wider text-zinc-600">
                          {category}
                        </div>
                        {comps.map((comp: any) => (
                          <div
                            key={comp.id}
                            onClick={() => {
                              if (editingComponentName !== comp.id) {
                                setSelectedBlueprintComponent(`comp-${comp.id}`);
                              }
                            }}
                            onDoubleClick={() => {
                              // Start inline editing on double-click
                              setEditingComponentName(comp.id);
                              setEditingNameValue(comp.name);
                            }}
                            className={cn(
                              "w-full flex items-center gap-2 px-3 py-1.5 text-left transition-all text-[11px] group cursor-pointer",
                              selectedBlueprintComponent === `comp-${comp.id}` 
                                ? "bg-zinc-700/50 text-white" 
                                : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-200"
                            )}
                          >
                            <Box className="w-3 h-3 flex-shrink-0 opacity-60" />
                            {editingComponentName === comp.id ? (
                              <input
                                type="text"
                                value={editingNameValue}
                                onChange={(e) => setEditingNameValue(e.target.value)}
                                onBlur={() => {
                                  // Save on blur
                                  if (editingNameValue.trim()) {
                                    setLibraryData((prev: any) => ({
                                      ...prev,
                                      components: prev?.components?.map((c: any) => 
                                        c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c
                                      ) || []
                                    }));
                                  }
                                  setEditingComponentName(null);
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    // Save on Enter
                                    if (editingNameValue.trim()) {
                                      setLibraryData((prev: any) => ({
                                        ...prev,
                                        components: prev?.components?.map((c: any) => 
                                          c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c
                                        ) || []
                                      }));
                                    }
                                    setEditingComponentName(null);
                                  } else if (e.key === 'Escape') {
                                    setEditingComponentName(null);
                                  }
                                }}
                                className="flex-1 bg-zinc-800 border border-zinc-600 rounded px-1.5 py-0.5 text-[11px] text-white focus:outline-none focus:border-emerald-500"
                                autoFocus
                                onClick={(e) => e.stopPropagation()}
                              />
                            ) : (
                              <span 
                                className="truncate flex-1 cursor-text"
                                onClick={(e) => {
                                  // Single click on name to edit when already selected
                                  if (selectedBlueprintComponent === `comp-${comp.id}`) {
                                    e.stopPropagation();
                                    setEditingComponentName(comp.id);
                                    setEditingNameValue(comp.name);
                                  }
                                }}
                              >
                                {comp.name}
                              </span>
                            )}
                            {/* 3-dot menu - ALWAYS visible when selected */}
                            <div className="relative">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  // Toggle dropdown
                                  const menu = e.currentTarget.nextElementSibling as HTMLElement;
                                  if (menu) {
                                    menu.classList.toggle('hidden');
                                    // Close on click outside
                                    const closeMenu = (ev: MouseEvent) => {
                                      if (!menu.contains(ev.target as Node) && ev.target !== e.currentTarget) {
                                        menu.classList.add('hidden');
                                        document.removeEventListener('click', closeMenu);
                                      }
                                    };
                                    setTimeout(() => document.addEventListener('click', closeMenu), 0);
                                  }
                                }}
                                className={cn(
                                  "p-1 rounded hover:bg-zinc-700 text-zinc-400 hover:text-white transition-all",
                                  selectedBlueprintComponent === `comp-${comp.id}` 
                                    ? "opacity-100" 
                                    : "opacity-0 group-hover:opacity-100"
                                )}
                                title="Options"
                              >
                                <MoreVertical className="w-3.5 h-3.5" />
                              </button>
                              {/* Dropdown menu */}
                              <div className="hidden absolute right-0 top-full mt-1 z-50 w-32 bg-zinc-800 border border-zinc-700 rounded-lg shadow-xl py-1">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setEditingComponentName(comp.id);
                                    setEditingNameValue(comp.name);
                                    (e.currentTarget.parentElement as HTMLElement)?.classList.add('hidden');
                                  }}
                                  className="w-full px-3 py-1.5 text-left text-xs text-zinc-300 hover:bg-zinc-700 flex items-center gap-2"
                                >
                                  <Pencil className="w-3 h-3" /> Rename
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const newId = `${comp.id}-copy-${Date.now()}`;
                                    const newComp = { ...comp, id: newId, name: `${comp.name} (Copy)` };
                                    setLibraryData((prev: any) => ({
                                      ...prev,
                                      components: [...(prev?.components || []), newComp]
                                    }));
                                    (e.currentTarget.parentElement as HTMLElement)?.classList.add('hidden');
                                  }}
                                  className="w-full px-3 py-1.5 text-left text-xs text-zinc-300 hover:bg-zinc-700 flex items-center gap-2"
                                >
                                  <Copy className="w-3 h-3" /> Duplicate
                                </button>
                                <div className="border-t border-zinc-700 my-1" />
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    // Delete component
                                    setLibraryData((prev: any) => ({
                                      ...prev,
                                      components: prev?.components?.filter((c: any) => c.id !== comp.id) || []
                                    }));
                                    if (selectedBlueprintComponent === `comp-${comp.id}`) {
                                      setSelectedBlueprintComponent(null);
                                    }
                                    (e.currentTarget.parentElement as HTMLElement)?.classList.add('hidden');
                                  }}
                                  className="w-full px-3 py-1.5 text-left text-xs text-red-400 hover:bg-red-500/20 flex items-center gap-2"
                                >
                                  <Trash2 className="w-3 h-3" /> Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="p-4 text-center text-zinc-500 text-xs">
                    <Layers className="w-6 h-6 mx-auto mb-2 opacity-50" />
                    <p>No components</p>
                  </div>
                )}
              </div>
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" && viewMode === "library" && generationComplete ? (
            /* LIBRARY VIEW SIDEBAR - Full Tree (1:1 with removed middle panel) */
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden bg-[#111111]">
              {/* Search */}
              <div className="p-3 border-b border-zinc-800/50">
                <div className="relative">
                  <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-600" />
                  <input
                    type="text"
                    value={librarySearchQuery}
                    onChange={(e) => setLibrarySearchQuery(e.target.value)}
                    placeholder="Find components..."
                    className="w-full pl-8 pr-3 py-1.5 text-xs bg-zinc-800/50 border border-zinc-700/50 rounded-md text-zinc-300 placeholder:text-zinc-600 focus:outline-none focus:border-zinc-600"
                  />
                  {librarySearchQuery && (
                    <button 
                      onClick={() => setLibrarySearchQuery("")}
                      className="absolute right-2.5 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-zinc-300"
                    >
                      <X className="w-3 h-3" />
                    </button>
                  )}
                </div>
                {/* Share Library - public read-only link */}
                <div className="mt-2">
                  {activeGeneration?.publishedSlug ? (
                    <a
                      href={`https://www.replay.build/p/${activeGeneration.publishedSlug}/library`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center justify-center gap-1.5 w-full px-2 py-1.5 text-[10px] font-medium bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-md border border-zinc-700/50 transition-colors"
                    >
                      <Share2 className="w-3 h-3" /> Share Library
                    </a>
                  ) : (
                    <p className="text-[10px] text-zinc-500 text-center px-1">
                      Publish project to get a shareable Library link
                    </p>
                  )}
                </div>
              </div>
              
              {/* Tree */}
              <div className="flex-1 overflow-auto p-2">
                {!libraryData ? (
                  <div className="flex flex-col items-center justify-center h-full p-4 text-center">
                    <Library className="w-8 h-8 text-zinc-700 mb-3" />
                    <p className="text-xs text-zinc-500 mb-1">No library yet</p>
                    <p className="text-[10px] text-zinc-600 mb-4">Generate code to extract components</p>
                    {generatedCode && (
                      <button
                        onClick={async () => {
                          setIsGeneratingLibrary(true);
                          try {
                            const response = await fetch("/api/generate/library", {
                              method: "POST",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ code: editableCode || generatedCode, styleInfo })
                            });
                            const result = await response.json();
                            if (result.success && result.data) {
                              // Extract only - replace components with freshly extracted ones
                              const newComponents = (result.data.components || []).map((comp: any) => ({
                                ...comp,
                                source: "generated",
                                isNew: true,
                                id: comp.id || `comp-${comp.name?.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                              }));
                              
                              // Keep DS tokens if present, merge with extracted foundations
                              const currentFoundations = (libraryData as any)?.foundations || {};
                              const mergedFoundations = {
                                colors: { ...(currentFoundations.colors || {}), ...(result.data.foundations?.colors || {}) },
                                typography: { ...(currentFoundations.typography || {}), ...(result.data.foundations?.typography || {}) },
                                spacing: { ...(currentFoundations.spacing || {}), ...(result.data.foundations?.spacing || {}) },
                                borderRadius: { ...(currentFoundations.borderRadius || {}), ...(result.data.foundations?.borderRadius || {}) },
                                shadows: { ...(currentFoundations.shadows || {}), ...(result.data.foundations?.shadows || {}) },
                              };
                              
                              const extractedData = {
                                ...result.data,
                                components: newComponents,
                                foundations: mergedFoundations,
                                tokens: {
                                  colors: mergedFoundations.colors,
                                  typography: mergedFoundations.typography,
                                  spacing: mergedFoundations.spacing,
                                  borderRadius: mergedFoundations.borderRadius,
                                  shadows: mergedFoundations.shadows,
                                },
                              };
                              
                              setLibraryData(extractedData);
                              setSelectedLibraryItem("doc-overview");
                              console.log(`[Library] Extracted: ${newComponents.length} components from code`);
                              
                              // Update localStorage backup with library data
                              if (activeGeneration?.id) {
                                try {
                                  const localKey = `replay_local_project_${activeGeneration.id}`;
                                  const existing = localStorage.getItem(localKey);
                                  if (existing) {
                                    const parsed = JSON.parse(existing);
                                    parsed.libraryData = extractedData;
                                    localStorage.setItem(localKey, JSON.stringify(parsed));
                                  }
                                } catch (e) {}
                              }
                            }
                          } catch (e) {
                            console.error("Library generation failed:", e);
                          } finally {
                            setIsGeneratingLibrary(false);
                          }
                        }}
                        disabled={isGeneratingLibrary}
                        className="w-full px-3 py-2 text-xs font-medium bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg border border-zinc-700 transition-colors disabled:opacity-50"
                      >
                        {isGeneratingLibrary ? (
                          <span className="flex items-center justify-center gap-1.5">
                            <Loader2 className="w-3 h-3 animate-spin" />
                            Extracting...
                          </span>
                        ) : (
                          <span className="flex items-center justify-center gap-1.5">
                            <Sparkles className="w-3.5 h-3.5" />
                            Extract Components
                          </span>
                        )}
                      </button>
                    )}
                  </div>
                ) : (
                  <div className="space-y-1">
                    {/* Extract New Components Button */}
                    {generatedCode && (
                      <button
                        onClick={async () => {
                          setIsGeneratingLibrary(true);
                          try {
                            const response = await fetch("/api/generate/library", {
                              method: "POST",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ code: editableCode || generatedCode, styleInfo })
                            });
                            const result = await response.json();
                            if (result.success && result.data) {
                              // Extract only - replace components with freshly extracted ones
                              const newComponents = (result.data.components || []).map((comp: any) => ({
                                ...comp,
                                source: "generated",
                                isNew: true,
                                id: comp.id || `comp-${comp.name?.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                              }));
                              
                              // Keep DS tokens if present, merge with extracted foundations
                              const currentFoundations = (libraryData as any)?.foundations || {};
                              const mergedFoundations = {
                                colors: { ...(currentFoundations.colors || {}), ...(result.data.foundations?.colors || {}) },
                                typography: { ...(currentFoundations.typography || {}), ...(result.data.foundations?.typography || {}) },
                                spacing: { ...(currentFoundations.spacing || {}), ...(result.data.foundations?.spacing || {}) },
                                borderRadius: { ...(currentFoundations.borderRadius || {}), ...(result.data.foundations?.borderRadius || {}) },
                                shadows: { ...(currentFoundations.shadows || {}), ...(result.data.foundations?.shadows || {}) },
                              };
                              
                              const extractedData = {
                                ...result.data,
                                components: newComponents,
                                foundations: mergedFoundations,
                                tokens: {
                                  colors: mergedFoundations.colors,
                                  typography: mergedFoundations.typography,
                                  spacing: mergedFoundations.spacing,
                                  borderRadius: mergedFoundations.borderRadius,
                                  shadows: mergedFoundations.shadows,
                                },
                              };
                              
                              setLibraryData(extractedData);
                              setLibraryCodeHash((editableCode || generatedCode).slice(0, 500) + (editableCode || generatedCode).length);
                              setSelectedLibraryItem("doc-overview");
                              console.log(`[Library] Extracted: ${newComponents.length} components from code`);
                              
                              // Update localStorage backup with library data
                              if (activeGeneration?.id) {
                                try {
                                  const localKey = `replay_local_project_${activeGeneration.id}`;
                                  const existing = localStorage.getItem(localKey);
                                  if (existing) {
                                    const parsed = JSON.parse(existing);
                                    parsed.libraryData = extractedData;
                                    localStorage.setItem(localKey, JSON.stringify(parsed));
                                  }
                                } catch (e) {}
                              }
                            }
                          } catch (e) {
                            console.error("Library generation failed:", e);
                          } finally {
                            setIsGeneratingLibrary(false);
                          }
                        }}
                        disabled={isGeneratingLibrary}
                        className="w-full mb-2 px-3 py-1.5 text-[10px] border border-zinc-700/50 bg-zinc-800/30 text-zinc-400 rounded-md hover:bg-zinc-800 hover:text-zinc-300 disabled:opacity-50 flex items-center justify-center gap-1.5 transition-colors"
                      >
                        {isGeneratingLibrary ? (
                          <><Loader2 className="w-3 h-3 animate-spin" />Extracting...</>
                        ) : (
                          <><Plus className="w-3 h-3" />Extract New Components</>
                        )}
                      </button>
                    )}
                    
                    {/* Export Buttons */}
                    {libraryData?.components?.length > 0 && (
                      <div className="flex gap-1 mb-2">
                        <button
                          onClick={() => {
                            // Export HTML - convert JSX to clean HTML
                            const components = libraryData?.components || [];
                            let html = `<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Components Library</title>\n  <script src="https://cdn.tailwindcss.com"></script>\n</head>\n<body class="bg-zinc-900 p-8">\n\n`;
                            
                            components.forEach((comp: any) => {
                              const code = comp.code || '';
                              // Convert JSX to HTML
                              const htmlCode = code
                                .replace(/className=/g, 'class=')
                                .replace(/htmlFor=/g, 'for=')
                                .replace(/\{\/\*.*?\*\/\}/g, '')
                                .replace(/\{`([^`]*)`\}/g, '$1')
                                .replace(/\{"([^"]*)"\}/g, '$1')
                                .replace(/\{([^}]+)\}/g, '{{$1}}'); // Convert props to placeholders
                              
                              html += `<!-- ${comp.name} -->\n<div class="mb-12">\n  <h2 class="text-xl font-bold text-white mb-4">${comp.name}</h2>\n  <div class="p-4 border border-zinc-700 rounded-lg">\n    ${htmlCode}\n  </div>\n</div>\n\n`;
                            });
                            
                            html += `</body>\n</html>`;
                            
                            const blob = new Blob([html], { type: 'text/html' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'components-library.html';
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast("HTML exported!", "success");
                          }}
                          className="flex-1 px-2 py-1.5 text-[10px] border border-zinc-700/50 bg-zinc-800/30 text-zinc-400 rounded-md hover:bg-zinc-800 hover:text-zinc-300 flex items-center justify-center gap-1 transition-colors"
                        >
                          <Code className="w-3 h-3" />
                          HTML
                        </button>
                        <button
                          onClick={() => {
                            // Export JSON Schema for CMS
                            const components = libraryData?.components || [];
                            const schema = {
                              "$schema": "http://json-schema.org/draft-07/schema#",
                              "title": "Design System Components",
                              "description": "JSON Schema for CMS content mapping",
                              "components": components.map((comp: any) => ({
                                "name": comp.name,
                                "id": comp.id,
                                "description": comp.description || "",
                                "category": comp.category || "component",
                                "layer": comp.layer || "components",
                                "fields": (comp.props || []).map((prop: any) => ({
                                  "name": prop.name,
                                  "type": prop.type || "string",
                                  "required": prop.required || false,
                                  "default": prop.default || null,
                                  "description": prop.description || "",
                                  "options": prop.options || null
                                }))
                              }))
                            };
                            
                            const blob = new Blob([JSON.stringify(schema, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'components-schema.json';
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast("JSON Schema exported!", "success");
                          }}
                          className="flex-1 px-2 py-1.5 text-[10px] border border-zinc-700/50 bg-zinc-800/30 text-zinc-400 rounded-md hover:bg-zinc-800 hover:text-zinc-300 flex items-center justify-center gap-1 transition-colors"
                        >
                          <FileText className="w-3 h-3" />
                          Schema
                        </button>
                      </div>
                    )}
                    
                    {/* DOCS Section */}
                    <div className="mb-2">
                      <div className="flex items-center">
                        <button 
                          onClick={() => setLibrarySectionsExpanded(prev => ({ ...prev, docs: !prev.docs }))}
                          className="flex-1 flex items-center gap-1.5 px-2 py-1.5 text-[10px] font-semibold text-zinc-500 uppercase tracking-wider hover:text-zinc-300 hover:bg-zinc-800/30 rounded transition-colors"
                        >
                          {librarySectionsExpanded.docs ? <ChevronDown className="w-3 h-3" /> : <ChevronRight className="w-3 h-3" />}
                          <FileText className="w-3 h-3" />
                          DOCS
                          <span className="text-zinc-600 ml-auto">{(libraryData.docs || []).filter((d: any) => !['colors', 'typography', 'iconography', 'icons', 'spacing'].includes(d.id)).length || 3}</span>
                        </button>
                        {/* Regenerate Docs Button */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            generateLibraryDocs(true);
                          }}
                          disabled={isGeneratingLibraryDocs}
                          className="p-1.5 text-zinc-500 hover:text-violet-400 hover:bg-violet-500/10 rounded transition-colors"
                          title="Regenerate documentation from code"
                        >
                          {isGeneratingLibraryDocs ? (
                            <Loader2 className="w-3 h-3 animate-spin" />
                          ) : (
                            <RefreshCw className="w-3 h-3" />
                          )}
                        </button>
                      </div>
                      {librarySectionsExpanded.docs && (
                        <div className="ml-2 space-y-0.5 mt-1">
                          {isGeneratingLibraryDocs ? (
                            <div className="flex items-center gap-2 px-2 py-2 text-xs text-zinc-500">
                              <Loader2 className="w-3 h-3 animate-spin" />
                              <span>Generating docs...</span>
                            </div>
                          ) : (libraryData.docs?.length > 0 ? libraryData.docs : [
                            { id: "overview", title: "Overview", type: "overview" },
                            { id: "getting-started", title: "Getting Started", type: "getting-started" },
                            { id: "examples", title: "Examples", type: "examples" },
                          ])
                          // Filter out Colors/Typography/Iconography - they're already in FOUNDATIONS
                          .filter((doc: any) => !['colors', 'typography', 'iconography', 'icons', 'spacing'].includes(doc.id))
                          .map((doc: any) => (
                            <button
                              key={doc.id}
                              onClick={() => setSelectedLibraryItem(`doc-${doc.id}`)}
                              className={cn(
                                "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors",
                                selectedLibraryItem === `doc-${doc.id}` ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                              )}
                            >
                              <FileText className="w-3.5 h-3.5 flex-shrink-0" />
                              <span className="truncate">{doc.title}</span>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* ═══════════════════════════════════════════════════════════════════ */}
                    {/* 5-LAYER DESIGN SYSTEM HIERARCHY */}
                    {/* ═══════════════════════════════════════════════════════════════════ */}
                    
                    {/* Layer config */}
                    {(() => {
                      const layers = [
                        { id: 'foundations', name: 'Foundations', icon: <Palette className="w-3 h-3" />, color: 'text-violet-400', bgColor: 'bg-violet-500/10', description: 'Design tokens' },
                        { id: 'components', name: 'Components', icon: <Layers className="w-3 h-3" />, color: 'text-blue-400', bgColor: 'bg-blue-500/10', description: 'UI building blocks' },
                        { id: 'patterns', name: 'Patterns', icon: <Layout className="w-3 h-3" />, color: 'text-amber-400', bgColor: 'bg-amber-500/10', description: 'Reusable recipes' },
                        { id: 'templates', name: 'Templates', icon: <Square className="w-3 h-3" />, color: 'text-teal-400', bgColor: 'bg-teal-500/10', description: 'Page layouts' },
                        { id: 'product', name: 'Product Modules', icon: <Rocket className="w-3 h-3" />, color: 'text-rose-400', bgColor: 'bg-rose-500/10', description: 'Brand-specific' },
                      ];

                      // Subcategory config for Components layer
                      const subcategories = [
                        { id: 'actions', name: 'Actions', icon: <MousePointerClick className="w-2.5 h-2.5" /> },
                        { id: 'forms', name: 'Forms', icon: <TextCursorInput className="w-2.5 h-2.5" /> },
                        { id: 'navigation', name: 'Navigation', icon: <Compass className="w-2.5 h-2.5" /> },
                        { id: 'data-display', name: 'Data Display', icon: <Table className="w-2.5 h-2.5" /> },
                        { id: 'feedback', name: 'Feedback', icon: <Bell className="w-2.5 h-2.5" /> },
                        { id: 'overlays', name: 'Overlays', icon: <PanelTop className="w-2.5 h-2.5" /> },
                      ];

                      // Group components by layer
                      const componentsByLayer: Record<string, any[]> = {
                        foundations: [],
                        components: [],
                        patterns: [],
                        templates: [],
                        product: []
                      };

                      // Group components within Components layer by subcategory
                      const componentsBySubcategory: Record<string, any[]> = {};
                      subcategories.forEach(sc => componentsBySubcategory[sc.id] = []);

                      libraryData.components
                        ?.filter((comp: any) =>
                          !librarySearchQuery ||
                          comp.name?.toLowerCase().includes(librarySearchQuery.toLowerCase()) ||
                          comp.layer?.toLowerCase().includes(librarySearchQuery.toLowerCase()) ||
                          comp.subcategory?.toLowerCase().includes(librarySearchQuery.toLowerCase())
                        )
                        ?.forEach((comp: any) => {
                          let layer = comp.layer?.toLowerCase() || 'components';
                          // Backward compat: remap old layer names
                          if (layer === 'primitives' || layer === 'elements') layer = 'components';
                          if (componentsByLayer[layer]) {
                            componentsByLayer[layer].push(comp);
                          } else {
                            componentsByLayer.components.push(comp);
                          }
                          // Also group by subcategory if it's a component
                          if (layer === 'components' && comp.subcategory) {
                            const sc = comp.subcategory.toLowerCase();
                            if (componentsBySubcategory[sc]) {
                              componentsBySubcategory[sc].push(comp);
                            } else {
                              componentsBySubcategory['data-display'].push(comp);
                            }
                          } else if (layer === 'components') {
                            componentsBySubcategory['data-display'].push(comp);
                          }
                        });
                      
                      return (
                        <div className="space-y-1">
                          {layers.map((layer) => {
                            const layerComponents = componentsByLayer[layer.id] || [];
                            const isExpanded = librarySectionsExpanded[layer.id] !== false;
                            const hasItems = layer.id === 'foundations' 
                              ? Object.keys(libraryData.foundations?.colors || {}).length > 0 || Object.keys(libraryData.foundations?.typography || {}).length > 0
                              : layerComponents.length > 0;
                            
                            return (
                              <div key={layer.id}>
                                <button 
                                  onClick={() => setLibrarySectionsExpanded(prev => ({ ...prev, [layer.id]: !isExpanded }))}
                                  className={cn(
                                    "w-full flex items-center gap-1.5 px-2 py-1.5 text-[10px] font-semibold uppercase tracking-wider rounded transition-colors",
                                    hasItems ? "text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800/30" : "text-zinc-600"
                                  )}
                                >
                                  {isExpanded ? <ChevronDown className="w-3 h-3" /> : <ChevronRight className="w-3 h-3" />}
                                  <span className={layer.color}>{layer.icon}</span>
                                  {layer.name}
                                  <span className="text-zinc-600 ml-auto text-[9px] font-normal">
                                    {layer.id === 'foundations' 
                                      ? `${Object.keys(libraryData.foundations?.colors || {}).length} colors`
                                      : layerComponents.length
                                    }
                                  </span>
                                </button>
                                
                                {isExpanded && (
                                  <div className="ml-2 space-y-0.5 mt-0.5">
                                    {/* Foundations layer - show tokens */}
                                    {layer.id === 'foundations' && (
                                      <>
                                        {/* Colors */}
                                        {Object.keys(libraryData.foundations?.colors || {}).length > 0 && (
                                          <button
                                            onClick={() => setSelectedLibraryItem('doc-colors')}
                                            className={cn(
                                              "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors",
                                              selectedLibraryItem === 'doc-colors' ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                            )}
                                          >
                                            <Palette className="w-3 h-3 text-violet-400" />
                                            <span>Colors</span>
                                            <span className="text-zinc-600 ml-auto text-[10px]">{Object.keys(libraryData.foundations?.colors || {}).length}</span>
                                          </button>
                                        )}
                                        {/* Typography */}
                                        {Object.keys(libraryData.foundations?.typography?.fontSize || {}).length > 0 && (
                                          <button
                                            onClick={() => setSelectedLibraryItem('doc-typography')}
                                            className={cn(
                                              "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors",
                                              selectedLibraryItem === 'doc-typography' ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                            )}
                                          >
                                            <Type className="w-3 h-3 text-violet-400" />
                                            <span>Typography</span>
                                          </button>
                                        )}
                                        {/* Spacing */}
                                        <button
                                          onClick={() => setSelectedLibraryItem('doc-spacing')}
                                          className={cn(
                                            "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors",
                                            selectedLibraryItem === 'doc-spacing' ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                          )}
                                        >
                                          <Ruler className="w-3 h-3 text-violet-400" />
                                          <span>Spacing</span>
                                          <span className="text-zinc-600 ml-auto text-[10px]">{Object.keys(libraryData.foundations?.spacing || {}).length || '—'}</span>
                                        </button>
                                        {/* Icons */}
                                        <button
                                          onClick={() => setSelectedLibraryItem('doc-iconography')}
                                          className={cn(
                                            "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors",
                                            selectedLibraryItem === 'doc-iconography' ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                          )}
                                        >
                                          <Grid3X3 className="w-3 h-3 text-violet-400" />
                                          <span>Icons</span>
                                        </button>
                                      </>
                                    )}
                                    
                                    {/* Components layer - show subcategory groups */}
                                    {layer.id === 'components' && subcategories.map((sc) => {
                                      const scComps = componentsBySubcategory[sc.id] || [];
                                      if (scComps.length === 0) return null;
                                      const isScExpanded = libraryCategoriesExpanded[sc.id] !== false;
                                      return (
                                        <div key={sc.id} className="mb-0.5">
                                          <button
                                            onClick={() => setLibraryCategoriesExpanded(prev => ({ ...prev, [sc.id]: !isScExpanded }))}
                                            className="w-full flex items-center gap-1.5 px-1.5 py-1 text-[10px] font-medium text-zinc-500 hover:text-zinc-300 rounded transition-colors"
                                          >
                                            {isScExpanded ? <ChevronDown className="w-2.5 h-2.5" /> : <ChevronRight className="w-2.5 h-2.5" />}
                                            <span className="text-blue-400/70">{sc.icon}</span>
                                            {sc.name}
                                            <span className="text-zinc-600 ml-auto text-[9px]">{scComps.length}</span>
                                          </button>
                                          {isScExpanded && scComps.map((comp: any) => (
                                            <div
                                              key={comp.id}
                                              className={cn(
                                                "w-full flex items-center gap-2 px-2 pl-5 py-1.5 text-xs rounded-md transition-colors group/comp cursor-pointer",
                                                selectedLibraryItem === `comp-${comp.id}` ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                              )}
                                              onClick={() => { if (editingComponentName !== comp.id) { setSelectedLibraryItem(`comp-${comp.id}`); setLibraryPropsOverride({}); } }}
                                              onDoubleClick={() => { setEditingComponentName(comp.id); setEditingNameValue(comp.name); }}
                                            >
                                              <span className={layer.color}>{layer.icon}</span>
                                              {editingComponentName === comp.id ? (
                                                <input type="text" value={editingNameValue} onChange={(e) => setEditingNameValue(e.target.value)}
                                                  onBlur={() => { if (editingNameValue.trim()) { setLibraryData((prev: any) => ({ ...prev, components: prev?.components?.map((c: any) => c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c) || [] })); } setEditingComponentName(null); }}
                                                  onKeyDown={(e) => { if (e.key === 'Enter') { if (editingNameValue.trim()) { setLibraryData((prev: any) => ({ ...prev, components: prev?.components?.map((c: any) => c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c) || [] })); } setEditingComponentName(null); } else if (e.key === 'Escape') { setEditingComponentName(null); } }}
                                                  className="flex-1 bg-zinc-700 border border-zinc-600 rounded px-1.5 py-0.5 text-[11px] text-white focus:outline-none focus:border-emerald-500" autoFocus onClick={(e) => e.stopPropagation()} />
                                              ) : (
                                                <span className="truncate flex-1 text-left">
                                                  {comp.name}
                                                </span>
                                              )}
                                              <button onClick={(e) => { e.stopPropagation(); setEditingComponentName(comp.id); setEditingNameValue(comp.name); }}
                                                className={cn("p-0.5 hover:bg-zinc-700 rounded transition-opacity", selectedLibraryItem === `comp-${comp.id}` ? "opacity-100" : "opacity-0 group-hover/comp:opacity-100")} title="Rename">
                                                <Pencil className="w-3 h-3" />
                                              </button>
                                              <button onClick={(e) => { e.stopPropagation(); if (libraryData) { const updated = { ...libraryData, components: libraryData.components.filter((c: any) => c.id !== comp.id) }; setLibraryData(updated); if (selectedLibraryItem === `comp-${comp.id}`) setSelectedLibraryItem(null); } }}
                                                className={cn("p-0.5 hover:bg-zinc-700 rounded transition-opacity", selectedLibraryItem === `comp-${comp.id}` ? "opacity-100" : "opacity-0 group-hover/comp:opacity-100")} title="Delete component">
                                                <X className="w-3 h-3" />
                                              </button>
                                            </div>
                                          ))}
                                        </div>
                                      );
                                    })}

                                    {/* Other layers (patterns, templates, product) - flat component list */}
                                    {layer.id !== 'foundations' && layer.id !== 'components' && layerComponents.map((comp: any) => (
                                      <div
                                        key={comp.id}
                                        className={cn(
                                          "w-full flex items-center gap-2 px-2 py-1.5 text-xs rounded-md transition-colors group/comp cursor-pointer",
                                          selectedLibraryItem === `comp-${comp.id}` ? "bg-zinc-800 text-white" : "text-zinc-400 hover:bg-zinc-800/50 hover:text-zinc-300"
                                        )}
                                        onClick={() => { if (editingComponentName !== comp.id) { setSelectedLibraryItem(`comp-${comp.id}`); setLibraryPropsOverride({}); } }}
                                        onDoubleClick={() => { setEditingComponentName(comp.id); setEditingNameValue(comp.name); }}
                                      >
                                        <span className={layer.color}>{layer.icon}</span>
                                        {editingComponentName === comp.id ? (
                                          <input type="text" value={editingNameValue} onChange={(e) => setEditingNameValue(e.target.value)}
                                            onBlur={() => { if (editingNameValue.trim()) { setLibraryData((prev: any) => ({ ...prev, components: prev?.components?.map((c: any) => c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c) || [] })); } setEditingComponentName(null); }}
                                            onKeyDown={(e) => { if (e.key === 'Enter') { if (editingNameValue.trim()) { setLibraryData((prev: any) => ({ ...prev, components: prev?.components?.map((c: any) => c.id === comp.id ? { ...c, name: editingNameValue.trim() } : c) || [] })); } setEditingComponentName(null); } else if (e.key === 'Escape') { setEditingComponentName(null); } }}
                                            className="flex-1 bg-zinc-700 border border-zinc-600 rounded px-1.5 py-0.5 text-[11px] text-white focus:outline-none focus:border-emerald-500" autoFocus onClick={(e) => e.stopPropagation()} />
                                        ) : (
                                          <span className="truncate flex-1 text-left">
                                            {comp.name}
                                          </span>
                                        )}
                                        <button onClick={(e) => { e.stopPropagation(); setEditingComponentName(comp.id); setEditingNameValue(comp.name); }}
                                          className={cn("p-0.5 hover:bg-zinc-700 rounded transition-opacity", selectedLibraryItem === `comp-${comp.id}` ? "opacity-100" : "opacity-0 group-hover/comp:opacity-100")} title="Rename">
                                          <Pencil className="w-3 h-3" />
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); if (libraryData) { const updated = { ...libraryData, components: libraryData.components.filter((c: any) => c.id !== comp.id) }; setLibraryData(updated); if (selectedLibraryItem === `comp-${comp.id}`) setSelectedLibraryItem(null); } }}
                                          className={cn("p-0.5 hover:bg-zinc-700 rounded transition-opacity", selectedLibraryItem === `comp-${comp.id}` ? "opacity-100" : "opacity-0 group-hover/comp:opacity-100")} title="Delete component">
                                          <X className="w-3 h-3" />
                                        </button>
                                      </div>
                                    ))}
                                    
                                    {/* Empty state */}
                                    {layer.id !== 'foundations' && layer.id !== 'components' && layerComponents.length === 0 && (
                                      <div className="px-2 py-2 text-[10px] text-zinc-600 italic">
                                        No {layer.name.toLowerCase()} extracted
                                      </div>
                                    )}
                                    {layer.id === 'components' && layerComponents.length === 0 && (
                                      <div className="px-2 py-2 text-[10px] text-zinc-600 italic">
                                        No components extracted
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}
                  </div>
                )}
              </div>
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" && viewMode === "flow" && generationComplete ? (
            /* FLOW VIEW SIDEBAR - 3-Tier System: Observed → Detected → Inferred */
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
              <div className="flex-shrink-0 px-3 py-2 border-b border-zinc-800 flex items-center justify-between">
                <span className="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Flow Map</span>
                <div className="flex items-center gap-1">
                  <button
                    onClick={() => {
                      const code = editableCode || generatedCode;
                      if (code) {
                        buildFlowLive(code);
                      }
                    }}
                    className="p-1 hover:bg-zinc-800 rounded transition-colors"
                    title="Refresh flow from code"
                    disabled={flowBuilding}
                  >
                    <RefreshCw className={cn("w-3.5 h-3.5 text-zinc-500 hover:text-zinc-300", flowBuilding && "animate-spin")} />
                  </button>
                  <button
                    onClick={() => {
                      const pageNum = flowNodes.filter(n => n.name.startsWith('New Page')).length + 1;
                      const pageName = `New Page ${pageNum}`;
                      const pageId = `new-page-${Date.now()}`;
                      const maxY = Math.max(...flowNodes.map(n => n.y || 0), 0);
                      const newNode = {
                        id: pageId,
                        name: pageName,
                        type: 'view' as const,
                        status: 'detected' as const,
                        description: 'Click to edit description',
                        x: 100,
                        y: maxY + 200,
                        confidence: 'high' as const
                      };
                      setFlowNodes(prev => [...prev, newNode]);
                    }}
                    className="p-1 hover:bg-zinc-800 rounded transition-colors"
                    title="Add custom page"
                  >
                    <Plus className="w-3.5 h-3.5 text-zinc-500 hover:text-zinc-300" />
                  </button>
                </div>
              </div>
              <div className="flex-1 overflow-y-auto p-3 space-y-4">
                {/* TIER 1: OBSERVED (SOLID) - Seen on video ≥2s, 100% certain */}
                <div>
                  <div className="text-[9px] font-semibold uppercase tracking-wider text-emerald-400/80 mb-2 flex items-center gap-1.5">
                    <Check className="w-3 h-3" /> Observed — Shown in Video
                  </div>
                  {flowNodes.filter(n => n.status === "observed" || n.status === "added").length > 0 ? (
                    <div className="space-y-1">
                      {flowNodes.filter(n => n.status === "observed" || n.status === "added").map((node) => (
                        <button
                          key={node.id}
                          onClick={() => {
                            setSelectedFlowNode(node.id);
                            handleFlowNodeCodeFocus(node.id, "preview");
                          }}
                          className={cn(
                            "w-full flex items-center gap-2 px-3 py-2 rounded-lg text-xs transition-all text-left",
                            selectedFlowNode === node.id 
                              ? "bg-zinc-700/50 border border-zinc-500/50 text-zinc-200" 
                              : "bg-zinc-800/50 border border-zinc-700/40 text-zinc-300 hover:bg-zinc-700/40"
                          )}
                        >
                          <FileText className="w-3.5 h-3.5 flex-shrink-0" />
                          <span className="truncate flex-1">{node.name}</span>
                          {node.videoEvidence?.duration && (
                            <span className="text-[8px] text-zinc-500">{node.videoEvidence.duration.toFixed(1)}s</span>
                          )}
                          {node.status === "added" && (
                            <span className="text-[8px] px-1 py-0.5 rounded bg-blue-500/20 text-blue-400">AI</span>
                          )}
                        </button>
                      ))}
                    </div>
                  ) : (
                    <p className="text-xs text-zinc-600 px-2">No pages observed</p>
                  )}
                </div>
                
                {/* TIER 2: DETECTED (DASHED) - Link/button visible but not clicked */}
                <div>
                  <div className="text-[9px] font-semibold uppercase tracking-wider text-blue-400/70 mb-2 flex items-center gap-1.5">
                    <AlertCircle className="w-3 h-3" /> Possible Paths — In Nav Only
                  </div>
                  {flowNodes.filter(n => n.status === "detected").length > 0 ? (
                    <div className="space-y-1">
                      {flowNodes.filter(n => n.status === "detected").map((node) => (
                        <div
                          key={node.id}
                          className="flex items-center gap-2 px-3 py-2 rounded-lg bg-zinc-800/30 border border-zinc-700/30 border-dashed text-zinc-400 text-xs group"
                        >
                          <FileText className="w-3.5 h-3.5 opacity-60 flex-shrink-0" />
                          <span className="truncate flex-1">{node.name}</span>
                          {node.videoEvidence?.hoverDetected && (
                            <span className="text-[8px] text-zinc-500">hover</span>
                          )}
                          <button
                            onClick={() => {
                              setEditInput(`@${node.name} Create this page with full content matching the design`);
                              setShowFloatingEdit(true);
                              setTimeout(() => editInputRef.current?.focus(), 100);
                            }}
                            className="opacity-0 group-hover:opacity-100 px-2 py-0.5 text-[9px] bg-zinc-700 hover:bg-zinc-600 text-zinc-300 rounded transition-all"
                          >
                            + Reconstruct
                          </button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-xs text-zinc-600 px-2">No detected pages</p>
                  )}
                </div>
                
                {/* TIER 3: INFERRED (GHOST) - AI suggestion based on patterns */}
                {flowNodes.filter(n => n.status === "inferred" || n.status === "possible").length > 0 && (
                  <div>
                    <div className="text-[9px] font-semibold uppercase tracking-wider text-zinc-500/60 mb-2 flex items-center gap-1.5">
                      <GitBranch className="w-3 h-3" /> AI Suggested Pages
                    </div>
                    <div className="space-y-1">
                      {flowNodes.filter(n => n.status === "inferred" || n.status === "possible").map((node) => (
                        <div
                          key={node.id}
                          className="flex items-center gap-2 px-3 py-2 rounded-lg bg-zinc-800/30 border border-zinc-700/30 border-dotted text-zinc-500 text-xs group"
                        >
                          <FileText className="w-3.5 h-3.5 opacity-40 flex-shrink-0" />
                          <span className="truncate flex-1 italic">{node.name}</span>
                          <span className={cn(
                            "text-[8px] px-1 py-0.5 rounded",
                            node.confidence === "high" ? "bg-zinc-700 text-zinc-400" :
                            node.confidence === "medium" ? "bg-zinc-800 text-zinc-500" :
                            "bg-zinc-900 text-zinc-600"
                          )}>
                            {node.confidence}
                          </span>
                          <button
                            onClick={() => {
                              setEditInput(`@${node.name} Create this page - AI suggested based on app patterns`);
                              setShowFloatingEdit(true);
                              setTimeout(() => editInputRef.current?.focus(), 100);
                            }}
                            className="opacity-0 group-hover:opacity-100 px-2 py-0.5 text-[9px] bg-zinc-700 hover:bg-zinc-600 text-zinc-300 rounded transition-all"
                          >
                            + Create
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Connections with semantic types */}
                <div>
                  <div className="text-[9px] font-semibold uppercase tracking-wider text-zinc-500 mb-2 flex items-center gap-1.5">
                    <ArrowRight className="w-3 h-3" /> Connections
                  </div>
                  {flowEdges.length > 0 ? (
                    <div className="space-y-1">
                      {flowEdges.slice(0, 10).map((edge, i) => {
                        const fromNode = flowNodes.find(n => n.id === edge.from);
                        const toNode = flowNodes.find(n => n.id === edge.to);
                        const isHover = edge.type === "hover";
                        const isPossible = edge.type === "possible";
                        return (
                          <div key={i} className={cn(
                            "flex items-center gap-2 text-[10px] px-2 py-1.5 rounded",
                            isPossible ? "text-zinc-600" : isHover ? "text-amber-500/60" : "text-zinc-400"
                          )}>
                            <span className="truncate max-w-[70px]">{fromNode?.name || edge.from}</span>
                            <ArrowRight className={cn(
                              "w-3 h-3 flex-shrink-0",
                              isPossible ? "opacity-30" : isHover ? "opacity-50" : "opacity-60"
                            )} />
                            <span className="truncate max-w-[70px]">{toNode?.name || edge.to}</span>
                            {isHover && <span className="text-[8px] text-amber-500/40">hover</span>}
                            {edge.videoEvidence?.timestamp !== undefined && (
                              <span className="text-[8px] text-zinc-600 ml-auto">{edge.videoEvidence.timestamp.toFixed(1)}s</span>
                            )}
                          </div>
                        );
                      })}
                      {flowEdges.length > 10 && (
                        <p className="text-[9px] text-zinc-600 px-2">+{flowEdges.length - 10} more...</p>
                      )}
                    </div>
                  ) : (
                    <p className="text-xs text-zinc-600 px-2">No connections</p>
                  )}
                </div>
              </div>
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" && viewMode === "code" && generationComplete ? (
            /* CODE VIEW SIDEBAR - Mode Toggle + Agent Mode + File Tree */
            <div className="flex-1 flex flex-col min-h-0 overflow-hidden bg-[#111111]">
              {/* Mode Toggle: Componentized / Single-file */}
              <div className="p-2 border-b border-zinc-800">
                <div className="flex items-center bg-zinc-900 rounded-lg p-0.5">
                  <button
                    onClick={() => generationComplete && setCodeMode("componentized")}
                    disabled={!generationComplete}
                    className={cn(
                      "flex-1 px-2 py-1 rounded-md text-[10px] font-medium transition-all",
                      !generationComplete && "opacity-50 cursor-not-allowed",
                      codeMode === "componentized" 
                        ? "bg-white/10 text-white" 
                        : "text-zinc-500 hover:text-zinc-400"
                    )}
                  >
                    Componentized
                  </button>
                  <button
                    onClick={() => setCodeMode("single-file")}
                    className={cn(
                      "flex-1 px-2 py-1 rounded-md text-[10px] font-medium transition-all",
                      codeMode === "single-file" 
                        ? "bg-white/10 text-white" 
                        : "text-zinc-500 hover:text-zinc-400"
                    )}
                  >
                    Single-file
                  </button>
                </div>
                
                {/* Agent Mode Toggle */}
                <div className="flex items-center justify-between mt-2 px-1">
                  <div className="flex items-center gap-1.5">
                    <span className={cn(
                      "text-[10px] font-medium",
                      agentMode ? "text-white" : "text-zinc-500"
                    )}>
                      Agent Mode
                    </span>
                    <div className="relative group">
                      <Info className="w-3 h-3 text-zinc-600 cursor-help" />
                      <div className="absolute left-0 top-full mt-2 w-48 p-2 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
                        <p className="text-[9px] text-zinc-400 leading-relaxed">
                          Adds context for <span className="text-white font-medium">Cursor</span>, <span className="text-white font-medium">Windsurf</span>, <span className="text-white font-medium">Copilot</span>
                        </p>
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => setAgentMode(!agentMode)}
                    className={cn(
                      "relative w-7 h-3.5 rounded-full transition-all",
                      agentMode ? "bg-emerald-500" : "bg-zinc-700"
                    )}
                  >
                    <span className={cn(
                      "absolute top-0.5 w-2.5 h-2.5 rounded-full bg-white shadow transition-all",
                      agentMode ? "left-[14px]" : "left-0.5"
                    )} />
                  </button>
                </div>
              </div>
              
              {/* FILES Header */}
              <div className="p-2 border-b border-zinc-800 sticky top-0 bg-[#111111] z-10">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-1.5 text-[9px] text-zinc-500 uppercase tracking-wider">
                    <FolderTree className="w-3 h-3" />
                    <span>Files</span>
                  </div>
                  <span className="text-[8px] text-white/20">{generatedFiles.length} files</span>
                </div>
              </div>
              
              <div className="flex-1 overflow-y-auto p-1 text-[10px]">
                {displayedCode && generatedFiles.length > 0 ? (
                  buildFileTree(generatedFiles.filter(f => !f.isStub)).map((item) => (
                    <FileTreeItem 
                      key={item.path} 
                      item={item} 
                      activeFilePath={activeFilePath}
                      onFileClick={(path, isStub, nodeId) => {
                        if (isStub && nodeId) {
                          if (isEditing) return;
                          const node = flowNodes.find(n => n.id === nodeId);
                          if (node) {
                            setEditInput(`@${node.name} Create this page with full content and layout`);
                            setShowFloatingEdit(true);
                            setTimeout(() => editInputRef.current?.focus(), 100);
                          }
                        } else {
                          setActiveFilePath(path);
                        }
                      }}
                      onFolderToggle={toggleFolder}
                      expandedFolders={expandedFolders}
                      generatingPath={generatingFilePath}
                    />
                  ))
                ) : (
                  <div className="flex flex-col items-center justify-center h-32 p-4 text-center">
                    <FolderTree className="w-6 h-6 text-zinc-700 mb-2" />
                    <p className="text-xs text-zinc-500">No files yet</p>
                  </div>
                )}
              </div>
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" && sidebarMode === "chat" && generationComplete && viewMode === "preview" ? (
            /* AGENTIC CHAT MODE - Only in Preview */
            <div className="flex-1 flex flex-col min-h-0">
              
              {/* Tabs: Replay AI | Settings */}
              <div className="flex-shrink-0 px-3 py-2 border-b border-zinc-800">
                <div className="flex gap-1 p-0.5 bg-zinc-800/50 rounded-lg">
                  <button
                    onClick={() => setSidebarTab("chat")}
                    className={cn(
                      "flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-md text-[11px] font-medium transition-all",
                      sidebarTab === "chat" 
                        ? "bg-white/10 text-white" 
                        : "text-zinc-500 hover:text-zinc-400"
                    )}
                  >
                    <Send className="w-3 h-3" />
                    Replay AI
                  </button>
                  <button
                    onClick={() => setSidebarTab("style")}
                    className={cn(
                      "flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-md text-[11px] font-medium transition-all",
                      sidebarTab === "style" 
                        ? "bg-white/10 text-white" 
                        : "text-zinc-500 hover:text-zinc-400"
                    )}
                  >
                    <Boxes className="w-3 h-3" />
                    Input
                  </button>
                </div>
              </div>
              
              {sidebarTab === "chat" ? (
                /* TAB: Replay AI - Chat Interface */
                <div className="flex-1 flex flex-col min-h-0">
                  {/* Chat Messages - Premium Look */}
                  <div 
                    className="flex-1 overflow-y-auto px-3 py-3 space-y-3 custom-scrollbar"
                    style={{ scrollbarWidth: 'thin', scrollbarColor: 'rgba(255,255,255,0.08) transparent' }}
                  >
                    {chatMessages.length === 0 && !isEditing ? (
                      /* STARTER PROMPTS - when chat is empty */
                      <div className="flex flex-col h-full">
                        <div className="flex-1 flex flex-col items-center justify-center text-center px-2">
                          <LogoIcon className="w-8 h-8 mb-3" color="var(--accent-orange)" />
                          <h3 className="text-sm font-medium text-zinc-300 mb-2">What can I do for you?</h3>
                          <ul className="text-[11px] text-zinc-500 space-y-1 mb-4">
                            <li>Edit styles, colors & layout</li>
                            <li>Add new sections & components</li>
                            <li>Create new pages</li>
                            <li>Fix bugs & improve design</li>
                          </ul>
                        </div>
                        
                        <div className="flex-shrink-0">
                          <div className="flex flex-wrap gap-1.5">
                            {[
                              "Dark theme",
                              "Rounded buttons",
                              "Hover animations",
                              "Contact form",
                              "About page",
                              "Pricing page",
                              "Footer section",
                              "Hero redesign"
                            ].map((prompt) => (
                              <button
                                key={prompt}
                                onClick={() => setChatInput(prompt)}
                                className="px-2.5 py-1 text-[10px] rounded-full bg-zinc-800/60 text-zinc-400 hover:bg-zinc-700 hover:text-zinc-200 border border-white/[0.04] transition-all"
                              >
                                {prompt}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Chat messages */
                      chatMessages.map((msg) => (
                      <motion.div 
                        key={msg.id} 
                        initial={{ opacity: 0, y: 8 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="space-y-2"
                      >
                        {msg.role === "assistant" ? (
                          /* AI Message - Clean, no avatar */
                          <div className="space-y-2">
                            <div className="flex items-center gap-1.5 mb-1">
                              <LogoIcon className="w-3.5 h-3.5" color="var(--accent-orange)" />
                              <span className="text-[10px] font-medium text-zinc-500">Replay</span>
                            </div>
                            <div className="text-[11px] leading-relaxed text-zinc-400 space-y-1.5">
                              {msg.content.split('\n').map((line, i) => {
                                if (line.includes('Complete')) {
                                  return (
                                    <p key={i} className="flex items-center gap-1.5 text-emerald-400/90 font-medium text-xs">
                                      <Check className="w-3 h-3" />
                                      {line.replace(/\*\*/g, '').replace('✅ ', '')}
                                    </p>
                                  );
                                }
                                if (line.startsWith('**') && line.endsWith('**')) {
                                  return <p key={i} className="font-medium text-zinc-200 text-xs">{line.replace(/\*\*/g, '')}</p>;
                                }
                                if (line.startsWith('• ') || line.startsWith('- ')) {
                                  return (
                                    <p key={i} className="flex items-start gap-1.5 text-zinc-400">
                                      <span className="text-zinc-300/70 mt-px">•</span>
                                      <span>{line.replace(/^[•-]\s/, '')}</span>
                                    </p>
                                  );
                                }
                                if (!line.trim()) return <div key={i} className="h-1" />;
                                return (
                                  <p key={i} className="text-zinc-400">
                                    {line.split(/(\*\*[^*]+\*\*)/).map((part, j) => 
                                      part.startsWith('**') && part.endsWith('**') 
                                        ? <span key={j} className="text-zinc-200 font-medium">{part.replace(/\*\*/g, '')}</span>
                                        : part
                                    )}
                                  </p>
                                );
                              })}
                            </div>
                            
                            {/* Quick Actions as chips */}
                            {msg.quickActions && msg.quickActions.length > 0 && (
                              <div className="flex flex-wrap gap-1.5 pt-1">
                                {msg.quickActions.map((action, i) => (
                                  <button
                                    key={i}
                                    onClick={() => setChatInput(action)}
                                    className="px-2 py-1 rounded text-[10px] bg-zinc-800/50 text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-200 border border-white/[0.05] transition-all"
                                  >
                                    {action}
                                  </button>
                                ))}
                              </div>
                            )}
                          </div>
                        ) : (
                          /* User Message - Right aligned, compact */
                          <div className="flex justify-end">
                            <div className="max-w-[85%]">
                              <div className="px-3 py-2 rounded-xl bg-zinc-800/50 text-[11px] text-zinc-200">
                                {msg.content}
                              </div>
                              {msg.attachments && msg.attachments.length > 0 && (
                                <div className="flex justify-end gap-1 mt-1">
                                  {msg.attachments.map((att, i) => (
                                    <span key={i} className="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-purple-500/10 text-purple-300/80 text-[9px]">
                                      {att.type === "element" && <MousePointer className="w-2.5 h-2.5" />}
                                      {att.type === "image" && <ImageIcon className="w-2.5 h-2.5" />}
                                      {att.label}
                                    </span>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </motion.div>
                      ))
                    )}
                    
                    {/* AI Response Indicator - Clean and minimal */}
                    {isEditing && (
                      <motion.div 
                        initial={{ opacity: 0 }} 
                        animate={{ opacity: 1 }}
                        transition={{ duration: 0.2 }}
                        className="rounded-lg border border-zinc-700 bg-[#111111] overflow-hidden"
                      >
                        {/* Status */}
                        <div className="flex items-center justify-between px-3 py-2">
                          <div className="flex items-center gap-2">
                            <Loader2 className="w-3 h-3 text-zinc-300 animate-spin" />
                            <span className="text-xs text-zinc-400">{streamingStatus || "Thinking..."}</span>
                          </div>
                          <button
                            onClick={() => { cancelAIRequest(); setIsEditing(false); showToast("Cancelled", "info"); }}
                            className="p-1 rounded hover:bg-white/10 text-zinc-600 hover:text-zinc-500"
                          >
                            <X className="w-3 h-3" />
                          </button>
                        </div>
                        
                        {/* Code preview - only when writing code - with syntax highlighting */}
                        {streamingCode && streamingCode.length > 50 && (
                          <motion.div 
                            initial={{ height: 0, opacity: 0 }}
                            animate={{ height: 'auto', opacity: 1 }}
                            transition={{ duration: 0.3 }}
                            className="border-t border-zinc-800 bg-[#111111]"
                          >
                            <div className="p-2 max-h-[120px] overflow-hidden font-mono text-[9px] leading-relaxed">
                              <pre className="m-0 whitespace-pre-wrap break-words">
                                {streamingCode.slice(-800).split('\n').slice(-8).map((line, i) => (
                                  <div key={i} className="min-h-[12px]">
                                    {line.split(/(<[^>]+>|"[^"]*"|'[^']*'|\/\*.*\*\/|\/\/.*$|{|}|\(|\)|class=|className=|style=|\b(?:const|let|var|function|return|if|else|for|while|import|export|from|default)\b)/g).map((part, j) => {
                                      if (!part) return null;
                                      if (part.startsWith('<') && part.endsWith('>')) return <span key={j} className="text-[#7fdbca]">{part}</span>;
                                      if (part.startsWith('"') || part.startsWith("'")) return <span key={j} className="text-[#ecc48d]">{part}</span>;
                                      if (part.startsWith('//') || part.startsWith('/*')) return <span key={j} className="text-[#637777]">{part}</span>;
                                      if (/^(const|let|var|function|return|if|else|for|while|import|export|from|default)$/.test(part)) return <span key={j} className="text-[#c792ea]">{part}</span>;
                                      if (part === 'class=' || part === 'className=' || part === 'style=') return <span key={j} className="text-[#addb67]">{part}</span>;
                                      if (part === '{' || part === '}' || part === '(' || part === ')') return <span key={j} className="text-[#ffd700]">{part}</span>;
                                      return <span key={j} className="text-[#d6deeb]">{part}</span>;
                                    })}
                                  </div>
                                ))}
                                <span className="text-zinc-300">▌</span>
                              </pre>
                            </div>
                            <div className="px-2 pb-1.5 text-[9px] text-zinc-600 font-mono">
                              {streamingLines} lines written
                            </div>
                          </motion.div>
                        )}
                      </motion.div>
                    )}
                  </div>
                  
                  {/* Input Area - Minimal */}
                  <div className="flex-shrink-0 p-2 border-t border-zinc-800">
                    <div className="rounded-xl bg-zinc-800/50 border border-white/[0.05] relative">
                      {/* Auth overlay - only for non-logged users (demo mode can see but not use) */}
                      {!user && (
                        <div 
                          onClick={() => {
                            setShowAuthModal(true);
                            showToast("Sign up free to edit with AI. Get 1 free generation!", "info");
                          }}
                          className="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-zinc-900 backdrop-blur-[2px] rounded-xl"
                        >
                          <div className="flex items-center gap-2 text-zinc-500 text-xs">
                            <Lock className="w-3.5 h-3.5" />
                            <span>Sign up to edit with AI</span>
                          </div>
                        </div>
                      )}
                      {/* Pro feature overlay for demo mode (logged in but viewing demo) */}
                      {user && isDemoMode && (
                        <div 
                          onClick={() => {
                            setUpgradeFeature("code");
                            setShowUpgradeModal(true);
                          }}
                          className="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-zinc-900/80 backdrop-blur-[2px] rounded-xl"
                        >
                          <div className="flex items-center gap-2 text-zinc-400 text-xs">
                            <Sparkles className="w-3.5 h-3.5 text-[#FF6E3C]" />
                            <span>AI Edit is a Pro feature</span>
                          </div>
                        </div>
                      )}
                      <textarea
                        value={chatInput}
                        onChange={(e) => setChatInput(e.target.value)}
                        disabled={!user}
                        onPaste={handlePasteImage}
                        onKeyDown={async (e) => {
                          if (e.key === "Enter" && !e.shiftKey && chatInput.trim() && editableCode) {
                            e.preventDefault();
                            // Demo mode: AI Edit is Pro feature
                            if (isDemoMode) {
                              setUpgradeFeature("code");
                              setShowUpgradeModal(true);
                              return;
                            }
                            // Auth check - only block non-logged users
                            if (!user) {
                              setShowAuthModal(true);
                              showToast("Sign up free to edit with AI. Get 1 free generation!", "info");
                              return;
                            }
                            const userMsg: ChatMessage = { id: generateId(), role: "user", content: chatInput, timestamp: Date.now(), attachments: selectedElement ? [{ type: "element", label: selectedElement }] : editImages.length > 0 ? editImages.map(img => ({ type: "image" as const, label: img.name })) : undefined };
                            setChatMessages(prev => [...prev, userMsg]);
                            const currentInput = chatInput;
                            const currentSelectedElement = selectedElement;
                            const currentPlanMode = isPlanMode;
                            const currentChatHistory = chatMessages.slice(-10).map(m => ({ role: m.role, content: m.content }));
                            setChatInput(""); setSelectedElement(null); setIsEditing(true); setStreamingStatus("Analyzing..."); setStreamingCode(''); setStreamingLines(0);
                            try {
                              if (currentPlanMode) {
                                // PLAN MODE: Conversational response without code editing with streaming
                                const result = await editCodeWithAIStreaming(
                                  editableCode, currentInput, undefined, undefined, true, undefined,
                                  (event) => {
                                    if (event.type === 'status') setStreamingStatus(event.message || null);
                                    else if (event.type === 'chunk' && event.fullText) {
                                      // Update streaming text in real-time (optional for plan mode)
                                    }
                                  }
                                );
                                const response = result?.code || "I can help you plan that! What would you like to discuss?";
                                setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: response, timestamp: Date.now() }]);
                              } else {
                                // EXECUTE MODE: Make actual changes with streaming status
                                // Convert images to base64 for API
                                let imageData: { base64?: string; url?: string; mimeType: string; name: string }[] | undefined;
                                if (editImages.length > 0) {
                                  setStreamingStatus("Processing images...");
                                  imageData = [];
                                  for (const img of editImages) {
                                    const base64 = await urlToBase64(img.url);
                                    if (base64) {
                                      imageData.push({ base64, mimeType: 'image/png', name: img.name, url: img.url });
                                    }
                                  }
                                  if (imageData.length === 0) imageData = undefined;
                                }
                                const prompt = currentSelectedElement 
                                  ? `IMPORTANT: Only modify the specific element that matches this selector/description: "${currentSelectedElement}". Do NOT change any other elements. User request: ${currentInput}`
                                  : currentInput;
                                
                                // Use streaming API with status updates and code preview
                                let currentStreamCode = '';
                                let lastUIUpdate = 0;
                                const result = await editCodeWithAIStreaming(
                                  editableCode, prompt, imageData, undefined, false, currentChatHistory,
                                  (event) => {
                                    if (event.type === 'status') {
                                      setStreamingStatus(event.message || null);
                                      if (event.phase === 'writing') {
                                        currentStreamCode = '';
                                        setStreamingCode('');
                                        setStreamingLines(0);
                                      }
                                    } else if (event.type === 'progress') {
                                      setStreamingLines(event.lines || 0);
                                      if (event.preview) {
                                        setStreamingCode(event.preview);
                                      }
                                    } else if (event.type === 'chunk' && event.text) {
                                      // Batch UI updates every 100ms for smooth rendering
                                      currentStreamCode += event.text;
                                      const now = Date.now();
                                      if (now - lastUIUpdate > 100) {
                                        lastUIUpdate = now;
                                        setStreamingCode(currentStreamCode);
                                        setStreamingLines(currentStreamCode.split('\n').length);
                                      }
                                    }
                                  }
                                );
                                
                                if (result && result.success && result.code) {
                                  // Check if AI returned a clarifying question or chat response instead of code
                                  const isChatResponse = (result as any).needsClarification || (result as any).isChat;
                                  // Also check if the "code" doesn't look like HTML at all
                                  const looksLikeHTML = result.code.includes('<!DOCTYPE') || result.code.includes('<html') || result.code.includes('<div') || result.code.includes('<body');
                                  
                                  if (isChatResponse || !looksLikeHTML) {
                                    // Show as chat message only - DON'T update the code
                                    setChatMessages(prev => [...prev, { 
                                      id: generateId(), 
                                      role: "assistant", 
                                      content: result.code || "What would you like me to change?", 
                                      timestamp: Date.now() 
                                    }]);
                                  } else {
                                    const codeChanged = result.code !== editableCode;
                                    
                                    if (codeChanged) {
                                      setEditableCode(result.code); setDisplayedCode(result.code); setGeneratedCode(result.code);
                                      setPreviewUrl(createPreviewUrl(result.code));
                                      
                                      // Use summary from streaming if available, otherwise analyze
                                      const responseMsg = result.summary 
                                        ? `**Zmiany wprowadzone:**\n\n${result.summary}\n\n**Preview zaktualizowany** - sprawdź rezultat!`
                                        : analyzeCodeChanges(editableCode, result.code, currentInput);
                                      
                                      setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: responseMsg, timestamp: Date.now() }]);
                                      if (activeGeneration) {
                                        const versionLabel = generateVersionLabel(currentInput);
                                        const updatedGen = { ...activeGeneration, code: result.code, versions: [...(activeGeneration.versions || []), { id: generateId(), timestamp: Date.now(), label: versionLabel, code: result.code, flowNodes, flowEdges, styleInfo }] };
                                        setActiveGeneration(updatedGen); 
                                        setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
                                        saveGenerationToSupabase(updatedGen);
                                      }
                                    } else {
                                      setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `No changes detected. The AI returned the same code. Try being more specific about what you want to change.`, timestamp: Date.now() }]);
                                    }
                                  }
                                } else if (!result?.cancelled) { setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `Error: ${result?.error || "Something went wrong. Please try again with a different request."}`, timestamp: Date.now() }]); }
                              }
                            } catch (error) { 
                              if (!(error instanceof Error && error.name === 'AbortError')) {
                                setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `Error: ${error instanceof Error ? error.message : "Unknown error occurred"}`, timestamp: Date.now() }]); 
                              }
                            }
                            finally { setIsEditing(false); setStreamingStatus(null); setStreamingCode(null); setStreamingLines(0); setEditImages([]); setIsPointAndEdit(false); }
                          }
                        }}
                        placeholder={isPlanMode ? "Plan and discuss changes..." : "Ask Replay to edit..."}
                        rows={1}
                        className="w-full px-3 py-2.5 bg-transparent text-[11px] text-zinc-200 placeholder:text-white/25 resize-none focus:outline-none min-h-[36px]"
                      />
                      
                      {/* Attachments preview */}
                      {(editImages.length > 0 || selectedElement) && (
                        <div className="px-3 pb-2 flex gap-1.5 flex-wrap">
                          {editImages.map((img) => (
                            <div key={img.id} className="relative group">
                              <img src={img.url} alt="" className={cn("w-8 h-8 rounded object-cover border border-zinc-700", img.uploading && "opacity-50")} />
                              {img.uploading && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                  <Loader2 className="w-3 h-3 text-white animate-spin" />
                                </div>
                              )}
                              <button onClick={() => setEditImages(prev => prev.filter(i => i.id !== img.id))} className="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-500/80 text-white flex items-center justify-center opacity-0 group-hover:opacity-100"><X className="w-2 h-2" /></button>
                            </div>
                          ))}
                          {selectedElement && (
                            <span className="flex items-center gap-1 px-2 py-0.5 rounded bg-zinc-800/10 text-zinc-300/80 text-[9px] border border-zinc-700">
                              <MousePointer className="w-2.5 h-2.5" />{selectedElement}
                              <button onClick={() => { setSelectedElement(null); setIsPointAndEdit(false); }}><X className="w-2 h-2" /></button>
                            </span>
                          )}
                        </div>
                      )}
                      
                      {/* Tools */}
                      <div className="px-2 py-1.5 border-t border-white/[0.03] flex items-center justify-between">
                        <div className="flex items-center gap-1">
                          {/* Pointer Select - same as Edit with AI */}
                          <button 
                            onClick={() => {
                              const newState = !isPointAndEdit;
                              setIsPointAndEdit(newState);
                              setIsSelectingElement(newState);
                              if (!newState) setSelectedElement(null);
                            }} 
                            className={cn(
                              "relative flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-[10px] transition-all",
                              isPointAndEdit 
                                ? "bg-zinc-800/20 text-zinc-300 border border-zinc-700" 
                                : "text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50"
                            )}
                          >
                            <MousePointer className={cn("w-3.5 h-3.5", isPointAndEdit && "animate-pulse")} />
                            <span>Select</span>
                            {isPointAndEdit && <span className="absolute -top-0.5 -right-0.5 w-1.5 h-1.5 bg-zinc-800 rounded-full" />}
                          </button>
                          {/* Image upload - uploads to Supabase */}
                          <label className="flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-[10px] text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50 cursor-pointer transition-all">
                            <ImageIcon className="w-3.5 h-3.5" />
                            <span>Image</span>
                            <input type="file" accept="image/*" multiple className="hidden" onChange={async (e) => {
                              if (!e.target.files) return;
                              for (const file of Array.from(e.target.files)) {
                                const id = generateId();
                                const localUrl = URL.createObjectURL(file);
                                setEditImages(prev => [...prev, { id, url: localUrl, name: file.name, file, uploading: true }]);
                                showToast("Wgrywanie zdjęcia...", "info");
                                try {
                                  const formData = new FormData();
                                  formData.append("file", file);
                                  formData.append("userId", user?.id || "anon");
                                  const response = await fetch("/api/upload-image", { method: "POST", body: formData });
                                  const data = await response.json();
                                  if (data.success && data.url) {
                                    URL.revokeObjectURL(localUrl);
                                    setEditImages(prev => prev.map(img => img.id === id ? { ...img, url: data.url, uploading: false } : img));
                                    showToast("Zdjęcie gotowe!", "success");
                                  } else {
                                    setEditImages(prev => prev.filter(img => img.id !== id));
                                    showToast("Nie udało się wgrać", "error");
                                  }
                                } catch (err) {
                                  setEditImages(prev => prev.filter(img => img.id !== id));
                                  showToast("Błąd wgrywania", "error");
                                }
                              }
                              e.target.value = "";
                            }} />
                          </label>
                        </div>
                        {/* Plan + Send grouped on right */}
                        <div className="flex items-center gap-1.5">
                          {/* Plan Mode Toggle */}
                          <button
                            onClick={() => setIsPlanMode(!isPlanMode)}
                            className={cn(
                              "flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-[10px] font-medium transition-all",
                              isPlanMode 
                                ? "bg-violet-500/20 text-violet-300 border border-violet-500/30" 
                                : "text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50"
                            )}
                            title={isPlanMode ? "Plan mode ON - discussing without executing" : "Plan mode OFF - will execute changes"}
                          >
                            <MessageSquare className="w-3 h-3" />
                            Plan
                          </button>
                        <button 
                          onClick={async () => {
                            if (!chatInput.trim() || !editableCode || isEditing) return;
                            const userMsg: ChatMessage = { id: generateId(), role: "user", content: chatInput, timestamp: Date.now(), attachments: selectedElement ? [{ type: "element", label: selectedElement }] : editImages.length > 0 ? editImages.map(img => ({ type: "image" as const, label: img.name })) : undefined };
                            setChatMessages(prev => [...prev, userMsg]);
                            const currentInput = chatInput;
                            const currentSelectedElement = selectedElement;
                            const currentPlanMode = isPlanMode;
                            const currentChatHistory = chatMessages.slice(-10).map(m => ({ role: m.role, content: m.content }));
                            setChatInput(""); setSelectedElement(null); setIsEditing(true);
                            try {
                              if (currentPlanMode) {
                                // PLAN MODE: Conversational response without code editing
                                const result = await editCodeWithAI(editableCode, currentInput, undefined, undefined, true, undefined);
                                const response = result?.code || "I can help you plan that! What would you like to discuss?";
                                setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: response, timestamp: Date.now() }]);
                              } else {
                                // EXECUTE MODE: Make actual changes with chat history context
                                // Convert images to base64 for API (button click handler)
                                let imageData: { base64?: string; url?: string; mimeType: string; name: string }[] | undefined;
                                if (editImages.length > 0) {
                                  imageData = [];
                                  for (const img of editImages) {
                                    const base64 = await urlToBase64(img.url);
                                    if (base64) {
                                      imageData.push({ base64, mimeType: 'image/png', name: img.name, url: img.url });
                                    }
                                  }
                                  if (imageData.length === 0) imageData = undefined;
                                }
                                const prompt = currentSelectedElement 
                                  ? `IMPORTANT: Only modify the specific element that matches this selector/description: "${currentSelectedElement}". Do NOT change any other elements. User request: ${currentInput}`
                                  : currentInput;
                                const result = await editCodeWithAI(editableCode, prompt, imageData, undefined, false, currentChatHistory);
                                if (result && result.success && result.code) {
                                  const codeChanged = result.code !== editableCode;
                                  
                                  if (codeChanged) {
                                    setEditableCode(result.code); setDisplayedCode(result.code); setGeneratedCode(result.code);
                                    setPreviewUrl(createPreviewUrl(result.code));
                                    
                                    const responseMsg = analyzeCodeChanges(editableCode, result.code, currentInput);
                                    
                                    setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: responseMsg, timestamp: Date.now() }]);
                                    if (activeGeneration) {
                                      const updatedGen = { ...activeGeneration, code: result.code, versions: [...(activeGeneration.versions || []), { id: generateId(), timestamp: Date.now(), label: generateVersionLabel(currentInput), code: result.code, flowNodes, flowEdges, styleInfo }] };
                                      setActiveGeneration(updatedGen); 
                                      setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
                                      saveGenerationToSupabase(updatedGen);
                                    }
                                  } else {
                                    setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `No changes detected. The AI returned the same code. Try being more specific about what you want to change.`, timestamp: Date.now() }]);
                                  }
                                } else if (!result?.cancelled) { setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `Error: ${result?.error || "Something went wrong. Please try again with a different request."}`, timestamp: Date.now() }]); }
                              }
                            } catch (error) { 
                              if (!(error instanceof Error && error.name === 'AbortError')) {
                                setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: `Error: ${error instanceof Error ? error.message : "Unknown error occurred"}`, timestamp: Date.now() }]); 
                              }
                            }
                            finally { setIsEditing(false); setEditImages([]); setIsPointAndEdit(false); }
                          }}
                          disabled={!chatInput.trim() || isEditing}
                          className={cn("p-1.5 rounded-lg transition-all", chatInput.trim() && !isEditing ? "bg-white text-black" : "bg-zinc-800/50 text-zinc-600")}
                        >
                          {isEditing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-3.5 h-3.5" />}
                        </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                /* TAB: Input - Video & Style Configuration */
                <div className="flex-1 overflow-y-auto custom-scrollbar" style={{ scrollbarWidth: 'thin', scrollbarColor: 'rgba(255,255,255,0.08) transparent' }}>
                  
                  {/* Upload Section - Primary */}
                  <div className="p-4 border-b border-white/[0.06]">
                    {/* Header with INPUT label and action buttons */}
                    <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center justify-between">
                      <span className="flex items-center gap-2">
                        <Video className="w-3.5 h-3.5" /> INPUT
                        {/* Info tooltip */}
                        <div className="relative group/inputtip">
                          <Info className="w-3 h-3 text-white/30 hover:text-white/50 cursor-help transition-colors" />
                          <div className="fixed ml-2 left-auto w-56 p-3 rounded-lg bg-zinc-900 border border-zinc-700 shadow-2xl opacity-0 invisible group-hover/inputtip:opacity-100 group-hover/inputtip:visible transition-all z-[9999] pointer-events-none" style={{ transform: 'translateY(-50%)' }}>
                            <div className="flex items-start gap-2.5 mb-2.5 pb-2.5 border-b border-white/[0.06]">
                              <Video className="w-4 h-4 text-[var(--accent-orange)] flex-shrink-0 mt-0.5" />
                              <div>
                                <p className="text-[11px] text-white font-medium mb-0.5">Video input</p>
                                <p className="text-[10px] text-white/50">Reconstruct UI, motion & behavior.</p>
                              </div>
                            </div>
                            <div className="flex items-start gap-2.5">
                              <ImageIcon className="w-4 h-4 text-[var(--accent-orange)] flex-shrink-0 mt-0.5" />
                              <div>
                                <p className="text-[11px] text-white font-medium mb-0.5">Image input</p>
                                <p className="text-[10px] text-white/50">Reconstruct UI, structure & tokens.</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </span>
                      {/* Compact action buttons */}
                      <div className="flex items-center gap-1">
                        <button 
                          onClick={startRecording}
                          className="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-700/50 border border-white/[0.08] hover:bg-zinc-700/70 hover:border-white/[0.15] transition-all text-white/60 hover:text-white/80 text-[10px] font-medium normal-case"
                        >
                          <div className="w-1.5 h-1.5 rounded-full bg-white/40" />
                          Record
                        </button>
                        <button 
                          onClick={() => fileInputRef.current?.click()}
                          className="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-700/50 border border-white/[0.08] hover:bg-zinc-700/70 hover:border-white/[0.15] transition-all text-white/60 hover:text-white/80 text-[10px] font-medium normal-case"
                        >
                          <Upload className="w-3 h-3" />
                          Upload
                        </button>
                      </div>
                    </div>
                    {flows.length === 0 ? (
                      <>
                        {/* Upload Source drop area */}
                        <button 
                          onClick={() => fileInputRef.current?.click()}
                          onDragOver={handleDragOver}
                          onDragLeave={handleDragLeave}
                          onDrop={handleDrop}
                          className={cn(
                            "w-full flex flex-col items-center justify-center gap-1 px-3 py-4 rounded-lg transition-all cursor-pointer",
                            "bg-zinc-800/30 border border-dashed border-white/[0.08] hover:border-white/[0.15] hover:bg-zinc-800/50",
                            isDragging && "border-[var(--accent-orange)] bg-[var(--accent-orange)]/10 border-solid"
                          )}
                        >
                          <div className="flex items-center gap-2">
                            <Plus className={cn(
                              "w-4 h-4 transition-colors text-white/30",
                              isDragging && "text-[var(--accent-orange)]"
                            )} />
                            <span className={cn(
                              "text-[11px] text-white/40 font-medium",
                              isDragging && "text-[var(--accent-orange)]"
                            )}>
                              {isDragging ? "Drop here" : "Drop video or image to reconstruct"}
                            </span>
                          </div>
                          <span className="text-[9px] text-white/25">
                            or click to browse
                          </span>
                        </button>
                      </>
                    ) : (
                      <>
                        {/* Input List - Videos & Images */}
                        <div className="space-y-2">
                          {flows.map((flow) => (
                            <div key={flow.id} className={cn("w-full flex items-center gap-3 p-2.5 rounded-lg cursor-pointer text-left transition-all", selectedFlowId === flow.id ? "bg-zinc-800/70 border border-white/[0.12]" : "bg-zinc-800/50 border border-transparent hover:bg-zinc-800/60 hover:border-white/[0.06]")}>
                              {/* Thumbnail - clickable to preview (video or image) */}
                              <button 
                                onClick={() => {
                                  if (flow.isImage && flow.videoUrl) {
                                    // For images, open in new tab or show inline
                                    window.open(flow.videoUrl, '_blank');
                                  } else if (flow.videoUrl) {
                                    setVideoPreviewModal({ open: true, url: flow.videoUrl, name: flow.name });
                                  }
                                }}
                                className="w-12 h-8 rounded overflow-hidden bg-zinc-900 flex-shrink-0 relative group"
                                title={flow.isImage ? "Click to view image" : "Click to preview video"}
                              >
                                {flow.thumbnail && flow.thumbnail.length > 100 ? (
                                  <>
                                    <img src={flow.thumbnail} alt="" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                      {flow.isImage ? (
                                        <ImageIcon className="w-4 h-4 text-white" />
                                      ) : (
                                        <Play className="w-4 h-4 text-white" />
                                      )}
                                    </div>
                                  </>
                                ) : flow.videoUrl && !flow.isImage ? (
                                  <>
                                    <video 
                                      src={flow.videoUrl} 
                                      className="w-full h-full object-cover" 
                                      muted 
                                      preload="metadata"
                                      onLoadedData={(e) => {
                                        const v = e.currentTarget;
                                        v.currentTime = Math.min(0.5, v.duration * 0.1);
                                      }}
                                    />
                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                      <Play className="w-4 h-4 text-white" />
                                    </div>
                                  </>
                                ) : (
                                  flow.isImage ? (
                                    <ImageIcon className="w-4 h-4 text-white/20 mx-auto mt-2" />
                                  ) : (
                                    <Film className="w-4 h-4 text-white/20 mx-auto mt-2" />
                                  )
                                )}
                              </button>
                              <button onClick={() => setSelectedFlowId(flow.id)} className="flex-1 min-w-0 text-left">
                                <p className="text-[13px] text-white/80 truncate">{flow.name}</p>
                                <p className="text-[11px] text-white/30">{flow.isImage ? 'Image' : formatDuration(flow.duration)}</p>
                              </button>
                              <span onClick={(e) => { e.stopPropagation(); setFlows(prev => prev.filter(f => f.id !== flow.id)); }} className="p-1.5 text-white/20 hover:text-red-400 hover:bg-zinc-700/50 rounded transition-colors" role="button" tabIndex={0} aria-label="Remove flow" onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); setFlows(prev => prev.filter(f => f.id !== flow.id)); }}}>
                                <Trash2 className="w-3.5 h-3.5" />
                              </span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                  
                  {/* Context Section */}
                  <div className="p-4 border-b border-white/[0.06]">
                    <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center justify-between">
                      <span className="flex items-center gap-2">
                        <Settings2 className="w-3.5 h-3.5" /> CONTEXT
                      </span>
                      <span className="text-[10px] text-white/25 bg-zinc-800/50 px-2 py-0.5 rounded normal-case font-normal">Optional</span>
                    </div>
                    <textarea
                      value={refinements}
                      onChange={(e) => setRefinements(e.target.value)}
                      placeholder="Add data logic, constraints or details..."
                      rows={3}
                      className="w-full px-3 py-3 rounded-xl text-xs text-zinc-300 bg-zinc-800/80 border border-zinc-700/50 placeholder:text-zinc-600 focus:outline-none focus:border-zinc-600 min-h-[80px] resize-y"
                    />
                  </div>
                  
                  {/* Style Section */}
                  <div className="p-4 border-b border-white/[0.06]">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider flex items-center gap-2">
                        <Palette className="w-3.5 h-3.5" /> STYLE
                      </span>
                    </div>
                    <StyleInjector 
                      value={styleDirective} 
                      onChange={setStyleDirective} 
                      disabled={isProcessing}
                      referenceImage={styleReferenceImage}
                      onReferenceImageChange={setStyleReferenceImage}
                      importedStyles={importedStylesList}
                      onImportClick={() => setShowImportLibraryModal(true)}
                      onDeleteDS={handleDeleteDS}
                    />
                  </div>
                  
                  {/* Generate Button */}
                  <div className="p-4 border-b border-white/[0.06]">
                    <ShimmerButton 
                      onClick={handleGenerate}
                      disabled={isProcessing || flows.length === 0}
                      shimmerColor="#ffffff"
                      shimmerDuration="2s"
                      background="#111111"
                      borderRadius="9999px"
                      className="w-full py-3.5 text-[13px] font-semibold disabled:opacity-50"
                    >
                      <LogoIcon className="w-4 h-4 mr-2" color="white" />
                      <span className="text-white font-semibold">Reconstruct</span>
                    </ShimmerButton>
                  </div>
                  
                  {/* Database Section */}
                  <div className="p-4 border-b border-white/[0.06]">
                    <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center justify-between">
                      <span className="flex items-center gap-2">
                        <Database className="w-3.5 h-3.5" /> DATABASE
                      </span>
                      <span className="text-[10px] text-white/25 bg-zinc-800/50 px-2 py-0.5 rounded normal-case font-normal">Optional</span>
                    </div>
                    <button 
                      onClick={() => {
                        // Require login for Supabase connection
                        if (!user || isDemoMode) {
                          setShowAuthModal(true);
                          showToast("Sign up free to connect Supabase. Get 1 free generation!", "info");
                          return;
                        }
                        // Require paid plan for Supabase
                        if (!isPaidPlan) {
                          showToast("Supabase integration is a Pro feature. Upgrade to connect your database!", "info");
                          return;
                        }
                        setShowProjectSettings(true);
                      }}
                      className={cn(
                        "w-full px-3 py-2 rounded-lg text-xs flex items-center justify-center gap-2 transition-colors bg-zinc-800/60 border border-zinc-700/50 hover:bg-zinc-700/60 text-zinc-300",
                        (!user || isDemoMode || !isPaidPlan) && "opacity-50 cursor-not-allowed"
                      )}
                      title={!user || isDemoMode ? "Sign up to use Supabase integration" : !isPaidPlan ? "Pro feature - Upgrade to connect" : "Connect Supabase to fetch real data"}
                    >
                      <Database className="w-3.5 h-3.5 text-zinc-400 group-hover:text-[#3ECF8E]" />
                      <span className="text-zinc-300">Wire to Supabase</span>
                      {(!user || isDemoMode || !isPaidPlan) && <Lock className="w-3 h-3 text-white/30" />}
                    </button>
                    <p className="text-[10px] text-white/25 mt-2 text-center">
                      {!user || isDemoMode ? "Sign up to connect database" : !isPaidPlan ? "Pro feature" : "Connect your database to wire real data"}
                    </p>
                  </div>
                  
                  {/* Colors Preview */}
                  {styleInfo && styleInfo.colors.length > 0 && (
                    <div className="p-3">
                      <span className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider block mb-2">Current Colors</span>
                      <div className="flex gap-1 flex-wrap">
                        {styleInfo.colors.slice(0, 6).map((c, i) => (
                          <div key={i} className="w-6 h-6 rounded border border-zinc-700" style={{ background: c.value }} title={c.value} />
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          ) : !sidebarCollapsed && sidebarView === "detail" ? (
            /* CONFIG MODE - Before Generation - Same style as Input tab */
            <div className="flex-1 overflow-y-auto custom-scrollbar" style={{ scrollbarWidth: 'thin', scrollbarColor: 'rgba(255,255,255,0.08) transparent' }}>
              
              {/* Input Section - Same as Input tab */}
              <div className="p-4 border-b border-white/[0.06]">
                {/* Header with INPUT label and action buttons */}
                <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center justify-between">
                  <span className="flex items-center gap-2">
                    <Video className="w-3.5 h-3.5" /> INPUT
                    {/* Info tooltip */}
                    <div className="relative group/inputtip2">
                      <Info className="w-3 h-3 text-white/30 hover:text-white/50 cursor-help transition-colors" />
                      <div className="fixed ml-2 left-auto w-56 p-3 rounded-lg bg-zinc-900 border border-zinc-700 shadow-2xl opacity-0 invisible group-hover/inputtip2:opacity-100 group-hover/inputtip2:visible transition-all z-[9999] pointer-events-none" style={{ transform: 'translateY(-50%)' }}>
                        <div className="flex items-start gap-2.5 mb-2.5 pb-2.5 border-b border-white/[0.06]">
                          <Video className="w-4 h-4 text-[var(--accent-orange)] flex-shrink-0 mt-0.5" />
                          <div>
                            <p className="text-[11px] text-white font-medium mb-0.5">Video input</p>
                            <p className="text-[10px] text-white/50">Reconstruct UI, motion & behavior.</p>
                          </div>
                        </div>
                        <div className="flex items-start gap-2.5">
                          <ImageIcon className="w-4 h-4 text-[var(--accent-orange)] flex-shrink-0 mt-0.5" />
                          <div>
                            <p className="text-[11px] text-white font-medium mb-0.5">Image input</p>
                            <p className="text-[10px] text-white/50">Reconstruct UI, structure & tokens.</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </span>
                  {/* Compact action buttons */}
                  <div className="flex items-center gap-1">
                    {isRecording ? (
                      <button onClick={stopRecording} className="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] font-medium normal-case">
                        <Square className="w-2.5 h-2.5 fill-red-500" />{formatDuration(recordingDuration)}
                      </button>
                    ) : (
                      <button 
                        onClick={startRecording}
                        className="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-700/50 border border-white/[0.08] hover:bg-zinc-700/70 hover:border-white/[0.15] transition-all text-white/60 hover:text-white/80 text-[10px] font-medium normal-case"
                      >
                        <div className="w-1.5 h-1.5 rounded-full bg-white/40" />
                        Record
                      </button>
                    )}
                    <button 
                      onClick={() => fileInputRef.current?.click()}
                      className="flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-700/50 border border-white/[0.08] hover:bg-zinc-700/70 hover:border-white/[0.15] transition-all text-white/60 hover:text-white/80 text-[10px] font-medium normal-case"
                    >
                      <Upload className="w-3 h-3" />
                      Upload
                    </button>
                  </div>
                </div>
                {flows.length === 0 ? (
                  <>
                    {/* Upload Source drop area */}
                    <button 
                      onClick={() => fileInputRef.current?.click()}
                      onDragOver={handleDragOver}
                      onDragLeave={handleDragLeave}
                      onDrop={handleDrop}
                      className={cn(
                        "w-full flex flex-col items-center justify-center gap-1 px-3 py-4 rounded-lg transition-all cursor-pointer",
                        "bg-zinc-800/30 border border-dashed border-white/[0.08] hover:border-white/[0.15] hover:bg-zinc-800/50",
                        isDragging && "border-[var(--accent-orange)] bg-[var(--accent-orange)]/10 border-solid"
                      )}
                    >
                      <div className="flex items-center gap-2">
                        <Plus className={cn(
                          "w-4 h-4 transition-colors text-white/30",
                          isDragging && "text-[var(--accent-orange)]"
                        )} />
                        <span className={cn(
                          "text-[11px] text-white/40 font-medium",
                          isDragging && "text-[var(--accent-orange)]"
                        )}>
                          {isDragging ? "Drop here" : "Drop video or image to reconstruct"}
                        </span>
                      </div>
                      <span className="text-[9px] text-white/25">
                        or click to browse
                      </span>
                    </button>
                  </>
                ) : (
                  <div className="space-y-1.5">
                    {flows.map((flow) => (
                      <button key={flow.id} onClick={() => setSelectedFlowId(flow.id)} className={cn("flow-item w-full flex items-center gap-2.5 p-2 cursor-pointer group text-left rounded-lg", selectedFlowId === flow.id ? "bg-white/[0.03] border border-white/[0.08]" : "hover:bg-white/[0.02]")} aria-label={`Select flow ${flow.name}`}>
                        <div className="w-12 h-7 rounded overflow-hidden bg-zinc-800/50 flex-shrink-0 flex items-center justify-center">
                          {flow.thumbnail && flow.thumbnail.length > 100 ? (
                            <img src={flow.thumbnail} alt="" className="w-full h-full object-cover" />
                          ) : flow.videoUrl ? (
                            <video src={flow.videoUrl} className="w-full h-full object-cover" muted preload="metadata" onLoadedData={(e) => { e.currentTarget.currentTime = 0.5; }} />
                          ) : (
                            <Film className="w-3 h-3 text-white/20" />
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-[11px] font-medium text-white/70 truncate">{flow.name}</p>
                          <p className="text-[10px] text-white/30">
                            {formatDuration(flow.trimEnd - flow.trimStart)}
                          </p>
                        </div>
                        <span onClick={(e) => { e.stopPropagation(); removeFlow(flow.id); }} className="p-1 opacity-0 group-hover:opacity-100 hover:bg-white/10 rounded" role="button" tabIndex={0} aria-label="Remove flow" onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); removeFlow(flow.id); }}}><Trash2 className="w-3 h-3 text-white/30" /></span>
                      </button>
                    ))}
                    
                    {/* Add more videos button */}
                    <button 
                      onClick={() => fileInputRef.current?.click()}
                      onDragOver={handleDragOver}
                      onDragLeave={handleDragLeave}
                      onDrop={handleDrop}
                      className={cn(
                        "w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg transition-all cursor-pointer",
                        "bg-zinc-800/30 border border-dashed border-white/[0.08] hover:border-white/[0.15] hover:bg-zinc-800/50",
                        isDragging && "border-[var(--accent-orange)] bg-[var(--accent-orange)]/10 border-solid"
                      )}
                    >
                      <Plus className="w-3 h-3 text-white/30" />
                      <span className="text-[10px] text-white/40">Add</span>
                    </button>
                  </div>
                )}
              </div>
              
              {/* CONTEXT Section - Same style as Input tab */}
              <div className="p-4 border-b border-white/[0.06]">
                <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <Settings2 className="w-3.5 h-3.5" /> CONTEXT
                  <span className="text-[10px] text-white/25 bg-zinc-800/50 px-2 py-0.5 rounded normal-case font-normal ml-auto">Optional</span>
                </div>
                
                {/* Textarea only */}
                <textarea
                  value={refinements}
                  onChange={(e) => {
                    const maxLen = isPaidPlan ? 20000 : 2000;
                    if (e.target.value.length <= maxLen) {
                      setRefinements(e.target.value);
                    } else {
                      showToast(`Context limit: ${isPaidPlan ? "20,000" : "2,000"} characters${!isPaidPlan ? ". Upgrade to PRO for 20k" : ""}`, "error");
                    }
                  }}
                  placeholder="Add data logic, constraints or details. Replay works without it — context just sharpens the result (optional)"
                  disabled={isProcessing}
                  rows={3}
                  className={cn(
                    "w-full px-2.5 py-2 text-[11px] text-white/70 placeholder:text-white/25 bg-white/[0.02] border border-white/[0.05] rounded-lg resize-y focus:outline-none focus:border-white/10 transition-colors min-h-[80px] max-h-[300px]",
                    isProcessing && "opacity-50 cursor-not-allowed"
                  )}
                />
              </div>

              {/* STYLE Section */}
              <div className="p-4 border-b border-white/[0.06]">
                <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <Palette className="w-3.5 h-3.5" /> STYLE
                </div>
                
                <StyleInjector 
                  value={styleDirective} 
                  onChange={setStyleDirective} 
                  disabled={isProcessing}
                  referenceImage={styleReferenceImage}
                  onReferenceImageChange={setStyleReferenceImage}
                  importedStyles={importedStylesList}
                  onImportClick={() => setShowImportLibraryModal(true)}
                  onDeleteDS={handleDeleteDS}
                />
              </div>

              {/* Generate Button */}
              <div className="p-4 border-b border-white/[0.06]">
                {(() => {
                  // Determine if we're in update mode (existing project + changed context)
                  const hasProject = activeGeneration && generatedCode && generationComplete;
                  const hasContextChange = refinements.trim() !== (activeGeneration?.refinements || "").trim();
                  const hasStyleChange = styleDirective.trim() !== (activeGeneration?.styleDirective || "").trim();
                  const isUpdateMode = hasProject && (hasContextChange || hasStyleChange) && refinements.trim();
                  
                  return (
                    <ShimmerButton 
                      onClick={handleGenerate}
                      disabled={isProcessing || isEditing || flows.length === 0}
                      shimmerColor="#ffffff"
                      shimmerDuration="2s"
                      background="#111111"
                      borderRadius="9999px"
                      className="w-full py-3.5 text-[13px] font-semibold disabled:opacity-50"
                    >
                      {isProcessing || isEditing ? (
                        <><Loader2 className="w-4 h-4 animate-spin mr-2" /><span className="text-white">{isEditing ? "Updating..." : "Reconstructing..."}</span></>
                      ) : (
                        <><LogoIcon className="w-4 h-4 mr-2" color="white" /><span className="text-white font-semibold">Reconstruct</span></>
                      )}
                    </ShimmerButton>
                  );
                })()}
              </div>

              {/* Database Section */}
              <div className="p-4 border-b border-white/[0.06]">
                <div className="sidebar-label text-[11px] font-semibold text-white/40 uppercase tracking-wider mb-3 flex items-center justify-between">
                  <span className="flex items-center gap-2">
                    <Database className="w-3.5 h-3.5" /> DATABASE
                  </span>
                  <span className="text-[10px] text-white/25 bg-zinc-800/50 px-2 py-0.5 rounded normal-case font-normal">Optional</span>
                </div>
                <button 
                  onClick={() => {
                    if (!user || isDemoMode) {
                      setShowAuthModal(true);
                      showToast("Sign up free to connect Supabase. Get 1 free generation!", "info");
                      return;
                    }
                    if (!isPaidPlan) {
                      showToast("Supabase integration is a Pro feature. Upgrade to connect your database!", "info");
                      return;
                    }
                    setShowProjectSettings(true);
                  }}
                  className={cn(
                    "w-full px-3 py-2 rounded-lg text-xs flex items-center justify-center gap-2 transition-colors bg-zinc-800/60 border border-zinc-700/50 hover:bg-zinc-700/60 text-zinc-300",
                    (!user || isDemoMode || !isPaidPlan) && "opacity-50 cursor-not-allowed"
                  )}
                  title={!user || isDemoMode ? "Sign up to use Supabase integration" : !isPaidPlan ? "Pro feature - Upgrade to connect" : "Connect Supabase to fetch real data"}
                >
                  <Database className="w-3.5 h-3.5 text-zinc-400 group-hover:text-[#3ECF8E]" />
                  <span className="text-zinc-300">Wire to Supabase</span>
                  {(!user || isDemoMode || !isPaidPlan) && <Lock className="w-3 h-3 text-white/30" />}
                </button>
                <p className="text-[10px] text-white/25 mt-2 text-center">
                  {!user || isDemoMode ? "Sign up to connect database" : !isPaidPlan ? "Pro feature" : "Connect your database to wire real data"}
                </p>
              </div>
              
              {/* Colors Preview */}
              {styleInfo && styleInfo.colors.length > 0 && (
                <div className="p-3">
                  <span className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider block mb-2">Current Colors</span>
                  <div className="flex gap-1 flex-wrap">
                    {styleInfo.colors.slice(0, 6).map((c, i) => (
                      <div key={i} className="w-6 h-6 rounded border border-zinc-700" style={{ background: c.value }} title={c.value} />
                    ))}
                  </div>
                </div>
              )}
              
              {/* Hidden Analysis Section */}
              <div className="hidden">
                <div ref={analysisRef}>
              {(isProcessing || isStreamingCode) && analysisPhase ? (
                <div className="space-y-4">
                  {/* UX SIGNALS - Technical analysis tags */}
                  <motion.div 
                    initial={{ opacity: 0, y: 10 }} 
                    animate={{ opacity: 1, y: 0 }} 
                    className="analysis-section"
                  >
                    <div className="flex items-center gap-2 mb-3">
                      <span className="text-[10px] font-semibold text-zinc-500 uppercase tracking-wider">UX Signals</span>
                      {analysisSection === "style" && <Loader2 className="w-3 h-3 animate-spin text-zinc-300/50 ml-auto" />}
                    </div>
                    <div className="space-y-2.5">
                      {/* Technical UX tags with Lucide icons */}
                      {analysisPhase.uxSignals && analysisPhase.uxSignals.length > 0 ? (
                        analysisPhase.uxSignals.map((signal, i) => (
                          <motion.div 
                            key={signal.label}
                            initial={{ opacity: 0, x: -10 }}
                            animate={{ opacity: 1, x: 0 }}
                            transition={{ delay: i * 0.08 }}
                            className="flex items-start gap-2.5"
                          >
                            {/* Lucide icon based on signal type */}
                            <div className={cn(
                              "w-5 h-5 rounded flex items-center justify-center flex-shrink-0",
                              signal.value.includes("...") ? "bg-zinc-800/50" : "bg-zinc-800/50"
                            )}>
                              {signal.type === "motion" && <RefreshCw className={cn("w-3 h-3", signal.value.includes("...") ? "text-zinc-600 animate-spin" : "text-cyan-400/70")} />}
                              {signal.type === "interaction" && <MousePointer className={cn("w-3 h-3", signal.value.includes("...") ? "text-zinc-600" : "text-zinc-300/70")} />}
                              {signal.type === "responsive" && <Smartphone className={cn("w-3 h-3", signal.value.includes("...") ? "text-zinc-600" : "text-green-400/70")} />}
                              {signal.type === "hierarchy" && <Layers className={cn("w-3 h-3", signal.value.includes("...") ? "text-zinc-600" : "text-purple-400/70")} />}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <span className="text-[10px] text-zinc-500">{signal.label}</span>
                                {signal.value.includes("...") ? (
                                  <span className="text-[10px] text-zinc-300/60 italic">{signal.value}</span>
                                ) : (
                                  <span className="text-[10px] px-1.5 py-0.5 rounded bg-zinc-800/50 text-zinc-200 font-medium border border-zinc-800">
                                    {signal.value}
                                  </span>
                                )}
                              </div>
                              {signal.tech && !signal.value.includes("...") && (
                                <code className="text-[9px] text-zinc-600 mt-0.5 block font-mono">{signal.tech}</code>
                              )}
                            </div>
                          </motion.div>
                        ))
                      ) : (
                        <div className="flex items-center gap-2 text-[10px] text-zinc-600">
                          <Loader2 className="w-3 h-3 animate-spin text-zinc-300/50" />
                          <span>Detecting patterns...</span>
                        </div>
                      )}
                    </div>
                  </motion.div>
                  
                  {/* STRUCTURE & COMPONENTS - Component Tree Hierarchy */}
                  <AnimatePresence>
                    {(analysisSection === "layout" || analysisSection === "components") && (
                      <motion.div 
                        initial={{ opacity: 0, y: 10 }} 
                        animate={{ opacity: 1, y: 0 }} 
                        exit={{ opacity: 0 }}
                        className="analysis-section"
                      >
                        <div className="flex items-center gap-2 mb-3">
                          <span className="text-[10px] font-semibold text-zinc-500 uppercase tracking-wider">Structure & Components</span>
                          {analysisSection === "layout" && <Loader2 className="w-3 h-3 animate-spin text-zinc-300/50 ml-auto" />}
                          {analysisSection === "components" && <Check className="w-3 h-3 text-green-500/50 ml-auto" />}
                        </div>
                        
                        {/* Component Tree - hierarchical view */}
                        <div className="space-y-1 font-mono">
                          {analysisPhase.componentTree && analysisPhase.componentTree.length > 0 ? (
                            analysisPhase.componentTree.map((node, i) => (
                              <motion.div 
                                key={node.name}
                                initial={{ opacity: 0, x: -10 }}
                                animate={{ opacity: 1, x: 0 }}
                                transition={{ delay: i * 0.08 }}
                                className="group"
                              >
                                <div className="flex items-center gap-1.5">
                                  {/* Tree structure indicator */}
                                  <span className="text-white/20 text-[10px]">
                                    {i === 0 ? "▼" : i === analysisPhase.componentTree!.length - 1 ? "└" : "├"}
                                  </span>
                                  
                                  {/* Status icon */}
                                  {node.status === "done" ? (
                                    <Check className="w-2.5 h-2.5 text-green-500/70 flex-shrink-0" />
                                  ) : node.status === "generating" ? (
                                    <Loader2 className="w-2.5 h-2.5 animate-spin text-zinc-300/70 flex-shrink-0" />
                                  ) : (
                                    <div className="w-2.5 h-2.5 rounded-full border border-zinc-700 flex-shrink-0" />
                                  )}
                                  
                                  {/* Component name */}
                                  <span className={cn(
                                    "text-[10px]", 
                                    node.status === "done" ? "text-zinc-400" : 
                                    node.status === "generating" ? "text-zinc-300/70" : "text-zinc-600"
                                  )}>
                                    {node.name}
                                  </span>
                                  
                                  {/* Type badge */}
                                  <span className={cn(
                                    "text-[8px] px-1 py-0.5 rounded",
                                    node.type === "Template" ? "bg-purple-500/20 text-purple-400/80" :
                                    node.type === "Organism" ? "bg-zinc-600/20 text-zinc-400" :
                                    node.type === "Molecule" ? "bg-green-500/20 text-green-400/80" :
                                    "bg-white/10 text-zinc-500"
                                  )}>
                                    {node.type}
                                  </span>
                                  
                                  {/* Database connection indicator */}
                                  {node.hasDataConnection && (
                                    <span className="text-[9px] text-yellow-500/80 flex items-center gap-0.5" title="Dynamic Collection">
                                      <Database className="w-2.5 h-2.5" />
                                    </span>
                                  )}
                                </div>
                                
                                {/* Children preview (collapsed) */}
                                {node.children && node.children.length > 0 && node.status === "done" && (
                                  <div className="ml-5 mt-0.5 text-[9px] text-white/25">
                                    {node.children.slice(0, 3).join(" • ")}
                                    {node.children.length > 3 && ` +${node.children.length - 3}`}
                                  </div>
                                )}
                              </motion.div>
                            ))
                          ) : (
                            <div className="flex items-center gap-2 text-[10px] text-zinc-600">
                              <Loader2 className="w-3 h-3 animate-spin text-zinc-300/50" />
                              <span>Building component tree...</span>
                            </div>
                          )}
                        </div>
                        
                        {/* Data Patterns - detected database connections + Supabase status */}
                        {analysisPhase.dataPatterns && analysisPhase.dataPatterns.length > 0 && (
                          <motion.div 
                            initial={{ opacity: 0, y: 5 }}
                            animate={{ opacity: 1, y: 0 }}
                            className="mt-3 pt-2 border-t border-zinc-800"
                          >
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-1.5">
                                <Database className={cn("w-3 h-3", isSupabaseConnected ? "text-green-500/60" : "text-white/20")} />
                                <span className="text-[9px] text-zinc-600 uppercase tracking-wide">Data Patterns</span>
                              </div>
                              {/* Supabase connection status - PRO only */}
                              {isPaidPlan ? (
                                <span className={cn(
                                  "text-[9px]",
                                  isSupabaseConnected ? "text-green-500" : "text-zinc-600"
                                )}>
                                  {isSupabaseConnected ? "Supabase Connected" : "Supabase Not Connected"}
                                </span>
                              ) : (
                                <button 
                                  onClick={() => {
                                    setUpgradeFeature("supabase");
                                    setShowUpgradeModal(true);
                                  }}
                                  className="flex items-center gap-1 text-[9px] text-zinc-300 hover:text-[#52525b]"
                                >
                                  <Lock className="w-2.5 h-2.5" />
                                  <span>PRO</span>
                                </button>
                              )}
                            </div>
                            {isPaidPlan ? (
                              analysisPhase.dataPatterns.map((pattern, i) => (
                                <div key={i} className="flex items-center gap-2 text-[9px] py-0.5">
                                  <span className="text-zinc-500">{pattern.pattern}</span>
                                  <span className="text-white/20">→</span>
                                  <code className={cn(
                                    "font-mono px-1 rounded",
                                    isSupabaseConnected ? "text-green-400/80 bg-green-500/5" : "text-zinc-500 bg-zinc-800/50"
                                  )}>{pattern.suggestedTable || pattern.component}</code>
                                </div>
                              ))
                            ) : (
                              <div className="text-[9px] text-zinc-600 italic">
                                {analysisPhase.dataPatterns.length} patterns detected — upgrade to see details
                              </div>
                            )}
                          </motion.div>
                        )}
                      </motion.div>
                    )}
                  </AnimatePresence>
                </div>
              ) : generationComplete && analysisPhase?.stats ? (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-3">
                  <div className="flex items-center gap-2 mb-2">
                    <LogoIcon className="w-4 h-5" color="var(--accent-orange)" />
                    <span className="text-xs font-medium text-zinc-400">Complete</span>
                  </div>
                  
                  {/* Stats tiles - compact single line */}
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-zinc-500">Stack</span>
                      <span className="text-xs text-zinc-400 font-medium">Tailwind + Alpine</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-zinc-500">Elements</span>
                      <span className="text-xs text-zinc-400 font-medium">{analysisPhase.stats.componentCount}</span>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-zinc-500">Style</span>
                      <span className="text-xs text-zinc-400 font-medium truncate max-w-[140px]">{analysisPhase.stats.theme.split(' ')[0]}</span>
                    </div>
                  </div>
                  
                  {/* Show actual colors from generated code */}
                  {styleInfo && styleInfo.colors.length > 0 && (
                    <div className="flex items-center gap-2 pt-2 border-t border-zinc-800">
                      <span className="text-xs text-zinc-600">Colors:</span>
                      <div className="flex gap-1">
                        {styleInfo.colors.slice(0, 5).map((c, i) => (
                          <div key={i} className="w-5 h-5 rounded-sm border border-zinc-700" style={{ background: c.value }} title={c.value} />
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {analysisDescription && (
                    <p className="text-xs text-zinc-500 leading-relaxed mt-2 pt-2 border-t border-zinc-800">
                      {analysisDescription}
                    </p>
                  )}
                </motion.div>
              ) : (
                <div className="analysis-section">
                  <div className="flex items-center gap-2 mb-2">
                    <Clock className="w-3.5 h-3.5 text-white/20" />
                    <span className="text-xs font-semibold text-zinc-600 uppercase tracking-wider">Waiting for generation</span>
                  </div>
                  <p className="text-xs text-white/25 leading-relaxed">Live analysis logs will display here once generation starts.</p>
                </div>
              )}
                </div>
              </div>
            </div>
          ) : null}
        </div>

        {/* Main Content */}
        <div className="flex-1 flex flex-col bg-[#111111] min-w-0 overflow-hidden">
          {/* Desktop Top Bar: Tabs Left | Options Center | User/Actions Right */}
          <div className="hidden md:flex items-center justify-between px-4 h-12 border-b border-zinc-800/50 bg-[#141414]">
            {/* Left: Navigation Tabs - Animated toggle style */}
            <div className="flex items-center bg-zinc-800/50 rounded-lg p-1">
              {[
                { id: "preview", icon: Eye, label: "Preview" },
                { id: "library", icon: Library, label: "Library" },
                { id: "blueprints", icon: Pencil, label: "Editor" },
                { id: "flow", icon: GitBranch, label: "Flow" },
                { id: "code", icon: Code, label: "Code" },
              ].map((tab) => (
                <div key={tab.id} className="relative group">
                  <button 
                    onClick={() => setViewMode(tab.id as ViewMode)} 
                    className={cn(
                      "relative flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium transition-all duration-200 rounded-md", 
                      viewMode === tab.id 
                        ? "text-white bg-zinc-700" 
                        : "text-zinc-500 hover:text-zinc-300"
                    )}
                  >
                    <tab.icon className="w-3.5 h-3.5" />
                    <AnimatePresence mode="wait">
                      {viewMode === tab.id && (
                        <motion.span
                          key={tab.id}
                          initial={{ width: 0, opacity: 0 }}
                          animate={{ width: "auto", opacity: 1 }}
                          exit={{ width: 0, opacity: 0 }}
                          transition={{ duration: 0.15 }}
                          className="overflow-hidden whitespace-nowrap"
                        >
                          {tab.label}
                        </motion.span>
                      )}
                    </AnimatePresence>
                  </button>
                  {/* Custom tooltip - only show when tab is not active */}
                  {viewMode !== tab.id && (
                    <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-2 py-1 bg-zinc-800 text-zinc-300 text-[10px] font-medium rounded-md whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none border border-zinc-700/50 z-[9999]">
                      {tab.label}
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            {/* Center: Tab-specific options */}
            <div className="flex items-center gap-2">


              {editableCode && (
                <>
                  {viewMode === "preview" && (
                    <>
                      {/* Pending edits indicator and Save All */}
                      {pendingTextEdits.length > 0 && (
                        <>
                          <button 
                            onClick={() => { 
                              // Reset pending edits and refresh preview to original
                              setPendingTextEdits([]); 
                              setIsDirectEditMode(false);
                              // Force refresh preview to discard visual changes
                              if (editableCode) {
                                setPreviewUrl(createPreviewUrl(editableCode));
                              }
                            }}
                            className="btn-black px-2 py-1 rounded-lg text-[10px] text-zinc-500 hover:text-zinc-400"
                          >
                            Discard All
                          </button>
                          <button 
                            onClick={applyPendingTextEdits}
                            className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 border border-emerald-500/30"
                          >
                            <Check className="w-3 h-3" /> Save All ({pendingTextEdits.length})
                          </button>
                        </>
                      )}
                      
                      {/* Editing / Select toggle - click again to deselect */}
                      <div className="flex items-center rounded-lg overflow-hidden border border-zinc-700">
                        <button 
                          onClick={() => { 
                            if (isDirectEditMode) {
                              setIsDirectEditMode(false);
                            } else {
                              setIsDirectEditMode(true); 
                              setIsPointAndEdit(false);
                              setShowFloatingEdit(false); // Close Edit with AI when entering direct edit mode
                            }
                          }}
                          className={cn(
                            "flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-medium transition-all",
                            isDirectEditMode 
                              ? "bg-white text-zinc-900" 
                              : "bg-zinc-800/50 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-700/50"
                          )}
                        >
                          <Pencil className={cn("w-3 h-3", isDirectEditMode && "text-zinc-700")} /> Editing
                        </button>
                        <button 
                          onClick={() => { 
                            if (isPointAndEdit) {
                              setIsPointAndEdit(false);
                            } else {
                              setIsPointAndEdit(true); 
                              setIsDirectEditMode(false); 
                            }
                          }}
                          className={cn(
                            "flex items-center gap-1.5 px-3 py-1.5 text-[11px] font-medium transition-all border-l border-zinc-700",
                            isPointAndEdit 
                              ? "bg-white text-zinc-900" 
                              : "bg-zinc-800/50 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-700/50"
                          )}
                        >
                          <MousePointer className={cn("w-3 h-3", isPointAndEdit && "text-zinc-700")} /> Select
                        </button>
                      </div>
                      
                      {/* Assets Button */}
                      <button
                        onClick={() => setShowAssetsModal(!showAssetsModal)}
                        className={cn(
                          "flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-medium transition-all border",
                          showAssetsModal
                            ? "bg-white text-zinc-900 border-white"
                            : "bg-zinc-800/50 border-zinc-700 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-700/50"
                        )}
                        title="View and replace images"
                      >
                        <ImageIcon className="w-3.5 h-3.5" />
                        Assets
                      </button>
                      
                      {/* Mobile/Desktop toggle - only in preview */}
                      <button 
                        onClick={() => setIsMobilePreview(!isMobilePreview)} 
                        className={cn(
                          "p-2 rounded-lg transition-colors border",
                          isMobilePreview 
                            ? "bg-white text-zinc-900 border-white" 
                            : "bg-zinc-800/50 border-zinc-700 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-700/50"
                        )} 
                        title={isMobilePreview ? "Switch to desktop view" : "Switch to mobile view"}
                      >
                        {isMobilePreview ? <Monitor className="w-3.5 h-3.5" /> : <Smartphone className="w-3.5 h-3.5" />}
                      </button>
                    </>
                  )}
                </>
              )}
            </div>
            
            {/* Right: User Menu + Refresh + Mobile + Publish */}
            <div className="flex items-center gap-2">
              {/* Online Users - show other users in this project */}
              {activeGeneration && (
                <OnlineUsers />
              )}
              
              {/* Comment Mode Toggle - available on all tabs */}
              {activeGeneration && (
                <CommentModeToggle 
                  isActive={isCommentMode}
                  onClick={() => setIsCommentMode(!isCommentMode)}
                />
              )}
              
              {/* User Menu */}
              <div className="relative" ref={profileMenuRef}>
                {user ? (
                  <>
                    {(() => {
                      const meta = user.user_metadata;
                      // Priority: profile.full_name > user_metadata.full_name > email
                      const displayName = profile?.full_name || meta?.full_name || meta?.name || user.email?.split('@')[0] || 'User';
                      const plan = membership?.plan || "free";
                      return (
                        <button 
                          onClick={() => setShowProfileMenu(!showProfileMenu)}
                          className="flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-zinc-800/50 transition-colors"
                        >
                          <span className="text-xs font-medium text-zinc-200 max-w-[80px] truncate">{displayName}</span>
                          {(plan === "pro" || plan === "agency" || plan === "enterprise") ? (
                            <span className="px-1.5 py-0.5 rounded text-[9px] font-semibold bg-zinc-800 text-white uppercase">
                              {plan === "agency" ? "Agency" : plan === "enterprise" ? "Enterprise" : "Pro"}
                            </span>
                          ) : (
                            <span className="px-1.5 py-0.5 rounded text-[9px] font-medium bg-white/10 text-zinc-500 uppercase">
                              {"Free"}
                            </span>
                          )}
                        </button>
                      );
                    })()}
                    
                    {/* Profile Dropdown */}
                    <AnimatePresence>
                      {showProfileMenu && (
                        <motion.div
                          initial={{ opacity: 0, y: -5, scale: 0.95 }}
                          animate={{ opacity: 1, y: 0, scale: 1 }}
                          exit={{ opacity: 0, y: -5, scale: 0.95 }}
                          transition={{ duration: 0.15 }}
                          className="absolute right-0 top-full mt-2 w-64 bg-[#111111] border border-zinc-700 rounded-xl shadow-xl overflow-hidden z-50"
                        >
                          {/* Credits section */}
                          {(() => {
                            const plan = membership?.plan || "free";
                            const maxCredits = plan === "agency" ? 10000 : plan === "pro" ? 3000 : 100;
                            const percentage = Math.min(100, (userTotalCredits / maxCredits) * 100);
                            return (
                              <Link 
                                href="/settings?tab=plans"
                                onClick={() => setShowProfileMenu(false)}
                                className="block p-4 hover:bg-zinc-800/50 transition-colors border-b border-zinc-800"
                              >
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                    <span className="text-sm text-white">{userTotalCredits} credits</span>
                                    {isPaidPlan ? (
                                      <span className="px-1.5 py-0.5 rounded text-[9px] font-semibold bg-zinc-800 text-white uppercase">
                                        {plan === "agency" ? "Agency" : plan === "enterprise" ? "Enterprise" : "Pro"}
                                      </span>
                                    ) : (
                                      <span className="px-1.5 py-0.5 rounded text-[9px] font-medium bg-white/10 text-zinc-500 uppercase">
                                        Free
                                      </span>
                                    )}
                                  </div>
                                  <ChevronRight className="w-4 h-4 text-zinc-500" />
                                </div>
                                <div className="mt-1">
                                  <span className="text-xs text-zinc-500">{isPaidPlan ? "Add credits →" : "Upgrade →"}</span>
                                </div>
                              </Link>
                            );
                          })()}
                          
                          {/* Your Projects */}
                          <button 
                            onClick={() => { setShowProfileMenu(false); setSidebarView("projects"); }}
                            className="w-full flex items-center gap-3 px-4 py-3 text-sm text-zinc-200 hover:bg-zinc-800/50 transition-colors"
                          >
                            <Folder className="w-4 h-4 opacity-50" />
                            Your Projects
                          </button>
                          
                          {/* Settings */}
                          <Link 
                            href="/settings"
                            onClick={() => setShowProfileMenu(false)}
                            className="flex items-center gap-3 px-4 py-3 text-sm text-zinc-200 hover:bg-zinc-800/50 transition-colors"
                          >
                            <Settings className="w-4 h-4 opacity-50" />
                            Settings
                          </Link>
                          
                          {/* Sign out */}
                          <div className="border-t border-zinc-800">
                            <button 
                              onClick={() => { setShowProfileMenu(false); signOut(); }}
                              className="w-full flex items-center gap-3 px-4 py-3 text-sm text-zinc-200 hover:bg-zinc-800/50 transition-colors"
                            >
                              <LogOut className="w-4 h-4 opacity-50" />
                              Sign out
                            </button>
                          </div>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </>
                ) : (
                  <Link
                    href="/login"
                    className="px-3 py-1.5 rounded-md bg-zinc-800 text-sm font-medium text-zinc-300 hover:bg-zinc-700 hover:text-zinc-200 transition-colors"
                  >
                    Sign in
                  </Link>
                )}
              </div>
              
              {/* Refresh button */}
              <button 
                onClick={handleRefresh}
                className="p-2 rounded-md hover:bg-zinc-800 transition-colors"
                title="Refresh preview"
              >
                <RefreshCw className="w-4 h-4 text-zinc-500" />
              </button>
              
              {/* Publish button with dropdown - always brand color */}
              <div className="relative">
                <button
                  onClick={() => {
                    // Demo mode: publish is Pro feature
                    if (isDemoMode) {
                      setUpgradeFeature("publish");
                      setShowUpgradeModal(true);
                      return;
                    }
                    // Not logged in: require sign up
                    if (!user) {
                      setShowAuthModal(true);
                      showToast("Sign up free to publish. You get 1 free generation!", "info");
                      return;
                    }
                    if (!isPaidPlan) {
                      setUpgradeFeature("publish");
                      setShowUpgradeModal(true);
                      return;
                    }
                    if (!editableCode) return;
                    // Toggle publish dropdown
                    setShowPublishModal(!showPublishModal);
                  }}
                  disabled={isPublishing}
                  className="px-4 py-2 rounded-lg text-sm font-medium bg-zinc-800 hover:bg-zinc-700 text-white transition-colors flex items-center gap-2 disabled:opacity-50"
                >
                  {isPublishing ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Publishing...
                    </>
                  ) : publishedUrl ? (
                    <>
                      <span className="w-1.5 h-1.5 rounded-full bg-emerald-400" />
                      Published
                    </>
                  ) : (
                    "Publish"
                  )}
                </button>
                
                {/* Publish Dropdown/Popover */}
                {showPublishModal && (
                  <>
                    {/* Backdrop to close on outside click - only covers main area, not sidebar */}
                    <div 
                      className="fixed inset-0 z-[5]" 
                      onClick={() => setShowPublishModal(false)}
                    />
                    <div className="absolute right-0 top-full mt-2 w-80 bg-zinc-900 border border-zinc-700 rounded-xl shadow-2xl z-[100] overflow-hidden">
                      {/* Header */}
                      <div className="px-4 py-3 border-b border-zinc-700 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-white">Publish your project</span>
                          {publishedUrl && (
                            <span className="px-1.5 py-0.5 bg-green-500/20 text-green-400 text-[10px] font-medium rounded">Live</span>
                          )}
                        </div>
                        <button
                          onClick={() => setShowPublishModal(false)}
                          className="p-1 rounded hover:bg-white/10 transition-colors"
                        >
                          <X className="w-4 h-4 text-zinc-400" />
                        </button>
                      </div>
                      
                      {/* Content */}
                      <div className="p-4 space-y-3">
                        {/* Published URL */}
                        <div>
                          <label className="text-xs text-zinc-500 mb-1.5 block">Published URL</label>
                          <div className="flex items-center gap-2 bg-zinc-800/50 border border-zinc-700 rounded-lg px-3 py-2">
                            <Globe className="w-4 h-4 text-zinc-500 flex-shrink-0" />
                            <span className="text-sm text-zinc-200 truncate flex-1 font-mono">
                              {publishedUrl ? publishedUrl.replace('https://', '').replace('http://', '') : 'replay.build/p/...'}
                            </span>
                            {publishedUrl && (
                              <button
                                onClick={() => {
                                  navigator.clipboard.writeText(publishedUrl);
                                  showToast("Link copied!", "success");
                                }}
                                className="p-1.5 rounded hover:bg-white/10 transition-colors"
                                title="Copy URL"
                              >
                                <Copy className="w-3.5 h-3.5 text-zinc-400" />
                              </button>
                            )}
                          </div>
                        </div>
                        
                        {/* Actions */}
                        <div className="flex gap-2">
                          {publishedUrl && (
                            <a
                              href={publishedUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="flex-1 py-2.5 rounded-lg bg-zinc-800/50 hover:bg-white/10 text-zinc-200 text-sm font-medium transition-colors flex items-center justify-center gap-2"
                            >
                              <ExternalLink className="w-4 h-4" />
                              Open
                            </a>
                          )}
                          <button
                            onClick={() => handlePublish()}
                            disabled={isPublishing}
                            className="flex-1 py-2.5 rounded-lg bg-zinc-800 hover:bg-zinc-600 text-white text-sm font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
                          >
                            {isPublishing ? (
                              <>
                                <Loader2 className="w-4 h-4 animate-spin" />
                                {publishedUrl ? "Updating..." : "Publishing..."}
                              </>
                            ) : (
                              <>
                                {publishedUrl ? (
                                  <>
                                    <RefreshCw className="w-4 h-4" />
                                    Update
                                  </>
                                ) : (
                                  <>
                                    <ExternalLink className="w-4 h-4" />
                                    Publish
                                  </>
                                )}
                              </>
                            )}
                          </button>
                        </div>
                        
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>

          <div className="flex-1 overflow-hidden flex flex-col relative bg-[#111111]">
            {/* Preview - show loading during generation, keep preview visible during editing */}
            {viewMode === "preview" && (
              <div className="flex-1 preview-container relative bg-[#111111] flex flex-col overflow-hidden" style={{ overscrollBehavior: 'none' }}>
                {(isProcessing || isStreamingCode) ? (
                  <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                    <LoadingState />
                  </div>
                ) : previewUrl ? (
                  <>
                    {/* Iframe container */}
                    <div className={cn("flex-1 flex items-center justify-center bg-[#111111] relative", isMobilePreview && "py-4")} style={{ overscrollBehavior: 'contain' }}>
                      <iframe 
                        key={previewUrl}
                        ref={previewIframeRef}
                        src={previewUrl} 
                        onLoad={() => {
                          // Send toggle message when iframe loads
                          if (showAssetsModal && previewIframeRef.current?.contentWindow) {
                            setTimeout(() => {
                              previewIframeRef.current?.contentWindow?.postMessage({ type: 'TOGGLE_ASSET_SELECTOR', enabled: true }, '*');
                            }, 50);
                          }
                        }}
                        className={cn(
                          "border-0 bg-[#111111] transition-all duration-300",
                          isMobilePreview 
                            ? "w-[375px] h-[667px] rounded-3xl shadow-2xl ring-4 ring-black/50" 
                            : "w-full h-full",
                          isPointAndEdit && "cursor-crosshair",
                          isEditing && "opacity-50"
                        )} 
                        style={{ 
                          overscrollBehavior: 'contain', 
                          backgroundColor: '#0a0a0a'
                        }}
                        title="Preview" 
                        sandbox="allow-scripts allow-same-origin"
                        referrerPolicy="no-referrer" 
                      />
                      {/* Editing overlay indicator */}
                      {isEditing && (
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                          <div className="bg-zinc-900 backdrop-blur-sm px-6 py-4 rounded-2xl border border-zinc-700 flex items-center gap-3">
                            <Loader2 className="w-5 h-5 text-zinc-300 animate-spin" />
                            <span className="text-zinc-200 text-sm font-medium">Applying changes...</span>
                          </div>
                        </div>
                      )}
                    </div>
                    
{/* Edit with AI button removed - chat does the same thing */}
                  </>
                ) : (
                  <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                    <EmptyState icon="logo" title="Drop or record video. Get code." subtitle="We analyze the flow, map interactions, and export clean code." />
                  </div>
                )}
              </div>
            )}

            {/* Code - Professional Code Tab with mode toggle and file tree */}
            {viewMode === "code" && (
              <div className="flex-1 flex flex-col relative bg-[#111111] min-h-0 overflow-hidden">
                {/* Show loading during generation - hide everything else */}
                {(isProcessing || isStreamingCode) ? (
                  <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                    <LoadingState />
                  </div>
                ) : (
                  <>
                {/* Code Tab Header - Breadcrumbs + Actions in one line */}
                {displayedCode && (
                  <div className="flex-shrink-0 border-b border-zinc-800 bg-[#111111] px-3 py-2">
                    <div className="flex items-center justify-between gap-3">
                      {/* Left: Breadcrumbs */}
                      <div className="flex items-center gap-1.5 text-[11px]">
                        <span className="text-zinc-500">{activeFilePath.split('/').slice(1, -1).join('/')}/</span>
                        <span className="text-white font-medium">{activeFilePath.split('/').pop()}</span>
                      </div>
                      
                      {/* Right: Actions - Edit, Copy for AI, Download */}
                      <div className="flex items-center gap-1.5">
                        {/* Edit button */}
                        {editableCode && !isCodeEditable && (
                          <button 
                            onClick={handleEnterEditMode} 
                            className="flex items-center gap-1 px-2 py-1 rounded text-[10px] text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50 transition-colors"
                          >
                            <Pencil className="w-3 h-3" /> Edit
                          </button>
                        )}
                        {isCodeEditable && (
                          <button 
                            onClick={applyCodeChanges} 
                            className="flex items-center gap-1 px-2 py-1 rounded text-[10px] text-emerald-400 hover:text-emerald-300 hover:bg-emerald-500/10 transition-colors"
                          >
                            <Check className="w-3 h-3" /> Apply
                          </button>
                        )}
                        
                        {/* Copy for AI - Single dropdown button */}
                        <div className="relative">
                          <button 
                            onClick={() => {
                              // Demo mode + no user -> Sign up
                              if (!user) {
                                setShowAuthModal(true);
                                showToast("Sign up free to export code. You get 1 free generation!", "info");
                                return;
                              }
                              // User exists but no credits and not paid -> Show starter pack modal
                              if (!isPaidPlan && userTotalCredits <= 0) {
                                setShowOutOfCreditsModal(true);
                                return;
                              }
                              // User can export (paid OR has credits)
                              setShowCopyDropdown(!showCopyDropdown);
                            }}
                            className={cn(
                              "flex items-center gap-1 px-2 py-1 rounded text-[10px] transition-colors",
                              agentMode 
                                ? "bg-zinc-800/10 text-zinc-300 hover:bg-zinc-800/20 border border-zinc-700" 
                                : "text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50",
                              (!user || (!isPaidPlan && userTotalCredits <= 0)) && "opacity-50"
                            )}
                          >
                            {(!user || (!isPaidPlan && userTotalCredits <= 0)) && <Lock className="w-2.5 h-2.5" />}
                            <Copy className="w-3 h-3" />
                            <span>Copy for AI</span>
                            <ChevronDown className="w-3 h-3" />
                          </button>
                          
                          {/* Copy Dropdown Menu */}
                          {showCopyDropdown && user && (isPaidPlan || userTotalCredits > 0) && (
                            <>
                              <div 
                                className="fixed inset-0 z-[5]" 
                                onClick={() => setShowCopyDropdown(false)}
                              />
                              <div className="absolute right-0 top-full mt-1 w-56 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 overflow-hidden">
                                <div className="p-1.5">
                                  <button
                                    onClick={() => {
                                      const content = getActiveFileContent();
                                      navigator.clipboard.writeText(content);
                                      showToast("Clean code copied", "success");
                                      setShowCopyDropdown(false);
                                    }}
                                    className="w-full flex items-center gap-2 px-3 py-2 rounded-md text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors text-left"
                                  >
                                    <Copy className="w-3.5 h-3.5 text-zinc-500" />
                                    <div>
                                      <div className="font-medium">Copy Clean Code</div>
                                      <div className="text-[9px] text-zinc-500">For manual implementation</div>
                                    </div>
                                  </button>
                                  
                                  <button
                                    onClick={() => {
                                      const content = getAgentPackCode(getActiveFileContent());
                                      navigator.clipboard.writeText(content);
                                      showToast("Agent Pack copied! Paste into Cursor", "success");
                                      setShowCopyDropdown(false);
                                    }}
                                    className={cn(
                                      "w-full flex items-center gap-2 px-3 py-2 rounded-md text-[11px] transition-colors text-left",
                                      agentMode 
                                        ? "bg-zinc-800/10 text-zinc-300" 
                                        : "text-zinc-400 hover:bg-zinc-800/10 hover:text-zinc-300"
                                    )}
                                  >
                                    <Sparkles className="w-3.5 h-3.5" />
                                    <div>
                                      <div className="font-medium">Copy for AI Editors</div>
                                      <div className="text-[9px] opacity-60">With context markers & instructions</div>
                                    </div>
                                    {agentMode && <Check className="w-3 h-3 ml-auto" />}
                                  </button>
                                  
                                  <div className="border-t border-zinc-800 my-1" />
                                  
                                  <button
                                    onClick={() => {
                                      const instructions = generateAgentInstructions(generationTitle, flowNodes);
                                      navigator.clipboard.writeText(instructions);
                                      showToast("Prompt instructions copied", "success");
                                      setShowCopyDropdown(false);
                                    }}
                                    className="w-full flex items-center gap-2 px-3 py-2 rounded-md text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors text-left"
                                  >
                                    <MessageSquare className="w-3.5 h-3.5 text-zinc-500" />
                                    <div>
                                      <div className="font-medium">Copy Prompt Only</div>
                                      <div className="text-[9px] text-zinc-500">Just the AI instructions</div>
                                    </div>
                                  </button>
                                </div>
                              </div>
                            </>
                          )}
                        </div>
                        
                        <button 
                          onClick={() => {
                            // No user -> Sign up
                            if (!user) {
                              setShowAuthModal(true);
                              showToast("Sign up free to download code. You get 1 free generation!", "info");
                              return;
                            }
                            // No credits and not paid -> Show starter pack modal
                            if (!isPaidPlan && userTotalCredits <= 0) {
                              setShowOutOfCreditsModal(true);
                              return;
                            }
                            // Allow download
                            handleDownload();
                          }}
                          className={cn(
                            "flex items-center gap-1 px-2 py-1 rounded text-[10px] text-zinc-500 hover:text-zinc-400 hover:bg-zinc-800/50 transition-colors",
                            (!user || (!isPaidPlan && userTotalCredits <= 0)) && "opacity-50"
                          )}
                        >
                          {(!user || (!isPaidPlan && userTotalCredits <= 0)) && <Lock className="w-2.5 h-2.5" />}
                          <Download className="w-3 h-3" />
                          <span>Download</span>
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Main Code Area (file tree panel removed - now in left sidebar) */}
                <div className="flex-1 flex min-h-0 overflow-hidden">
                  {/* Code Editor Panel */}
                  <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                    {/* Code content */}
                    <div ref={codeContainerRef} className="flex-1 overflow-auto">
                      {isCodeEditable ? (
                        <textarea 
                          value={editableCode} 
                          onChange={(e) => setEditableCode(e.target.value)} 
                          className="w-full h-full p-3 bg-[#111111] text-[11px] text-zinc-200 font-mono resize-none focus:outline-none" 
                          style={{ fontFamily: "'JetBrains Mono', monospace" }} 
                          spellCheck={false} 
                        />
                      ) : generatingFilePath && generatingFilePath === activeFilePath ? (
                        // Show loading state when generating the currently viewed file
                        <div className="w-full h-full flex flex-col items-center justify-center bg-[#111111] gap-4">
                          <Loader2 className="w-8 h-8 text-zinc-300 animate-spin" />
                          <div className="text-center">
                            <p className="text-sm text-zinc-400 font-medium">Generating page...</p>
                            <p className="text-xs text-zinc-600 mt-1">{activeFilePath.split('/').pop()}</p>
                          </div>
                        </div>
                      ) : displayedCode ? (
                        <div className="overflow-x-auto relative h-full">
                          {/* For PRO users OR Demo projects: show real code (with Agent Mode enhancements if enabled) */}
                          {(isPaidPlan || DEMO_PROJECT_IDS.has(activeGeneration?.id || '')) ? (
                            <Highlight 
                              theme={themes.nightOwl} 
                              code={agentMode ? getAgentPackCode(getActiveFileContent()) : getActiveFileContent()} 
                              language={activeFilePath.endsWith('.tsx') || activeFilePath.endsWith('.ts') ? 'tsx' : 'html'}
                            >
                              {({ style, tokens, getLineProps, getTokenProps }) => (
                                <pre 
                                  className="p-3 text-[11px] leading-relaxed" 
                                  style={{ 
                                    ...style, 
                                    background: "#111111", 
                                    fontFamily: "'JetBrains Mono', monospace", 
                                    minHeight: "100%",
                                    minWidth: "fit-content"
                                  }}
                                >
                                  {tokens.map((line, i) => {
                                    const lineNum = i + 1;
                                    const isHighlighted = highlightedLines && lineNum >= highlightedLines.start && lineNum <= highlightedLines.end;
                                    return (
                                      <div 
                                        key={i} 
                                        {...getLineProps({ line })}
                                        className={cn(
                                          isHighlighted && "bg-zinc-800/10 -mx-3 px-3 border-l-2 border-[var(--accent-orange)]"
                                        )}
                                      >
                                        <span className="inline-block w-8 pr-3 text-right text-white/15 select-none text-[10px]">{lineNum}</span>
                                        {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                      </div>
                                    );
                                  })}
                                  {isStreamingCode && <span className="text-zinc-300 animate-pulse">▋</span>}
                                </pre>
                              )}
                            </Highlight>
                          ) : (
                            /* For FREE users: show blurred mock code with upgrade overlay */
                            <div className="relative h-full">
                              {/* Blurred mock code background - visible but unreadable */}
                              <div className="absolute inset-0 overflow-hidden select-none pointer-events-none">
                                <pre 
                                  className="p-3 text-[11px] leading-relaxed blur-[8px] opacity-60" 
                                  style={{ 
                                    background: "#111111", 
                                    fontFamily: "'JetBrains Mono', monospace",
                                  }}
                                >
                                  {`import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';

export default function GeneratedPage() {
  const [isLoading, setIsLoading] = useState(true);
  const [data, setData] = useState(null);

  useEffect(() => {
    // Fetch data from API
    fetchData().then(setData);
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-b">
      <header className="fixed top-0 w-full">
        <nav className="container mx-auto px-4">
          <div className="flex items-center justify-between">
            <Logo />
            <Navigation />
          </div>
        </nav>
      </header>

      <main className="pt-20">
        <section className="hero-section">
          <motion.h1 
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-5xl font-bold"
          >
            Welcome to Your App
          </motion.h1>
          <p className="text-xl text-muted">
            Build something amazing today
          </p>
          <Button size="lg">Get Started</Button>
        </section>

        <section className="features-grid">
          {features.map((feature, i) => (
            <Card key={i} className="p-6">
              <feature.icon className="w-12 h-12" />
              <h3>{feature.title}</h3>
              <p>{feature.description}</p>
            </Card>
          ))}
        </section>
      </main>

      <footer className="border-t">
        <div className="container py-8">
          <p>© 2026 Your Company</p>
        </div>
      </footer>
    </div>
  );
}`.split('\n').map((line, i) => (
                                    <div key={i} className="whitespace-pre">
                                      <span className="inline-block w-8 pr-3 text-right text-white/15 text-[10px]">{i + 1}</span>
                                      <span className="text-zinc-500">{line}</span>
                                    </div>
                                  ))}
                                </pre>
                              </div>
                              
                              {/* Upgrade overlay - Starter Pack + Pro options */}
                              <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-b from-[#111111]/40 via-[#111111]/70 to-[#111111]/90">
                                <div className="relative p-6 bg-[#111111] border border-zinc-700 rounded-2xl shadow-2xl max-w-md mx-4">
                                  {/* Close button */}
                                  <button 
                                    onClick={() => setViewMode("preview")}
                                    className="absolute top-4 right-4 p-1.5 rounded-lg hover:bg-white/10 transition-colors z-10"
                                  >
                                    <X className="w-4 h-4 text-zinc-500" />
                                  </button>
                                  
                                  {/* Header */}
                                  <div className="text-center mb-5">
                                    <div className="w-14 h-14 mx-auto mb-4 rounded-2xl bg-zinc-800/10 flex items-center justify-center">
                                      <Zap className="w-7 h-7 text-zinc-300" />
                                    </div>
                                    <h3 className="text-xl font-bold text-white mb-2">Unlock Source Code</h3>
                                    <p className="text-sm text-zinc-500">Get instant access to React + Tailwind code</p>
                                  </div>
                                  
                                  {/* Options */}
                                  <div className="space-y-3 mb-5">
                                    {/* Pro Subscription - Best Value */}
                                    <div
                                      onClick={() => setSelectedUpgradePlan("pro")}
                                      className={`w-full p-4 rounded-xl border-2 transition-all text-left relative cursor-pointer ${
                                        selectedUpgradePlan === "pro" ? "border-[var(--accent-orange)] bg-zinc-800/5" : "border-zinc-700 hover:border-white/20 bg-zinc-800/50"
                                      }`}
                                    >
                                      <span className="absolute -top-2 right-3 px-2 py-0.5 text-[10px] font-bold uppercase bg-zinc-800 text-white rounded">Best Value</span>
                                      <div className="flex items-center gap-3 mb-3">
                                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${selectedUpgradePlan === "pro" ? "border-[var(--accent-orange)] bg-zinc-800" : "border-white/30"}`}>
                                          {selectedUpgradePlan === "pro" && <Check className="w-3 h-3 text-white" />}
                                        </div>
                                        <div className="flex-1">
                                          <div className="flex items-center gap-2">
                                            <Sparkles className="w-4 h-4 text-zinc-300" />
                                            <span className="font-semibold text-white">Pro Subscription</span>
                                          </div>
                                        </div>
                                        <div className="text-right">
                                          <span className="text-xl font-bold text-white">${selectedProTier.price}</span>
                                          <span className="text-xs text-zinc-500">/mo</span>
                                        </div>
                                      </div>
                                      
                                      {/* Capacity selector */}
                                      <div className="ml-8 relative">
                                        <button
                                          onClick={(e) => { e.stopPropagation(); setShowProTierDropdown(!showProTierDropdown); }}
                                          className="w-full flex items-center justify-between px-3 py-2 bg-zinc-900 border border-zinc-700 rounded-lg text-sm text-white hover:border-white/20 transition-colors"
                                        >
                                          <span>{selectedProTier.credits.toLocaleString()} credits</span>
                                          <ChevronDown className={`w-4 h-4 text-zinc-500 transition-transform ${showProTierDropdown ? "rotate-180" : ""}`} />
                                        </button>
                                        
                                        {showProTierDropdown && (
                                          <div className="absolute top-full left-0 right-0 mt-1 bg-zinc-900 border border-zinc-700 rounded-lg overflow-hidden z-20 shadow-xl">
                                            {PRO_TIERS.map((tier, idx) => (
                                              <button
                                                key={tier.id}
                                                onClick={(e) => { e.stopPropagation(); setSelectedProTierIndex(idx); setShowProTierDropdown(false); }}
                                                className={`w-full px-3 py-2 text-left text-sm hover:bg-zinc-800/50 transition-colors flex items-center justify-between ${
                                                  idx === selectedProTierIndex ? "text-zinc-300 bg-zinc-800/10" : "text-white"
                                                }`}
                                              >
                                                <span>{tier.credits.toLocaleString()} credits</span>
                                                <span className="text-zinc-500">${tier.price}/mo</span>
                                              </button>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                      
                                      <p className="text-xs text-zinc-500 mt-2 ml-8">Full access • Priority support • Credits roll over</p>
                                    </div>
                                    
                                    {/* Starter Pack - Simple option */}
                                    <button
                                      onClick={() => {}}
                                      className={`w-full p-4 rounded-xl border-2 transition-all text-left ${
                                        false ? "border-[var(--accent-orange)] bg-zinc-800/5" : "border-zinc-700 hover:border-white/20 bg-zinc-800/50"
                                      }`}
                                    >
                                      <div className="flex items-center gap-3">
                                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${false ? "border-[var(--accent-orange)] bg-zinc-800" : "border-white/30"}`}>
                                          {false && <Check className="w-3 h-3 text-white" />}
                                        </div>
                                        <div className="flex-1">
                                          <div className="flex items-center gap-2">
                                            <Zap className="w-4 h-4 text-zinc-400" />
                                            <span className="font-medium text-white">Starter</span>
                                          </div>
                                          <p className="text-xs text-zinc-500 mt-0.5">300 credits • ~4 generations • Perfect for testing</p>
                                        </div>
                                        <div className="text-right">
                                          <span className="text-xl font-bold text-white">$9</span>
                                        </div>
                                      </div>
                                    </button>
                                  </div>
                                  
                                  {/* CTA */}
                                  <button
                                    onClick={() => handleUpgradeCheckout(selectedUpgradePlan)}
                                    disabled={isUpgradeCheckingOut}
                                    className="w-full py-3.5 rounded-xl bg-zinc-800 text-white text-sm font-semibold hover:opacity-90 transition-opacity disabled:opacity-50 flex items-center justify-center gap-2"
                                  >
                                    {isUpgradeCheckingOut ? (
                                      <>
                                        <Loader2 className="w-4 h-4 animate-spin" />
                                        Processing...
                                      </>
                                    ) : false ? (
                                      "Get Starter — $9"
                                    ) : (
                                      `Subscribe — $${selectedProTier.price}/mo`
                                    )}
                                  </button>
                                  <p className="text-center text-[10px] text-zinc-600 mt-3">
                                    {false ? "One-time payment. Credits never expire." : "Cancel anytime. Credits roll over."}
                                  </p>
                                  
                                  <button
                                    onClick={() => setViewMode("preview")}
                                    className="w-full mt-3 text-xs text-zinc-600 hover:text-zinc-500 transition-colors"
                                  >
                                    Maybe later
                                  </button>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      ) : (
                        <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                          {isProcessing ? <LoadingState /> : <EmptyState icon="logo" title="No code generated" subtitle="Generate from a video to see the code" />}
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* Inspector Panel removed - simplified UI */}
                </div>
                
{/* Edit with AI button removed - chat does the same thing */}
                  </>
                )}
              </div>
            )}

            {/* Flow - PRODUCT MAP (Canvas) - what's possible, not what happened */}
            {viewMode === "flow" && (
              <div className="flex-1 overflow-hidden relative flex flex-col">
                {/* Show loader when processing (same as other views) */}
                {(isProcessing || isStreamingCode) ? (
                  <div className="w-full h-full flex items-center justify-center">
                    <LoadingState />
                  </div>
                ) : flowNodes.length > 0 || flowBuilding ? (
                  <>
                    {/* Zoom controls - bottom left (same style as Blueprints) */}
                    <div className="absolute bottom-4 left-4 z-20 flex items-center gap-1 bg-zinc-900/95 backdrop-blur-sm rounded-lg p-1 border border-zinc-800 shadow-xl">
                      <button 
                        onClick={() => setArchZoom(z => Math.max(0.25, z - 0.1))} 
                        className="p-1.5 rounded hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white"
                        title="Zoom out"
                      >
                        <ZoomOut className="w-4 h-4" />
                      </button>
                      <span className="text-xs text-zinc-300 w-12 text-center font-mono">{Math.round(archZoom * 100)}%</span>
                      <button 
                        onClick={() => setArchZoom(z => Math.min(2, z + 0.1))} 
                        className="p-1.5 rounded hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white"
                        title="Zoom in"
                      >
                        <ZoomIn className="w-4 h-4" />
                      </button>
                      <div className="w-px h-4 bg-zinc-700 mx-1" />
                      <button 
                        onClick={() => setArchZoom(1)} 
                        className="px-2 py-1 rounded hover:bg-zinc-800 transition-colors text-[10px] text-zinc-400 hover:text-white"
                        title="Reset zoom"
                      >
                        Reset
                      </button>
                      <div className="w-px h-4 bg-zinc-700 mx-1" />
                      <button 
                        onClick={autoLayoutFlowNodes}
                        className="px-2 py-1 rounded hover:bg-zinc-800 transition-colors text-[10px] text-zinc-400 hover:text-white"
                        title="Auto-arrange"
                      >
                        Auto Layout
                      </button>
                      <div className="w-px h-4 bg-zinc-700 mx-1" />
                      <button 
                        onClick={() => {
                          const pageNum = flowNodes.filter(n => n.name.startsWith('New Page')).length + 1;
                          const pageName = `New Page ${pageNum}`;
                          const pageId = `new-page-${Date.now()}`;
                          const maxY = Math.max(...flowNodes.map(n => n.y || 0), 0);
                          const newNode = {
                            id: pageId,
                            name: pageName,
                            type: 'view' as const,
                            status: 'detected' as const,
                            description: 'Click to edit description',
                            x: 100,
                            y: maxY + 200,
                            confidence: 'high' as const
                          };
                          setFlowNodes(prev => [...prev, newNode]);
                        }}
                        className="px-2 py-1 rounded hover:bg-zinc-800 transition-colors text-[10px] text-zinc-400 hover:text-white flex items-center gap-1"
                        title="Add custom page"
                      >
                        <Plus className="w-3 h-3" />
                        New Page
                      </button>
                    </div>
                    
                    {/* Toggle buttons - top right - neutral colors */}
                    <div className="absolute top-4 right-4 z-20 flex items-center gap-1 bg-zinc-900/95 backdrop-blur-sm rounded-lg p-1 border border-zinc-800 shadow-xl">
                      {/* Possible paths toggle */}
                      <button 
                        onClick={() => setShowPossiblePaths(!showPossiblePaths)}
                        className={cn(
                          "flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all",
                          showPossiblePaths 
                            ? "bg-zinc-700 text-white" 
                            : "text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200"
                        )}
                      >
                        <GitBranch className="w-3.5 h-3.5" />
                        Paths
                      </button>
                      {/* Structure toggle */}
                      <button 
                        onClick={() => setShowStructureInFlow(!showStructureInFlow)}
                        className={cn(
                          "flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all",
                          showStructureInFlow 
                            ? "bg-zinc-700 text-white" 
                            : "text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200"
                        )}
                      >
                        <Layers className="w-3.5 h-3.5" />
                        Structure
                      </button>
                      {/* Preview toggle */}
                      <button 
                        onClick={() => setShowPreviewsInFlow(!showPreviewsInFlow)}
                        className={cn(
                          "flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all",
                          showPreviewsInFlow 
                            ? "bg-zinc-700 text-white" 
                            : "text-zinc-400 hover:bg-zinc-800 hover:text-zinc-200"
                        )}
                      >
                        <Eye className="w-3.5 h-3.5" />
                        Preview
                      </button>
                    </div>
                    
                    {/* Node Detail Panel removed - simplified UI */}
                    
                    
                    <div 
                      ref={archCanvasRef}
                      className={cn("arch-canvas w-full h-full bg-[#111111]", isPanning && !draggingNodeId && "dragging")} style={{ backgroundImage: "radial-gradient(circle, rgba(255,255,255,0.06) 1px, transparent 1px)", backgroundSize: "24px 24px" }}
                      onWheel={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Zoom towards cursor position
                        const rect = archCanvasRef.current?.getBoundingClientRect();
                        if (!rect) return;
                        
                        const delta = e.deltaY > 0 ? -0.08 : 0.08;
                        const newZoom = Math.max(0.25, Math.min(2, archZoom + delta));
                        
                        // Mouse position relative to canvas
                        const mouseX = e.clientX - rect.left;
                        const mouseY = e.clientY - rect.top;
                        
                        // Canvas center (transformOrigin is center)
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        
                        // World position under cursor before zoom
                        const worldX = (mouseX - centerX - canvasPan.x) / archZoom;
                        const worldY = (mouseY - centerY - canvasPan.y) / archZoom;
                        
                        // New pan to keep same world position under cursor
                        const newPanX = mouseX - centerX - worldX * newZoom;
                        const newPanY = mouseY - centerY - worldY * newZoom;
                        
                        setArchZoom(newZoom);
                        setCanvasPan({ x: newPanX, y: newPanY });
                      }}
                      onMouseDown={(e) => {
                        if (!draggingNodeId) handleCanvasMouseDown(e);
                      }}
                      onMouseMove={(e) => {
                        if (draggingNodeId) {
                          // Dragging a node
                          const dx = (e.clientX - dragStartPos.current.x) / archZoom;
                          const dy = (e.clientY - dragStartPos.current.y) / archZoom;
                          setFlowNodes(prev => prev.map(n => 
                            n.id === draggingNodeId 
                              ? { ...n, x: dragStartPos.current.nodeX + dx, y: dragStartPos.current.nodeY + dy }
                              : n
                          ));
                        } else {
                          handleCanvasMouseMove(e);
                        }
                      }}
                      onMouseUp={() => {
                        if (draggingNodeId) {
                          setDraggingNodeId(null);
                        } else {
                          handleCanvasMouseUp();
                        }
                      }}
                      onMouseLeave={() => {
                        setDraggingNodeId(null);
                        handleCanvasMouseUp();
                      }}
                    >
                      <div 
                        className="arch-canvas-inner" 
                        style={{ 
                          transform: `translate(${canvasPan.x}px, ${canvasPan.y}px) scale(${archZoom})`,
                          transformOrigin: 'center center'
                        }}
                      >
                        {/* Edge lines with semantic styling */}
                        <svg 
                          className="absolute pointer-events-none overflow-visible" 
                          style={{ left: 0, top: 0, width: "100%", height: "100%", overflow: "visible" }}
                        >
                          <defs>
                            <marker id="flow-arrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                              <polygon points="0 0, 10 4, 0 8" fill="rgba(255, 255, 255, 0.6)" />
                            </marker>
                            <marker id="flow-arrow-thick" markerWidth="12" markerHeight="9" refX="11" refY="4.5" orient="auto">
                              <polygon points="0 0, 12 4.5, 0 9" fill="rgba(255, 255, 255, 0.7)" />
                            </marker>
                            <marker id="flow-arrow-gated" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                              <polygon points="0 0, 10 4, 0 8" fill="rgba(255, 255, 255, 0.5)" />
                            </marker>
                          </defs>
                          {flowEdges
                            .filter(edge => showPossiblePaths || edge.type !== "possible")
                            .map(edge => {
                            const fromNode = flowNodes.find(n => n.id === edge.from);
                            const toNode = flowNodes.find(n => n.id === edge.to);
                            if (!fromNode || !toNode) return null;
                            // Guard against NaN coordinates (nodes loaded without valid x/y)
                            if (typeof fromNode.x !== 'number' || typeof fromNode.y !== 'number' || isNaN(fromNode.x) || isNaN(fromNode.y)) return null;
                            if (typeof toNode.x !== 'number' || typeof toNode.y !== 'number' || isNaN(toNode.x) || isNaN(toNode.y)) return null;
                            // Hide edges to hidden detected/possible/inferred nodes
                            if (!showPossiblePaths && (toNode.status === "detected" || toNode.status === "possible" || toNode.status === "inferred")) return null;

                            const fromHeight = getFlowNodeHeight(fromNode);
                            const x1 = fromNode.x + FLOW_NODE_WIDTH / 2;
                            const y1 = fromNode.y + fromHeight;
                            const x2 = toNode.x + FLOW_NODE_WIDTH / 2;
                            const y2 = toNode.y;
                            const midX = (x1 + x2) / 2;
                            const midY = (y1 + y2) / 2;
                            
                            // Edge styles: 3-tier system - neutral colors
                            // SOLID = navigation, action, scroll (confirmed from video)
                            // DASHED = gated, hover (detected but not confirmed)
                            // DOTTED = possible (AI inferred)
                            const edgeStyles: Record<string, { stroke: string; width: number; dash?: string; marker: string; labelBg: string }> = {
                              // SOLID lines - observed in video - thicker and more visible
                              navigation: { stroke: "rgba(255, 255, 255, 0.55)", width: 2.5, marker: "url(#flow-arrow-thick)", labelBg: "rgba(10, 10, 10, 0.95)" },
                              action: { stroke: "rgba(255, 255, 255, 0.45)", width: 2, marker: "url(#flow-arrow)", labelBg: "rgba(10, 10, 10, 0.95)" },
                              scroll: { stroke: "rgba(255, 255, 255, 0.35)", width: 2, marker: "url(#flow-arrow)", labelBg: "rgba(10, 10, 10, 0.95)" },
                              // DASHED lines - detected but not visited
                              gated: { stroke: "rgba(255, 255, 255, 0.4)", width: 2, dash: "5 3", marker: "url(#flow-arrow-gated)", labelBg: "rgba(10, 10, 10, 0.95)" },
                              hover: { stroke: "rgba(255, 255, 255, 0.35)", width: 2, dash: "6 4", marker: "url(#flow-arrow-gated)", labelBg: "rgba(20, 20, 20, 0.95)" },
                              // DOTTED lines - AI inferred
                              possible: { stroke: "rgba(255, 255, 255, 0.2)", width: 1.5, dash: "3 3", marker: "url(#flow-arrow-gated)", labelBg: "rgba(20, 20, 20, 0.9)" }
                            };
                            const style = edgeStyles[edge.type] || edgeStyles.action;
                            const isPossible = edge.type === "possible";
                            
                            return (
                              <g key={edge.id} className={isPossible ? "opacity-60" : ""}>
                                <path 
                                  d={`M ${x1} ${y1} Q ${x1} ${midY} ${midX} ${midY} Q ${x2} ${midY} ${x2} ${y2}`}
                                  stroke={style.stroke}
                                  strokeWidth={style.width}
                                  strokeDasharray={style.dash}
                                  fill="none"
                                  markerEnd={style.marker}
                                />
                                {/* Label - smaller and more subtle */}
                                <rect 
                                  x={midX - 36} 
                                  y={midY - 7} 
                                  width="72" 
                                  height="14" 
                                  rx="7" 
                                  fill={style.labelBg}
                                  stroke={isPossible ? "rgba(255, 255, 255, 0.05)" : "rgba(255, 255, 255, 0.12)"}
                                  strokeWidth="1"
                                  strokeDasharray={isPossible ? "3 2" : undefined}
                                />
                                {edge.type === "gated" && (
                                  <text x={midX - 26} y={midY + 2.5} fill="rgba(255, 255, 255, 0.4)" fontSize="8">🔒</text>
                                )}
                                {isPossible && (
                                  <text x={midX - 26} y={midY + 2.5} fill="rgba(255, 255, 255, 0.25)" fontSize="7">○</text>
                                )}
                                <text 
                                  x={edge.type === "gated" || isPossible ? midX + 4 : midX} 
                                  y={midY + 2.5} 
                                  fill={isPossible ? "rgba(255,255,255,0.35)" : "rgba(255,255,255,0.6)"} 
                                  fontSize="8" 
                                  textAnchor="middle" 
                                  className="font-medium"
                                  fontStyle={isPossible ? "italic" : "normal"}
                                >
                                  {edge.label}
                                </text>
                              </g>
                            );
                          })}
                        </svg>
                        
                        {/* Flow Nodes - Draggable */}
                        {flowNodes
                          .filter(node => showPossiblePaths || node.status === "observed" || node.status === "added")
                          .map((node, idx) => {
                          const isObserved = node.status === "observed";
                          const isDetected = node.status === "detected";
                          const isInferred = node.status === "inferred";
                          const isPossible = node.status === "possible" || isInferred;
                          const isAdded = node.status === "added";
                          const typeIcons: Record<string, any> = { view: Layout, section: Layers, modal: Box, state: CheckCircle, loading: Loader2 };
                          const Icon = typeIcons[node.type] || Layout;
                          const isDragging = draggingNodeId === node.id;
                          
                          // For preview thumbnail, use ORIGINAL displayedCode (not editableCode which changes with file selection)
                          const hasCode = (isObserved || isAdded) && displayedCode;
                          const hasPreview = showPreviewsInFlow && hasCode;
                          
                          // Create preview code with page navigation script (use node.id)
                          // IMPORTANT: Use displayedCode here, NOT editableCode - Code tab file selection shouldn't affect Flow
                          const previewCode = hasPreview && displayedCode
                            ? injectPageSelection(displayedCode, node.id)
                            : null;
                          
                          // Fixed width for cleaner layout
                          const nodeWidth = FLOW_NODE_WIDTH;
                          const previewHeight = hasPreview ? FLOW_PREVIEW_HEIGHT : 0;
                          
                          // Dynamic height calculation - matches getFlowNodeHeight
                          const baseHeight = hasPreview ? FLOW_PREVIEW_HEIGHT : 0;
                          const contentHeight = 58 + (node.description ? 24 : 0) + (showStructureInFlow && node.components?.length ? Math.ceil(node.components.length / 2) * 18 + 24 : 0);
                          const totalHeight = getFlowNodeHeight(node) || (baseHeight + contentHeight);
                          
                          // Each iframe gets its own isolated preview code with unique key
                          const iframeKey = `iframe-${node.id}-${showPreviewsInFlow}`;
                          
                          return (
                            <div 
                              key={node.id}
                              className={cn(
                                "absolute select-none group/flownode flex flex-col",
                                "rounded-lg overflow-hidden",
                                isDragging ? "cursor-grabbing z-50 scale-[1.02]" : "cursor-grab transition-shadow duration-200",
                                selectedFlowNode === node.id && "ring-1 ring-[var(--accent-orange)]/50 ring-offset-1 ring-offset-black/80"
                              )}
                              style={{ 
                                left: node.x, 
                                top: node.y,
                                width: nodeWidth,
                                minHeight: totalHeight,
                                opacity: isPossible ? 0.55 : isDetected ? 0.85 : 1,
                                // Minimal border styles
                                background: 'rgba(18,18,20,0.9)',
                                border: isObserved 
                                  ? '1px solid rgba(113, 113, 122, 0.4)' // zinc solid
                                  : isAdded
                                  ? '1px solid rgba(59, 130, 246, 0.3)' // blue solid
                                  : isDetected
                                  ? '1px dashed rgba(113, 113, 122, 0.25)' // zinc dashed
                                  : '1px dotted rgba(255,255,255,0.08)', // gray dotted
                                boxShadow: isDragging
                                  ? '0 12px 24px -8px rgba(0,0,0,0.4)'
                                  : '0 2px 8px -2px rgba(0,0,0,0.2)'
                              }}
                              onMouseDown={(e) => {
                                // Don't start drag if clicking buttons
                                if ((e.target as HTMLElement).closest('.flow-node-btn')) return;
                                e.stopPropagation();
                                setDraggingNodeId(node.id);
                                dragStartPos.current = { 
                                  x: e.clientX, 
                                  y: e.clientY, 
                                  nodeX: node.x, 
                                  nodeY: node.y 
                                };
                              }}
                            >
                              {/* Iframe Preview */}
                              {hasPreview && previewCode && (
                                <div className="relative w-full overflow-hidden bg-[#111111]" style={{ height: previewHeight }}>
                                  <iframe
                                    key={iframeKey}
                                    srcDoc={previewCode}
                                    className="pointer-events-none absolute top-0 left-0 opacity-90 transition-opacity group-hover/flownode:opacity-100"
                                    style={{ 
                                      width: `${nodeWidth * 8}px`,
                                      height: `${previewHeight * 8}px`,
                                      transform: 'scale(0.125)',
                                      transformOrigin: 'top left'
                                    }}
                                    sandbox="allow-scripts allow-same-origin"
                                    referrerPolicy="no-referrer"
                                    title={`Preview: ${node.name}`}
                                  />
                                  {/* Glass overlay on preview */}
                                  <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent" />
                                </div>
                              )}
                              
                              {/* Node header with status badge */}
                              <div className="p-2 pb-1">
                                {/* Top row: Icon + Name + Status Badge */}
                                <div className="flex items-center gap-1.5 mb-1">
                                  {/* Icon - compact */}
                                  <div className={cn(
                                    "w-5 h-5 rounded flex items-center justify-center flex-shrink-0",
                                    isObserved ? "bg-zinc-700/30 text-zinc-300" 
                                    : isAdded ? "bg-blue-500/10 text-blue-400"
                                    : isDetected ? "bg-zinc-700/20 text-zinc-400"
                                    : "bg-zinc-800/50 text-zinc-500"
                                  )}>
                                    <Icon className="w-3 h-3" />
                                  </div>
                                  {/* Name - takes available space */}
                                  <div className="flex-1 min-w-0">
                                    <span className={cn(
                                      "text-[10px] font-medium block leading-tight line-clamp-1", 
                                      isPossible ? "text-zinc-500 italic" : "text-zinc-200"
                                    )} title={node.name}>{node.name}</span>
                                  </div>
                                  {/* Status Badge - minimal */}
                                  <span className={cn(
                                    "text-[7px] px-1 py-0.5 rounded capitalize font-medium flex-shrink-0",
                                    isObserved 
                                      ? "bg-zinc-700/40 text-zinc-400" 
                                      : isAdded
                                      ? "bg-blue-500/20 text-blue-400"
                                      : isDetected
                                      ? "bg-zinc-700/30 text-zinc-500"
                                      : "bg-zinc-800 text-zinc-600"
                                  )}>
                                    {isObserved ? "Observed" : isAdded ? "Generated" : isDetected ? "Detected" : "Possible"}
                                  </span>
                                </div>
                                
                                {/* Description */}
                                {node.description && (
                                  <p className="text-[9px] text-zinc-500 leading-snug line-clamp-2">
                                    {node.description}
                                  </p>
                                )}

                                {/* Structure overlay (Components list) */}
                                <AnimatePresence>
                                  {showStructureInFlow && (
                                    <motion.div 
                                      initial={{ height: 0, opacity: 0 }}
                                      animate={{ height: "auto", opacity: 1 }}
                                      exit={{ height: 0, opacity: 0 }}
                                      className="overflow-hidden"
                                    >
                                      <div className="pt-2 mt-2 border-t border-zinc-800">
                                        <div className="flex items-center gap-1.5 mb-1.5">
                                          <GitBranch className="w-3 h-3 text-white/20" />
                                          <span className="text-[9px] text-zinc-600 uppercase tracking-wider font-medium">Structure</span>
                                        </div>
                                        {node.components && node.components.length > 0 ? (
                                          <div className="flex flex-wrap gap-1">
                                            {node.components.map((comp, i) => (
                                              <div key={i} className="px-1.5 py-0.5 rounded-[4px] bg-zinc-800/50 border border-zinc-800 text-[9px] text-zinc-500">
                                                {comp}
                                              </div>
                                            ))}
                                          </div>
                                        ) : (
                                          <div className="text-[9px] text-white/25 italic">No structure detected</div>
                                        )}
                                      </div>
                                    </motion.div>
                                  )}
                                </AnimatePresence>
                              </div>
                              
                              {/* Action buttons - minimal */}
                              <div className="flex items-center gap-1 px-2 pb-2.5 pt-0.5">
                                {hasCode ? (
                                  <>
                                    <button
                                      className="flow-node-btn flex-1 flex items-center justify-center gap-0.5 py-1 rounded text-[9px] font-medium bg-zinc-800/80 hover:bg-zinc-700 text-zinc-300 transition-colors"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleFlowNodeCodeFocus(node.id, "preview");
                                      }}
                                    >
                                      <Eye className="w-2.5 h-2.5" />
                                      Preview
                                    </button>
                                    <button
                                      className="flow-node-btn flex-1 flex items-center justify-center gap-0.5 py-1 rounded text-[9px] font-medium bg-zinc-800/50 hover:bg-zinc-700 text-zinc-400 transition-colors"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleFlowNodeCodeFocus(node.id, "code");
                                      }}
                                    >
                                      <Code className="w-2.5 h-2.5" />
                                      Code
                                    </button>
                                  </>
                                ) : isDetected ? (
                                  <button
                                    className="flow-node-btn flex-1 flex items-center justify-center gap-0.5 py-1 rounded text-[9px] font-medium bg-zinc-700 hover:bg-zinc-600 text-zinc-300 transition-colors"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (isDemoMode) {
                                        setUpgradeFeature("code");
                                        setShowUpgradeModal(true);
                                        return;
                                      }
                                      if (!user) {
                                        setShowAuthModal(true);
                                        showToast("Sign up free to reconstruct pages!", "info");
                                        return;
                                      }
                                      if (isEditing) return;
                                      setEditInput(`@${node.name} Reconstruct this page based on observed navigation patterns and styling from the main page`);
                                      setShowFloatingEdit(true);
                                    }}
                                    disabled={isEditing}
                                  >
                                    <Plus className="w-2.5 h-2.5" />
                                    Reconstruct
                                  </button>
                                ) : (
                                  <button
                                    className="flow-node-btn flex-1 flex items-center justify-center gap-0.5 py-1 rounded text-[9px] font-medium bg-zinc-800/50 hover:bg-zinc-700 text-zinc-500 transition-colors"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (isDemoMode) {
                                        setUpgradeFeature("code");
                                        setShowUpgradeModal(true);
                                        return;
                                      }
                                      if (!user) {
                                        setShowAuthModal(true);
                                        showToast("Sign up free to generate pages!", "info");
                                        return;
                                      }
                                      if (isEditing) return;
                                      setEditInput(`@${node.name} Create this page with full content. Keep the same design system, colors, navigation header, and footer from existing pages. Include realistic text, proper sections, and interactive elements. Make it production-ready.`);
                                      setShowFloatingEdit(true);
                                    }}
                                    disabled={isEditing}
                                  >
                                    <Plus className="w-3 h-3" />
                                    Generate
                                  </button>
                                )}
                              </div>
                              

                            </div>
                          );
                        })}
                        
                        
                        {flowBuilding && (
                          <div className="absolute top-4 left-4 flex items-center gap-2 text-xs text-zinc-500 bg-zinc-900 px-3 py-2 rounded-lg">
                            <Loader2 className="w-4 h-4 animate-spin text-zinc-300" />
                            Building product map...
                          </div>
                        )}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="w-full h-full flex items-center justify-center">
                    <EmptyState icon="logo" title="No product flow yet" subtitle="Flow shows how the product is connected - views, states, transitions" />
                  </div>
                )}
                
{/* Edit with AI button removed - chat does the same thing */}

                {/* Business Process Architecture Sidebar */}
                <AnimatePresence>
                  {showBusinessProcess && (
                    <motion.div
                      initial={{ width: 0, opacity: 0 }}
                      animate={{ width: 400, opacity: 1 }}
                      exit={{ width: 0, opacity: 0 }}
                      transition={{ duration: 0.2 }}
                      className="absolute top-0 right-0 h-full bg-zinc-950 border-l border-zinc-800 z-30 overflow-hidden flex flex-col"
                    >
                      <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <Network className="w-4 h-4 text-zinc-400" />
                            <h3 className="text-sm font-medium text-white">Business Process Architecture</h3>
                          </div>
                          <button 
                            onClick={() => setShowBusinessProcess(false)}
                            className="p-1 hover:bg-zinc-800 rounded"
                          >
                            <X className="w-4 h-4 text-zinc-500" />
                          </button>
                        </div>

                        {isGeneratingFlows ? (
                          <div className="flex items-center gap-2 text-xs text-zinc-500">
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Analyzing business logic...
                          </div>
                        ) : aiFlows ? (
                          <div className="space-y-4">
                            {/* Process Architecture */}
                            {aiFlows.processArchitecture && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <GitBranch className="w-3.5 h-3.5 text-zinc-500" />
                                  <span className="text-xs font-medium text-zinc-400">{aiFlows.processArchitecture.title || "Process Flow"}</span>
                                </div>
                                <div className="p-3">
                                  {aiFlows.processArchitecture.description && (
                                    <p className="text-xs text-zinc-500 mb-3">{aiFlows.processArchitecture.description}</p>
                                  )}
                                  {aiFlows.processArchitecture.nodes?.length > 0 && (
                                    <div className="space-y-1">
                                      {aiFlows.processArchitecture.nodes.slice(0, 8).map((node: any, i: number) => (
                                        <div key={i} className="flex items-center gap-2 text-[10px]">
                                          <span className={cn(
                                            "w-5 h-5 flex items-center justify-center rounded text-[9px]",
                                            node.type === "decision" ? "bg-amber-500/20 text-amber-400 rotate-45" : 
                                            node.type === "api" ? "bg-blue-500/20 text-blue-400 rounded-full" :
                                            node.type === "start" ? "bg-emerald-500/20 text-emerald-400 rounded-full" :
                                            node.type === "end" ? "bg-zinc-500/20 text-zinc-400 rounded-full" :
                                            "bg-zinc-700 text-zinc-400"
                                          )}>
                                            {node.type === "decision" ? "◇" : node.type === "api" ? "⬤" : "○"}
                                          </span>
                                          <span className="text-zinc-400 flex-1 truncate">{node.label}</span>
                                          <span className="text-zinc-600">{node.type}</span>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Decision Matrix */}
                            {aiFlows.decisionMatrix?.decisions?.length > 0 && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <AlertCircle className="w-3.5 h-3.5 text-amber-500" />
                                  <span className="text-xs font-medium text-zinc-400">Decision Points</span>
                                  <span className="text-[9px] text-zinc-600 ml-auto">{aiFlows.decisionMatrix.decisions.length}</span>
                                </div>
                                <div className="p-2 space-y-2 max-h-48 overflow-y-auto">
                                  {aiFlows.decisionMatrix.decisions.map((dec: any, i: number) => (
                                    <div key={i} className="p-2 rounded bg-zinc-800/50 border border-zinc-700/50">
                                      <p className="text-[10px] font-medium text-zinc-300 mb-1">{dec.name}</p>
                                      <p className="text-[9px] text-zinc-500">{dec.condition}</p>
                                      <div className="flex gap-2 mt-2 text-[9px]">
                                        <span className="text-emerald-400">✓ {dec.truePath}</span>
                                        <span className="text-zinc-500">|</span>
                                        <span className="text-zinc-500">✗ {dec.falsePath}</span>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Event Mapping - Trigger → Action → Result */}
                            {(aiFlows.eventMapping?.length > 0 || flowNodes.length > 0) && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <Zap className="w-3.5 h-3.5 text-yellow-500" />
                                  <span className="text-xs font-medium text-zinc-400">Event Mapping</span>
                                  <button 
                                    onClick={() => {
                                      const events = flowNodes.map(n => `Trigger: ${n.name} click\n  → Action: Navigate to ${n.name}\n  → Result: Show ${n.name} page`).join('\n\n');
                                      navigator.clipboard.writeText(events);
                                      showToast("Events copied!", "success");
                                    }}
                                    className="ml-auto text-[9px] text-zinc-600 hover:text-white"
                                  >
                                    Copy
                                  </button>
                                </div>
                                <div className="p-2 space-y-2 max-h-48 overflow-y-auto">
                                  {(aiFlows.eventMapping || flowNodes.slice(0, 5).map((n: any) => ({
                                    trigger: `${n.name} click`,
                                    action: `Navigate to ${n.name}`,
                                    result: `Render ${n.name} page`,
                                    component: n.components?.[0] || 'Button'
                                  }))).map((event: any, i: number) => (
                                    <div key={i} className="p-2 rounded bg-zinc-800/50 border border-zinc-700/50">
                                      <div className="flex items-center gap-2 text-[9px]">
                                        <span className="px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400">Trigger</span>
                                        <span className="text-zinc-300 font-mono">{event.trigger}</span>
                                      </div>
                                      <div className="flex items-center gap-2 text-[9px] mt-1 ml-4">
                                        <span className="text-zinc-600">→</span>
                                        <span className="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400">Action</span>
                                        <span className="text-zinc-400">{event.action}</span>
                                      </div>
                                      <div className="flex items-center gap-2 text-[9px] mt-1 ml-8">
                                        <span className="text-zinc-600">→</span>
                                        <span className="px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400">Result</span>
                                        <span className="text-zinc-500">{event.result}</span>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* API Contracts with JSON */}
                            {aiFlows.dataContracts?.endpoints?.length > 0 && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <Database className="w-3.5 h-3.5 text-blue-500" />
                                  <span className="text-xs font-medium text-zinc-400">API Contracts</span>
                                  <span className="text-[9px] text-zinc-600 ml-auto">{aiFlows.dataContracts.endpoints.length} endpoints</span>
                                </div>
                                <div className="p-2 space-y-2 max-h-64 overflow-y-auto">
                                  {aiFlows.dataContracts.endpoints.map((api: any, i: number) => (
                                    <div key={i} className="p-2 rounded bg-zinc-800/50 border border-zinc-700/50">
                                      <div className="flex items-center gap-2 mb-2">
                                        <span className={cn(
                                          "px-1.5 py-0.5 rounded text-[8px] font-mono font-bold",
                                          api.method === "GET" ? "bg-emerald-500/20 text-emerald-400" :
                                          api.method === "POST" ? "bg-blue-500/20 text-blue-400" :
                                          api.method === "PUT" ? "bg-amber-500/20 text-amber-400" :
                                          api.method === "DELETE" ? "bg-red-500/20 text-red-400" :
                                          "bg-zinc-500/20 text-zinc-400"
                                        )}>{api.method}</span>
                                        <span className="text-zinc-300 font-mono text-[10px] flex-1 truncate">{api.endpoint}</span>
                                        <button 
                                          onClick={() => {
                                            const contract = `// ${api.method} ${api.endpoint}\n// Request:\n${JSON.stringify(api.request || {}, null, 2)}\n\n// Response:\n${JSON.stringify(api.response || { success: true }, null, 2)}`;
                                            navigator.clipboard.writeText(contract);
                                            showToast("Contract copied!", "success");
                                          }}
                                          className="text-[9px] text-zinc-600 hover:text-white"
                                        >
                                          <Copy className="w-3 h-3" />
                                        </button>
                                      </div>
                                      {api.description && (
                                        <p className="text-[9px] text-zinc-500 mb-2">{api.description}</p>
                                      )}
                                      <div className="grid grid-cols-2 gap-2">
                                        <div>
                                          <span className="text-[8px] text-zinc-600 uppercase">Request</span>
                                          <pre className="text-[9px] text-zinc-400 font-mono bg-zinc-900 rounded p-1.5 mt-1 overflow-x-auto">
                                            {JSON.stringify(api.request || { "...": "payload" }, null, 2)}
                                          </pre>
                                        </div>
                                        <div>
                                          <span className="text-[8px] text-zinc-600 uppercase">Response</span>
                                          <pre className="text-[9px] text-emerald-400/70 font-mono bg-zinc-900 rounded p-1.5 mt-1 overflow-x-auto">
                                            {JSON.stringify(api.response || { success: true }, null, 2)}
                                          </pre>
                                        </div>
                                      </div>
                                      {api.usedIn && (
                                        <div className="mt-2 flex items-center gap-1 text-[8px] text-zinc-600">
                                          <span>Used in:</span>
                                          {api.usedIn.map((page: string, j: number) => (
                                            <span key={j} className="px-1 py-0.5 bg-zinc-800 rounded">{page}</span>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* State Machine */}
                            {aiFlows.stateMachine?.states?.length > 0 && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <Activity className="w-3.5 h-3.5 text-purple-500" />
                                  <span className="text-xs font-medium text-zinc-400">State Machine</span>
                                </div>
                                <div className="p-2 space-y-1">
                                  {aiFlows.stateMachine.states.map((state: any, i: number) => (
                                    <div key={i} className="flex items-center gap-2 p-2 rounded bg-zinc-800/30 text-[10px]">
                                      <span className="w-2 h-2 rounded-full bg-purple-500/50" />
                                      <span className="text-zinc-300 font-medium">{state.name}</span>
                                      {state.uiIndicator && <span className="text-zinc-500 text-[9px] ml-auto">{state.uiIndicator}</span>}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Business Rules */}
                            {aiFlows.businessRules?.rules?.length > 0 && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <Scale className="w-3.5 h-3.5 text-emerald-500" />
                                  <span className="text-xs font-medium text-zinc-400">Business Rules</span>
                                  <span className="text-[9px] text-zinc-600 ml-auto">{aiFlows.businessRules.rules.length}</span>
                                </div>
                                <div className="p-2 space-y-2 max-h-48 overflow-y-auto">
                                  {aiFlows.businessRules.rules.map((rule: any, i: number) => (
                                    <div key={i} className="p-2 rounded bg-zinc-800/50 border border-zinc-700/50">
                                      <div className="flex items-center gap-2 mb-1">
                                        <span className={cn(
                                          "text-[8px] px-1.5 py-0.5 rounded",
                                          rule.type === "validation" ? "bg-emerald-500/20 text-emerald-400" :
                                          rule.type === "conditional" ? "bg-amber-500/20 text-amber-400" :
                                          rule.type === "calculation" ? "bg-blue-500/20 text-blue-400" :
                                          "bg-zinc-500/20 text-zinc-400"
                                        )}>{rule.type}</span>
                                        <span className="text-[10px] font-medium text-zinc-300">{rule.name}</span>
                                      </div>
                                      <p className="text-[9px] text-zinc-500">{rule.description}</p>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* User Journeys */}
                            {aiFlows.userJourneys?.length > 0 && (
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                <div className="px-3 py-2 border-b border-zinc-800 flex items-center gap-2">
                                  <Users className="w-3.5 h-3.5 text-pink-500" />
                                  <span className="text-xs font-medium text-zinc-400">User Journeys</span>
                                </div>
                                <div className="p-2 space-y-2">
                                  {aiFlows.userJourneys.map((journey: any, i: number) => (
                                    <div key={i} className="p-2 rounded bg-zinc-800/50">
                                      <div className="flex items-center gap-2 mb-2">
                                        <span className="text-[10px] font-medium text-zinc-300">{journey.name}</span>
                                        {journey.happyPath && <span className="text-[8px] text-emerald-400">✓ Happy Path</span>}
                                      </div>
                                      {journey.steps?.slice(0, 5).map((step: any, j: number) => (
                                        <div key={j} className="flex items-center gap-2 text-[9px] text-zinc-500 ml-2">
                                          <span className="text-zinc-600">{step.step}.</span>
                                          <span>{step.action}</span>
                                        </div>
                                      ))}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        ) : (
                          <div className="flex flex-col items-center justify-center py-8 text-center">
                            <Network className="w-8 h-8 text-zinc-700 mb-2" />
                            <p className="text-xs text-zinc-500">
                              {generatedCode ? "Click to generate process analysis" : "Generate code first"}
                            </p>
                            {generatedCode && (
                              <button
                                onClick={generateFlows}
                                className="mt-3 px-3 py-1.5 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-xs text-zinc-300 transition-colors"
                              >
                                Analyze Business Logic
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            )}
            

            {/* Design System - Enhanced with Multi-Pass Pipeline outputs */}
            {viewMode === "design" && (
              <div className="flex-1 overflow-auto p-6 relative bg-[#111111]">
                {(isProcessing || isStreamingCode) ? (
                  <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                    <LoadingState />
                  </div>
                ) : generatedCode ? (
                  <div className="max-w-4xl mx-auto space-y-6">
                    <div className="flex items-center gap-2 mb-6"><Paintbrush className="w-5 h-5 text-zinc-300/60" /><h3 className="text-sm font-medium text-zinc-400">Design System</h3></div>
                    
                    {/* Colors - from styleInfo or scanData */}
                    {(styleInfo?.colors || scanData?.ui?.colors) && (
                      <div className="style-card">
                        <div className="flex items-center gap-2 mb-6"><Droplet className="w-4 h-4 text-zinc-300/60" /><span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Colors</span></div>
                        <div className="grid grid-cols-2 gap-4">
                          {styleInfo?.colors ? styleInfo.colors.map((color, i) => (
                            <div key={i} className="flex items-center gap-4 p-3 rounded-lg bg-zinc-900/50 border border-zinc-800/50">
                              <div className="w-16 h-16 rounded-lg flex-shrink-0 shadow-lg" style={{ backgroundColor: color.value, border: '1px solid rgba(255,255,255,0.1)' }} />
                              <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-zinc-200">{color.name}</p>
                                <p className="text-xs text-zinc-400 font-mono mt-0.5">{color.value}</p>
                              </div>
                            </div>
                          )) : Object.entries(scanData?.ui?.colors || {}).slice(0, 6).map(([name, value], i) => {
                            const colorValue = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#888') : String(value));
                            return (
                            <div key={i} className="flex items-center gap-4 p-3 rounded-lg bg-zinc-900/50 border border-zinc-800/50">
                              <div className="w-16 h-16 rounded-lg flex-shrink-0 shadow-lg" style={{ backgroundColor: colorValue, border: '1px solid rgba(255,255,255,0.1)' }} />
                              <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-zinc-200 capitalize">{name}</p>
                                <p className="text-xs text-zinc-400 font-mono mt-0.5">{colorValue}</p>
                              </div>
                            </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    
                    {/* Typography */}
                    {(styleInfo?.fonts || scanData?.ui?.typography) && (
                      <div className="style-card">
                        <div className="flex items-center gap-2 mb-4"><Type className="w-4 h-4 text-zinc-300/60" /><span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Typography</span></div>
                        <div className="p-4 rounded-lg bg-zinc-900/30 border border-zinc-800/30">
                          <p className="text-2xl text-zinc-200" style={{ fontFamily: styleInfo?.fonts?.[0]?.family || scanData?.ui?.typography?.fontFamily || 'Inter' }}>
                            {styleInfo?.fonts?.[0]?.name || scanData?.ui?.typography?.fontFamily || 'Inter'}
                          </p>
                          <p className="text-xs text-zinc-500 mt-1">Primary font</p>
                          <div className="flex gap-4 mt-3 text-[10px] text-zinc-600">
                            <span>400-700</span>
                            <span>•</span>
                            <span>'{styleInfo?.fonts?.[0]?.family || scanData?.ui?.typography?.fontFamily || 'Inter'}', sans-serif</span>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Other Styles */}
                    <div className="grid grid-cols-3 gap-4">
                      <div className="style-card"><p className="text-[10px] text-zinc-500 uppercase mb-2">Spacing</p><p className="text-sm text-zinc-400">{styleInfo?.spacing || 'Tailwind spacing scale'}</p></div>
                      <div className="style-card"><p className="text-[10px] text-zinc-500 uppercase mb-2">Border Radius</p><p className="text-sm text-zinc-400">{styleInfo?.borderRadius || 'Medium (8px)'}</p></div>
                      <div className="style-card"><p className="text-[10px] text-zinc-500 uppercase mb-2">Shadows</p><p className="text-sm text-zinc-400">{styleInfo?.shadows || 'Subtle shadows'}</p></div>
                    </div>
                    
                    {/* Enterprise Package Download - PROMINENT */}
                    <div className="style-card bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border-emerald-500/20">
                      <button
                        onClick={downloadEnterprisePackage}
                        disabled={isDownloadingPackage}
                        className="w-full flex items-center justify-center gap-3 py-4 text-emerald-400 hover:text-emerald-300 transition-colors disabled:opacity-50"
                      >
                        {isDownloadingPackage ? (
                          <>
                            <div className="w-5 h-5 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin" />
                            <span className="text-sm font-medium">Packaging...</span>
                          </>
                        ) : (
                          <>
                            <Download className="w-5 h-5" />
                            <span className="text-sm font-medium">Download Enterprise Package</span>
                          </>
                        )}
                      </button>
                      <p className="text-[10px] text-zinc-600 text-center mt-2">
                        Includes production-ready code, API specs, documentation, design tokens, and deployment configs. Ready for backend integration.
                      </p>
                    </div>
                    
                    {/* Package Contents */}
                    <div className="style-card">
                      <div className="flex items-center gap-2 mb-4">
                        <Package className="w-4 h-4 text-zinc-300/60" />
                        <span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Package Contents</span>
                        <span className="text-[10px] text-zinc-600 ml-auto">{12 + (apiContracts ? 2 : 0) + (debtAudit ? 2 : 0) + (e2eTests ? 4 : 0)} files</span>
                      </div>
                      <div className="space-y-1">
                        {/* Source Code */}
                        <div className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30">
                          <Code className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">Source Code</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">3 files</span>
                          <Check className="w-3 h-3 text-emerald-500" />
                        </div>
                        <div className="ml-6 space-y-0.5 text-[10px] text-zinc-600">
                          <p>├─ 1-source-code/index.html</p>
                          <p>├─ 2-source-code/package.json</p>
                          <p>└─ 3-source-code/tsconfig.json</p>
                        </div>
                        
                        {/* API Specs */}
                        <div 
                          className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30 cursor-pointer hover:bg-zinc-800/50 transition-colors"
                          onClick={() => !apiContracts && !isGeneratingApiContracts && generateApiContracts()}
                        >
                          <Plug className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">API Specs</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">2 files</span>
                          {isGeneratingApiContracts ? (
                            <div className="w-3 h-3 border border-zinc-500 border-t-transparent rounded-full animate-spin" />
                          ) : apiContracts ? (
                            <Check className="w-3 h-3 text-emerald-500" />
                          ) : (
                            <ChevronRight className="w-3 h-3 text-zinc-600" />
                          )}
                        </div>
                        
                        {/* Documentation */}
                        <div className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30 cursor-pointer hover:bg-zinc-800/50 transition-colors">
                          <FileText className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">Documentation</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">4 files</span>
                          {(aiDocsOverview || aiDocsApi || aiDocsQa || aiDocsDeploy) ? (
                            <Check className="w-3 h-3 text-emerald-500" />
                          ) : (
                            <ChevronRight className="w-3 h-3 text-zinc-600" />
                          )}
                        </div>
                        
                        {/* Design System / Debt Audit */}
                        <div 
                          className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30 cursor-pointer hover:bg-zinc-800/50 transition-colors"
                          onClick={() => !debtAudit && !isGeneratingDebtAudit && generateDebtAudit()}
                        >
                          <Paintbrush className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">Design System</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">2 files</span>
                          {isGeneratingDebtAudit ? (
                            <div className="w-3 h-3 border border-zinc-500 border-t-transparent rounded-full animate-spin" />
                          ) : (debtAudit || aiDesignSystem) ? (
                            <Check className="w-3 h-3 text-emerald-500" />
                          ) : (
                            <ChevronRight className="w-3 h-3 text-zinc-600" />
                          )}
                        </div>
                        
                        {/* Quality Assurance */}
                        <div 
                          className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30 cursor-pointer hover:bg-zinc-800/50 transition-colors"
                          onClick={() => !e2eTests && !isGeneratingE2ETests && generateE2ETests()}
                        >
                          <CheckSquare className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">Quality Assurance</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">4 files</span>
                          {isGeneratingE2ETests ? (
                            <div className="w-3 h-3 border border-zinc-500 border-t-transparent rounded-full animate-spin" />
                          ) : (e2eTests || aiDocsQa) ? (
                            <Check className="w-3 h-3 text-emerald-500" />
                          ) : (
                            <ChevronRight className="w-3 h-3 text-zinc-600" />
                          )}
                        </div>
                        
                        {/* Deployment */}
                        <div className="flex items-center gap-2 py-2 px-3 rounded-md bg-zinc-900/30">
                          <Rocket className="w-3.5 h-3.5 text-zinc-500" />
                          <span className="text-xs text-zinc-400">Deployment</span>
                          <span className="text-[10px] text-zinc-600 ml-auto">2 files</span>
                          {aiDocsDeploy ? (
                            <Check className="w-3 h-3 text-emerald-500" />
                          ) : (
                            <ChevronRight className="w-3 h-3 text-zinc-600" />
                          )}
                        </div>
                        
                        {/* Enterprise Package */}
                        <div className="flex items-center gap-2 py-2 px-3 rounded-md bg-emerald-500/10 border border-emerald-500/20 mt-2">
                          <Sparkles className="w-3.5 h-3.5 text-emerald-500" />
                          <span className="text-xs text-emerald-400">Enterprise Package</span>
                          <span className="text-[10px] text-emerald-600 ml-auto">Complete ZIP</span>
                        </div>
                      </div>
                      <p className="text-[10px] text-zinc-600 mt-3 pt-3 border-t border-zinc-800">
                        Includes production-ready code, API specs, documentation, design tokens, and deployment configs. Ready for backend integration.
                      </p>
                    </div>
                    
                  </div>
                ) : (
                  <div className="w-full h-full flex items-center justify-center">
                    <EmptyState icon="logo" title="No style info yet" subtitle="Generate code to see the design system" />
                  </div>
                )}
              </div>
            )}

            {/* Docs - Documentation with sub-tabs */}
            {viewMode === "docs" && (
              <div className="flex-1 overflow-hidden flex flex-col bg-[#111111]">
                {/* Sub-tabs navigation */}
                <div className="flex items-center gap-1 p-3 border-b border-white/[0.06] bg-[#141414]">
                  {[
                    { id: "overview", icon: FileText, label: "Audit" },
                    { id: "api", icon: Plug, label: "Contracts" },
                    { id: "qa", icon: CheckSquare, label: "QA" },
                    { id: "deploy", icon: Rocket, label: "Handoff" },
                  ].map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => setDocsSubTab(tab.id as DocsSubTab)}
                      className={cn(
                        "flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-all",
                        docsSubTab === tab.id
                          ? "text-white bg-zinc-700"
                          : "text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800/50"
                      )}
                    >
                      <tab.icon className="w-3.5 h-3.5" />
                      {tab.label}
                    </button>
                  ))}
                </div>

                {/* Sub-tab content */}
                <div className="flex-1 overflow-auto p-6">
                  {(isProcessing || isStreamingCode) ? (
                    <div className="w-full h-full flex items-center justify-center">
                      <LoadingState />
                    </div>
                  ) : !generatedCode ? (
                    <div className="w-full h-full flex items-center justify-center">
                      <EmptyState icon="logo" title="No documentation yet" subtitle="Generate code to see documentation" />
                    </div>
                  ) : (
                    <div className="max-w-4xl mx-auto">
                      {/* Overview Sub-tab - AI Generated */}
                      {docsSubTab === "overview" && (
                        <div className="space-y-6">
                          {isGeneratingDocs === "overview" ? (
                            <div className="flex flex-col items-center justify-center py-20">
                              <div className="relative w-10 h-10 mb-4">
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-700" />
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-400 border-t-transparent animate-spin" />
                              </div>
                              <p className="text-sm text-zinc-500">Generating documentation...</p>
                            </div>
                          ) : aiDocsOverview ? (
                            <>
                              {/* Header - Clean style */}
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <div className="w-8 h-8 rounded-lg bg-zinc-800 flex items-center justify-center">
                                    <FileText className="w-4 h-4 text-zinc-400" />
                                  </div>
                                  <div>
                                    <h2 className="text-sm font-medium text-white">{aiDocsOverview.title || activeGeneration?.title || "Project"}</h2>
                                    <div className="flex items-center gap-2 mt-0.5">
                                      <span className="text-[10px] text-zinc-500">{aiDocsOverview.industry || "SaaS"}</span>
                                      <span className="text-zinc-700">•</span>
                                      <span className="text-[10px] text-zinc-600">AI Generated</span>
                                    </div>
                                  </div>
                                </div>
                                <button onClick={() => generateDocs("overview")} className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors">
                                  <RefreshCw className="w-3.5 h-3.5 text-zinc-500" />
                                </button>
                              </div>

                              {/* AI Description */}
                              {aiDocsOverview.description && (
                                <p className="text-xs text-zinc-500 leading-relaxed mt-3">
                                  {aiDocsOverview.description}
                                </p>
                              )}

                              {/* Stats Grid */}
                              <div className="grid grid-cols-4 gap-2 mt-4">
                                <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                  <p className="text-xl font-semibold text-zinc-300">{aiDocsOverview.stats?.screens || flowNodes.filter(n => n.status === "observed").length}</p>
                                  <p className="text-[10px] text-zinc-600">Screens</p>
                                </div>
                                <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                  <p className="text-xl font-semibold text-zinc-300">{aiDocsOverview.stats?.components || (editableCode?.split("function ").length || 1)}</p>
                                  <p className="text-[10px] text-zinc-600">Components</p>
                                </div>
                                <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                  <p className="text-xl font-semibold text-zinc-300">{aiDocsOverview.stats?.apiEndpoints || "~5"}</p>
                                  <p className="text-[10px] text-zinc-600">API Endpoints</p>
                                </div>
                                <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                  <p className="text-xl font-semibold text-zinc-300">{aiDocsOverview.stats?.designTokens || styleInfo?.colors?.length || 5}</p>
                                  <p className="text-[10px] text-zinc-600">Design Tokens</p>
                                </div>
                              </div>

                              {/* Features */}
                              {aiDocsOverview.features?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden mt-4">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Features</h3>
                                  </div>
                                  <div className="p-3 grid grid-cols-2 gap-1.5">
                                    {aiDocsOverview.features.map((feature: string, i: number) => (
                                      <div key={i} className="flex items-center gap-2 p-2 rounded bg-zinc-800/30">
                                        <div className="w-1 h-1 rounded-full bg-zinc-500" />
                                        <span className="text-xs text-zinc-400">{feature}</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Architecture */}
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden mt-4">
                                <div className="px-4 py-2.5 border-b border-zinc-800">
                                  <h3 className="text-xs font-medium text-zinc-400">Architecture</h3>
                                </div>
                                <pre className="p-4 text-[11px] text-zinc-500 font-mono overflow-x-auto whitespace-pre">
{aiDocsOverview.fileStructure || `/src
├── /components
│   ├── /ui          # Base shadcn/ui components
│   └── /features    # Business logic components
├── /hooks           # Custom React hooks
├── /services        # API client & services
├── /types           # TypeScript definitions
├── /utils           # Helper functions
└── /config          # App configuration`}
                                </pre>
                              </div>

                              {/* Quick Start */}
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden mt-4">
                                <div className="px-4 py-2.5 border-b border-zinc-800">
                                  <h3 className="text-xs font-medium text-zinc-400">Quick Start</h3>
                                </div>
                                <div className="p-3 space-y-2">
                                  {(aiDocsOverview.quickStart || [
                                    { step: 1, title: "Download", description: "Go to Design tab → Download Enterprise Package" },
                                    { step: 2, title: "Install", command: "npm install" },
                                    { step: 3, title: "Run", command: "npm run dev" }
                                  ]).map((item: any, i: number) => (
                                    <div key={i} className="flex items-start gap-2.5 p-2 rounded hover:bg-zinc-800/30">
                                      <span className="w-5 h-5 rounded bg-zinc-800 flex items-center justify-center text-[10px] font-medium text-zinc-500">{item.step || i + 1}</span>
                                      <div className="flex-1">
                                        <p className="text-xs text-zinc-300">{item.title}</p>
                                        {item.description && <p className="text-[10px] text-zinc-600">{item.description}</p>}
                                        {item.command && <code className="text-[10px] text-zinc-400 bg-zinc-800 px-1.5 py-0.5 rounded mt-1 inline-block font-mono">{item.command}</code>}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Technologies */}
                              <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden mt-4">
                                <div className="px-4 py-2.5 border-b border-zinc-800">
                                  <h3 className="text-xs font-medium text-zinc-400">Technology Stack</h3>
                                </div>
                                <div className="p-3 space-y-2.5">
                                  {aiDocsOverview.architecture && Object.entries(aiDocsOverview.architecture).map(([category, techs]: [string, any]) => (
                                    <div key={category}>
                                      <p className="text-[9px] text-zinc-600 uppercase tracking-wider mb-1.5">{category}</p>
                                      <div className="flex flex-wrap gap-1.5">
                                        {(Array.isArray(techs) ? techs : [techs]).map((tech: string, i: number) => (
                                          <span key={i} className="px-2 py-0.5 rounded bg-zinc-800 text-[10px] text-zinc-500">
                                            {tech}
                                          </span>
                                        ))}
                                      </div>
                                    </div>
                                  ))}
                                  {!aiDocsOverview.architecture && (
                                    <div className="flex flex-wrap gap-1.5">
                                      {["React 18", "TypeScript", "Tailwind CSS", "shadcn/ui", "Radix UI", "React Query", "Zod"].map((tech) => (
                                        <span key={tech} className="px-2 py-0.5 rounded bg-zinc-800 text-[10px] text-zinc-500">
                                          {tech}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            </>
                          ) : (
                            /* Waiting for code generation */
                            <div className="flex flex-col items-center justify-center py-16">
                              <FileText className="w-10 h-10 text-zinc-700 mb-3" />
                              <p className="text-sm text-zinc-400 mb-2">Migration Audit</p>
                              <p className="text-xs text-zinc-600">
                                {generatedCode ? "Generating documentation..." : "Waiting for code generation to complete..."}
                              </p>
                              {generatedCode && (
                                <div className="mt-4">
                                  <div className="w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin" />
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {/* API Sub-tab - AI Generated */}
                      {docsSubTab === "api" && (
                        <div className="space-y-4">
                          {isGeneratingDocs === "api" ? (
                            <div className="flex flex-col items-center justify-center py-20">
                              <div className="relative w-10 h-10 mb-4">
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-700" />
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-400 border-t-transparent animate-spin" />
                              </div>
                              <p className="text-sm text-zinc-500">Generating API documentation...</p>
                            </div>
                          ) : aiDocsApi ? (
                            <>
                              {/* Header */}
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <div className="w-8 h-8 rounded-lg bg-zinc-800 flex items-center justify-center">
                                    <Plug className="w-4 h-4 text-zinc-400" />
                                  </div>
                                  <div>
                                    <h2 className="text-sm font-medium text-white">API Integration</h2>
                                    <p className="text-[10px] text-zinc-600">Backend specifications • AI Generated</p>
                                  </div>
                                </div>
                                <button onClick={() => generateDocs("api")} className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors">
                                  <RefreshCw className="w-3.5 h-3.5 text-zinc-500" />
                                </button>
                              </div>

                              {/* Endpoints */}
                              {aiDocsApi.endpoints?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Endpoints</h3>
                                  </div>
                                  <div className="divide-y divide-zinc-800/50">
                                    {aiDocsApi.endpoints.slice(0, 10).map((endpoint: any, i: number) => (
                                      <div key={i} className="px-4 py-3 hover:bg-zinc-800/30 transition-colors">
                                        <div className="flex items-center gap-2 mb-1">
                                          <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold ${
                                            endpoint.method === "GET" ? "bg-zinc-700 text-zinc-300" :
                                            endpoint.method === "POST" ? "bg-zinc-700 text-zinc-300" :
                                            endpoint.method === "PUT" ? "bg-zinc-700 text-zinc-300" :
                                            "bg-zinc-700 text-zinc-300"
                                          }`}>{endpoint.method}</span>
                                          <code className="text-xs text-zinc-300 font-mono">{endpoint.path}</code>
                                        </div>
                                        <p className="text-[11px] text-zinc-500">{endpoint.description}</p>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* OpenAPI Spec */}
                              {aiDocsApi.openApiSpec && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800 flex items-center justify-between">
                                    <h3 className="text-xs font-medium text-zinc-400">OpenAPI 3.0 Spec</h3>
                                    <button 
                                      onClick={() => {
                                        navigator.clipboard.writeText(aiDocsApi.openApiSpec);
                                        showToast("Copied!", "success");
                                      }}
                                      className="text-[10px] text-zinc-500 hover:text-zinc-300 flex items-center gap-1"
                                    >
                                      <Copy className="w-3 h-3" /> Copy
                                    </button>
                                  </div>
                                  <pre className="p-4 text-[11px] text-zinc-500 font-mono overflow-x-auto max-h-48">{aiDocsApi.openApiSpec}</pre>
                                </div>
                              )}

                              {/* Data Models */}
                              {aiDocsApi.dataModels?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Data Models</h3>
                                  </div>
                                  <div className="p-4 space-y-3">
                                    {aiDocsApi.dataModels.map((model: any, i: number) => (
                                      <div key={i}>
                                        <p className="text-xs font-medium text-zinc-300 mb-1">{model.name}</p>
                                        <div className="flex flex-wrap gap-1.5">
                                          {model.fields?.map((field: any, j: number) => (
                                            <span key={j} className="px-2 py-0.5 rounded bg-zinc-800 text-[10px] text-zinc-500 font-mono">
                                              {field.name}: {field.type}
                                            </span>
                                          ))}
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Backend Checklist */}
                              {aiDocsApi.backendChecklist?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Implementation Checklist</h3>
                                  </div>
                                  <div className="p-3 space-y-1">
                                    {aiDocsApi.backendChecklist.map((item: any, i: number) => (
                                      <label key={i} className="flex items-center gap-2.5 p-2 rounded hover:bg-zinc-800/30 cursor-pointer group">
                                        <input type="checkbox" className="w-3.5 h-3.5 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                        <span className="text-xs text-zinc-500 group-hover:text-zinc-400">{item.item || item}</span>
                                        {item.priority && <span className="text-[9px] text-zinc-600 ml-auto">{item.priority}</span>}
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </>
                          ) : (
                            /* Waiting for code generation */
                            <div className="flex flex-col items-center justify-center py-16">
                              <Plug className="w-10 h-10 text-zinc-700 mb-3" />
                              <p className="text-sm text-zinc-400 mb-2">Data Contracts</p>
                              <p className="text-xs text-zinc-600">
                                {generatedCode ? "Generating documentation..." : "Waiting for code generation to complete..."}
                              </p>
                              {generatedCode && (
                                <div className="mt-4">
                                  <div className="w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin" />
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {/* QA Sub-tab - AI Generated */}
                      {docsSubTab === "qa" && (
                        <div className="space-y-4">
                          {isGeneratingDocs === "qa" ? (
                            <div className="flex flex-col items-center justify-center py-20">
                              <div className="relative w-10 h-10 mb-4">
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-700" />
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-400 border-t-transparent animate-spin" />
                              </div>
                              <p className="text-sm text-zinc-500">Generating QA checklist...</p>
                            </div>
                          ) : aiDocsQa ? (
                            <>
                              {/* Header */}
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <div className="w-8 h-8 rounded-lg bg-zinc-800 flex items-center justify-center">
                                    <CheckSquare className="w-4 h-4 text-zinc-400" />
                                  </div>
                                  <div>
                                    <h2 className="text-sm font-medium text-white">Quality Assurance</h2>
                                    <p className="text-[10px] text-zinc-600">Testing checklist • AI Generated</p>
                                  </div>
                                </div>
                                <button onClick={() => generateDocs("qa")} className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors">
                                  <RefreshCw className="w-3.5 h-3.5 text-zinc-500" />
                                </button>
                              </div>

                              {/* Performance Baseline */}
                              {aiDocsQa.performanceBaseline?.modernTarget && (
                                <div className="grid grid-cols-4 gap-2">
                                  <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                    <p className="text-lg font-semibold text-zinc-300">{aiDocsQa.performanceBaseline.modernTarget.lcp || "< 2.5s"}</p>
                                    <p className="text-[10px] text-zinc-600">LCP</p>
                                  </div>
                                  <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                    <p className="text-lg font-semibold text-zinc-300">{aiDocsQa.performanceBaseline.modernTarget.fid || "< 100ms"}</p>
                                    <p className="text-[10px] text-zinc-600">FID</p>
                                  </div>
                                  <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                    <p className="text-lg font-semibold text-zinc-300">{aiDocsQa.performanceBaseline.modernTarget.cls || "< 0.1"}</p>
                                    <p className="text-[10px] text-zinc-600">CLS</p>
                                  </div>
                                  <div className="p-3 rounded-lg bg-zinc-900 border border-zinc-800">
                                    <p className="text-lg font-semibold text-zinc-300">{aiDocsQa.performanceBaseline.modernTarget.ttfb || "< 600ms"}</p>
                                    <p className="text-[10px] text-zinc-600">TTFB</p>
                                  </div>
                                </div>
                              )}

                              {/* Behavioral Tests */}
                              {aiDocsQa.behavioralTests?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Behavioral Tests</h3>
                                  </div>
                                  <div className="p-3 space-y-1 max-h-64 overflow-y-auto">
                                    {aiDocsQa.behavioralTests.map((test: any, i: number) => (
                                      <label key={i} className="flex items-start gap-2.5 p-2 rounded hover:bg-zinc-800/30 cursor-pointer group">
                                        <input type="checkbox" className="w-3.5 h-3.5 mt-0.5 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                        <div className="flex-1 min-w-0">
                                          <p className="text-xs text-zinc-400 group-hover:text-zinc-300">{test.scenario || test.testId}</p>
                                          {test.given && <p className="text-[9px] text-zinc-600 mt-0.5">Given: {test.given}</p>}
                                          {test.then && <p className="text-[9px] text-zinc-500 mt-0.5">Then: {test.then}</p>}
                                        </div>
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Accessibility Audit */}
                              {aiDocsQa.accessibilityAudit?.improvements?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800 flex items-center justify-between">
                                    <h3 className="text-xs font-medium text-zinc-400">Accessibility (WCAG {aiDocsQa.accessibilityAudit.wcagLevel || "AA"})</h3>
                                    <span className="text-[9px] text-zinc-500">{aiDocsQa.accessibilityAudit.issuesFixed || 0} fixed</span>
                                  </div>
                                  <div className="p-3 space-y-1">
                                    {aiDocsQa.accessibilityAudit.improvements.map((item: any, i: number) => (
                                      <label key={i} className="flex items-start gap-2.5 p-2 rounded hover:bg-zinc-800/30 cursor-pointer group">
                                        <input type="checkbox" defaultChecked={item.modernStatus?.includes("✅")} className="w-3.5 h-3.5 mt-0.5 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                        <div className="flex-1">
                                          <p className="text-xs text-zinc-400 group-hover:text-zinc-300">{item.issue}</p>
                                          {item.wcagCriteria && <p className="text-[9px] text-zinc-600 mt-0.5">WCAG {item.wcagCriteria}</p>}
                                        </div>
                                        <span className="text-[9px] text-zinc-500">{item.modernStatus}</span>
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Security Checklist */}
                              {aiDocsQa.securityChecklist?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Security</h3>
                                  </div>
                                  <div className="p-3 space-y-2">
                                    {aiDocsQa.securityChecklist.map((category: any, i: number) => (
                                      <div key={i}>
                                        <p className="text-[10px] text-zinc-500 mb-1">{category.category}</p>
                                        {category.checks?.map((check: any, j: number) => (
                                          <label key={j} className="flex items-center gap-2.5 p-2 rounded hover:bg-zinc-800/30 cursor-pointer group">
                                            <input type="checkbox" defaultChecked={check.status?.includes("✅")} className="w-3.5 h-3.5 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                            <span className="text-xs text-zinc-500 group-hover:text-zinc-400 flex-1">{check.item}</span>
                                            <span className="text-[9px] text-zinc-600">{check.status}</span>
                                          </label>
                                        ))}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Sign-off Checklist */}
                              {aiDocsQa.signOffChecklist?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Sign-off Checklist</h3>
                                  </div>
                                  <div className="p-3 space-y-1">
                                    {aiDocsQa.signOffChecklist.map((item: any, i: number) => (
                                      <label key={i} className="flex items-center gap-2.5 p-2 rounded hover:bg-zinc-800/30 cursor-pointer group">
                                        <input type="checkbox" className="w-3.5 h-3.5 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                        <span className="text-xs text-zinc-500 group-hover:text-zinc-400 flex-1">{item.requirement}</span>
                                        <span className="text-[9px] text-zinc-600">{item.stakeholder}</span>
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </>
                          ) : (
                            /* Waiting for code generation */
                            <div className="flex flex-col items-center justify-center py-16">
                              <CheckSquare className="w-10 h-10 text-zinc-700 mb-3" />
                              <p className="text-sm text-zinc-400 mb-2">Traceability Tests</p>
                              <p className="text-xs text-zinc-600">
                                {generatedCode ? "Generating documentation..." : "Waiting for code generation to complete..."}
                              </p>
                              {generatedCode && (
                                <div className="mt-4">
                                  <div className="w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin" />
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {/* Deploy Sub-tab - AI Generated */}
                      {docsSubTab === "deploy" && (
                        <div className="space-y-4">
                          {isGeneratingDocs === "deploy" ? (
                            <div className="flex flex-col items-center justify-center py-20">
                              <div className="relative w-10 h-10 mb-4">
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-700" />
                                <div className="absolute inset-0 rounded-full border-2 border-zinc-400 border-t-transparent animate-spin" />
                              </div>
                              <p className="text-sm text-zinc-500">Generating deployment guide...</p>
                            </div>
                          ) : aiDocsDeploy ? (
                            <>
                              {/* Header */}
                              <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  <div className="w-8 h-8 rounded-lg bg-zinc-800 flex items-center justify-center">
                                    <Rocket className="w-4 h-4 text-zinc-400" />
                                  </div>
                                  <div>
                                    <h2 className="text-sm font-medium text-white">Deployment</h2>
                                    <p className="text-[10px] text-zinc-600">Production guide • AI Generated</p>
                                  </div>
                                </div>
                                <button onClick={() => generateDocs("deploy")} className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors">
                                  <RefreshCw className="w-3.5 h-3.5 text-zinc-500" />
                                </button>
                              </div>

                              {/* Dockerfile */}
                              {aiDocsDeploy.dockerfile && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800 flex items-center justify-between">
                                    <h3 className="text-xs font-medium text-zinc-400">Dockerfile</h3>
                                    <button 
                                      onClick={() => {
                                        navigator.clipboard.writeText(aiDocsDeploy.dockerfile);
                                        showToast("Copied!", "success");
                                      }}
                                      className="text-[10px] text-zinc-500 hover:text-zinc-300 flex items-center gap-1"
                                    >
                                      <Copy className="w-3 h-3" /> Copy
                                    </button>
                                  </div>
                                  <pre className="p-4 text-[11px] text-zinc-500 font-mono overflow-x-auto max-h-40">{aiDocsDeploy.dockerfile}</pre>
                                </div>
                              )}

                              {/* Environment Variables */}
                              {aiDocsDeploy.envVariables?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Environment Variables</h3>
                                  </div>
                                  <div className="divide-y divide-zinc-800/50">
                                    {aiDocsDeploy.envVariables.map((env: any, i: number) => (
                                      <div key={i} className="px-4 py-2.5">
                                        <div className="flex items-center gap-2">
                                          <code className="text-xs text-zinc-300 font-mono">{env.name}</code>
                                          {env.required && <span className="text-[9px] text-zinc-600">required</span>}
                                        </div>
                                        <p className="text-[10px] text-zinc-600 mt-0.5">{env.description}</p>
                                        {env.example && <code className="text-[10px] text-zinc-500 font-mono">{env.example}</code>}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* CI/CD */}
                              {aiDocsDeploy.cicd?.workflow && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800 flex items-center justify-between">
                                    <h3 className="text-xs font-medium text-zinc-400">{aiDocsDeploy.cicd.platform || "CI/CD"}</h3>
                                    <button 
                                      onClick={() => {
                                        navigator.clipboard.writeText(aiDocsDeploy.cicd.workflow);
                                        showToast("Copied!", "success");
                                      }}
                                      className="text-[10px] text-zinc-500 hover:text-zinc-300 flex items-center gap-1"
                                    >
                                      <Copy className="w-3 h-3" /> Copy
                                    </button>
                                  </div>
                                  <pre className="p-4 text-[11px] text-zinc-500 font-mono overflow-x-auto max-h-40">{aiDocsDeploy.cicd.workflow}</pre>
                                </div>
                              )}

                              {/* Deploy Platforms */}
                              {aiDocsDeploy.platforms?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Deploy Platforms</h3>
                                  </div>
                                  <div className="p-3 grid grid-cols-3 gap-2">
                                    {aiDocsDeploy.platforms.map((platform: any, i: number) => (
                                      <div key={i} className={`p-3 rounded-lg text-center ${platform.recommended ? "bg-zinc-800 border border-zinc-700" : "bg-zinc-800/50"}`}>
                                        <p className="text-xs font-medium text-zinc-300">{platform.name}</p>
                                        {platform.recommended && <p className="text-[9px] text-zinc-500 mt-0.5">Recommended</p>}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Production Checklist */}
                              {aiDocsDeploy.productionChecklist?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Production Checklist</h3>
                                  </div>
                                  <div className="p-3 space-y-3">
                                    {aiDocsDeploy.productionChecklist.map((category: any, i: number) => (
                                      <div key={i}>
                                        <p className="text-[10px] text-zinc-500 uppercase tracking-wider mb-1.5">{category.category}</p>
                                        <div className="space-y-1">
                                          {category.items?.map((item: string, j: number) => (
                                            <label key={j} className="flex items-center gap-2.5 p-1.5 rounded hover:bg-zinc-800/30 cursor-pointer">
                                              <input type="checkbox" className="w-3 h-3 rounded border-zinc-700 bg-zinc-800 text-zinc-400" />
                                              <span className="text-xs text-zinc-500">{item}</span>
                                            </label>
                                          ))}
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}

                              {/* Troubleshooting */}
                              {aiDocsDeploy.troubleshooting?.length > 0 && (
                                <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden">
                                  <div className="px-4 py-2.5 border-b border-zinc-800">
                                    <h3 className="text-xs font-medium text-zinc-400">Troubleshooting</h3>
                                  </div>
                                  <div className="divide-y divide-zinc-800/50">
                                    {aiDocsDeploy.troubleshooting.slice(0, 5).map((issue: any, i: number) => (
                                      <div key={i} className="px-4 py-3">
                                        <p className="text-xs text-zinc-300 font-medium">{issue.issue}</p>
                                        <p className="text-[10px] text-zinc-600 mt-1">→ {issue.solution}</p>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </>
                          ) : (
                            /* Waiting for code generation */
                            <div className="flex flex-col items-center justify-center py-16">
                              <Rocket className="w-10 h-10 text-zinc-700 mb-3" />
                              <p className="text-sm text-zinc-400 mb-2">Handoff Guide</p>
                              <p className="text-xs text-zinc-600">
                                {generatedCode ? "Generating documentation..." : "Waiting for code generation to complete..."}
                              </p>
                              {generatedCode && (
                                <div className="mt-4">
                                  <div className="w-6 h-6 border-2 border-zinc-700 border-t-zinc-400 rounded-full animate-spin" />
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Library - Storybook-like component library */}
            {viewMode === "library" && (
              <div className="flex-1 overflow-hidden flex bg-[#111111]">
                {/* Fullscreen Preview Overlay */}
                {isLibraryFullscreen && (() => {
                  const compId = selectedLibraryItem?.startsWith("comp-") 
                    ? selectedLibraryItem.replace("comp-", "")
                    : null;
                  const selectedComponent = compId
                    ? libraryData?.components?.find((c: any) => c.id === compId || c.id === selectedLibraryItem || `comp-${c.id}` === selectedLibraryItem)
                    : null;
                  return selectedComponent?.code ? (
                    <div className="fixed inset-0 z-50 bg-[#111111] flex flex-col">
                      {/* Fullscreen Header */}
                      <div className="flex-shrink-0 h-12 border-b border-zinc-800 bg-zinc-900 flex items-center justify-between px-4">
                        <div className="flex items-center gap-3">
                          <span className="text-sm font-medium text-white">{selectedComponent.name}</span>
                          <span className="text-xs text-zinc-500">Fullscreen Preview</span>
                        </div>
                        <div className="flex items-center gap-2">
                          {/* Viewport toggles */}
                          <button 
                            onClick={() => setLibraryViewport("mobile")}
                            className={cn("p-2 rounded-md", libraryViewport === "mobile" ? "bg-zinc-700 text-white" : "hover:bg-zinc-800 text-zinc-400")} 
                          >
                            <Smartphone className="w-4 h-4" />
                          </button>
                          <button 
                            onClick={() => setLibraryViewport("desktop")}
                            className={cn("p-2 rounded-md", libraryViewport === "desktop" ? "bg-zinc-700 text-white" : "hover:bg-zinc-800 text-zinc-400")} 
                          >
                            <Monitor className="w-4 h-4" />
                          </button>
                          <div className="w-px h-6 bg-zinc-700 mx-2" />
                          {/* Background toggles */}
                          {(["light", "dark"] as const).map((bg) => (
                            <button
                              key={bg}
                              onClick={() => setLibraryBackground(bg)}
                              className={cn("px-3 py-1.5 text-xs rounded-md", libraryBackground === bg ? "bg-zinc-700 text-white" : "text-zinc-400 hover:text-white")}
                            >
                              {bg.charAt(0).toUpperCase() + bg.slice(1)}
                            </button>
                          ))}
                          <div className="w-px h-6 bg-zinc-700 mx-2" />
                          <button 
                            onClick={() => setIsLibraryFullscreen(false)}
                            className="p-2 hover:bg-zinc-800 rounded-md text-zinc-400 hover:text-white"
                            title="Exit fullscreen (Esc)"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                      {/* Fullscreen Content */}
                      <div className={cn(
                        "flex-1 overflow-auto flex items-center justify-center p-8",
                        libraryBackground === "dark" ? "bg-zinc-950" : "bg-white"
                      )}>
                        <div className={cn(
                          "transition-all duration-300",
                          libraryViewport === "mobile" ? "w-[375px]" : "w-full max-w-6xl"
                        )}>
                          <InteractiveReactPreview 
                            code={selectedComponent.code}
                            background={libraryBackground === "light" ? "light" : "dark"}
                            className="min-h-[300px]"
                            isFullWidth={(() => {
                              const componentName = selectedComponent.name?.toLowerCase() || '';
                              const componentCategory = selectedComponent.category?.toLowerCase() || (selectedComponent as any).layer?.toLowerCase() || '';
                              return ['product', 'section', 'hero', 'footer', 'header', 'page', 'nav'].includes(componentCategory) ||
                                componentName.includes('hero') || 
                                componentName.includes('section') ||
                                componentName.includes('navbar') ||
                                componentName.includes('nav') ||
                                componentName.includes('header') ||
                                componentName.includes('footer') ||
                                componentName.includes('banner');
                            })()}
                          />
                        </div>
                      </div>
                    </div>
                  ) : null;
                })()}
                {/* Main Area - Canvas + Bottom Panel (middle panel removed - now in left sidebar) */}
                <div className="flex-1 flex flex-col min-w-0 relative">
                  {/* Center Toolbar - Tool controls (floating over canvas) - neutral colors */}
                  {/* Only show toolbar for components, hide for docs */}
                  {selectedLibraryItem?.startsWith("comp-") && (
                  <div className="absolute top-4 left-1/2 -translate-x-1/2 z-30 flex flex-wrap items-center justify-center gap-1 bg-zinc-900/98 backdrop-blur-xl rounded-xl p-1.5 border border-zinc-700/50 shadow-2xl shadow-black/40 max-w-[calc(100%-2rem)] sm:max-w-none">
                    {/* Grid toggle */}
                    <button 
                      onClick={() => setShowLibraryGrid(!showLibraryGrid)}
                      className={cn(
                        "p-2 rounded-lg transition-all duration-150 group relative",
                        showLibraryGrid 
                          ? "bg-zinc-700 text-white" 
                          : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                      )}
                    >
                      <Grid3X3 className="w-4 h-4" />
                      <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">Grid</span>
                    </button>
                    
                    {/* Background toggle - click dropdown */}
                    <div className="relative">
                      <button 
                        onClick={() => {
                          setShowLibraryBgDropdown(!showLibraryBgDropdown);
                          setShowLibraryVisionDropdown(false);
                        }}
                        className={cn(
                          "p-2 rounded-lg transition-all duration-150 flex items-center gap-1",
                          libraryBackground !== "dark" 
                            ? "bg-zinc-700 text-white" 
                            : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                        )}
                      >
                        {libraryBackground === "light" ? <Sun className="w-4 h-4" /> : libraryBackground === "transparent" ? <Grid2X2 className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                        <ChevronDown className="w-3 h-3" />
                      </button>
                      {showLibraryBgDropdown && (
                        <div className="absolute top-full left-0 mt-2 bg-zinc-900/98 backdrop-blur-xl border border-zinc-700/50 rounded-xl shadow-2xl min-w-[120px] py-1 z-50">
                          <span className="block px-3 py-1.5 text-[10px] text-zinc-500 uppercase tracking-wider">Background</span>
                          {(["dark", "light", "transparent"] as const).map((bg) => (
                            <button
                              key={bg}
                              onClick={() => {
                                setLibraryBackground(bg);
                                setShowLibraryBgDropdown(false);
                              }}
                              className={cn(
                                "w-full px-3 py-1.5 text-xs text-left hover:bg-zinc-800 transition-colors flex items-center justify-between capitalize",
                                libraryBackground === bg ? "bg-zinc-700 text-white" : "text-zinc-400"
                              )}
                            >
                              {bg}
                              {libraryBackground === bg && <Check className="w-3 h-3" />}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Ruler mode */}
                    <button 
                      onClick={() => setShowLibraryRuler(!showLibraryRuler)}
                      className={cn(
                        "p-2 rounded-lg transition-all duration-150 group relative",
                        showLibraryRuler 
                          ? "bg-zinc-700 text-white" 
                          : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                      )}
                    >
                      <Ruler className="w-4 h-4" />
                      <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">Measure</span>
                    </button>
                    
                    {/* Outline toggle */}
                    <button 
                      onClick={() => setShowLibraryOutline(!showLibraryOutline)}
                      className={cn(
                        "p-2 rounded-lg transition-all duration-150 group relative",
                        showLibraryOutline 
                          ? "bg-zinc-700 text-white" 
                          : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                      )}
                    >
                      <Square className="w-4 h-4" />
                      <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">Outline</span>
                    </button>
                    
                    <div className="w-px h-5 bg-zinc-700 mx-1" />
                    
                    {/* Vision Simulator dropdown - click */}
                    <div className="relative">
                      <button 
                        onClick={() => {
                          setShowLibraryVisionDropdown(!showLibraryVisionDropdown);
                          setShowLibraryBgDropdown(false);
                        }}
                        className={cn(
                          "p-2 rounded-lg transition-all duration-150 flex items-center gap-1",
                          libraryVisionMode !== "none" 
                            ? "bg-zinc-700 text-white" 
                            : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                        )}
                      >
                        <Eye className="w-4 h-4" />
                        <ChevronDown className="w-3 h-3" />
                      </button>
                      {showLibraryVisionDropdown && (
                        <div className="absolute top-full right-0 mt-2 bg-zinc-900/98 backdrop-blur-xl border border-zinc-700/50 rounded-xl shadow-2xl min-w-[160px] py-1 z-50">
                          <span className="block px-3 py-1.5 text-[10px] text-zinc-500 uppercase tracking-wider">Vision Simulator</span>
                          {[
                            { id: "none", label: "Normal" },
                            { id: "blur", label: "Blurred Vision" },
                            { id: "deuteranopia", label: "Deuteranopia" },
                            { id: "protanopia", label: "Protanopia" },
                            { id: "tritanopia", label: "Tritanopia" },
                            { id: "grayscale", label: "Grayscale" },
                          ].map((mode) => (
                            <button
                              key={mode.id}
                              onClick={() => {
                                setLibraryVisionMode(mode.id as any);
                                setShowLibraryVisionDropdown(false);
                              }}
                              className={cn(
                                "w-full px-3 py-1.5 text-xs text-left hover:bg-zinc-800 transition-colors flex items-center justify-between",
                                libraryVisionMode === mode.id ? "bg-zinc-700 text-white" : "text-zinc-400"
                              )}
                            >
                              {mode.label}
                              {libraryVisionMode === mode.id && <Check className="w-3 h-3" />}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    <div className="w-px h-5 bg-zinc-700 mx-1" />
                    
                    {/* Viewport toggles */}
                    <button 
                      onClick={() => setLibraryViewport(libraryViewport === "desktop" ? "mobile" : "desktop")}
                      className={cn(
                        "p-2 rounded-lg transition-all duration-150 group relative",
                        "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                      )}
                    >
                      {libraryViewport === "mobile" ? <Smartphone className="w-4 h-4" /> : <Monitor className="w-4 h-4" />}
                      <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">{libraryViewport === "mobile" ? "Mobile" : "Desktop"}</span>
                    </button>
                    <button 
                      onClick={() => setIsLibraryFullscreen(!isLibraryFullscreen)}
                      className={cn(
                        "p-2 rounded-lg transition-all duration-150 group relative",
                        isLibraryFullscreen 
                          ? "bg-zinc-700 text-white" 
                          : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                      )}
                    >
                      <Maximize2 className="w-4 h-4" />
                      <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">Fullscreen</span>
                    </button>
                  </div>
                  )}
                  
                  {/* Canvas - Component Preview - STORYBOOK STYLE */}
                  {(() => {
                    // Find selected component from libraryData - match by comp-{id} or direct id
                    const compId = selectedLibraryItem?.startsWith("comp-") 
                      ? selectedLibraryItem.replace("comp-", "")
                      : selectedLibraryItem;
                    const selectedComponent = compId && !selectedLibraryItem?.startsWith("doc-")
                      ? libraryData?.components?.find((c: any) => 
                          c.id === compId || 
                          c.id === selectedLibraryItem || 
                          `comp-${c.id}` === selectedLibraryItem ||
                          c.name === selectedLibraryItem
                        )
                      : null;
                    // Find doc from libraryData.docs OR use built-in doc types for foundations
                    const docId = selectedLibraryItem?.replace("doc-", "");
                    // Map ALL possible doc IDs to their display config
                    const libData = libraryData as any;
                    const builtInDocs: Record<string, any> = {
                      "overview": { id: "overview", title: "Overview", type: "overview", content: libData?.overview || {} },
                      "getting-started": { id: "getting-started", title: "Getting Started", type: "getting-started", content: {} },
                      "colors": { id: "colors", title: "Colors", type: "colors", content: {} },
                      "typography": { id: "typography", title: "Typography", type: "typography", content: {} },
                      "spacing": { id: "spacing", title: "Spacing", type: "spacing", content: {} },
                      "iconography": { id: "iconography", title: "Iconography", type: "iconography", content: {} },
                      "icons": { id: "icons", title: "Icons", type: "icons", content: {} },
                      "components": { id: "components", title: "Components", type: "components", content: {} },
                      "examples": { id: "examples", title: "Examples", type: "examples", content: {} },
                    };
                    // First try real docs, then fallback to built-in
                    const selectedDoc = selectedLibraryItem?.startsWith("doc-")
                      ? (libraryData?.docs?.find((d: any) => `doc-${d.id}` === selectedLibraryItem || d.id === docId) || builtInDocs[docId || ""] || null)
                      : null;
                    
                    return (
                      <>
                        <div 
                          className={cn(
                            "flex-1 overflow-auto",
                            libraryBackground === "dark" ? "bg-[#1a1a1c]" : 
                            libraryBackground === "light" ? "bg-white" : 
                            "bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHJlY3QgZmlsbD0iIzFhMWExYSIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIi8+PHJlY3QgZmlsbD0iIzI1MjUyNSIgeD0iMTAiIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIvPjxyZWN0IGZpbGw9IiMyNTI1MjUiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiLz48cmVjdCBmaWxsPSIjMWExYTFhIiB4PSIxMCIgeT0iMTAiIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3QgZmlsbD0idXJsKCNncmlkKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==')]",
                            showLibraryGrid && "bg-[linear-gradient(to_right,rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(to_bottom,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:16px_16px]"
                          )}
                          style={{
                            filter: libraryVisionMode === "blur" ? "blur(2px)" 
                              : libraryVisionMode === "deuteranopia" ? "url(#deuteranopia)" 
                              : libraryVisionMode === "protanopia" ? "url(#protanopia)"
                              : libraryVisionMode === "tritanopia" ? "url(#tritanopia)"
                              : libraryVisionMode === "grayscale" ? "grayscale(100%)" 
                              : undefined
                          }}
                        >
                          {!selectedLibraryItem ? (
                            <div className="w-full h-full flex items-center justify-center bg-[#111111]">
                              <EmptyState icon="logo" title="Design System Library" subtitle="Generate from video to extract components, colors, and typography." />
                            </div>
                          ) : selectedDoc ? (
                            /* Documentation view - Rich Solenis-style rendering */
                            <div className="w-full max-w-4xl mx-auto p-8 pb-24">
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* OVERVIEW PAGE - Shows data from generation */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "overview" && (
                                <div className="space-y-8">
                                  {/* Hero Header */}
                                  <div className="flex items-start justify-between">
                                    <div>
                                      <h1 className={cn("text-3xl font-bold mb-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        {(libraryData as any)?.overview?.name || selectedDoc.content?.systemName || selectedDoc.content?.headline || selectedDoc.title || "Design System"}
                                      </h1>
                                      <p className={cn("text-sm max-w-xl", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                        {(libraryData as any)?.overview?.description || selectedDoc.content?.projectContext || selectedDoc.content?.description || "Component library extracted from UI"}
                                      </p>
                                    </div>
                                  </div>
                                  
                                  {/* Stats Cards - Atomic Design Breakdown */}
                                  <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                    {/* Total Components */}
                                    <div className={cn("p-4 rounded-xl border relative overflow-hidden group cursor-pointer transition-all hover:border-zinc-600", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")} onClick={() => setSelectedLibraryItem("doc-components")}>
                                      <div className="flex items-center justify-between mb-2">
                                        <Puzzle className={cn("w-5 h-5", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-500")} />
                                      </div>
                                      <div className={cn("text-3xl font-bold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        {selectedDoc.content?.stats?.totalComponents || libraryData?.components?.length || 0}
                                      </div>
                                      <div className={cn("text-sm font-medium mt-1", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Components</div>
                                    </div>
                                    {/* Colors */}
                                    <div className={cn("p-4 rounded-xl border relative overflow-hidden group cursor-pointer transition-all hover:border-zinc-600", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")} onClick={() => setSelectedLibraryItem("doc-colors")}>
                                      <div className="flex items-center justify-between mb-2">
                                        <Palette className={cn("w-5 h-5", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-500")} />
                                      </div>
                                      <div className={cn("text-3xl font-bold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        {selectedDoc.content?.stats?.colors || Object.keys(libraryData?.tokens?.colors || {}).length || 0}
                                      </div>
                                      <div className={cn("text-sm font-medium mt-1", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Color Tokens</div>
                                    </div>
                                    {/* Icons */}
                                    <div className={cn("p-4 rounded-xl border relative overflow-hidden group cursor-pointer transition-all hover:border-zinc-600", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")} onClick={() => setSelectedLibraryItem("doc-iconography")}>
                                      <div className="flex items-center justify-between mb-2">
                                        <Grid3X3 className={cn("w-5 h-5", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-500")} />
                                      </div>
                                      <div className={cn("text-3xl font-bold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        {(libraryData as any)?.foundations?.iconography?.icons?.length || selectedDoc.content?.stats?.icons || 0}
                                      </div>
                                      <div className={cn("text-sm font-medium mt-1", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Icons</div>
                                    </div>
                                    {/* Accessibility */}
                                    <div className={cn("p-4 rounded-xl border relative overflow-hidden", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                      <div className="flex items-center justify-between mb-2">
                                        <Shield className={cn("w-5 h-5", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-500")} />
                                      </div>
                                      <div className={cn("text-3xl font-bold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{(libraryData as any)?.overview?.accessibilityScore || 90}%</div>
                                      <div className={cn("text-sm font-medium mt-1", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>AA Compliant</div>
                                    </div>
                                  </div>
                                  
                                  {/* Quick Links */}
                                  {selectedDoc.content?.quickLinks && selectedDoc.content.quickLinks.length > 0 && (
                                    <div className="flex flex-wrap gap-2">
                                      {selectedDoc.content.quickLinks.map((link: any) => (
                                        <button
                                          key={link.id}
                                          onClick={() => setSelectedLibraryItem(`doc-${link.id}`)}
                                          className={cn("flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors", libraryBackground === "light" ? "bg-zinc-100 hover:bg-zinc-200 text-zinc-700" : "bg-zinc-800 hover:bg-zinc-700 text-zinc-300")}
                                        >
                                          {link.icon === "Rocket" && <Rocket className="w-4 h-4" />}
                                          {link.icon === "Palette" && <Palette className="w-4 h-4" />}
                                          {link.icon === "Type" && <Type className="w-4 h-4" />}
                                          {link.icon === "Grid" && <Grid3X3 className="w-4 h-4" />}
                                          {link.icon === "Layers" && <Layers className="w-4 h-4" />}
                                          {link.label}
                                        </button>
                                      ))}
                                    </div>
                                  )}
                                  
                                  {/* Component Preview Section - From Generation */}
                                  <div>
                                    <div className="flex items-center justify-between mb-4">
                                      <h2 className={cn("text-lg font-semibold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Components</h2>
                                      <button onClick={() => setSelectedLibraryItem("doc-components")} className={cn("text-xs px-3 py-1.5 rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}>View All</button>
                                    </div>
                                    {libraryData?.components && libraryData.components.length > 0 ? (
                                      <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                        <div className={cn("grid grid-cols-2 lg:grid-cols-3 divide-x divide-y", libraryBackground === "light" ? "divide-zinc-200" : "divide-zinc-800")}>
                                          {libraryData.components.slice(0, 6).map((comp) => (
                                            <div key={comp.id} className={cn("p-4 cursor-pointer transition-colors", libraryBackground === "light" ? "hover:bg-zinc-50" : "hover:bg-zinc-800/50")} onClick={() => setSelectedLibraryItem(`comp-${comp.id}`)}>
                                              <div className="flex items-center gap-2 mb-2">
                                                <div className={cn("w-6 h-6 rounded flex items-center justify-center", libraryBackground === "light" ? "bg-zinc-100" : "bg-zinc-800")}>
                                                  <Puzzle className={cn("w-3.5 h-3.5", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")} />
                                                </div>
                                                <span className={cn("text-sm font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{comp.name}</span>
                                              </div>
                                              <p className={cn("text-xs line-clamp-2", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{comp.description}</p>
                                              <div className={cn("text-[10px] mt-2 px-2 py-0.5 rounded-full inline-block", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600" : "bg-zinc-800 text-zinc-400")}>{comp.category}</div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    ) : (
                                      <div className={cn("rounded-xl border p-8 text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                        <Puzzle className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                        <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No components extracted yet</p>
                                        <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Generate from video to extract components</p>
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Color Palette Preview - From Generation */}
                                  <div>
                                    <div className="flex items-center justify-between mb-4">
                                      <h2 className={cn("text-lg font-semibold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Color Tokens</h2>
                                      <button onClick={() => setSelectedLibraryItem("doc-colors")} className={cn("text-xs px-3 py-1.5 rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}>View All</button>
                                    </div>
                                    {Object.keys(libraryData?.tokens?.colors || {}).length > 0 ? (
                                      <div className={cn("rounded-xl border overflow-hidden p-4", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                        <div className="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-3">
                                          {Object.entries(libraryData?.tokens?.colors || {}).slice(0, 16).map(([name, value]) => {
                                            const colorValue = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#888') : '#888');
                                            return (
                                              <div key={name} className="text-center">
                                                <div 
                                                  className="w-full aspect-square rounded-lg cursor-pointer hover:scale-105 transition-transform shadow-sm border border-white/10"
                                                  style={{ backgroundColor: colorValue }}
                                                  onClick={() => { navigator.clipboard.writeText(colorValue); showToast(`Copied ${colorValue}`, "success"); }}
                                                  title={`${name}: ${colorValue}`}
                                                />
                                                <div className={cn("text-[10px] mt-1.5 truncate", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>{name}</div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    ) : (
                                      <div className={cn("rounded-xl border p-8 text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                        <Palette className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                        <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No colors extracted yet</p>
                                        <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Generate from video to extract color tokens</p>
                                      </div>
                                    )}
                                  </div>
                                  
                                  {/* Quick Links */}
                                  <div className="grid grid-cols-4 gap-3">
                                    {[
                                      { icon: <Rocket className="w-5 h-5" />, title: "Getting Started", desc: "Installation & setup", id: "doc-getting-started", color: "blue" },
                                      { icon: <Palette className="w-5 h-5" />, title: "Colors", desc: "OKLCH color system", id: "doc-colors", color: "violet" },
                                      { icon: <Type className="w-5 h-5" />, title: "Typography", desc: "Font scales & styles", id: "doc-typography", color: "emerald" },
                                      { icon: <Grid3X3 className="w-5 h-5" />, title: "Iconography", desc: "Icon library", id: "doc-iconography", color: "amber" },
                                    ].map((link) => (
                                      <button 
                                        key={link.id}
                                        onClick={() => setSelectedLibraryItem(link.id)}
                                        className={cn("p-4 rounded-xl border text-left transition-all hover:scale-[1.02]", libraryBackground === "light" ? "bg-white border-zinc-200 hover:border-zinc-300" : "bg-zinc-900/50 border-zinc-800 hover:border-zinc-700")}
                                      >
                                        <div className={cn("mb-2", `text-${link.color}-500`)}>{link.icon}</div>
                                        <div className={cn("font-medium text-sm", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{link.title}</div>
                                        <div className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{link.desc}</div>
                                      </button>
                                    ))}
                                  </div>
                                  
                                  {/* Design Principles - from libraryData */}
                                  {(() => {
                                    const principles = (libraryData as any)?.overview?.principles || [
                                      { title: "Accessibility", items: ["WCAG compliance", "Keyboard nav", "Screen readers", "High contrast"] },
                                      { title: "Consistency", items: ["Unified language", "Standard interactions", "Cohesive typography", "Consistent spacing"] },
                                      { title: "Developer Experience", items: ["TypeScript ready", "Clear docs", "Live examples", "Modern tooling"] }
                                    ];
                                    const icons: Record<string, any> = { "Accessibility": Eye, "Consistency": Palette, "Developer Experience": Code };
                                    return (
                                      <div>
                                        <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                          <Target className="w-5 h-5 text-zinc-400" /> Design Principles
                                        </h2>
                                        <div className="grid grid-cols-3 gap-4">
                                          {principles.map((p: any, i: number) => {
                                            const IconComp = icons[p.title] || Eye;
                                            return (
                                              <div key={i} className={cn("p-4 rounded-xl border", libraryBackground === "light" ? "bg-white border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                                <h3 className={cn("font-semibold mb-2 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                                  <IconComp className="w-4 h-4 text-zinc-400" /> {p.title}
                                                </h3>
                                                <ul className={cn("text-xs space-y-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                  {(p.items || []).map((item: string, j: number) => (
                                                    <li key={j}>• {item}</li>
                                                  ))}
                                                </ul>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* Quick Links */}
                                  <div>
                                    <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                      <Link2 className="w-5 h-5 text-zinc-400" /> Quick Links
                                    </h2>
                                    <div className="flex flex-wrap gap-2">
                                      {["Getting Started", "Colors", "Typography", "Iconography", "Examples"].map((link) => (
                                        <button key={link} onClick={() => setSelectedLibraryItem(`doc-${link.toLowerCase().replace(" ", "-")}`)} className="px-4 py-2 text-sm bg-zinc-800 text-zinc-300 rounded-lg hover:bg-zinc-700 hover:text-white transition-colors">
                                          {link}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* GETTING STARTED PAGE */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "getting-started" && (
                                <div className="space-y-8">
                                  <div>
                                    <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Getting Started</h1>
                                    <p className={cn("text-lg", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {selectedDoc.content?.description || "Quick guide to implementing this design system."}
                                    </p>
                                  </div>
                                  
                                  {/* Installation - from AI */}
                                  {selectedDoc.content?.installation && (
                                    <div>
                                      <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        <Package className="w-5 h-5 text-zinc-400" /> Installation
                                      </h2>
                                      <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                        <div className={cn("px-4 py-2 text-xs font-mono border-b flex items-center justify-between", libraryBackground === "light" ? "bg-zinc-100 border-zinc-200 text-zinc-600" : "bg-zinc-900 border-zinc-800 text-zinc-400")}>
                                          <span>Terminal</span>
                                          <button onClick={() => { navigator.clipboard.writeText(selectedDoc.content.installation); showToast("Copied!", "success"); }} className="text-zinc-400 hover:text-white">Copy</button>
                                        </div>
                                        <pre className={cn("p-4 text-sm font-mono overflow-x-auto", libraryBackground === "light" ? "bg-zinc-50" : "bg-[#0d0d0d]")}>
                                          <code className={libraryBackground === "light" ? "text-zinc-800" : "text-zinc-300"}>{selectedDoc.content.installation}</code>
                                        </pre>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Quick Start - from AI */}
                                  {selectedDoc.content?.quickStart && (
                                    <div>
                                      <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        <Rocket className="w-5 h-5 text-zinc-400" /> Quick Start
                                      </h2>
                                      <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                        <div className={cn("px-4 py-2 text-xs font-mono border-b", libraryBackground === "light" ? "bg-zinc-100 border-zinc-200 text-zinc-600" : "bg-zinc-900 border-zinc-800 text-zinc-400")}>React + TypeScript</div>
                                        <Highlight 
                                          theme={themes.nightOwl} 
                                          code={selectedDoc.content.quickStart}
                                          language="tsx"
                                        >
                                          {({ style, tokens, getLineProps, getTokenProps }) => (
                                            <pre className="p-4 text-sm overflow-x-auto" style={{ ...style, background: "#0d0d0d", fontFamily: "'JetBrains Mono', monospace" }}>
                                              {tokens.map((line, i) => (
                                                <div key={i} {...getLineProps({ line })}>
                                                {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                              </div>
                                            ))}
                                          </pre>
                                        )}
                                      </Highlight>
                                    </div>
                                  </div>
                                  )}
                                  
                                  {/* Features - from AI or fallback */}
                                  {selectedDoc.content?.features && selectedDoc.content.features.length > 0 ? (
                                    <div>
                                      <h2 className={cn("text-xl font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Features</h2>
                                      <div className="grid grid-cols-2 gap-4">
                                        {selectedDoc.content.features.map((f: any, i: number) => (
                                          <div key={i} className={cn("p-4 rounded-xl border", libraryBackground === "light" ? "bg-white border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                            <div className="text-zinc-400 mb-2">
                                              {f.icon === "Code" && <Code className="w-5 h-5" />}
                                              {f.icon === "Paintbrush" && <Palette className="w-5 h-5" />}
                                              {f.icon === "Smartphone" && <Monitor className="w-5 h-5" />}
                                              {f.icon === "Accessibility" && <Shield className="w-5 h-5" />}
                                            </div>
                                            <h3 className={cn("font-semibold", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{f.title}</h3>
                                            <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{f.description}</p>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  ) : (
                                    <div className={cn("rounded-xl border p-8 text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                      <Rocket className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                      <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No getting started info yet</p>
                                      <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Generate Library to create documentation</p>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* COMPONENTS GALLERY PAGE - Real components from libraryData */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "components" && (
                                <div className="space-y-8">
                                  {/* Header */}
                                  <div className="flex items-start justify-between">
                                    <div>
                                      <h1 className={cn("text-3xl font-bold mb-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Components</h1>
                                      <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                        All extracted components organized by layer
                                      </p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                      <span className={cn("px-2 py-1 text-[10px] rounded-full font-medium", libraryBackground === "light" ? "bg-blue-100 text-blue-700" : "bg-blue-500/20 text-blue-400")}>{libraryData?.components?.length || 0} components</span>
                                    </div>
                                  </div>
                                  
                                  {/* Components by Layer */}
                                  {(() => {
                                    const layers = [
                                      { id: 'components', name: 'Components', color: 'blue', desc: 'UI building blocks' },
                                      { id: 'patterns', name: 'Patterns', color: 'amber', desc: 'Reusable recipes' },
                                      { id: 'templates', name: 'Templates', color: 'teal', desc: 'Page layouts' },
                                      { id: 'product', name: 'Product Modules', color: 'rose', desc: 'Brand-specific' },
                                    ];
                                    const compsByLayer: Record<string, any[]> = {};
                                    layers.forEach(l => compsByLayer[l.id] = []);
                                    (libraryData?.components || []).forEach((comp: any) => {
                                      let layer = (comp.layer || 'components').toLowerCase();
                                      // Backward compat
                                      if (layer === 'primitives' || layer === 'elements') layer = 'components';
                                      if (compsByLayer[layer]) compsByLayer[layer].push(comp);
                                      else compsByLayer.components.push(comp);
                                    });
                                    
                                    return layers.map(layer => {
                                      const comps = compsByLayer[layer.id];
                                      if (comps.length === 0) return null;
                                      return (
                                        <div key={layer.id} className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                          <div className={cn("px-5 py-4 border-b", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900")}>
                                            <h3 className={cn("font-semibold flex items-center gap-2", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                              <span className={`w-2 h-2 rounded-full bg-${layer.color}-500`} />
                                              {layer.name}
                                              <span className="text-xs font-normal text-zinc-500">({comps.length})</span>
                                            </h3>
                                            <p className={cn("text-xs mt-0.5", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{layer.desc}</p>
                                          </div>
                                          <div className="p-4">
                                            <div className="grid grid-cols-2 lg:grid-cols-3 gap-3">
                                              {comps.map((comp: any) => (
                                                <button
                                                  key={comp.id}
                                                  onClick={() => setSelectedLibraryItem(`comp-${comp.id}`)}
                                                  className={cn(
                                                    "p-4 rounded-lg border text-left transition-all hover:border-blue-500/50",
                                                    libraryBackground === "light" ? "border-zinc-200 bg-zinc-50 hover:bg-zinc-100" : "border-zinc-700 bg-zinc-800/50 hover:bg-zinc-800"
                                                  )}
                                                >
                                                  <div className={cn("font-medium text-sm mb-1", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{comp.name}</div>
                                                  <div className={cn("text-xs line-clamp-2", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{comp.description || 'No description'}</div>
                                                </button>
                                              ))}
                                            </div>
                                          </div>
                                        </div>
                                      );
                                    });
                                  })()}
                                  
                                  {/* Empty state */}
                                  {(!libraryData?.components || libraryData.components.length === 0) && (
                                    <div className={cn("p-12 rounded-xl border text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                      <Layers className={cn("w-10 h-10 mx-auto mb-4", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                      <p className={cn("text-sm mb-1", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>No components extracted yet</p>
                                      <p className={cn("text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>Generate Library to extract components from your video</p>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* COLORS PAGE - SupaColors Style */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "colors" && (
                                <div className="space-y-8">
                                  {/* Header */}
                                  <div className="flex items-start justify-between">
                                    <div>
                                      <h1 className={cn("text-3xl font-bold mb-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Color System</h1>
                                      <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                        OKLCH-powered color scales with WCAG accessibility compliance
                                      </p>
                                    </div>
                                  </div>
                                  
                                  {/* Color Palettes Grid - SupaColors Style */}
                                  <div>
                                    <div className="flex items-center justify-between mb-4">
                                      <h2 className={cn("text-lg font-semibold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Color Palettes</h2>
                                      <div className="flex items-center gap-2">
                                        <button 
                                          onClick={() => {
                                            const tokens = libraryData?.tokens || libraryData?.foundations || {};
                                            const colors = tokens.colors || {};
                                            const typography = tokens.typography || {};
                                            const spacing = tokens.spacing || {};
                                            const borderRadius = tokens.borderRadius || {};
                                            const shadows = tokens.shadows || {};
                                            
                                            let css = `:root {\n  /* Colors */\n`;
                                            Object.entries(colors).forEach(([name, value]) => {
                                              const val = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#000') : '#000');
                                              css += `  --color-${name.toLowerCase().replace(/\s+/g, '-')}: ${val};\n`;
                                            });
                                            css += `\n  /* Typography */\n`;
                                            if (typography.fontFamily) {
                                              Object.entries(typography.fontFamily).forEach(([name, value]) => {
                                                css += `  --font-${name}: ${value};\n`;
                                              });
                                            }
                                            if (typography.fontSize) {
                                              Object.entries(typography.fontSize).forEach(([name, value]) => {
                                                css += `  --font-size-${name}: ${value};\n`;
                                              });
                                            }
                                            css += `\n  /* Spacing */\n`;
                                            Object.entries(spacing).forEach(([name, value]) => {
                                              css += `  --spacing-${name}: ${value};\n`;
                                            });
                                            css += `\n  /* Border Radius */\n`;
                                            Object.entries(borderRadius).forEach(([name, value]) => {
                                              css += `  --radius-${name}: ${value};\n`;
                                            });
                                            css += `\n  /* Shadows */\n`;
                                            Object.entries(shadows).forEach(([name, value]) => {
                                              css += `  --shadow-${name}: ${value};\n`;
                                            });
                                            css += `}\n`;
                                            
                                            const blob = new Blob([css], { type: 'text/css' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = 'design-tokens.css';
                                            a.click();
                                            URL.revokeObjectURL(url);
                                            showToast("CSS exported!", "success");
                                          }}
                                          className={cn("px-3 py-1.5 text-xs rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}
                                        >
                                          Export CSS
                                        </button>
                                        <button 
                                          onClick={() => {
                                            const tokens = libraryData?.tokens || libraryData?.foundations || {};
                                            const colors = tokens.colors || {};
                                            const typography = tokens.typography || {};
                                            const spacing = tokens.spacing || {};
                                            const borderRadius = tokens.borderRadius || {};
                                            
                                            const colorsObj: Record<string, string> = {};
                                            Object.entries(colors).forEach(([name, value]) => {
                                              const val = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#000') : '#000');
                                              colorsObj[name.toLowerCase().replace(/\s+/g, '-')] = val;
                                            });
                                            
                                            const fontFamilyObj: Record<string, string[]> = {};
                                            if (typography.fontFamily) {
                                              Object.entries(typography.fontFamily).forEach(([name, value]) => {
                                                fontFamilyObj[name] = [String(value)];
                                              });
                                            }
                                            
                                            const config = `/** @type {import('tailwindcss').Config} */
module.exports = {
  theme: {
    extend: {
      colors: ${JSON.stringify(colorsObj, null, 8).replace(/^/gm, '      ').trim()},
      fontFamily: ${JSON.stringify(fontFamilyObj, null, 8).replace(/^/gm, '      ').trim()},
      spacing: ${JSON.stringify(spacing, null, 8).replace(/^/gm, '      ').trim()},
      borderRadius: ${JSON.stringify(borderRadius, null, 8).replace(/^/gm, '      ').trim()},
    },
  },
  plugins: [],
}
`;
                                            
                                            const blob = new Blob([config], { type: 'text/javascript' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = 'tailwind.config.js';
                                            a.click();
                                            URL.revokeObjectURL(url);
                                            showToast("Tailwind config exported!", "success");
                                          }}
                                          className={cn("px-3 py-1.5 text-xs rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}
                                        >
                                          Export Tailwind
                                        </button>
                                        <button 
                                          onClick={() => {
                                            const tokens = libraryData?.tokens || libraryData?.foundations || {};
                                            const output = JSON.stringify({
                                              colors: tokens.colors || {},
                                              typography: tokens.typography || {},
                                              spacing: tokens.spacing || {},
                                              borderRadius: tokens.borderRadius || {},
                                            }, null, 2);
                                            
                                            const blob = new Blob([output], { type: 'application/json' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = 'design-tokens.json';
                                            a.click();
                                            URL.revokeObjectURL(url);
                                            showToast("JSON exported!", "success");
                                          }}
                                          className={cn("px-3 py-1.5 text-xs rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}
                                        >
                                          Export JSON
                                        </button>
                                        <button 
                                          onClick={() => {
                                            const tokens = libraryData?.tokens || libraryData?.foundations || {};
                                            const colors = tokens.colors || {};
                                            const spacing = tokens.spacing || {};
                                            
                                            const lines = ['// Design System Tokens', '// Generated by Replay', ''];
                                            
                                            // Colors as SCSS variables
                                            if (Object.keys(colors).length > 0) {
                                              lines.push('// Colors');
                                              Object.entries(colors).forEach(([name, value]) => {
                                                const val = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#000') : '#000');
                                                lines.push(`$color-${name.toLowerCase().replace(/\s+/g, '-')}: ${val};`);
                                              });
                                              lines.push('');
                                              
                                              // Colors map
                                              lines.push('$colors: (');
                                              Object.entries(colors).forEach(([name, value], i, arr) => {
                                                const val = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#000') : '#000');
                                                const comma = i < arr.length - 1 ? ',' : '';
                                                lines.push(`  "${name.toLowerCase().replace(/\s+/g, '-')}": ${val}${comma}`);
                                              });
                                              lines.push(');');
                                              lines.push('');
                                            }
                                            
                                            // Spacing
                                            if (Object.keys(spacing).length > 0) {
                                              lines.push('// Spacing');
                                              Object.entries(spacing).forEach(([name, value]) => {
                                                lines.push(`$spacing-${name}: ${value};`);
                                              });
                                              lines.push('');
                                            }
                                            
                                            const scss = lines.join('\n');
                                            const blob = new Blob([scss], { type: 'text/plain' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = '_tokens.scss';
                                            a.click();
                                            URL.revokeObjectURL(url);
                                            showToast("SCSS exported!", "success");
                                          }}
                                          className={cn("px-3 py-1.5 text-xs rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600 hover:bg-zinc-200" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}
                                        >
                                          Export SCSS
                                        </button>
                                      </div>
                                    </div>
                                    
                                    {/* Palette Cards - Horizontal Layout like SupaColors */}
                                    <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                      {/* Palette Header Row */}
                                      <div className={cn("grid border-b", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900")} style={{ gridTemplateColumns: "repeat(11, minmax(0, 1fr))" }}>
                                        <div className={cn("px-3 py-2 text-[10px] font-medium uppercase tracking-wider", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}></div>
                                        {["50", "100", "200", "300", "400", "500", "600", "700", "800", "900"].map((shade) => (
                                          <div key={shade} className={cn("px-2 py-2 text-center text-[10px] font-medium", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{shade}</div>
                                        ))}
                                      </div>
                                      
                                      {/* Color Rows */}
                                      {(() => {
                                        // Generate full palettes from base colors or use defaults
                                        const generateShades = (baseColor: string, name: string) => {
                                          // Parse hex to get luminosity hints
                                          const hex = baseColor.replace('#', '');
                                          const r = parseInt(hex.slice(0, 2), 16) / 255;
                                          const g = parseInt(hex.slice(2, 4), 16) / 255;
                                          const b = parseInt(hex.slice(4, 6), 16) / 255;
                                          const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                                          
                                          // Generate 10 shades based on luminance curve
                                          const shades: { shade: string; hex: string; contrast: string }[] = [];
                                          const baseShades = [0.97, 0.94, 0.88, 0.78, 0.65, 0.50, 0.40, 0.32, 0.24, 0.18];
                                          
                                          baseShades.forEach((targetL, i) => {
                                            const factor = targetL / Math.max(luminance, 0.1);
                                            const newR = Math.min(255, Math.max(0, Math.round(r * 255 * factor)));
                                            const newG = Math.min(255, Math.max(0, Math.round(g * 255 * factor)));
                                            const newB = Math.min(255, Math.max(0, Math.round(b * 255 * factor)));
                                            const newHex = `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
                                            
                                            // Calculate contrast ratio with white
                                            const newLuminance = (0.299 * newR + 0.587 * newG + 0.114 * newB) / 255;
                                            const contrastWithWhite = (1 + 0.05) / (newLuminance + 0.05);
                                            const contrastWithBlack = (newLuminance + 0.05) / (0 + 0.05);
                                            
                                            let contrast = "";
                                            if (contrastWithWhite >= 7) contrast = "AAA";
                                            else if (contrastWithWhite >= 4.5) contrast = "AA";
                                            else if (contrastWithBlack >= 4.5) contrast = "AA ✓";
                                            
                                            shades.push({ 
                                              shade: ["50", "100", "200", "300", "400", "500", "600", "700", "800", "900"][i], 
                                              hex: newHex,
                                              contrast 
                                            });
                                          });
                                          
                                          return { name, shades, baseColor };
                                        };
                                        
                                        // Get colors ONLY from libraryData - no defaults
                                        const baseColors = Object.entries(libraryData?.tokens?.colors || {}).map(([name, value]) => ({
                                          name,
                                          color: typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#6366f1') : '#6366f1')
                                        }));
                                        
                                        if (baseColors.length === 0) {
                                          return (
                                            <div className={cn("p-8 text-center col-span-11", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                              <Palette className="w-8 h-8 mx-auto mb-3 opacity-50" />
                                              <p className="text-sm">No colors extracted yet</p>
                                              <p className="text-xs mt-1 opacity-70">Generate Library to extract colors from your design</p>
                                            </div>
                                          );
                                        }
                                        
                                        const palettes = baseColors.map(({ name, color }) => generateShades(color, name));
                                        
                                        return palettes.map((palette, idx) => (
                                          <div key={palette.name} className={cn("grid border-b last:border-0 group", libraryBackground === "light" ? "border-zinc-100 hover:bg-zinc-50/50" : "border-zinc-800/50 hover:bg-zinc-800/30")} style={{ gridTemplateColumns: "repeat(11, minmax(0, 1fr))" }}>
                                            {/* Palette Name */}
                                            <div className={cn("px-3 py-3 flex items-center", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>
                                              <div className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: palette.baseColor }} />
                                              <span className="text-xs font-medium capitalize">{palette.name}</span>
                                            </div>
                                            {/* Color Swatches */}
                                            {palette.shades.map((swatch) => (
                                              <div 
                                                key={swatch.shade}
                                                className="relative group/swatch cursor-pointer"
                                                onClick={() => {
                                                  navigator.clipboard.writeText(swatch.hex);
                                                }}
                                              >
                                                <div 
                                                  className="h-10 w-full transition-all"
                                                  style={{ backgroundColor: swatch.hex }}
                                                />
                                                {/* Hover Info - shows hex and contrast badge */}
                                                <div className="absolute inset-0 flex flex-col items-center justify-center opacity-0 group-hover/swatch:opacity-100 transition-opacity bg-black/70">
                                                  <span className="text-[9px] font-mono text-white">{swatch.hex}</span>
                                                  {swatch.contrast && (
                                                    <span className="mt-1 px-1.5 py-0.5 text-[8px] font-medium rounded bg-zinc-800 text-zinc-300">
                                                      {swatch.contrast.replace(" ✓", "")}
                                                    </span>
                                                  )}
                                                </div>
                                              </div>
                                            ))}
                                          </div>
                                        ));
                                      })()}
                                    </div>
                                  </div>
                                  
                                  {/* Accessibility Overview - from libraryData.overview.colorStats */}
                                  {(() => {
                                    const colorStats = (libraryData as any)?.overview?.colorStats || { readabilityScore: 90, lc75Plus: 25, lc90Plus: 15, minReadable: 35 };
                                    return (
                                      <div className={cn("rounded-xl border p-5", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                        <h3 className={cn("text-sm font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                          <Eye className="w-4 h-4 text-zinc-500" /> Accessibility Overview
                                        </h3>
                                        <div className="grid grid-cols-4 gap-3">
                                          <div className={cn("p-4 rounded-lg text-center border", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                            <div className={cn("text-2xl font-bold mb-1", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{colorStats.readabilityScore}</div>
                                            <div className={cn("text-xs font-medium", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Readability Score</div>
                                          </div>
                                          <div className={cn("p-4 rounded-lg text-center border", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                            <div className={cn("text-2xl font-bold mb-1", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{colorStats.lc75Plus}%</div>
                                            <div className={cn("text-xs font-medium", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Lc 75+</div>
                                          </div>
                                          <div className={cn("p-4 rounded-lg text-center border", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                            <div className={cn("text-2xl font-bold mb-1", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{colorStats.lc90Plus}%</div>
                                            <div className={cn("text-xs font-medium", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Lc 90+</div>
                                          </div>
                                          <div className={cn("p-4 rounded-lg text-center border", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                            <div className={cn("text-2xl font-bold mb-1", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{colorStats.minReadable}%</div>
                                            <div className={cn("text-xs font-medium", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Min. Readable</div>
                                          </div>
                                        </div>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* Semantic Colors - From real tokens (success, warning, error, info) */}
                                  {(() => {
                                    const tokens = libraryData?.tokens?.colors || {};
                                    const semanticColors = ['success', 'warning', 'error', 'info'].filter(k => tokens[k]);
                                    if (semanticColors.length === 0) return null;
                                    return (
                                      <div>
                                        <h2 className={cn("text-lg font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Semantic Colors</h2>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                          {semanticColors.map((name) => {
                                            const value = tokens[name];
                                            const colorValue = typeof value === 'string' ? value : (typeof value === 'object' && value !== null ? ((value as any).bg || (value as any).value || '#888') : '#888');
                                            return (
                                              <div key={name} className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                                <div className="h-16 w-full" style={{ backgroundColor: colorValue }} />
                                                <div className="p-3">
                                                  <div className={cn("font-medium text-sm capitalize", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{name}</div>
                                                  <div className="flex items-center justify-between mt-2">
                                                    <code className={cn("text-[10px] font-mono px-1.5 py-0.5 rounded", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600" : "bg-zinc-800 text-zinc-400")}>feedback-{name}</code>
                                                    <span className={cn("text-[9px] px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400")}>AA</span>
                                                  </div>
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* CSS Variables Export - Real data only */}
                                  {Object.keys(libraryData?.tokens?.colors || {}).length > 0 && (
                                    <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                      <div className={cn("px-4 py-3 flex items-center justify-between border-b", libraryBackground === "light" ? "bg-zinc-50 border-zinc-200" : "bg-zinc-900 border-zinc-800")}>
                                        <div className="flex items-center gap-2">
                                          <Code className="w-4 h-4 text-zinc-400" />
                                          <span className={cn("text-sm font-medium", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>CSS Custom Properties</span>
                                        </div>
                                        <button 
                                          onClick={() => {
                                            const css = `:root {\n${Object.entries(libraryData?.tokens?.colors || {}).map(([n,v]) => `  --color-${n}: ${typeof v === 'string' ? v : (typeof v === 'object' && v !== null ? ((v as any).bg || (v as any).value || '#000') : String(v))};`).join('\n')}\n}`;
                                            navigator.clipboard.writeText(css);
                                            showToast("CSS copied!", "success");
                                          }}
                                          className={cn("px-3 py-1 text-xs rounded-lg transition-colors", libraryBackground === "light" ? "bg-zinc-200 text-zinc-600 hover:bg-zinc-300" : "bg-zinc-800 text-zinc-400 hover:bg-zinc-700")}
                                        >
                                          Copy All
                                        </button>
                                      </div>
                                      <Highlight 
                                        theme={themes.nightOwl} 
                                        code={`:root {\n${Object.entries(libraryData?.tokens?.colors || {}).slice(0, 12).map(([n,v]) => `  --color-${n}: ${typeof v === 'string' ? v : (typeof v === 'object' && v !== null ? ((v as any).bg || (v as any).value || '#000') : String(v))};`).join('\n')}\n}`}
                                        language="css"
                                      >
                                        {({ style, tokens, getLineProps, getTokenProps }) => (
                                          <pre className="p-4 text-xs overflow-x-auto" style={{ ...style, background: libraryBackground === "light" ? "#fafafa" : "#0d0d0d", fontFamily: "'JetBrains Mono', monospace" }}>
                                            {tokens.map((line, i) => (
                                              <div key={i} {...getLineProps({ line })}>
                                                {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                              </div>
                                            ))}
                                          </pre>
                                        )}
                                      </Highlight>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* TYPOGRAPHY PAGE */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "typography" && (
                                <div className="space-y-10">
                                  <div>
                                    <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Typography</h1>
                                    <p className={cn("text-lg", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {selectedDoc.content?.description || "Type scale and font usage guidelines extracted from your project."}
                                    </p>
                                  </div>
                                  
                                  {/* Font Family - from AI */}
                                  <div>
                                    <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                      <Type className="w-5 h-5 text-zinc-400" /> Font Family
                                    </h2>
                                    {selectedDoc.content?.fontFamily ? (
                                      <div className="space-y-3">
                                        <div className={cn("p-4 rounded-lg border", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                          <p className={cn("text-sm font-medium mb-1", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>Primary Font</p>
                                          <p className={cn("text-lg font-semibold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{selectedDoc.content.fontFamily.primary || "Inter, system-ui"}</p>
                                        </div>
                                        {selectedDoc.content.fontFamily.mono && (
                                          <div className={cn("p-4 rounded-lg border", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                            <p className={cn("text-sm font-medium mb-1", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>Monospace Font</p>
                                            <p className={cn("text-lg font-mono", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{selectedDoc.content.fontFamily.mono}</p>
                                          </div>
                                        )}
                                      </div>
                                    ) : (
                                      <p className={cn("text-sm italic", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>—</p>
                                    )}
                                  </div>
                                  
                                  {/* Typography Scale - from AI */}
                                  <div>
                                    <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                      <Ruler className="w-5 h-5 text-zinc-400" /> Typography Scale
                                    </h2>
                                    {selectedDoc.content?.scale && selectedDoc.content.scale.length > 0 ? (
                                      <div className="space-y-4">
                                        {selectedDoc.content.scale.map((item: any, i: number) => (
                                          <div key={i} className={cn("p-4 rounded-lg border", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                            <div className="flex items-baseline justify-between mb-2">
                                              <span className={cn("font-semibold", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{item.name}</span>
                                              <span className={cn("text-xs font-mono", libraryBackground === "light" ? "text-blue-600" : "text-blue-400")}>{item.class} · {item.size}</span>
                                            </div>
                                            <p className={cn(item.class, "mb-2", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")} style={{ fontWeight: item.weight === 'bold' ? 700 : item.weight === 'semibold' ? 600 : 400 }}>
                                              {item.sample || "The quick brown fox jumps over the lazy dog."}
                                            </p>
                                            <p className={cn("text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                              Line height: {item.lineHeight || "1.5"}
                                            </p>
                                          </div>
                                        ))}
                                      </div>
                                    ) : (
                                      <p className={cn("text-sm italic", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>—</p>
                                    )}
                                  </div>
                                  
                                  {/* Font Weights - from AI */}
                                  {selectedDoc.content?.weights && selectedDoc.content.weights.length > 0 && (
                                    <div>
                                      <h2 className={cn("text-xl font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Font Weights</h2>
                                      <div className="flex flex-wrap gap-2">
                                        {selectedDoc.content.weights.map((weight: string, i: number) => (
                                          <span key={i} className={cn("px-3 py-1.5 rounded-lg text-sm font-mono", libraryBackground === "light" ? "bg-zinc-100 text-zinc-700" : "bg-zinc-800 text-zinc-300")}>
                                            {weight}
                                          </span>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* SPACING PAGE */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "spacing" && (
                                <div className="space-y-10">
                                  <div>
                                    <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Spacing</h1>
                                    <p className={cn("text-lg", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {selectedDoc.content?.description || "Spacing scale and layout tokens from your design system."}
                                    </p>
                                  </div>
                                  
                                  {/* Spacing Scale */}
                                  <div>
                                    <h2 className={cn("text-lg font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Spacing Scale</h2>
                                    <div className="space-y-3">
                                      {Object.entries(libraryData?.foundations?.spacing || libraryData?.tokens?.spacing || {}).map(([name, value]) => (
                                        <div key={name} className={cn("flex items-center gap-4 p-3 rounded-lg border", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                          <code className={cn("text-sm font-mono w-20", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{name}</code>
                                          <div className="h-6 bg-violet-500/30 rounded" style={{ width: typeof value === 'string' ? value : `${value}px` }} />
                                          <span className={cn("text-sm font-mono", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-400")}>{typeof value === 'string' ? value : `${value}px`}</span>
                                        </div>
                                      ))}
                                    </div>
                                    {Object.keys(libraryData?.foundations?.spacing || libraryData?.tokens?.spacing || {}).length === 0 && (
                                      <div className={cn("p-8 rounded-lg border text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                        <Ruler className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                        <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No spacing tokens detected yet</p>
                                        <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Regenerate Library to extract spacing values</p>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* ICONOGRAPHY PAGE */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "iconography" && (
                                <div className="space-y-10">
                                  <div>
                                    <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Iconography</h1>
                                    <p className={cn("text-lg", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {selectedDoc.content?.description || "Icons detected in your project."}
                                    </p>
                                  </div>
                                  
                                  {/* Icon Sizes */}
                                  {selectedDoc.content?.sizes && selectedDoc.content.sizes.length > 0 && (
                                    <div>
                                      <h2 className={cn("text-lg font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Icon Sizes</h2>
                                      <div className="flex flex-wrap gap-4">
                                        {selectedDoc.content.sizes.map((size: any, i: number) => (
                                          <div key={i} className={cn("p-4 rounded-lg border text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                            <div className={cn("mb-2 flex justify-center", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>
                                              <div className={size.class}>
                                                <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24" className="w-full h-full"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707" /></svg>
                                              </div>
                                            </div>
                                            <p className={cn("text-xs font-semibold", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>{size.name}</p>
                                            <p className={cn("text-xs font-mono", libraryBackground === "light" ? "text-blue-600" : "text-blue-400")}>{size.class}</p>
                                            <p className={cn("text-[10px] mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{size.usage}</p>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Detected Icons from AI */}
                                  {selectedDoc.content?.icons && selectedDoc.content.icons.length > 0 ? (
                                    <div>
                                      <h2 className={cn("text-lg font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                        Detected Icons ({selectedDoc.content.icons.length})
                                      </h2>
                                      <div className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                        <div className="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-px bg-zinc-800">
                                          {selectedDoc.content.icons.map((icon: string, i: number) => {
                                            // Dynamic Lucide icon lookup - supports any icon name
                                            // Strip "Icon" prefix if present (AI sometimes returns "IconAnchor" instead of "Anchor")
                                            const normalizedName = icon.replace(/^Icon/, '');
                                            
                                            // Try to get the icon from LucideIcons dynamically
                                            const LucideIcon = (LucideIcons as any)[normalizedName] || (LucideIcons as any)[icon];
                                            const IconComponent = LucideIcon ? <LucideIcon className="w-5 h-5" /> : <Box className="w-5 h-5" />;
                                            return (
                                              <div 
                                                key={i} 
                                                className={cn("flex flex-col items-center gap-2 p-4 cursor-pointer transition-colors", libraryBackground === "light" ? "bg-white hover:bg-zinc-50" : "bg-zinc-900 hover:bg-zinc-800")}
                                                onClick={() => { navigator.clipboard.writeText(`<${icon} />`); showToast(`Copied: <${icon} />`, "success"); }}
                                              >
                                                <div className={cn(libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>
                                                  {IconComponent}
                                                </div>
                                                <span className={cn("text-[10px] font-mono truncate w-full text-center", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{icon}</span>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>
                                    </div>
                                  ) : (
                                    <div className={cn("p-8 rounded-lg border text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                      <Layers className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                      <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No icons detected yet</p>
                                      <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Generate Library to analyze icons used in your code</p>
                                    </div>
                                  )}
                                  
                                  {/* Icon Categories */}
                                  {selectedDoc.content?.categories && selectedDoc.content.categories.length > 0 && (
                                    <div>
                                      <h2 className={cn("text-lg font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Categories</h2>
                                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {selectedDoc.content.categories.map((cat: any, i: number) => (
                                          <div key={i} className={cn("p-4 rounded-lg border", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                            <h3 className={cn("font-semibold mb-2", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{cat.name}</h3>
                                            <div className="flex flex-wrap gap-1">
                                              {cat.icons?.map((icon: string, j: number) => (
                                                <span key={j} className={cn("px-2 py-0.5 rounded text-xs font-mono", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600" : "bg-zinc-800 text-zinc-400")}>{icon}</span>
                                              ))}
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                  
                                  <p className={cn("text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                    {selectedDoc.content?.library || "Using Lucide Icons"} - <a href="https://lucide.dev" target="_blank" rel="noopener" className="text-zinc-400 hover:text-white hover:underline">lucide.dev</a>
                                  </p>
                                </div>
                              )}
                              
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {/* EXAMPLES PAGE */}
                              {/* ═══════════════════════════════════════════════════════════════════════════════ */}
                              {selectedDoc.type === "examples" && (
                                <div className="space-y-10">
                                  <div>
                                    <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Real-World Examples</h1>
                                    <p className={cn("text-lg", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {selectedDoc.content?.description || "Discover how the design system powers applications across different frameworks and technology stacks."}
                                    </p>
                                  </div>
                                  
                                  {/* Code Examples - from AI or auto-generated from components */}
                                  {(() => {
                                    // Use AI examples if available, otherwise generate from components
                                    const examples = selectedDoc.content?.examples && selectedDoc.content.examples.length > 0 
                                      ? selectedDoc.content.examples 
                                      : libraryData?.components?.slice(0, 4).map((comp: any) => ({
                                          title: comp.name,
                                          description: comp.description || `${comp.layer || 'Component'} - ${comp.name}`,
                                          code: comp.code || `<${comp.name} />`
                                        }));
                                    
                                    return examples && examples.length > 0 ? (
                                      <div>
                                        <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                          <Code className="w-5 h-5 text-zinc-400" /> Code Examples
                                        </h2>
                                        <div className="space-y-6">
                                          {examples.map((example: any, i: number) => (
                                            <div key={i} className={cn("rounded-xl border overflow-hidden", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                              <div className={cn("px-4 py-3 flex items-center justify-between", libraryBackground === "light" ? "bg-zinc-50 border-b border-zinc-200" : "bg-zinc-900 border-b border-zinc-800")}>
                                                <div>
                                                  <h3 className={cn("font-semibold text-sm", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{example.title}</h3>
                                                  <p className={cn("text-xs mt-0.5", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{example.description}</p>
                                                </div>
                                                <button 
                                                  onClick={() => navigator.clipboard.writeText((example.code || '').replace(/\\n/g, '\n'))}
                                                  className="px-3 py-1 text-xs bg-zinc-700 text-white rounded hover:bg-zinc-600"
                                                >
                                                  Copy
                                                </button>
                                              </div>
                                              <Highlight theme={themes.nightOwl} code={(example.code || '').replace(/\\n/g, '\n')} language="tsx">
                                                {({ style, tokens, getLineProps, getTokenProps }) => (
                                                  <pre className="p-4 text-sm overflow-x-auto max-h-64" style={{ ...style, background: libraryBackground === "light" ? "#fafafa" : "#0d0d0d", fontFamily: "'JetBrains Mono', monospace" }}>
                                                    {tokens.map((line, i) => (
                                                      <div key={i} {...getLineProps({ line })}>
                                                        {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                                      </div>
                                                    ))}
                                                  </pre>
                                                )}
                                              </Highlight>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    ) : (
                                      <div className={cn("p-8 rounded-lg border text-center", libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")}>
                                        <Code className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                        <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>No components extracted yet</p>
                                        <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>Generate Library to extract components from your video</p>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* Atomic Design Categories - from AI */}
                                  {(selectedDoc.content?.atoms || selectedDoc.content?.molecules || selectedDoc.content?.organisms) && (
                                    <div className="space-y-6">
                                      {/* Atoms */}
                                      {selectedDoc.content?.atoms && selectedDoc.content.atoms.length > 0 && (
                                        <div>
                                          <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                            <div className="w-3 h-3 rounded-full bg-blue-500" /> Atoms
                                          </h2>
                                          <div className="grid grid-cols-2 gap-4">
                                            {selectedDoc.content.atoms.map((atom: any, i: number) => (
                                              <div key={i} className={cn("p-4 rounded-xl border", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                                <h3 className={cn("font-semibold text-sm", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{atom.name}</h3>
                                                <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{atom.description}</p>
                                                {atom.variants && <div className="flex gap-1 mt-2 flex-wrap">{atom.variants.map((v: string, vi: number) => <span key={vi} className="px-1.5 py-0.5 text-[10px] bg-blue-500/20 text-blue-400 rounded">{v}</span>)}</div>}
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                      
                                      {/* Molecules */}
                                      {selectedDoc.content?.molecules && selectedDoc.content.molecules.length > 0 && (
                                        <div>
                                          <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                            <div className="w-3 h-3 rounded-full bg-emerald-500" /> Molecules
                                          </h2>
                                          <div className="grid grid-cols-2 gap-4">
                                            {selectedDoc.content.molecules.map((mol: any, i: number) => (
                                              <div key={i} className={cn("p-4 rounded-xl border", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                                <h3 className={cn("font-semibold text-sm", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{mol.name}</h3>
                                                <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{mol.description}</p>
                                                {mol.composition && <div className="flex gap-1 mt-2 flex-wrap">{mol.composition.map((c: string, ci: number) => <span key={ci} className="px-1.5 py-0.5 text-[10px] bg-emerald-500/20 text-emerald-400 rounded">{c}</span>)}</div>}
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                      
                                      {/* Organisms */}
                                      {selectedDoc.content?.organisms && selectedDoc.content.organisms.length > 0 && (
                                        <div>
                                          <h2 className={cn("text-xl font-semibold mb-4 flex items-center gap-2", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                            <div className="w-3 h-3 rounded-full bg-violet-500" /> Organisms
                                          </h2>
                                          <div className="grid grid-cols-2 gap-4">
                                            {selectedDoc.content.organisms.map((org: any, i: number) => (
                                              <div key={i} className={cn("p-4 rounded-xl border", libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50")}>
                                                <h3 className={cn("font-semibold text-sm", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{org.name}</h3>
                                                <p className={cn("text-xs mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>{org.description}</p>
                                                {org.composition && <div className="flex gap-1 mt-2 flex-wrap">{org.composition.map((c: string, ci: number) => <span key={ci} className="px-1.5 py-0.5 text-[10px] bg-violet-500/20 text-violet-400 rounded">{c}</span>)}</div>}
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  )}
                                  
                                  {/* Categories from actual components - only if no atomic data */}
                                  {!selectedDoc.content?.atoms && !selectedDoc.content?.molecules && !selectedDoc.content?.organisms && libraryData?.components && libraryData.components.length > 0 && (
                                    <div>
                                      <h2 className={cn("text-xl font-semibold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>Components by Category</h2>
                                      <div className="space-y-3">
                                        {[...new Set(libraryData.components.map((c: any) => c.category))].filter(Boolean).map((cat: any) => {
                                          const catComponents = libraryData.components.filter((c: any) => c.category === cat);
                                          return (
                                            <div key={cat} className={cn("p-4 rounded-lg border", libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800")}>
                                              <h3 className={cn("font-semibold capitalize mb-2", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>{cat}</h3>
                                              <div className="flex flex-wrap gap-2">
                                                {catComponents.map((comp: any, i: number) => (
                                                  <span key={i} className={cn("px-2 py-1 text-xs rounded cursor-pointer hover:opacity-80", libraryBackground === "light" ? "bg-zinc-100 text-zinc-600" : "bg-zinc-800 text-zinc-400")} onClick={() => setSelectedLibraryItem(`comp-${comp.id}`)}>{comp.name}</span>
                                                ))}
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {/* Default/other docs */}
                              {!["welcome", "overview", "colors", "typography", "getting-started", "iconography", "examples", "components", "spacing", "shadows"].includes(selectedDoc.type || "") && (
                                <div>
                                  <h1 className={cn("text-4xl font-bold mb-4", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>{selectedDoc.title}</h1>
                                  <div className={cn("prose prose-sm max-w-none", libraryBackground === "light" ? "prose-zinc" : "prose-invert")}>
                                    <div className="whitespace-pre-wrap text-sm opacity-80">{selectedDoc.content}</div>
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : selectedComponent ? (
                            /* STORYBOOK-STYLE Component Documentation */
                            <div className="w-full h-full flex flex-col">
                              {/* Scrollable content area */}
                              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                              {/* Header with badges and Copy button */}
                              <div className="flex items-start justify-between">
                                <div>
                                  <div className="flex items-center gap-3 mb-2">
                                    <h1 className={cn("text-3xl font-bold", libraryBackground === "light" ? "text-zinc-900" : "text-white")}>
                                      {selectedComponent.name}
                                    </h1>
                                    {/* Source badge - show where component came from */}
                                    <span className={cn(
                                      "px-2 py-0.5 text-[10px] font-medium rounded border",
                                      selectedComponent.source === "storybook" 
                                        ? (libraryBackground === "light" ? "bg-purple-100 text-purple-600 border-purple-200" : "bg-purple-500/20 text-purple-400 border-purple-500/30")
                                        : selectedComponent.source === "video"
                                        ? (libraryBackground === "light" ? "bg-blue-100 text-blue-600 border-blue-200" : "bg-blue-500/20 text-blue-400 border-blue-500/30")
                                        : selectedComponent.isNew
                                        ? (libraryBackground === "light" ? "bg-green-100 text-green-600 border-green-200" : "bg-green-500/20 text-green-400 border-green-500/30")
                                        : (libraryBackground === "light" ? "bg-zinc-100 text-zinc-500 border-zinc-200" : "bg-zinc-800/60 text-zinc-400 border-zinc-700")
                                    )}>
                                      {selectedComponent.source === "storybook" ? "Imported" 
                                        : selectedComponent.source === "video" ? "From Video"
                                        : selectedComponent.isNew ? "New" 
                                        : "Auto-Generated"}
                                    </span>
                                    {/* Usage count badge */}
                                    {selectedComponent.usageCount && (
                                      <span className={cn(
                                        "px-2 py-0.5 text-[10px] font-medium rounded border",
                                        libraryBackground === "light" 
                                          ? "bg-zinc-100 text-zinc-500 border-zinc-200" 
                                          : "bg-zinc-800/60 text-zinc-400 border-zinc-700"
                                      )}>
                                        {selectedComponent.usageCount}x used
                                      </span>
                                    )}
                                  </div>
                                  <p className={cn("text-base", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                    {selectedComponent.description || "No description available"}
                                  </p>
                                </div>
                              </div>
                              
                              {/* Preview Box with Show Code button */}
                              <div className={cn(
                                "rounded-xl border overflow-hidden flex flex-col",
                                libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50"
                              )}>
                                {/* Preview Toolbar */}
                                <div className={cn(
                                  "flex items-center justify-between px-4 py-2 border-b",
                                  libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900"
                                )}>
                                  <div className="flex items-center gap-1">
                                    <button 
                                      onClick={() => setLibraryZoom(Math.max(50, libraryZoom - 25))}
                                      className={cn(
                                        "p-1.5 rounded-md transition-colors",
                                        libraryBackground === "light" ? "hover:bg-zinc-200 text-zinc-600" : "hover:bg-zinc-800 text-zinc-400"
                                      )}
                                      title="Zoom out"
                                    >
                                      <ZoomOut className="w-4 h-4" />
                                    </button>
                                    <span className={cn("text-xs w-12 text-center font-mono", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                      {libraryZoom}%
                                    </span>
                                    <button 
                                      onClick={() => setLibraryZoom(Math.min(200, libraryZoom + 25))}
                                      className={cn(
                                        "p-1.5 rounded-md transition-colors",
                                        libraryBackground === "light" ? "hover:bg-zinc-200 text-zinc-600" : "hover:bg-zinc-800 text-zinc-400"
                                      )}
                                      title="Zoom in"
                                    >
                                      <ZoomIn className="w-4 h-4" />
                                    </button>
                                    <button 
                                      onClick={() => setLibraryZoom(100)}
                                      className={cn(
                                        "p-1.5 rounded-md transition-colors",
                                        libraryBackground === "light" ? "hover:bg-zinc-200 text-zinc-600" : "hover:bg-zinc-800 text-zinc-400"
                                      )}
                                      title="Reset zoom"
                                    >
                                      <RefreshCw className="w-4 h-4" />
                                    </button>
                                  </div>
                                  <button
                                    onClick={() => setShowLibraryCode(!showLibraryCode)}
                                    className={cn(
                                      "flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-md transition-colors",
                                      libraryBackground === "light" 
                                        ? "text-zinc-700 hover:bg-zinc-200 border border-zinc-300" 
                                        : "text-zinc-300 hover:bg-zinc-800 border border-zinc-700"
                                    )}
                                  >
                                    <Code className="w-3.5 h-3.5" />
                                    {showLibraryCode ? "Hide code" : "Show code"}
                                  </button>
                                </div>
                                
                                {/* Component Preview - LIVE with props override - FULL WIDTH */}
                                {(() => {
                                  // Apply live props to code for preview
                                  const liveCode = applyPropsToCode(
                                    selectedComponent.code || '', 
                                    selectedComponent.props || [], 
                                    libraryPropsOverride
                                  );
                                  
                                  return (
                                    <div 
                                      className="w-full overflow-auto custom-scrollbar"
                                      style={{ minHeight: '80px' }}
                                    >
                                      {/* Viewport container - changes width based on mobile/desktop */}
                                      <div 
                                        className={cn(
                                          "transition-all duration-300",
                                          libraryViewport === "mobile" 
                                            ? "w-[375px] border-x border-zinc-700/50 shadow-lg mx-auto" 
                                            : "w-full"
                                        )}
                                      >
                                      <div 
                                        className="p-4 relative transition-transform duration-200"
                                        style={{ 
                                          transform: `scale(${libraryZoom / 100})`, 
                                          transformOrigin: 'top left'
                                        }}
                                      >
                                      {liveCode ? (() => {
                                        // Check if this is a full-width component (hero, section, product, etc.)
                                        // Also check component NAME for navbar, header, footer - they're full-width regardless of category
                                        const componentName = selectedComponent.name?.toLowerCase() || '';
                                        const componentCategory = selectedComponent.category?.toLowerCase() || (selectedComponent as any).layer?.toLowerCase() || '';
                                        const isFullWidthComponent = 
                                          ['product', 'section', 'hero', 'footer', 'header', 'page', 'nav'].includes(componentCategory) ||
                                          componentName.includes('hero') || 
                                          componentName.includes('section') ||
                                          componentName.includes('navbar') ||
                                          componentName.includes('nav') ||
                                          componentName.includes('header') ||
                                          componentName.includes('footer') ||
                                          componentName.includes('banner');
                                        
                                        return (
                                        <div 
                                          className={cn(
                                            "transition-all duration-300 relative group/measure w-full",
                                            showLibraryOutline && "outline outline-1 outline-dashed outline-zinc-500/50"
                                          )}
                                        >
                                          {/* Storybook-like measurement overlay */}
                                          {(showLibraryOutline || showLibraryRuler) && (
                                            <>
                                              {/* Top dimension - width */}
                                              <div className="absolute -top-6 left-0 right-0 flex justify-center items-center gap-1 transition-opacity">
                                                <span className="px-1.5 py-0.5 text-[9px] font-mono font-medium text-zinc-400 bg-zinc-800 rounded border border-zinc-700">
                                                  {libraryPreviewSize.width > 0 ? `${libraryPreviewSize.width}px` : 'Hug'}
                                                </span>
                                              </div>
                                              {/* Left dimension - height */}
                                              <div className="absolute -left-8 top-0 bottom-0 flex items-center gap-1 transition-opacity">
                                                <span className="px-1.5 py-0.5 text-[9px] font-mono font-medium text-zinc-400 bg-zinc-800 rounded border border-zinc-700" style={{writingMode: 'vertical-rl', transform: 'rotate(180deg)'}}>
                                                  {libraryPreviewSize.height > 0 ? `${libraryPreviewSize.height}px` : 'Hug'}
                                                </span>
                                              </div>
                                            </>
                                          )}
                                          <InteractiveReactPreview 
                                            code={liveCode}
                                            background={libraryBackground === "light" ? "light" : "dark"}
                                            className=""
                                            onSizeChange={setLibraryPreviewSize}
                                            onAccessibilityResults={setAccessibilityResults}
                                            isFullWidth={isFullWidthComponent}
                                          />
                                        </div>
                                        );
                                      })() : (
                                        <div className="px-6 py-3 rounded-lg font-medium bg-blue-600 text-white inline-block">
                                          {selectedComponent.name}
                                        </div>
                                      )}
                                      </div>
                                      </div>
                                    </div>
                                  );
                                })()}
                                
                                {/* Code Display (collapsible) - LIVE with props override */}
                                {showLibraryCode && (() => {
                                  // Generate live usage code with current props
                                  const liveUsageCode = generateLiveCode(
                                    selectedComponent.name,
                                    selectedComponent.props || [],
                                    libraryPropsOverride
                                  );
                                  const liveHtmlCode = applyPropsToCode(
                                    selectedComponent.code || '', 
                                    selectedComponent.props || [], 
                                    libraryPropsOverride
                                  );
                                  
                                  return (
                                    <div className={cn(
                                      "border-t max-w-full",
                                      libraryBackground === "light" ? "border-zinc-200 bg-[#1e1e1e]" : "border-zinc-800 bg-[#0d0d0d]"
                                    )}>
                                      {/* Usage Code */}
                                      <div className="border-b border-zinc-800/50">
                                        <div className="flex items-center justify-between px-4 py-2 border-b border-zinc-800/30">
                                          <div className="flex items-center gap-2">
                                            <span className="text-[10px] text-emerald-500 font-medium uppercase">Usage</span>
                                            <span className="text-[11px] text-zinc-500 font-mono">{selectedComponent.name}</span>
                                          </div>
                                          <button 
                                            className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors" 
                                            title="Copy usage"
                                            onClick={() => {
                                              navigator.clipboard.writeText(liveUsageCode);
                                              showToast("Usage copied!", "success");
                                            }}
                                          >
                                            <Copy className="w-3.5 h-3.5 text-zinc-400" />
                                          </button>
                                        </div>
                                        <Highlight theme={themes.nightOwl} code={liveUsageCode} language="tsx">
                                          {({ style, tokens, getLineProps, getTokenProps }) => (
                                            <pre className="p-4 text-[13px] leading-relaxed" style={{ ...style, background: "transparent", fontFamily: "'JetBrains Mono', monospace" }}>
                                              {tokens.map((line, i) => (
                                                <div key={i} {...getLineProps({ line })}>
                                                  {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                                </div>
                                              ))}
                                            </pre>
                                          )}
                                        </Highlight>
                                      </div>
                                      
                                      {/* HTML Output */}
                                      <div>
                                        <div className="flex items-center justify-between px-4 py-2 border-b border-zinc-800/30">
                                          <div className="flex items-center gap-2">
                                            <Code className="w-3.5 h-3.5 text-zinc-500" />
                                            <span className="text-[11px] text-zinc-400 font-mono">{selectedComponent.name}.tsx</span>
                                          </div>
                                          <button 
                                            className="p-1.5 hover:bg-zinc-800 rounded-md transition-colors" 
                                            title="Copy HTML"
                                            onClick={() => {
                                              navigator.clipboard.writeText(liveHtmlCode);
                                              showToast("HTML copied!", "success");
                                            }}
                                          >
                                            <Copy className="w-3.5 h-3.5 text-zinc-400" />
                                          </button>
                                        </div>
                                        <Highlight theme={themes.nightOwl} code={liveHtmlCode || "// No code available"} language="html">
                                          {({ style, tokens, getLineProps, getTokenProps }) => (
                                            <pre className="p-4 text-[13px] leading-relaxed overflow-x-auto max-h-[300px] overflow-y-auto" style={{ ...style, background: "transparent", fontFamily: "'JetBrains Mono', monospace" }}>
                                              {tokens.map((line, i) => (
                                                <div key={i} {...getLineProps({ line })}>
                                                  {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                                                </div>
                                              ))}
                                            </pre>
                                          )}
                                        </Highlight>
                                      </div>
                                    </div>
                                  );
                                })()}
                              </div>
                              </div>{/* End scrollable content */}
                              
                              {/* Storybook-style Panel with Tabs: Controls, Actions, Interactions, Visual tests, Accessibility */}
                              {/* STICKY AT BOTTOM with collapsible panel */}
                              {(() => {
                                const propsCount = selectedComponent.props?.length || 0;
                                const variantsCount = selectedComponent.variants?.length || 0;
                                
                                // Tab definitions - only show tabs with real data
                                const accessibilityCount = Array.isArray(selectedComponent.accessibility) ? selectedComponent.accessibility.length : 0;
                                const usageCount = selectedComponent.usageLocations?.length || 0;
                                
                                const tabs = [
                                  { id: "controls", label: "Controls", count: propsCount, show: true },
                                  { id: "interactions", label: "Interactions", count: variantsCount, show: variantsCount > 0 },
                                  { id: "accessibility", label: "Accessibility", count: accessibilityCount, show: true },
                                  { id: "usage", label: "Usage", count: usageCount, show: usageCount > 0 },
                                ].filter(t => t.show);
                                
                                return (
                                  <div className={cn(
                                    "border-t w-full flex-shrink-0 transition-all duration-200",
                                    libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-[#111111]",
                                    libraryPanelCollapsed ? "h-10" : "h-[280px]"
                                  )}>
                                    {/* Tab Bar with collapse toggle */}
                                    <div className={cn(
                                      "flex items-center justify-between px-4 border-b h-10 flex-shrink-0",
                                      libraryBackground === "light" ? "border-zinc-200" : "border-zinc-800"
                                    )}>
                                      <div className="flex items-center gap-1">
                                      {tabs.map((tab) => (
                                        <button
                                          key={tab.id}
                                          onClick={() => setLibraryPanel(tab.id as LibraryPanel)}
                                          className={cn(
                                            "flex items-center gap-1.5 px-3 py-2.5 text-sm font-medium border-b-2 -mb-px transition-colors",
                                            libraryPanel === tab.id
                                              ? libraryBackground === "light" 
                                                ? "border-zinc-400 text-zinc-800" 
                                                : "border-zinc-400 text-white"
                                              : libraryBackground === "light"
                                                ? "border-transparent text-zinc-500 hover:text-zinc-700"
                                                : "border-transparent text-zinc-500 hover:text-zinc-300"
                                          )}
                                        >
                                          {tab.label}
                                          {tab.count > 0 && (
                                            <span className={cn(
                                              "text-[10px] px-1.5 py-0.5 rounded-full",
                                              libraryPanel === tab.id
                                                ? "bg-zinc-700 text-white"
                                                : libraryBackground === "light" 
                                                  ? "bg-zinc-200 text-zinc-600"
                                                  : "bg-zinc-800 text-zinc-500"
                                            )}>
                                              {tab.count}
                                            </span>
                                          )}
                                        </button>
                                      ))}
                                      </div>
                                      {/* Collapse toggle button */}
                                      <button
                                        onClick={() => setLibraryPanelCollapsed(!libraryPanelCollapsed)}
                                        className={cn(
                                          "p-1.5 rounded-md transition-colors",
                                          libraryBackground === "light" ? "hover:bg-zinc-200 text-zinc-500" : "hover:bg-zinc-800 text-zinc-500"
                                        )}
                                        title={libraryPanelCollapsed ? "Expand panel" : "Collapse panel"}
                                      >
                                        {libraryPanelCollapsed ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                      </button>
                                    </div>
                                    
                                    {/* Tab Content - Fixed height with scroll */}
                                    {!libraryPanelCollapsed && (
                                    <div className="w-full h-[240px] overflow-y-auto">
                                      {/* Controls Tab */}
                                      {libraryPanel === "controls" && propsCount > 0 && (
                                        <table className="w-full text-sm">
                                          <colgroup>
                                            <col style={{ width: '140px' }} />
                                            <col style={{ width: '35%' }} />
                                            <col style={{ width: '100px' }} />
                                            <col style={{ width: '180px' }} />
                                          </colgroup>
                                          <thead className="sticky top-0 z-10">
                                            <tr className={cn(
                                              "text-left border-b",
                                              libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900"
                                            )}>
                                              <th className={cn("px-3 py-2 font-medium text-xs whitespace-nowrap", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Name</th>
                                              <th className={cn("px-3 py-2 font-medium text-xs", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Description</th>
                                              <th className={cn("px-3 py-2 font-medium text-xs whitespace-nowrap", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Default</th>
                                              <th className={cn("px-3 py-2 font-medium text-xs whitespace-nowrap", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>Control</th>
                                            </tr>
                                          </thead>
                                          <tbody>
                                            {selectedComponent.props?.map((prop: any) => (
                                              <tr key={prop.name} className={cn(
                                                "border-b last:border-b-0",
                                                libraryBackground === "light" ? "border-zinc-100 hover:bg-zinc-50" : "border-zinc-800/50 hover:bg-zinc-800/30"
                                              )}>
                                                <td className="px-3 py-2 align-top">
                                                  <div className="flex flex-col">
                                                    <span className={cn("font-mono text-xs font-medium truncate", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                                      {prop.name}
                                                      {prop.required && <span className="text-red-500 ml-0.5">*</span>}
                                                    </span>
                                                    <span className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>
                                                      {prop.type || "string"}
                                                    </span>
                                                  </div>
                                                </td>
                                                <td className={cn("px-3 py-2 text-xs align-top", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                  <span className="line-clamp-2">{prop.description || "-"}</span>
                                                </td>
                                                <td className={cn("px-3 py-2 font-mono text-[10px] truncate align-top", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>
                                                  {prop.defaultValue !== undefined && prop.defaultValue !== "" ? String(prop.defaultValue).slice(0, 15) : '""'}
                                                </td>
                                                <td className="px-3 py-2 align-top">
                                                  {prop.control === "select" || prop.type === "enum" ? (
                                                    <select 
                                                      className={cn(
                                                        "rounded-md px-2.5 py-1.5 text-xs border cursor-pointer min-w-[120px]",
                                                        libraryBackground === "light" 
                                                          ? "bg-white border-zinc-300 text-zinc-900 hover:border-zinc-400" 
                                                          : "bg-zinc-800 border-zinc-700 text-zinc-200 hover:border-zinc-600"
                                                      )}
                                                      value={libraryPropsOverride[prop.name] ?? prop.defaultValue ?? ''}
                                                      onChange={(e) => setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: e.target.value }))}
                                                    >
                                                      <option value="">Choose...</option>
                                                      {(prop.options || []).map((opt: string) => (
                                                        <option key={opt} value={opt}>{opt}</option>
                                                      ))}
                                                    </select>
                                                  ) : prop.control === "toggle" || prop.type === "boolean" ? (
                                                    (() => {
                                                      // Convert string "true"/"false" to actual boolean
                                                      const rawValue = libraryPropsOverride[prop.name] ?? prop.defaultValue;
                                                      const isTrue = rawValue === true || rawValue === 'true' || rawValue === 'True';
                                                      return (
                                                        <div className="inline-flex items-center p-0.5 rounded-lg bg-zinc-800 border border-zinc-700">
                                                          <button 
                                                            type="button"
                                                            className={cn(
                                                              "px-3 py-1.5 text-xs font-medium rounded-md transition-all whitespace-nowrap",
                                                              !isTrue
                                                                ? "bg-zinc-700 text-white shadow-sm"
                                                                : "text-zinc-500 hover:text-zinc-300"
                                                            )}
                                                            onClick={() => setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: false }))}
                                                          >
                                                            False
                                                          </button>
                                                          <button 
                                                            type="button"
                                                            className={cn(
                                                              "px-3 py-1.5 text-xs font-medium rounded-md transition-all whitespace-nowrap",
                                                              isTrue
                                                                ? "bg-zinc-700 text-white shadow-sm"
                                                                : "text-zinc-500 hover:text-zinc-300"
                                                            )}
                                                            onClick={() => setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: true }))}
                                                          >
                                                            True
                                                          </button>
                                                        </div>
                                                      );
                                                    })()
                                                  ) : prop.control === "number" || prop.type === "number" ? (
                                                    <input 
                                                      type="number"
                                                      value={libraryPropsOverride[prop.name] ?? prop.defaultValue ?? ''} 
                                                      className={cn(
                                                        "rounded-md px-2.5 py-1.5 text-xs border w-24 font-mono",
                                                        libraryBackground === "light" 
                                                          ? "bg-white border-zinc-300 text-zinc-900 focus:border-blue-400" 
                                                          : "bg-zinc-800 border-zinc-700 text-zinc-200 focus:border-zinc-500"
                                                      )}
                                                      onChange={(e) => setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: e.target.value }))}
                                                    />
                                                  ) : prop.name.toLowerCase().includes('color') ? (
                                                    <div className="flex items-center gap-2">
                                                      {/* Advanced color picker with contrast ratio */}
                                                      {(() => {
                                                        const currentVal = (libraryPropsOverride[prop.name] ?? prop.defaultValue ?? '').toString();
                                                        // Extract hex color from value - handles both "#fff" and "text-[#f26522]" formats
                                                        const hexMatch = currentVal.match(/#[0-9A-Fa-f]{3,8}/);
                                                        const displayColor = hexMatch ? hexMatch[0] : '#6366f1';
                                                        return (
                                                          <Popover>
                                                            <PopoverTrigger asChild>
                                                              <button className="flex items-center gap-2 group">
                                                                <div 
                                                                  className={cn(
                                                                    "w-7 h-7 rounded-md border-2 shadow-md transition-all group-hover:scale-110 cursor-pointer",
                                                                    libraryBackground === "light" ? "border-zinc-300" : "border-zinc-600"
                                                                  )}
                                                                  style={{ backgroundColor: displayColor }}
                                                                />
                                                                <span className={cn(
                                                                  "text-xs font-mono",
                                                                  libraryBackground === "light" ? "text-zinc-700" : "text-zinc-400"
                                                                )}>
                                                                  {displayColor}
                                                                </span>
                                                              </button>
                                                            </PopoverTrigger>
                                                            <PopoverContent className="w-auto p-0" align="start">
                                                              <ColorPicker
                                                                value={displayColor}
                                                                onValueChange={(val) => {
                                                                  setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: val.hex }));
                                                                }}
                                                              />
                                                            </PopoverContent>
                                                          </Popover>
                                                        );
                                                      })()}
                                                    </div>
                                                  ) : (
                                                    <input 
                                                      type="text"
                                                      value={libraryPropsOverride[prop.name] ?? prop.defaultValue ?? ''} 
                                                      placeholder={prop.name}
                                                      className={cn(
                                                        "rounded px-2 py-1 text-xs border w-full max-w-[160px]",
                                                        libraryBackground === "light" 
                                                          ? "bg-white border-zinc-300 text-zinc-900 focus:border-blue-400" 
                                                          : "bg-zinc-800 border-zinc-700 text-zinc-200 focus:border-zinc-500"
                                                      )}
                                                      onChange={(e) => setLibraryPropsOverride(prev => ({ ...prev, [prop.name]: e.target.value }))}
                                                    />
                                                  )}
                                                </td>
                                              </tr>
                                            ))}
                                          </tbody>
                                        </table>
                                      )}
                                      
                                      {libraryPanel === "controls" && propsCount === 0 && (
                                        <div className="p-4">
                                          <p className={cn("text-xs mb-3", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                            Default controls (no custom props detected)
                                          </p>
                                          <table className="w-full text-sm">
                                            <tbody>
                                              <tr className={cn("border-b", libraryBackground === "light" ? "border-zinc-100" : "border-zinc-800/50")}>
                                                <td className="px-4 py-2.5">
                                                  <span className={cn("font-mono text-xs font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>className</span>
                                                  <br /><span className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>string</span>
                                                </td>
                                                <td className={cn("px-4 py-2.5 text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>Additional CSS classes</td>
                                                <td className={cn("px-4 py-2.5 font-mono text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>""</td>
                                                <td className="px-4 py-2.5">
                                                  <input 
                                                    type="text" 
                                                    placeholder="e.g. mt-4 p-2" 
                                                    value={libraryPropsOverride['className'] || ''}
                                                    onChange={(e) => setLibraryPropsOverride(prev => ({ ...prev, className: e.target.value }))}
                                                    className={cn("rounded px-2 py-1 text-xs border w-32", libraryBackground === "light" ? "bg-white border-zinc-300" : "bg-zinc-800 border-zinc-700 text-zinc-200")} 
                                                  />
                                                </td>
                                              </tr>
                                              <tr className={cn("border-b", libraryBackground === "light" ? "border-zinc-100" : "border-zinc-800/50")}>
                                                <td className="px-4 py-2.5">
                                                  <span className={cn("font-mono text-xs font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>children</span>
                                                  <br /><span className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>ReactNode</span>
                                                </td>
                                                <td className={cn("px-4 py-2.5 text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>Content inside component</td>
                                                <td className={cn("px-4 py-2.5 font-mono text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>-</td>
                                                <td className="px-4 py-2.5">
                                                  <input 
                                                    type="text" 
                                                    placeholder="Text content..." 
                                                    value={libraryPropsOverride['children'] || ''}
                                                    onChange={(e) => setLibraryPropsOverride(prev => ({ ...prev, children: e.target.value }))}
                                                    className={cn("rounded px-2 py-1 text-xs border w-32", libraryBackground === "light" ? "bg-white border-zinc-300" : "bg-zinc-800 border-zinc-700 text-zinc-200")} 
                                                  />
                                                </td>
                                              </tr>
                                              <tr>
                                                <td className="px-4 py-2.5">
                                                  <span className={cn("font-mono text-xs font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>onClick</span>
                                                  <br /><span className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>function</span>
                                                </td>
                                                <td className={cn("px-4 py-2.5 text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>Click handler</td>
                                                <td className={cn("px-4 py-2.5 font-mono text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>-</td>
                                                <td className="px-4 py-2.5">
                                                  <span className={cn("text-xs px-2 py-1 rounded", libraryBackground === "light" ? "bg-zinc-100 text-zinc-500" : "bg-zinc-800 text-zinc-500")}>() =&gt; {"{}"}</span>
                                                </td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </div>
                                      )}
                                      
                                      {/* Interactions Tab */}
                                      {libraryPanel === "interactions" && (
                                        <div className="p-4">
                                          {variantsCount > 0 ? (
                                            <div className="space-y-3">
                                              <p className={cn("text-xs mb-3", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Component interactions and variant states
                                              </p>
                                              {selectedComponent.variants?.map((variant: any, i: number) => (
                                                <div 
                                                  key={i}
                                                  className={cn(
                                                    "flex items-center gap-3 p-3 rounded-lg border",
                                                    libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-800/50"
                                                  )}
                                                >
                                                  <Check className="w-4 h-4 text-emerald-500" />
                                                  <div className="flex-1">
                                                    <p className={cn("text-sm font-medium", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>
                                                      {variant.name}
                                                    </p>
                                                    <p className={cn("text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                      {Object.keys(variant.props || {}).length} props configured
                                                    </p>
                                                  </div>
                                                  <button
                                                    onClick={() => setLibraryPropsOverride(variant.props || {})}
                                                    className="text-xs text-zinc-400 hover:text-white"
                                                  >
                                                    Apply
                                                  </button>
                                                </div>
                                              ))}
                                            </div>
                                          ) : (
                                            <div className="text-center py-8">
                                              <Play className={cn("w-8 h-8 mx-auto mb-3", libraryBackground === "light" ? "text-zinc-300" : "text-zinc-700")} />
                                              <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                No interactions defined
                                              </p>
                                            </div>
                                          )}
                                        </div>
                                      )}
                                      
                                      {/* Accessibility Tab - Real axe-core checks */}
                                      {libraryPanel === "accessibility" && (() => {
                                        const violations = accessibilityResults?.violations || [];
                                        const passes = accessibilityResults?.passes || [];
                                        const incomplete = accessibilityResults?.incomplete || [];
                                        
                                        const criticalViolations = violations.filter(v => v.impact === 'critical');
                                        const seriousViolations = violations.filter(v => v.impact === 'serious');
                                        const moderateViolations = violations.filter(v => v.impact === 'moderate');
                                        const minorViolations = violations.filter(v => v.impact === 'minor');
                                        
                                        const hasViolations = violations.length > 0;
                                        const hasCritical = criticalViolations.length > 0;
                                        
                                        // Impact colors
                                        const impactColor = (impact: string) => {
                                          switch (impact) {
                                            case 'critical': return 'text-red-500 bg-red-500/10 border-red-500/30';
                                            case 'serious': return 'text-orange-500 bg-orange-500/10 border-orange-500/30';
                                            case 'moderate': return 'text-amber-500 bg-amber-500/10 border-amber-500/30';
                                            case 'minor': return 'text-blue-500 bg-blue-500/10 border-blue-500/30';
                                            default: return 'text-zinc-500 bg-zinc-500/10 border-zinc-500/30';
                                          }
                                        };
                                        
                                        return (
                                        <div className="p-4 space-y-4">
                                          {/* Summary counts - Storybook style */}
                                          <div className="grid grid-cols-3 gap-2">
                                            <div className={cn(
                                              "p-3 rounded-lg border text-center",
                                              violations.length > 0 
                                                ? (libraryBackground === "light" ? "border-red-200 bg-red-50" : "border-red-900/50 bg-red-950/30")
                                                : (libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50")
                                            )}>
                                              <div className={cn("text-2xl font-bold", violations.length > 0 ? "text-red-500" : (libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600"))}>
                                                {violations.length}
                                              </div>
                                              <div className={cn("text-[10px] uppercase tracking-wider", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Violations
                                              </div>
                                            </div>
                                            <div className={cn(
                                              "p-3 rounded-lg border text-center",
                                              libraryBackground === "light" ? "border-emerald-200 bg-emerald-50" : "border-emerald-900/50 bg-emerald-950/30"
                                            )}>
                                              <div className="text-2xl font-bold text-emerald-500">{passes.length}</div>
                                              <div className={cn("text-[10px] uppercase tracking-wider", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Passes
                                              </div>
                                            </div>
                                            <div className={cn(
                                              "p-3 rounded-lg border text-center",
                                              libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50"
                                            )}>
                                              <div className={cn("text-2xl font-bold", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                                {incomplete.length}
                                              </div>
                                              <div className={cn("text-[10px] uppercase tracking-wider", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Incomplete
                                              </div>
                                            </div>
                                          </div>
                                          
                                          {/* Violations list */}
                                          {hasViolations && (
                                            <div>
                                              <p className={cn("text-xs font-medium uppercase tracking-wider mb-2", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Violations ({violations.length})
                                              </p>
                                              <div className="space-y-2">
                                                {violations.map((violation, i) => (
                                                  <div key={i} className={cn(
                                                    "p-3 rounded-lg border",
                                                    libraryBackground === "light" ? "border-zinc-200 bg-white" : "border-zinc-800 bg-zinc-900/50"
                                                  )}>
                                                    <div className="flex items-start gap-2">
                                                      <span className={cn("px-1.5 py-0.5 text-[10px] font-medium uppercase rounded border", impactColor(violation.impact))}>
                                                        {violation.impact}
                                                      </span>
                                                      <div className="flex-1 min-w-0">
                                                        <p className={cn("text-xs font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                                          {violation.help}
                                                        </p>
                                                        <p className={cn("text-[10px] mt-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                          {violation.description}
                                                        </p>
                                                        {violation.nodes.length > 0 && (
                                                          <div className="mt-2">
                                                            <p className={cn("text-[10px] font-medium mb-1", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                              Elements ({violation.nodes.length}):
                                                            </p>
                                                            {violation.nodes.slice(0, 3).map((node, j) => (
                                                              <pre key={j} className={cn(
                                                                "text-[9px] p-1.5 rounded mt-1 overflow-x-auto",
                                                                libraryBackground === "light" ? "bg-zinc-100 text-zinc-700" : "bg-zinc-800 text-zinc-300"
                                                              )}>
                                                                {node.html.length > 100 ? node.html.slice(0, 100) + '...' : node.html}
                                                              </pre>
                                                            ))}
                                                            {violation.nodes.length > 3 && (
                                                              <p className={cn("text-[10px] mt-1", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>
                                                                +{violation.nodes.length - 3} more elements
                                                              </p>
                                                            )}
                                                          </div>
                                                        )}
                                                        <a 
                                                          href={violation.helpUrl} 
                                                          target="_blank" 
                                                          rel="noopener noreferrer"
                                                          className="text-[10px] text-blue-500 hover:underline mt-2 inline-block"
                                                        >
                                                          Learn how to fix →
                                                        </a>
                                                      </div>
                                                    </div>
                                                  </div>
                                                ))}
                                              </div>
                                            </div>
                                          )}
                                          
                                          {/* Passes list - collapsible */}
                                          {passes.length > 0 && (
                                            <details className="group">
                                              <summary className={cn(
                                                "text-xs font-medium uppercase tracking-wider cursor-pointer flex items-center gap-1",
                                                libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500"
                                              )}>
                                                <ChevronRight className="w-3 h-3 transition-transform group-open:rotate-90" />
                                                Passes ({passes.length})
                                              </summary>
                                              <div className="mt-2 space-y-1">
                                                {passes.map((pass, i) => (
                                                  <div key={i} className={cn(
                                                    "flex items-center gap-2 py-1.5 px-2 rounded",
                                                    libraryBackground === "light" ? "hover:bg-zinc-50" : "hover:bg-zinc-800/50"
                                                  )}>
                                                    <span className="text-xs text-emerald-500">✓</span>
                                                    <span className={cn("text-xs", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                                      {pass.help}
                                                    </span>
                                                  </div>
                                                ))}
                                              </div>
                                            </details>
                                          )}
                                          
                                          {/* Incomplete checks */}
                                          {incomplete.length > 0 && (
                                            <details className="group">
                                              <summary className={cn(
                                                "text-xs font-medium uppercase tracking-wider cursor-pointer flex items-center gap-1",
                                                libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500"
                                              )}>
                                                <ChevronRight className="w-3 h-3 transition-transform group-open:rotate-90" />
                                                Incomplete ({incomplete.length})
                                              </summary>
                                              <div className="mt-2 space-y-1">
                                                {incomplete.map((item, i) => (
                                                  <div key={i} className={cn(
                                                    "flex items-start gap-2 py-1.5 px-2 rounded",
                                                    libraryBackground === "light" ? "hover:bg-zinc-50" : "hover:bg-zinc-800/50"
                                                  )}>
                                                    <span className={cn("text-xs mt-0.5", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>?</span>
                                                    <div>
                                                      <span className={cn("text-xs", libraryBackground === "light" ? "text-zinc-600" : "text-zinc-400")}>
                                                        {item.help}
                                                      </span>
                                                      <p className={cn("text-[10px]", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")}>
                                                        Needs manual review
                                                      </p>
                                                    </div>
                                                  </div>
                                                ))}
                                              </div>
                                            </details>
                                          )}
                                          
                                          {/* No results yet */}
                                          {!accessibilityResults && (
                                            <div className={cn(
                                              "p-6 rounded-lg border text-center",
                                              libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50"
                                            )}>
                                              <Loader2 className={cn("w-6 h-6 mx-auto mb-2 animate-spin", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                              <p className={cn("text-sm", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                Running accessibility checks...
                                              </p>
                                            </div>
                                          )}
                                          
                                          {/* All checks passed */}
                                          {accessibilityResults && !hasViolations && (
                                            <div className={cn(
                                              "p-4 rounded-lg border flex items-center gap-3",
                                              libraryBackground === "light" ? "border-emerald-200 bg-emerald-50" : "border-emerald-900/50 bg-emerald-950/30"
                                            )}>
                                              <div className="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center">
                                                <Check className="w-5 h-5 text-white" />
                                              </div>
                                              <div>
                                                <p className={cn("text-sm font-medium", libraryBackground === "light" ? "text-emerald-700" : "text-emerald-400")}>
                                                  All accessibility checks passed!
                                                </p>
                                                <p className={cn("text-xs", libraryBackground === "light" ? "text-emerald-600" : "text-emerald-500")}>
                                                  {passes.length} checks verified by axe-core
                                                </p>
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                        );
                                      })()}
                                      
                                      {/* Usage Tab - shows where component is used */}
                                      {libraryPanel === "usage" && (
                                        <div className="p-4">
                                          <div className={cn(
                                            "p-4 rounded-lg border mb-4",
                                            libraryBackground === "light" ? "border-zinc-200 bg-zinc-50" : "border-zinc-800 bg-zinc-900/50"
                                          )}>
                                            <div className="flex items-center gap-3 mb-3">
                                              <div className={cn("w-10 h-10 rounded-lg flex items-center justify-center", libraryBackground === "light" ? "bg-blue-100" : "bg-blue-900/30")}>
                                                <Link2 className={cn("w-5 h-5", libraryBackground === "light" ? "text-blue-600" : "text-blue-400")} />
                                              </div>
                                              <div>
                                                <p className={cn("text-sm font-medium", libraryBackground === "light" ? "text-zinc-800" : "text-zinc-200")}>
                                                  Component Usage
                                                </p>
                                                <p className={cn("text-xs", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                                  Found in {selectedComponent.usageLocations?.length || 1} location(s)
                                                </p>
                                              </div>
                                            </div>
                                          </div>
                                          
                                          <h4 className={cn("text-xs font-semibold uppercase tracking-wider mb-3", libraryBackground === "light" ? "text-zinc-500" : "text-zinc-500")}>
                                            Used in Pages
                                          </h4>
                                          <div className="space-y-2">
                                            {(selectedComponent.usageLocations || ['Main Page', 'Generated UI']).map((location: string, i: number) => (
                                              <div 
                                                key={i}
                                                className={cn(
                                                  "flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors",
                                                  libraryBackground === "light" 
                                                    ? "border-zinc-200 hover:bg-zinc-50" 
                                                    : "border-zinc-800 hover:bg-zinc-800/50"
                                                )}
                                              >
                                                <div className="flex items-center gap-3">
                                                  <FileText className={cn("w-4 h-4", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-500")} />
                                                  <span className={cn("text-sm", libraryBackground === "light" ? "text-zinc-700" : "text-zinc-300")}>
                                                    {location}
                                                  </span>
                                                </div>
                                                <ChevronRight className={cn("w-4 h-4", libraryBackground === "light" ? "text-zinc-400" : "text-zinc-600")} />
                                              </div>
                                            ))}
                                          </div>
                                          
                                          <div className={cn("mt-6 p-3 rounded-lg", libraryBackground === "light" ? "bg-amber-50 border border-amber-200" : "bg-amber-950/30 border border-amber-900/50")}>
                                            <p className={cn("text-xs", libraryBackground === "light" ? "text-amber-700" : "text-amber-400")}>
                                              <strong>Tip:</strong> Changes to this component will propagate to all usage locations automatically.
                                            </p>
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                    )}
                                  </div>
                                );
                              })()}
                              
                            </div>
                          ) : (
                            <div className="flex flex-col items-center justify-center h-full text-center p-8">
                              {isGeneratingLibrary ? (
                                <>
                                  <div className="relative w-10 h-10 mb-4">
                                    <div className="absolute inset-0 rounded-full border-2 border-zinc-700" />
                                    <div className="absolute inset-0 rounded-full border-2 border-zinc-400 border-t-transparent animate-spin" />
                                  </div>
                                  <p className="text-sm text-zinc-400">Loading...</p>
                                </>
                              ) : (
                                <>
                                  <div className="w-12 h-12 rounded-xl bg-zinc-800 flex items-center justify-center mb-4">
                                    <MousePointer className="w-5 h-5 text-zinc-500" />
                                  </div>
                                  <p className="text-sm text-zinc-400 mb-1">Select a component</p>
                                  <p className="text-xs text-zinc-600">Choose from the sidebar on the left</p>
                                </>
                              )}
                            </div>
                          )}
                        </div>
                      </>
                    );
                  })()}
                  
                </div>
              </div>
            )}

            {/* Blueprints - Infinite Canvas with Draggable Components */}
            {viewMode === "blueprints" && (
              <div className="flex-1 relative flex flex-col bg-[#111111]" style={{ overflow: 'clip' }}>
                {/* Show loader when processing */}
                {(isProcessing || isStreamingCode || isGeneratingBlueprintsComponent) ? (
                  <div className="w-full h-full flex items-center justify-center">
                    <LoadingState />
                  </div>
                ) : (
                  <>
                    
                    {/* Infinite Canvas - Pan & Zoom with Draggable Elements */}
                    <div 
                      ref={blueprintsCanvasRef}
                      className={cn(
                        "flex-1 relative",
                        draggingComponent ? "cursor-grabbing" : isBlueprintsPanning ? "cursor-grabbing" : "cursor-default",
                        blueprintsBackground === "transparent" ? "bg-[#0a0a0a]" : blueprintsBackground === "light" ? "bg-zinc-100" : "bg-[#111111]"
                      )}
                      style={{ 
                        overflow: 'clip', // Use clip instead of hidden - allows handles to be visible at component edges
                        backgroundImage: blueprintsBackground === "light"
                          ? `radial-gradient(circle, rgba(0,0,0,0.05) 1px, transparent 1px)`
                          : `radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px)`,
                        backgroundSize: `${24 * blueprintsZoom / 100}px ${24 * blueprintsZoom / 100}px`,
                        backgroundPosition: `${blueprintsOffset.x}px ${blueprintsOffset.y}px`
                      }}
                      onMouseDown={(e) => {
                        // Only start panning if clicking on canvas background (not on a component)
                        if (e.target === e.currentTarget || (e.target as HTMLElement).classList.contains('canvas-content')) {
                          setIsBlueprintsPanning(true);
                          setBlueprintsPanStart({ x: e.clientX - blueprintsOffset.x, y: e.clientY - blueprintsOffset.y });
                          setSelectedBlueprintComponent(null);
                        }
                      }}
                      onDoubleClick={(e) => {
                        // Create new component at click position - no prompt, inline editing
                        // DISABLED for demo projects
                        if (DEMO_PROJECT_IDS.has(activeGeneration?.id || '')) return;
                        
                        if (e.target === e.currentTarget || (e.target as HTMLElement).classList.contains('canvas-content')) {
                          const rect = blueprintsCanvasRef.current?.getBoundingClientRect();
                          if (!rect) return;
                          const scale = blueprintsZoom / 100;
                          const clickX = (e.clientX - rect.left - blueprintsOffset.x) / scale;
                          const clickY = (e.clientY - rect.top - blueprintsOffset.y) / scale;
                          
                          const newId = `new-${Date.now()}`;
                          const defaultName = "New Component";
                          const newComp = {
                            id: newId,
                            name: defaultName,
                            category: 'custom',
                            code: `<div className="p-6 bg-white rounded-xl shadow-lg border border-zinc-200">
  <h3 className="text-lg font-semibold text-zinc-900">${defaultName}</h3>
  <p className="text-sm text-zinc-500 mt-2">Double-click to edit in the panel</p>
</div>`,
                            props: [],
                            variants: []
                          };
                          setLibraryData((prev: any) => ({
                            ...prev,
                            components: [...(prev?.components || []), newComp]
                          }));
                          setBlueprintPositions(prev => ({
                            ...prev,
                            [`comp-${newId}`]: { x: clickX, y: clickY }
                          }));
                          // Broadcast to other users
                          broadcastLibraryComponentAdd(newComp);
                          broadcastBlueprintPosition(`comp-${newId}`, clickX, clickY);
                          setSelectedBlueprintComponent(`comp-${newId}`);
                          // Start inline editing for new component name
                          setEditingComponentName(newId);
                          setEditingNameValue(defaultName);
                        }
                      }}
                      onMouseMove={(e) => {
                        if (resizingComponent) {
                          // Resize component - FIXED: also update position for left/top handles
                          const scale = blueprintsZoom / 100;
                          const deltaX = (e.clientX - resizeStart.x) / scale;
                          const deltaY = (e.clientY - resizeStart.y) / scale;
                          const handle = resizingComponent.handle;
                          
                          let newWidth = resizeStart.width;
                          let newHeight = resizeStart.height;
                          let newPosX = resizeStart.posX;
                          let newPosY = resizeStart.posY;
                          
                          // East (right) edge - increase width
                          if (handle.includes('e')) {
                            newWidth = Math.max(60, resizeStart.width + deltaX);
                          }
                          // West (left) edge - increase width AND move position
                          if (handle.includes('w')) {
                            const widthDelta = Math.min(deltaX, resizeStart.width - 60); // Don't shrink below min
                            newWidth = Math.max(60, resizeStart.width - deltaX);
                            newPosX = resizeStart.posX + deltaX;
                            // Clamp position so component doesn't flip
                            if (newWidth <= 60) {
                              newPosX = resizeStart.posX + (resizeStart.width - 60);
                            }
                          }
                          // South (bottom) edge - increase height
                          if (handle.includes('s')) {
                            newHeight = Math.max(40, resizeStart.height + deltaY);
                          }
                          // North (top) edge - increase height AND move position
                          if (handle.includes('n')) {
                            newHeight = Math.max(40, resizeStart.height - deltaY);
                            newPosY = resizeStart.posY + deltaY;
                            // Clamp position so component doesn't flip
                            if (newHeight <= 40) {
                              newPosY = resizeStart.posY + (resizeStart.height - 40);
                            }
                          }
                          
                          // Update size
                          setBlueprintSizes(prev => ({
                            ...prev,
                            [resizingComponent.id]: { width: newWidth, height: newHeight }
                          }));
                          
                          // Update position if changed (for w/n handles)
                          if (handle.includes('w') || handle.includes('n')) {
                            setBlueprintPositions(prev => ({
                              ...prev,
                              [resizingComponent.id]: { x: newPosX, y: newPosY }
                            }));
                            broadcastBlueprintPosition(resizingComponent.id, newPosX, newPosY);
                          }
                          
                          // Notify iframe about resize for responsive content
                          const iframeEl = document.getElementById(`iframe-${resizingComponent.id.replace('comp-', '')}`) as HTMLIFrameElement;
                          if (iframeEl?.contentWindow) {
                            iframeEl.contentWindow.postMessage({ type: 'PARENT_RESIZE', width: newWidth, height: newHeight }, '*');
                          }
                          // Broadcast to other users
                          broadcastBlueprintSize(resizingComponent.id, newWidth, newHeight);
                        } else if (draggingComponent) {
                          // Move component
                          const rect = blueprintsCanvasRef.current?.getBoundingClientRect();
                          if (!rect) return;
                          const scale = blueprintsZoom / 100;
                          const newX = (e.clientX - rect.left - blueprintsOffset.x) / scale - dragStart.x;
                          const newY = (e.clientY - rect.top - blueprintsOffset.y) / scale - dragStart.y;
                          setBlueprintPositions(prev => ({
                            ...prev,
                            [draggingComponent]: { x: newX, y: newY }
                          }));
                          // Broadcast to other users
                          broadcastBlueprintPosition(draggingComponent, newX, newY);
                        } else if (isBlueprintsPanning) {
                          setBlueprintsOffset({
                            x: e.clientX - blueprintsPanStart.x,
                            y: e.clientY - blueprintsPanStart.y
                          });
                        }
                      }}
                      onMouseUp={() => {
                        // Mark component as manually resized so iframe auto-size doesn't override
                        if (resizingComponent) {
                          setManuallyResizedComponents(prev => new Set([...prev, resizingComponent.id]));
                        }
                        setDraggingComponent(null);
                        setResizingComponent(null);
                        setIsBlueprintsPanning(false);
                      }}
                      onMouseLeave={() => {
                        // DON'T reset resizingComponent on leave - user might be resizing outside canvas
                        // Only reset dragging and panning
                        setDraggingComponent(null);
                        setIsBlueprintsPanning(false);
                        // Keep resizingComponent active - will be reset on mouseUp anywhere
                      }}
                      onWheel={(e) => {
                        e.preventDefault();
                        const rect = blueprintsCanvasRef.current?.getBoundingClientRect();
                        if (!rect) return;
                        
                        const mouseX = e.clientX - rect.left;
                        const mouseY = e.clientY - rect.top;
                        const delta = e.deltaY > 0 ? -10 : 10;
                        const newZoom = Math.min(200, Math.max(25, blueprintsZoom + delta));
                        const zoomFactor = newZoom / blueprintsZoom;
                        
                        const newOffsetX = mouseX - (mouseX - blueprintsOffset.x) * zoomFactor;
                        const newOffsetY = mouseY - (mouseY - blueprintsOffset.y) * zoomFactor;
                        
                        setBlueprintsZoom(newZoom);
                        setBlueprintsOffset({ x: newOffsetX, y: newOffsetY });
                      }}
                      onDragOver={handleBlueprintDragOver}
                      onDragLeave={handleBlueprintDragLeave}
                      onDrop={handleBlueprintDrop}
                    >
                      {/* Drop zone overlay for Vision import */}
                      {isDraggingOverCanvas && (
                        <div className="absolute inset-0 z-50 bg-gradient-to-br from-violet-500/15 to-blue-500/15 backdrop-blur-sm border-2 border-dashed border-violet-500/60 rounded-xl flex items-center justify-center pointer-events-none">
                          <div className="text-center animate-pulse">
                            <div className="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-violet-500/30 to-blue-500/30 flex items-center justify-center shadow-lg shadow-violet-500/20">
                              <svg className="w-10 h-10 text-violet-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <path d="M21 15l-5-5L5 21" />
                                <path d="M12 8v8M8 12h8" strokeLinecap="round" />
                              </svg>
                            </div>
                            <p className="text-xl font-semibold text-white mb-1">Drop to Import</p>
                            <p className="text-sm text-violet-300">AI Vision will convert your image to code</p>
                            <div className="flex items-center justify-center gap-2 mt-3 text-xs text-zinc-400">
                              <span className="px-2 py-0.5 bg-zinc-800/80 rounded">Screenshot</span>
                              <span className="px-2 py-0.5 bg-zinc-800/80 rounded">Figma Frame</span>
                              <span className="px-2 py-0.5 bg-zinc-800/80 rounded">Design mockup</span>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Center Toolbar - Tool controls - neutral colors */}
                      <div className="absolute top-4 left-1/2 -translate-x-1/2 z-30 flex flex-wrap items-center justify-center gap-1 bg-zinc-900/98 backdrop-blur-xl rounded-xl p-1.5 border border-zinc-700/50 shadow-2xl shadow-black/40 max-w-[calc(100%-2rem)] sm:max-w-none">
                        {/* Grid toggle */}
                        <button 
                          onClick={() => setShowBlueprintsGrid(!showBlueprintsGrid)}
                          className={cn(
                            "p-2 rounded-lg transition-all duration-150 group relative",
                            showBlueprintsGrid 
                              ? "bg-zinc-700 text-white" 
                              : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                          )}
                        >
                          <Grid3X3 className="w-4 h-4" />
                          <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">Grid</span>
                        </button>
                        
                        {/* Background toggle - click dropdown */}
                        <div className="relative">
                          <button 
                            onClick={() => {
                              setShowBlueprintsBgDropdown(!showBlueprintsBgDropdown);
                              setShowBlueprintsVisionDropdown(false);
                            }}
                            className={cn(
                              "p-2 rounded-lg transition-all duration-150 flex items-center gap-1",
                              blueprintsBackground !== "dark" 
                                ? "bg-zinc-700 text-white" 
                                : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                            )}
                          >
                            {blueprintsBackground === "light" ? <Sun className="w-4 h-4" /> : blueprintsBackground === "transparent" ? <Grid2X2 className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                            <ChevronDown className="w-3 h-3" />
                          </button>
                          {showBlueprintsBgDropdown && (
                            <div className="absolute top-full left-0 mt-2 bg-zinc-900/98 backdrop-blur-xl border border-zinc-700/50 rounded-xl shadow-2xl min-w-[120px] py-1 z-50">
                              <span className="block px-3 py-1.5 text-[10px] text-zinc-500 uppercase tracking-wider">Background</span>
                              {(["dark", "light", "transparent"] as const).map((bg) => (
                                <button
                                  key={bg}
                                  onClick={() => {
                                    setBlueprintsBackground(bg);
                                    setShowBlueprintsBgDropdown(false);
                                  }}
                                  className={cn(
                                    "w-full px-3 py-1.5 text-xs text-left hover:bg-zinc-800 transition-colors flex items-center justify-between capitalize",
                                    blueprintsBackground === bg ? "bg-zinc-700 text-white" : "text-zinc-400"
                                  )}
                                >
                                  {bg}
                                  {blueprintsBackground === bg && <Check className="w-3 h-3" />}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                        
                        {/* Spacer to push New Component button to right */}
                        <div className="flex-1" />
                        
                        {/* + New Component - Creates component instantly on canvas (hidden for demo) */}
                        {!DEMO_PROJECT_IDS.has(activeGeneration?.id || '') && (
                          <button 
                            onClick={() => {
                              // Create new component instantly on canvas
                              const newId = `new_${Date.now()}`;
                              const newComponent = {
                                id: newId,
                                name: "New Component",
                                code: '<div className="p-4 bg-zinc-800 rounded-xl text-white text-center min-w-[200px] min-h-[80px] flex items-center justify-center"><p className="text-sm font-medium text-zinc-400">New Component</p></div>',
                                category: "CUSTOM",
                                description: "New custom component",
                                isNew: true // Flag for inline AI input
                              };
                              
                              // Add to library
                              setLibraryData((prev: any) => ({
                                ...prev,
                                components: [...(prev?.components || []), newComponent]
                              }));
                              
                              // Calculate center position on canvas
                              const canvasEl = blueprintsCanvasRef.current;
                              let centerX = 400, centerY = 300;
                              if (canvasEl) {
                                const rect = canvasEl.getBoundingClientRect();
                                centerX = (-blueprintsOffset.x + rect.width / 2) / (blueprintsZoom / 100);
                                centerY = (-blueprintsOffset.y + rect.height / 2) / (blueprintsZoom / 100);
                              }
                              
                              // Set position for new component
                              setBlueprintPositions(prev => ({
                                ...prev,
                                [`comp-${newId}`]: { x: centerX - 100, y: centerY - 50 }
                              }));
                              
                              // Select the new component to show edit bar
                              setSelectedBlueprintComponent(`comp-${newId}`);
                              setBlueprintEditedCode(null);
                              setBlueprintChatHistory([]);
                              
                              // Mark as draft
                              setBlueprintStatuses(prev => ({ ...prev, [newId]: 'draft' }));
                            }}
                            className={cn(
                              "px-4 py-2 rounded-lg transition-all duration-150 group relative flex items-center gap-2",
                              "bg-white/10 hover:bg-white/15",
                              "border border-white/20 hover:border-white/30",
                              "text-white font-medium"
                            )}
                          >
                            <Plus className="w-4 h-4" />
                            <span className="text-[12px]">New Component</span>
                          </button>
                        )}
                        <input 
                          ref={visionFileInputRef}
                          type="file"
                          accept="image/*"
                          className="hidden"
                          onChange={handleVisionFileSelect}
                        />
                        
                        <div className="w-px h-5 bg-zinc-700 mx-1" />
                        
                        {/* Vision Simulator dropdown - click */}
                        <div className="relative">
                          <button 
                            onClick={() => {
                              setShowBlueprintsVisionDropdown(!showBlueprintsVisionDropdown);
                              setShowBlueprintsBgDropdown(false);
                            }}
                            className={cn(
                              "p-2 rounded-lg transition-all duration-150 flex items-center gap-1",
                              blueprintsVisionMode !== "none" 
                                ? "bg-zinc-700 text-white" 
                                : "hover:bg-zinc-800 text-zinc-400 hover:text-zinc-200"
                            )}
                          >
                            <Eye className="w-4 h-4" />
                            <ChevronDown className="w-3 h-3" />
                          </button>
                          {showBlueprintsVisionDropdown && (
                            <div className="absolute top-full left-0 mt-2 bg-zinc-900/98 backdrop-blur-xl border border-zinc-700/50 rounded-xl shadow-2xl min-w-[160px] py-1 z-50">
                              <span className="block px-3 py-1.5 text-[10px] text-zinc-500 uppercase tracking-wider">Vision Simulator</span>
                              {[
                                { id: "none", label: "Normal" },
                                { id: "blur", label: "Blurred Vision" },
                                { id: "deuteranopia", label: "Deuteranopia" },
                                { id: "protanopia", label: "Protanopia" },
                                { id: "tritanopia", label: "Tritanopia" },
                                { id: "grayscale", label: "Grayscale" },
                              ].map((mode) => (
                                <button
                                  key={mode.id}
                                  onClick={() => {
                                    setBlueprintsVisionMode(mode.id as any);
                                    setShowBlueprintsVisionDropdown(false);
                                  }}
                                  className={cn(
                                    "w-full px-3 py-1.5 text-xs text-left hover:bg-zinc-800 transition-colors flex items-center justify-between",
                                    blueprintsVisionMode === mode.id ? "bg-zinc-700 text-white" : "text-zinc-400"
                                  )}
                                >
                                  {mode.label}
                                  {blueprintsVisionMode === mode.id && <Check className="w-3 h-3" />}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Zoom controls - bottom left (like Flow) */}
                      <div className="absolute bottom-4 left-4 z-30 flex items-center gap-1 bg-zinc-900/95 backdrop-blur-sm rounded-lg p-1 border border-zinc-800 shadow-xl">
                        <button 
                          onClick={() => setBlueprintsZoom(Math.max(25, blueprintsZoom - 25))}
                          className="p-1.5 rounded hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white"
                          title="Zoom out"
                        >
                          <ZoomOut className="w-4 h-4" />
                        </button>
                        <span className="text-xs text-zinc-300 w-12 text-center font-mono">{blueprintsZoom}%</span>
                        <button 
                          onClick={() => setBlueprintsZoom(Math.min(200, blueprintsZoom + 25))}
                          className="p-1.5 rounded hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white"
                          title="Zoom in"
                        >
                          <ZoomIn className="w-4 h-4" />
                        </button>
                        <div className="w-px h-4 bg-zinc-700 mx-1" />
                        <button 
                          onClick={() => { setBlueprintsZoom(100); setBlueprintsOffset({ x: 0, y: 0 }); }}
                          className="px-2 py-1 rounded hover:bg-zinc-800 transition-colors text-[10px] text-zinc-400 hover:text-white"
                          title="Reset view"
                        >
                          Reset
                        </button>
                        <div className="w-px h-4 bg-zinc-700 mx-1" />
                        <button 
                          onClick={autoLayoutBlueprints}
                          className="px-2 py-1 rounded hover:bg-zinc-800 transition-colors text-[10px] text-zinc-400 hover:text-white"
                          title="Auto-arrange"
                        >
                          Auto Layout
                        </button>
                      </div>
                      
                      {/* Canvas content layer */}
                      <div 
                        className={cn(
                          "canvas-content absolute inset-0",
                          showBlueprintsGrid && "bg-[linear-gradient(to_right,rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(to_bottom,rgba(255,255,255,0.03)_1px,transparent_1px)] bg-[size:20px_20px]"
                        )}
                        style={{ 
                          transform: `translate(${blueprintsOffset.x}px, ${blueprintsOffset.y}px) scale(${blueprintsZoom / 100})`,
                          transformOrigin: '0 0',
                          filter: blueprintsVisionMode === "blur" ? "blur(2px)" 
                            : blueprintsVisionMode === "deuteranopia" ? "url(#deuteranopia)" 
                            : blueprintsVisionMode === "protanopia" ? "url(#protanopia)"
                            : blueprintsVisionMode === "tritanopia" ? "url(#tritanopia)"
                            : blueprintsVisionMode === "grayscale" ? "grayscale(100%)" 
                            : undefined
                        }}
                      >
                        {/* Empty state */}
                        {(!libraryData || !libraryData.components || libraryData.components.length === 0) ? (
                          <div className="absolute inset-0 flex items-center justify-center bg-[#111111]">
                            <EmptyState icon="logo" title="Component Editor" subtitle="Generate from video to visualize and edit your component architecture." />
                          </div>
                        ) : (
                          <>
                            {/* Layer labels on canvas */}
                            {Object.entries(blueprintPositions)
                              .filter(([key]) => key.startsWith('label-'))
                              .map(([key, pos]) => {
                                const layerName = key.replace('label-', '');
                                const layerConfig: Record<string, { name: string; color: string }> = {
                                  components: { name: 'Components', color: 'text-blue-400' },
                                  patterns: { name: 'Patterns', color: 'text-amber-400' },
                                  templates: { name: 'Templates', color: 'text-teal-400' },
                                  product: { name: 'Product Modules', color: 'text-rose-400' },
                                  foundations: { name: 'Foundations', color: 'text-violet-400' },
                                };
                                const config = layerConfig[layerName] || { name: layerName, color: 'text-zinc-400' };
                                return (
                                  <div key={key} className="absolute pointer-events-none" style={{ transform: `translate(${pos.x}px, ${pos.y}px)` }}>
                                    <span className={cn("text-[11px] font-semibold uppercase tracking-wider opacity-60", config.color)}>
                                      {config.name}
                                    </span>
                                  </div>
                                );
                              })
                            }
                            {/* Draggable Components - FIGMA STYLE: just component + small name */}
                            {libraryData.components.map((comp: any) => {
                              const id = `comp-${comp.id}`;
                              const pos = blueprintPositions[id] || { x: 50, y: 100 };
                              const size = blueprintSizes[id];
                              const isSelected = selectedBlueprintComponent === id;
                              const isDragging = draggingComponent === id;
                              const isResizing = resizingComponent?.id === id;
                              const isGenerating = generatingBlueprintId === comp.id || (isEditingBlueprint && selectedBlueprintComponent === id);
                              const isRecentlyGenerated = recentlyGeneratedId === comp.id;
                              
                              return (
                                <div
                                  key={id}
                                  className={cn(
                                    "absolute select-none group",
                                    isRecentlyGenerated && "animate-[scaleUp_0.5s_ease-out]"
                                  )}
                                  style={{ 
                                    // Use transform instead of left/top for GPU-accelerated movement (prevents lag/ghosting)
                                    // Add padding for resize handles to be visible outside component
                                    transform: `translate(${pos.x - 16}px, ${pos.y - 16}px)`,
                                    padding: '16px',
                                    willChange: isDragging ? 'transform' : 'auto',
                                    zIndex: isDragging || isResizing ? 100 : isSelected ? 50 : 1,
                                    cursor: isDragging ? 'grabbing' : 'grab'
                                  }}
                                  onMouseDown={(e) => {
                                    // Don't start drag if clicking on resize handle
                                    if ((e.target as HTMLElement).dataset.resizeHandle) return;
                                    e.stopPropagation();
                                    setDraggingComponent(id);
                                    if (selectedBlueprintComponent !== id) {
                                      setSelectedBlueprintComponent(id);
                                      setBlueprintEditedCode(null);
                                      setBlueprintChatHistory([]);
                                    }
                                    const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();
                                    const canvasRect = blueprintsCanvasRef.current?.getBoundingClientRect();
                                    if (canvasRect) {
                                      const scale = blueprintsZoom / 100;
                                      setDragStart({
                                        x: (e.clientX - rect.left) / scale,
                                        y: (e.clientY - rect.top) / scale
                                      });
                                    }
                                  }}
                                  onDoubleClick={(e) => {
                                    e.stopPropagation();
                                    setSelectedLibraryItem(id);
                                    setViewMode("library");
                                  }}
                                >
                                  {/* Figma-style: name + quick actions */}
                                  <div className="mb-2 flex items-center justify-between gap-2">
                                    <span className={cn(
                                      "text-[11px] font-medium",
                                      isSelected ? "text-white" : "text-zinc-500"
                                    )}>{comp.name}</span>
                                    {/* Quick actions on hover/select */}
                                    <div className={cn(
                                      "flex items-center gap-1 transition-opacity",
                                      isSelected ? "opacity-100" : "opacity-0 group-hover:opacity-100"
                                    )}>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          // Duplicate component
                                          const newId = `${comp.id}-copy-${Date.now()}`;
                                          const newComp = {
                                            ...comp,
                                            id: newId,
                                            name: `${comp.name} (Copy)`
                                          };
                                          setLibraryData((prev: any) => ({
                                            ...prev,
                                            components: [...(prev?.components || []), newComp]
                                          }));
                                          // Position near original
                                          const pos = blueprintPositions[id] || { x: 100, y: 100 };
                                          setBlueprintPositions(prev => ({
                                            ...prev,
                                            [`comp-${newId}`]: { x: pos.x + 50, y: pos.y + 50 }
                                          }));
                                        }}
                                        className="p-1 rounded bg-zinc-800/80 hover:bg-zinc-700 text-zinc-400 hover:text-white"
                                        title="Duplicate"
                                      >
                                        <Copy className="w-3 h-3" />
                                      </button>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          const newName = prompt("Save to library as:", comp.name);
                                          if (newName) {
                                            // Update component name in library
                                            setLibraryData((prev: any) => ({
                                              ...prev,
                                              components: prev?.components?.map((c: any) => 
                                                c.id === comp.id ? { ...c, name: newName } : c
                                              ) || []
                                            }));
                                          }
                                        }}
                                        className="p-1 rounded bg-zinc-800/80 hover:bg-emerald-600 text-zinc-400 hover:text-white"
                                        title="Save to Library"
                                      >
                                        <Save className="w-3 h-3" />
                                      </button>
                                    </div>
                                  </div>
                                  
                                  {/* Pure component - clean minimal style like Library */}
                                  <div className={cn(
                                    "transition-all rounded overflow-hidden",
                                    isDragging && "opacity-80"
                                  )}>
                                    {comp.code ? (() => {
                                      // Use edited code for live preview if available
                                      const codeToUse = isSelected && blueprintEditedCode ? blueprintEditedCode : comp.code;
                                      
                                      // Apply live props override for selected component
                                      const liveCode = isSelected && Object.keys(blueprintPropsOverride).length > 0
                                        ? applyPropsToCode(codeToUse, comp.props || [], blueprintPropsOverride)
                                        : codeToUse;
                                      
                                      // Stabilize ALL image URLs (picsum, pravatar, pollinations) based on component id
                                      // First apply picsum stabilization
                                      let stableCode = stabilizePicsumUrls(liveCode);
                                      // Then stabilize pravatar and pollinations
                                      stableCode = stableCode
                                        .replace(/pravatar\.cc\/(\d+)\?(?!img=)/g, `pravatar.cc/$1?img=${Math.abs(comp.id?.charCodeAt(0) || 1) % 70 + 1}&`)
                                        .replace(/pravatar\.cc\/(\d+)(?:\?img=\d+)?$/g, `pravatar.cc/$1?img=${Math.abs(comp.id?.charCodeAt(0) || 1) % 70 + 1}`)
                                        .replace(/pollinations\.ai\/prompt\/([^?]+)\?/g, `pollinations.ai/prompt/$1?seed=${comp.id || 'stable'}&`);
                                      
                                      // Determine if this is a full-width component
                                      // Check name, category, and code for full-width indicators
                                      const nameLower = comp.name?.toLowerCase() || '';
                                      const codeLower = stableCode?.toLowerCase() || '';
                                      const layerLower = comp.layer?.toLowerCase() || '';
                                      const isFullWidthComp = ['product', 'templates'].includes(layerLower) ||
                                         nameLower.includes('hero') || nameLower.includes('footer') ||
                                         nameLower.includes('section') || nameLower.includes('header') ||
                                         nameLower.includes('landing') || nameLower.includes('banner') ||
                                         nameLower.includes('layout') || nameLower.includes('page') || nameLower.includes('shell') ||
                                         // Also detect by code patterns - if it has full viewport styling
                                         codeLower.includes('min-h-screen') || codeLower.includes('h-screen') ||
                                         (codeLower.includes('w-full') && (codeLower.includes('100vh') || codeLower.includes('min-h-[')));
                                      
                                      // During generation OR new component: force fixed compact size
                                      const isGeneratingThis = isGenerating;
                                      const isNewUngenerated = comp.isNew && !isGeneratingThis;
                                      const needsFixedSize = isGeneratingThis || isNewUngenerated;
                                      
                                      // Check if user manually resized OR is currently resizing this component
                                      const wasManuallyResized = manuallyResizedComponents.has(id);
                                      const isCurrentlyResizing = resizingComponent?.id === id;
                                      const useStoredSize = wasManuallyResized || isCurrentlyResizing;
                                      
                                      // If resized/resizing, use stored size directly. Otherwise minimal defaults.
                                      let finalWidth: number | string;
                                      let finalHeight: number;
                                      
                                      if (useStoredSize && size) {
                                        // Use stored size exactly - user is in control
                                        finalWidth = size.width;
                                        finalHeight = size.height;
                                      } else if (needsFixedSize) {
                                        // Generating/new - placeholder
                                        finalWidth = 320;
                                        finalHeight = 120;
                                      } else if (size) {
                                        // Use iframe-reported size — real content dimensions
                                        finalWidth = isFullWidthComp ? Math.max(size.width, 800) : size.width;
                                        finalHeight = size.height;
                                      } else {
                                        // No size yet - comfortable default
                                        finalWidth = isFullWidthComp ? 800 : 400;
                                        finalHeight = 250;
                                      }
                                      
                                      return (
                                      <div 
                                        className="relative"
                                        data-component-container={id}
                                        style={{
                                          // CANVAS: freely resizable
                                          width: typeof finalWidth === 'string' ? finalWidth : `${finalWidth}px`,
                                          height: `${finalHeight}px`,
                                          overflow: 'hidden',
                                        }}
                                      >
                                        {/* Content wrapper with overflow hidden */}
                                        <div className="w-full h-full overflow-hidden rounded relative">
                                          {/* Use same InteractiveReactPreview as Library for identical rendering */}
                                          {/* Iframe fills this container 100% - so resizing container = responsive content */}
                                          <InteractiveReactPreview
                                            code={stableCode}
                                            background={blueprintsBackground}
                                            className="pointer-events-none w-full h-full"
                                            componentId={comp.id}
                                            onSizeChange={(newSize) => {
                                              // Always update size from content UNLESS manually resized OR currently resizing
                                              // This ensures new content auto-fits after generation but doesn't override resize
                                              const isBeingResized = resizingComponent?.id === id;
                                              if (!manuallyResizedComponents.has(id) && !isBeingResized) {
                                                setBlueprintSizes(prev => {
                                                  const existing = prev[id];
                                                  // Only update if size changed significantly
                                                  if (existing && Math.abs(existing.width - newSize.width) < 10 && Math.abs(existing.height - newSize.height) < 10) {
                                                    return prev;
                                                  }
                                                  return {
                                                    ...prev,
                                                    [id]: { width: newSize.width, height: newSize.height }
                                                  };
                                                });
                                              }
                                            }}
                                            isFullWidth={isFullWidthComp}
                                          />
                                          
                                          {/* Shimmer overlay during generation */}
                                          {isGenerating && (
                                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-zinc-900/80 backdrop-blur-sm rounded overflow-hidden">
                                              {/* Animated gradient shimmer */}
                                              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent animate-[shimmer_2s_infinite]" 
                                                   style={{ backgroundSize: '200% 100%' }} />
                                              <div className="relative flex flex-col items-center gap-3">
                                                <div className="w-8 h-8 border-2 border-zinc-600 border-t-emerald-500 rounded-full animate-spin" />
                                                <span className="text-xs text-zinc-400 font-medium">Generating...</span>
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                        {/* Selection indicator - OUTSIDE overflow:hidden wrapper for visible handles */}
                                        {isSelected && (
                                          <>
                                            {/* Simple selection border - HIGH z-index to be on top */}
                                            <div className="absolute inset-0 border-2 border-blue-500 rounded pointer-events-none z-[9998]" />
                                            
                                            {/* Resize handles - all 4 corners + 4 edges - BIGGER for visibility */}
                                            {/* Corner: top-left */}
                                            <div 
                                              data-resize-handle="nw"
                                              className="absolute -top-1.5 -left-1.5 w-3 h-3 bg-blue-500 border-2 border-white rounded-sm cursor-nw-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-125 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                // Get actual size from DOM FIRST - before setting resizing state
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                // CRITICAL: Update blueprintSizes with displayed size BEFORE triggering re-render
                                                // This prevents "jump" from capped to uncapped size
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'nw' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Corner: top-right */}
                                            <div 
                                              data-resize-handle="ne"
                                              className="absolute -top-1.5 -right-1.5 w-3 h-3 bg-blue-500 border-2 border-white rounded-sm cursor-ne-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-125 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'ne' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Corner: bottom-left */}
                                            <div 
                                              data-resize-handle="sw"
                                              className="absolute -bottom-1.5 -left-1.5 w-3 h-3 bg-blue-500 border-2 border-white rounded-sm cursor-sw-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-125 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'sw' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Corner: bottom-right */}
                                            <div 
                                              data-resize-handle="se"
                                              className="absolute -bottom-1.5 -right-1.5 w-3 h-3 bg-blue-500 border-2 border-white rounded-sm cursor-se-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-125 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'se' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Edge: top */}
                                            <div 
                                              data-resize-handle="n"
                                              className="absolute -top-1 left-1/2 -translate-x-1/2 w-6 h-2 bg-blue-500 border border-white rounded-sm cursor-n-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-110 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'n' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Edge: bottom */}
                                            <div 
                                              data-resize-handle="s"
                                              className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-6 h-2 bg-blue-500 border border-white rounded-sm cursor-s-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-110 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 's' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Edge: left */}
                                            <div 
                                              data-resize-handle="w"
                                              className="absolute top-1/2 -left-1 -translate-y-1/2 w-2 h-6 bg-blue-500 border border-white rounded-sm cursor-w-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-110 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'w' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            {/* Edge: right */}
                                            <div 
                                              data-resize-handle="e"
                                              className="absolute top-1/2 -right-1 -translate-y-1/2 w-2 h-6 bg-blue-500 border border-white rounded-sm cursor-e-resize z-[9999] hover:bg-blue-400 shadow-lg hover:scale-110 transition-transform"
                                              onMouseDown={(e) => {
                                                e.stopPropagation();
                                                const container = (e.currentTarget as HTMLElement).closest('[data-component-container]');
                                                const rect = container?.getBoundingClientRect();
                                                const scale = blueprintsZoom / 100;
                                                const actualWidth = rect ? rect.width / scale : (size?.width || 200);
                                                const actualHeight = rect ? rect.height / scale : (size?.height || 200);
                                                const currentPos = blueprintPositions[id] || pos;
                                                setBlueprintSizes(prev => ({
                                                  ...prev,
                                                  [id]: { width: actualWidth, height: actualHeight }
                                                }));
                                                setResizingComponent({ id, handle: 'e' });
                                                setResizeStart({ x: e.clientX, y: e.clientY, width: actualWidth, height: actualHeight, posX: currentPos.x, posY: currentPos.y });
                                              }}
                                            />
                                            
                                            {/* Dimension labels removed from blueprints - only in Library */}
                                          </>
                                        )}
                                      </div>
                                      );
                                    })() : (
                                      <div className="px-4 py-2 bg-zinc-800/50 rounded text-xs text-zinc-500">
                                        {comp.name}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </>
                        )}
                      </div>
                      
                      {/* ═══════════════════════════════════════════════════════════════════════════
                          FLOATING AI COMMAND BAR - Vercel v0 / Spotlight Style
                          Bottom-center, glassmorphic, appears when component is selected
                         ═══════════════════════════════════════════════════════════════════════════ */}
                      {selectedBlueprintComponent && (() => {
                        const compId = selectedBlueprintComponent.replace('comp-', '');
                        const selectedComp = libraryData?.components?.find((c: any) => c.id === compId);
                        if (!selectedComp) return null;
                        
                        return (
                          <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-50 w-full max-w-2xl px-4">
                            {/* Main Floating Bar */}
                            <div className="bg-zinc-900/95 backdrop-blur-xl border border-zinc-700/50 rounded-2xl shadow-2xl shadow-black/50 overflow-hidden">
                              {/* Selected Component Header */}
                              <div className="px-4 py-2.5 border-b border-zinc-800/50 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                  {editingComponentName === compId ? (
                                    <input
                                      type="text"
                                      value={editingNameValue}
                                      onChange={(e) => setEditingNameValue(e.target.value)}
                                      onBlur={() => {
                                        if (editingNameValue.trim()) {
                                          setLibraryData((prev: any) => ({
                                            ...prev,
                                            components: prev?.components?.map((c: any) => 
                                              c.id === compId ? { ...c, name: editingNameValue.trim() } : c
                                            ) || []
                                          }));
                                        }
                                        setEditingComponentName(null);
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          if (editingNameValue.trim()) {
                                            setLibraryData((prev: any) => ({
                                              ...prev,
                                              components: prev?.components?.map((c: any) => 
                                                c.id === compId ? { ...c, name: editingNameValue.trim() } : c
                                              ) || []
                                            }));
                                          }
                                          setEditingComponentName(null);
                                        } else if (e.key === 'Escape') {
                                          setEditingComponentName(null);
                                        }
                                      }}
                                      className="text-sm font-medium text-white bg-zinc-800 border border-zinc-600 rounded px-2 py-0.5 focus:outline-none focus:border-zinc-500"
                                      autoFocus
                                    />
                                  ) : (
                                    <span 
                                      className="text-sm font-medium text-white cursor-pointer hover:text-zinc-300 transition-colors"
                                      onDoubleClick={() => {
                                        setEditingComponentName(compId);
                                        setEditingNameValue(selectedComp.name);
                                      }}
                                      title="Double-click to rename"
                                    >
                                      {selectedComp.name}
                                    </span>
                                  )}
                                  <span className="text-[10px] px-2 py-0.5 rounded-full bg-zinc-800 text-zinc-400 uppercase">
                                    {blueprintStatuses[compId] || 'draft'}
                                  </span>
                                  {blueprintEditedCode && (
                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-zinc-700 text-zinc-300 border border-zinc-600">
                                      Unsaved Changes
                                    </span>
                                  )}
                                </div>
                                <div className="flex items-center gap-1">
                                  <button 
                                    onClick={() => {
                                      setDeleteComponentTarget({ id: selectedComp.id, name: selectedComp.name });
                                      setShowDeleteComponentModal(true);
                                    }}
                                    className="p-1.5 hover:bg-red-500/20 rounded-lg text-zinc-500 hover:text-red-400 transition-colors group relative"
                                  >
                                    <Trash2 className="w-4 h-4" />
                                    <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 border border-zinc-700/50">Delete</span>
                                  </button>
                                  <button 
                                    onClick={() => {
                                      setSelectedBlueprintComponent(null);
                                      setBlueprintEditedCode(null);
                                      setBlueprintChatHistory([]);
                                    }}
                                    className="p-1.5 hover:bg-zinc-800 rounded-lg text-zinc-500 hover:text-white transition-colors group relative"
                                  >
                                    <X className="w-4 h-4" />
                                    <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-[10px] text-zinc-300 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 border border-zinc-700/50">Close</span>
                                  </button>
                                </div>
                              </div>
                              
                              {/* AI Input - Main Action Area */}
                              <div className="p-3">
                                <div className="flex items-center gap-2">
                                  <div className="flex-1 relative">
                                    {/* Context image thumbnail */}
                                    {blueprintContextImage && (
                                      <div className="absolute left-2 top-1/2 -translate-y-1/2 z-10">
                                        <div className="relative">
                                          <img 
                                            src={blueprintContextImage} 
                                            alt="Context" 
                                            className="w-8 h-8 object-cover rounded border border-zinc-600"
                                          />
                                          <button
                                            onClick={() => setBlueprintContextImage(null)}
                                            className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-zinc-700 hover:bg-red-600 rounded-full flex items-center justify-center text-zinc-400 hover:text-white border border-zinc-600"
                                          >
                                            <X className="w-2.5 h-2.5" />
                                          </button>
                                        </div>
                                      </div>
                                    )}
                                    <input
                                      type="text"
                                      value={blueprintChatInput}
                                      onChange={(e) => setBlueprintChatInput(e.target.value)}
                                      onKeyDown={async (e) => {
                                        if (e.key === 'Enter' && blueprintChatInput.trim() && !isEditingBlueprint) {
                                          e.preventDefault();
                                          const userMessage = blueprintChatInput.trim();
                                          const contextImage = blueprintContextImage;
                                          setBlueprintChatInput("");
                                          setBlueprintContextImage(null);
                                          setBlueprintChatHistory(prev => [...prev, { role: 'user', content: contextImage ? `🖼️ ${userMessage}` : userMessage }]);
                                          setIsEditingBlueprint(true);
                                          
                                          // If we have context image, use Agentic Vision: Surveyor → Generator flow
                                          if (contextImage) {
                                            try {
                                              // STEP 1: SURVEYOR - Extract hard data from image
                                              setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '🔍 Analyzing image with Agentic Vision...' }]);
                                              setIsSurveyingBlueprint(true);
                                              
                                              const surveyResponse = await fetch('/api/blueprint/vision-survey', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ imageBase64: contextImage })
                                              });
                                              
                                              let surveyData: any = null;
                                              if (surveyResponse.ok) {
                                                const surveyResult = await surveyResponse.json();
                                                if (surveyResult.success && surveyResult.hardData) {
                                                  surveyData = surveyResult.hardData;
                                                  setBlueprintSurveyData(surveyData);
                                                  setBlueprintChatHistory(prev => [...prev, { 
                                                    role: 'ai', 
                                                    content: `📋 Extracted: ${surveyData?.componentType || 'Component'} (${surveyData?.theme || 'dark'} theme, ${surveyData?.style || 'minimal'} style)` 
                                                  }]);
                                                }
                                              }
                                              setIsSurveyingBlueprint(false);
                                              
                                              // STEP 2: GENERATOR - Create component with hard data constraints
                                              setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '⚡ Generating component...' }]);
                                              
                                              // Build enhanced instructions with hard data
                                              let enhancedInstructions = userMessage;
                                              if (surveyData) {
                                                enhancedInstructions += `\n\n**MANDATORY HARD DATA FROM VISUAL ANALYSIS:**\n`;
                                                if (surveyData.colors) {
                                                  enhancedInstructions += `- Background: ${surveyData.colors.background}\n`;
                                                  enhancedInstructions += `- Text: ${surveyData.colors.text}\n`;
                                                  enhancedInstructions += `- Accent: ${surveyData.colors.accent}\n`;
                                                }
                                                if (surveyData.tailwindClasses?.container) {
                                                  enhancedInstructions += `- Container classes: ${surveyData.tailwindClasses.container}\n`;
                                                }
                                                if (surveyData.content) {
                                                  if (surveyData.content.headline) enhancedInstructions += `- Headline: "${surveyData.content.headline}"\n`;
                                                  if (surveyData.content.description) enhancedInstructions += `- Description: "${surveyData.content.description}"\n`;
                                                  if (surveyData.content.buttonText) enhancedInstructions += `- Button text: "${surveyData.content.buttonText}"\n`;
                                                }
                                                enhancedInstructions += `\nYou MUST use these exact values - they are deterministic constraints from visual analysis.`;
                                              }
                                              
                                              const response = await fetch('/api/blueprint/vision', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                  imageBase64: contextImage,
                                                  componentName: selectedComp.name,
                                                  additionalInstructions: enhancedInstructions
                                                })
                                              });
                                              
                                              if (!response.ok) throw new Error('Vision API failed');
                                              
                                              const reader2 = response.body?.getReader();
                                              const decoder = new TextDecoder();
                                              
                                              while (reader2) {
                                                const { done, value } = await reader2.read();
                                                if (done) break;
                                                const text = decoder.decode(value);
                                                const lines = text.split('\n').filter(l => l.startsWith('data: '));
                                                for (const line of lines) {
                                                  try {
                                                    const data = JSON.parse(line.slice(6));
                                                    if (data.type === 'partial' || data.type === 'done') {
                                                      setBlueprintEditedCode(data.code);
                                                    }
                                                  } catch {}
                                                }
                                              }
                                              
                                              setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '✓ Component generated with Agentic Vision!' }]);
                                            } catch (error) {
                                              setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: 'Failed to process image' }]);
                                              setIsSurveyingBlueprint(false);
                                            }
                                            setIsEditingBlueprint(false);
                                            return;
                                          }
                                          
                                          const currentCode = blueprintEditedCode || selectedComp.code || '';
                                            await streamBlueprintEdit(
                                              currentCode,
                                              selectedComp.name,
                                              userMessage,
                                              (partialCode) => setBlueprintEditedCode(partialCode),
                                              (finalCode) => {
                                                setBlueprintEditedCode(finalCode);
                                                setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: 'Applied ✓' }]);
                                                setIsEditingBlueprint(false);
                                              },
                                              (error) => {
                                                setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: `Error: ${error}` }]);
                                                setIsEditingBlueprint(false);
                                              }
                                            );
                                        }
                                      }}
                                      onPaste={(e) => {
                                        // Handle Ctrl+V paste of images - add as context, don't auto-generate
                                        const items = e.clipboardData?.items;
                                        if (!items) return;
                                        
                                        for (let i = 0; i < items.length; i++) {
                                          if (items[i].type.startsWith('image/')) {
                                            e.preventDefault();
                                            const file = items[i].getAsFile();
                                            if (!file) continue;
                                            
                                            // Convert to base64 and set as context (don't auto-generate)
                                            const reader = new FileReader();
                                            reader.onload = () => {
                                              const base64 = reader.result as string;
                                              setBlueprintContextImage(base64);
                                            };
                                            reader.readAsDataURL(file);
                                            break;
                                          }
                                        }
                                      }}
                                      placeholder={blueprintContextImage ? "Describe what this component should do..." : "Describe changes or paste image..."}
                                      className={cn(
                                        "w-full pr-4 py-3 text-sm bg-zinc-800/50 border border-zinc-700/50 rounded-xl text-white placeholder-zinc-500 focus:border-zinc-500/50 focus:outline-none focus:ring-2 focus:ring-zinc-500/20 transition-all",
                                        blueprintContextImage ? "pl-14" : "pl-4"
                                      )}
                                      disabled={isEditingBlueprint}
                                      autoFocus
                                    />
                                  </div>
                                  
                                  {/* Upload Image Button - on right side before send */}
                                  <button
                                    onClick={() => {
                                      const input = document.createElement('input');
                                      input.type = 'file';
                                      input.accept = 'image/*';
                                      input.onchange = async (e) => {
                                        const file = (e.target as HTMLInputElement).files?.[0];
                                        if (!file) return;
                                        const reader = new FileReader();
                                        reader.onload = () => {
                                          const base64 = reader.result as string;
                                          setBlueprintContextImage(base64);
                                          showToast("Image added! Now describe what to create.", "info");
                                        };
                                        reader.readAsDataURL(file);
                                      };
                                      input.click();
                                    }}
                                    disabled={isEditingBlueprint}
                                    className="w-10 h-10 rounded-full bg-zinc-800/50 hover:bg-zinc-700 text-zinc-400 hover:text-white transition-colors disabled:opacity-50 flex items-center justify-center"
                                    title="Upload image"
                                  >
                                    <ImageIcon className="w-4 h-4" />
                                  </button>
                                  
                                  {/* Send Button - circular */}
                                  <button
                                    onClick={async () => {
                                      if (!blueprintChatInput.trim() || isEditingBlueprint) return;
                                      const userMessage = blueprintChatInput.trim();
                                      const contextImage = blueprintContextImage;
                                      setBlueprintChatInput("");
                                      setBlueprintContextImage(null);
                                      setBlueprintChatHistory(prev => [...prev, { role: 'user', content: contextImage ? `🖼️ ${userMessage}` : userMessage }]);
                                      setIsEditingBlueprint(true);
                                      
                                      // If we have context image, use Agentic Vision: Surveyor → Generator flow
                                      if (contextImage) {
                                        try {
                                          // STEP 1: SURVEYOR - Extract hard data from image
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '🔍 Analyzing image with Agentic Vision...' }]);
                                          setIsSurveyingBlueprint(true);
                                          
                                          const surveyResponse = await fetch('/api/blueprint/vision-survey', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ imageBase64: contextImage })
                                          });
                                          
                                          let surveyData: any = null;
                                          if (surveyResponse.ok) {
                                            const surveyResult = await surveyResponse.json();
                                            if (surveyResult.success && surveyResult.hardData) {
                                              surveyData = surveyResult.hardData;
                                              setBlueprintSurveyData(surveyData);
                                              setBlueprintChatHistory(prev => [...prev, { 
                                                role: 'ai', 
                                                content: `📋 Extracted: ${surveyData?.componentType || 'Component'} (${surveyData?.theme || 'dark'} theme, ${surveyData?.style || 'minimal'} style)` 
                                              }]);
                                            }
                                          }
                                          setIsSurveyingBlueprint(false);
                                          
                                          // STEP 2: GENERATOR - Create component with hard data constraints
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '⚡ Generating component...' }]);
                                          
                                          // Build enhanced instructions with hard data
                                          let enhancedInstructions = userMessage;
                                          if (surveyData) {
                                            enhancedInstructions += `\n\n**MANDATORY HARD DATA FROM VISUAL ANALYSIS:**\n`;
                                            if (surveyData.colors) {
                                              enhancedInstructions += `- Background: ${surveyData.colors.background}\n`;
                                              enhancedInstructions += `- Text: ${surveyData.colors.text}\n`;
                                              enhancedInstructions += `- Accent: ${surveyData.colors.accent}\n`;
                                            }
                                            if (surveyData.tailwindClasses?.container) {
                                              enhancedInstructions += `- Container classes: ${surveyData.tailwindClasses.container}\n`;
                                            }
                                            if (surveyData.content) {
                                              if (surveyData.content.headline) enhancedInstructions += `- Headline: "${surveyData.content.headline}"\n`;
                                              if (surveyData.content.description) enhancedInstructions += `- Description: "${surveyData.content.description}"\n`;
                                              if (surveyData.content.buttonText) enhancedInstructions += `- Button text: "${surveyData.content.buttonText}"\n`;
                                            }
                                            enhancedInstructions += `\nYou MUST use these exact values - they are deterministic constraints from visual analysis.`;
                                          }
                                          
                                          const response = await fetch('/api/blueprint/vision', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                              imageBase64: contextImage,
                                              componentName: selectedComp.name,
                                              additionalInstructions: enhancedInstructions
                                            })
                                          });
                                          
                                          if (!response.ok) throw new Error('Vision API failed');
                                          
                                          const reader2 = response.body?.getReader();
                                          const decoder = new TextDecoder();
                                          
                                          while (reader2) {
                                            const { done, value } = await reader2.read();
                                            if (done) break;
                                            const text = decoder.decode(value);
                                            const lines = text.split('\n').filter(l => l.startsWith('data: '));
                                            for (const line of lines) {
                                              try {
                                                const data = JSON.parse(line.slice(6));
                                                if (data.type === 'partial' || data.type === 'done') {
                                                  setBlueprintEditedCode(data.code);
                                                }
                                              } catch {}
                                            }
                                          }
                                          
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: '✓ Component generated with Agentic Vision!' }]);
                                        } catch (error) {
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: 'Failed to process image' }]);
                                          setIsSurveyingBlueprint(false);
                                        }
                                        setIsEditingBlueprint(false);
                                        return;
                                      }
                                      
                                      const currentCode = blueprintEditedCode || selectedComp.code || '';
                                      const isNewComp = (selectedComp as any).isNew;
                                      
                                      // Reset size if new component so it auto-fits after generation
                                      if (isNewComp) {
                                        setGeneratingBlueprintId(selectedComp.id);
                                        setManuallyResizedComponents(prev => {
                                          const next = new Set(prev);
                                          next.delete(`comp-${compId}`);
                                          return next;
                                        });
                                        setBlueprintSizes(prev => {
                                          const { [`comp-${compId}`]: _, ...rest } = prev;
                                          return rest;
                                        });
                                      }
                                      
                                      await streamBlueprintEdit(
                                        currentCode,
                                        selectedComp.name,
                                        isNewComp ? `Create: ${userMessage}` : userMessage,
                                        (partialCode) => setBlueprintEditedCode(partialCode),
                                        (finalCode) => {
                                          setBlueprintEditedCode(finalCode);
                                          // Clear isNew flag after generation
                                          if (isNewComp) {
                                            setLibraryData((prev: any) => ({
                                              ...prev,
                                              components: prev?.components?.map((c: any) => 
                                                c.id === selectedComp.id ? { ...c, isNew: false } : c
                                              ) || []
                                            }));
                                            setGeneratingBlueprintId(null);
                                          }
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: 'Applied ✓' }]);
                                          setIsEditingBlueprint(false);
                                        },
                                        (error) => {
                                          setBlueprintChatHistory(prev => [...prev, { role: 'ai', content: `Error: ${error}` }]);
                                          setIsEditingBlueprint(false);
                                          if (isNewComp) setGeneratingBlueprintId(null);
                                        }
                                      );
                                    }}
                                    disabled={isEditingBlueprint || !blueprintChatInput.trim()}
                                    className={cn(
                                      "w-10 h-10 rounded-full transition-all flex items-center justify-center",
                                      isEditingBlueprint 
                                        ? "bg-zinc-700 text-zinc-400 cursor-wait" 
                                        : blueprintChatInput.trim()
                                          ? "bg-zinc-600 hover:bg-zinc-500 text-white"
                                          : "bg-zinc-800 text-zinc-500"
                                    )}
                                  >
                                    {isEditingBlueprint ? (
                                      <Loader2 className="w-4 h-4 animate-spin" />
                                    ) : (
                                      <Send className="w-4 h-4" />
                                    )}
                                  </button>
                                </div>
                                
                                {/* Quick Actions */}
                                <div className="mt-2 flex items-center gap-1.5 overflow-x-auto pb-1">
                                  {(((selectedComp as any).isNew)
                                    ? ['Line chart', 'Pricing card', 'Login form', 'Hero section', 'Feature grid', 'Stats counter']
                                    : ['Make it red', 'Add icon', 'Add button', 'Make bigger', 'Add shadow', 'Add chart']
                                  ).map(action => (
                                    <button
                                      key={action}
                                      onClick={() => setBlueprintChatInput(action)}
                                      className="flex-shrink-0 px-2.5 py-1 text-[11px] bg-zinc-800/80 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded-lg transition-colors"
                                    >
                                      {action}
                                    </button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Accept/Discard Actions - Only show when there are changes */}
                              {blueprintEditedCode && (
                                <div className="px-3 pb-3 flex items-center gap-2">
                                  <button
                                    onClick={() => {
                                      // Accept: Update the component in library
                                      if (libraryData && blueprintEditedCode) {
                                        setLibraryData({
                                          ...libraryData,
                                          components: libraryData.components?.map((c: any) => 
                                            c.id === compId ? { ...c, code: blueprintEditedCode, isNew: false } : c
                                          ) || []
                                        });
                                        // Clear size constraints so it auto-fits to new content
                                        setManuallyResizedComponents(prev => {
                                          const next = new Set(prev);
                                          next.delete(`comp-${compId}`);
                                          return next;
                                        });
                                        setBlueprintSizes(prev => {
                                          const { [`comp-${compId}`]: _, ...rest } = prev;
                                          return rest;
                                        });
                                        setBlueprintEditedCode(null);
                                        setBlueprintChatHistory([]);
                                        showToast("Changes accepted!", "success");
                                      }
                                    }}
                                    className="flex-1 py-2.5 text-sm bg-zinc-700 hover:bg-zinc-600 text-white rounded-xl transition-colors flex items-center justify-center gap-2 font-medium"
                                  >
                                    <Check className="w-4 h-4" />
                                    Accept
                                  </button>
                                  <button
                                    onClick={() => {
                                      // Discard: Reset to original
                                      setBlueprintEditedCode(null);
                                      setBlueprintChatHistory([]);
                                    }}
                                    className="flex-1 py-2.5 text-sm bg-zinc-800 hover:bg-zinc-700 text-zinc-400 rounded-xl transition-colors flex items-center justify-center gap-2"
                                  >
                                    <X className="w-4 h-4" />
                                    Discard
                                  </button>
                                  <button
                                    onClick={() => {
                                      // Publish to Library: Update existing component with edited code
                                      if (libraryData && blueprintEditedCode) {
                                        // Update the existing component instead of creating new one
                                        setLibraryData((prev: any) => ({
                                          ...prev,
                                          components: prev?.components?.map((c: any) => 
                                            c.id === selectedComp.id 
                                              ? { ...c, code: blueprintEditedCode }
                                              : c
                                          ) || []
                                        }));
                                        // Broadcast code change to other users
                                        broadcastLibraryComponentChange(selectedComp.id, { code: blueprintEditedCode });
                                        setBlueprintStatuses(prev => ({ ...prev, [selectedComp.id]: 'approved' }));
                                        setBlueprintEditedCode(null);
                                        setBlueprintChatHistory([]);
                                        setSelectedBlueprintComponent(null);
                                        showToast(`${selectedComp.name} saved to Library!`, "success");
                                      }
                                    }}
                                    className="py-2.5 px-4 text-sm bg-zinc-700 hover:bg-zinc-600 text-white rounded-xl transition-colors flex items-center justify-center gap-2 font-medium"
                                  >
                                    <Upload className="w-4 h-4" />
                                    Publish
                                  </button>
                                </div>
                              )}
                            </div>
                            
                            {/* Mini hint below bar */}
                            <div className="mt-2 text-center text-[10px] text-zinc-600">
                              Press <kbd className="px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">Enter</kbd> to send • <kbd className="px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">Esc</kbd> to deselect
                            </div>
                          </div>
                        );
                      })()}
                      
                    </div>
                    
                  </>
                )}
              </div>
            )}

            {/* Input - Custom Video Player with better trim */}
            {viewMode === "input" && (
              <div className="flex-1 bg-black flex flex-col overflow-hidden">
                {selectedFlow ? (
                  <>
                    <div className="flex-1 flex items-center justify-center min-h-0 bg-black">
                      <video 
                        ref={videoRef} 
                        src={selectedFlow.videoUrl} 
                        preload="metadata"
                        playsInline
                        className="w-full h-full object-contain" 
                        style={{ 
                          maxWidth: '100%', 
                          maxHeight: '100%',
                          imageRendering: 'auto'
                        }}
                        onLoadedMetadata={(e) => {
                          const video = e.currentTarget;
                          // WebM fix: if duration is Infinity, seek far to force calculation
                          if (!isFinite(video.duration) || video.duration <= 0) {
                            video.currentTime = 1e10; // Seek far ahead to get real duration
                          } else if (video.duration && isFinite(video.duration) && video.duration > 0) {
                            const newDuration = Math.round(video.duration);
                            if (newDuration !== selectedFlow.duration) {
                              setFlows(prev => prev.map(f => 
                                f.id === selectedFlow.id 
                                  ? { ...f, duration: newDuration, trimEnd: Math.min(f.trimEnd, newDuration), trimStart: Math.min(f.trimStart, newDuration) }
                                  : f
                              ));
                            }
                          }
                          setCurrentTime(0);
                        }}
                        onDurationChange={(e) => {
                          // WebM: duration becomes valid after seeking
                          const video = e.currentTarget;
                          if (video.duration && isFinite(video.duration) && video.duration > 0) {
                            const newDuration = Math.round(video.duration);
                            if (newDuration !== selectedFlow.duration && newDuration > 0) {
                              console.log("[VideoPlayer] Duration updated:", newDuration, "s");
                              setFlows(prev => prev.map(f => 
                                f.id === selectedFlow.id 
                                  ? { ...f, duration: newDuration, trimEnd: Math.min(f.trimEnd || newDuration, newDuration), trimStart: Math.min(f.trimStart || 0, newDuration) }
                                  : f
                              ));
                            }
                          }
                        }}
                        onPlay={() => setIsPlaying(true)} 
                        onPause={() => setIsPlaying(false)}
                        onCanPlay={(e) => {
                          // Seek to tiny offset to show first frame instead of black screen
                          // This doesn't affect playhead position which stays at 0
                          const video = e.currentTarget;
                          if (video.paused && video.currentTime < 0.01) {
                            video.currentTime = 0.01;
                          }
                        }}
                        onTimeUpdate={(e) => {
                          const time = e.currentTarget.currentTime;
                          // Only update state for real playback, ignore initial seek for thumbnail
                          if (time >= 0.02 || time === 0) {
                            setCurrentTime(time);
                          }
                        }}
                      />
                    </div>
                    <div className="p-4 border-t border-zinc-800 bg-[#111111]">
                      {/* Video Timeline Header */}
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <button onClick={togglePlayPause} className="p-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition-colors">
                            {isPlaying ? <Pause className="w-4 h-4 text-white" /> : <Play className="w-4 h-4 text-white" />}
                          </button>
                          <span className="text-sm text-white font-mono">{formatDuration(Math.floor(currentTime))}</span>
                          <span className="text-xs text-zinc-500">/</span>
                          <span className="text-xs text-zinc-500 font-mono">{formatDuration(selectedFlow.duration)}</span>
                        </div>
                        <div className="flex items-center gap-2 text-xs text-zinc-500">
                          <span className="text-zinc-400">AI will process:</span>
                          <span className="font-mono text-white bg-zinc-800 px-2 py-0.5 rounded">{formatDuration(selectedFlow.trimStart)} - {formatDuration(selectedFlow.trimEnd)}</span>
                        </div>
                      </div>
                      
                      {/* Timeline / Trim bar */}
                      <div className="mb-4">
                        <div 
                          ref={trimBarRef} 
                          className="trim-slider-container relative cursor-pointer"
                          onClick={(e) => {
                            // Click to seek - only if not clicking on handles
                            if ((e.target as HTMLElement).classList.contains('trim-handle')) return;
                            const rect = trimBarRef.current?.getBoundingClientRect();
                            if (!rect || !videoRef.current || !selectedFlow || !selectedFlow.duration || selectedFlow.duration <= 0) return;
                            const x = e.clientX - rect.left;
                            const percent = Math.max(0, Math.min(1, x / rect.width));
                            const time = percent * selectedFlow.duration;
                            if (isFinite(time) && time >= 0 && time <= selectedFlow.duration) {
                              videoRef.current.currentTime = time;
                              setCurrentTime(time);
                            }
                          }}
                        >
                          <div className="trim-waveform" />
                          {/* Selected area */}
                          {selectedFlow.duration > 0 && isFinite(selectedFlow.duration) && (
                            <>
                              <div className="trim-selected-area" style={{
                                left: `${Math.max(0, (selectedFlow.trimStart / selectedFlow.duration) * 100)}%`,
                                width: `${Math.max(0, ((selectedFlow.trimEnd - selectedFlow.trimStart) / selectedFlow.duration) * 100)}%`
                              }} />
                              {/* Start handle with tooltip */}
                              <div 
                                className="trim-handle" 
                                style={{ left: `calc(${Math.max(0, (selectedFlow.trimStart / selectedFlow.duration) * 100)}% - 7px)` }}
                                onMouseDown={(e) => { e.stopPropagation(); handleTrimDrag(e, "start"); }} 
                              >
                                {isDraggingTrim === "start" && trimPreviewTime !== null && (
                                  <div className="trim-time-tooltip">{formatDuration(trimPreviewTime)}</div>
                                )}
                              </div>
                              {/* End handle with tooltip */}
                              <div 
                                className="trim-handle" 
                                style={{ left: `calc(${Math.min(100, (selectedFlow.trimEnd / selectedFlow.duration) * 100)}% - 7px)` }}
                                onMouseDown={(e) => { e.stopPropagation(); handleTrimDrag(e, "end"); }} 
                              >
                                {isDraggingTrim === "end" && trimPreviewTime !== null && (
                                  <div className="trim-time-tooltip">{formatDuration(trimPreviewTime)}</div>
                                )}
                              </div>
                              {/* Playhead */}
                              <div className="trim-playhead" style={{ left: `${Math.min(100, (currentTime / selectedFlow.duration) * 100)}%` }} />
                            </>
                          )}
                        </div>
                      </div>
                      
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <button onClick={() => fileInputRef.current?.click()} className="btn-black flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs"><Upload className="w-3.5 h-3.5" /> Upload New</button>
                          <button onClick={startRecording} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs bg-zinc-800/50 border border-white/[0.08] hover:border-white/[0.15] text-zinc-400 hover:text-zinc-200 transition-all"><div className="w-2 h-2 rounded-full bg-white/40" /> Record New</button>
                        </div>
                        <button onClick={applyTrim} className="btn-black flex items-center gap-1.5 px-4 py-1.5 rounded-lg text-xs bg-zinc-800/20 text-zinc-300 border border-zinc-700">
                          <Check className="w-3.5 h-3.5" /> Apply Trim
                        </button>
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="flex-1 flex items-center justify-center bg-[#111111]">
                    <div className="text-center">
                      <EmptyState icon="logo" title="No video selected" subtitle="Record or upload a video first" />
                      <div className="flex items-center justify-center gap-2 mt-4">
                        <button onClick={() => fileInputRef.current?.click()} className="btn-black flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs"><Upload className="w-3.5 h-3.5" /> Upload</button>
                        <button onClick={startRecording} className="flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs bg-zinc-800/50 border border-white/[0.08] hover:border-white/[0.15] text-zinc-400 hover:text-zinc-200 transition-all"><div className="w-2.5 h-2.5 rounded-full bg-white/40" /> Record</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Global Floating Edit - Properly Centered */}
            <AnimatePresence>
              {showFloatingEdit && (
                <motion.div 
                  initial={{ opacity: 0, y: 20 }} 
                  animate={{ opacity: 1, y: 0 }} 
                  exit={{ opacity: 0, y: 20 }} 
                  className="absolute bottom-6 left-0 right-0 flex justify-center z-50 px-6"
                >
                  <div className="w-full max-w-[500px] backdrop-blur-xl bg-[#111111]/95 border border-zinc-800 rounded-2xl p-3 shadow-2xl">
                    <div className="flex items-center gap-2 mb-2">
                      {isEditing ? (
                        <Loader2 className="w-3.5 h-3.5 text-zinc-300 animate-spin" />
                      ) : (
                        <Sparkles className="w-3.5 h-3.5 text-zinc-300" />
                      )}
                      <span className="text-xs text-zinc-500">
                        {isEditing ? (
                          <span className="text-zinc-300/80 animate-pulse">
                            {selectedElement ? `Editing ${selectedElement.substring(0, 20)}...` : editInput.includes('@') ? `Creating ${editInput.match(/@([a-zA-Z0-9-_]+)/)?.[1] || 'page'}...` : 'Applying changes...'}
                          </span>
                        ) : selectedArchNode ? (
                          <>Editing <span className="at-tag">@{selectedArchNode}</span></>
                        ) : "Describe your changes"}
                      </span>
                      {isEditing ? (
                        /* Cancel button during editing */
                        <button 
                          onClick={() => { 
                            cancelAIRequest(); 
                            setIsEditing(false); 
                            showToast("Request cancelled", "info"); 
                          }} 
                          className="ml-auto p-1.5 hover:bg-red-500/20 rounded-lg transition-colors group"
                          title="Cancel request"
                        >
                          <X className="w-4 h-4 text-red-400 group-hover:text-red-300" />
                        </button>
                      ) : (
                        /* Close button when not editing */
                        <button onClick={() => { setShowFloatingEdit(false); setSelectedArchNode(null); setShowSuggestions(false); }} className="ml-auto p-1 hover:bg-zinc-800/50 rounded">
                          <X className="w-3 h-3 text-white/20" />
                        </button>
                      )}
                    </div>
                    <div className="relative">
                      {/* Image previews */}
                      {editImages.length > 0 && (
                        <div className="flex flex-wrap gap-2 mb-2">
                          {editImages.map(img => (
                            <div key={img.id} className="relative group">
                              <img src={img.url} alt={img.name} className="w-12 h-12 object-cover rounded-lg border border-zinc-700" />
                              <button 
                                onClick={() => {
                                  URL.revokeObjectURL(img.url);
                                  setEditImages(prev => prev.filter(i => i.id !== img.id));
                                }}
                                className="absolute -top-1.5 -right-1.5 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                              >
                                <X className="w-2.5 h-2.5 text-white" />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                      <div className="flex gap-2">
                        {/* Pointer tool button */}
                        <button
                          onClick={() => {
                            if (isEditing) return;
                            const newState = !isPointAndEdit;
                            setIsPointAndEdit(newState);
                            // Clear selected element when turning off pointer
                            if (!newState) {
                              setSelectedElement(null);
                            }
                          }}
                          disabled={isEditing}
                          className={cn(
                            "relative flex items-center justify-center w-10 h-10 rounded-lg border transition-all",
                            isEditing 
                              ? "bg-zinc-800/50 border-white/[0.02] text-white/20 cursor-not-allowed"
                              : isPointAndEdit 
                                ? "bg-zinc-800/20 border-[var(--accent-orange)] text-zinc-300 shadow-[0_0_10px_rgba(82,82,91,0.2)]" 
                                : "bg-zinc-800/50 border-zinc-800 hover:border-zinc-700 text-zinc-500"
                          )}
                          title={isEditing ? "Disabled during editing" : isPointAndEdit ? "Click to deactivate pointer" : "Click element in preview to edit"}
                        >
                          <MousePointer className={cn("w-4 h-4", isPointAndEdit && !isEditing && "animate-pulse")} />
                          {isPointAndEdit && !isEditing && (
                            <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-zinc-800 rounded-full animate-pulse" />
                          )}
                        </button>
                        {/* Image upload button */}
                        <label 
                          className={cn(
                            "flex items-center justify-center w-10 h-10 rounded-lg border transition-colors",
                            isEditing 
                              ? "bg-zinc-800/50 border-white/[0.02] text-white/20 cursor-not-allowed"
                              : "bg-zinc-800/50 border-zinc-800 hover:border-zinc-700 cursor-pointer"
                          )}
                          title={isEditing ? "Disabled during editing" : "Upload image"}
                        >
                          <input 
                            type="file"
                            accept="image/*"
                            multiple
                            className="hidden"
                            disabled={isEditing}
                            onChange={async (e) => {
                              const files = e.target.files;
                              if (files) {
                                for (const file of Array.from(files)) {
                                  const id = `img_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                                  const localUrl = URL.createObjectURL(file);
                                  
                                  // Add with loading state
                                  setEditImages(prev => [...prev, { id, url: localUrl, name: file.name, file, uploading: true }]);
                                  
                                  // Upload to Supabase
                                  try {
                                    const formData = new FormData();
                                    formData.append("file", file);
                                    formData.append("userId", user?.id || "anon");
                                    
                                    const response = await fetch("/api/upload-image", {
                                      method: "POST",
                                      body: formData,
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success && data.url) {
                                      URL.revokeObjectURL(localUrl);
                                      setEditImages(prev => prev.map(img => 
                                        img.id === id ? { ...img, url: data.url, uploading: false } : img
                                      ));
                                      console.log("[EditImages] Uploaded to Supabase:", data.url);
                                    } else {
                                      setEditImages(prev => prev.map(img => 
                                        img.id === id ? { ...img, uploading: false } : img
                                      ));
                                    }
                                  } catch (error) {
                                    console.error("[EditImages] Upload error:", error);
                                    setEditImages(prev => prev.map(img => 
                                      img.id === id ? { ...img, uploading: false } : img
                                    ));
                                  }
                                }
                              }
                              e.target.value = "";
                            }}
                          />
                          <ImageIcon className={cn("w-4 h-4", isEditing ? "text-white/20" : "text-zinc-500")} />
                        </label>
                        <input 
                          ref={editInputRef}
                          type="text" 
                          value={editInput} 
                          onChange={(e) => setEditInput(e.target.value)} 
                          onKeyDown={(e) => {
                            if (e.key === "Enter" && !showSuggestions) handleEdit();
                            if (e.key === "Escape" && !isEditing) { setShowFloatingEdit(false); setSelectedArchNode(null); setEditImages([]); }
                          }}
                          placeholder={selectedArchNode ? `Describe changes for @${selectedArchNode}...` : "Type @ to select a component or add images..."} 
                          className="flex-1 px-3 py-2.5 rounded-lg text-sm text-zinc-200 placeholder:text-white/20 bg-zinc-800/50 border border-zinc-800 focus:outline-none focus:border-zinc-700" 
                          disabled={isEditing} 
                          autoFocus 
                        />
                        <button onClick={handleEdit} disabled={(!editInput.trim() && editImages.length === 0) || isEditing} className="btn-black px-4 rounded-lg flex items-center gap-2 disabled:opacity-50">
                          {isEditing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-3.5 h-3.5" />}
                        </button>
                      </div>
                      
                      {/* Suggestions dropdown */}
                      <AnimatePresence>
                        {showSuggestions && suggestions.length > 0 && (
                          <motion.div 
                            initial={{ opacity: 0, y: 10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: 10 }}
                            className="suggestions-dropdown"
                          >
                            {suggestions.map(node => {
                              const Icon = getNodeIcon(node.type);
                              return (
                                <div
                                  key={node.id}
                                  onClick={() => handleSuggestionClick(node.id)}
                                  className="suggestion-item"
                                >
                                  <Icon className="w-3.5 h-3.5 icon" />
                                  <div>
                                    <span className="text-xs text-zinc-200">@{node.id}</span>
                                    <span className="text-[10px] text-zinc-500 ml-2">{node.name}</span>
                                  </div>
                                </div>
                              );
                            })}
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>

            {/* Node Detail Modal */}
            <AnimatePresence>
              {selectedNodeModal && (
                <motion.div 
                  initial={{ opacity: 0 }} 
                  animate={{ opacity: 1 }} 
                  exit={{ opacity: 0 }}
                  className="fixed inset-0 bg-zinc-900 backdrop-blur-sm z-[100] flex items-center justify-center"
                  onClick={() => setSelectedNodeModal(null)}
                >
                  <motion.div 
                    initial={{ opacity: 0, scale: 0.95 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.95 }}
                    className="bg-[#111111] border border-zinc-700 rounded-2xl p-6 w-full max-w-md shadow-2xl"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        {(() => { const Icon = getNodeIcon(selectedNodeModal.type); return <Icon className="w-6 h-6 text-zinc-300" />; })()}
                        <div>
                          <h3 className="text-lg font-semibold text-white">{selectedNodeModal.name}</h3>
                          <span className="text-xs text-zinc-500 uppercase">{selectedNodeModal.type}</span>
                        </div>
                      </div>
                      <button onClick={() => setSelectedNodeModal(null)} className="p-1 hover:bg-zinc-800/50 rounded">
                        <X className="w-5 h-5 text-zinc-500" />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <span className="text-[10px] text-zinc-600 uppercase">Description</span>
                        <p className="text-sm text-zinc-400 mt-1">{selectedNodeModal.description || "Component in the page structure"}</p>
                      </div>
                      
                      <div>
                        <span className="text-[10px] text-zinc-600 uppercase">User Flow</span>
                        <p className="text-sm text-zinc-500 mt-1">
                          {selectedNodeModal.type === "page" && "Root container for all page elements"}
                          {selectedNodeModal.type === "component" && "Reusable UI component that can contain other elements"}
                          {selectedNodeModal.type === "section" && "Major content section of the page"}
                          {selectedNodeModal.type === "interactive" && "User can click, tap, or interact with this element"}
                          {selectedNodeModal.type === "element" && "Visual or content element (text, image, etc.)"}
                        </p>
                      </div>
                      
                      {selectedNodeModal.connections && selectedNodeModal.connections.length > 0 && (
                        <div>
                          <span className="text-[10px] text-zinc-600 uppercase">Connected To</span>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {selectedNodeModal.connections.map(conn => (
                              <span key={conn} className="px-2 py-1 bg-zinc-800/50 rounded text-xs text-zinc-400">@{conn}</span>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      <button 
                        onClick={() => { 
                          if (isEditing) return;
                          setEditInput(`@${selectedNodeModal.id} `); 
                          setSelectedArchNode(selectedNodeModal.id);
                          setShowFloatingEdit(true); 
                          setSelectedNodeModal(null); 
                        }}
                        className="w-full mt-4 flex items-center justify-center gap-2 px-4 py-3 bg-zinc-800/10 border border-zinc-700 rounded-xl text-sm text-zinc-300 hover:bg-zinc-800/15 transition-colors"
                      >
                        <Sparkles className="w-4 h-4" /> Edit with AI
                      </button>
                    </div>
                  </motion.div>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        </div>
      </div>
      
      {/* Mobile Auth Gate - Require login on mobile (EXCEPT in demo mode or loading demo!) */}
      {!user && !authLoading && !isDemoMode && !searchParams.get('demo') && (
        <>
          {/* Backdrop with blur - see content behind */}
          <div className="fixed inset-0 z-50 md:hidden bg-zinc-900 backdrop-blur-sm" />
          
          {/* Auth Popup Modal - Static, no animations */}
          <div className="fixed inset-0 z-50 md:hidden flex items-center justify-center p-4">
            <div className="w-full max-w-sm bg-[#111111] border border-zinc-700 rounded-2xl p-6 shadow-2xl text-center">
              <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--accent-orange)]/20 to-[#52525b]/10 flex items-center justify-center mx-auto mb-5">
                <Lock className="w-8 h-8 text-zinc-300" />
              </div>
              <h2 className="text-xl font-semibold text-white mb-2">Sign in to continue</h2>
              <p className="text-zinc-500 text-sm mb-6">
                Create an account or sign in to start building. Get 100 free credits.
              </p>
              <button
                onClick={() => setShowAuthModal(true)}
                className="w-full px-6 py-3.5 rounded-xl bg-zinc-800 text-white font-medium hover:bg-zinc-600 transition-colors mb-4"
              >
                Sign in / Sign up
              </button>
              <a href="/landing" className="text-sm text-zinc-500 hover:text-zinc-400 transition-colors">
                ← Back to home
              </a>
            </div>
          </div>
        </>
      )}
      
      {/* Mobile Tip Banner */}
      <AnimatePresence>
        {showMobileBanner && (
          <motion.div
            initial={{ y: 100, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ y: 100, opacity: 0 }}
            className="fixed bottom-[80px] left-3 right-3 z-50 md:hidden"
          >
            <div className="bg-zinc-900 border border-zinc-700 rounded-2xl p-4 shadow-2xl">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-zinc-800/10 flex items-center justify-center flex-shrink-0">
                  <Monitor className="w-5 h-5 text-zinc-300" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-zinc-200">Quick preview mode</p>
                  <p className="text-xs text-zinc-500 mt-0.5">Full features available on desktop</p>
                </div>
                <button 
                  onClick={() => {
                    setShowMobileBanner(false);
                    localStorage.setItem("replay_mobile_banner_dismissed", "true");
                  }}
                  className="p-3 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center"
                >
                  <X className="w-5 h-5 text-zinc-500" />
                </button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
      
      {/* Mobile Bottom Navigation - 72px height, proper touch targets - HIDE in demo mode */}
      {!isDemoMode && (
      <div className="fixed bottom-0 left-0 right-0 z-40 md:hidden border-t border-zinc-700 bg-[#111111] safe-area-pb" style={{ height: '72px' }}>
        <div className="flex items-center justify-around h-full px-1">
          {/* Show Chat tab when we have generated code, otherwise show Input */}
          {generatedCode ? (
            <button 
              onClick={() => setMobilePanel("chat")}
              className={cn(
                "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
                mobilePanel === "chat" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
              )}
            >
              <Sparkles className="w-6 h-6" />
              <span className="text-[10px] font-medium">Chat</span>
            </button>
          ) : (
            <button 
              onClick={() => setMobilePanel("input")}
              className={cn(
                "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
                mobilePanel === "input" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
              )}
            >
              <Film className="w-6 h-6" />
              <span className="text-[10px] font-medium">Input</span>
            </button>
          )}
          
          <button 
            onClick={() => setMobilePanel("preview")}
            className={cn(
              "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
              mobilePanel === "preview" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
            )}
          >
            <Eye className="w-6 h-6" />
            <span className="text-[10px] font-medium">Preview</span>
          </button>
          
          <button 
            onClick={() => setMobilePanel("flow")}
            className={cn(
              "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
              mobilePanel === "flow" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
            )}
          >
            <GitBranch className="w-6 h-6" />
            <span className="text-[10px] font-medium">Flow</span>
          </button>
          
          <button 
            onClick={() => setMobilePanel("code")}
            className={cn(
              "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
              mobilePanel === "code" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
            )}
          >
            <Code className="w-6 h-6" />
            <span className="text-[10px] font-medium">Code</span>
          </button>
          
          <button 
            onClick={() => setMobilePanel("design")}
            className={cn(
              "flex flex-col items-center justify-center gap-1 rounded-xl transition-colors min-w-[64px] min-h-[56px]",
              mobilePanel === "design" && !showHistoryMode ? "text-zinc-300 bg-zinc-800/10" : "text-zinc-500"
            )}
          >
            <Palette className="w-6 h-6" />
            <span className="text-[10px] font-medium">Design</span>
          </button>
        </div>
      </div>
      )}
      
      {/* Mobile History - Full Screen Overlay - Static */}
      {showHistoryMode && (
          <div className="fixed inset-0 z-[100] md:hidden bg-[#111111] flex flex-col">
            {/* History Header - Same height as tool headers */}
            <div className="flex items-center justify-between px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
              <div className="flex items-center gap-2">
                <History className="w-5 h-5 text-zinc-300" />
                <span className="text-sm font-semibold text-white">Your Projects</span>
              </div>
              <button 
                onClick={() => setShowHistoryMode(false)}
                className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center"
              >
                <X className="w-5 h-5 text-zinc-400" />
              </button>
            </div>
            
            {/* Search */}
            <div className="p-4 border-b border-zinc-800 flex-shrink-0">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-600" />
                <input
                  type="text"
                  value={historySearch}
                  onChange={(e) => setHistorySearch(e.target.value)}
                  placeholder="Search projects..."
                  className="w-full pl-10 pr-4 py-3 rounded-xl bg-zinc-800/50 border border-zinc-800 text-sm text-zinc-400 placeholder:text-zinc-600 focus:outline-none focus:border-zinc-700"
                />
              </div>
            </div>
            
            {/* Generation List - sorted newest first */}
            <div className="flex-1 min-h-0 overflow-y-auto p-3 space-y-2">
              {isLoadingHistory ? (
                <div className="text-center py-12">
                  <Loader2 className="w-8 h-8 text-zinc-300 animate-spin mx-auto" />
                  <p className="text-sm text-zinc-500 mt-4">Loading your projects...</p>
                </div>
              ) : generations.length === 0 ? (
                <div className="text-center py-12">
                  <div className="empty-logo-container mx-auto" style={{ width: 60, height: 75 }}>
                    <svg className="empty-logo" viewBox="0 0 82 109" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M68.099 37.2285C78.1678 43.042 78.168 57.5753 68.099 63.3887L29.5092 85.668C15.6602 93.6633 0.510418 77.4704 9.40857 64.1836L17.4017 52.248C18.1877 51.0745 18.1876 49.5427 17.4017 48.3691L9.40857 36.4336C0.509989 23.1467 15.6602 6.95306 29.5092 14.9482L68.099 37.2285Z" stroke="currentColor" strokeWidth="11.6182" strokeLinejoin="round"/>
                      <rect x="34.054" y="98.6841" width="48.6555" height="11.6182" rx="5.80909" transform="rotate(-30 34.054 98.6841)" fill="currentColor"/>
                    </svg>
                  </div>
                  <p className="text-sm text-zinc-500 mt-4">No generations yet</p>
                  <p className="text-xs text-white/25 mt-1">Upload a video and generate code to start</p>
                </div>
              ) : (
                generations
                  .slice()
                  .sort((a, b) => b.timestamp - a.timestamp)
                  .filter(gen => !historySearch || gen.title.toLowerCase().includes(historySearch.toLowerCase()))
                  .map((gen) => (
                  <div 
                    key={gen.id}
                    className={cn(
                      "relative p-3 pr-10 rounded-xl cursor-pointer transition-colors border",
                      activeGeneration?.id === gen.id 
                        ? "bg-zinc-800/10 border-zinc-700" 
                        : "bg-zinc-800/50 border-zinc-800 hover:bg-zinc-800/50"
                    )}
                    onClick={async () => {
                      if (renamingId === gen.id) return;
                      
                      try {
                        // If code is missing (minimal fetch), load full data first
                        let genToLoad = gen;
                        const isDemo = DEMO_PROJECT_IDS.has(gen.id);
                        if (!gen.code && (user || isDemo)) {
                          console.log("[History Mobile] Loading full data for generation:", gen.id, isDemo ? "(demo)" : "");
                          const fullGen = await loadFullGeneration(gen.id);
                          if (fullGen) {
                            genToLoad = fullGen;
                          } else {
                            console.error("[History Mobile] Failed to load generation data");
                            showToast("Failed to load project", "error");
                            return;
                          }
                        }
                        
                        // MOBILE: Save project to localStorage for MobileLayout to pick up
                        const projectData = {
                          id: genToLoad.id,
                          title: genToLoad.title,
                          code: genToLoad.code,
                          videoUrl: genToLoad.videoUrl,
                          publishedSlug: genToLoad.publishedSlug,
                        };
                        console.log("[History Mobile] Saving project to localStorage:", {
                          id: projectData.id,
                          title: projectData.title,
                          hasCode: !!projectData.code,
                          videoUrl: projectData.videoUrl,
                        });
                        localStorage.setItem("replay_mobile_load_project", JSON.stringify(projectData));
                        
                        // Close history mode - MobileLayout will render and load the project
                        setShowHistoryMode(false);
                      } catch (e) {
                        console.error("[History Mobile] Error loading generation:", e);
                        showToast("Error loading generation", "error");
                      }
                    }}
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <p className="text-sm font-medium text-zinc-200 truncate flex-1">{gen.title}</p>
                    </div>
                    <p className="text-[10px] text-zinc-600">
                      {new Date(gen.timestamp).toLocaleDateString()} • {new Date(gen.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </p>
                    {/* Delete action - right aligned */}
                    <div className="absolute top-3 right-3">
                      <button
                        onClick={(e) => { e.stopPropagation(); confirmDeleteGeneration(gen.id, gen.title); }}
                        className="p-1.5 rounded-lg bg-zinc-800/50 hover:bg-red-500/20 text-zinc-600 hover:text-red-400 transition-colors"
                      >
                        <Trash2 className="w-3.5 h-3.5" />
                      </button>
                    </div>
                    
                    {/* Latest change or style info */}
                    <div className="mt-1">
                      {gen.versions && gen.versions.length > 0 ? (
                        <p className="text-[10px] text-zinc-500 truncate">
                          <span className="text-emerald-400/60">Latest:</span> {gen.versions[gen.versions.length - 1]?.label || "Code update"}
                        </p>
                      ) : (
                        <p className="text-[10px] text-white/25 truncate">
                          <span className="text-white/15">Style:</span> {gen.styleDirective?.split('.')[0]?.split('⚠️')[0]?.trim() || "Auto-Detect"}
                        </p>
                      )}
                    </div>
                    
                    {/* Version History Toggle - Mobile */}
                    <div className="mt-2 pt-2 border-t border-zinc-800">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setExpandedVersions(expandedVersions === gen.id ? null : gen.id);
                        }}
                        className="flex items-center gap-2 text-[10px] text-zinc-500 hover:text-zinc-400 transition-colors"
                      >
                        <Clock className="w-3 h-3" />
                        <span>{((gen.versions || []).filter(v => v.label !== "Initial generation").length) + 1} version{((gen.versions || []).filter(v => v.label !== "Initial generation").length) >= 1 ? 's' : ''}</span>
                        <ChevronDown className={cn(
                          "w-3 h-3 transition-transform",
                          expandedVersions === gen.id && "rotate-180"
                        )} />
                      </button>
                      
                      <AnimatePresence>
                        {expandedVersions === gen.id && (
                          <motion.div
                            initial={{ opacity: 0, height: 0 }}
                            animate={{ opacity: 1, height: "auto" }}
                            exit={{ opacity: 0, height: 0 }}
                            className="mt-2 ml-1 space-y-1 overflow-hidden"
                          >
                            {/* Version timeline - newest at top, oldest at bottom */}
                            <div className="relative pl-3 border-l border-zinc-700">
                              {/* Versions in reverse order (newest/current at top) - filter out "Initial generation" */}
                              {(gen.versions || []).filter(v => v.label !== "Initial generation").slice().reverse().map((version, idx) => (
                                <div 
                                  key={version.id}
                                  className="relative py-1.5"
                                >
                                  <div className={cn(
                                    "absolute -left-[7px] top-2.5 w-2.5 h-2.5 rounded-full border-2",
                                    idx === 0 
                                      ? "bg-zinc-800 border-[var(--accent-orange)]" 
                                      : "bg-[#111111] border-white/20"
                                  )} />
                                  
                                  <div className="flex items-center justify-between gap-2 pl-2">
                                    <div className="flex-1 min-w-0">
                                      <p className="text-[10px] text-zinc-500 truncate">{version.label}</p>
                                      <p className="text-[8px] text-white/25">
                                        {new Date(version.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                      </p>
                                    </div>
                                    
                                    {idx === 0 ? (
                                      <span className="text-[8px] text-zinc-300/60 uppercase">Current</span>
                                    ) : (
                                      <button
                                        onClick={async (e) => {
                                          e.stopPropagation();
                                          // Check if version has code
                                          if (!version.code || version.code.length < 50) {
                                            if (activeGeneration?.id === gen.id) {
                                              const freshVersion = (activeGeneration.versions || []).find(v => v.id === version.id);
                                              if (freshVersion?.code && freshVersion.code.length >= 50) {
                                                restoreVersion(gen.id, freshVersion);
                                                return;
                                              }
                                            }
                                            showToast("Loading version data...", "info");
                                            const fullGen = await loadFullGeneration(gen.id);
                                            if (fullGen) {
                                              const freshVersion = (fullGen.versions || []).find(v => v.id === version.id);
                                              if (freshVersion?.code && freshVersion.code.length >= 50) {
                                                restoreVersion(gen.id, freshVersion);
                                                return;
                                              }
                                            }
                                            showToast("Version data not available", "error");
                                            return;
                                          }
                                          restoreVersion(gen.id, version);
                                        }}
                                        className="p-1.5 rounded bg-zinc-800/50 hover:bg-white/10 transition-all"
                                        title="Restore"
                                      >
                                        <Play className="w-3 h-3 text-zinc-300" />
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))}
                              
                              {/* Initial generation - at the bottom */}
                              <div className="relative py-1.5">
                                <div className={cn(
                                  "absolute -left-[7px] top-2.5 w-2.5 h-2.5 rounded-full border-2",
                                  !gen.versions?.length ? "bg-zinc-800 border-[var(--accent-orange)]" : "bg-[#111111] border-white/20"
                                )} />
                                <div className="flex items-center justify-between gap-2 pl-2">
                                  <div className="flex-1 min-w-0">
                                    <p className="text-[10px] text-zinc-500 truncate">Initial generation</p>
                                    <p className="text-[8px] text-white/25">
                                      {new Date(gen.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </p>
                                  </div>
                                  {!gen.versions?.length ? (
                                    <span className="text-[8px] text-zinc-300/60 uppercase">Current</span>
                                  ) : (
                                    <button
                                      onClick={async (e) => {
                                        e.stopPropagation();
                                        // Restore to initial generation
                                        let codeToRestore = gen.code;
                                        let flowNodesToRestore = gen.flowNodes;
                                        let flowEdgesToRestore = gen.flowEdges;
                                        let styleInfoToRestore = gen.styleInfo;
                                        
                                        if (!codeToRestore || codeToRestore.length < 50) {
                                          // Try to use activeGeneration if it's the same project
                                          if (activeGeneration?.id === gen.id && activeGeneration.code) {
                                            const initialVersion = (activeGeneration.versions || []).find(v => v.label === 'Initial generation');
                                            if (initialVersion?.code) {
                                              codeToRestore = initialVersion.code;
                                              flowNodesToRestore = initialVersion.flowNodes;
                                              flowEdgesToRestore = initialVersion.flowEdges;
                                              styleInfoToRestore = initialVersion.styleInfo;
                                            } else {
                                              showToast("Initial version not saved - cannot restore", "error");
                                              return;
                                            }
                                          } else {
                                            showToast("Loading version data...", "info");
                                            const fullGen = await loadFullGeneration(gen.id);
                                            if (!fullGen?.code) {
                                              showToast("Failed to load version data", "error");
                                              return;
                                            }
                                            codeToRestore = fullGen.code;
                                            flowNodesToRestore = fullGen.flowNodes;
                                            flowEdgesToRestore = fullGen.flowEdges;
                                            styleInfoToRestore = fullGen.styleInfo;
                                          }
                                        }
                                        
                                        restoreVersion(gen.id, { 
                                          id: 'initial', 
                                          timestamp: gen.timestamp, 
                                          label: 'Initial generation',
                                          code: codeToRestore || '',
                                          flowNodes: flowNodesToRestore,
                                          flowEdges: flowEdgesToRestore,
                                          styleInfo: styleInfoToRestore
                                        });
                                      }}
                                      className="p-1.5 rounded bg-zinc-800/50 hover:bg-white/10 transition-all"
                                      title="Restore to initial"
                                    >
                                      <Play className="w-3 h-3 text-zinc-300" />
                                    </button>
                                  )}
                                </div>
                              </div>
                            </div>
                          </motion.div>
                        )}
                      </AnimatePresence>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
      )}
      
      {/* Mobile Input Panel - Standard Input (MobileScanner users go to MobileLayout) */}
      {mobilePanel === "input" && !showHistoryMode && !showMobileMenu && (
          <div className="fixed inset-x-0 bottom-[72px] top-0 z-30 md:hidden bg-black flex flex-col">
            {flows.length === 0 && !isProcessing && !generatedCode ? (
              <div className="flex-1 flex flex-col items-center justify-center p-6">
                <div className="text-center mb-8">
                  <h2 className="text-2xl font-bold text-white mb-2">Upload a video</h2>
                  <p className="text-zinc-500">Record your screen and upload it here</p>
                </div>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full max-w-xs py-4 bg-zinc-800 rounded-2xl text-white font-bold text-lg flex items-center justify-center gap-3"
                >
                  <Upload className="w-5 h-5" />
                  Upload Video
                </button>
              </div>
            ) : (
              <>
              {/* Standard Mobile Header - when video is loaded */}
              <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
                <a href="/" className="flex-shrink-0 p-1.5 -ml-1.5">
                  <LogoIcon className="w-7 h-7" color="white" />
                </a>
                <input
                  type="text"
                  value={generationTitle}
                  onChange={(e) => setGenerationTitle(e.target.value)}
                  className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                  placeholder="Untitled"
                />
                <div className="flex items-center gap-1 flex-shrink-0">
                  <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New Project">
                    <Plus className="w-5 h-5 text-zinc-500" />
                  </button>
                  <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                    <History className="w-5 h-5 text-zinc-500" />
                  </button>
                  <button onClick={() => setShowProjectSettings(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Settings">
                    <Settings className="w-5 h-5 text-zinc-500" />
                  </button>
                  <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                    {user ? (
                      <span className={cn(
                        "text-xs font-semibold uppercase",
                        (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                      )}>
                        {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                      </span>
                    ) : (
                      <User className="w-5 h-5 text-zinc-500" />
                    )}
                  </button>
                </div>
              </div>
              
              <div className="flex flex-col flex-1 overflow-auto">
              {/* Videos Section - Consistent sizing */}
              <div className="p-4 border-b border-zinc-800 flex-shrink-0">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Video className="w-4 h-4 text-zinc-500" />
                    <span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Videos</span>
                  </div>
                  <div className="flex gap-2">
                    {isRecording ? (
                      <button onClick={stopRecording} className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm bg-red-500/20 text-red-400 min-h-[44px]">
                        <Square className="w-3 h-3 fill-current" />{formatDuration(recordingDuration)}
                      </button>
                    ) : (
                      <button onClick={startRecording} className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm bg-zinc-800/50 border border-white/[0.08] active:bg-white/10 text-zinc-400 transition-all min-h-[44px]">
                        <div className="w-2.5 h-2.5 rounded-full bg-white/40" /> Record
                      </button>
                    )}
                    <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm bg-zinc-800/50 active:bg-white/10 text-zinc-400 min-h-[44px]">
                      <Upload className="w-4 h-4" /> Upload
                    </button>
                  </div>
                </div>
                
                <div 
                  className="space-y-2"
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={handleDrop}
                >
                  {flows.length === 0 ? (
                    <div 
                      onClick={() => fileInputRef.current?.click()} 
                      className={cn(
                        "relative rounded-xl border-2 border-dashed transition-all cursor-pointer min-h-[100px]",
                        isDragging 
                          ? "border-[var(--accent-orange)] bg-zinc-800/10" 
                          : "border-zinc-700 bg-zinc-800/50 active:bg-zinc-800/50"
                      )}
                    >
                      <div className="p-6 text-center">
                        <Video className={cn("w-6 h-6 mx-auto mb-2", isDragging ? "text-zinc-300" : "text-zinc-600")} />
                        <p className={cn("text-sm", isDragging ? "text-zinc-300" : "text-zinc-500")}>
                          {isDragging ? "Drop video here!" : "Drop your video here"}
                        </p>
                        <p className="text-xs text-zinc-600 mt-1">
                          Screen recording or UI walkthrough
                        </p>
                      </div>
                    </div>
                  ) : flows.map((flow) => (
                    <div 
                      key={flow.id} 
                      onClick={() => setSelectedFlowId(flow.id)}
                      className={cn(
                        "flex items-center gap-3 p-3 rounded-xl cursor-pointer min-h-[56px]",
                        selectedFlowId === flow.id ? "bg-zinc-800/10 border border-zinc-700" : "bg-zinc-800/50 active:bg-white/10"
                      )}
                    >
                      <div className="w-16 h-10 rounded-lg overflow-hidden bg-zinc-800/50 flex-shrink-0 flex items-center justify-center">
                        {flow.thumbnail && flow.thumbnail.length > 100 ? (
                          <img src={flow.thumbnail} alt="" className="w-full h-full object-cover" />
                        ) : flow.videoUrl ? (
                          <video src={flow.videoUrl} className="w-full h-full object-cover" muted preload="metadata" onLoadedData={(e) => { e.currentTarget.currentTime = 0.5; }} />
                        ) : (
                          <Film className="w-4 h-4 text-white/20" />
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-zinc-200 truncate">{flow.name}</p>
                        <p className="text-xs text-zinc-500">{formatDuration(flow.trimEnd - flow.trimStart)} / {formatDuration(flow.duration)}</p>
                      </div>
                      <button onClick={(e) => { e.stopPropagation(); removeFlow(flow.id); }} className="p-3 rounded-xl active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center">
                        <Trash2 className="w-4 h-4 text-zinc-500" />
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              {/* Context Section - Consistent sizing */}
              <div className="p-4 border-b border-zinc-800 flex-shrink-0">
                <div className="flex items-center gap-2 mb-3">
                  <Settings2 className="w-4 h-4 text-zinc-500" />
                  <span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Context</span>
                </div>
                <textarea
                  value={refinements}
                  onChange={(e) => {
                    const maxLen = isPaidPlan ? 20000 : 2000;
                    if (e.target.value.length <= maxLen) {
                      setRefinements(e.target.value);
                    } else {
                      showToast(`Context limit: ${isPaidPlan ? "20,000" : "2,000"} characters${!isPaidPlan ? ". Upgrade to PRO for 20k" : ""}`, "error");
                    }
                  }}
                  placeholder="Add data logic, constraints or details (optional)"
                  disabled={isProcessing}
                  rows={3}
                  className="w-full px-4 py-3 rounded-xl text-sm text-zinc-300 placeholder:text-zinc-600 bg-zinc-800/80 border border-zinc-700/50 focus:outline-none focus:border-zinc-600 min-h-[88px] max-h-[200px] resize-y leading-relaxed"
                />
              </div>

              {/* Style Section - Consistent sizing */}
              <div className="p-4 border-b border-zinc-800 flex-shrink-0">
                <div className="flex items-center gap-2 mb-3">
                  <Palette className="w-4 h-4 text-zinc-500" />
                  <span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Style</span>
                </div>
                
                <StyleInjector 
                  value={styleDirective} 
                  onChange={setStyleDirective} 
                  disabled={isProcessing}
                  referenceImage={styleReferenceImage}
                  onReferenceImageChange={setStyleReferenceImage}
                  importedStyles={importedStylesList}
                  onImportClick={() => setShowImportLibraryModal(true)}
                  onDeleteDS={handleDeleteDS}
                />
              </div>

              {/* Generate Button */}
              <div className="p-4 border-b border-zinc-800 flex-shrink-0">
                {(() => {
                  // Determine if we're in update mode (existing project + changed context)
                  const hasProject = activeGeneration && generatedCode && generationComplete;
                  const hasContextChange = refinements.trim() !== (activeGeneration?.refinements || "").trim();
                  const hasStyleChange = styleDirective.trim() !== (activeGeneration?.styleDirective || "").trim();
                  const isUpdateMode = hasProject && (hasContextChange || hasStyleChange) && refinements.trim();
                  
                  return (
                    <ShimmerButton 
                      onClick={handleGenerate}
                      disabled={isProcessing || isEditing || flows.length === 0}
                      shimmerColor="#ffffff"
                      shimmerDuration="2s"
                      background="#111111"
                      borderRadius="9999px"
                      className="w-full py-3.5 text-[13px] font-semibold disabled:opacity-50"
                    >
                      {isProcessing || isEditing ? (
                        <><Loader2 className="w-4 h-4 animate-spin mr-2" /><span className="text-white">{isEditing ? "Updating..." : "Reconstructing..."}</span></>
                      ) : (
                        <><LogoIcon className="w-4 h-4 mr-2" color="white" /><span className="text-white font-semibold">Reconstruct</span></>
                      )}
                    </ShimmerButton>
                  );
                })()}
              </div>

              {/* Analysis Section */}
              <div className="flex-1 flex flex-col min-h-0">
                <div className="px-4 py-3 border-b border-zinc-800 flex items-center gap-2 flex-shrink-0">
                  <Activity className="w-4 h-4 text-zinc-500" />
                  <span className="text-xs font-semibold text-zinc-400 uppercase tracking-wider">Analysis</span>
                </div>
                <div className="flex-1 p-4 overflow-auto">
                  {(isProcessing || isStreamingCode) && analysisPhase ? (
                    <div className="space-y-4">
                      {/* UX Signals */}
                      <div className="bg-zinc-800/50 rounded-lg p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="text-[10px] font-semibold text-zinc-500 uppercase tracking-wider">UX Signals</span>
                        </div>
                        <div className="space-y-1.5">
                          {analysisPhase.uxSignals && analysisPhase.uxSignals.length > 0 ? (
                            analysisPhase.uxSignals.map((signal, i) => (
                              <div key={signal.label} className="flex items-center justify-between">
                                <span className="text-[10px] text-zinc-600">{signal.label}</span>
                                <span className="text-[10px] text-zinc-500">{signal.value}</span>
                              </div>
                            ))
                          ) : (
                            <div className="flex items-center gap-2 text-[10px] text-zinc-600">
                              <Loader2 className="w-3 h-3 animate-spin text-zinc-300/50" />
                              <span>Detecting UX patterns...</span>
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Structure & Components */}
                      {analysisPhase.structureItems && analysisPhase.structureItems.length > 0 && (
                        <div className="bg-zinc-800/50 rounded-lg p-3">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-[10px] font-semibold text-zinc-500 uppercase tracking-wider">Structure</span>
                          </div>
                          <div className="space-y-1">
                            {analysisPhase.structureItems.map((item, i) => (
                              <div key={item.name} className="flex items-center gap-2">
                                <div className={cn("w-1.5 h-1.5 rounded-full", item.status === "done" ? "bg-green-500/60" : "bg-zinc-800/40")} />
                                <span className="text-[10px] text-zinc-500">{item.name}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : !generatedCode ? (
                    <div className="flex flex-col items-center justify-center h-full text-center py-8">
                      <Clock className="w-8 h-8 text-white/10 mb-3" />
                      <p className="text-xs font-medium text-zinc-500 uppercase tracking-wider">Waiting for generation</p>
                      <p className="text-[10px] text-white/25 mt-1">Live analysis logs will display here once generation starts.</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <Check className="w-4 h-4 text-green-500/60" />
                        <span className="text-xs text-zinc-400">Generation complete</span>
                      </div>
                      {styleInfo && (
                        <p className="text-[10px] text-zinc-500">{styleInfo.colors.length} colors, {styleInfo.fonts.length} fonts detected</p>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
              </>
            )}
          </div>
      )}
      
      {/* Mobile Preview Panel - Static */}
      {mobilePanel === "preview" && !showHistoryMode && !showMobileMenu && (
          <div className={cn(
            "fixed inset-x-0 top-0 z-30 md:hidden bg-[#111111] flex flex-col",
            isDemoMode ? "bottom-0" : "bottom-[72px]"
          )}>
            {/* Demo Mode Header - Simplified */}
            {isDemoMode ? (
              <div className="flex items-center justify-between px-4 py-3 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
                <a href="/" className="flex items-center gap-2">
                  <LogoIcon className="w-7 h-7" color="white" />
                  <span className="text-sm font-semibold text-zinc-200">Replay Demo</span>
                </a>
                <button 
                  onClick={() => setShowAuthModal(true)}
                  className="px-4 py-2 rounded-lg bg-zinc-800 text-white text-sm font-semibold"
                >
                  Try Free
                </button>
              </div>
            ) : (
              /* Regular Mobile Header with Close button */
              <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
                {/* Close button */}
                <button 
                  onClick={() => setMobilePanel("input")} 
                  className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-1"
                >
                  <X className="w-5 h-5 text-zinc-400" />
                </button>
                <input
                  type="text"
                  value={generationTitle}
                  onChange={(e) => setGenerationTitle(e.target.value)}
                  onBlur={() => {
                    if (activeGeneration) {
                      const updated = { ...activeGeneration, title: generationTitle };
                      setActiveGeneration(updated);
                      setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updated : g));
                    }
                  }}
                  className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                  placeholder="Untitled"
                />
                <div className="flex items-center gap-1 flex-shrink-0">
                  <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New">
                    <Plus className="w-5 h-5 text-zinc-500" />
                  </button>
                  <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                    <History className="w-5 h-5 text-zinc-500" />
                  </button>
                  <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                    {user ? (
                      <span className={cn(
                        "text-xs font-semibold uppercase",
                        (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                      )}>
                        {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                      </span>
                    ) : (
                      <User className="w-5 h-5 text-zinc-500" />
                    )}
                  </button>
                </div>
              </div>
            )}
            
            {/* Content */}
            <div className="flex-1 overflow-hidden">
              {(isProcessing || isStreamingCode) ? (
                <div className="flex flex-col items-center justify-center h-full text-center p-4">
                  <LoadingState />
                </div>
              ) : previewUrl ? (
                <div className="w-full h-full bg-[#111111]" style={{ overscrollBehavior: 'contain' }}>
                  <iframe 
                    key={previewUrl}
                    src={previewUrl} 
                    className="w-full h-full border-0 bg-[#111111]" 
                    style={{ 
                      touchAction: 'auto',
                      overscrollBehavior: 'contain',
                      backgroundColor: '#0a0a0a'
                    }}
                  />
                </div>
              ) : (
                <div className="flex flex-col items-center justify-center h-full text-center p-4">
                  <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--accent-orange)]/20 to-[#52525b]/10 flex items-center justify-center mb-4">
                    <Eye className="w-8 h-8 text-zinc-300/50" />
                  </div>
                  <p className="text-sm text-zinc-500 font-medium">No preview yet</p>
                  <p className="text-xs text-zinc-600 mt-1">Generate to see preview</p>
                </div>
              )}
            </div>
            
            {/* Mobile Comment Input - Simple feedback input */}
            {!isDemoMode && previewUrl && (
              <div className="flex-shrink-0 p-3 border-t border-zinc-800 bg-zinc-900/95 backdrop-blur-xl">
                <form 
                  onSubmit={(e) => {
                    e.preventDefault();
                    const input = e.currentTarget.querySelector('input') as HTMLInputElement;
                    const comment = input?.value?.trim();
                    if (comment) {
                      // Add comment to chat messages for now (simple implementation)
                      setChatMessages(prev => [...prev, { 
                        id: `comment-${Date.now()}`,
                        role: 'user', 
                        content: `💬 Comment: ${comment}`,
                        timestamp: Date.now()
                      }]);
                      input.value = '';
                      showToast("Comment added!", "success");
                    }
                  }}
                  className="flex items-center gap-2"
                >
                  <input
                    type="text"
                    placeholder="Add a comment..."
                    className="flex-1 px-4 py-3 rounded-xl bg-zinc-800/50 border border-zinc-700/50 text-sm text-white placeholder:text-zinc-500 focus:outline-none focus:border-zinc-600"
                  />
                  <button 
                    type="submit"
                    className="p-3 rounded-xl bg-zinc-800 hover:bg-zinc-700 active:bg-zinc-600 transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
                  >
                    <Send className="w-5 h-5 text-zinc-300" />
                  </button>
                </form>
              </div>
            )}
            
            {/* Demo Mode Bottom Banner */}
            {isDemoMode && previewUrl && (
              <div className="flex-shrink-0 p-4 border-t border-zinc-800 bg-gradient-to-t from-black to-transparent">
                <div className="bg-zinc-800/50 border border-zinc-700 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <div className="w-10 h-10 rounded-lg bg-zinc-800/10 flex items-center justify-center flex-shrink-0">
                      <Monitor className="w-5 h-5 text-zinc-300" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">View full project on desktop</p>
                      <p className="text-xs text-zinc-500 mt-0.5">Code, Flow Map, Design System & Edit with AI available on larger screens</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShowAuthModal(true)}
                    className="w-full mt-3 py-3 rounded-lg bg-zinc-800 text-white text-sm font-semibold"
                  >
                    Sign up free to create your own
                  </button>
                </div>
              </div>
            )}
          </div>
      )}
      
      {/* Mobile Code Panel - Static */}
      {mobilePanel === "code" && !showHistoryMode && !showMobileMenu && (
          <div className="fixed inset-x-0 bottom-[72px] top-0 z-30 md:hidden bg-[#111111] flex flex-col">
            {/* Unified Mobile Header with Close button */}
            <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
              <button 
                onClick={() => setMobilePanel("preview")} 
                className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-1"
              >
                <X className="w-5 h-5 text-zinc-400" />
              </button>
              <input
                type="text"
                value={generationTitle}
                onChange={(e) => setGenerationTitle(e.target.value)}
                onBlur={() => {
                  if (activeGeneration) {
                    const updated = { ...activeGeneration, title: generationTitle };
                    setActiveGeneration(updated);
                    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updated : g));
                  }
                }}
                className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                placeholder="Untitled"
              />
              <div className="flex items-center gap-1 flex-shrink-0">
                <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New">
                  <Plus className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                  <History className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowProjectSettings(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Settings">
                  <Settings className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                  {user ? (
                    <span className={cn(
                      "text-xs font-semibold uppercase",
                      (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                    )}>
                      {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                    </span>
                  ) : (
                    <User className="w-5 h-5 text-zinc-500" />
                  )}
                </button>
              </div>
            </div>
            
            {(isProcessing || isStreamingCode) ? (
              <div className="flex flex-col items-center justify-center h-full text-center p-4">
                <LoadingState />
              </div>
            ) : generatedCode ? (
              <>
                {/* Secondary Header with toggle, copy, and download */}
                <div className="flex items-center justify-between p-2 border-b border-zinc-700 flex-shrink-0 bg-zinc-900">
                  <div className="flex items-center gap-1">
                    <button
                      onClick={() => setCodeMode("single-file")}
                      className={cn(
                        "text-[10px] px-2 py-1 rounded-md transition-colors",
                        codeMode === "single-file" ? "bg-white/10 text-white" : "text-zinc-500"
                      )}
                    >
                      Single-file
                    </button>
                    <button
                      onClick={() => generationComplete && setCodeMode("componentized")}
                      disabled={!generationComplete}
                      className={cn(
                        "text-[10px] px-2 py-1 rounded-md transition-colors",
                        codeMode === "componentized" ? "bg-white/10 text-white" : "text-zinc-500",
                        !generationComplete && "opacity-50"
                      )}
                    >
                      Componentized
                    </button>
                  </div>
                  <div className="flex items-center gap-2">
                    <button 
                      onClick={() => {
                        if (!isPaidPlan) {
                          setUpgradeFeature("code");
                          setShowUpgradeModal(true);
                        } else {
                          navigator.clipboard.writeText(getActiveFileContent());
                          showToast("Copied!", "success");
                        }
                      }} 
                      className={cn(
                        "text-[10px] text-zinc-500 hover:text-zinc-400 flex items-center gap-1",
                        !isPaidPlan && "opacity-50"
                      )}
                    >
                      {!isPaidPlan && <Lock className="w-2.5 h-2.5" />}
                      <Copy className="w-3 h-3" />
                    </button>
                    <button 
                      onClick={() => {
                        if (!isPaidPlan) {
                          setUpgradeFeature("download");
                          setShowUpgradeModal(true);
                        } else {
                          handleDownload();
                        }
                      }}
                      className={cn(
                        "text-[10px] text-zinc-500 hover:text-zinc-400 flex items-center gap-1",
                        !isPaidPlan && "opacity-50"
                      )}
                    >
                      {!isPaidPlan && <Lock className="w-2.5 h-2.5" />}
                      <Download className="w-3 h-3" />
                    </button>
                  </div>
                </div>
                
                {/* File tree (compact for mobile) */}
                {codeMode === "componentized" && generatedFiles.length > 0 && (
                  <div className="flex overflow-x-auto gap-1 p-2 border-b border-zinc-800 flex-shrink-0">
                    {generatedFiles.filter(f => !f.isStub).slice(0, 8).map(file => (
                      <button
                        key={file.path}
                        onClick={() => setActiveFilePath(file.path)}
                        className={cn(
                          "text-[9px] px-2 py-1 rounded whitespace-nowrap flex-shrink-0",
                          activeFilePath === file.path 
                            ? "bg-zinc-800/20 text-zinc-300" 
                            : "bg-zinc-800/50 text-zinc-500"
                        )}
                      >
                        {file.name}
                      </button>
                    ))}
                  </div>
                )}
                
                {/* Code display with syntax highlighting - Visible for all, export locked */}
                <div className="flex-1 overflow-auto bg-[#111111] relative">
                  {generatingFilePath && generatingFilePath === activeFilePath ? (
                    <div className="w-full h-full flex flex-col items-center justify-center gap-3">
                      <Loader2 className="w-6 h-6 text-zinc-300 animate-spin" />
                      <div className="text-center">
                        <p className="text-xs text-zinc-400">Generating page...</p>
                        <p className="text-[10px] text-zinc-600 mt-0.5">{activeFilePath.split('/').pop()}</p>
                      </div>
                    </div>
                  ) : (
                    <Highlight 
                      theme={themes.nightOwl} 
                      code={getActiveFileContent()} 
                      language={activeFilePath.endsWith('.tsx') || activeFilePath.endsWith('.ts') ? 'tsx' : 'html'}
                    >
                      {({ style, tokens, getLineProps, getTokenProps }) => (
                        <pre 
                          className="p-3 text-[10px] leading-relaxed min-h-full" 
                          style={{ 
                            ...style, 
                            background: "#111111", 
                            fontFamily: "'JetBrains Mono', 'SF Mono', monospace",
                          }}
                        >
                          {tokens.map((line, i) => (
                            <div key={i} {...getLineProps({ line })}>
                              <span className="inline-block w-6 pr-2 text-right text-white/15 select-none text-[9px]">{i + 1}</span>
                              {line.map((token, key) => <span key={key} {...getTokenProps({ token })} />)}
                            </div>
                          ))}
                        </pre>
                      )}
                    </Highlight>
                  )}
                </div>
                
                {/* Edit with AI button */}
                {!showFloatingEdit && !isStreamingCode && (
                  <div className="flex-shrink-0 p-3 border-t border-zinc-800">
                    <button 
                      onClick={() => { setShowFloatingEdit(true); setIsDirectEditMode(false); }} 
                      className="w-full flex items-center justify-center gap-2 py-2.5 rounded-xl bg-zinc-800/50 border border-zinc-700 text-zinc-400 text-xs font-medium"
                    >
                      <Sparkles className="w-3.5 h-3.5 text-zinc-300" /> Edit with AI
                    </button>
                  </div>
                )}
              </>
            ) : (
              <div className="flex flex-col items-center justify-center h-full text-center p-4">
                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--accent-orange)]/20 to-[#52525b]/10 flex items-center justify-center mb-4">
                  <Code className="w-8 h-8 text-zinc-300/50" />
                </div>
                <p className="text-sm text-zinc-500 font-medium">No code yet</p>
                <p className="text-xs text-zinc-600 mt-1">Generate to see code</p>
              </div>
            )}
          </div>
      )}
      
      {/* Mobile Flow Panel - Static */}
      {mobilePanel === "flow" && !showHistoryMode && !showMobileMenu && (
          <div className="fixed inset-x-0 bottom-[72px] top-0 z-30 md:hidden bg-[#111111] flex flex-col">
            {/* Unified Mobile Header with Close button */}
            <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
              <button 
                onClick={() => setMobilePanel("preview")} 
                className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-1"
              >
                <X className="w-5 h-5 text-zinc-400" />
              </button>
              <input
                type="text"
                value={generationTitle}
                onChange={(e) => setGenerationTitle(e.target.value)}
                onBlur={() => {
                  if (activeGeneration) {
                    const updated = { ...activeGeneration, title: generationTitle };
                    setActiveGeneration(updated);
                    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updated : g));
                  }
                }}
                className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                placeholder="Untitled"
              />
              <div className="flex items-center gap-1 flex-shrink-0">
                <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New">
                  <Plus className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                  <History className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowProjectSettings(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Settings">
                  <Settings className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                  {user ? (
                    <span className={cn(
                      "text-xs font-semibold uppercase",
                      (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                    )}>
                      {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                    </span>
                  ) : (
                    <User className="w-5 h-5 text-zinc-500" />
                  )}
                </button>
              </div>
            </div>
            
            {flowNodes.length > 0 ? (
              <>
                {/* Secondary Header with toggles */}
                <div className="flex items-center justify-between px-3 py-2 border-b border-zinc-700 flex-shrink-0 bg-zinc-900">
                  <div>
                    <span className="text-xs text-zinc-500 flex items-center gap-1.5">
                      <GitBranch className="w-3.5 h-3.5 text-zinc-300" />
                      Product Flow
                    </span>
                  </div>
                  <div className="flex gap-1">
                    <button 
                      onClick={() => setShowPossiblePaths(!showPossiblePaths)}
                      className={cn(
                        "text-[9px] px-2 py-1 rounded-lg flex items-center gap-1",
                        showPossiblePaths ? "bg-white text-zinc-900" : "bg-zinc-800/50 text-zinc-500 hover:bg-zinc-700/50"
                      )}
                    >
                      <GitBranch className="w-2.5 h-2.5" />
                      Possible
                    </button>
                    <button 
                      onClick={() => setShowStructureInFlow(!showStructureInFlow)}
                      className={cn(
                        "text-[9px] px-2 py-1 rounded-lg flex items-center gap-1",
                        showStructureInFlow ? "bg-white text-zinc-900" : "bg-zinc-800/50 text-zinc-500 hover:bg-zinc-700/50"
                      )}
                    >
                      <Layers className="w-2.5 h-2.5" />
                      Structure
                    </button>
                  </div>
                </div>
                
                {/* Flow nodes list */}
                <div className="flex-1 overflow-auto p-4 space-y-3">
                  {flowNodes
                    .filter(node => showPossiblePaths || node.status === "observed" || node.status === "added")
                    .map(node => {
                    const isObserved = node.status === "observed";
                    const isDetected = node.status === "detected";
                    const isPossible = node.status === "possible";
                    return (
                      <div 
                        key={node.id} 
                        className={cn(
                          "p-3 rounded-xl border",
                          isObserved
                            ? "border-emerald-500/30 bg-emerald-500/5"
                            : isDetected 
                            ? "border-zinc-600/30 bg-zinc-700/10" 
                            : isPossible 
                            ? "border-dashed border-white/20 bg-zinc-800/50 opacity-60" 
                            : "border-zinc-700 bg-zinc-800/5"
                        )}
                        onClick={() => {
                          if (isEditing) return;
                          if (isDetected || isPossible) {
                            // Full prompt like on desktop
                            setEditInput(`@${node.name} Create this page with the same style and navigation as the main page`);
                            setShowFloatingEdit(true);
                          }
                        }}
                      >
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-2">
                            {isObserved && <div className="w-1.5 h-1.5 rounded-full bg-emerald-400" />}
                            {isDetected && <div className="w-1.5 h-1.5 rounded-full bg-zinc-500" />}
                            {isPossible && <div className="w-1.5 h-1.5 rounded-full bg-white/40" />}
                            <p className={cn(
                              "text-sm font-medium",
                              isPossible ? "text-zinc-500 italic" : isDetected ? "text-zinc-400" : "text-zinc-200"
                            )}>{node.name}</p>
                          </div>
                          <span className={cn(
                            "text-[8px] px-1.5 py-0.5 rounded uppercase",
                            isPossible ? "bg-zinc-800/50 text-zinc-600" : isDetected ? "bg-zinc-600/10 text-zinc-400" : "bg-emerald-500/10 text-emerald-400/60"
                          )}>
                            {isPossible ? "possible" : isDetected ? "detected" : "observed"}
                          </span>
                        </div>
                        {node.description && (
                          <p className={cn("text-xs", isPossible ? "text-white/25" : isDetected ? "text-zinc-600" : "text-zinc-500")}>
                            {node.description}
                          </p>
                        )}
                        
                        {/* Structure components (when toggle is ON) */}
                        {showStructureInFlow && node.components && node.components.length > 0 && (
                          <div className="mt-2 pt-2 border-t border-zinc-700">
                            <span className="text-[9px] text-zinc-600 uppercase">Components:</span>
                            <div className="flex flex-wrap gap-1 mt-1">
                              {node.components.map((comp, i) => (
                                <span key={i} className="text-[10px] px-1.5 py-0.5 rounded bg-zinc-800/50 text-zinc-500">{comp}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                  
                  {/* Transitions section inside scrollable area */}
                  {flowEdges.filter(e => showPossiblePaths || e.type !== "possible").length > 0 && (
                    <div className="mt-4 pt-4 border-t border-zinc-700">
                      <span className="text-xs text-zinc-500 block mb-2">Transitions</span>
                      {flowEdges
                        .filter(e => showPossiblePaths || e.type !== "possible")
                        .slice(0, 10)
                        .map(edge => {
                          const fromNode = flowNodes.find(n => n.id === edge.from);
                          const toNode = flowNodes.find(n => n.id === edge.to);
                          if (!fromNode || !toNode) return null;
                          return (
                            <div key={edge.id} className="text-[10px] text-zinc-500 py-1 flex items-center gap-1">
                              <span className="text-zinc-400">{fromNode.name}</span>
                              <span className="text-white/20">→</span>
                              <span className="text-zinc-300/70">{edge.label}</span>
                              <span className="text-white/20">→</span>
                              <span className={cn(
                                toNode.status === "possible" ? "text-zinc-600 italic" : 
                                toNode.status === "detected" ? "text-zinc-300/50" : "text-zinc-400"
                              )}>
                                {toNode.name}
                              </span>
                            </div>
                          );
                        })}
                    </div>
                  )}
                </div>
                
                {/* Edit with AI button */}
                {!showFloatingEdit && !isProcessing && (
                  <div className="flex-shrink-0 p-3 border-t border-zinc-800">
                    <button 
                      onClick={() => { setShowFloatingEdit(true); setIsDirectEditMode(false); }} 
                      className="w-full flex items-center justify-center gap-2 py-2.5 rounded-xl bg-zinc-800/50 border border-zinc-700 text-zinc-400 text-xs font-medium"
                    >
                      <Sparkles className="w-3.5 h-3.5 text-zinc-300" /> Edit with AI
                    </button>
                  </div>
                )}
              </>
            ) : (
              <div className="flex flex-col items-center justify-center h-full text-center p-4">
                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--accent-orange)]/20 to-[#52525b]/10 flex items-center justify-center mb-4">
                  <GitBranch className="w-8 h-8 text-zinc-300/50" />
                </div>
                <p className="text-sm text-zinc-500 font-medium">No flow yet</p>
                <p className="text-xs text-zinc-600 mt-1">Generate to see product flow</p>
              </div>
            )}
          </div>
      )}
      
      {/* Mobile Design Panel - Static */}
      {mobilePanel === "design" && !showHistoryMode && !showMobileMenu && (
          <div className="fixed inset-x-0 bottom-[72px] top-0 z-30 md:hidden bg-[#111111] flex flex-col">
            {/* Unified Mobile Header with Close button */}
            <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
              <button 
                onClick={() => setMobilePanel("preview")} 
                className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-1"
              >
                <X className="w-5 h-5 text-zinc-400" />
              </button>
              <input
                type="text"
                value={generationTitle}
                onChange={(e) => setGenerationTitle(e.target.value)}
                onBlur={() => {
                  if (activeGeneration) {
                    const updated = { ...activeGeneration, title: generationTitle };
                    setActiveGeneration(updated);
                    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updated : g));
                  }
                }}
                className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                placeholder="Untitled"
              />
              <div className="flex items-center gap-1 flex-shrink-0">
                <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New">
                  <Plus className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                  <History className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowProjectSettings(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Settings">
                  <Settings className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                  {user ? (
                    <span className={cn(
                      "text-xs font-semibold uppercase",
                      (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                    )}>
                      {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                    </span>
                  ) : (
                    <User className="w-5 h-5 text-zinc-500" />
                  )}
                </button>
              </div>
            </div>
            
            {styleInfo ? (
              <div className="flex-1 overflow-auto p-4 space-y-6">
                {/* Colors */}
                <div>
                  <span className="text-xs text-zinc-500 flex items-center gap-1.5 mb-3">
                    <div className="w-2 h-2 rounded-full bg-zinc-800" />
                    Colors
                  </span>
                  <div className="grid grid-cols-4 gap-2">
                    {styleInfo.colors.slice(0, 8).map((color, i) => (
                      <div key={i} className="space-y-1">
                        <div 
                          className="h-12 rounded-lg border border-zinc-700" 
                          style={{ backgroundColor: color.value }} 
                        />
                        <p className="text-[9px] text-zinc-500 text-center truncate">{color.name || color.value}</p>
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* Typography */}
                {styleInfo.fonts.length > 0 && (
                  <div>
                    <span className="text-xs text-zinc-500 flex items-center gap-1.5 mb-3">
                      <Type className="w-3 h-3 text-zinc-300" />
                      Typography
                    </span>
                    <div className="space-y-2">
                      {styleInfo.fonts.map((font, i) => (
                        <div key={i} className="p-2 bg-zinc-800/50 rounded-lg">
                          <p className="text-sm text-zinc-400" style={{ fontFamily: font.family }}>
                            {font.family || font.name}
                          </p>
                          <p className="text-[10px] text-zinc-600">{font.usage || font.weight}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Spacing & Radius */}
                <div className="grid grid-cols-2 gap-4">
                  {styleInfo.spacing && (
                    <div>
                      <span className="text-xs text-zinc-500 block mb-2">Spacing</span>
                      <p className="text-sm text-zinc-400">{styleInfo.spacing}</p>
                    </div>
                  )}
                  {styleInfo.borderRadius && (
                    <div>
                      <span className="text-xs text-zinc-500 block mb-2">Radius</span>
                      <p className="text-sm text-zinc-400">{styleInfo.borderRadius}</p>
                    </div>
                  )}
                </div>
                
                {/* Shadows */}
                {styleInfo.shadows && (
                  <div>
                    <span className="text-xs text-zinc-500 block mb-2">Shadows</span>
                    <p className="text-sm text-zinc-400">{styleInfo.shadows}</p>
                  </div>
                )}
              </div>
            ) : (
              <div className="flex flex-col items-center justify-center h-full text-center p-4">
                <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--accent-orange)]/20 to-[#52525b]/10 flex items-center justify-center mb-4">
                  <Palette className="w-8 h-8 text-zinc-300/50" />
                </div>
                <p className="text-sm text-zinc-500 font-medium">No style analysis yet</p>
                <p className="text-xs text-zinc-600 mt-1">Generate to see design system</p>
              </div>
            )}
          </div>
      )}
      
      {/* Mobile Chat Panel - Static */}
      {mobilePanel === "chat" && generatedCode && !showHistoryMode && !showMobileMenu && (
          <div className="fixed inset-x-0 bottom-[72px] top-0 z-30 md:hidden bg-[#111111] flex flex-col">
            {/* Combined Header with Close button */}
            <div className="flex items-center gap-2 px-3 py-2.5 border-b border-zinc-800 flex-shrink-0 bg-zinc-900 backdrop-blur-xl">
              <button 
                onClick={() => setMobilePanel("preview")} 
                className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-1"
              >
                <X className="w-5 h-5 text-zinc-400" />
              </button>
              <input
                type="text"
                value={generationTitle}
                onChange={(e) => setGenerationTitle(e.target.value)}
                onBlur={() => {
                  if (activeGeneration) {
                    const updated = { ...activeGeneration, title: generationTitle };
                    setActiveGeneration(updated);
                    setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updated : g));
                  }
                }}
                className="flex-1 min-w-0 text-sm font-medium text-zinc-200 bg-transparent focus:outline-none truncate"
                placeholder="Untitled"
              />
              <div className="flex items-center gap-1 flex-shrink-0">
                <button onClick={resetToNewProject} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="New">
                  <Plus className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowHistoryMode(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Your Projects">
                  <History className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowProjectSettings(true)} className="p-2.5 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-w-[44px] min-h-[44px] flex items-center justify-center" title="Settings">
                  <Settings className="w-5 h-5 text-zinc-500" />
                </button>
                <button onClick={() => setShowMobileMenu(!showMobileMenu)} className="px-3 py-2 rounded-xl hover:bg-zinc-800/50 active:bg-white/10 min-h-[44px] flex items-center justify-center">
                  {user ? (
                    <span className={cn(
                      "text-xs font-semibold uppercase",
                      (membership?.plan === "pro" || membership?.plan === "agency" || membership?.plan === "enterprise") ? "text-zinc-300" : "text-zinc-500"
                    )}>
                      {membership?.plan === "agency" ? "Agency" : membership?.plan === "enterprise" ? "Enterprise" : membership?.plan === "pro" ? "Pro" : "Free"}
                    </span>
                  ) : (
                    <User className="w-5 h-5 text-zinc-500" />
                  )}
                </button>
              </div>
            </div>
            
            {/* Tabs: Replay AI | Input */}
            <div className="flex-shrink-0 px-3 py-1.5 border-b border-white/[0.03]">
              <div className="flex gap-1">
                <button
                  onClick={() => setSidebarTab("chat")}
                  className={cn(
                    "flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium transition-all",
                    sidebarTab === "chat" 
                      ? "bg-zinc-800/50 text-white" 
                      : "text-zinc-500"
                  )}
                >
                  <Send className="w-3.5 h-3.5" />
                  Replay AI
                </button>
                <button
                  onClick={() => setSidebarTab("style")}
                  className={cn(
                    "flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium transition-all",
                    sidebarTab === "style" 
                      ? "bg-zinc-800/50 text-white" 
                      : "text-zinc-500"
                  )}
                >
                  <Boxes className="w-3.5 h-3.5" />
                  Config
                </button>
              </div>
            </div>

            {sidebarTab === "chat" ? (
              <>
                {/* Chat Messages - Same style as desktop */}
                <div className="flex-1 overflow-y-auto p-3 space-y-3">
                  {chatMessages.map((msg) => (
                    <motion.div 
                      key={msg.id} 
                      initial={{ opacity: 0, y: 8 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="space-y-1"
                    >
                      {msg.role === "assistant" ? (
                        /* AI Message */
                        <div className="space-y-2">
                          <div className="flex items-center gap-2">
                            <LogoIcon className="w-4 h-4" color="var(--accent-orange)" />
                            <span className="text-xs font-medium text-zinc-500">Replay</span>
                          </div>
                          <div className="text-sm leading-relaxed text-zinc-400 space-y-2">
                            {msg.content.split('\n').map((line, i) => {
                              if (line.includes('Complete')) {
                                return <p key={i} className="text-emerald-400/90 font-medium flex items-center gap-1.5"><Check className="w-4 h-4" />{line.replace(/\*\*/g, '')}</p>;
                              }
                              if (line.startsWith('**') && line.endsWith('**')) {
                                return <p key={i} className="font-semibold text-zinc-200">{line.replace(/\*\*/g, '')}</p>;
                              }
                              if (line.startsWith('• ') || line.startsWith('- ')) {
                                return <p key={i} className="text-zinc-400 pl-3 border-l-2 border-zinc-700">{line.substring(2)}</p>;
                              }
                              if (line.trim()) {
                                return <p key={i}>{line.replace(/\*\*([^*]+)\*\*/g, (_, t) => t)}</p>;
                              }
                              return null;
                            })}
                          </div>
                          {/* Quick Actions */}
                          {msg.quickActions && msg.quickActions.length > 0 && (
                            <div className="flex flex-wrap gap-2 pt-2">
                              {msg.quickActions.map((action, i) => (
                                <button
                                  key={i}
                                  onClick={() => setChatInput(action)}
                                  className="px-3 py-1.5 rounded-lg text-xs bg-zinc-800/50 text-zinc-500 hover:bg-zinc-800/50 hover:text-zinc-200 border border-zinc-800 transition-all"
                                >
                                  {action}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      ) : (
                        /* User Message */
                        <div className="flex justify-end">
                          <div className="max-w-[85%]">
                            <div className="px-4 py-2.5 rounded-2xl bg-zinc-800/50 text-sm text-zinc-200">
                              {msg.content}
                            </div>
                            {msg.attachments && msg.attachments.length > 0 && (
                              <div className="flex justify-end gap-1.5 mt-1.5">
                                {msg.attachments.map((att, i) => (
                                  <span key={i} className="inline-flex items-center gap-1.5 px-2 py-1 rounded-lg bg-violet-500/10 text-violet-300/80 text-xs">
                                    {att.type === "image" && <ImageIcon className="w-3 h-3" />}
                                    {att.label}
                                  </span>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </motion.div>
                  ))}
                  
                  {/* Thinking Indicator - Mobile - Clean, no code display */}
                  {isEditing && (
                    <motion.div 
                      initial={{ opacity: 0, y: 8 }} 
                      animate={{ opacity: 1, y: 0 }} 
                      className="rounded-lg border border-zinc-700 bg-zinc-900/80 px-3 py-2.5"
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Loader2 className="w-3.5 h-3.5 text-zinc-400 animate-spin" />
                          <span className="text-xs text-zinc-500">{streamingStatus || "Working..."}</span>
                          {streamingLines > 0 && (
                            <span className="text-[10px] text-zinc-600 font-mono">{streamingLines} lines</span>
                          )}
                        </div>
                        <button
                          onClick={() => {
                            cancelAIRequest();
                            setIsEditing(false);
                            setStreamingStatus(null);
                            setStreamingCode(null);
                            setStreamingLines(0);
                            showToast("Cancelled", "info");
                          }}
                          className="p-1 rounded hover:bg-zinc-800 text-zinc-600"
                        >
                          <X className="w-3.5 h-3.5" />
                        </button>
                      </div>
                    </motion.div>
                  )}
                </div>
              </>
            ) : (
              /* Input Tab - Video & Style Configuration */
              <div className="flex-1 overflow-y-auto p-4 space-y-4">
                {/* Videos Section */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider flex items-center gap-1">
                      <Video className="w-2.5 h-2.5" /> Videos
                      {flows.length > 0 && <span className="text-[8px] bg-white/10 px-1 py-0.5 rounded">{flows.length}</span>}
                    </label>
                  </div>
                  <div className="flex gap-1.5 mb-2">
                    <button 
                      onClick={startRecording}
                      className="flex-1 flex items-center justify-center gap-1 px-2 py-2 rounded-lg bg-zinc-800/50 border border-zinc-700 hover:bg-zinc-800/50 text-[10px] text-zinc-400 hover:text-zinc-200 transition-colors"
                    >
                      <Monitor className="w-3 h-3" /> Record
                    </button>
                    <button 
                      onClick={() => fileInputRef.current?.click()}
                      className="flex-1 flex items-center justify-center gap-1 px-2 py-2 rounded-lg bg-zinc-800/50 border border-zinc-700 hover:bg-zinc-800/50 text-[10px] text-zinc-400 hover:text-zinc-200 transition-colors"
                    >
                      <Upload className="w-3 h-3" /> Upload
                    </button>
                  </div>
                  {/* Video list */}
                  <div className="space-y-1.5 max-h-[120px] overflow-auto">
                    {flows.map((flow) => (
                      <button key={flow.id} onClick={() => setSelectedFlowId(flow.id)} className={cn("w-full flex items-center gap-2 p-2 rounded-lg cursor-pointer text-left", selectedFlowId === flow.id ? "bg-zinc-800/10 border border-zinc-700" : "bg-zinc-800/50 hover:bg-zinc-800/50")} aria-label={`Select flow ${flow.name}`}>
                        <div className="w-10 h-6 rounded overflow-hidden bg-zinc-800/50 flex-shrink-0 flex items-center justify-center">
                          {flow.thumbnail && flow.thumbnail.length > 100 ? (
                            <img src={flow.thumbnail} alt="" className="w-full h-full object-cover" />
                          ) : flow.videoUrl ? (
                            <video src={flow.videoUrl} className="w-full h-full object-cover" muted preload="metadata" onLoadedData={(e) => { e.currentTarget.currentTime = 0.5; }} />
                          ) : (
                            <Film className="w-3 h-3 text-white/20" />
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-xs text-zinc-400 truncate">{flow.name}</p>
                          <p className="text-[10px] text-zinc-600">{formatDuration(flow.duration)}</p>
                        </div>
                        <span onClick={(e) => { e.stopPropagation(); setFlows(prev => prev.filter(f => f.id !== flow.id)); }} className="p-1 text-white/20 hover:text-red-400" role="button" tabIndex={0} aria-label="Remove flow" onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); setFlows(prev => prev.filter(f => f.id !== flow.id)); }}}>
                          <Trash2 className="w-3 h-3" />
                        </span>
                      </button>
                    ))}
                    {flows.length === 0 && (
                      <div className="text-center py-3 text-[10px] text-zinc-600">
                        Record or upload a video to get started
                      </div>
                    )}
                  </div>
                </div>
                
                {/* Context */}
                <div>
                  <label className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider mb-1.5 block">Context</label>
                  <textarea
                    value={refinements}
                    onChange={(e) => setRefinements(e.target.value)}
                    placeholder="Add data logic, constraints..."
                    rows={2}
                    className="w-full px-3 py-2 rounded-lg bg-zinc-800/50 border border-zinc-700 text-xs text-zinc-200 placeholder:text-zinc-600 focus:outline-none focus:border-white/15 resize-y min-h-[60px] max-h-[200px] transition-colors"
                  />
                </div>
                
                {/* Visual Style */}
                <div>
                  <div className="flex items-center justify-between mb-1.5">
                    <label className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider">Style</label>
                  </div>
                  
                  <StyleInjector 
                    value={styleDirective} 
                    onChange={setStyleDirective} 
                    disabled={isProcessing}
                    referenceImage={styleReferenceImage}
                    onReferenceImageChange={setStyleReferenceImage}
                    importedStyles={importedStylesList}
                    onImportClick={() => setShowImportLibraryModal(true)}
                    onDeleteDS={handleDeleteDS}
                  />
                </div>
                
                {/* Reconstruct Button */}
                <div className="pt-1">
                  <button 
                    onClick={handleGenerate}
                    disabled={isProcessing || flows.length === 0}
                    className="w-full py-2.5 rounded-lg bg-zinc-800/10 hover:bg-zinc-800/20 border border-zinc-700 text-xs font-medium text-zinc-300 flex items-center justify-center gap-1.5 transition-colors disabled:opacity-50"
                  >
                    <LogoIcon className="w-3.5 h-3.5" color="var(--accent-orange)" />
                    Reconstruct
                  </button>
                </div>
                
                {/* Current Colors */}
                {styleInfo?.colors && styleInfo.colors.length > 0 && (
                  <div>
                    <label className="text-[10px] font-medium text-zinc-500 uppercase tracking-wider mb-1.5 block">Current Colors</label>
                    <div className="flex gap-1.5 flex-wrap">
                      {styleInfo.colors.slice(0, 6).map((color, i) => (
                        <div 
                          key={i} 
                          className="w-7 h-7 rounded-lg border border-zinc-700" 
                          style={{ backgroundColor: color.value }}
                          title={color.name}
                        />
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Chat Input - Only show in chat tab */}
            {sidebarTab === "chat" && (
            <div className="p-3 border-t border-zinc-800 flex-shrink-0 relative">
              {/* Auth overlay for non-logged users - Mobile */}
              {!user && (
                <div 
                  onClick={() => {
                    setShowAuthModal(true);
                    showToast("Sign up free to edit with AI. Get 1 free generation!", "info");
                  }}
                  className="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-zinc-900 backdrop-blur-[2px]"
                >
                  <div className="flex items-center gap-2 text-zinc-400 text-sm">
                    <Lock className="w-4 h-4" />
                    <span>Sign up to edit with AI</span>
                  </div>
                </div>
              )}
              {/* Pro feature overlay for demo mode - Mobile */}
              {user && isDemoMode && (
                <div 
                  onClick={() => {
                    setUpgradeFeature("code");
                    setShowUpgradeModal(true);
                  }}
                  className="absolute inset-0 z-10 cursor-pointer flex items-center justify-center bg-zinc-900/80 backdrop-blur-[2px]"
                >
                  <div className="flex items-center gap-2 text-zinc-400 text-sm">
                    <Sparkles className="w-4 h-4 text-[#FF6E3C]" />
                    <span>AI Edit is a Pro feature</span>
                  </div>
                </div>
              )}
              {/* Attachments preview - images only on mobile */}
              {editImages.length > 0 && (
                <div className="pb-2 flex gap-1.5 flex-wrap">
                  {editImages.map((img) => (
                    <div key={img.id} className="relative group">
                      <img src={img.url} alt="" className="w-10 h-10 rounded-lg object-cover border border-zinc-700" />
                      <button onClick={() => setEditImages(prev => prev.filter(i => i.id !== img.id))} className="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-red-500/80 text-white flex items-center justify-center"><X className="w-2.5 h-2.5" /></button>
                    </div>
                  ))}
                </div>
              )}
              <div className="flex items-end gap-2">
                <div className="flex-1 bg-zinc-800/50 rounded-xl border border-zinc-800">
                  <textarea
                    value={chatInput}
                    onChange={(e) => setChatInput(e.target.value)}
                    disabled={!user}
                    onPaste={handlePasteImage}
                    onKeyDown={async (e) => {
                      if (e.key === "Enter" && !e.shiftKey && chatInput.trim() && editableCode) {
                        e.preventDefault();
                        // Demo mode: AI Edit is Pro feature
                        if (isDemoMode) {
                          setUpgradeFeature("code");
                          setShowUpgradeModal(true);
                          return;
                        }
                        // Auth check on mobile - block non-logged users
                        if (!user) {
                          setShowAuthModal(true);
                          showToast("Sign up free to edit with AI. Get 1 free generation!", "info");
                          return;
                        }
                        const userMsg: ChatMessage = { id: generateId(), role: "user", content: chatInput, timestamp: Date.now(), attachments: editImages.length > 0 ? editImages.map(img => ({ type: "image" as const, label: img.name })) : undefined };
                        setChatMessages(prev => [...prev, userMsg]);
                        const currentInput = chatInput;
                        const currentPlanMode = isPlanMode;
                        const currentChatHistory = chatMessages.slice(-10).map(m => ({ role: m.role, content: m.content }));
                        setChatInput(""); setIsEditing(true);
                        try {
                          // Convert images to base64 for API (mobile handler)
                          let imageData: { base64?: string; url?: string; mimeType: string; name: string }[] | undefined;
                          if (editImages.length > 0) {
                            imageData = [];
                            for (const img of editImages) {
                              const base64 = await urlToBase64(img.url);
                              if (base64) imageData.push({ base64, mimeType: 'image/png', name: img.name, url: img.url });
                            }
                            if (imageData.length === 0) imageData = undefined;
                          }
                          
                          // USE STREAMING API FOR LIVE CODE DISPLAY
                          setStreamingStatus("Analyzing...");
                          setStreamingCode(null);
                          setStreamingLines(0);
                          
                          let currentStreamCode = '';
                          const result = await editCodeWithAIStreaming(
                            editableCode, 
                            currentInput, 
                            imageData, 
                            undefined, 
                            currentPlanMode, 
                            currentChatHistory,
                            (event) => {
                              if (event.type === 'status') {
                                setStreamingStatus(event.message || null);
                                if (event.phase === 'writing') {
                                  currentStreamCode = '';
                                  setStreamingCode('');
                                }
                              } else if (event.type === 'progress') {
                                setStreamingStatus(`Writing code...`);
                                setStreamingLines(event.lines || 0);
                                if (event.preview) {
                                  setStreamingCode(event.preview);
                                }
                              } else if (event.type === 'chunk' && event.text) {
                                // Real-time code streaming
                                currentStreamCode += event.text;
                                setStreamingCode(currentStreamCode.slice(-1500)); // Show last 1500 chars for better visibility
                                setStreamingLines(currentStreamCode.split('\n').length);
                              }
                            }
                          );
                          
                          setStreamingStatus(null);
                          setStreamingCode(null);
                          setStreamingLines(0);
                          
                          if (currentPlanMode) {
                            // Plan mode - just chat response
                            const response = result?.code || "Jasne, mogę w tym pomóc! Co chcesz omówić?";
                            setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: response, timestamp: Date.now() }]);
                          } else if (result?.success && result.code && result.code !== editableCode) {
                            // Code was changed
                            const responseMsg = analyzeCodeChanges(editableCode, result.code, currentInput);
                            setEditableCode(result.code); setDisplayedCode(result.code); setGeneratedCode(result.code);
                            setPreviewUrl(createPreviewUrl(result.code));
                            setChatMessages(prev => [...prev, { id: generateId(), role: "assistant", content: responseMsg, timestamp: Date.now() }]);
                            if (activeGeneration) {
                              const versionLabel = generateVersionLabel(currentInput);
                              const updatedGen = { 
                                ...activeGeneration, 
                                code: result.code, 
                                versions: [...(activeGeneration.versions || []), { 
                                  id: generateId(), 
                                  timestamp: Date.now(), 
                                  label: versionLabel, 
                                  code: result.code, 
                                  flowNodes, 
                                  flowEdges, 
                                  styleInfo 
                                }] 
                              };
                              setActiveGeneration(updatedGen); 
                              setGenerations(prev => prev.map(g => g.id === activeGeneration.id ? updatedGen : g));
                              saveGenerationToSupabase(updatedGen);
                            }
                          } else if (!result?.cancelled) {
                            setChatMessages(prev => [...prev, { 
                              id: generateId(), 
                              role: "assistant", 
                              content: `Error: ${result?.error || "Something went wrong. Please try again with a different request."}`, 
                              timestamp: Date.now() 
                            }]);
                          }
                        } catch (error) {
                          if (!(error instanceof Error && error.name === 'AbortError')) {
                            setChatMessages(prev => [...prev, { 
                              id: generateId(), 
                              role: "assistant", 
                              content: `Error: ${error instanceof Error ? error.message : "Unknown error occurred"}`, 
                              timestamp: Date.now() 
                            }]);
                          }
                        } finally {
                          setIsEditing(false);
                          setStreamingStatus(null);
                          setStreamingCode(null);
                          setStreamingLines(0);
                          setEditImages([]);
                        }
                      }
                    }}
                    placeholder={isPlanMode ? "Plan and discuss changes..." : "Ask Replay to edit..."}
                    rows={1}
                    className="w-full px-3 py-2.5 bg-transparent text-[11px] text-zinc-200 placeholder:text-white/25 resize-none focus:outline-none min-h-[36px]"
                  />
                  
                  {/* Attachments preview - images only on mobile */}
                  {editImages.length > 0 && (
                    <div className="px-3 pb-2 flex gap-1.5 flex-wrap">
                      {editImages.map((img) => (
                        <div key={img.id} className="relative group">
                          <img src={img.url} alt="" className="w-8 h-8 rounded object-cover border border-zinc-700" />
                          <button onClick={() => setEditImages(prev => prev.filter(i => i.id !== img.id))} className="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-500/80 text-white flex items-center justify-center opacity-0 group-hover:opacity-100"><X className="w-2 h-2" /></button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                <button
                  onClick={() => {
                    if (!chatInput.trim() || !editableCode) return;
                    const fakeEvent = { key: "Enter", shiftKey: false, preventDefault: () => {} } as any;
                    const textarea = document.activeElement as HTMLTextAreaElement | null;
                    textarea?.dispatchEvent?.(new KeyboardEvent("keydown", { key: "Enter" }));
                  }}
                  className="p-2 rounded-lg bg-zinc-800/10 border border-zinc-700 text-zinc-300 hover:bg-zinc-800/20 transition-colors"
                  title="Send"
                >
                  <Send className="w-4 h-4" />
                </button>
              </div>
            </div>
            )}
          </div>
      )}
      
      {/* Delete Component Modal - Custom styled (not system confirm) */}
      {showDeleteComponentModal && deleteComponentTarget && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm"
          onClick={() => setShowDeleteComponentModal(false)}
        >
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 10 }}
            className="bg-zinc-900 border border-zinc-700/50 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="px-5 py-4 border-b border-zinc-800">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center">
                  <Trash2 className="w-5 h-5 text-red-400" />
                </div>
                <div>
                  <h3 className="text-base font-semibold text-white">Delete Component</h3>
                  <p className="text-xs text-zinc-500">This action cannot be undone</p>
                </div>
              </div>
            </div>
            
            {/* Content */}
            <div className="px-5 py-4">
              <p className="text-sm text-zinc-400">
                Are you sure you want to delete <span className="text-white font-medium">"{deleteComponentTarget.name}"</span>?
              </p>
            </div>
            
            {/* Actions */}
            <div className="px-5 py-4 bg-zinc-900/50 border-t border-zinc-800 flex items-center justify-end gap-3">
              <button
                onClick={() => setShowDeleteComponentModal(false)}
                className="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  if (libraryData && deleteComponentTarget) {
                    const updated = {
                      ...libraryData,
                      components: libraryData.components.filter((c: any) => c.id !== deleteComponentTarget.id)
                    };
                    setLibraryData(updated);
                    setSelectedBlueprintComponent(null);
                    setBlueprintEditedCode(null);
                    setBlueprintChatHistory([]);
                    // Broadcast deletion to other users
                    broadcastLibraryComponentDelete(deleteComponentTarget.id);
                  }
                  setShowDeleteComponentModal(false);
                  setDeleteComponentTarget(null);
                }}
                className="px-4 py-2 text-sm font-medium bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
              >
                Delete
              </button>
            </div>
          </motion.div>
        </motion.div>
      )}
      
      {/* Delete Project Modal - Confirmation before deleting generation */}
      {showDeleteModal && deleteTargetId && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm"
          onClick={() => {
            setShowDeleteModal(false);
            setDeleteTargetId(null);
          }}
        >
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 10 }}
            className="bg-zinc-900 border border-zinc-700/50 rounded-2xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="px-5 py-4 border-b border-zinc-800">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center">
                  <Trash2 className="w-5 h-5 text-red-400" />
                </div>
                <div>
                  <h3 className="text-base font-semibold text-white">Delete Project</h3>
                  <p className="text-xs text-zinc-500">This action cannot be undone</p>
                </div>
              </div>
            </div>
            
            {/* Content */}
            <div className="px-5 py-4">
              <p className="text-sm text-zinc-400">
                Are you sure you want to delete <span className="text-white font-medium">"{deleteTargetTitle}"</span>?
              </p>
              <p className="text-xs text-zinc-600 mt-2">
                The project and all its versions will be permanently removed.
              </p>
            </div>
            
            {/* Actions */}
            <div className="px-5 py-4 bg-zinc-900/50 border-t border-zinc-800 flex items-center justify-end gap-3">
              <button
                onClick={() => {
                  setShowDeleteModal(false);
                  setDeleteTargetId(null);
                }}
                className="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-white transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  if (deleteTargetId) {
                    deleteGeneration(deleteTargetId);
                  }
                }}
                className="px-4 py-2 text-sm font-medium bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
              >
                Delete
              </button>
            </div>
          </motion.div>
        </motion.div>
      )}
      
      {/* New Component Modal - Clean tool-matching style */}
      {showVisionImportModal && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm"
          onClick={() => {
            if (!visionImportLoading) {
              setShowVisionImportModal(false);
              setVisionImportImage(null);
              setVisionImportDescription("");
            }
          }}
        >
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 10 }}
            className="bg-[#1a1a1a] border border-zinc-800 rounded-xl shadow-2xl w-full max-w-xl mx-4 overflow-hidden"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header - Clean, matching tool style */}
            <div className="px-5 py-4 border-b border-zinc-800">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-sm font-semibold text-white">New Component</h3>
                  <p className="text-[11px] text-zinc-500 mt-0.5">Import from image or describe to create</p>
                </div>
                
                {/* Mode Toggle - Clean tabs */}
                <div className="flex items-center bg-zinc-900 rounded-lg p-0.5">
                  <button
                    onClick={() => setVisionImportMode("image")}
                    className={cn(
                      "px-3 py-1.5 rounded-md text-[11px] font-medium transition-all flex items-center gap-1.5",
                      visionImportMode === "image"
                        ? "bg-white/10 text-white"
                        : "text-zinc-500 hover:text-white"
                    )}
                  >
                    <ImageIcon className="w-3.5 h-3.5" />
                    Image / Figma
                  </button>
                  <button
                    onClick={() => setVisionImportMode("describe")}
                    className={cn(
                      "px-3 py-1.5 rounded-md text-[11px] font-medium transition-all flex items-center gap-1.5",
                      visionImportMode === "describe"
                        ? "bg-white/10 text-white"
                        : "text-zinc-500 hover:text-white"
                    )}
                  >
                    <Sparkles className="w-3.5 h-3.5" />
                    Describe
                  </button>
                </div>
              </div>
            </div>
            
            {/* Content - Compact */}
            <div className="p-5">
              {visionImportMode === "image" ? (
                <>
                  {/* Image Upload Area - Compact */}
                  {!visionImportImage ? (
                    <div 
                      className="mb-4 rounded-lg border border-dashed border-zinc-700 hover:border-white/30 transition-colors bg-zinc-900/50 cursor-pointer"
                      onClick={() => visionFileInputRef.current?.click()}
                      onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                      onDrop={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const file = e.dataTransfer.files[0];
                        if (file && file.type.startsWith('image/')) {
                          const reader = new FileReader();
                          reader.onload = () => setVisionImportImage(reader.result as string);
                          reader.readAsDataURL(file);
                        }
                      }}
                    >
                      <div className="p-8 text-center">
                        <div className="w-12 h-12 mx-auto mb-3 rounded-lg bg-zinc-800 flex items-center justify-center">
                          <ImageIcon className="w-6 h-6 text-zinc-500" />
                        </div>
                        <p className="text-[12px] text-white/70 mb-1">Drop screenshot or Figma frame here</p>
                        <p className="text-[11px] text-zinc-500">or click to upload</p>
                        <div className="mt-3 flex items-center justify-center gap-2 text-[10px] text-zinc-600">
                          <kbd className="px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">Ctrl+V</kbd>
                          <span>to paste from clipboard</span>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="mb-4 rounded-lg border border-zinc-800 overflow-hidden bg-zinc-900 relative group">
                      <img 
                        src={visionImportImage} 
                        alt="Preview" 
                        className="w-full max-h-[250px] object-contain"
                      />
                      <button
                        onClick={() => setVisionImportImage(null)}
                        className="absolute top-2 right-2 p-1.5 rounded bg-black/60 text-zinc-400 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <X className="w-3.5 h-3.5" />
                      </button>
                    </div>
                  )}
                </>
              ) : (
                <>
                  {/* Description Input */}
                  <div className="mb-4">
                    <label className="block text-[10px] font-medium text-zinc-500 uppercase tracking-wider mb-2">Describe component</label>
                    <textarea
                      value={visionImportDescription}
                      onChange={(e) => setVisionImportDescription(e.target.value)}
                      placeholder="e.g., A pricing card with plan name, price, features with checkmarks, and CTA button..."
                      disabled={visionImportLoading}
                      rows={4}
                      className="w-full px-3 py-2.5 bg-zinc-900 border border-zinc-800 rounded-lg text-[12px] text-white placeholder:text-zinc-600 focus:outline-none focus:border-zinc-700 resize-none disabled:opacity-50"
                      autoFocus
                    />
                  </div>
                  
                  {/* Quick Examples */}
                  <div className="mb-4">
                    <p className="text-[10px] text-zinc-600 mb-2">Quick starts:</p>
                    <div className="flex flex-wrap gap-1.5">
                      {[
                        "Card with hover",
                        "Stats counter",
                        "Testimonial",
                        "CTA button",
                        "Feature list"
                      ].map((example) => (
                        <button
                          key={example}
                          onClick={() => setVisionImportDescription(example)}
                          className="px-2 py-1 text-[10px] bg-zinc-800/50 hover:bg-zinc-800 text-zinc-500 hover:text-white rounded transition-colors"
                        >
                          {example}
                        </button>
                      ))}
                    </div>
                  </div>
                </>
              )}
              
              {/* Component Name - Compact */}
              <div className="mb-3">
                <label className="block text-[10px] font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Name (optional)</label>
                <input
                  type="text"
                  value={visionImportComponentName}
                  onChange={(e) => setVisionImportComponentName(e.target.value)}
                  placeholder="Auto-detect..."
                  disabled={visionImportLoading}
                  className="w-full px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-[12px] text-white placeholder:text-zinc-600 focus:outline-none focus:border-zinc-700 disabled:opacity-50"
                />
              </div>
              
              {/* Additional Instructions (only for image mode) */}
              {visionImportMode === "image" && (
                <div className="mb-3">
                  <label className="block text-[10px] font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Instructions (optional)</label>
                  <input
                    type="text"
                    value={visionImportInstructions}
                    onChange={(e) => setVisionImportInstructions(e.target.value)}
                    placeholder="e.g., Dark theme, add hover effects..."
                    disabled={visionImportLoading}
                    className="w-full px-3 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-[12px] text-white placeholder:text-zinc-600 focus:outline-none focus:border-zinc-700 disabled:opacity-50"
                  />
                </div>
              )}
              
              {/* Progress */}
              {visionImportLoading && visionImportProgress && (
                <div className="mb-3 flex items-center gap-2 p-2.5 rounded-lg bg-zinc-800/50 border border-zinc-700">
                  <Loader2 className="w-3.5 h-3.5 text-white/50 animate-spin" />
                  <span className="text-[11px] text-zinc-400">{visionImportProgress}</span>
                </div>
              )}
            </div>
            
            {/* Actions - Clean */}
            <div className="px-5 py-3 border-t border-zinc-800 flex items-center justify-end gap-2">
              <button
                onClick={() => {
                  setShowVisionImportModal(false);
                  setVisionImportImage(null);
                  setVisionImportInstructions("");
                  setVisionImportComponentName("");
                  setVisionImportDescription("");
                }}
                disabled={visionImportLoading}
                className="px-3 py-1.5 text-[11px] font-medium text-zinc-500 hover:text-white transition-colors disabled:opacity-50"
              >
                Cancel
              </button>
              <button
                onClick={() => {
                  if (visionImportMode === "image" && visionImportImage) {
                    processVisionImport(visionImportImage);
                  } else if (visionImportMode === "describe" && visionImportDescription.trim()) {
                    processVisionImport(null, visionImportDescription);
                  }
                }}
                disabled={(visionImportMode === "image" && !visionImportImage) || (visionImportMode === "describe" && !visionImportDescription.trim()) || visionImportLoading}
                className="px-4 py-1.5 text-[11px] font-medium bg-white text-black hover:bg-white/90 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5"
              >
                {visionImportLoading ? (
                  <>
                    <Loader2 className="w-3.5 h-3.5 animate-spin" />
                    Creating...
                  </>
                ) : (
                  <>
                    <Plus className="w-3.5 h-3.5" />
                    Create Component
                  </>
                )}
              </button>
            </div>
          </motion.div>
        </motion.div>
      )}
    </div>
    </LiveCollaboration>
  );
}

// Page wrapper with Suspense for useSearchParams
export default function Page() {
  return (
    <Suspense fallback={<div className="h-screen bg-[#111111] flex items-center justify-center"><div className="w-8 h-8 border-2 border-[var(--accent-orange)] border-t-transparent rounded-full animate-spin" /></div>}>
      <ReplayToolContent />
    </Suspense>
  );
}
